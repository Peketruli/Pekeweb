<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<script type="text/javascript">
    // Solo redirige si esta página NO está dentro de un iframe (es decir, se abre sola)
    if (window.self === window.top) {
        window.location.replace("PekeOS.html");
    }
</script>
<title>Blog - Rebeldía IN.AR (Navidad)</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  :root{
    --text: #f5f3f4;
    --accent-gold: #ffd27a;
    --accent-red: #c43a2d;
    --evergreen: #0b4a2e;
    --bg-deep: #05060a; /* oscuro */
    --card-bg: rgba(255,255,255,0.03);
  }

  html,body{height:100%;margin:0;padding:0;}
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 50px;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: radial-gradient(circle at 10% 10%, rgba(255,250,240,0.02), transparent 15%), linear-gradient(180deg,#020308 0%, #07111a 50%, #001018 100%);
    color: var(--text);
    overflow-x: hidden;
  }

  /* ---------- Painted snowy hills + pines (scene-bg) ---------- */
  .scene-bg {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    z-index: 1;
    pointer-events: none;
  }
  .scene-bg svg { width:100%; height:100%; display:block; }

  /* ---------- STAR (replaces moon) ---------- */
  .star {
    position: fixed;
    top: 40px;
    left: 56px;
    width: 120px;
    height: 120px;
    z-index: 2;
    pointer-events: none;
    filter: drop-shadow(0 10px 40px rgba(255,200,90,0.05));
  }
  .star::before{
    content:"";
    position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at 45% 35%, rgba(255,230,150,0.98), rgba(255,210,120,0.85) 30%, rgba(220,180,90,0.45) 55%, transparent 70%);
    transform: rotate(12deg);
  }

  /* ---------- Fog layers (subtle snowy haze) ---------- */
  .fog-layer {
    position: fixed;
    left: -20%;
    width: 140%;
    height: 35vh;
    bottom: -8%;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
    filter: blur(22px);
    opacity: 0.45;
    z-index: 3;
    pointer-events: none;
    animation: fogShift 36s linear infinite;
  }
  .fog-layer.layer2 { bottom:-4%; opacity:0.28; height:30vh; filter: blur(28px); animation-duration:46s }
  .fog-layer.layer3 { bottom:-16%; opacity:0.18; height:40vh; filter: blur(36px); animation-duration:56s; transform: scaleX(1.05) }
  @keyframes fogShift {
    0%{ transform:translateX(0) }
    50%{ transform:translateX(-8%) }
    100%{ transform:translateX(0) }
  }

  /* ---------- Christmas lights across top ---------- */
  .christmas-lights {
    position: fixed;
    top: 6px;
    left: 0;
    width: 100%;
    height: 44px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 14px;
    z-index: 9;
    pointer-events: none;
  }
  .light-bulb{
    width: 14px; height: 20px; border-radius: 6px;
    box-shadow: 0 0 8px currentColor;
    transform-origin: center bottom;
    animation: blink 1.6s infinite;
  }
  .light-bulb:nth-child(odd){ animation-duration: 1.4s; }
  @keyframes blink {
    0%,100%{ opacity: 1; transform: scale(1); }
    50%{ opacity: 0.45; transform: scale(1.06) translateY(-1px); }
  }

  /* ---------- Snow particles (uses existing markup) ---------- */
  .particles {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 4;
  }
  .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    opacity: 0.9;
    animation: fall linear infinite;
    box-shadow: 0 0 6px rgba(255,255,255,0.35);
  }
  @keyframes fall {
    0% { transform: translateY(-12vh) translateX(0); opacity: 0.95; }
    100% { transform: translateY(120vh) translateX(20vw); opacity: 0.6; }
  }

  /* Botón Home - Actualizado a PekeOS */
  .home-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 10px 20px;
    background: var(--accent-gold);
    color: black;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    z-index: 10;
  }
  .home-btn:hover { background: #e6b75a; }

  /* Auth / User */
  .auth-container, .user-info {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10;
  }
  .auth-button {
    padding: 10px 20px;
    font-size: 1em;
    color: white;
    background-color: rgba(20,20,20,0.7);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: 6px;
    cursor: pointer;
  }
  .user-info { display: none; cursor: pointer; }
  #userLogo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--evergreen); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
  #userName { font-weight: bold; color: var(--accent-gold); }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 60px;
    right: 20px;
    background: rgba(2,6,10,0.9);
    color: var(--text);
    border-radius: 6px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    width: 160px;
    text-align: left;
    z-index: 11;
  }
  .dropdown-menu td {
    padding: 10px;
    cursor: pointer;
  }
  .dropdown-menu td:hover { background-color: rgba(255,255,255,0.03); }

  /* Blogs (kept) */
  .blog-container {
    position: relative;
    z-index: 10;
    max-width: 820px;
    margin-top: 80px;
    padding: 24px;
    width: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: 12px;
    border: 1px solid rgba(255,215,120,0.04);
    box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  }

  .blog-post, .new-blog, .blog-details {
    background: rgba(255,255,255,0.02);
    color: #eae8e8;
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 18px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,215,120,0.04);
  }

  .blog-post {
    cursor: pointer;
    transition: transform 0.18s, box-shadow 0.18s;
  }
  .blog-post:hover{
    transform: translateY(-4px);
    box-shadow: 0 14px 40px rgba(0,0,0,0.6);
  }

  .hidden { display: none; }

  input, textarea {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 6px;
    border: 1px solid rgba(80,80,80,0.6);
    background: rgba(10,10,12,0.6);
    color: #eae8e8;
  }

  .btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(180deg,var(--accent-red), #9c2d26);
    color: #fff;
    cursor: pointer;
    margin: 5px;
    font-weight: bold;
    transition: all 0.22s ease;
  }
  .btn:hover { transform: scale(1.04) translateY(-2px); }

  #commentsList div {
    border-bottom: 1px solid rgba(255,255,255,0.04);
    padding: 6px 0;
    text-align: left;
  }

  .like-btn {
    background:none;
    border:none;
    cursor:pointer;
    font-size:1.4em;
    color:#ff6b81;
    margin-top:5px;
  }
  .like-btn.liked { color:red; }

  .blog-media {
    margin-top:10px;
    max-width:100%;
    border-radius:6px;
    border: 1px solid rgba(255,255,255,0.03);
  }

  /* Responsive tweaks */
  @media (max-width:720px){
    body{ padding: 18px; }
    .blog-container{ margin-top:54px; padding:16px; }
    .star{ width:88px; height:88px; left:20px; top:28px; }
  }
   
  .hidden-snowman{
        position:absolute;
        font-size:2rem;
        cursor:pointer;
        transition:0.25s;
        z-index: 100; /* Alto z-index para que esté sobre todo */
    }

    .hidden-snowman.catched{
        opacity:0;
        transform:scale(0);
    }
</style>
</head>
<body>

    <div class="scene-bg" aria-hidden="true">
    <svg viewBox="0 0 1440 400" preserveAspectRatio="none">
            <rect width="1440" height="400" fill="transparent"></rect>

            <path d="M0,320 C120,260 260,280 420,320 C560,350 720,300 880,330 C1020,355 1180,310 1440,340 L1440,400 L0,400 Z" fill="#0a1620" opacity="0.7"/>
      <path d="M0,350 C160,300 340,320 520,350 C700,380 880,340 1060,365 C1240,390 1440,360 1440,360 L1440,400 L0,400 Z" fill="#0b2730" opacity="0.85"/>
            <path d="M0,360 C150,300 300,320 480,360 C660,400 820,360 1000,390 C1180,420 1440,360 1440,360 L1440,400 L0,400 Z" fill="#ffffff" opacity="0.06"/>
            <g fill="#052a1a">
        <g transform="translate(40,40) scale(0.9)">
          <polygon points="40,260 80,160 120,260"/>
          <polygon points="24,200 80,110 136,200" fill="#053822"/>
        </g>
        <g transform="translate(220,20) scale(1)">
          <polygon points="40,260 80,140 120,260"/>
          <polygon points="20,190 80,80 140,190" fill="#053822"/>
        </g>
        <g transform="translate(420,30) scale(0.95)">
          <polygon points="60,260 100,130 140,260"/>
          <polygon points="40,200 100,70 160,200" fill="#053822"/>
        </g>
        <g transform="translate(660,20) scale(1)">
          <polygon points="40,260 80,150 120,260"/>
          <polygon points="22,185 80,75 138,185" fill="#053822"/>
        </g>
        <g transform="translate(940,40) scale(0.98)">
          <polygon points="40,260 80,155 120,260"/>
          <polygon points="20,190 80,90 140,190" fill="#053822"/>
        </g>
        <g transform="translate(1180,30) scale(0.9)">
          <polygon points="40,260 80,160 120,260"/>
          <polygon points="24,200 80,110 136,200" fill="#053822"/>
        </g>
      </g>
    </svg>
  </div>

    <div class="star" aria-hidden="true"></div>

    <div class="fog-layer layer1" aria-hidden="true"></div>
  <div class="fog-layer layer2" aria-hidden="true"></div>
  <div class="fog-layer layer3" aria-hidden="true"></div>

    <div class="christmas-lights" aria-hidden="true">
    <div class="light-bulb" style="background: #ff3b30; color:#ff3b30"></div>
    <div class="light-bulb" style="background: #ffd60a; color:#ffd60a"></div>
    <div class="light-bulb" style="background: #30d158; color:#30d158"></div>
    <div class="light-bulb" style="background: #0abde3; color:#0abde3"></div>
    <div class="light-bulb" style="background: #ff2d55; color:#ff2d55"></div>
    <div class="light-bulb" style="background: #ffa500; color:#ffa500"></div>
    <div class="light-bulb" style="background: #7f5af0; color:#7f5af0"></div>
  </div>

    <div class="particles">
    <div class="particle" style="left:5%; animation-duration:14s; animation-delay:0s; width:6px;height:6px; opacity:0.9"></div>
    <div class="particle" style="left:18%; animation-duration:10s; animation-delay:1.2s; width:8px;height:8px; opacity:0.85"></div>
    <div class="particle" style="left:30%; animation-duration:18s; animation-delay:0.6s; width:5px;height:5px; opacity:0.8"></div>
    <div class="particle" style="left:45%; animation-duration:12s; animation-delay:2s; width:7px;height:7px; opacity:0.9"></div>
    <div class="particle" style="left:62%; animation-duration:16s; animation-delay:0.3s; width:6px;height:6px; opacity:0.85"></div>
    <div class="particle" style="left:78%; animation-duration:13s; animation-delay:1.5s; width:9px;height:9px; opacity:0.95"></div>
    <div class="particle" style="left:88%; animation-duration:20s; animation-delay:0s; width:5px;height:5px; opacity:0.7"></div>
  </div>

  <button class="home-btn" onclick="window.location.href='PekeOS.html'">Volver al Escritorio</button>

    <div class="hidden-snowman" data-id="11">⛄</div>
  <div class="hidden-snowman" data-id="12">⛄</div>
  <div class="hidden-snowman" data-id="13">⛄</div>
  <div class="hidden-snowman" data-id="14">⛄</div>
  <div class="hidden-snowman" data-id="15">⛄</div>
    <div class="auth-container" id="authContainer">
    <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesión o registrarse</button>
  </div>
  <div class="user-info" id="userInfo">
    <h3 id="userName"></h3>
    <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
  </div>
  <div class="dropdown-menu" id="dropdownMenu">
    <table><tr><td onclick="logout()">Cerrar sesión</td></tr></table>
  </div>

  <div class="blog-container">
    <h1>Blog</h1>
    <button class="btn" onclick="showNewBlogForm()">Publicar nuevo blog</button>

    <div id="newBlogForm" class="new-blog hidden">
      <h2>Nuevo Blog</h2>
      <input type="text" id="newTitle" placeholder="Título">
      <textarea id="newContent" rows="5" placeholder="Escribe tu blog aquí..."></textarea>
      <input type="file" id="newMedia" accept="image/*,video/*,image/gif">
      <button class="btn" onclick="publishBlog()">Publicar</button>
      <button class="btn" onclick="hideNewBlogForm()">Cancelar</button>
    </div>

    <div id="blogsList"></div>

    <div id="blogDetails" class="blog-details hidden">
      <h2 id="blogTitleDetail"></h2>
      <div id="blogMediaDetail"></div>
      <p id="blogContentDetail"></p>
      <h3>Comentarios</h3>
      <div id="commentsList"></div>
      <div id="newCommentForm">
        <textarea id="newCommentText" rows="3" placeholder="Escribe un comentario..."></textarea>
        <button class="btn" onclick="publishComment()">Publicar comentario</button>
      </div>
      <button class="btn" onclick="closeBlog()">Volver</button>
    </div>
  </div>

<script>
// -------------------- Supabase --------------------
const { createClient } = supabase;
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// -------------------- Usuario --------------------
function getCurrentUser() { return JSON.parse(localStorage.getItem("currentUser")) || null; }
function isUserLoggedIn() { return !!getCurrentUser(); }

function loadUserInfo() {
  const user = getCurrentUser();
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");
  if(user) {
    userInfo.style.display = "flex";
    authContainer.style.display = "none";
    document.getElementById("userName").textContent = user.username || "Usuario";
    document.getElementById("userLogo").src = user.logo || "logoDefault.png";
    registrarActividad("ha iniciado sesión");
  } else {
    userInfo.style.display = "none";
    authContainer.style.display = "flex";
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  loadUserInfo();
  loadBlogs();
});

// Logout
function logout() {
  registrarActividad("ha cerrado sesión");
  localStorage.removeItem("currentUser");
  window.location.href="l.html";
}

const userInfoDiv = document.getElementById("userInfo");
const dropdownMenu = document.getElementById("dropdownMenu");
userInfoDiv.addEventListener("click", ()=>{ 
  dropdownMenu.style.display = dropdownMenu.style.display==="block"?"none":"block"; 
});
document.addEventListener("click",(e)=>{
  if(!userInfoDiv.contains(e.target)&&!dropdownMenu.contains(e.target)) dropdownMenu.style.display="none"; 
});

// -------------------- Registrar actividad --------------------
async function registrarActividad(accion) {
  const user = getCurrentUser();
  const usuario = user?.username || "Desconocido";

  try {
    await db.from("actividad").insert([{
      usuario,
      accion,
      fecha: new Date().toISOString()
    
    }]);
  } catch(err) {
    console.error("Error registrando actividad:", err.message);
  }
}

// -------------------- Blogs --------------------
function showNewBlogForm(){ 
  if(!isUserLoggedIn()){ alert("Debes iniciar sesión para publicar un blog"); return; } 
  document.getElementById("newBlogForm").classList.remove("hidden"); 
}
function hideNewBlogForm(){ document.getElementById("newBlogForm").classList.add("hidden"); }

async function loadBlogs(){
  const blogsList=document.getElementById("blogsList");
  blogsList.innerHTML="Cargando blogs...";
  const { data, error } = await db.from("blog").select("*").order("created_at",{ascending:false});
  if(error){ console.error(error); blogsList.innerHTML=`<p>Error al cargar blogs: ${error.message}</p>`; return; }
  if(!data || data.length===0){ blogsList.innerHTML="<p>No hay blogs publicados.</p>"; return; }
  blogsList.innerHTML="";
  const user=getCurrentUser();
  data.forEach(blog=>{
    const div=document.createElement("div");
    div.className="blog-post";
    div.innerHTML=`
      <h3>${blog.title}</h3>
      <p style="font-size:0.9em;color:gray;">Autor: ${blog.author||"Anónimo"}</p>
      ${blog.media_url?`<img src="${blog.media_url}" class="blog-media">`:''}
      <p>❤️ <span id="likeCount-${blog.id}">${blog.likes||0}</span>
      <button class="like-btn" id="likeBtn-${blog.id}">❤️</button></p>
    `;
    div.addEventListener("click",(e)=>{ if(!e.target.classList.contains("like-btn")) openBlog(blog); });
    const likeBtn = div.querySelector(`#likeBtn-${blog.id}`);
    likeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); toggleLike(blog.id); });
    if(user && localStorage.getItem(`like_${blog.id}_${user.id}`)) likeBtn.classList.add("liked");
    blogsList.appendChild(div);
  });
}

// -------------------- Likes --------------------
async function toggleLike(blogId){
  const user=getCurrentUser(); if(!user){ alert("Inicia sesión para dar like"); return; }
  const likeKey=`like_${blogId}_${user.id}`;
  const likeEl=document.getElementById(`likeCount-${blogId}`);
  const btn=document.getElementById(`likeBtn-${blogId}`);
  const alreadyLiked=localStorage.getItem(likeKey);
  const currentLikes=parseInt(likeEl.textContent)||0;
  const newLikes=alreadyLiked?currentLikes-1:currentLikes+1;
  likeEl.textContent=newLikes;
  btn.classList.toggle("liked");
  if(alreadyLiked) localStorage.removeItem(likeKey); else localStorage.setItem(likeKey,"true");
  await db.from("blog").update({likes:newLikes}).eq("id",blogId);

  const blogTitle = (await db.from("blog").select("title").eq("id",blogId).single()).data?.title || "Desconocido";
  registrarActividad(`${alreadyLiked ? "ha quitado like" : "ha dado like"} al blog "${blogTitle}"`);
}

// -------------------- Publicar blog --------------------
async function publishBlog(){
  const user=getCurrentUser(); if(!user){ alert("Debes iniciar sesión"); return; }
  const title=document.getElementById("newTitle").value.trim();
  const content=document.getElementById("newContent").value.trim();
  const mediaInput=document.getElementById("newMedia");
  let mediaUrl="";
  if(!title||!content){ alert("Completa todos los campos"); return; }
  if(mediaInput.files.length>0){
    const file=mediaInput.files[0];
    const fileName=`${user.id}_${Date.now()}_${file.name}`;
    const { error: uploadError } = await db.storage.from("blog-media").upload(fileName, file, { upsert:true });
    if(uploadError){ console.error(uploadError); alert("Error al subir archivo"); return; }
    const { data: publicData } = db.storage.from("blog-media").getPublicUrl(fileName);
    mediaUrl=publicData.publicUrl;
  }
  const { error } = await db.from("blog").insert([{ title, content, author:user.username, media_url:mediaUrl, likes:0, comments:[] }]);
  if(error){ console.error(error); alert("Error al publicar"); return; }

  registrarActividad(`ha publicado un blog: "${title}"`);

  hideNewBlogForm();
  document.getElementById("newTitle").value="";
  document.getElementById("newContent").value="";
  document.getElementById("newMedia").value="";
  loadBlogs();
}

// -------------------- Abrir blog --------------------
function openBlog(blog){
  document.getElementById("blogTitleDetail").textContent=blog.title;
  document.getElementById("blogContentDetail").textContent=blog.content;
  const mediaDiv=document.getElementById("blogMediaDetail"); mediaDiv.innerHTML="";
  if(blog.media_url){
    if(blog.media_url.endsWith(".mp4")) mediaDiv.innerHTML=`<video src="${blog.media_url}" controls class="blog-media"></video>`;
    else mediaDiv.innerHTML=`<img src="${blog.media_url}" class="blog-media">`;
  }
  const commentsList=document.getElementById("commentsList"); commentsList.innerHTML="";
  if(blog.comments && blog.comments.length>0){
    blog.comments.forEach(c=>{ commentsList.innerHTML+=`<div><strong>${c.author}</strong>: ${c.comment}</div>`; });
  } else commentsList.innerHTML="<p>No hay comentarios todavía.</p>";
  document.getElementById("blogsList").classList.add("hidden");
  document.getElementById("blogDetails").classList.remove("hidden");
  window.currentBlogId=blog.id;
}

// -------------------- Comentar --------------------
async function publishComment(){
  const user=getCurrentUser(); if(!user){ alert("Debes iniciar sesión"); return; }
  const commentText=document.getElementById("newCommentText").value.trim(); if(!commentText){ alert("Escribe un comentario"); return; }
  const { data: blogData, error } = await db.from("blog").select("*").eq("id",window.currentBlogId).single();
  if(error){ console.error(error); alert("Error al obtener comentarios"); return; }
  const newComments = blogData.comments || [];
  newComments.push({ author:user.username, comment:commentText });
  const { error: updateError } = await db.from("blog").update({comments:newComments}).eq("id",window.currentBlogId);
  if(updateError){ console.error(updateError); alert("Error al publicar comentario"); return; }

  registrarActividad(`ha comentado en el blog "${blogData.title}"`);

  document.getElementById("newCommentText").value="";
  openBlog({...blogData, comments:newComments});
}

// -------------------- Cerrar blog --------------------
function closeBlog(){
  document.getElementById("blogDetails").classList.add("hidden");
  document.getElementById("blogsList").classList.remove("hidden");
}

// ==================== LÓGICA MUÑECOS ESCONDIDOS AÑADIDA ====================
let snowmen = JSON.parse(localStorage.getItem("snowmen")) || [];
let collectedIDs = JSON.parse(localStorage.getItem("collectedSnowmenIDs")) || [];
const firstCollectibleIndex = 13; // Primer coleccionable para muñecos (ID 13)
const maxCollectibleIndex = 22; // Último coleccionable para muñecos (ID 22)


document.addEventListener("DOMContentLoaded", () => {
  // ... (El resto de loadUserInfo y loadBlogs ya están arriba)
  setupSnowmanListeners(); 
});

function unlockCollectible(id){
  // Esta es una función auxiliar que debe estar definida en evento.html para que funcione la lógica de desbloqueo,
  // pero la definimos aquí para evitar errores y simular el guardado.
  // En el blog, solo recogemos y guardamos en localStorage. El desbloqueo visual se hará en evento.html.
  let coleccion = JSON.parse(localStorage.getItem("coleccionables"));
  if(!coleccion) return false;

  if(coleccion[id-1] && !coleccion[id-1].unlocked){
    coleccion[id-1].unlocked=true;
    localStorage.setItem("coleccionables", JSON.stringify(coleccion));
    return true;
  }
  return false;
}

function setupSnowmanListeners() {
  document.querySelectorAll(".hidden-snowman").forEach(sm=>{
    const id = sm.dataset.id;
    
    // Posición aleatoria en la ventana
    const padding = 80; 
    // Usamos document.body.scrollHeight/scrollWidth para posicionar en todo el cuerpo, no solo la vista
    const maxX = window.innerWidth - padding;
    const maxY = document.body.scrollHeight - padding; 
    
    // Intentamos que se posicionen fuera de la zona central del blog-container para que sean "escondidos"
    const isLeft = Math.random() < 0.5;
    
    if (isLeft) {
       // Posicionar en el lado izquierdo (0 a 30% de la ventana)
      sm.style.left = (Math.random() * (window.innerWidth * 0.3 - padding) + padding) + "px";
    } else {
      // Posicionar en el lado derecho (70% al 100% de la ventana)
      sm.style.left = (window.innerWidth * 0.7 + Math.random() * (window.innerWidth * 0.3 - padding) + padding) + "px";
    }

    // Posición vertical aleatoria
    sm.style.top = (Math.random() * (maxY - 200) + 200) + "px"; // 200px para evitar el header

    // Ocultar si ya recogido
    if(collectedIDs.includes(id)) sm.style.display="none";

    sm.addEventListener("click", ()=>{
      if(collectedIDs.includes(id)) return;

      sm.classList.add("catched");
      setTimeout(()=> sm.style.display="none", 200);

      // Guardar en el array de muñecos
      snowmen.push("Muñeco #" + (snowmen.length + 1));
      localStorage.setItem("snowmen", JSON.stringify(snowmen));

      // Guardar el ID recogido
      collectedIDs.push(id);
      localStorage.setItem("collectedSnowmenIDs", JSON.stringify(collectedIDs));

      const totalCollected = snowmen.length;
      
      let unlockedNow = false;
      let nextNeeded = 5 - (totalCollected % 5);

      // Lógica de desbloqueo (Solo se comprueba y se guarda el estado)
      if(totalCollected % 5 === 0){
        const collectibleToUnlock = firstCollectibleIndex + (totalCollected / 5) - 1;
        
        if(collectibleToUnlock <= maxCollectibleIndex) {
          if(unlockCollectible(collectibleToUnlock)){
            unlockedNow = true;
            alert("❄️ ¡Muñecos recogidos! Un coleccionable se ha desbloqueado. Visita el Evento de Navidad para verlo.");
          }
        } else {
          alert("✅ ¡Muñeco recogido! Ya has desbloqueado todos los coleccionables disponibles.");
        }
      }
      
      if (!unlockedNow && totalCollected < maxCollectibleIndex * 5) {
        alert(`⛄ ¡Muñeco de nieve recogido! Faltan ${nextNeeded} para el próximo coleccionable.`);
      } else if (!unlockedNow) {
         alert("⛄ ¡Muñeco de nieve recogido! (Ya has desbloqueado todos los premios)");
      }
    });
  });
}
</script>
</body>
</html>
