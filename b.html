<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Blog - Rebeldía IN.AR</title>

<!-- Fuentes -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Creepster&display=swap" rel="stylesheet">

<!-- Dependencias -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<style>
:root{
  --text: #eae8e8;
  --accent-orange: #f39c12;
}

/* Reset base */
*{margin:0;padding:0;box-sizing:border-box;}
body {
  font-family:"Inter",Arial,sans-serif;
  color: var(--text);
  background: linear-gradient(180deg,#1b0b2b 0%,#3a103a 50%,#0b0b0b 100%);
  overflow-x:hidden;
  min-height:100vh;
  padding:50px 20px;
  text-align:center;
}

/* ---------- SCENE ---------- */
.scene-bg {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:50%;
  z-index:1;
  pointer-events:none;
}
.scene-bg svg { width:100%; height:100%; display:block; }

.moon {
  position:fixed;
  top:50px;
  left:60px;
  width:130px;
  height:130px;
  border-radius:50%;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,230,0.95) 0%, rgba(255,255,220,0.85) 20%, rgba(240,240,200,0.55) 30%, rgba(220,220,200,0.15) 50%, transparent 70%);
  box-shadow:0 0 90px rgba(255,240,180,0.08), 0 6px 40px rgba(0,0,0,0.6) inset;
  z-index:2;
}
.moon::after {
  content:"";
  position:absolute;
  inset:-20px;
  border-radius:50%;
  background: radial-gradient(circle, rgba(255,230,160,0.06), transparent 35%);
  filter: blur(12px);
}

.fog-layer {
  position:fixed;
  left:-20%;
  width:140%;
  height:35vh;
  bottom:-8%;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
  filter: blur(22px);
  opacity:0.45;
  z-index:3;
  pointer-events:none;
  animation: fogShift 28s linear infinite;
}
.fog-layer.layer2 { bottom:-4%; opacity:0.28; height:30vh; filter: blur(28px); animation-duration:36s }
.fog-layer.layer3 { bottom:-16%; opacity:0.18; height:40vh; filter: blur(36px); animation-duration:46s; transform: scaleX(1.1) }
@keyframes fogShift {
  0%{ transform:translateX(0) }
  50%{ transform:translateX(-8%) }
  100%{ transform:translateX(0) }
}

.bat-svg {
  position:fixed;
  width:110px;
  height:auto;
  display:block;
  z-index:4;
  pointer-events:none;
  opacity:0.95;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,0.6));
}
.bat-1 { top:18%; left:-18%; animation: batFly1 12s linear infinite; transform-origin:center; }
.bat-2 { top:32%; left:-30%; animation: batFly2 16s linear infinite; transform-origin:center; opacity:0.9; transform:scale(.8) }
.bat-3 { top:46%; left:-10%; animation: batFly3 10s linear infinite; transform-origin:center; opacity:0.95; transform:scale(.95) }
@keyframes batFly1 {0%{transform:translateX(0) translateY(0) rotate(0deg)}25%{transform:translateX(220px) translateY(-10px) rotate(-8deg)}50%{transform:translateX(480px) translateY(6px) rotate(10deg)}75%{transform:translateX(760px) translateY(-4px) rotate(-6deg)}100%{transform:translateX(1100px) translateY(0) rotate(0deg);opacity:0}}
@keyframes batFly2 {0%{transform:translateX(0) translateY(0) rotate(0deg)}20%{transform:translateX(140px) translateY(6px) rotate(6deg)}45%{transform:translateX(380px) translateY(-12px) rotate(-10deg)}70%{transform:translateX(740px) translateY(8px) rotate(8deg)}100%{transform:translateX(1100px) translateY(0) rotate(0deg);opacity:0}}
@keyframes batFly3 {0%{transform:translateX(0) translateY(0) rotate(0deg)}30%{transform:translateX(260px) translateY(-18px) rotate(-14deg)}60%{transform:translateX(540px) translateY(12px) rotate(12deg)}100%{transform:translateX(1100px) translateY(0) rotate(0deg);opacity:0}}

/* ---------- BOTONES ---------- */
.btn { 
  font-weight:600; 
  padding:12px 22px; 
  border-radius:12px; 
  border:none; 
  cursor:pointer; 
  transition:all .25s ease; 
  box-shadow:0 6px 18px rgba(0,0,0,0.45); 
  display:inline-flex; 
  align-items:center; 
  gap:10px; 
  color:white; 
  background:linear-gradient(180deg,#f39c12,#f57c00);
}
.btn:hover {
  transform: scale(1.1) translateY(-3px);
  box-shadow:0 0 50px 18px rgba(255,160,70,0.9),0 18px 60px rgba(0,0,0,0.7);
}

/* ---------- USER / AUTH ---------- */
.auth-container, .user-info {
  position: fixed;
  top: 20px;
  right: 20px;
  display:flex;
  align-items:center;
  gap:10px;
  z-index:5;
}
.auth-button {
  padding:10px 18px;
  font-size:1em;
  color:white;
  background-color:#333;
  border:none;
  cursor:pointer;
  border-radius:6px;
}
.user-info { display:none; cursor:pointer; }
#userLogo { width:40px; height:40px; border-radius:50%; }
#userName { font-weight:600; color:white; }

.dropdown-menu {
  display:none;
  position:absolute;
  top:60px;
  right:0;
  background-color:#000;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);
  width:160px;
  text-align:left;
  z-index:10;
}
.dropdown-menu td {
  padding:10px;
  cursor:pointer;
  color:white;
}
.dropdown-menu td:hover { background-color:#333; }

/* ---------- BLOG CONTAINERS ---------- */
.blog-container { max-width:800px; margin:80px auto 0; text-align:center; width:100%; z-index:5; position:relative; }
.blog-post, .new-blog, .blog-details {
  background: rgba(255,255,255,0.02);
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  border:1px solid rgba(255,255,255,0.03);
  color:#eae8e8;
  transition: transform 0.2s;
}
.blog-post:hover { transform: scale(1.02); }
.blog-media { margin-top:10px; max-width:100%; border-radius:6px; }
#commentsList div { border-bottom:1px solid #444; padding:5px 0; text-align:left; }
.like-btn { background:none; border:none; cursor:pointer; font-size:1.5em; color:#ff4081; margin-top:5px; }
.like-btn.liked { color:red; }
input, textarea { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #555; background:#111; color:#eae8e8; }
</style>
</head>
<body>

<!-- SCENE BACKGROUND -->
<div class="scene-bg">
<svg viewBox="0 0 1440 400" preserveAspectRatio="none">
  <polygon points="0,400 0,250 200,280 400,220 600,280 800,240 1000,300 1200,260 1440,300 1440,400" fill="#0b0b0b"/>
  <rect x="220" y="260" width="10" height="40" fill="#1c1c1c"/>
  <rect x="240" y="245" width="8" height="55" fill="#1c1c1c"/>
  <rect x="380" y="250" width="10" height="50" fill="#1c1c1c"/>
  <rect x="780" y="265" width="10" height="35" fill="#1c1c1c"/>
  <rect x="800" y="240" width="8" height="60" fill="#1c1c1c"/>
  <rect x="1150" y="265" width="10" height="35" fill="#1c1c1c"/>
</svg>
</div>
<div class="moon" aria-hidden="true"></div>
<div class="fog-layer layer1" aria-hidden="true"></div>
<div class="fog-layer layer2" aria-hidden="true"></div>
<div class="fog-layer layer3" aria-hidden="true"></div>
<img class="bat-svg bat-1" src="murci-removebg-preview.png" />
<img class="bat-svg bat-2" src="murci-removebg-preview.png" />
<img class="bat-svg bat-3" src="murci-removebg-preview.png" />

<!-- AUTH -->
<div class="auth-container" id="authContainer">
  <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesión o registrarse</button>
</div>
<div class="user-info" id="userInfo">
  <h3 id="userName"></h3>
  <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
</div>
<div class="dropdown-menu" id="dropdownMenu">
  <table><tr><td onclick="logout()">Cerrar sesión</td></tr></table>
</div>

<!-- BLOG -->
<div class="blog-container">
  <h1>Blog</h1>
  <button class="btn" onclick="showNewBlogForm()">Publicar nuevo blog</button>

  <div id="newBlogForm" class="new-blog hidden">
    <h2>Nuevo Blog</h2>
    <input type="text" id="newTitle" placeholder="Título">
    <textarea id="newContent" rows="5" placeholder="Escribe tu blog aquí..."></textarea>
    <input type="file" id="newMedia" accept="image/*,video/*,image/gif">
    <button class="btn" onclick="publishBlog()">Publicar</button>
    <button class="btn" onclick="hideNewBlogForm()">Cancelar</button>
  </div>

  <div id="blogsList"></div>

  <div id="blogDetails" class="blog-details hidden">
    <h2 id="blogTitleDetail"></h2>
    <div id="blogMediaDetail"></div>
    <p id="blogContentDetail"></p>
    <h3>Comentarios</h3>
    <div id="commentsList"></div>
    <div id="newCommentForm">
      <textarea id="newCommentText" rows="3" placeholder="Escribe tu comentario..."></textarea>
      <button class="btn" onclick="publishComment()">Publicar comentario</button>
    </div>
    <button class="btn" onclick="closeBlog()">Volver</button>
  </div>
</div>

<!-- SCRIPTS -->
<script>
const { createClient } = supabase;
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

function getCurrentUser(){ return JSON.parse(localStorage.getItem("currentUser"))||null; }
function isUserLoggedIn(){ return !!getCurrentUser(); }

function loadUserInfo(){
  const user=getCurrentUser();
  const authContainer=document.getElementById("authContainer");
  const userInfo=document.getElementById("userInfo");
  if(user){
    userInfo.style.display="flex";
    authContainer.style.display="none";
    document.getElementById("userName").textContent=user.username||"Usuario";
    document.getElementById("userLogo").src=user.logo||"logoDefault.png";
  }else{
    userInfo.style.display="none";
    authContainer.style.display="flex";
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  loadUserInfo();
  loadBlogs();
});

function logout(){ localStorage.removeItem("currentUser"); window.location.href="login.html"; }

const userInfoDiv=document.getElementById("userInfo");
const dropdownMenu=document.getElementById("dropdownMenu");
userInfoDiv.addEventListener("click",()=>{ dropdownMenu.style.display=dropdownMenu.style.display==="block"?"none":"block"; });
document.addEventListener("click",(e)=>{if(!userInfoDiv.contains(e.target)&&!dropdownMenu.contains(e.target)) dropdownMenu.style.display="none";});

function showNewBlogForm(){ if(!isUserLoggedIn()){ alert("Debes iniciar sesión para publicar un blog"); return; } document.getElementById("newBlogForm").classList.remove("hidden"); }
function hideNewBlogForm(){ document.getElementById("newBlogForm").classList.add("hidden"); }

async function loadBlogs(){
  const blogsList = document.getElementById("blogsList");
  blogsList.innerHTML = "Cargando blogs...";
  const { data, error } = await db.from("blog").select("*").order("created_at", { ascending: false });
  if(error){ console.error("Error al cargar blogs:", error); blogsList.innerHTML = `<p>Error al cargar blogs: ${error.message}</p>`; return; }
  if(!data || data.length === 0){ blogsList.innerHTML = "<p>No hay blogs publicados.</p>"; return; }

  blogsList.innerHTML = "";
  const user = getCurrentUser();

  data.forEach(blog => {
    const div = document.createElement("div");
    div.className = "blog-post";

    // Evitamos que la imagen o botón de like bloquee el click
    div.innerHTML = `
      <h3>${blog.title}</h3>
      <p style="font-size:0.9em;color:gray;">Autor: ${blog.author || "Anónimo"}</p>
      ${blog.media_url ? `<img src="${blog.media_url}" class="blog-media">` : ""}
      <p>❤️ <span id="likeCount-${blog.id}">${blog.likes || 0}</span>
      <button class="like-btn" id="likeBtn-${blog.id}">❤️</button></p>
    `;

    // Evento click para abrir blog (solo si no es like)
    div.addEventListener("click", (e) => { 
      if(!e.target.classList.contains("like-btn")) openBlog(blog); 
    });

    const likeBtn = div.querySelector(`#likeBtn-${blog.id}`);
    likeBtn.addEventListener("click", (e) => { 
      e.stopPropagation(); // evitar que abra el blog
      toggleLike(blog.id); 
    });

    if(user && localStorage.getItem(`like_${blog.id}_${user.id}`)) likeBtn.classList.add("liked");

    blogsList.appendChild(div);
  });
}

// Mostrar formulario flotante encima de los blogs
function showNewBlogForm(){
  if(!isUserLoggedIn()){ alert("Debes iniciar sesión para publicar un blog"); return; }
  const form = document.getElementById("newBlogForm");
  form.classList.remove("hidden");
  form.style.position = "fixed";
  form.style.top = "50%";
  form.style.left = "50%";
  form.style.transform = "translate(-50%, -50%)";
  form.style.zIndex = 10;
  form.style.width = "90%";
  form.style.maxWidth = "500px";
  form.style.backgroundColor = "rgba(20,10,30,0.95)";
  form.style.backdropFilter = "blur(6px)";
}
function hideNewBlogForm(){
  const form = document.getElementById("newBlogForm");
  form.classList.add("hidden");
  form.style.position = "";
  form.style.top = "";
  form.style.left = "";
  form.style.transform = "";
  form.style.zIndex = "";
}


async function toggleLike(blogId){
  const user=getCurrentUser();
  if(!user){ alert("Inicia sesión para dar like"); return; }
  const likeKey=`like_${blogId}_${user.id}`;
  const likeEl=document.getElementById(`likeCount-${blogId}`);
  const btn=document.getElementById(`likeBtn-${blogId}`);
  const alreadyLiked=localStorage.getItem(likeKey);
  const currentLikes=parseInt(likeEl.textContent)||0;
  const newLikes=alreadyLiked?currentLikes-1:currentLikes+1;
  likeEl.textContent=newLikes;
  btn.classList.toggle("liked");
  if(alreadyLiked) localStorage.removeItem(likeKey); else localStorage.setItem(likeKey,"true");
  await db.from("blog").update({likes:newLikes}).eq("id",blogId);
}

async function publishBlog(){
  const user=getCurrentUser();
  if(!user){ alert("Debes iniciar sesión"); return; }
  const title=document.getElementById("newTitle").value.trim();
  const content=document.getElementById("newContent").value.trim();
  const mediaInput=document.getElementById("newMedia");
  let mediaUrl="";
  if(!title||!content){ alert("Completa todos los campos"); return; }

  if(mediaInput.files.length>0){
    const file=mediaInput.files[0];
    const fileName=`${user.id}_${Date.now()}_${file.name}`;
    const { error: uploadError } = await db.storage.from("blog-media").upload(fileName, file, { upsert:true });
    if(uploadError){ console.error(uploadError); alert("Error al subir archivo"); return; }
    const { data: publicData } = db.storage.from("blog-media").getPublicUrl(fileName);
    mediaUrl=publicData.publicUrl;
  }

  const { error } = await db.from("blog").insert([{ title, content, author:user.username, media_url:mediaUrl, likes:0, comments:[] }]);
  if(error){ console.error(error); alert("Error al publicar"); return; }

  hideNewBlogForm();
  document.getElementById("newTitle").value="";
  document.getElementById("newContent").value="";
  document.getElementById("newMedia").value="";
  loadBlogs();
}

function openBlog(blog){
  document.getElementById("blogTitleDetail").textContent=blog.title;
  document.getElementById("blogContentDetail").textContent=blog.content;
  const mediaDiv=document.getElementById("blogMediaDetail");
  mediaDiv.innerHTML="";
  if(blog.media_url){
    if(blog.media_url.endsWith(".mp4")) mediaDiv.innerHTML=`<video src="${blog.media_url}" controls class="blog-media"></video>`;
    else mediaDiv.innerHTML=`<img src="${blog.media_url}" class="blog-media">`;
  }
  const commentsList=document.getElementById("commentsList");
  commentsList.innerHTML="";
  if(blog.comments && blog.comments.length>0){
    blog.comments.forEach(c=>{ commentsList.innerHTML+=`<div><strong>${c.author}</strong>: ${c.comment}</div>`; });
  } else commentsList.innerHTML="<p>No hay comentarios todavía.</p>";
  document.getElementById("blogsList").classList.add("hidden");
  document.getElementById("blogDetails").classList.remove("hidden");
  window.currentBlogId=blog.id;
}

async function publishComment(){
  const user=getCurrentUser();
  if(!user){ alert("Debes iniciar sesión"); return; }
  const commentText=document.getElementById("newCommentText").value.trim();
  if(!commentText){ alert("Escribe un comentario"); return; }

  const { data: blogData, error } = await db.from("blog").select("*").eq("id",window.currentBlogId).single();
  if(error){ console.error(error); alert("Error al obtener comentarios"); return; }

  const newComments = blogData.comments || [];
  newComments.push({ author:user.username, comment:commentText });

  const { error: updateError } = await db.from("blog").update({comments:newComments}).eq("id",window.currentBlogId);
  if(updateError){ console.error(updateError); alert("Error al publicar comentario"); return; }

  document.getElementById("newCommentText").value="";
  openBlog({...blogData, comments:newComments});
}

function closeBlog(){ document.getElementById("blogDetails").classList.add("hidden"); document.getElementById("blogsList").classList.remove("hidden"); }
</script>

</body>
</html>
