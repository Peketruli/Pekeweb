<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Online</title>
<style>
/* --- tu CSS prÃ¡cticamente igual al original --- */
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#eee;
  margin:0;
  overflow:hidden;
}
h1 { text-align:center; color:#ff9a33; margin:10px 0; }

.card {
  background:#1b1b1b;
  border-radius:10px;
  padding:14px;
  width:95%;
  max-width:960px;
  margin:12px auto;
}
button {
  background:#ff7f2a;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
button.secondary { background:#444; }
input, select {
  padding:8px;
  border-radius:6px;
  border:1px solid #333;
  background:#0f0f0f;
  color:#fff;
}

/* === TABLERO === */
#tableroContainer {
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,#202020 0%,#0b0b0b 100%);
  flex-direction:row;
  align-items:stretch;
  justify-content:center;
  gap:10px;
  padding:10px;
}
#mesa {
  flex:1;
  position:relative;
  background:radial-gradient(circle at center,#144914 0%,#0a240a 100%);
  border-radius:50%;
  border:4px solid #222;
  box-shadow:inset 0 0 30px #000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#centro {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  gap:30px;
}
.hueco {
  width:70px;
  height:100px;
  border:2px dashed rgba(255,255,255,0.2);
  border-radius:10px;
}
#mesa-cartas {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:100%;
  height:100%;
  pointer-events:none;
  overflow:visible;
}
.jugador {
  position:absolute;
  text-align:center;
  font-size:14px;
  color:#fff;
}
.jugador span { color:#ffb866; }
.jugador1 { bottom:10px; left:50%; transform:translateX(-50%); }
.jugador2 { top:10px; left:50%; transform:translateX(-50%); }
.jugador3 { left:10px; top:50%; transform:translateY(-50%); }
.jugador4 { right:10px; top:50%; transform:translateY(-50%); }
.jugador5 { top:25%; left:50%; transform:translateX(-50%); }

/* === CARTAS === */
.carta {
  position:absolute;
  width:60px;
  height:90px;
  transform-origin:center;
  transform:translate(-50%, -50%) rotate(0deg);
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  transition:all 0.6s ease;
}
@keyframes barajar {
  0% { transform:translate(-50%, -50%) rotate(0deg); }
  25% { transform:translate(-48%, -52%) rotate(6deg); }
  50% { transform:translate(-52%, -48%) rotate(-6deg); }
  75% { transform:translate(-49%, -51%) rotate(4deg); }
  100% { transform:translate(-50%, -50%) rotate(0deg); }
}
.cartaReverso {
  background:#b02;
  background-image:repeating-linear-gradient(45deg,#b02,#b02 6px,#701 6px,#701 12px);
  color:transparent;
}
.cartaFrente {
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
  color:#000;
  background:#fff;
}

/* === PANEL === */
#panelLateral {
  width:280px;
  background:#181818;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* === DEBUG === */
#debugErrors {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  max-height:200px;
  overflow:auto;
  background:#220000;
  color:#ff5555;
  font-family:monospace;
  font-size:12px;
  padding:10px;
  z-index:9999;
}
  #mesa .fichaCentral {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: radial-gradient(circle, #ffcc33, #ff9900);
  transition: all 0.8s ease;
}

</style>
</head>
<body>
<h1>Juego de Cartas â€” Online</h1>

<!-- === FICHAS === -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos: <strong id="pekepuntosActuales">0</strong></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" value="1">
  <button id="canjearBtn">Canjear</button>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- === SALAS === -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <input id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear sala</button>
  <button id="refreshSalas" class="secondary">Actualizar</button>
  <div id="salasContainer"></div>
</div>

<!-- === TABLERO === -->
<div id="tableroContainer">
  <div id="mesa">
    <div id="centro">
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
    </div>

    <div class="jugador jugador1" id="pos1"></div>
    <div class="jugador jugador2" id="pos2"></div>
    <div class="jugador jugador3" id="pos3"></div>
    <div class="jugador jugador4" id="pos4"></div>
    <div class="jugador jugador5" id="pos5"></div>

    <div id="mesa-cartas"></div>
  </div>

  <div id="panelLateral">
    <div>
      <h3>InformaciÃ³n</h3>
      <div id="infoJugador"></div>
      <div id="fichasPanel"></div>
      <div id="jugadoresSala"></div>
    </div>
    <div>
      <button id="iniciarPartidaBtn">Iniciar partida</button>
      <button id="salirBtn" class="secondary">Salir</button>
    </div>
  </div>
</div>

<div id="debugErrors"></div>

<!-- cargamos la versiÃ³n UMD del cliente Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
/* ===================== CONFIG ===================== */
const debugErrorsEl = document.getElementById('debugErrors');
function mostrarError(e){
  console.error(e);
  const txt = e && e.message ? e.message : (typeof e === 'string' ? e : JSON.stringify(e));
  debugErrorsEl.innerHTML += `<div>${new Date().toLocaleTimeString()} â†’ ${txt}</div>`;
}

function generarID(){ return 'id-'+Math.floor(Math.random()*1e16); }

let usuario = JSON.parse(localStorage.getItem('currentUser')) || { id: generarID(), username: "Jugador" + Math.floor(Math.random()*1000) };
localStorage.setItem('currentUser', JSON.stringify(usuario));
let salaActual = null;

/* ===================== ELEMENTOS ===================== */
const fichaResumen = document.getElementById('fichaResumen');
const infoJugador = document.getElementById('infoJugador');
const fichasPanel = document.getElementById('fichasPanel');
const jugadoresSala = document.getElementById('jugadoresSala');
const iniciarPartidaBtn = document.getElementById('iniciarPartidaBtn');
const tableroContainer = document.getElementById('tableroContainer');
const salasCard = document.getElementById('salasCard');
const conversionCard = document.getElementById('conversionCard');
const mesa = document.getElementById('mesa');
const mesaCartas = document.getElementById('mesa-cartas');
const panelLateral = document.getElementById('panelLateral');

/* ===================== SUPABASE ===================== */
const supabaseClient = window.supabase?.createClient(
  'https://jdvwlfogkzrzovepzjqa.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'
);

/* ===================== USUARIO Y FICHAS ===================== */
async function obtenerDatosUsuario(){
  try{
    if(!supabaseClient) throw new Error('supabaseClient no inicializado');
    let { data, error } = await supabaseClient.from('usuarios').select('*').eq('id', usuario.id).limit(1);
    if(error) throw error;
    if(!data.length){
      let { data: insertData, error: insertErr } = await supabaseClient.from('usuarios').insert([{
        id: usuario.id, username: usuario.username, pekepuntos: 500,
        ficha_blanca:0,ficha_roja:0,ficha_azul:0,ficha_verde:0
      }]).select();
      if(insertErr) throw insertErr;
      return insertData[0];
    }
    return data[0];
  }catch(e){ mostrarError(e); return { pekepuntos:0,ficha_blanca:0,ficha_roja:0,ficha_azul:0,ficha_verde:0 }; }
}

async function renderFichas(){
  const user = await obtenerDatosUsuario();
  fichaResumen.textContent = `âšª ${user.ficha_blanca||0} ðŸ”´ ${user.ficha_roja||0} ðŸ”µ ${user.ficha_azul||0} ðŸŸ¢ ${user.ficha_verde||0}`;
  document.getElementById('pekepuntosActuales').textContent = user.pekepuntos||0;
}

/* Canjear pekepuntos por fichas */
document.getElementById('canjearBtn').addEventListener('click', async ()=>{
  try{
    const tipo = parseInt(document.getElementById('tipoFicha').value);
    const cantidad = parseInt(document.getElementById('cantidadFichas').value);
    if(cantidad<=0) return alert('Cantidad invÃ¡lida');
    const user = await obtenerDatosUsuario();
    if(user.pekepuntos < cantidad*tipo) return alert('No tienes suficientes pekepuntos');

    const campoFicha = tipo==1?'ficha_blanca':tipo==5?'ficha_roja':tipo==25?'ficha_azul':'ficha_verde';
    await supabaseClient.from('usuarios').update({ pekepuntos: user.pekepuntos - cantidad*tipo }).eq('id', usuario.id);
    await supabaseClient.from('usuarios').update({ [campoFicha]: (user[campoFicha]||0)+cantidad }).eq('id', usuario.id);
    await renderFichas();
    alert('Canje realizado correctamente!');
  }catch(e){ mostrarError(e); alert('Error canjeando fichas'); }
});

/* ===================== SALAS ===================== */
let canalGlobal=null, canalSala=null;

async function mostrarSalas(){
  try{
    const { data: salas, error } = await supabaseClient.from('room').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    const cont = document.getElementById('salasContainer');
    cont.innerHTML = '';
    if(!salas.length){ cont.innerHTML='<p>No hay salas disponibles.</p>'; return; }
    salas.forEach(s=>{
      const div = document.createElement('div');
      div.style = 'background:#222;padding:10px;margin:6px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;';
      const playersCount = Array.isArray(s.players)? s.players.length : 0;
      div.innerHTML = `<div><strong>${escapeHtml(s.name||'Sala')}</strong></div>
                       <div style="display:flex;gap:8px;align-items:center;">
                         <span>${playersCount}/5</span><button class="joinBtn">Unirse</button>
                       </div>`;
      div.querySelector('.joinBtn').onclick = ()=> unirseASala(s);
      cont.appendChild(div);
    });
  }catch(e){ mostrarError(e); }
}

async function unirseASala(room){
  try{
    salaActual = room;
    const jugadores = Array.isArray(room.players)? room.players.slice():[];
    if(!jugadores.some(p=>p.id===usuario.id)) jugadores.push({id:usuario.id,username:usuario.username,folded:false});
    await supabaseClient.from('room').update({players: jugadores}).eq('id', room.id);
    salasCard.style.display='none'; conversionCard.style.display='none'; tableroContainer.style.display='flex';
    await actualizarPanel();
    suscribirseASala(room.id);
  }catch(e){ mostrarError(e); }
}

async function suscribirseASala(idSala){
  if(canalSala) await supabaseClient.removeChannel(canalSala);
  canalSala = supabaseClient.channel(`room-${idSala}`)
    .on('postgres_changes',{event:'*',schema:'public',table:'room',filter:`id=eq.${idSala}`}, payload=>{
      salaActual = payload.new;
      actualizarPanel();
    }).subscribe();
}

/* ===================== PANEL ===================== */
function escapeHtml(str){return String(str).replace(/[&<>"'`=\/]/g,s=>'&#'+s.charCodeAt(0)+';');}
function playerFolded(id, players){ return (players||[]).some(p=>p.id===id && p.folded); }

async function actualizarPanel(){
  if(!salaActual) return;
  const jugadores = salaActual.players||[];
  infoJugador.innerHTML=`<strong>${escapeHtml(usuario.username)}</strong><br>Sala: ${escapeHtml(salaActual.name||'')}`;
  fichasPanel.innerHTML=fichaResumen.textContent;
  jugadoresSala.innerHTML = jugadores.map(j=>`<div>ðŸ‘¤ ${escapeHtml(j.username)}</div>`).join('');

  // posiciones
  for(let i=1;i<=5;i++){ document.getElementById('pos'+i).textContent = jugadores[i-1]?jugadores[i-1].username:''; }

  // cartas
  mesaCartas.innerHTML='';
  const gs = salaActual.game_state||{};
  if(Array.isArray(gs.community)) gs.community.forEach((c,i)=>{
    const div = crearCartaElemento(c,'carta cartaFrente carta-comunitaria');
    div.style.left=`calc(50% + ${ (i-2)*70 }px)`; div.style.top='40%'; div.style.transform='translate(-50%,-50%)';
    mesaCartas.appendChild(div);
  });
  if(gs.manos && gs.manos[usuario.id] && !playerFolded(usuario.id, jugadores)){
    gs.manos[usuario.id].forEach((c,i)=>{
      const div = crearCartaElemento(c,'carta cartaFrente');
      div.style.left=`calc(50% + ${i*70-35}px)`; div.style.bottom='5%'; div.style.transform='translate(-50%,0)';
      mesaCartas.appendChild(div);
    });
  }
}

/* ===================== CREAR CARTAS ===================== */
function crearCartaElemento(carta, className='carta'){
  const div = document.createElement('div');
  div.className = className;
  if(carta) div.textContent = `${carta.valor}${carta.palo}`;
  return div;
}

/* ===================== INICIAR PARTIDA ===================== */
iniciarPartidaBtn.addEventListener('click', async ()=>{
  try{
    if(!salaActual) return;
    const jugadores = salaActual.players||[];
    if(jugadores.length<2) return alert('Se necesitan al menos 2 jugadores');
    const manos = {};
    const palos = ['â™ ','â™¥','â™¦','â™£'], valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    jugadores.forEach(j=>{
      manos[j.id] = Array(2).fill(0).map(()=>({valor:valores[Math.floor(Math.random()*valores.length)], palo:palos[Math.floor(Math.random()*palos.length)]}));
    });
    await supabaseClient.from('room').update({ game_state:{manos,community:[]} }).eq('id', salaActual.id);
  }catch(e){ mostrarError(e); }
});

/* ===================== INIT ===================== */
(async ()=>{
  await renderFichas();
  await mostrarSalas();

  // suscripciÃ³n global de cambios de salas
  canalGlobal = supabaseClient.channel('salas-global')
    .on('postgres_changes',{event:'*',schema:'public',table:'room'},payload=>{
      mostrarSalas();
    }).subscribe();
})();
</script>
</body>
</html>
