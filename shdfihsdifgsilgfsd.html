<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Online</title>
<style>
/* --- tu CSS prácticamente igual al original --- */
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#eee;
  margin:0;
  overflow:hidden;
}
h1 { text-align:center; color:#ff9a33; margin:10px 0; }

.card {
  background:#1b1b1b;
  border-radius:10px;
  padding:14px;
  width:95%;
  max-width:960px;
  margin:12px auto;
}
button {
  background:#ff7f2a;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
button.secondary { background:#444; }
input, select {
  padding:8px;
  border-radius:6px;
  border:1px solid #333;
  background:#0f0f0f;
  color:#fff;
}

/* === TABLERO === */
#tableroContainer {
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,#202020 0%,#0b0b0b 100%);
  flex-direction:row;
  align-items:stretch;
  justify-content:center;
  gap:10px;
  padding:10px;
}
#mesa {
  flex:1;
  position:relative;
  background:radial-gradient(circle at center,#144914 0%,#0a240a 100%);
  border-radius:50%;
  border:4px solid #222;
  box-shadow:inset 0 0 30px #000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#centro {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  gap:30px;
}
.hueco {
  width:70px;
  height:100px;
  border:2px dashed rgba(255,255,255,0.2);
  border-radius:10px;
}
#mesa-cartas {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:100%;
  height:100%;
  pointer-events:none;
  overflow:visible;
}
.jugador {
  position:absolute;
  text-align:center;
  font-size:14px;
  color:#fff;
}
.jugador span { color:#ffb866; }
.jugador1 { bottom:10px; left:50%; transform:translateX(-50%); }
.jugador2 { top:10px; left:50%; transform:translateX(-50%); }
.jugador3 { left:10px; top:50%; transform:translateY(-50%); }
.jugador4 { right:10px; top:50%; transform:translateY(-50%); }
.jugador5 { top:25%; left:50%; transform:translateX(-50%); }

/* === CARTAS === */
.carta {
  position:absolute;
  width:60px;
  height:90px;
  transform-origin:center;
  transform:translate(-50%, -50%) rotate(0deg);
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  transition:all 0.6s ease;
}
@keyframes barajar {
  0% { transform:translate(-50%, -50%) rotate(0deg); }
  25% { transform:translate(-48%, -52%) rotate(6deg); }
  50% { transform:translate(-52%, -48%) rotate(-6deg); }
  75% { transform:translate(-49%, -51%) rotate(4deg); }
  100% { transform:translate(-50%, -50%) rotate(0deg); }
}
.cartaReverso {
  background:#b02;
  background-image:repeating-linear-gradient(45deg,#b02,#b02 6px,#701 6px,#701 12px);
  color:transparent;
}
.cartaFrente {
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
  color:#000;
  background:#fff;
}

/* === PANEL === */
#panelLateral {
  width:280px;
  background:#181818;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* === DEBUG === */
#debugErrors {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  max-height:200px;
  overflow:auto;
  background:#220000;
  color:#ff5555;
  font-family:monospace;
  font-size:12px;
  padding:10px;
  z-index:9999;
}
</style>
</head>
<body>
<h1>Juego de Cartas — Online</h1>

<!-- === FICHAS === -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos: <strong id="pekepuntosActuales">0</strong></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" value="1">
  <button id="canjearBtn">Canjear</button>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- === SALAS === -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <input id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear sala</button>
  <button id="refreshSalas" class="secondary">Actualizar</button>
  <div id="salasContainer"></div>
</div>

<!-- === TABLERO === -->
<div id="tableroContainer">
  <div id="mesa">
    <div id="centro">
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
    </div>

    <div class="jugador jugador1" id="pos1"></div>
    <div class="jugador jugador2" id="pos2"></div>
    <div class="jugador jugador3" id="pos3"></div>
    <div class="jugador jugador4" id="pos4"></div>
    <div class="jugador jugador5" id="pos5"></div>

    <div id="mesa-cartas"></div>
  </div>

  <div id="panelLateral">
    <div>
      <h3>Información</h3>
      <div id="infoJugador"></div>
      <div id="fichasPanel"></div>
      <div id="jugadoresSala"></div>
    </div>
    <div>
      <button id="iniciarPartidaBtn">Iniciar partida</button>
      <button id="salirBtn" class="secondary">Salir</button>
    </div>
  </div>
</div>

<div id="debugErrors"></div>

<!-- cargamos la versión UMD del cliente Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
/* === CONFIGURACIÓN SUPABASE === */
const supabaseUrl = "https://TU_URL.supabase.co";
const supabaseAnonKey = "TU_ANON_KEY";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

let usuario = { id: null, username: "Jugador" + Math.floor(Math.random() * 1000) };
let salaActual = null;

/* === UTILS === */
function mostrarError(e) {
  console.error(e);
  document.getElementById("debugErrors").innerText += e.message + "\n";
}

/* === CANJEO DE PEKEPUNTOS === */
const pekepuntosActuales = document.getElementById("pekepuntosActuales");
const fichaResumen = document.getElementById("fichaResumen");
let pekepuntos = 1000;
let fichas = { blanca: 0, roja: 0, azul: 0, verde: 0 };

pekepuntosActuales.textContent = pekepuntos;

function actualizarResumenFichas() {
  fichaResumen.textContent = `Blanca: ${fichas.blanca}, Roja: ${fichas.roja}, Azul: ${fichas.azul}, Verde: ${fichas.verde}`;
}
actualizarResumenFichas();

document.getElementById("canjearBtn").onclick = () => {
  const tipo = document.getElementById("tipoFicha").value;
  const cantidad = parseInt(document.getElementById("cantidadFichas").value, 10);
  if (isNaN(cantidad) || cantidad <= 0) return alert("Cantidad inválida");

  const costo = cantidad * parseInt(tipo);
  if (pekepuntos < costo) return alert("No tienes suficientes pekepuntos");

  pekepuntos -= costo;
  pekepuntosActuales.textContent = pekepuntos;
  if (tipo == 1) fichas.blanca += cantidad;
  if (tipo == 5) fichas.roja += cantidad;
  if (tipo == 25) fichas.azul += cantidad;
  if (tipo == 100) fichas.verde += cantidad;
  actualizarResumenFichas();
};

/* === SALAS === */
async function mostrarSalas() {
  try {
    const { data, error } = await supabaseClient.from("rooms").select("*");
    if (error) throw error;
    const cont = document.getElementById("salasContainer");
    cont.innerHTML = "";
    data.forEach((sala) => {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${sala.name}</strong> — jugadores: ${sala.players?.length || 0}/5 
      <button onclick="unirseSala(${sala.id})">Entrar</button>`;
      cont.appendChild(div);
    });
  } catch (e) {
    mostrarError(e);
  }
}

async function crearSala() {
  try {
    const nombre = document.getElementById("nombreSala").value || "Sala";
    const { data, error } = await supabaseClient
      .from("rooms")
      .insert([{ name: nombre, players: [usuario], game_state: {} }])
      .select();
    if (error) throw error;
    salaActual = data[0];
    abrirSala();
    suscribirseASala(salaActual.id);
  } catch (e) {
    mostrarError(e);
  }
}

async function unirseSala(id) {
  try {
    const { data: sala } = await supabaseClient.from("rooms").select("*").eq("id", id).single();
    if (!sala) return;
    const jugadores = sala.players || [];
    if (jugadores.find((j) => j.id === usuario.id)) {
      salaActual = sala;
    } else {
      jugadores.push(usuario);
      const { data, error } = await supabaseClient
        .from("rooms")
        .update({ players: jugadores })
        .eq("id", id)
        .select();
      if (error) throw error;
      salaActual = data[0];
    }
    abrirSala();
    suscribirseASala(id);
  } catch (e) {
    mostrarError(e);
  }
}

document.getElementById("crearSalaBtn").onclick = crearSala;
document.getElementById("refreshSalas").onclick = mostrarSalas;

/* === PANEL === */
function abrirSala() {
  document.getElementById("salasCard").style.display = "none";
  document.getElementById("conversionCard").style.display = "none";
  document.getElementById("tableroContainer").style.display = "flex";
  actualizarPanel();
}

function actualizarPanel() {
  const info = document.getElementById("infoJugador");
  info.innerHTML = `<strong>${usuario.username}</strong>`;
  const jugadores = document.getElementById("jugadoresSala");
  jugadores.innerHTML = "<h4>Jugadores:</h4>";
  (salaActual.players || []).forEach((j) => {
    const p = document.createElement("div");
    p.textContent = j.username;
    jugadores.appendChild(p);
  });
}

/* === SUSCRIPCIÓN EN TIEMPO REAL === */
function suscribirseASala(idSala) {
  supabaseClient
    .channel("sala_" + idSala)
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "rooms", filter: `id=eq.${idSala}` },
      (payload) => {
        const nuevaSala = payload.new;
        if (nuevaSala) {
          salaActual = nuevaSala;
          actualizarPanel();
          if (nuevaSala.game_state && nuevaSala.game_state.fase === "apuestas") {
            mostrarTurno();
          }
        }
      }
    )
    .subscribe();
}

/* === INICIO DE PARTIDA === */
document.getElementById("iniciarPartidaBtn").onclick = async () => {
  try {
    if (!salaActual) return;
    const estado = {
      fase: "reparto",
      cartas: [],
      apuestas: {},
      turnoActual: 0,
    };
    await supabaseClient.from("rooms").update({ game_state: estado }).eq("id", salaActual.id);
    setTimeout(() => iniciarRondaApuestas(), 1000);
  } catch (e) {
    mostrarError(e);
  }
};

/* === RONDA DE APUESTAS === */
async function iniciarRondaApuestas() {
  try {
    if (!salaActual) return;
    const jugadores = salaActual.players || [];
    const apuestas = {};
    jugadores.forEach((j) => (apuestas[j.id] = 0));

    const upd = await supabaseClient
      .from("rooms")
      .update({ game_state: { ...salaActual.game_state, fase: "apuestas", apuestas, turnoActual: 0 } })
      .eq("id", salaActual.id);
    if (upd.error) throw upd.error;
    mostrarTurno();
  } catch (e) {
    mostrarError(e);
  }
}

function mostrarTurno() {
  try {
    const estado = salaActual.game_state;
    if (!estado || estado.fase !== "apuestas") return;

    const jugadores = salaActual.players || [];
    const jugadorActual = jugadores[estado.turnoActual];
    const esMiTurno = jugadorActual.id === usuario.id;

    const panel = document.getElementById("panelLateral");
    const viejo = document.getElementById("accionesApuesta");
    if (viejo) viejo.remove();

    const contBotones = document.createElement("div");
    contBotones.id = "accionesApuesta";
    contBotones.style.marginTop = "10px";

    if (!esMiTurno) {
      contBotones.innerHTML = `<p>Esperando a <strong>${jugadorActual.username}</strong>...</p>`;
      panel.appendChild(contBotones);
      return;
    }

    contBotones.innerHTML = `
      <h4>Tu turno de apostar</h4>
      <input id="cantidadApuesta" type="number" min="1" placeholder="Cantidad">
      <button id="btnApostar">Apostar</button>
      <button id="btnPasar" class="secondary">Pasar</button>
      <button id="btnRetirarse" class="secondary">Retirarse</button>
    `;
    panel.appendChild(contBotones);

    document.getElementById("btnApostar").onclick = async () => {
      const cantidad = parseInt(document.getElementById("cantidadApuesta").value, 10);
      if (!cantidad || cantidad <= 0) return alert("Cantidad inválida");
      await hacerAccionApuesta("apostar", cantidad);
    };
    document.getElementById("btnPasar").onclick = () => hacerAccionApuesta("pasar");
    document.getElementById("btnRetirarse").onclick = () => hacerAccionApuesta("retirarse");
  } catch (e) {
    mostrarError(e);
  }
}

async function hacerAccionApuesta(accion, cantidad = 0) {
  try {
    const estado = salaActual.game_state;
    const jugadores = salaActual.players || [];
    const idJugador = usuario.id;
    const apuestas = estado.apuestas || {};

    if (accion === "apostar") {
      apuestas[idJugador] = (apuestas[idJugador] || 0) + cantidad;
    } else if (accion === "retirarse") {
      salaActual.players = jugadores.filter((j) => j.id !== idJugador);
    }

    const activos = salaActual.players.map((j) => j.id);
    const activas = activos.map((id) => apuestas[id] || 0);
    const maxApuesta = Math.max(...activas);
    const todosIguales = activas.every((a) => a === maxApuesta);

    let nuevaFase = "apuestas";
    let turnoActual = estado.turnoActual + 1;
    if (turnoActual >= salaActual.players.length) turnoActual = 0;

    if (todosIguales || salaActual.players.length === 1) {
      nuevaFase = "finApuestas";
    }

    await supabaseClient
      .from("rooms")
      .update({ game_state: { ...estado, apuestas, turnoActual, fase: nuevaFase }, players: salaActual.players })
      .eq("id", salaActual.id);
  } catch (e) {
    mostrarError(e);
  }
}

/* === INICIO AUTOMÁTICO === */
mostrarSalas();
</script>
</body>
</html>
