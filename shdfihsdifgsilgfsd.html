<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Online</title>
<style>
/* --- tu CSS prÃ¡cticamente igual al original --- */
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#eee;
  margin:0;
  overflow:hidden;
}
h1 { text-align:center; color:#ff9a33; margin:10px 0; }

.card {
  background:#1b1b1b;
  border-radius:10px;
  padding:14px;
  width:95%;
  max-width:960px;
  margin:12px auto;
}
button {
  background:#ff7f2a;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
button.secondary { background:#444; }
input, select {
  padding:8px;
  border-radius:6px;
  border:1px solid #333;
  background:#0f0f0f;
  color:#fff;
}

/* === TABLERO === */
#tableroContainer {
  display:none;
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,#202020 0%,#0b0b0b 100%);
  flex-direction:row;
  align-items:stretch;
  justify-content:center;
  gap:10px;
  padding:10px;
}
#mesa {
  flex:1;
  position:relative;
  background:radial-gradient(circle at center,#144914 0%,#0a240a 100%);
  border-radius:50%;
  border:4px solid #222;
  box-shadow:inset 0 0 30px #000;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
#centro {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  gap:30px;
}
.hueco {
  width:70px;
  height:100px;
  border:2px dashed rgba(255,255,255,0.2);
  border-radius:10px;
}
#mesa-cartas {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:100%;
  height:100%;
  pointer-events:none;
  overflow:visible;
}
.jugador {
  position:absolute;
  text-align:center;
  font-size:14px;
  color:#fff;
}
.jugador span { color:#ffb866; }
.jugador1 { bottom:10px; left:50%; transform:translateX(-50%); }
.jugador2 { top:10px; left:50%; transform:translateX(-50%); }
.jugador3 { left:10px; top:50%; transform:translateY(-50%); }
.jugador4 { right:10px; top:50%; transform:translateY(-50%); }
.jugador5 { top:25%; left:50%; transform:translateX(-50%); }

/* === CARTAS === */
.carta {
  position:absolute;
  width:60px;
  height:90px;
  transform-origin:center;
  transform:translate(-50%, -50%) rotate(0deg);
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  transition:all 0.6s ease;
}
@keyframes barajar {
  0% { transform:translate(-50%, -50%) rotate(0deg); }
  25% { transform:translate(-48%, -52%) rotate(6deg); }
  50% { transform:translate(-52%, -48%) rotate(-6deg); }
  75% { transform:translate(-49%, -51%) rotate(4deg); }
  100% { transform:translate(-50%, -50%) rotate(0deg); }
}
.cartaReverso {
  background:#b02;
  background-image:repeating-linear-gradient(45deg,#b02,#b02 6px,#701 6px,#701 12px);
  color:transparent;
}
.cartaFrente {
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
  color:#000;
  background:#fff;
}

/* === PANEL === */
#panelLateral {
  width:280px;
  background:#181818;
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

/* === DEBUG === */
#debugErrors {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  max-height:200px;
  overflow:auto;
  background:#220000;
  color:#ff5555;
  font-family:monospace;
  font-size:12px;
  padding:10px;
  z-index:9999;
}
</style>
</head>
<body>
<h1>Juego de Cartas â€” Online</h1>

<!-- === FICHAS === -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos: <strong id="pekepuntosActuales">0</strong></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" value="1">
  <button id="canjearBtn">Canjear</button>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- === SALAS === -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <input id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear sala</button>
  <button id="refreshSalas" class="secondary">Actualizar</button>
  <div id="salasContainer"></div>
</div>

<!-- === TABLERO === -->
<div id="tableroContainer">
  <div id="mesa">
    <div id="centro">
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
      <div class="hueco"></div>
    </div>

    <div class="jugador jugador1" id="pos1"></div>
    <div class="jugador jugador2" id="pos2"></div>
    <div class="jugador jugador3" id="pos3"></div>
    <div class="jugador jugador4" id="pos4"></div>
    <div class="jugador jugador5" id="pos5"></div>

    <div id="mesa-cartas"></div>
  </div>

  <div id="panelLateral">
    <div>
      <h3>InformaciÃ³n</h3>
      <div id="infoJugador"></div>
      <div id="fichasPanel"></div>
      <div id="jugadoresSala"></div>
    </div>
    <div>
      <button id="iniciarPartidaBtn">Iniciar partida</button>
      <button id="salirBtn" class="secondary">Salir</button>
    </div>
  </div>
</div>

<div id="debugErrors"></div>

<!-- cargamos la versiÃ³n UMD del cliente Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
/* ------------- InicializaciÃ³n segura ------------- */
const debugErrorsEl = document.getElementById('debugErrors');
function mostrarError(e){
  console.error(e);
  const txt = e && e.message ? e.message : (typeof e === 'string' ? e : JSON.stringify(e));
  debugErrorsEl.innerHTML += `<div>${new Date().toLocaleTimeString()} â†’ ${txt}</div>`;
}

/* ID seguro para navegadores antiguos */
function generarID(){ return 'id-'+Math.floor(Math.random()*1e16); }
let usuario = JSON.parse(localStorage.getItem('currentUser')) || { id: generarID(), username: "Jugador" + Math.floor(Math.random()*1000) };
localStorage.setItem('currentUser', JSON.stringify(usuario));
let salaActual = null;

/* Elementos */
const fichaResumen = document.getElementById('fichaResumen');
const infoJugador = document.getElementById('infoJugador');
const fichasPanel = document.getElementById('fichasPanel');
const jugadoresSala = document.getElementById('jugadoresSala');
const iniciarPartidaBtn = document.getElementById('iniciarPartidaBtn');
const tableroContainer = document.getElementById('tableroContainer');
const salasCard = document.getElementById('salasCard');
const conversionCard = document.getElementById('conversionCard');

/* --- Supabase client --- */
/* Nota: evita poner claves sensibles en el frontend. Mejor usar un backend o variables de entorno. */
if (!window.supabase) {
  mostrarError('WARN: La librerÃ­a supabase-js no estÃ¡ disponible (window.supabase undefined).');
}
const supabaseClient = window.supabase && window.supabase.createClient
  ? window.supabase.createClient(
      'https://jdvwlfogkzrzovepzjqa.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'
    )
  : null;

if (!supabaseClient) {
  mostrarError('ERROR: No se pudo crear supabaseClient. Comprueba la inclusiÃ³n del CDN.');
}

/* ========== FUNCIONES ========= */

async function obtenerDatosUsuario(){
  try{
    if (!supabaseClient) throw new Error('supabaseClient no inicializado');
    const res = await supabaseClient.from('usuarios').select('*').eq('id', usuario.id);
    if (res.error) throw res.error;
    const data = res.data;
    if (!data || data.length === 0) {
      // crear usuario por defecto
      const insert = await supabaseClient.from('usuarios').insert([{
        id: usuario.id,
        username: usuario.username,
        pekepuntos: 500,
        ficha_blanca: 0,
        ficha_roja: 0,
        ficha_azul: 0,
        ficha_verde: 0
      }]);
      if (insert.error) throw insert.error;
      return await obtenerDatosUsuario();
    }
    return data[0];
  }catch(e){
    mostrarError(e);
    // devolver un objeto por defecto para no romper la UI
    return { pekepuntos:0, ficha_blanca:0, ficha_roja:0, ficha_azul:0, ficha_verde:0 };
  }
}

async function renderFichas(){
  try{
    const user = await obtenerDatosUsuario();
    fichaResumen.textContent = `âšª ${user.ficha_blanca||0} ðŸ”´ ${user.ficha_roja||0} ðŸ”µ ${user.ficha_azul||0} ðŸŸ¢ ${user.ficha_verde||0}`;
    const p = document.getElementById('pekepuntosActuales');
    if(p) p.textContent = user.pekepuntos || 0;
  }catch(e){ mostrarError(e); }
}

async function mostrarSalas(){
  try{
    if (!supabaseClient) throw new Error('supabaseClient no inicializado');
    const res = await supabaseClient.from('rooms').select('*').order('created_at', { ascending: false });
    if (res.error) throw res.error;
    const salas = res.data || [];
    const cont = document.getElementById('salasContainer');
    cont.innerHTML = '';
    if (!salas.length){
      cont.innerHTML = '<p>No hay salas disponibles.</p>';
      return;
    }
    salas.forEach(s=>{
      const div = document.createElement('div');
      div.style = 'background:#222;padding:10px;margin:6px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;';
      const playersCount = Array.isArray(s.players) ? s.players.length : 0;
      const nameSafe = s.name || 'Sala';
      div.innerHTML = `<div><strong>${escapeHtml(nameSafe)}</strong></div><div style="display:flex;gap:8px;align-items:center;"><span>${playersCount}/5</span><button class="joinBtn">Unirse</button></div>`;
      const btn = div.querySelector('.joinBtn');
      btn.onclick = ()=> unirseASala(s);
      cont.appendChild(div);
    });
  }catch(e){ mostrarError(e); }
}

/* simple escape to avoid HTML injection from DB */
function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, function(s){ return '&#'+s.charCodeAt(0)+';'; });
}

/* === SUSCRIPCIONES EN TIEMPO REAL === */
let canalGlobal = null;
let canalSala = null;

async function iniciarSuscripciones() {
  try{
    if (!supabaseClient) return;
    // canal global para cambios en rooms
    canalGlobal = supabaseClient
      .channel('salas-global')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, (payload) => {
        mostrarSalas();
      })
      .subscribe();
  }catch(e){ mostrarError(e); }
}

async function suscribirseASala(idSala) {
  try{
    if (!supabaseClient) return;
    if (canalSala) {
      try { await supabaseClient.removeChannel(canalSala); } catch(e){ /* no crÃ­tico */ }
      canalSala = null;
    }
    canalSala = supabaseClient
      .channel('sala-' + idSala)
      .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms', filter: `id=eq.${idSala}` }, (payload) => {
        const nuevaSala = payload.new;
        if (nuevaSala) {
          salaActual = nuevaSala;
          actualizarPanel();
        }
      })
      .subscribe();
  }catch(e){ mostrarError(e); }
}

/* === UNIRSE A SALA (centralizada) === */
async function unirseASala(room, creador=false){
  try{
    if (!supabaseClient) throw new Error('supabaseClient no inicializado');
    salaActual = room;
    const jugadores = Array.isArray(room.players) ? room.players.slice() : [];
    if (!jugadores.some(p=>p.id===usuario.id)){
      jugadores.push({ id: usuario.id, username: usuario.username });
      const upd = await supabaseClient.from('rooms').update({ players: jugadores }).eq('id', room.id);
      if (upd.error) throw upd.error;
      // traer room actualizada
      const { data } = await supabaseClient.from('rooms').select('*').eq('id', room.id);
      if (data && data.length) salaActual = data[0];
    }
    salasCard.style.display = 'none';
    conversionCard.style.display = 'none';
    tableroContainer.style.display = 'flex';
    iniciarPartidaBtn.style.display = creador ? 'block' : 'none';
    await actualizarPanel();
    suscribirseASala(room.id);
  }catch(e){ mostrarError(e); }
}

/* === ACTUALIZAR PANEL === */
async function actualizarPanel(){
  try{
    if(!salaActual) return;
    if (!supabaseClient) throw new Error('supabaseClient no inicializado');
    const res = await supabaseClient.from('rooms').select('*').eq('id', salaActual.id);
    if(res.error) throw res.error;
    if(!res.data || res.data.length===0) return;
    const sala = res.data[0];
    salaActual = sala; // actualizar referencia
    const jugadores = sala.players || [];

    infoJugador.innerHTML = `<strong>${escapeHtml(usuario.username)}</strong><br>Sala: ${escapeHtml(sala.name||'')}`;
    fichasPanel.innerHTML = fichaResumen.textContent;
    jugadoresSala.innerHTML = jugadores.map(j=>`<div>ðŸ‘¤ ${escapeHtml(j.username)}</div>`).join('');

    for (let i=1;i<=5;i++){
      const el = document.getElementById('pos'+i);
      if(!el) continue;
      el.textContent = jugadores[i-1] ? jugadores[i-1].username : '';
    }

    // Mostrar cartas en la mesa (propias y reversos de los demÃ¡s)
    const mesa = document.getElementById('mesa-cartas');
    mesa.innerHTML = '';
    if (sala.game_state && sala.game_state.manos){
      const manos = sala.game_state.manos;
      // mostrar tus cartas delante
      const misCartas = manos[usuario.id];
      if (misCartas){
        misCartas.forEach((c,i)=>{
          const carta = document.createElement('div');
          carta.className = 'carta cartaFrente';
          carta.textContent = `${c.valor}${c.palo}`;
          // ubicarlas en la zona inferior (tu posiciÃ³n por defecto)
          carta.style.left = `calc(50% + ${i*70-35}px)`;
          carta.style.bottom = '30px';
          carta.style.transform = 'translateX(-50%)';
          mesa.appendChild(carta);
        });
      }
      // mostrar reversos en las posiciones de los demÃ¡s
      jugadores.forEach((j, idx)=>{
        if (j.id === usuario.id) return;
        const otras = manos[j.id] || [];
        otras.forEach((c,i)=>{
          const pos = document.getElementById('pos'+(idx+1));
          if(!pos) return;
          const carta = document.createElement('div');
          carta.className = 'carta cartaReverso';
          carta.style.top = '50%';
          carta.style.left = '50%';
          carta.style.opacity = 0;
          mesa.appendChild(carta);
          requestAnimationFrame(()=>{
            const rectJugador = pos.getBoundingClientRect();
            const rectMesa = mesa.getBoundingClientRect();
            const destX = rectJugador.left + rectJugador.width/2 - rectMesa.left;
            const destY = rectJugador.top + rectJugador.height/2 - rectMesa.top;
            requestAnimationFrame(()=>{
              carta.style.left = destX + 'px';
              carta.style.top = destY + 'px';
              carta.style.opacity = 1;
            });
          });
        });
      });
    }
  }catch(e){ mostrarError(e); }
}

/* === CREAR SALA === */
document.getElementById('crearSalaBtn').onclick = async () => {
  try{
    const nombre = document.getElementById('nombreSala').value.trim();
    if (!nombre) return alert('Nombre vacÃ­o');
    const room = { name: nombre, players: [{ id: usuario.id, username: usuario.username }] };
    const res = await supabaseClient.from('rooms').insert([room]).select();
    if (res.error) throw res.error;
    const nueva = res.data && res.data.length ? res.data[0] : null;
    if (nueva) unirseASala(nueva, true);
  }catch(e){ mostrarError(e); alert('Error creando sala'); }
};

document.getElementById('refreshSalas').onclick = mostrarSalas;

/* === INICIAR PARTIDA (animada) === */
iniciarPartidaBtn.onclick = async () => {
  try{
    if(!salaActual) return alert('No hay sala actual');
    const resSala = await supabaseClient.from('rooms').select('*').eq('id', salaActual.id);
    if (resSala.error) throw resSala.error;
    const sala = resSala.data && resSala.data.length ? resSala.data[0] : null;
    if(!sala) return alert('Sala no encontrada');
    const jugadores = sala.players || [];
    if (!jugadores.length) return alert('No hay jugadores');
    if (jugadores[0].id !== usuario.id) return alert('Solo el creador puede iniciar');

    const mesa = document.getElementById('mesa-cartas');
    mesa.innerHTML = '';

    // AnimaciÃ³n de barajar visual
    const reversos = [];
    for (let i=0;i<6;i++){
      const r = document.createElement('div');
      r.className = 'carta cartaReverso';
      r.style.top = '50%';
      r.style.left = '50%';
      r.style.animation = `barajar 0.45s ${i*0.08}s infinite alternate`;
      mesa.appendChild(r);
      reversos.push(r);
    }
    await new Promise(r=>setTimeout(r, 1800));
    reversos.forEach(x=>x.remove());

    // Crear baraja y repartir lÃ³gicamente
    const palos = ['â™ ','â™¥','â™¦','â™£'];
    const valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let baraja = [];
    for (let p of palos) for (let v of valores) baraja.push({valor:v, palo:p});
    baraja.sort(()=>Math.random()-0.5);

    const manos = {};
    jugadores.forEach(j => { manos[j.id] = [baraja.pop(), baraja.pop()]; });

    // Guardar estado (como JSON serializable)
    const updateRes = await supabaseClient.from('rooms').update({ game_state: { fase: 'reparto', manos, baraja } }).eq('id', salaActual.id);
    if (updateRes.error) throw updateRes.error;

    // Forzar mostrar tablero y calcular posiciones
    tableroContainer.style.display = 'flex';
    await new Promise(r => requestAnimationFrame(r));

    // Repartir animado: creamos cartas en centro y las movemos a cada pos
    for (let i=0;i<jugadores.length;i++){
      const jugador = jugadores[i];
      const posEl = document.getElementById('pos' + (i+1));
      if (!posEl) continue;

      for (let c=0;c<2;c++){
        const carta = document.createElement('div');
        carta.className = 'carta cartaReverso';
        carta.style.top = '50%';
        carta.style.left = '50%';
        carta.style.opacity = 0;
        carta.style.transition = 'all 0.55s ease';
        mesa.appendChild(carta);

        // animar hacia la posiciÃ³n (calculamos en next frame)
        requestAnimationFrame(()=>{
          const rectJugador = posEl.getBoundingClientRect();
          const rectMesa = mesa.getBoundingClientRect();
          const destX = rectJugador.left + rectJugador.width/2 - rectMesa.left;
          const destY = rectJugador.top + rectJugador.height/2 - rectMesa.top;

          requestAnimationFrame(()=>{
            carta.style.left = destX + 'px';
            carta.style.top = destY + 'px';
            carta.style.opacity = 1;
          });
        });

        // Si la carta es tuya, revelarla despuÃ©s
        if (jugador.id === usuario.id){
          setTimeout(()=>{
            carta.className = 'carta cartaFrente';
            const cardObj = manos[jugador.id][c];
            carta.textContent = `${cardObj.valor}${cardObj.palo}`;
          }, 700 + c*120 + i*250);
        }
        // espera pequeÃ±a entre cartas para efecto reparto secuencial
        await new Promise(r=>setTimeout(r, 120));
      }
    }

    // refrescar panel para que muestre cartas en sus posiciones (reversos + tuyas)
    setTimeout(()=> actualizarPanel(), 600);
  }catch(e){ mostrarError(e); alert('Error al iniciar partida'); }
};

/* === SALIR SALA === */
document.getElementById('salirBtn').onclick = async () => {
  try{
    if(!salaActual) return;
    const res = await supabaseClient.from('rooms').select('*').eq('id', salaActual.id);
    if(res.error) throw res.error;
    const sala = res.data && res.data.length ? res.data[0] : null;
    if(!sala) return;
    const nuevos = (sala.players || []).filter(p => p.id !== usuario.id);
    await supabaseClient.from('rooms').update({ players: nuevos }).eq('id', sala.id);
    salaActual = null;
    tableroContainer.style.display = 'none';
    salasCard.style.display = 'block';
    conversionCard.style.display = 'block';
    mostrarSalas();
    if (canalSala) {
      try { await supabaseClient.removeChannel(canalSala); } catch(e){ /* ignore */ }
      canalSala = null;
    }
  }catch(e){ mostrarError(e); alert('Error al salir de la sala'); }
};

/* === CANJEAR FICHAS === */
document.getElementById('canjearBtn').onclick = async () => {
  try {
    const tipo = document.getElementById('tipoFicha').value;
    const cantidad = parseInt(document.getElementById('cantidadFichas').value, 10);
    if (!cantidad || cantidad <= 0) return alert('Cantidad invÃ¡lida');

    // obtener usuario actual
    const user = await obtenerDatosUsuario();
    const costoTotal = cantidad * parseInt(tipo, 10);
    if (user.pekepuntos < costoTotal) return alert('No tienes suficientes pekepuntos');

    // actualizar datos segÃºn el tipo
    const update = {};
    if (tipo === '1') update.ficha_blanca = (user.ficha_blanca || 0) + cantidad;
    if (tipo === '5') update.ficha_roja = (user.ficha_roja || 0) + cantidad;
    if (tipo === '25') update.ficha_azul = (user.ficha_azul || 0) + cantidad;
    if (tipo === '100') update.ficha_verde = (user.ficha_verde || 0) + cantidad;

    update.pekepuntos = user.pekepuntos - costoTotal;

    // guardar en base de datos
    const res = await supabaseClient.from('usuarios').update(update).eq('id', usuario.id);
    if (res.error) throw res.error;

    await renderFichas();
    alert('Canje realizado');
  } catch(e) {
    mostrarError(e);
    alert('Error al canjear');
  }
};

/* === INICIO (DOMContentLoaded) === */
window.addEventListener('DOMContentLoaded', async () => {
  try{
    await renderFichas();
    await mostrarSalas();

    // iniciar suscripciones globales
    iniciarSuscripciones();

    // reconectar si ya estabas en una sala (opcional)
    try{
      const { data: salas } = await supabaseClient.from('rooms').select('*');
      if (salas && salas.length){
        const salaEncontrada = salas.find(s => (s.players || []).some(p => p.id === usuario.id));
        if (salaEncontrada){
          // unir sin preguntar (para simplificar)
          salaActual = salaEncontrada;
          salasCard.style.display='none';
          conversionCard.style.display='none';
          tableroContainer.style.display='flex';
          await actualizarPanel();
          suscribirseASala(salaEncontrada.id);
        }
      }
    }catch(e){ /* no crÃ­tico */ }
  }catch(e){ mostrarError(e); }
});

/* === llamada iniciales en caso de carga fuera de DOMContentLoaded (seguridad) === */
</script>
</body>
</html>
