<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PekeOS — Apuntes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ------------------ ESTILOS ------------------ */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #1a1b1e;
  color: #e6e6e6;
}

header {
  background: #2b2d31;
  padding: 15px;
  text-align: center;
  font-size: 22px;
  font-weight: bold;
  border-bottom: 1px solid #3b3d42;
}

.container {
  display: flex;
  height: calc(100vh - 60px);
}

/* PANEL IZQUIERDO */
aside {
  width: 260px;
  background: #202226;
  border-right: 1px solid #3b3d42;
  padding: 15px;
  overflow-y: auto;
}

.section-title {
  font-weight: bold;
  margin-top: 10px;
  margin-bottom: 6px;
  font-size: 15px;
}

.item-list div {
  padding: 8px;
  margin-bottom: 4px;
  background: #2b2d31;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s;
}

.item-list div:hover {
  background: #3a3d43;
}

.item-list .active {
  background: #4a4f58;
}

/* CONTENIDO (APUNTES) */
main {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

#notesList div {
  background: #2b2d31;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  border: 1px solid #3b3d42;
}

.add-btn {
  background: #5865f2;
  border: none;
  padding: 10px 14px;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  margin-top: 10px;
}

.add-btn:hover {
  background: #4752c4;
}

/* MODAL */
.modal-bg {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
}

.modal {
  background: #2b2d31;
  width: 320px;
  padding: 20px;
  margin: 100px auto;
  border-radius: 8px;
}

input, textarea {
  width: 100%;
  padding: 8px;
  background: #1a1b1e;
  border: 1px solid #3b3d42;
  color: white;
  border-radius: 6px;
  margin-top: 5px;
}

textarea {
  resize: none;
  height: 120px;
}

.modal button {
  margin-top: 10px;
}

</style>
</head>

<body>

<header>PekeOS — Apuntes</header>

<div class="container">

  <!-- ------------------ PANEL IZQUIERDO ------------------ -->
  <aside>
    <div class="section-title">Ramas</div>
    <div id="branchList" class="item-list"></div>

    <div class="section-title">Asignaturas</div>
    <div id="subjectList" class="item-list"></div>
  </aside>

  <!-- ------------------ CONTENIDO DERECHA ------------------ -->
  <main>
    <h2 id="subjectTitle">Selecciona una asignatura</h2>

    <input type="text" id="searchInput" placeholder="Buscar apuntes...">
    <hr><br>

    <div id="notesList"></div>

    <button class="add-btn" id="addNoteBtn" style="display:none;">
      Añadir apunte
    </button>
  </main>
</div>

<!-- ------------------ MODAL ------------------ -->
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <h3>Nuevo apunte</h3>

    <label>Título</label>
    <input id="noteTitle">

    <label>Contenido</label>
    <textarea id="noteContent"></textarea>

    <label>Archivo (PDF, imagen...)</label>
    <input type="file" id="noteFile">

    <button class="add-btn" onclick="saveNote()">Guardar</button>
    <button class="add-btn" style="background:#555" onclick="closeModal()">Cancelar</button>
  </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ------------------ CONFIG SUPABASE ------------------ */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------ RAMAS y ASIGNATURAS ------------------ */
const data = {
  "Letras": ["Latín", "Frances", "Historia del arte"],
  "Ciencias": ["Biología", "Química", "Física", "Mates", "Tecnologia"],
  "Orokorrak": ["Fisiologia", "Geografía", "Empresa"],
  "Obligatorias": ["Historia de España", "Inglés", "Euskera", "Lengua", "Filosofía"]
};

let currentBranch = null;
let currentSubject = null;

function loadBranches() {
  try {
    const container = document.getElementById("branchList");
    container.innerHTML = "";

    Object.keys(data).forEach(branch => {
      const div = document.createElement("div");
      div.textContent = branch;
      div.onclick = () => selectBranch(branch, div);
      container.appendChild(div);
    });
  } catch (e) {
    alert("Error cargando ramas: " + e.message);
  }
}

function selectBranch(branch, element) {
  try {
    currentBranch = branch;

    [...document.querySelectorAll("#branchList div")].forEach(d => d.classList.remove("active"));
    element.classList.add("active");

    const subjects = data[branch];
    const container = document.getElementById("subjectList");
    container.innerHTML = "";

    subjects.forEach(sub => {
      const div = document.createElement("div");
      div.textContent = sub;
      div.onclick = () => selectSubject(sub, div);
      container.appendChild(div);
    });
  } catch (e) {
    alert("Error mostrando asignaturas: " + e.message);
  }
}

function selectSubject(subject, element) {
  try {
    currentSubject = subject;

    [...document.querySelectorAll("#subjectList div")].forEach(d => d.classList.remove("active"));
    element.classList.add("active");

    document.getElementById("subjectTitle").textContent = subject;
    document.getElementById("addNoteBtn").style.display = "block";

    loadNotes();
  } catch (e) {
    alert("Error seleccionando asignatura: " + e.message);
  }
}

/* ------------------ CARGAR NOTAS ------------------ */
async function loadNotes() {
  try {
    const container = document.getElementById("notesList");
    container.innerHTML = "Cargando...";

    let { data: notes, error } = await db
      .from("apuntes")
      .select("*")
      .eq("subject", currentSubject)
      .order("created_at", { ascending: false });

    if (error) return alert("Error cargando apuntes: " + error.message);

    container.innerHTML = "";

    notes.forEach(note => {
      let fileLink = "";
      if (note.file_url) {
        fileLink = `<br><a href="${note.file_url}" target="_blank" style="color:#4ea1f3">Ver archivo</a>`;
      }

      const div = document.createElement("div");
      div.innerHTML = `<strong>${note.title}</strong><br>${note.content}${fileLink}`;
      container.appendChild(div);
    });
  } catch (e) {
    alert("Error cargando notas: " + e.message);
  }
}

document.getElementById("searchInput").oninput = loadNotes;

/* ------------------ MODAL ------------------ */
function openModal() {
  document.getElementById("modalBg").style.display = "block";
}
function closeModal() {
  document.getElementById("modalBg").style.display = "none";
}

document.getElementById("addNoteBtn").onclick = openModal;

/* ------------------ GUARDAR NOTA + ARCHIVO ------------------ */
async function saveNote() {
  try {
    const title = document.getElementById("noteTitle").value.trim();
    const content = document.getElementById("noteContent").value.trim();
    const file = document.getElementById("noteFile").files[0];

    if (!title || !content) return alert("Rellena todos los campos.");

    let file_url = null;

    /* ---- SUBIR ARCHIVO ---- */
    if (file) {
      const fileName = Date.now() + "_" + file.name;

      let { data: uploadData, error: uploadError } = await db
        .storage
        .from("zona18")
        .upload(fileName, file);

      if (uploadError) return alert("Error subiendo archivo: " + uploadError.message);

      file_url = `${SUPABASE_URL}/storage/v1/object/public/zona18/${fileName}`;
    }

    /* ---- GUARDAR NOTA ---- */
    const { error } = await db
      .from("apuntes")
      .insert({
        subject: currentSubject,
        title,
        content,
        file_url
      });

    if (error) return alert("Error guardando apunte: " + error.message);

    closeModal();
    loadNotes();

  } catch (e) {
    alert("Error inesperado guardando apunte: " + e.message);
  }
}

/* ------------------ INICIO ------------------ */
loadBranches();

</script>
</body>
</html>
