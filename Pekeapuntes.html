<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PekeOS ‚Äî Apuntes</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --muted:#6b7280; --accent:#4f46e5;
      --radius:14px; --shadow: 0 6px 18px rgba(50,50,93,0.08);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#0f172a;-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .branches{display:flex;gap:8px;margin-top:10px}
    .branch-btn{flex:1;padding:8px 10px;border-radius:10px;border:1px solid #eee;background:#fafafa;font-weight:600;cursor:pointer;text-align:center}
    .branch-btn.active{background:var(--accent);color:#fff;border-color:rgba(79,70,229,0.9)}
    .subjects{margin-top:12px;max-height:300px;overflow:auto;padding-right:6px}
    .subject{display:block;padding:10px;border-radius:10px;border:1px solid transparent;margin-bottom:8px;text-align:left;cursor:pointer}
    .subject:hover{background:#fbfbfe}
    .subject.active{background:linear-gradient(90deg,#eef2ff, #f8fafc);border-color:#e6e9ff}

    .add-sub{display:flex;gap:8px;margin-top:8px}
    .add-sub select,.add-sub input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e7ee}
    .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #e6e7ee}

    /* Main */
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:8px 10px;border-radius:10px;border:1px solid #e6e7ee}
    .notes-list{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .note{padding:12px;border-radius:12px;border:1px solid #f0f2ff;background:#fff}
    .note h3{margin:0 0 6px 0;font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .note .content{margin-top:8px;white-space:pre-wrap;color:#111827}
    .note .actions{display:flex;gap:8px;margin-top:10px}
    .attachment-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .att{width:100px;height:76px;border-radius:8px;border:1px solid #eee;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:12px;background:#fbfbff;padding:6px;text-align:center}

    /* Drawer modal */
    .drawer-back{position:fixed;inset:0;background:rgba(9,10,15,0.35);display:flex;align-items:flex-start;justify-content:flex-end;padding:28px;z-index:60}
    .drawer{width:420px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 20px 50px rgba(2,6,23,0.3);max-height:90vh;overflow:auto}
    .field{margin-bottom:12px}
    .field label{display:block;font-size:13px;margin-bottom:6px;color:#111827}
    .field input[type="text"], .field textarea, .field input[type="file"], .field select{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e7ee;font-size:14px
    }
    .field textarea{min-height:160px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}

    /* Responsive */
    @media (max-width:880px){
      .grid{grid-template-columns:1fr;gap:12px}
      .drawer{width:100%;border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Apuntes</h1>
        <div class="sub">Comparte y consulta apuntes organizados por rama y asignatura</div>
      </div>
      <div class="sub">Guardado local (localStorage)</div>
    </header>

    <div class="grid">
      <!-- LEFT: branches + subjects -->
      <aside class="panel" aria-label="Ramas y asignaturas">
        <div>
          <strong>Ramas</strong>
          <div class="branches" id="branchesContainer"></div>
        </div>

        <div style="margin-top:14px">
          <strong>Asignaturas</strong>
          <div class="subjects" id="subjectsContainer"></div>


        <div style="margin-top:14px;font-size:13px;color:var(--muted)">
          Consejo: los archivos se guardan en tu navegador. Para compartir entre usuarios hay que a√±adir un backend.
        </div>
      </aside>

      <!-- RIGHT: main -->
      <main class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div>
            <h2 id="subjectTitle">Selecciona una asignatura</h2>
            <div class="small" id="notesCount"></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div class="search">
              <input id="searchInput" placeholder="Buscar apuntes..." />
              <select id="sortSelect" title="Ordenar">
                <option value="newest">M√°s recientes</option>
                <option value="oldest">M√°s antiguos</option>
                <option value="top">M√°s votados</option>
              </select>
            </div>
            <button class="btn primary" id="addNoteBtn">A√±adir apunte</button>
          </div>
        </div>

        <div id="notesList" class="notes-list">
          <!-- notas -->
        </div>
      </main>
    </div>
  </div>

  <!-- Drawer (hidden) -->
  <div id="drawerRoot" style="display:none"></div>

  <script>
  /********** App: estructura inicial y helpers **********/
  const INITIAL_STRUCTURE = {
    Letras: ['Historia del arte','Latin','','',''],
    Ciencias: ['Mate','F√≠sica','Qu√≠mica','Biolog√≠a','Tecnolog√≠a'],
    Orokorrak: ['Zientzia orokorra','Giza mate','Economia'],
    ParaTodos: ['Historia de espa√±a','Lengua','Ingl√©s','Euskera','Filosof√≠a']
  };
  const STORAGE_KEY = 'pekeos_apuntes_v1';

  function uid(){ return Date.now().toString(36)+'_'+Math.floor(Math.random()*9999) }

  function nowISO(){ return new Date().toISOString() }
  function prettyDate(iso){ const d = new Date(iso); return d.toLocaleString(); }

  // load/save
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        // create empty subjects
        const subjects = {};
        Object.values(INITIAL_STRUCTURE).flat().forEach(s=>subjects[s]=[]);
        return { branches: INITIAL_STRUCTURE, subjects };
      }
      return JSON.parse(raw);
    }catch(e){
      console.error(e);
      return { branches: INITIAL_STRUCTURE, subjects: {} };
    }
  }
  function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }

  let state = loadState();
  let currentBranch = '';
  let currentSubject = '';
  let editingNote = null;

  /********** UI references **********/
  const branchesContainer = document.getElementById('branchesContainer');
  const subjectsContainer = document.getElementById('subjectsContainer');
  const branchSelect = document.getElementById('branchSelect');
  const newSubjectInput = document.getElementById('newSubjectInput');
  const createSubjectBtn = document.getElementById('createSubjectBtn');

  const subjectTitle = document.getElementById('subjectTitle');
  const notesCount = document.getElementById('notesCount');
  const addNoteBtn = document.getElementById('addNoteBtn');
  const notesList = document.getElementById('notesList');

  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');

  const drawerRoot = document.getElementById('drawerRoot');

  /********** Render functions **********/
  function renderBranches(){
    branchesContainer.innerHTML = '';
    Object.keys(state.branches).forEach(b=>{
      const btn = document.createElement('button');
      btn.className = 'branch-btn' + (b===currentBranch ? ' active' : '');
      btn.textContent = b;
      btn.onclick = ()=>{ currentBranch = b; currentSubject=''; render(); }
      branchesContainer.appendChild(btn);
    });

    // fill branch select
    branchSelect.innerHTML = '';
    Object.keys(state.branches).forEach(b=>{
      const opt = document.createElement('option'); opt.value=b; opt.textContent=b;
      branchSelect.appendChild(opt);
    });
  }

  function renderSubjects(){
    subjectsContainer.innerHTML = '';
    if(!currentBranch){
      subjectsContainer.innerHTML = '<div class="small">Elige una rama para ver asignaturas.</div>';
      return;
    }
    const list = state.branches[currentBranch] || [];
    if(list.length===0){ subjectsContainer.innerHTML = '<div class="small">Sin asignaturas</div>'; return; }
    list.forEach(s=>{
      const wrap = document.createElement('div');
      wrap.className = 'subject' + (s===currentSubject ? ' active':'');
      wrap.textContent = s;
      wrap.onclick = ()=>{ currentSubject = s; render(); }
      subjectsContainer.appendChild(wrap);
    });
  }

  function getFilteredNotes(){
    if(!currentSubject) return [];
    const all = (state.subjects[currentSubject] || []).slice();
    const q = searchInput.value.trim().toLowerCase();
    let filtered = all.filter(n => {
      if(!q) return true;
      return (n.title||'').toLowerCase().includes(q) || (n.content||'').toLowerCase().includes(q) || (n.author||'').toLowerCase().includes(q);
    });
    const sortBy = sortSelect.value;
    if(sortBy==='newest') filtered.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
    if(sortBy==='oldest') filtered.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
    if(sortBy==='top') filtered.sort((a,b)=> (b.likes||0) - (a.likes||0));
    return filtered;
  }

  function renderNotes(){
    notesList.innerHTML = '';
    if(!currentSubject){
      subjectTitle.textContent = 'Selecciona una asignatura';
      notesCount.textContent = '';
      return;
    }
    subjectTitle.textContent = currentSubject;
    const arr = state.subjects[currentSubject] || [];
    notesCount.textContent = arr.length + ' apuntes';

    const notes = getFilteredNotes();
    if(notes.length===0){
      notesList.innerHTML = '<div class="small" style="padding:18px;background:#fff;border-radius:10px">No hay apuntes a√∫n.</div>';
      return;
    }

    notes.forEach(n=>{
      const el = document.createElement('div'); el.className='note';
      const title = document.createElement('h3'); title.textContent = n.title || 'Sin t√≠tulo';
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `por ${n.author || 'Anon'} ¬∑ ${prettyDate(n.createdAt)}`;
      const content = document.createElement('div'); content.className='content'; content.textContent = n.content || '';

      const actions = document.createElement('div'); actions.className='actions';
      const likeBtn = document.createElement('button'); likeBtn.className='btn ghost'; likeBtn.textContent = `üëç ${n.likes||0}`; likeBtn.onclick = ()=>{ toggleLike(n.id) };
      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Editar'; editBtn.onclick = ()=>{ openDrawer(n) };
      const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.style.color='#b91c1c'; delBtn.textContent='Eliminar'; delBtn.onclick = ()=>{ deleteNote(n.id) };

      actions.appendChild(likeBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

      el.appendChild(title); el.appendChild(meta); el.appendChild(content);

      // attachments
      if(n.attachments && n.attachments.length){
        const attRow = document.createElement('div'); attRow.className='attachment-row';
        n.attachments.forEach(a=>{
          const aEl = document.createElement('div'); aEl.className='att';
          if(a.type && a.type.startsWith('image/')){
            const img = document.createElement('img'); img.src = a.data; img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.alt = a.name;
            aEl.appendChild(img);
          } else if(a.type === 'application/pdf'){
            aEl.textContent = a.name || 'PDF';
          } else {
            aEl.textContent = a.name || 'Archivo';
          }
          attRow.appendChild(aEl);
        });
        el.appendChild(attRow);
      }

      el.appendChild(actions);
      notesList.appendChild(el);
    });
  }

  function render(){
    renderBranches();
    renderSubjects();
    renderNotes();
    // update branch select default
    branchSelect.value = currentBranch || Object.keys(state.branches)[0] || '';
  }

  /********** CRUD **********/
  function ensureSubject(subject){
    if(state.subjects[subject]) return;
    state.subjects[subject] = [];
    saveState(state);
  }

  function addNote(payload){
    if(!currentSubject) return alert('Selecciona una asignatura primero');
    const note = {
      id: uid(),
      title: payload.title || 'Sin t√≠tulo',
      content: payload.content || '',
      attachments: payload.attachments || [],
      author: payload.author || 'Alumno',
      createdAt: nowISO(),
      updatedAt: nowISO(),
      likes: 0
    };
    state.subjects[currentSubject] = [note, ...(state.subjects[currentSubject]||[]) ];
    saveState(state);
    render();
  }

  function updateNote(noteId, patch){
    const arr = (state.subjects[currentSubject]||[]).map(n => n.id===noteId ? {...n, ...patch, updatedAt: nowISO()} : n);
    state.subjects[currentSubject] = arr;
    saveState(state);
    render();
  }

  function deleteNote(noteId){
    if(!confirm('¬øEliminar este apunte?')) return;
    state.subjects[currentSubject] = (state.subjects[currentSubject]||[]).filter(n => n.id!==noteId);
    saveState(state);
    render();
  }

  function toggleLike(noteId){
    const arr = (state.subjects[currentSubject]||[]).map(n => n.id===noteId ? {...n, likes:(n.likes||0)+1} : n);
    state.subjects[currentSubject] = arr;
    saveState(state);
    render();
  }

  /********** Drawer (add/edit form) **********/
  function openDrawer(note=null){
    editingNote = note;
    drawerRoot.innerHTML = '';
    const back = document.createElement('div'); back.className='drawer-back';
    const drawer = document.createElement('div'); drawer.className='drawer';
    back.onclick = (e)=>{ if(e.target===back) closeDrawer(); }
    drawer.onclick = (e)=>e.stopPropagation();

    const title = document.createElement('div'); title.style.display='flex'; title.style.justifyContent='space-between'; title.style.alignItems='center';
    const h = document.createElement('strong'); h.textContent = note ? 'Editar apunte' : 'Nuevo apunte';
    const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Cerrar'; closeBtn.onclick = closeDrawer;
    title.appendChild(h); title.appendChild(closeBtn);

    // form fields
    const form = document.createElement('form');

    // Title
    const fTitle = document.createElement('div'); fTitle.className='field';
    const lTitle = document.createElement('label'); lTitle.textContent='T√≠tulo';
    const iTitle = document.createElement('input'); iTitle.type='text'; iTitle.value = note?.title || '';
    fTitle.appendChild(lTitle); fTitle.appendChild(iTitle);

    // Content
    const fContent = document.createElement('div'); fContent.className='field';
    const lContent = document.createElement('label'); lContent.textContent='Contenido';
    const tContent = document.createElement('textarea'); tContent.value = note?.content || '';
    fContent.appendChild(lContent); fContent.appendChild(tContent);

    // Author
    const fAuthor = document.createElement('div'); fAuthor.className='field';
    const lAuthor = document.createElement('label'); lAuthor.textContent='Autor';
    const iAuthor = document.createElement('input'); iAuthor.type='text'; iAuthor.value = note?.author || 'Alumno';
    fAuthor.appendChild(lAuthor); fAuthor.appendChild(iAuthor);

    // Files
    const fFiles = document.createElement('div'); fFiles.className='field';
    const lFiles = document.createElement('label'); lFiles.textContent='Adjuntar archivos (imagen / pdf)';
    const iFiles = document.createElement('input'); iFiles.type='file'; iFiles.multiple = true;
    const preview = document.createElement('div'); preview.style.display='flex'; preview.style.gap='8px'; preview.style.flexWrap='wrap'; preview.style.marginTop='8px';
    fFiles.appendChild(lFiles); fFiles.appendChild(iFiles); fFiles.appendChild(preview);

    // existing attachments if editing
    let attachments = note?.attachments ? note.attachments.slice() : [];

    function renderPreview(){
      preview.innerHTML = '';
      attachments.forEach((a, idx)=>{
        const p = document.createElement('div'); p.className='att';
        p.style.position='relative';
        if(a.type && a.type.startsWith('image/')){
          const img = document.createElement('img'); img.src=a.data; img.style.maxWidth='100%'; img.style.maxHeight='100%';
          p.appendChild(img);
        } else if(a.type==='application/pdf'){
          p.textContent = a.name || 'PDF';
        } else {
          p.textContent = a.name || 'Archivo';
        }
        const rem = document.createElement('button'); rem.className='btn'; rem.textContent='√ó';
        rem.style.position='absolute'; rem.style.top='-6px'; rem.style.right='-6px'; rem.style.background='#ef4444'; rem.style.color='white'; rem.style.borderRadius='12px'; rem.style.width='22px'; rem.style.height='22px'; rem.onclick = ()=>{ attachments.splice(idx,1); renderPreview(); };
        p.appendChild(rem);
        preview.appendChild(p);
      });
    }
    renderPreview();

    iFiles.onchange = async (e)=>{
      const files = Array.from(e.target.files || []);
      for(const f of files){
        const data = await readFileAsDataURL(f);
        attachments.push({ name: f.name, type: f.type, data });
      }
      renderPreview();
      iFiles.value = '';
    };

    // submit
    const submitRow = document.createElement('div'); submitRow.style.display='flex'; submitRow.style.gap='8px';
    const saveBtn = document.createElement('button'); saveBtn.className='btn primary'; saveBtn.textContent='Guardar';
    const cancelBtn = document.createElement('button'); cancelBtn.className='btn'; cancelBtn.textContent='Cancelar';
    saveBtn.type='submit';
    cancelBtn.type='button'; cancelBtn.onclick = closeDrawer;
    submitRow.appendChild(saveBtn); submitRow.appendChild(cancelBtn);

    form.appendChild(fTitle); form.appendChild(fContent); form.appendChild(fAuthor); form.appendChild(fFiles); form.appendChild(submitRow);

    form.onsubmit = (ev)=>{
      ev.preventDefault();
      const payload = {
        title: iTitle.value.trim(),
        content: tContent.value.trim(),
        author: iAuthor.value.trim(),
        attachments
      };
      if(editingNote){
        updateNote(editingNote.id, payload);
      } else {
        addNote(payload);
      }
      closeDrawer();
    };

    drawer.appendChild(title);
    drawer.appendChild(document.createElement('hr'));
    drawer.appendChild(form);
    back.appendChild(drawer);
    drawerRoot.appendChild(back);
    drawerRoot.style.display='block';
  }

  function closeDrawer(){
    editingNote = null;
    drawerRoot.innerHTML = ''; drawerRoot.style.display='none';
  }

  function readFileAsDataURL(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  /********** Events **********/
  createSubjectBtn.onclick = ()=>{
    const name = newSubjectInput.value.trim();
    const branch = branchSelect.value || Object.keys(state.branches)[0];
    if(!name) return alert('Nombre de asignatura vac√≠o');
    if(!state.branches[branch]) state.branches[branch] = [];
    state.branches[branch].push(name);
    state.subjects[name] = [];
    newSubjectInput.value = '';
    saveState(state);
    currentBranch = branch;
    currentSubject = name;
    render();
  };

  addNoteBtn.onclick = ()=> {
    if(!currentSubject) return alert('Selecciona una asignatura primero');
    openDrawer(null);
  };

  searchInput.oninput = ()=> renderNotes();
  sortSelect.onchange = ()=> renderNotes();

  /********** Init default selection **********/
  // If branch none, pick first
  if(!currentBranch) currentBranch = Object.keys(state.branches)[0] || '';
  render();

  </script>
</body>
</html>
