<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>PekeOS — Apuntes (con archivos)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ------------------ ESTILOS ------------------ */
:root{--bg:#1a1b1e;--panel:#202226;--muted:#9aa0a6;--accent:#5865f2}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#e6e6e6}
header{background:#2b2d31;padding:15px;text-align:center;font-size:22px;font-weight:bold;border-bottom:1px solid #3b3d42}
.container{display:flex;height:calc(100vh - 60px)}
aside{width:260px;background:var(--panel);border-right:1px solid #313338;padding:15px;overflow:auto}
.section-title{font-weight:bold;margin-top:10px;margin-bottom:6px;font-size:15px}
.item-list div{padding:8px;margin-bottom:4px;background:#2b2d31;border-radius:6px;cursor:pointer;transition:0.15s}
.item-list div:hover{background:#3a3d43}
.item-list .active{background:#47505a}
main{flex:1;padding:20px;overflow:auto}
#notesList div{background:#2b2d31;padding:12px;border-radius:8px;margin-bottom:10px;border:1px solid #3b3d42}
.add-btn{background:var(--accent);border:none;padding:10px 14px;border-radius:6px;color:white;cursor:pointer;margin-top:10px}
.add-btn:hover{background:#4752c4}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center}
.modal{background:#2b2d31;width:420px;padding:18px;border-radius:8px}
input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid #333;background:#111214;color:#fff;margin-top:6px}
textarea{height:120px}
.attach-row{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.att{width:90px;height:70px;border-radius:6px;background:#111214;border:1px solid #313338;display:flex;align-items:center;justify-content:center;font-size:12px;padding:6px;text-align:center;overflow:hidden}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.link{color:#8fb0ff;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<header>
  PekeOS — Apuntes
  <div id="status" class="small" style="margin-top:6px">Listo</div>
</header>

<div class="container">
  <aside>
    <div class="section-title">Ramas</div>
    <div id="branchList" class="item-list"></div>

    <div class="section-title">Asignaturas</div>
    <div id="subjectList" class="item-list"></div>

    <div class="small" style="margin-top:12px">Sube imágenes o PDFs al crear un apunte. Comprueba el bucket <code>apuntes-files</code> en Supabase.</div>
  </aside>

  <main>
    <h2 id="subjectTitle">Selecciona una asignatura</h2>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <input id="searchInput" type="text" placeholder="Buscar apuntes... (vacío = todos)">
      <button id="addNoteBtn" class="add-btn" style="display:none">Añadir apunte</button>
    </div>

    <div id="notesList"></div>
  </main>
</div>

<!-- Modal -->
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <h3 id="modalTitle">Nuevo apunte</h3>

    <label>Título</label>
    <input id="noteTitle" type="text" />

    <label>Contenido</label>
    <textarea id="noteContent"></textarea>

    <label>Archivos (imagen / PDF) — multiple</label>
    <input id="noteFiles" type="file" multiple accept="image/*,application/pdf" />

    <div class="attach-row" id="filesPreview"></div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="saveNoteBtn" class="add-btn">Guardar</button>
      <button id="cancelNoteBtn" style="background:#555;border:0;padding:8px 12px;border-radius:6px;color:#fff">Cancelar</button>
    </div>

    <div id="modalMsg" class="small"></div>
  </div>
</div>

<!-- supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";

/* Cambia esto si prefieres otro nombre de bucket */
const STORAGE_BUCKET = 'zona18';
/* ==================== */

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* Ramas y asignaturas */
const data = {
  "Letras": ["Latín", "Frances", "Historia del arte"],
  "Ciencias": ["Biología", "Química", "Física", "Mates", "Tecnologia"],
  "Orokorrak": ["Fisiologia", "Geografía", "Empresa"],
  "Obligatorias": ["Historia de España", "Inglés", "Euskera", "Lengua", "Filosofía"]
};

let currentBranch = null;
let currentSubject = null;

/* DOM refs */
const branchList = document.getElementById('branchList');
const subjectList = document.getElementById('subjectList');
const subjectTitle = document.getElementById('subjectTitle');
const notesList = document.getElementById('notesList');
const addNoteBtn = document.getElementById('addNoteBtn');
const searchInput = document.getElementById('searchInput');
const statusEl = document.getElementById('status');

const modalBg = document.getElementById('modalBg');
const noteTitle = document.getElementById('noteTitle');
const noteContent = document.getElementById('noteContent');
const noteFiles = document.getElementById('noteFiles');
const filesPreview = document.getElementById('filesPreview');
const saveNoteBtn = document.getElementById('saveNoteBtn');
const cancelNoteBtn = document.getElementById('cancelNoteBtn');
const modalMsg = document.getElementById('modalMsg');

function setStatus(s){ statusEl.textContent = s; }

/* Render ramas */
function loadBranches(){
  branchList.innerHTML = '';
  Object.keys(data).forEach(b=>{
    const d = document.createElement('div');
    d.textContent = b;
    d.onclick = ()=> selectBranch(b,d);
    branchList.appendChild(d);
  });
}

function selectBranch(branch, el){
  currentBranch = branch;
  Array.from(branchList.children).forEach(n=>n.classList.toggle('active', n===el));
  // render asignaturas
  subjectList.innerHTML = '';
  (data[branch]||[]).forEach(s=>{
    const d = document.createElement('div');
    d.textContent = s;
    d.onclick = ()=> selectSubject(s,d);
    subjectList.appendChild(d);
  });
  // reset view
  currentSubject = null;
  subjectTitle.textContent = 'Selecciona una asignatura';
  addNoteBtn.style.display = 'none';
  notesList.innerHTML = '';
}

/* Seleccionar asignatura y cargar notas */
function selectSubject(subject, el){
  currentSubject = subject;
  Array.from(subjectList.children).forEach(n=>n.classList.toggle('active', n===el));
  subjectTitle.textContent = subject;
  addNoteBtn.style.display = 'inline-block';
  loadNotes();
}

/* Cargar notas desde Supabase (incluye attachments) */
async function loadNotes(){
  if(!currentSubject){
    notesList.innerHTML = '';
    return;
  }
  notesList.innerHTML = 'Cargando...';
  try{
    const { data: notes, error } = await db
      .from('apuntes')
      .select('id, title, content, attachments, created_at')
      .eq('subject', currentSubject)
      .order('created_at', { ascending:false });

    if(error){
      console.error('Error cargando apuntes', error);
      notesList.innerHTML = '<div class="small">Error cargando apuntes (ver consola)</div>';
      setStatus('Error cargando apuntes');
      return;
    }

    const q = (searchInput.value || '').trim().toLowerCase();
    const filtered = (notes||[]).filter(n=>{
      if(!q) return true;
      return (n.title||'').toLowerCase().includes(q) || (n.content||'').toLowerCase().includes(q);
    });

    notesList.innerHTML = '';
    if(filtered.length===0){
      notesList.innerHTML = '<div class="small">No hay apuntes en esta asignatura.</div>';
      return;
    }

    filtered.forEach(n=>{
      const box = document.createElement('div');
      box.innerHTML = `<strong>${escapeHtml(n.title)}</strong>
      <div class="small">${new Date(n.created_at).toLocaleString()}</div>
      <div style="margin-top:8px">${escapeHtml(n.content)}</div>`;

      // attachments (if present)
      try{
        const atts = n.attachments || [];
        if(Array.isArray(atts) && atts.length){
          const row = document.createElement('div'); row.className='attach-row';
          atts.forEach(a=>{
            const aEl = document.createElement('div'); aEl.className='att';
            if(a.type && a.type.startsWith('image/') && a.url){
              const img = document.createElement('img'); img.src = a.url; img.style.maxWidth='100%'; img.style.maxHeight='100%';
              aEl.appendChild(img);
            } else if(a.type === 'application/pdf' && a.url){
              const link = document.createElement('a'); link.href = a.url; link.target='_blank'; link.className='link'; link.textContent = a.name || 'PDF';
              aEl.appendChild(link);
            } else if(a.url){
              const link = document.createElement('a'); link.href = a.url; link.target='_blank'; link.className='link'; link.textContent = a.name || 'Archivo';
              aEl.appendChild(link);
            } else {
              aEl.textContent = a.name || 'Archivo';
            }
            row.appendChild(aEl);
          });
          box.appendChild(row);
        }
      }catch(e){
        console.warn('Error mostrando attachments', e);
      }

      notesList.appendChild(box);
    });

    setStatus('Cargadas ' + filtered.length + ' apuntes');
  }catch(err){
    console.error('loadNotes threw', err);
    notesList.innerHTML = '<div class="small">Error inesperado (ver consola)</div>';
    setStatus('Error inesperado');
  }
}

/* Abrir/cerrar modal */
function openModal(){
  modalMsg.textContent = '';
  filesPreview.innerHTML = '';
  noteFiles.value = '';
  noteTitle.value = '';
  noteContent.value = '';
  document.getElementById('modalTitle').textContent = `Nuevo apunte — ${currentSubject}`;
  modalBg.style.display = 'flex';
}
function closeModal(){
  modalBg.style.display = 'none';
}

/* Previsualizar archivos seleccionados (sin subir todavía) */
noteFiles.addEventListener('change', (e)=>{
  filesPreview.innerHTML = '';
  const files = Array.from(e.target.files || []);
  files.forEach(f=>{
    const p = document.createElement('div'); p.className='att';
    if(f.type.startsWith('image/')){
      const reader = new FileReader();
      reader.onload = ()=>{ const img=document.createElement('img'); img.src=reader.result; img.style.maxWidth='100%'; img.style.maxHeight='100%'; p.appendChild(img); }
      reader.readAsDataURL(f);
    } else if(f.type === 'application/pdf'){
      p.textContent = f.name;
    } else {
      p.textContent = f.name;
    }
    filesPreview.appendChild(p);
  });
});

/* Guardar nota + subir archivos a Storage si hay */
async function saveNote(){
  modalMsg.textContent = '';
  const title = (noteTitle.value||'').trim();
  const content = (noteContent.value||'').trim();
  if(!currentSubject) return alert('Selecciona una asignatura primero');
  if(!title || !content){ modalMsg.textContent = 'Rellena título y contenido'; return; }

  const files = Array.from(noteFiles.files || []);
  const attachments = [];

  // Si hay archivos, subirlos y obtener URLs públicas
  if(files.length){
    setStatus('Subiendo archivos...');
    for(const f of files){
      try{
        // generar ruta única
        const path = `${encodeURIComponent(currentSubject)}/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${f.name.replace(/[^a-zA-Z0-9._-]/g,'_')}`;
        const up = await db.storage.from(STORAGE_BUCKET).upload(path, f, {cacheControl: '3600', upsert: false});
        if(up.error){
          console.error('upload error', up.error);
          modalMsg.textContent = 'Error subiendo archivos (ver consola)';
          setStatus('Error subida archivos');
          return;
        }
        const { data: pub } = db.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        const publicUrl = pub && pub.publicUrl ? pub.publicUrl : null;
        attachments.push({ name: f.name, type: f.type, url: publicUrl, path });
      }catch(err){
        console.error('upload threw', err);
        modalMsg.textContent = 'Error inesperado subiendo archivos';
        setStatus('Error subida archivos');
        return;
      }
    }
  }

  // insertar nota en la tabla con attachments (JSON)
  try{
    setStatus('Guardando apunte...');
    const insertObj = { subject: currentSubject, title, content, attachments };
    const { data, error } = await db.from('apuntes').insert([insertObj]).select();

    if(error){
      console.error('insert error', error);
      // si hay un error por column attachments inexistente, indicamos cómo arreglarlo
      if(error.message && error.message.toLowerCase().includes('column') && error.message.toLowerCase().includes('attachments')){
        modalMsg.innerHTML = 'Error: la tabla <code>apuntes</code> no tiene columna <code>attachments</code>. Ejecuta en Supabase SQL:<br><pre>alter table apuntes add column attachments jsonb default \'[]\'::jsonb;</pre>';
      } else {
        modalMsg.textContent = 'Error guardando apunte (ver consola)';
      }
      setStatus('Error al guardar');
      return;
    }

    // success
    modalMsg.textContent = '';
    closeModal();
    noteTitle.value = '';
    noteContent.value = '';
    noteFiles.value = '';
    filesPreview.innerHTML = '';
    await loadNotes();
    setStatus('Apunte guardado');
  }catch(err){
    console.error('saveNote threw', err);
    modalMsg.textContent = 'Error inesperado (ver consola)';
    setStatus('Error inesperado');
  }
}

/* helpers */
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

/* wiring UI */
loadBranches();
addNoteBtn.addEventListener('click', openModal);
cancelNoteBtn.addEventListener('click', closeModal);
saveNoteBtn.addEventListener('click', saveNote);
searchInput.addEventListener('input', ()=>{ if(currentSubject) loadNotes(); });

/* quick test: check bucket exists and table connectivity */
(async function startupTest(){
  try{
    // check bucket list (will fail if anon key lacks permissions, but it's ok)
    const bucketTest = await db.storage.listBuckets();
    console.log('Buckets:', bucketTest);
    // try a lightweight query to check table access
    const test = await db.from('apuntes').select('id').limit(1);
    console.log('apuntes test:', test);
    setStatus('Listo');
  }catch(err){
    console.warn('startup test error', err);
    setStatus('Listo (con posibles limitaciones) — mira la consola si algo no va');
  }
})();
</script>
</body>
</html>
