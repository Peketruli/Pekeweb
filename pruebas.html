<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pekeweb</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Mountains+of+Christmas&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<style>
:root{
Â  --text: #f9f9ff;
Â  --accent-red: #ff3b3b;
Â  --accent-green: #1fc94c;
}

*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow-x:hidden;font-family:"Inter",Arial,sans-serif;color:var(--text);}
body{
Â  position:relative;
Â  padding:50px 20px 140px;
Â  background:linear-gradient(180deg,#0b1c33 0%,#123a58 50%,#05131d 100%);
Â  background-attachment:fixed;
}

/* ---------- NIEVE ---------- */
@keyframes snow {
Â  0% {transform: translateY(0);}
Â  100% {transform: translateY(100vh);}
}
.snowflake {
Â  position: fixed;
Â  top: -10px;
Â  color: white;
Â  font-size: 1em;
Â  animation: snow linear infinite;
Â  z-index: 2;
Â  opacity: 0.8;
}
@keyframes twinkle {
Â  0%,100%{opacity:0.8;}
Â  50%{opacity:0.2;}
}

/* ---------- LUCES ---------- */
.lights {
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  height: 60px;
Â  display: flex;
Â  justify-content: space-around;
Â  z-index: 3;
Â  pointer-events: none;
}
.light {
Â  width: 14px;
Â  height: 22px;
Â  border-radius: 50%;
Â  background: var(--accent-red);
Â  box-shadow: 0 0 16px var(--accent-red);
Â  animation: twinkle 2s infinite;
}
.light:nth-child(odd){background:var(--accent-green);box-shadow:0 0 16px var(--accent-green);animation-delay:1s;}

/* ---------- MONTAÃ‘A DE NIEVE ---------- */
.scene-bg{
Â  position:fixed;bottom:0;left:0;width:100%;height:50%;z-index:1;pointer-events:none;
}
.scene-bg svg{width:100%;height:100%;display:block;}

/* ---------- BOTONES ---------- */
.btn{
Â  font-weight:600;
Â  padding:12px 22px;
Â  border-radius:12px;
Â  border:none;
Â  cursor:pointer;
Â  transition:all .25s ease;
Â  box-shadow:0 6px 18px rgba(0,0,0,0.45);
Â  display:inline-flex;
Â  align-items:center;
Â  gap:10px;
Â  color:white;
Â  background:linear-gradient(180deg,#e63946,#d62828);
Â  z-index:5;
}
.btn[disabled]{opacity:0.6;cursor:default;}
.btn:hover{
Â  transform:scale(1.1) translateY(-3px);
Â  box-shadow:0 0 50px 18px rgba(255,80,80,0.8),0 18px 60px rgba(0,0,0,0.7);
}

/* ---------- NAV INFERIOR ---------- */
.nav-container{
Â  position:fixed;bottom:20px;left:0;width:100%;
Â  background-color:rgba(0,0,0,0.7);
Â  padding:15px 0;
Â  display:flex;justify-content:space-around;
Â  z-index:6;
}
.nav-button{
Â  padding:10px 16px;margin:0 6px;border-radius:10px;border:none;
Â  background:linear-gradient(180deg,#e63946,#d62828);
Â  color:white;font-weight:600;cursor:pointer;
Â  transition:all .25s ease;
Â  box-shadow:0 4px 18px rgba(0,0,0,0.45);
}
.nav-button:hover{
Â  transform:translateY(-6px) scale(1.08);
Â  box-shadow:0 0 48px 16px rgba(255,80,80,0.9),0 20px 60px rgba(0,0,0,0.7);
}

/* ---------- CONTENIDO ---------- */
.container{text-align:center;max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:26px;align-items:center;position:relative;z-index:5;}
.card{
Â  width:100%;
Â  background:rgba(255,255,255,0.05);
Â  border-radius:14px;
Â  padding:18px;
Â  box-shadow:0 6px 30px rgba(0,0,0,0.6);
Â  backdrop-filter:blur(6px);
Â  border:1px solid rgba(255,255,255,0.05);
Â  color:#f1f1f1;
}
.header h1{
Â  text-align:center;
Â  font-family:"Mountains of Christmas",cursive;
Â  font-size:48px;
Â  color:var(--accent-red);
Â  text-shadow:0 4px 26px rgba(0,0,0,0.6),0 0 18px rgba(255,255,255,0.4);
}
.lead{font-size:16px;line-height:1.5;color:#eae8e8;}

/* ---------- PERFIL ---------- */
.auth-container,.user-info{position:fixed;top:16px;right:16px;display:flex;align-items:center;gap:10px;z-index:10;}
.auth-button{padding:10px 18px;font-size:1em;color:white;background-color:#333;border:none;cursor:pointer;border-radius:6px;transition:all .2s;}
.auth-button:hover{transform:scale(1.08);box-shadow:0 0 30px rgba(255,255,255,0.4);}
.user-info{display:none;cursor:pointer;}
#userLogo{width:40px;height:40px;border-radius:50%;}
#userName{font-weight:600;font-size:1em;color:white;}

/* ---------- DROPDOWN ---------- */
.dropdown-menu{display:none;position:absolute;top:56px;right:0;background-color:#000;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.4);width:160px;text-align:left;z-index:10;}
.dropdown-menu td{padding:10px;cursor:pointer;color:white;}
.dropdown-menu td:hover{background-color:#333;}

/* ---------- PANEL ADMIN ---------- */
#adminPanel{display:none;text-align:left;}
#adminPanel table{width:100%;border-collapse:collapse;margin-top:8px;color:white;}
#adminPanel th,#adminPanel td{border:1px solid rgba(255,255,255,0.2);padding:6px 10px;font-size:14px;}
#adminPanel th{background:rgba(255,255,255,0.08);}

/* ---------- RESPONSIVE ---------- */
@media(max-width:720px){
Â  .header h1{font-size:36px;}
Â  .nav-button{font-size:14px;padding:8px 12px;}
}

/* ---------- ESTILOS DE MUÃ‘ECOS DE NIEVE (NUEVO) ---------- */
.snow-container{
Â  margin-top:30px;
Â  background:rgba(22,35,48,0.7); /* Oscurecido ligeramente */
Â  border-radius:10px;
Â  padding:20px;
Â  border:1px solid rgba(255,255,255,0.2);
Â  width:100%;
}
.snow-list div{
Â  padding:5px;
Â  margin:5px 0;
Â  border-bottom:1px dashed rgba(255,255,255,0.2);
}
.hidden-snowman{
Â  position:absolute;
Â  font-size:2rem;
Â  cursor:pointer;
Â  transition:0.25s;
Â  z-index:4; /* Para que estÃ© por encima del fondo y otros elementos */
}
.hidden-snowman.catched{
Â  opacity:0;
Â  transform:scale(0);
}
</style>
</head>
<body>
Â Â 
<div class="lights">
Â  <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
Â  <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
</div>

<script>
for(let i=0;i<40;i++){
Â  const snow=document.createElement("div");
Â  snow.className="snowflake";
Â  snow.textContent="â„ï¸";
Â  snow.style.left=Math.random()*100+"%";
Â  snow.style.fontSize=(Math.random()*10+10)+"px";
Â  snow.style.animationDuration=(Math.random()*6+6)+"s";
Â  snow.style.animationDelay=(Math.random()*6)+"s";
Â  document.body.appendChild(snow);
}
</script>

<div class="hidden-snowman" data-id="1">â›„</div>
<div class="hidden-snowman" data-id="2">â›„</div>
<div class="hidden-snowman" data-id="3">â›„</div>
<div class="hidden-snowman" data-id="4">â›„</div>
<div class="hidden-snowman" data-id="5">â›„</div>

<div class="scene-bg">
Â  <svg viewBox="0 0 1440 400" preserveAspectRatio="none">
Â  Â  <polygon points="0,400 0,260 200,300 400,220 600,280 800,240 1000,290 1200,260 1440,300 1440,400" fill="#fff"/>
Â  </svg>
</div>

<div class="container">
Â  <div class="header card">
Â  Â  <h1>ğŸ„ Pekeweb ğŸ</h1>
Â  Â  <p class="lead" style="margin-top:6px;">Un lugar para el alumnado â€” Â¡ahora con espÃ­ritu de Navidad! ğŸ…âœ¨</p>
Â  </div>
Â Â 
<div id="global-timer" style="margin-top:20px; padding:15px; background:#222; color:#fff; border-radius:10px; font-size:16px;"></div>

<div id="timer-admin" style="margin-top:15px; display:none; padding:15px; background:#111; border-radius:10px;">
Â  <h3 style="color:#8f8;">â± Crear Temporizador Global</h3>
Â  <label>Horas:</label>
Â  <input type="number" id="timer-hours" min="0" value="0" style="width:50px;">
Â  <label>Minutos:</label>
Â  <input type="number" id="timer-minutes" min="0" max="59" value="0" style="width:50px;">
Â  <label>Segundos:</label>
Â  <input type="number" id="timer-seconds" min="0" max="59" value="0" style="width:50px;">
Â  <br><br>
Â  <label>Texto explicativo:</label><br>
Â  <input type="text" id="timer-text" placeholder="Para quÃ© es el temporizador" style="width:100%; padding:5px; margin-top:5px;">
Â  <br><br>
Â  <button id="publishTimerBtn" style="padding:8px 15px; cursor:pointer;">ğŸ“¢ Publicar</button>
</div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green);margin-bottom:8px;">Bienvenidos</h2>
Â  Â  <p class="lead">AquÃ­ podÃ©is escribir, organizar grupos, votar y divertiros. Este espacio es para la comunidad del instituto.</p>
Â  Â  <div class="actions" style="margin-top:12px;">
Â  Â  Â  <button class="btn" onclick="location.href='c.html'">ğŸ° Casino ğŸ°</button>
Â  Â  Â  <button class="btn" onclick="location.href='golf.html'">ğŸ® Zona Arcade ğŸ®</button>
Â  Â  Â  <button class="btn" onclick="location.href='po.html'">ğŸ“œ PolÃ­tica ğŸ“œ</button>
Â  Â  Â  <button class="btn" onclick="location.href='periodico.html'">ğŸ“° Noticias ğŸ“°</button>
Â  Â  Â  <button class="btn" onclick="location.href='posts.html'">ğŸ“ Posts de la Pekeweb ğŸ“</button>
Â  Â  Â  <button class="btn" onclick="location.href='evento.html'">ğŸ„ Evento NavideÃ±o ğŸ</button>

Â  Â  Â  <button class="auth-button" onclick="location.href='admin.html'">Admin</button>
Â  Â  </div>
Â  </div>

<div class="snow-container card">
Â  Â  <h2>â›„ MuÃ±ecos de nieve recogidos</h2>
Â  Â  <p>Total: <b id="snowCount">0</b></p>
Â  Â  <div class="snow-list" id="snowList"></div>
</div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green)">Enviar PeticiÃ³n</h2>
Â  Â  <textarea id="peticionInput" placeholder="Escribe tu peticiÃ³n aquÃ­..." rows="3" style="width:100%;border-radius:6px;padding:8px;margin-bottom:8px;"></textarea>
Â  Â  <button class="btn" id="enviarPeticionBtn">Enviar PeticiÃ³n ğŸ</button>
Â  </div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green)">Enviar Reporte</h2>
Â  Â  <select id="tipoReporte" style="width:100%;padding:8px;border-radius:6px;margin-bottom:8px;">
Â  Â  Â  <option value="inapropiado">Contenido inapropiado</option>
Â  Â  Â  <option value="error">Error / fallo</option>
Â  Â  Â  <option value="otro">Otro</option>
Â  Â  </select>
Â  Â  <textarea id="reporteInput" placeholder="Describe el reporte..." rows="3" style="width:100%;border-radius:6px;padding:8px;margin-bottom:8px;"></textarea>
Â  Â  <button class="btn" id="enviarReporteBtn">Enviar Reporte ğŸ…</button>
Â  </div>

Â  <div class="card" id="adminPanel">
Â  Â  <h2 style="color:var(--accent-red)">Panel Admin</h2>
Â  Â  <h3>Peticiones</h3>
Â  Â  <table id="peticionesTable"><thead><tr><th>ID</th><th>Usuario</th><th>Contenido</th><th>Fecha</th></tr></thead><tbody></tbody></table>
Â  Â  <h3 style="margin-top:12px;">Reportes</h3>
Â  Â  <table id="reportesTable"><thead><tr><th>ID</th><th>Usuario</th><th>Tipo</th><th>DescripciÃ³n</th><th>Fecha</th></tr></thead><tbody></tbody></table>
Â  </div>
</div>

Â  <div id="timerPanel" style="display:none; margin-top:20px; padding:15px; background:#222; border-radius:10px;">
Â  Â  <h3>â± Crear / Actualizar Temporizador Global</h3>
Â  Â  <p>Selecciona la fecha final del evento:</p>
Â  Â Â 
Â  Â  <input type="datetime-local" id="timerDate" style="padding:5px; font-size:16px;">
Â  Â  <br><br>

Â  Â  <button id="saveTimerBtn" style="padding:10px; font-size:16px; cursor:pointer;">
Â  Â  Â  Â  Guardar temporizador
Â  Â  </button>

Â  Â  <p id="timerStatus" style="margin-top:10px; color:#8f8;"></p>
</div>


<div class="auth-container" id="authContainer">
Â  <button class="auth-button" onclick="location.href='l.html'">Iniciar sesiÃ³n / Registrarse</button>
</div>

<div class="user-info" id="userInfo" title="Abrir menÃº de usuario">
Â  <img id="userLogo" src="logoDefault.png" alt="Logo usuario">
Â  <div style="text-align:left">
Â  Â  <div id="userName" style="font-weight:600">Usuario</div>
Â  Â  <div style="font-size:12px;color:#cfcacd">Ver perfil</div>
Â  </div>
</div>

<div class="dropdown-menu" id="dropdownMenu">
Â  <table><tr><td onclick="logout()">ğŸšª Cerrar sesiÃ³n</td></tr></table>
</div>

<div class="nav-container">
Â  <button class="nav-button" onclick="location.href='b.html'">Blog</button>
Â  <button class="nav-button" onclick="location.href='ch.html'">Chat</button>
Â  <button class="nav-button" onclick="location.href='https://sites.google.com/arrigorriagabhi.net/ikasle'">Juegos</button>
Â  <button class="nav-button" onclick="location.href='e.html'">Encuesta</button>
</div>
Â Â 
Â Â 
<script>
Â Â 
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);


// ==================== MUÃ‘ECOS ESCONDIDOS (LÃ³gica simplificada) ====================
let snowmen = JSON.parse(localStorage.getItem("snowmen")) || [];
let collectedIDs = JSON.parse(localStorage.getItem("collectedSnowmenIDs")) || [];
const snowList = document.getElementById("snowList");
const snowCount = document.getElementById("snowCount");

function updateSnowList(){
Â  snowList.innerHTML="";
Â  snowmen.forEach(n=>{
Â  Â  const div=document.createElement("div");
Â  Â  div.textContent=n;
Â  Â  snowList.appendChild(div);
Â  });
Â  snowCount.textContent=snowmen.length;
}

document.addEventListener("DOMContentLoaded", () => {
Â  Â  updateSnowList();

Â  Â  document.querySelectorAll(".hidden-snowman").forEach(sm=>{
Â  Â  Â  Â  const id = sm.dataset.id;

Â  Â  Â  Â  // PosiciÃ³n aleatoria en la ventana (considerando un margen)
Â  Â  Â  Â  const padding = 50; // margen para que no se salga de la pantalla
Â  Â  Â  Â  const maxX = window.innerWidth - 50;
Â  Â  Â  Â  const maxY = window.innerHeight - 150; // dejando espacio para header y nav
Â  Â  Â  Â  sm.style.left = (Math.random() * (maxX - padding) + padding) + "px";
Â  Â  Â  Â  sm.style.top = (Math.random() * (maxY - padding) + padding) + "px";

Â  Â  Â  Â  // Ocultar si ya recogido
Â  Â  Â  Â  if(collectedIDs.includes(id)) sm.style.display="none";

Â  Â  Â  Â  sm.addEventListener("click", ()=>{
Â  Â  Â  Â  Â  Â  if(collectedIDs.includes(id)) return;

Â  Â  Â  Â  Â  Â  sm.classList.add("catched");
Â  Â  Â  Â  Â  Â  setTimeout(()=> sm.style.display="none", 200);

Â  Â  Â  Â  Â  Â  // Usa un nombre genÃ©rico, sin hacer referencia a coleccionables
Â  Â  Â  Â  Â  Â  snowmen.push("MuÃ±eco #" + (snowmen.length + 1)); 
Â  Â  Â  Â  Â  Â  localStorage.setItem("snowmen", JSON.stringify(snowmen));

Â  Â  Â  Â  Â  Â  collectedIDs.push(id);
Â  Â  Â  Â  Â  Â  localStorage.setItem("collectedSnowmenIDs", JSON.stringify(collectedIDs));

Â  Â  Â  Â  Â  Â  updateSnowList();

Â  Â  Â  Â  Â  Â  // NotificaciÃ³n simple
Â  Â  Â  Â  Â  Â  alert("â„ï¸ Â¡MuÃ±eco de nieve recogido! Llevas " + snowmen.length + " en total.");
Â  Â  Â  Â  });
Â  Â  });
});


// ==================== RESTO DEL SCRIPT ORIGINAL ====================

document.addEventListener("DOMContentLoaded", async () => {
Â  const authContainer = document.getElementById("authContainer");
Â  const userInfo = document.getElementById("userInfo");
Â  const adminPanel = document.getElementById("adminPanel");
Â  const timerAdmin = document.getElementById("timer-admin");
Â  const timerBox = document.getElementById("global-timer");

Â  let sendingPetition = false;
Â  let sendingReport = false;
Â  let currentUser = null;
Â  let countdownInterval = null;

Â  // -------------------------
Â  // Cargar info usuario
Â  // -------------------------
Â  async function loadUserInfo() {
Â  Â  try {
Â  Â  Â  const { data: { session } = {} } = await supabase.auth.getSession();
Â  Â  Â  if (session?.user) {
Â  Â  Â  Â  currentUser = {
Â  Â  Â  Â  Â  username: session.user.user_metadata?.username || session.user.email,
Â  Â  Â  Â  Â  email: session.user.email,
Â  Â  Â  Â  Â  logo: session.user.user_metadata?.logo || "logoDefault.png"
Â  Â  Â  Â  };
Â  Â  Â  Â  localStorage.setItem("currentUser", JSON.stringify(currentUser));
Â  Â  Â  } else {
Â  Â  Â  Â  currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.warn("No se pudo obtener session de supabase:", e);
Â  Â  Â  currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
Â  Â  }

Â  Â  if (currentUser) {
Â  Â  Â  userInfo && (userInfo.style.display = "flex");
Â  Â  Â  authContainer && (authContainer.style.display = "none");
Â  Â  Â  const nameEl = document.getElementById("userName");
Â  Â  Â  const logoEl = document.getElementById("userLogo");
Â  Â  Â  if (nameEl) nameEl.textContent = currentUser.username;
Â  Â  Â  if (logoEl) logoEl.src = currentUser.logo || "logoDefault.png";

Â  Â  Â  if (currentUser.username === "Peketruli") {
Â  Â  Â  Â  adminPanel && (adminPanel.style.display = "block");
Â  Â  Â  Â  timerAdmin && (timerAdmin.style.display = "block");
Â  Â  Â  Â  await loadAdminData();
Â  Â  Â  } else {
Â  Â  Â  Â  adminPanel && (adminPanel.style.display = "none");
Â  Â  Â  Â  timerAdmin && (timerAdmin.style.display = "none");
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  userInfo && (userInfo.style.display = "none");
Â  Â  Â  authContainer && (authContainer.style.display = "flex");
Â  Â  Â  adminPanel && (adminPanel.style.display = "none");
Â  Â  Â  timerAdmin && (timerAdmin.style.display = "none");
Â  Â  }
Â  }

Â  // -------------------------
Â  // Peticiones y reportes
Â  // -------------------------
Â  async function loadAdminData() {
Â  Â  if (!adminPanel) return;
Â  Â  const tbodyP = document.querySelector("#peticionesTable tbody");
Â  Â  const tbodyR = document.querySelector("#reportesTable tbody");
Â  Â  tbodyP && (tbodyP.innerHTML = "");
Â  Â  tbodyR && (tbodyR.innerHTML = "");

Â  Â  try {
Â  Â  Â  const { data: peticiones, error: errP } = await supabase
Â  Â  Â  Â  .from("peticiones")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .order("id", { ascending: false });

Â  Â  Â  if (errP) tbodyP.innerHTML = `<tr><td colspan="4" style="color:red;">Error cargando peticiones</td></tr>`;
Â  Â  Â  else if (!peticiones || peticiones.length === 0) tbodyP.innerHTML = `<tr><td colspan="4">No hay peticiones</td></tr>`;
Â  Â  Â  else peticiones.forEach(p => {
Â  Â  Â  Â  const fecha = p.created_at ? new Date(p.created_at).toLocaleString() : "Sin fecha";
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `<td>${p.id}</td><td>${escapeHtml(p.usuario)}</td><td>${escapeHtml(p.contenido)}</td><td>${fecha}</td>`;
Â  Â  Â  Â  tbodyP.appendChild(tr);
Â  Â  Â  });
Â  Â  } catch (e) { console.error(e); }

Â  Â  try {
Â  Â  Â  const { data: reportes, error: errR } = await supabase
Â  Â  Â  Â  .from("reportes")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .order("id", { ascending: false });

Â  Â  Â  if (errR) tbodyR.innerHTML = `<tr><td colspan="5" style="color:red;">Error cargando reportes</td></tr>`;
Â  Â  Â  else if (!reportes || reportes.length === 0) tbodyR.innerHTML = `<tr><td colspan="5">No hay reportes</td></tr>`;
Â  Â  Â  else reportes.forEach(r => {
Â  Â  Â  Â  const fecha = r.created_at ? new Date(r.created_at).toLocaleString() : "Sin fecha";
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `<td>${r.id}</td><td>${escapeHtml(r.usuario)}</td><td>${escapeHtml(r.tipo)}</td><td>${escapeHtml(r.descripcion)}</td><td>${fecha}</td>`;
Â  Â  Â  Â  tbodyR.appendChild(tr);
Â  Â  Â  });
Â  Â  } catch (e) { console.error(e); }
Â  }

Â  // -------------------------
Â  // Logout
Â  // -------------------------
Â  // Se mantiene la funciÃ³n global por si se llama desde el HTML
Â  window.logout = async function() {
Â  Â  try { await supabase.auth.signOut(); } catch(e){ console.warn(e); }
Â  Â  localStorage.removeItem("currentUser");
Â  Â  window.location.reload();
Â  };
Â  
Â  document.querySelector("#dropdownMenu td")?.addEventListener("click", window.logout);


Â  // -------------------------
Â  // Botones Peticiones / Reportes
Â  // -------------------------
Â  const petBtn = document.getElementById("enviarPeticionBtn");
Â  if (petBtn) petBtn.addEventListener("click", async () => {
Â  Â  if (!currentUser) return alert("Debes iniciar sesiÃ³n para enviar una peticiÃ³n.");
Â  Â  if (sendingPetition) return;
Â  Â  const contenido = (document.getElementById("peticionInput")?.value || "").trim();
Â  Â  if (!contenido) return alert("Escribe algo antes de enviar.");
Â  Â  sendingPetition = true;
Â  Â  petBtn.disabled = true;
Â  Â  petBtn.textContent = "Enviando...";
Â  Â  try {
Â  Â  Â  const created_at = new Date().toISOString();
Â  Â  Â  const { error } = await supabase.from("peticiones").insert([{ usuario: currentUser.username, contenido, created_at }]);
Â  Â  Â  if (!error) {
Â  Â  Â  Â  document.getElementById("peticionInput").value = "";
Â  Â  Â  Â  alert("âœ… PeticiÃ³n enviada con Ã©xito.");
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âŒ Error al enviar la peticiÃ³n: " + error.message);
Â  Â  Â  }
Â  Â  Â  await loadAdminData();
Â  Â  } finally {
Â  Â  Â  sendingPetition = false;
Â  Â  Â  petBtn.disabled = false;
Â  Â  Â  petBtn.textContent = "Enviar PeticiÃ³n ğŸ";
Â  Â  }
Â  });

Â  const repBtn = document.getElementById("enviarReporteBtn");
Â  if (repBtn) repBtn.addEventListener("click", async () => {
Â  Â  if (!currentUser) return alert("Debes iniciar sesiÃ³n para enviar un reporte.");
Â  Â  if (sendingReport) return;
Â  Â  const descripcion = (document.getElementById("reporteInput")?.value || "").trim();
Â  Â  if (!descripcion) return alert("Describe el reporte antes de enviar.");
Â  Â  sendingReport = true;
Â  Â  repBtn.disabled = true;
Â  Â  repBtn.textContent = "Enviando...";
Â  Â  try {
Â  Â  Â  const tipo = document.getElementById("tipoReporte")?.value || "otro";
Â  Â  Â  const created_at = new Date().toISOString();
Â  Â  Â  const { error } = await supabase.from("reportes").insert([{ usuario: currentUser.username, tipo, descripcion, created_at }]);
Â  Â  Â  if (!error) {
Â  Â  Â  Â  document.getElementById("reporteInput").value = "";
Â  Â  Â  Â  alert("âœ… Reporte enviado con Ã©xito.");
Â  Â  Â  } else {
Â  Â  Â  Â  alert("âŒ Error al enviar el reporte: " + error.message);
Â  Â  Â  }
Â  Â  Â  await loadAdminData();
Â  Â  } finally {
Â  Â  Â  sendingReport = false;
Â  Â  Â  repBtn.disabled = false;
Â  Â  Â  repBtn.textContent = "Enviar Reporte ğŸ…";
Â  Â  }
Â  });

Â  // -------------------------
Â  // Temporizador global
Â  // -------------------------
Â  async function loadTimer() {
Â  Â  const { data, error } = await supabase.from("event_timer").select("*").single();
Â  Â  if (!data || error) {
Â  Â  Â  timerBox.textContent = "No hay temporizador activo.";
Â  Â  Â  return;
Â  Â  }
Â  Â  startCountdown(new Date(data.end_time).getTime(), data.texto || "");
Â  }

Â  document.getElementById("publishTimerBtn")?.addEventListener("click", async () => {
Â  Â  if (!currentUser || currentUser.username !== "Peketruli") return;
Â  Â  const h = parseInt(document.getElementById("timer-hours").value) || 0;
Â  Â  const m = parseInt(document.getElementById("timer-minutes").value) || 0;
Â  Â  const s = parseInt(document.getElementById("timer-seconds").value) || 0;
Â  Â  const texto = document.getElementById("timer-text").value.trim();
Â  Â  const totalMs = (h*3600 + m*60 + s) * 1000;
Â  Â  if (totalMs <= 0) return alert("Introduce al menos un valor de duraciÃ³n.");
Â  Â  const endTime = new Date(Date.now() + totalMs);

Â  Â  const { error } = await supabase.from("event_timer").upsert({
Â  Â  Â  id: 1,
Â  Â  Â  end_time: endTime.toISOString(),
Â  Â  Â  texto
Â  Â  });

Â  Â  if (error) return alert("Error al guardar el temporizador.");
Â  Â  startCountdown(endTime.getTime(), texto);
Â  Â  alert("âœ… Temporizador publicado y activo para todos.");
Â  });

Â  function startCountdown(endTimestamp, texto="") {
Â  Â  if (countdownInterval) clearInterval(countdownInterval);
Â  Â  countdownInterval = setInterval(() => {
Â  Â  Â  const diff = endTimestamp - Date.now();
Â  Â  Â  if (diff <= 0) {
Â  Â  Â  Â  timerBox.innerHTML = `â³ Â¡Tiempo agotado!<br>${texto}`;
Â  Â  Â  Â  clearInterval(countdownInterval);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const hours = Math.floor(diff / 1000 / 60 / 60);
Â  Â  Â  const minutes = Math.floor((diff / 1000 / 60) % 60);
Â  Â  Â  const seconds = Math.floor((diff / 1000) % 60);
Â  Â  Â  timerBox.innerHTML = `â± Tiempo restante: ${hours}h ${minutes}m ${seconds}s<br>${texto}`;
Â  Â  }, 1000);
Â  }

Â  // -------------------------
Â  // Utilidad
Â  // -------------------------
Â  function escapeHtml(text) {
Â  Â  if (!text) return "";
Â  Â  return String(text)
Â  Â  Â  .replaceAll("&","&amp;")
Â  Â  Â  .replaceAll("<","&lt;")
Â  Â  Â  .replaceAll(">","&gt;")
Â  Â  Â  .replaceAll('"',"&quot;")
Â  Â  Â  .replaceAll("'","&#039;");
Â  }

Â  await loadUserInfo();
Â  await loadTimer();
});


</script>
</body>
</html>
