<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Casino - Recompensas</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
    body {
        background-color: #2c2c2c;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 50px;
    }

    .auth-container, .user-info {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .auth-button {
        padding: 10px 20px;
        font-size: 1em;
        color: white;
        background-color: #333;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    .user-info { display: none; cursor: pointer; }
    #userLogo { width: 40px; height: 40px; border-radius: 50%; }
    #userName { font-weight: bold; }

    .dropdown-menu {
        display: none;
        position: absolute;
        top: 60px;
        right: 20px;
        background-color: black;
        color: black;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        width: 150px;
        text-align: left;
    }
    .dropdown-menu td { padding: 10px; cursor: pointer; }
    .dropdown-menu td:hover { background-color: #ddd; color:black; }

    #pekepuntos {
        margin-top: 100px;
        font-size: 2em;
    }

    .section {
        margin-top: 40px;
        padding: 20px;
        background-color: #3a3a3a;
        border-radius: 10px;
    }

    .section h2 {
        margin-bottom: 20px;
        color: #ffcc00;
    }

    .top5-list, .rewards-list {
        list-style: none;
        padding: 0;
    }

    .top5-list li, .rewards-list li {
        padding: 10px;
        margin: 5px 0;
        background-color: #4a4a4a;
        border-radius: 5px;
    }

    .reward-button {
        padding: 10px 20px;
        margin: 5px;
        background-color: #ff4081;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .reward-button:hover { transform: scale(1.1); }

    .home-btn {
        padding: 10px 15px;
        background: #444;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
</style>
</head>
<body>
    <button class="home-btn" onclick="window.location.href='Hub.html'"> Volver a la Página Principal</button>

    <h1>🎰 Casino 🎰</h1>

    <div class="auth-container" id="authContainer">
        <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesión o registrarse</button>
    </div>

    <div class="user-info" id="userInfo">
        <h3 id="userName"></h3>
        <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
    </div>

    <div class="dropdown-menu" id="dropdownMenu">
        <table>
            <tr><td onclick="logout()">🚪 Cerrar sesión</td></tr>
        </table>
    </div>

    <div id="pekepuntos">Pekepuntos: 0</div>

    <!-- Top 5 usuarios -->
    <div class="section" id="top5Section">
        <h2>🏆 Top 5 Jugadores</h2>
        <ul class="top5-list" id="top5List"></ul>
    </div>

    <div class="section" id="gamesSection">
    <h2>🎮 Juegos Disponibles</h2>
    <button class="game-button" onclick="window.location.href='blackjack.html'">Blackjack</button>
    <button class="game-button" onclick="window.location.href='ruleta.html'">Ruleta</button>
    <button class="game-button" onclick="window.location.href='poker.html'">Poker</button>
</div>

    
<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; // pon tu key
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let top5Users = [];

document.addEventListener("DOMContentLoaded", function () {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
    loadUserInfo();
    loadTop5();

    const userInfo = document.getElementById("userInfo");
    const dropdownMenu = document.getElementById("dropdownMenu");
    userInfo.addEventListener("click", function () {
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", function (event) {
        if (!userInfo.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.style.display = "none";
        }
    });
});

function logout() {
    supabase.auth.signOut();
    localStorage.removeItem("currentUser");
    window.location.href = "login.html";
}

function loadUserInfo() {
    const user = currentUser;
    const authContainer = document.getElementById("authContainer");
    const userInfo = document.getElementById("userInfo");

    if (user) {
        userInfo.style.display = "flex";
        authContainer.style.display = "none";
        document.getElementById("userName").textContent = user.username || "Usuario";
        document.getElementById("userLogo").src = user.logo || "logoDefault.png";
        cargarPekepuntos(user.id);
    } else {
        userInfo.style.display = "none";
        authContainer.style.display = "flex";
    }
}

async function cargarPekepuntos(usuarioId) {
    const { data, error } = await supabase
        .from('usuarios')
        .select('pekepuntos')
        .eq('id', usuarioId)
        .single();

    if (error) {
        console.error(error);
        document.getElementById("pekepuntos").textContent = "Error al cargar Pekepuntos";
        return;
    }
    document.getElementById("pekepuntos").textContent = `Pekepuntos: ${data.pekepuntos}`;
}

async function claimBasicReward(num) {
    if (!currentUser) return alert("Debes iniciar sesión.");
    let amount = num === 1 ? 100 : num === 2 ? 200 : 300;
    await addPekepuntos(amount);
    alert(`🎉 Has reclamado la Recompensa ${num} (+${amount})`);
}

async function buyExclusiveReward() {
    if (!currentUser) return alert("Debes iniciar sesión.");
    const { data } = await supabase.from("usuarios").select("pekepuntos").eq("id", currentUser.id).single();
    if (data.pekepuntos < 500) return alert("No tienes suficientes puntos.");
    await addPekepuntos(-500);
    alert("🔥 Compraste la recompensa exclusiva del Top 5!");
}

async function claimTop3Reward() {
    if (!currentUser) return alert("Debes iniciar sesión.");
    await addPekepuntos(1000);
    alert("🏅 Has reclamado la recompensa especial del Top 3 (+1000)!");
}

async function claimTop1Reward() {
    if (!currentUser) return alert("Debes iniciar sesión.");
    await addPekepuntos(2000);
    alert("👑 Has reclamado la recompensa exclusiva del Campeón (+2000)!");
}

async function addPekepuntos(amount) {
    const { data, error } = await supabase
        .from("usuarios")
        .select("pekepuntos")
        .eq("id", currentUser.id)
        .single();
    if (error) return;

    const nuevos = data.pekepuntos + amount;
    await supabase.from("usuarios").update({ pekepuntos: nuevos }).eq("id", currentUser.id);
    cargarPekepuntos(currentUser.id);
}

async function loadTop5() {
    const { data, error } = await supabase
        .from('usuarios')
        .select('id, username, pekepuntos')
        .order('pekepuntos', { ascending: false })
        .limit(5);

    if (error) {
        console.error(error);
        return;
    }

    top5Users = data;
    const top5List = document.getElementById('top5List');
    top5List.innerHTML = "";
    data.forEach((user, index) => {
        const li = document.createElement('li');
        li.textContent = `${index + 1}. ${user.username} - ${user.pekepuntos} Pekepuntos`;
        top5List.appendChild(li);
    });

    // Verificar posición del usuario actual
    if (currentUser) {
        const pos = top5Users.findIndex(u => u.id === currentUser.id);
        if (pos !== -1) {
            if (pos <= 4) document.getElementById("exclusiveTop5").style.display = "block";
            if (pos <= 2) document.getElementById("exclusiveTop3").style.display = "block";
            if (pos === 0) document.getElementById("exclusiveTop1").style.display = "block";
        }
    }
}
</script>
</body>
</html>
