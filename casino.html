<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Casino - Recompensas</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  :root { --table-bg: #ffffff; --table-text: #000000; }

  body{
    background-color: #2c2c2c;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 40px;
  }

  .auth-container, .user-info {
    position: absolute; top: 20px; right: 20px; display:flex; gap:10px; align-items:center;
  }
  .auth-button { padding:8px 12px; background:#333; border-radius:6px; color:white; border:none; cursor:pointer; }
  .user-info { display:none; cursor:pointer; }
  #userLogo { width:40px; height:40px; border-radius:50%; object-fit:cover; }
  #userName { font-weight:700; margin-right:6px; }

  .dropdown-menu { display:none; position:absolute; top:60px; right:20px; background:#111; color:#fff; border-radius:6px; padding:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
  .dropdown-menu div { padding:8px; cursor:pointer; }
  .dropdown-menu div:hover { background:#222; }

  .section { margin-top:30px; padding:18px; background:#333; border-radius:10px; }
  .section h2 { color:#ffd54f; margin-bottom:12px; }

  .top5-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .top5-item { width:90%; background:#3b3b3b; border-radius:8px; padding:8px 12px; display:flex; align-items:center; gap:12px; color:white; }
  .top5-item img { width:36px; height:36px; border-radius:50%; object-fit:cover; }

  .game-button, .reward-button { padding:10px 14px; margin:6px; border-radius:8px; border:none; cursor:pointer; background:#ff4081; color:white; }
  .game-button:hover, .reward-button:hover { transform:scale(1.03); }

  /* Estilos para tablas del sitio (que cambiar√° la "recompensa 3") */
  table.site-table {
    width:90%;
    margin:14px auto;
    border-collapse:collapse;
    background: var(--table-bg);
    color: var(--table-text);
    border-radius:8px;
    overflow:hidden;
  }
  table.site-table th, table.site-table td {
    padding:10px 12px;
    border-bottom:1px solid rgba(0,0,0,0.08);
  }
  /* responsive */
  @media (max-width:600px){ .top5-item { width:100%; } }
</style>
</head>
<body>
  <button class="auth-button" onclick="window.location.href='Hub.html'">Volver a la P√°gina Principal</button>

  <h1>üé∞ Casino - Recompensas</h1>

  <div class="auth-container" id="authContainer">
    <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesi√≥n / Registrarse</button>
  </div>

  <div class="user-info" id="userInfo">
    <span id="userName">Usuario</span>
    <img id="userLogo" src="logoDefault.png" alt="logo"/>
  </div>

  <div class="dropdown-menu" id="dropdownMenu">
    <div onclick="logout()">üö™ Cerrar sesi√≥n</div>
  </div>

  <div id="pekepuntos" style="margin-top:20px; font-size:1.2rem;">Pekepuntos: 0</div>

  <!-- TOP 5 -->
  <div class="section" id="top5Section">
    <h2>üèÜ Top 5 Jugadores</h2>
    <ul id="top5List" class="top5-list"></ul>
  </div>

  <!-- Juegos -->
  <div class="section" id="gamesSection">
    <h2>üéÆ Juegos Disponibles</h2>
    <button class="game-button" onclick="window.location.href='blackjack.html'">Blackjack</button>
    <button class="game-button" onclick="window.location.href='ruleta.html'">Ruleta</button>
    <button class="game-button" onclick="window.location.href='poker.html'">Poker</button>
  </div>

  <!-- Recompensas -->
  <div class="section" id="rewardsSection">
    <h2>üéÅ Recompensas (Personalizaciones)</h2>

    <!-- Recompensa 1: Cambiar fondo -->
    <div style="margin-bottom:12px;">
      <button class="reward-button" id="rewardBgBtn">Recompensa 1: Cambiar Fondo</button>
      <input type="color" id="backgroundPicker" style="display:none; margin-left:8px;" />
    </div>

    <!-- Recompensa 2: Cambiar color del nombre (visible para todos) -->
    <div style="margin-bottom:12px;">
      <button class="reward-button" id="rewardNameBtn">Recompensa 2: Cambiar Color del Nombre</button>
      <input type="color" id="nameColorPicker" style="display:none; margin-left:8px;" />
    </div>

    <!-- Recompensa 3: Cambiar color de las tablas -->
    <div style="margin-bottom:12px;">
     <button class="reward-button" id="reward3Btn">Recompensa 3: Cambiar color de tablas</button>
<input type="color" id="tableColorPicker" style="display:none;" onchange="setTableColor(this.value)">
    </div>

    <!-- Recompensas por ranking -->
    <div id="exclusiveTop5" style="display:none; margin-top:10px;">üéñ Est√°s en Top 5 ‚Üí tu foto aparece en la lista.</div>
    <div id="exclusiveTop3" style="display:none; margin-top:6px;">ü•â Top 3 ‚Üí nombre en <span style="color:#b87333">cobre</span>.</div>
    <div id="exclusiveTop2" style="display:none; margin-top:6px;">ü•à Top 2 ‚Üí nombre en <span style="color:silver">plata</span>.</div>
    <div id="exclusiveTop1" style="display:none; margin-top:6px;">üëë Top 1 ‚Üí nombre en <span style="color:gold">oro</span>.</div>
  </div>

<script>
  /* --------- CONFIGURA SUPABASE AQUI ---------- */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
/* -------------------------------------------- */

let currentUser = null;
let authUser = null;

document.addEventListener("DOMContentLoaded", async () => {
  // Eventos UI
  document.getElementById("reward3Btn").addEventListener("click", () => toggleShow("tableColorPicker"));
  document.getElementById("rewardBgBtn").addEventListener("click", () => toggleShow("backgroundPicker"));
  document.getElementById("rewardNameBtn").addEventListener("click", () => toggleShow("nameColorPicker"));

  document.getElementById("backgroundPicker").addEventListener("input", (e) => setBackgroundColor(e.target.value));
  document.getElementById("nameColorPicker").addEventListener("input", (e) => setNameColor(e.target.value));
  document.getElementById("tableColorPicker").addEventListener("input", (e) => setTableColor(e.target.value));

  document.getElementById("userInfo").addEventListener("click", toggleDropdown);
  document.addEventListener("click", (e) => {
    const ui = document.getElementById("userInfo"),
      dd = document.getElementById("dropdownMenu");
    if (!ui.contains(e.target) && !dd.contains(e.target)) dd.style.display = "none";
  });

  await initUserAndUI();
  setTimeout(loadTop5, 1500);
});

/* ---------- INIT: obtener sesi√≥n y datos de usuario ---------- */
async function initUserAndUI() {
  // primero intenta cargar desde localStorage
  const saved = localStorage.getItem("currentUser");
  let local = null;
  if (saved) {
    try {
      local = JSON.parse(saved);
    } catch (e) {
      local = null;
    }
  }

  // si ya existe en localStorage, cargarlo directamente
  if (local && local.id) {
    const row = await fetchUserRow("id", local.id);
    if (row) {
      currentUser = row;
      renderUserUI();
      return;
    }
  }

  // si no hay en localStorage, intenta Supabase Auth
  try {
    const { data: authData, error: authErr } = await supabase.auth.getUser();
    if (authErr) console.warn("auth.getUser() error:", authErr);
    authUser = authData?.user || null;
  } catch (e) {
    console.error("Error calling supabase.auth.getUser():", e);
    authUser = null;
  }

  let row = null;
  if (authUser && authUser.id) {
    row = await fetchUserRow("auth_id", authUser.id);
    if (!row && authUser.email) row = await fetchUserRow("email", authUser.email);
  }

  if (!row && local && local.email) row = await fetchUserRow("email", local.email);

  if (!row) {
    currentUser = null;
    document.getElementById("userInfo").style.display = "none";
    document.getElementById("authContainer").style.display = "flex";
    document.getElementById("pekepuntos").textContent = "Pekepuntos: ‚Äî";
    console.info("No se encontr√≥ fila en tabla usuarios para la sesi√≥n actual.");
    return;
  }

  currentUser = row;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  renderUserUI();
}

/* ---------- renderizar datos del usuario ---------- */
function renderUserUI() {
  document.getElementById("userInfo").style.display = "flex";
  document.getElementById("authContainer").style.display = "none";
  document.getElementById("userName").textContent = currentUser.username || "Usuario";
  document.getElementById("userLogo").src = currentUser.logo || "logoDefault.png";
  document.getElementById("pekepuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos ?? 0}`;

  if (currentUser.fondo_color) document.body.style.backgroundColor = currentUser.fondo_color;
  if (currentUser.nombre_color) document.getElementById("userName").style.color = currentUser.nombre_color;
  if (currentUser.tabla_color) {
    applyTableColor(currentUser.tabla_color);
    const picker = document.getElementById("tableColorPicker");
    if (picker) picker.value = currentUser.tabla_color;
  }
}

/* helper para pedir la fila del usuario */
async function fetchUserRow(column, value) {
  try {
    const { data, error } = await supabase
      .from("usuarios")
      .select("*")
      .eq(column, value)
      .limit(1)
      .maybeSingle();
    if (error) {
      console.warn(`fetchUserRow error by ${column}:`, error);
      return null;
    }
    return data || null;
  } catch (e) {
    console.error("fetchUserRow exception:", e);
    return null;
  }
}

async function loadTop5() {
  try {
    const top5List = document.getElementById("top5List");
    top5List.innerHTML = '<li style="color:#aaa;">Cargando top 5...</li>';

    const { data, error } = await supabase
      .from("usuarios")
      .select("id, username, pekepuntos, logo, nombre_color, foto_desbloqueada, recompensa3_desbloqueada")
      .order("pekepuntos", { ascending: false })
      .limit(5);

    if (error) {
      top5List.innerHTML = `<li style="color:red;">‚ùå Error al cargar el Top 5:<br>${error.message}</li>`;
      return;
    }

    if (!data || data.length === 0) {
      top5List.innerHTML = '<li style="color:#ccc;">(No hay jugadores a√∫n en la base de datos)</li>';
      return;
    }

    top5List.innerHTML = "";

    data.forEach((u, idx) => {
      const li = document.createElement("li");
      li.className = "top5-item";

      let nameColor = u.nombre_color || "#fff";
      if (idx === 0 && u.nombre_color === "gold") nameColor = "gold";
      else if (idx === 1 && u.nombre_color === "silver") nameColor = "silver";
      else if (idx === 2 && u.nombre_color === "#b87333") nameColor = "#b87333";

      const imgHtml = u.logo
        ? `<img src="${u.logo}" alt="logo">`
        : `<div style="width:36px;height:36px;border-radius:50%;background:#666;"></div>`;

      // bot√≥n para reclamar recompensa si es el usuario actual y no la tiene desbloqueada
      let rewardBtn = '';
      if(currentUser && u.id === currentUser.id){
        if(idx <= 4 && !currentUser.foto_desbloqueada){
          rewardBtn = `<button onclick="reclamarFoto()" class="reward-button" style="margin-left:8px;">Reclamar foto Top 5</button>`;
        }
        if(idx === 2 && !currentUser.recompensa3_desbloqueada){
          rewardBtn += `<button onclick="reclamarCobre()" class="reward-button" style="margin-left:8px;">Reclamar cobre</button>`;
        }
        if(idx === 1 && !currentUser.recompensa2_desbloqueada){
          rewardBtn += `<button onclick="reclamarPlata()" class="reward-button" style="margin-left:8px;">Reclamar plata</button>`;
        }
        if(idx === 0 && !currentUser.recompensa1_desbloqueada){
          rewardBtn += `<button onclick="reclamarOro()" class="reward-button" style="margin-left:8px;">Reclamar oro</button>`;
        }
      }

      li.innerHTML = `
        ${imgHtml}
        <div style="flex:1;text-align:left;">
          <strong style="color:${nameColor}">${idx + 1}. ${u.username}</strong>
          <div style="font-size:0.9rem;color:#ddd;">${u.pekepuntos ?? 0} Pekepuntos</div>
        </div>
        ${rewardBtn}
      `;

      top5List.appendChild(li);
    });

    // mostrar rangos especiales y aplicar colores
    if(currentUser && currentUser.id){
      const pos = data.findIndex(x => x.id === currentUser.id);
      ["exclusiveTop5","exclusiveTop3","exclusiveTop2","exclusiveTop1"].forEach(id => document.getElementById(id).style.display='none');

      if(pos !== -1){
        if(pos<=4) document.getElementById("exclusiveTop5").style.display='block';
        if(pos<=2 && currentUser.nombre_color === "#b87333") document.getElementById("exclusiveTop3").style.display='block';
        if(pos===1 && currentUser.nombre_color === "silver") document.getElementById("exclusiveTop2").style.display='block';
        if(pos===0 && currentUser.nombre_color === "gold") document.getElementById("exclusiveTop1").style.display='block';

        // colorear nombre
        if(pos===0 && currentUser.nombre_color === "gold") document.getElementById("userName").style.color="gold";
        else if(pos===1 && currentUser.nombre_color === "silver") document.getElementById("userName").style.color="silver";
        else if(pos===2 && currentUser.nombre_color === "#b87333") document.getElementById("userName").style.color="#b87333";
        else if(currentUser.nombre_color) document.getElementById("userName").style.color=currentUser.nombre_color;
      }
    }
  } catch(e){
    console.error("loadTop5 exception:", e);
  }
}

// funciones para reclamar recompensas
async function reclamarFoto(){
  if(!currentUser) return alert("Debes iniciar sesi√≥n");
  const { error } = await supabase.from("usuarios").update({ foto_desbloqueada:true }).eq("id", currentUser.id);
  if(error) return alert("Error al desbloquear foto");
  currentUser.foto_desbloqueada = true;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  alert("‚úÖ Foto desbloqueada!");
  loadTop5();
}

async function reclamarCobre(){
  if(!currentUser) return alert("Debes iniciar sesi√≥n");
  const { error } = await supabase.from("usuarios").update({ recompensa3_desbloqueada:true }).eq("id", currentUser.id);
  if(error) return alert("Error al desbloquear cobre");
  currentUser.recompensa3_desbloqueada = true;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  alert("‚úÖ Recompensa cobre desbloqueada!");
  loadTop5();
}

async function reclamarPlata(){
  if(!currentUser) return alert("Debes iniciar sesi√≥n");
  const { error } = await supabase.from("usuarios").update({ recompensa2_desbloqueada:true }).eq("id", currentUser.id);
  if(error) return alert("Error al desbloquear plata");
  currentUser.recompensa2_desbloqueada = true;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  alert("‚úÖ Recompensa plata desbloqueada!");
  loadTop5();
}

async function reclamarOro(){
  if(!currentUser) return alert("Debes iniciar sesi√≥n");
  const { error } = await supabase.from("usuarios").update({ recompensa1_desbloqueada:true }).eq("id", currentUser.id);
  if(error) return alert("Error al desbloquear oro");
  currentUser.recompensa1_desbloqueada = true;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  alert("‚úÖ Recompensa oro desbloqueada!");
  loadTop5();
}


/* ---------- RECOMPENSAS: guardar y aplicar estilos ---------- */
async function setBackgroundColor(color) {
  document.body.style.backgroundColor = color;
  if (!currentUser || !currentUser.id)
    return alert("Debes iniciar sesi√≥n para usar esta recompensa.");
  const { error } = await supabase.from("usuarios").update({ fondo_color: color }).eq("id", currentUser.id);
  if (error) {
    console.error("Error guardando fondo_color:", error);
    alert("Error guardando color de fondo");
    return;
  }
  currentUser.fondo_color = color;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

async function setNameColor(color) {
  document.getElementById("userName").style.color = color;
  if (!currentUser || !currentUser.id)
    return alert("Debes iniciar sesi√≥n para usar esta recompensa.");
  const { error } = await supabase.from("usuarios").update({ nombre_color: color }).eq("id", currentUser.id);
  if (error) {
    console.error("Error guardando nombre_color:", error);
    alert("Error guardando color de nombre");
    return;
  }
  currentUser.nombre_color = color;
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

async function setTableColor(color){
  // aplicar inmediatamente
  applyTableColor(color);

  if(!currentUser || !currentUser.id) 
    return alert('Debes iniciar sesi√≥n para usar esta recompensa.');

  // guardar en la BDD
  const { error } = await supabase.from('usuarios').update({ tabla_color: color }).eq('id', currentUser.id);
  if (error) { 
    console.error('Error guardando tabla_color:', error); 
    alert('‚ùå Error al guardar el color en Supabase (revisa consola)'); 
    return; 
  }

  // success: actualizar currentUser y localStorage
  currentUser.tabla_color = color;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  alert('‚úÖ Color de secciones guardado correctamente.');
}

/* aplica color a todas las secciones y a las tablas si quieres mantenerlas */
function applyTableColor(color){
  const lum = luminanceFromHex(color);
  const textColor = lum < 0.5 ? '#ffffff' : '#000000';

  // cambiar fondo y texto de las secciones principales
  document.querySelectorAll('.section').forEach(sec => {
    sec.style.backgroundColor = color;
    sec.style.color = textColor;
  });

  // si quieres tambi√©n afectar las tablas de ejemplo
  document.querySelectorAll('table').forEach(tbl => {
    tbl.style.backgroundColor = color;
    tbl.style.color = textColor;
  });
}

/* ---------- util ---------- */
function toggleDropdown() {
  const dd = document.getElementById("dropdownMenu");
  dd.style.display = dd.style.display === "block" ? "none" : "block";
}
function toggleShow(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === "block" ? "none" : "block";
}
function luminanceFromHex(hex) {
  try {
    const h = hex.replace("#", "");
    const r = parseInt(h.substring(0, 2), 16) / 255;
    const g = parseInt(h.substring(2, 4), 16) / 255;
    const b = parseInt(h.substring(4, 6), 16) / 255;
    const srgb = [r, g, b].map((c) =>
      c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)
    );
    return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
  } catch (e) {
    return 1;
  }
}

</script>
</body>
</html>
