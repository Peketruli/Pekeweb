<!DOCTYPE html>

<html lang="es">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1" />  
<title>Casino - Recompensas</title>  
<script src="https://unpkg.com/@supabase/supabase-js"></script>  
<style>  
  :root { --table-bg: #ffffff; --table-text: #000000; }  body{
background-color: #2c2c2c;
color: white;
font-family: Arial, sans-serif;
text-align: center;
padding: 40px;
}

.auth-container, .user-info {
position: absolute; top: 20px; right: 20px; display:flex; gap:10px; align-items:center;
}
.auth-button { padding:8px 12px; background:#333; border-radius:6px; color:white; border:none; cursor:pointer; }
.user-info { display:none; cursor:pointer; }
#userLogo { width:40px; height:40px; border-radius:50%; object-fit:cover; }
#userName { font-weight:700; margin-right:6px; }

.dropdown-menu { display:none; position:absolute; top:60px; right:20px; background:#111; color:#fff; border-radius:6px; padding:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
.dropdown-menu div { padding:8px; cursor:pointer; }
.dropdown-menu div:hover { background:#222; }

.section { margin-top:30px; padding:18px; background:#333; border-radius:10px; }
.section h2 { color:#ffd54f; margin-bottom:12px; }

.top5-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; align-items:center; }
.top5-item { width:90%; background:#3b3b3b; border-radius:8px; padding:8px 12px; display:flex; align-items:center; gap:12px; color:white; }
.top5-item img { width:36px; height:36px; border-radius:50%; object-fit:cover; }

.game-button, .reward-button { padding:10px 14px; margin:6px; border-radius:8px; border:none; cursor:pointer; background:#ff4081; color:white; }
.game-button:hover, .reward-button:hover { transform:scale(1.03); }

table.site-table {
width:90%;
margin:14px auto;
border-collapse:collapse;
background: var(--table-bg);
color: var(--table-text);
border-radius:8px;
overflow:hidden;
}
table.site-table th, table.site-table td {
padding:10px 12px;
border-bottom:1px solid rgba(0,0,0,0.08);
}

@media (max-width:600px){ .top5-item { width:100%; } }
</style>

</head>  
<body>  
<button class="auth-button" onclick="window.location.href='Hub.html'">Volver a la P√°gina Principal</button>  <h1>üé∞ Casino - Recompensas</h1>  <div class="auth-container" id="authContainer">  
  <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesi√≥n / Registrarse</button>  
</div>  <div class="user-info" id="userInfo">  
  <span id="userName">Usuario</span>  
  <img id="userLogo" src="logoDefault.png" alt="logo"/>  
</div>  <div class="dropdown-menu" id="dropdownMenu">  
  <div onclick="logout()">üö™ Cerrar sesi√≥n</div>  
</div>  <div id="pekepuntos" style="margin-top:20px; font-size:1.2rem;">Pekepuntos: 0</div>  <div class="section" id="top5Section">  
  <h2>üèÜ Top 5 Jugadores</h2>  
  <ul id="top5List" class="top5-list"></ul>  
</div>  <div class="section" id="gamesSection">  
  <h2>üéÆ Juegos Disponibles</h2>  
  <button class="game-button" onclick="window.location.href='blackjack.html'">Blackjack</button>  
  <button class="game-button" onclick="window.location.href='ruleta.html'">Ruleta</button>  
  <button class="game-button" onclick="window.location.href='poker.html'">Poker</button>  
</div>  <div class="section" id="rewardsSection">  
  <h2>üéÅ Recompensas (Personalizaciones)</h2>    <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardBgBtn">Recompensa 1: Cambiar Fondo</button>  
    <input type="color" id="backgroundPicker" style="display:none; margin-left:8px;" />  
  </div>    <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardNameBtn">Recompensa 2: Cambiar Color del Nombre</button>  
    <input type="color" id="nameColorPicker" style="display:none; margin-left:8px;" />  
  </div>    <div style="margin-bottom:12px;">  
    <button class="reward-button" id="reward3Btn">Recompensa 3: Cambiar color de tablas</button>  
    <input type="color" id="tableColorPicker" style="display:none;" onchange="setTableColor(this.value)">  
  </div>    <div id="exclusiveTop5" style="display:none; margin-top:10px;">üéñ Est√°s en Top 5 ‚Üí tu foto aparece en la lista.</div>  
  <div id="exclusiveTop3" style="display:none; margin-top:6px;">ü•â Top 3 ‚Üí nombre en <span style="color:#b87333">cobre</span>.</div>  
  <div id="exclusiveTop2" style="display:none; margin-top:6px;">ü•à Top 2 ‚Üí nombre en <span style="color:silver">plata</span>.</div>  
  <div id="exclusiveTop1" style="display:none; margin-top:6px;">üëë Top 1 ‚Üí nombre en <span style="color:gold">oro</span>.</div>  
</div>  <script>  
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";  
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";  
const { createClient } = window.supabase;  
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);  
  
let currentUser = null;  
  
document.addEventListener("DOMContentLoaded", async () => {  
  document.getElementById("reward3Btn").addEventListener("click", () => toggleShow("tableColorPicker"));  
  document.getElementById("rewardBgBtn").addEventListener("click", () => toggleShow("backgroundPicker"));  
  document.getElementById("rewardNameBtn").addEventListener("click", () => toggleShow("nameColorPicker"));  
  
  document.getElementById("backgroundPicker").addEventListener("input", (e) => setBackgroundColor(e.target.value));  
  document.getElementById("nameColorPicker").addEventListener("input", (e) => setNameColor(e.target.value));  
  document.getElementById("tableColorPicker").addEventListener("input", (e) => setTableColor(e.target.value));  
  
  document.getElementById("userInfo").addEventListener("click", toggleDropdown);  
  document.addEventListener("click", (e) => {  
    const ui = document.getElementById("userInfo"), dd = document.getElementById("dropdownMenu");  
    if (!ui.contains(e.target) && !dd.contains(e.target)) dd.style.display = "none";  
  });  
  
  await initUser();  
  await loadTop5();  
});  
  
async function initUser() {  
  const saved = localStorage.getItem("currentUser");  
  if(saved){  
    try{ currentUser = JSON.parse(saved); renderUserUI(); return; }catch{}  
  }  
  
  const { data: authData } = await supabase.auth.getUser();  
  if(authData?.user){  
    const { data } = await supabase.from("usuarios").select("*").eq("auth_id", authData.user.id).limit(1).maybeSingle();  
    if(data){ currentUser = data; localStorage.setItem("currentUser", JSON.stringify(currentUser)); renderUserUI(); }  
  }  
}  
  
function renderUserUI(){  
  document.getElementById("userInfo").style.display="flex";  
  document.getElementById("authContainer").style.display="none";  
  document.getElementById("userName").textContent=currentUser.username||"Usuario";  
  document.getElementById("userLogo").src=currentUser.logo||"logoDefault.png";  
  document.getElementById("pekepuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos ? Number(currentUser.pekepuntos) : 0}`;  
  if(currentUser.fondo_color) document.body.style.backgroundColor=currentUser.fondo_color;  
  if(currentUser.nombre_color) document.getElementById("userName").style.color=currentUser.nombre_color;  
  if(currentUser.tabla_color) { applyTableColor(currentUser.tabla_color); document.getElementById("tableColorPicker").value=currentUser.tabla_color; }  
}  
  
async function loadTop5(){
  const top5List = document.getElementById("top5List");
  top5List.innerHTML = '<li style="color:#aaa;">Cargando top 5...</li>';

  try {
    const { data, error } = await supabase
      .from("usuarios")
      .select("id, username, pekepuntos, logo, nombre_color")
      .order("pekepuntos", { ascending: false })
      .limit(5);

    if (error) {
      top5List.innerHTML = `<li style="color:red;">‚ùå Error al cargar el Top 5:<br>${error.message}</li>`;
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      top5List.innerHTML = '<li style="color:#ccc;">(No hay jugadores a√∫n en la base de datos)</li>';
      return;
    }

    // üî• Conversi√≥n robusta
    const fixedData = data.map(u => ({
      ...u,
      pekepuntos: u.pekepuntos !== null && u.pekepuntos !== undefined
        ? parseInt(u.pekepuntos)
        : 0
    }));

    console.log("TOP5 data:", fixedData); // üëÄ Comprueba en la consola qu√© valores llegan

    top5List.innerHTML = "";
    fixedData.forEach((u, idx) => {
      const li = document.createElement("li");
      li.className = "top5-item";
      const nameColor = (idx === 0)
        ? "gold"
        : (idx === 1)
        ? "silver"
        : (idx === 2)
        ? "#b87333"
        : u.nombre_color || "#fff";
      const imgHtml = u.logo
        ? `<img src="${u.logo}" alt="logo">`
        : `<div style="width:36px;height:36px;border-radius:50%;background:#666;"></div>`;
      li.innerHTML = `
        ${imgHtml}
        <div style="flex:1;text-align:left;">
          <strong style="color:${nameColor}">${idx + 1}. ${u.username || 'Jugador'}</strong>
          <div style="font-size:0.9rem;color:#ddd;">${u.pekepuntos} Pekepuntos</div>
        </div>
      `;
      top5List.appendChild(li);
    });

  } catch (e) {
    console.error("loadTop5 exception:", e);
    top5List.innerHTML = '<li style="color:red;">Error cargando Top 5 (revisa consola)</li>';
  }
}
  
    top5List.innerHTML = "";  
    data.forEach((u, idx) => {  
      const li = document.createElement("li");  
      li.className = "top5-item";  
      const nameColor = (idx === 0) ? "gold" : (idx === 1) ? "silver" : (idx === 2) ? "#b87333" : u.nombre_color || "#fff";  
      const imgHtml = u.logo ? `<img src="${u.logo}" alt="logo">` : `<div style="width:36px;height:36px;border-radius:50%;background:#666;"></div>`;  
      li.innerHTML = `  
        ${imgHtml}  
        <div style="flex:1;text-align:left;">  
          <strong style="color:${nameColor}">${idx+1}. ${u.username || 'Jugador'}</strong>  
          <div style="font-size:0.9rem;color:#ddd;">${u.pekepuntos.toLocaleString()} Pekepuntos</div>  
        </div>  
      `;  
      top5List.appendChild(li);  
    });  
  
  } catch(e){  
    console.error("loadTop5 exception:", e);  
    top5List.innerHTML = '<li style="color:red;">Error cargando Top 5 (revisa consola)</li>';  
  }  
}  
  
  
function toggleDropdown(){ const dd=document.getElementById("dropdownMenu"); dd.style.display = dd.style.display==="block"?"none":"block"; }  
function toggleShow(id){ const el=document.getElementById(id); el.style.display = el.style.display==="block"?"none":"block"; }  
function applyTableColor(color){ document.querySelectorAll('.section').forEach(sec=>sec.style.backgroundColor=color); document.querySelectorAll('table').forEach(tbl=>tbl.style.backgroundColor=color); }  
async function setBackgroundColor(color){ document.body.style.backgroundColor=color; if(currentUser){ await supabase.from("usuarios").update({fondo_color:color}).eq("id",currentUser.id); currentUser.fondo_color=color; localStorage.setItem("currentUser",JSON.stringify(currentUser)); } }  
async function setNameColor(color){ document.getElementById("userName").style.color=color; if(currentUser){ await supabase.from("usuarios").update({nombre_color:color}).eq("id",currentUser.id); currentUser.nombre_color=color; localStorage.setItem("currentUser",JSON.stringify(currentUser)); } }  
async function setTableColor(color){ applyTableColor(color); if(currentUser){ await supabase.from("usuarios").update({tabla_color:color}).eq("id",currentUser.id); currentUser.tabla_color=color; localStorage.setItem("currentUser",JSON.stringify(currentUser)); } }  
  
</script> 
</body>  
</html>
