<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Casino - Recompensas</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  :root { --table-bg: #ffffff; --table-text: #000000; }

  body{
    background-color: #2c2c2c;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 40px;
  }

  .auth-container, .user-info {
    position: absolute; top: 20px; right: 20px; display:flex; gap:10px; align-items:center;
  }
  .auth-button { padding:8px 12px; background:#333; border-radius:6px; color:white; border:none; cursor:pointer; }
  .user-info { display:none; cursor:pointer; }
  #userLogo { width:40px; height:40px; border-radius:50%; object-fit:cover; }
  #userName { font-weight:700; margin-right:6px; }

  .dropdown-menu { display:none; position:absolute; top:60px; right:20px; background:#111; color:#fff; border-radius:6px; padding:8px; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
  .dropdown-menu div { padding:8px; cursor:pointer; }
  .dropdown-menu div:hover { background:#222; }

  .section { margin-top:30px; padding:18px; background:#333; border-radius:10px; }
  .section h2 { color:#ffd54f; margin-bottom:12px; }

  .top5-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .top5-item { width:90%; background:#3b3b3b; border-radius:8px; padding:8px 12px; display:flex; align-items:center; gap:12px; color:white; }
  .top5-item img { width:36px; height:36px; border-radius:50%; object-fit:cover; }

  .game-button, .reward-button { padding:10px 14px; margin:6px; border-radius:8px; border:none; cursor:pointer; background:#ff4081; color:white; }
  .game-button:hover, .reward-button:hover { transform:scale(1.03); }

  /* Estilos para tablas del sitio (que cambiar√° la "recompensa 3") */
  table.site-table {
    width:90%;
    margin:14px auto;
    border-collapse:collapse;
    background: var(--table-bg);
    color: var(--table-text);
    border-radius:8px;
    overflow:hidden;
  }
  table.site-table th, table.site-table td {
    padding:10px 12px;
    border-bottom:1px solid rgba(0,0,0,0.08);
  }
  /* responsive */
  @media (max-width:600px){ .top5-item { width:100%; } }
</style>
</head>
<body>
  <button class="auth-button" onclick="window.location.href='Hub.html'">Volver a la P√°gina Principal</button>

  <h1>üé∞ Casino - Recompensas</h1>

  <div class="auth-container" id="authContainer">
    <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesi√≥n / Registrarse</button>
  </div>

  <div class="user-info" id="userInfo">
    <span id="userName">Usuario</span>
    <img id="userLogo" src="logoDefault.png" alt="logo"/>
  </div>

  <div class="dropdown-menu" id="dropdownMenu">
    <div onclick="logout()">üö™ Cerrar sesi√≥n</div>
  </div>

  <div id="pekepuntos" style="margin-top:20px; font-size:1.2rem;">Pekepuntos: 0</div>

  <!-- TOP 5 -->
  <div class="section" id="top5Section">
    <h2>üèÜ Top 5 Jugadores</h2>
    <ul id="top5List" class="top5-list"></ul>
  </div>

  <!-- Juegos -->
  <div class="section" id="gamesSection">
    <h2>üéÆ Juegos Disponibles</h2>
    <button class="game-button" onclick="window.location.href='blackjack.html'">Blackjack</button>
    <button class="game-button" onclick="window.location.href='ruleta.html'">Ruleta</button>
    <button class="game-button" onclick="window.location.href='poker.html'">Poker</button>
  </div>

  <!-- Recompensas -->
  <div class="section" id="rewardsSection">
    <h2>üéÅ Recompensas (Personalizaciones)</h2>

    <!-- Recompensa 1: Cambiar fondo -->
    <div style="margin-bottom:12px;">
      <button class="reward-button" id="rewardBgBtn">Recompensa 1: Cambiar Fondo</button>
      <input type="color" id="backgroundPicker" style="display:none; margin-left:8px;" />
    </div>

    <!-- Recompensa 2: Cambiar color del nombre (visible para todos) -->
    <div style="margin-bottom:12px;">
      <button class="reward-button" id="rewardNameBtn">Recompensa 2: Cambiar Color del Nombre</button>
      <input type="color" id="nameColorPicker" style="display:none; margin-left:8px;" />
    </div>

    <!-- Recompensa 3: Cambiar color de las tablas -->
    <div style="margin-bottom:12px;">
     <button class="reward-button" id="reward3Btn">Recompensa 3: Cambiar color de tablas</button>
<input type="color" id="tableColorPicker" style="display:none;" onchange="setTableColor(this.value)">
    </div>

    <!-- Recompensas por ranking -->
    <div id="exclusiveTop5" style="display:none; margin-top:10px;">üéñ Est√°s en Top 5 ‚Üí tu foto aparece en la lista.</div>
    <div id="exclusiveTop3" style="display:none; margin-top:6px;">ü•â Top 3 ‚Üí nombre en <span style="color:#b87333">cobre</span>.</div>
    <div id="exclusiveTop2" style="display:none; margin-top:6px;">ü•à Top 2 ‚Üí nombre en <span style="color:silver">plata</span>.</div>
    <div id="exclusiveTop1" style="display:none; margin-top:6px;">üëë Top 1 ‚Üí nombre en <span style="color:gold">oro</span>.</div>
  </div>

  <!-- ejemplo de tabla para ver efecto de "tabla_color" -->
  <div class="section" style="margin-top:22px;">
    <h2>Ejemplo de tabla (afectada por Recompensa 3)</h2>
    <table class="site-table">
      <thead><tr><th>Elemento</th><th>Descripci√≥n</th></tr></thead>
      <tbody>
        <tr><td>Blackjack</td><td>Juego cl√°sico</td></tr>
        <tr><td>Ruleta</td><td>Girar la rueda</td></tr>
        <tr><td>Poker</td><td>En l√≠nea</td></tr>
      </tbody>
    </table>
  </div>

<script>
/* --------- CONFIGURA SUPABASE AQUI ---------- */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
/* -------------------------------------------- */

let currentUser = null; // objeto actualizado desde la BDD

document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById("reward3Btn").addEventListener("click",()=>{
    document.getElementById("tableColorPicker").style.display="block";
});
  const saved = localStorage.getItem('currentUser');
  if (saved) {
    try { currentUser = JSON.parse(saved); } catch(e){ currentUser = null; }
  }

  // listeners UI
  document.getElementById('userInfo').addEventListener('click', toggleDropdown);
  document.addEventListener('click', (e) => {
    const ui = document.getElementById('userInfo');
    const dd = document.getElementById('dropdownMenu');
    if (!ui.contains(e.target) && !dd.contains(e.target)) dd.style.display = 'none';
  });

  // recompensas - mostrar pickers
  document.getElementById('rewardBgBtn').addEventListener('click', ()=> toggleShow('backgroundPicker'));
  document.getElementById('rewardNameBtn').addEventListener('click', ()=> toggleShow('nameColorPicker'));
  document.getElementById('rewardTableBtn').addEventListener('click', ()=> toggleShow('tableColorPicker'));

  // pickers -> acciones
  document.getElementById('backgroundPicker').addEventListener('input', e => setBackgroundColor(e.target.value));
  document.getElementById('nameColorPicker').addEventListener('input', e => setNameColor(e.target.value));
  document.getElementById('tableColorPicker').addEventListener('input', e => setTableColor(e.target.value));

  // carga inicial de datos
  await refreshCurrentUser();
  await loadTop5();
});

/* ---------- UTIL ---------- */
function toggleDropdown(){ const dd = document.getElementById('dropdownMenu'); dd.style.display = dd.style.display === 'block' ? 'none' : 'block'; }
function toggleShow(id){ const el = document.getElementById(id); el.style.display = (el.style.display==='block') ? 'none' : 'block'; }

/* ---------- LOGOUT ---------- */
async function logout(){
  try { await supabase.auth.signOut(); } catch(e){/*ignore*/ }
  localStorage.removeItem('currentUser');
  currentUser = null;
  // simple redirect to login
  window.location.href = 'login.html';
}

async function loadUserInfo() {
    const user = currentUser;
    const authContainer = document.getElementById("authContainer");
    const userInfo = document.getElementById("userInfo");

    if (user) {
        userInfo.style.display = "flex";
        authContainer.style.display = "none";
        document.getElementById("userName").textContent = user.username || "Usuario";
        document.getElementById("userLogo").src = user.logo || "logoDefault.png";

        // Cargar pekepuntos
        cargarPekepuntos(user.id);

        // üîπ Cargar colores guardados en Supabase
        const { data, error } = await supabase
            .from("usuarios")
            .select("fondo_color, nombre_color, tabla_color")
            .eq("id", user.id)
            .single();

        if (!error && data) {
            // Fondo personalizado
            if (data.fondo_color) document.body.style.backgroundColor = data.fondo_color;

            // Color del nombre
            if (data.nombre_color) document.getElementById("userName").style.color = data.nombre_color;

            // Color de las tablas
            if (data.tabla_color) {
                document.querySelectorAll("table").forEach(tbl => {
                    tbl.style.backgroundColor = data.tabla_color;
                });
            }
        } else if (error) {
            console.error("Error al cargar datos del usuario:", error);
        }

    } else {
        userInfo.style.display = "none";
        authContainer.style.display = "flex";
    }
}

/* ---------- REFRESCAR DATOS DEL USUARIO DESDE BDD ---------- */
async function refreshCurrentUser(){
  // si no hay usuario local, no intentamos fetch de id
  if(!currentUser || !currentUser.id){
    // ocultar userInfo, mostrar bot√≥n login
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('authContainer').style.display = 'flex';
    // igual cargamos top5 p√∫blico
    document.getElementById('pekepuntos').textContent = 'Pekepuntos: ‚Äî';
    return;
  }

  // traer registro actualizado desde supabase
  const { data, error } = await supabase
    .from('usuarios')
    .select('id, username, logo, pekepuntos, fondo_color, nombre_color, tabla_color')
    .eq('id', currentUser.id)
    .single();

  if(error){
    console.error('Error al cargar usuario:', error.message || error);
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('pekepuntos').textContent = 'Pekepuntos: ‚Äî';
    return;
  }

  // actualizar currentUser completo
  currentUser = data;
  // guardar de nuevo local (por si)
  localStorage.setItem('currentUser', JSON.stringify(currentUser));

  // mostrar UI
  document.getElementById('userInfo').style.display = 'flex';
  document.getElementById('authContainer').style.display = 'none';
  document.getElementById('userName').textContent = currentUser.username || 'Usuario';
  document.getElementById('userLogo').src = currentUser.logo || 'logoDefault.png';
  document.getElementById('pekepuntos').textContent = `Pekepuntos: ${currentUser.pekepuntos ?? 0}`;

  // aplicar estilos guardados
  if(currentUser.fondo_color) document.body.style.backgroundColor = currentUser.fondo_color;
  if(currentUser.nombre_color) document.getElementById('userName').style.color = currentUser.nombre_color;
  if(currentUser.tabla_color) applyTableColor(currentUser.tabla_color);
}

/* ---------- RECOMPENSAS: Guardar estilos en BDD y aplicar ---------- */
async function setBackgroundColor(color){
  // aplicar localmente
  document.body.style.backgroundColor = color;
  // guardar en la BDD
  if(!currentUser || !currentUser.id) return alert('Debes iniciar sesi√≥n para usar esta recompensa.');
  const { error } = await supabase.from('usuarios').update({ fondo_color: color }).eq('id', currentUser.id);
  if(error){ console.error(error); alert('Error guardando color de fondo'); return; }
  // refrescar cache local
  currentUser.fondo_color = color;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
}

async function setNameColor(color){
  document.getElementById('userName').style.color = color;
  if(!currentUser || !currentUser.id) return alert('Debes iniciar sesi√≥n para usar esta recompensa.');
  const { error } = await supabase.from('usuarios').update({ nombre_color: color }).eq('id', currentUser.id);
  if(error){ console.error(error); alert('Error guardando color de nombre'); return; }
  currentUser.nombre_color = color;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
}

// Recompensa 3: cambiar color de las tablas
async function setTableColor(color){
    if (!currentUser) return alert("Debes iniciar sesi√≥n.");

    // Cambiar el color en todas las tablas visibles
    document.querySelectorAll("table").forEach(tbl => {
        tbl.style.backgroundColor = color;
    });

    // Guardar el color en Supabase
    const { error } = await supabase
        .from("usuarios")
        .update({ tabla_color: color })
        .eq("id", currentUser.id);

    if (error) {
        console.error(error);
        alert("‚ùå Error al guardar el color en Supabase");
    } else {
        alert("‚úÖ ¬°Color de tablas actualizado correctamente!");
    }
}

function applyTableColor(color){
  // definir variable CSS para tablas
  document.documentElement.style.setProperty('--table-bg', color);
  // ajustar texto en tablas si el color es oscuro -> blanco, si es claro -> negro
  const lum = luminanceFromHex(color);
  const textColor = lum < 0.5 ? '#ffffff' : '#000000';
  document.documentElement.style.setProperty('--table-text', textColor);
}

/* utilidad luminancia */
function luminanceFromHex(hex){
  try{
    const h = hex.replace('#','');
    const r = parseInt(h.substring(0,2),16)/255;
    const g = parseInt(h.substring(2,4),16)/255;
    const b = parseInt(h.substring(4,6),16)/255;
    // sRGB -> linear
    const srgb = [r,g,b].map(c => (c<=0.03928) ? c/12.92 : Math.pow((c+0.055)/1.055,2.4));
    return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
  }catch(e){ return 1; }
}

/* ---------- TOP 5 ---------- */
async function loadTop5(){
  const { data, error } = await supabase
    .from('usuarios')
    .select('id, username, pekepuntos, logo, nombre_color')
    .order('pekepuntos', { ascending: false })
    .limit(5);

  if(error){ console.error('Error Top5:', error.message || error); return; }
  const top5List = document.getElementById('top5List');
  top5List.innerHTML = '';

  data.forEach((u, idx) => {
    const li = document.createElement('li');
    li.className = 'top5-item';
    // override color por ranking 1-3
    let nameColor = u.nombre_color || '#ffffff';
    if(idx === 0) nameColor = 'gold';
    else if(idx === 1) nameColor = 'silver';
    else if(idx === 2) nameColor = '#b87333'; // cobre

    const imgHtml = u.logo ? `<img src="${u.logo}" alt="logo">` : `<div style="width:36px;height:36px;border-radius:50%;background:#666;display:inline-block;"></div>`;
    li.innerHTML = `${imgHtml}<div style="flex:1;text-align:left;"><strong style="color:${nameColor}">${idx+1}. ${escapeHtml(u.username)}</strong><div style="font-size:0.9rem;color:#ddd">${u.pekepuntos} Pekepuntos</div></div>`;
    top5List.appendChild(li);
  });

  // mostrar recompensas exclusivas segun tu posicion
  if(currentUser && currentUser.id){
    const pos = data.findIndex(x => x.id === currentUser.id);
    // ocultar todos
    ['exclusiveTop5','exclusiveTop3','exclusiveTop2','exclusiveTop1'].forEach(id => document.getElementById(id).style.display = 'none');
    if(pos !== -1){
      if(pos <= 4) document.getElementById('exclusiveTop5').style.display = 'block';
      if(pos <= 2) document.getElementById('exclusiveTop3').style.display = 'block';
      if(pos === 1) document.getElementById('exclusiveTop2').style.display = 'block';
      if(pos === 0) document.getElementById('exclusiveTop1').style.display = 'block';
      // si est√°s en top1/2/3 sobrescribimos el color del nombre de tu UI
      if(pos === 0) document.getElementById('userName').style.color = 'gold';
      else if(pos === 1) document.getElementById('userName').style.color = 'silver';
      else if(pos === 2) document.getElementById('userName').style.color = '#b87333';
      else if(currentUser.nombre_color) document.getElementById('userName').style.color = currentUser.nombre_color;
    } else {
      // si no est√°s en el top, aplicar tu color guardado
      if(currentUser && currentUser.nombre_color) document.getElementById('userName').style.color = currentUser.nombre_color;
      // ocultar exclusivas
      ['exclusiveTop5','exclusiveTop3','exclusiveTop2','exclusiveTop1'].forEach(id => document.getElementById(id).style.display = 'none');
    }
  }
}

/* ---------- helpers ---------- */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

</script>
</body>
</html>
