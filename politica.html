<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crear Partido Pol√≠tico</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  h1 { text-align: center; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type="text"], textarea, input[type="file"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    background: #0077ff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #0055aa; }
  .candidate-inputs { margin-top: 10px; }
  .candidate-inputs input { margin-top: 5px; }
  #backBtn {
    background: #555;
    margin-top: 10px;
  }
  #backBtn:hover {
    background: #333;
  }
  /* Lista de partidos */
  #partiesList {
    margin-top: 30px;
  }
  .party-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  background: #fafafa;
  text-align: center; 
}

.party-card img {
  max-width: 100px; 
  max-height: 100px;
  margin-bottom: 10px;
  object-fit: contain; 
}

.party-card h3 {
  margin: 0 0 10px 0;
  font-size: 1.3em;
}

</style>
</head>
<body>

<div class="container">
  <h1>Crear Partido Pol√≠tico</h1>
  <form id="partyForm">
    <label>Nombre del Partido</label>
    <input type="text" id="partyName" required>

    <label>Descripci√≥n</label>
    <textarea id="partyDescription" rows="4" required></textarea>

    <label>Logo</label>
    <input type="file" id="partyLogo" accept="image/*">

    <label>Programa / Manifesto (un punto por l√≠nea)</label>
    <textarea id="partyManifesto" rows="4"></textarea>

    <label>Candidatos</label>
    <div class="candidate-inputs" id="candidateInputs">
      <input type="text" placeholder="Nombre candidato" class="candidateName">
    </div>
    <button type="button" id="addCandidate">+ A√±adir otro candidato</button>

    <button type="submit">Crear Partido</button>
  </form>
  <button id="backBtn" onclick="window.location.href='Hub.html'">‚¨Ö Volver al Hub</button>
  <p id="status"></p>

  <h2>üìå Partidos Creados</h2>
  <div id="partiesList"></div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const partyForm = document.getElementById('partyForm');
  const candidateInputs = document.getElementById('candidateInputs');
  const addCandidateBtn = document.getElementById('addCandidate');
  const statusText = document.getElementById('status');
  const partiesList = document.getElementById('partiesList');

  addCandidateBtn.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Nombre candidato';
    input.className = 'candidateName';
    candidateInputs.appendChild(input);
  });

  function slugify(text) {
    return text.toString().toLowerCase()
      .replace(/\s+/g,'-')
      .replace(/[^\w\-]+/g,'')
      .replace(/\-\-+/g,'-')
      .replace(/^-+|-+$/g,'');
  }

  async function cryptoRandomUUID() {
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2,10));
  }

  async function loadParties() {
    partiesList.innerHTML = "Cargando partidos...";
    const { data, error } = await supabase
      .from("parties")
      .select("id, name, description, logo_path, manifesto");

    if (error) {
      partiesList.innerHTML = "‚ùå Error cargando partidos.";
      console.error(error);
      return;
    }

    if (data.length === 0) {
      partiesList.innerHTML = "<p>No hay partidos creados a√∫n.</p>";
      return;
    }

    partiesList.innerHTML = "";
    data.forEach(party => {
      const div = document.createElement("div");
      div.className = "party-card";

      let logoHtml = "";
      if (party.logo_path) {
        const logoUrl = supabase.storage.from("logos").getPublicUrl(party.logo_path).data.publicUrl;
        logoHtml = `<img src="${logoUrl}" alt="Logo">`;
      }

      const manifestoHtml = party.manifesto && party.manifesto.length > 0
        ? `<ul>${party.manifesto.map(m => `<li>${m}</li>`).join("")}</ul>`
        : "<p><em>Sin programa definido</em></p>";

      div.innerHTML = `
        ${logoHtml}
        <h3>${party.name}</h3>
        <p>${party.description}</p>
        <h4>Programa:</h4>
        ${manifestoHtml}
      `;
      partiesList.appendChild(div);
    });
  }

  // Cargar partidos al entrar
  loadParties();

  // Evento crear partido
  partyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusText.textContent = 'Creando partido...';

    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!user) {
      alert("‚ö†Ô∏è Debes iniciar sesi√≥n primero.");
      statusText.textContent = 'Debes iniciar sesi√≥n primero.';
      return;
    }

    const name = document.getElementById('partyName').value;
    const description = document.getElementById('partyDescription').value;
    const manifestoText = document.getElementById('partyManifesto').value;
    const manifestoArray = manifestoText.split('\n').filter(l => l.trim() !== '');
    const logoFile = document.getElementById('partyLogo').files[0];

    const slug = `${slugify(name)}-${Math.random().toString(36).slice(2,6)}`;
    let logo_path = null;

    if (logoFile) {
      const fileExt = logoFile.name.split('.').pop();
      const fileName = await cryptoRandomUUID() + '.' + fileExt;
      logo_path = `parties/logos/${fileName}`;
      const { error: uploadError } = await supabase.storage.from('logos').upload(logo_path, logoFile);
      if (uploadError) {
        alert("‚ùå Error subiendo logo: " + uploadError.message);
        return;
      }
    }

    try {
      const { data: party, error: partyError } = await supabase
        .from('parties')
        .insert([{
          name,
          slug,
          description,
          manifesto: manifestoArray,
          logo_path,
          creator_id: user.id || user.user?.id
        }])
        .select()
        .single();

      if (partyError) throw partyError;

      // Candidatos
      const candidates = Array.from(document.querySelectorAll('.candidateName'))
        .map(c => c.value.trim())
        .filter(c => c !== '');
      if (candidates.length > 0) {
        await supabase.from('party_candidates').insert(
          candidates.map((c, i) => ({
            party_id: party.id,
            name: c,
            order_index: i
          }))
        );
      }

      // Insertar miembro creador
      await supabase.from('party_members').insert([{
        party_id: party.id,
        user_id: user.id || user.user?.id,
        role: 'creator'
      }]);

      alert("‚úÖ Partido creado exitosamente");
      statusText.textContent = '¬°Partido creado exitosamente!';
      partyForm.reset();
      candidateInputs.innerHTML = '<input type="text" placeholder="Nombre candidato" class="candidateName">';
      
      // Recargar lista
      loadParties();
    } catch (err) {
      console.error(err);
      alert("‚ùå Error al crear el partido: " + err.message);
      statusText.textContent = 'Error al crear el partido: ' + err.message;
    }
  });
</script>
</body>
</html>
