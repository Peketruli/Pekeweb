<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pol√≠tica - Partidos</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
.container { max-width:800px; margin:40px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1,h2 { text-align:center; }
label { display:block; margin-top:15px; font-weight:bold; }
input[type="text"], textarea, input[type="file"] { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { margin-top:20px; padding:10px 20px; background:#0077ff; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#0055aa; }
.candidate-inputs input { margin-top:5px; }
#backBtn { background:#555; margin-top:10px; }
#backBtn:hover { background:#333; }

#partiesList { margin-top:30px; display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; }
.party-card { border:1px solid #ddd; border-radius:10px; padding:15px; background:#fafafa; display:flex; flex-direction:column; align-items:center; }
.party-card img { max-width:80px; max-height:80px; margin-bottom:10px; }
.party-card h3 { margin:5px 0; text-align:center; }
.party-card p { text-align:center; }

/* Vista del partido */
#partyView { display:none; padding:20px; max-width:800px; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
#partyMembers { list-style:none; padding:0; }
#partyChat { margin-top:15px; border-top:1px solid #ddd; padding-top:10px; max-height:200px; overflow-y:auto; }
#chatInput { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; }
#leaveBtn, #hubBtn { margin-top:10px; margin-right:5px; }
#leaveBtn { background:#ff5555; }
#hubBtn { background:#555; }
#leaveBtn:hover { background:#cc4444; }
#hubBtn:hover { background:#333; }
</style>
</head>
<body>

<div id="mainContainer" class="container">
  <h1>Crear Partido Pol√≠tico</h1>
  <form id="partyForm">
    <label>Nombre del Partido</label>
    <input type="text" id="partyName" required>

    <label>Descripci√≥n</label>
    <textarea id="partyDescription" rows="3" required></textarea>

    <label>Logo</label>
    <input type="file" id="partyLogo" accept="image/*">

    <label>Programa / Manifesto (un punto por l√≠nea)</label>
    <textarea id="partyManifesto" rows="4"></textarea>

    <label>Candidatos</label>
    <div class="candidate-inputs" id="candidateInputs">
      <input type="text" placeholder="Nombre candidato" class="candidateName">
    </div>
    <button type="button" id="addCandidate">+ A√±adir otro candidato</button>

    <button type="submit">Crear Partido</button>
  </form>

  <button id="backBtn" onclick="window.location.href='Hub.html'">‚¨Ö Volver al Hub</button>
  <p id="status"></p>

  <h2>üìå Partidos Creados</h2>
  <div id="partiesList"></div>
</div>

<!-- Vista del partido -->
<div id="partyView">
  <button id="leaveBtn">Salir del Partido</button>
  <button id="hubBtn">‚¨Ö Volver al Hub</button>
  <img id="partyLogoView" style="max-width:120px; display:block; margin:0 auto 10px;">
  <h2 id="partyNameView"></h2>
  <p id="partyDescriptionView"></p>
  <div id="partyManifestoView"><h3>Manifesto / Programa</h3><ul></ul></div>
  <h3>Miembros</h3>
  <ul id="partyMembers"></ul>
  <div id="partyChat"></div>
  <input type="text" id="chatInput" placeholder="Escribe un mensaje y presiona Enter">
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const partyForm = document.getElementById('partyForm');
const candidateInputs = document.getElementById('candidateInputs');
const addCandidateBtn = document.getElementById('addCandidate');
const statusText = document.getElementById('status');
const partiesList = document.getElementById('partiesList');

const mainContainer = document.getElementById('mainContainer');
const partyView = document.getElementById('partyView');
const partyNameView = document.getElementById('partyNameView');
const partyDescriptionView = document.getElementById('partyDescriptionView');
const partyMembersList = document.getElementById('partyMembers');
const chatInput = document.getElementById('chatInput');
const leaveBtn = document.getElementById('leaveBtn');
const hubBtn = document.getElementById('hubBtn');
const partyLogoView = document.getElementById('partyLogoView');
const manifestoList = document.querySelector("#partyManifestoView ul");

// A√±adir candidatos din√°micamente
addCandidateBtn.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Nombre candidato';
  input.className = 'candidateName';
  candidateInputs.appendChild(input);
});

// Utilidades
function slugify(text) {
  return text.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+|-+$/g,'');
}
async function cryptoRandomUUID() {
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2,10));
}

// Cargar partidos
async function loadParties() {
  partiesList.innerHTML = "Cargando partidos...";
  const { data, error } = await supabase.from("parties").select("id, name, description, logo_path");
  if(error){ partiesList.innerHTML = "Error cargando partidos"; console.error(error); return; }
  if(!data || data.length===0){ partiesList.innerHTML="<p>No hay partidos creados a√∫n.</p>"; return; }

  partiesList.innerHTML="";
  data.forEach(party=>{
    const div=document.createElement("div");
    div.className="party-card";
    let logoHtml="";
    if(party.logo_path){
      const logoUrl = supabase.storage.from("logos").getPublicUrl(party.logo_path).data.publicUrl;
      logoHtml = `<img src="${logoUrl}" alt="Logo">`;
    }
    div.innerHTML=`${logoHtml}<h3>${party.name}</h3><p>${party.description}</p><button onclick="joinParty('${party.id}')">Unirse</button>`;
    partiesList.appendChild(div);
  });
}
loadParties();

// Crear partido
partyForm.addEventListener('submit', async e=>{
  e.preventDefault();
  statusText.textContent = 'Creando partido...';
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  const name = document.getElementById('partyName').value;
  const description = document.getElementById('partyDescription').value;
  const manifestoArray = document.getElementById('partyManifesto').value.split('\n').filter(l=>l.trim()!=='');
  const logoFile = document.getElementById('partyLogo').files[0];
  const slug = `${slugify(name)}-${Math.random().toString(36).slice(2,6)}`;
  let logo_path = null;
  if(logoFile){
    const fileExt = logoFile.name.split('.').pop();
    const fileName = await cryptoRandomUUID()+'.'+fileExt;
    logo_path = `parties/logos/${fileName}`;
    const { error: uploadError } = await supabase.storage.from('logos').upload(logo_path, logoFile);
    if(uploadError){ alert("Error subiendo logo: "+uploadError.message); return; }
  }

  try{
    const { data: party, error: partyError } = await supabase.from('parties')
      .insert([{ name, slug, description, manifesto: manifestoArray, logo_path, creator_id: user.id }])
      .select().single();
    if(partyError) throw partyError;

    const candidates = Array.from(document.querySelectorAll('.candidateName')).map(c=>c.value.trim()).filter(c=>c!=='');
    if(candidates.length){
      await supabase.from('party_candidates').insert(candidates.map((c,i)=>({ party_id: party.id, name:c, order_index:i })));
    }
    await supabase.from('party_members').insert([{ party_id: party.id, usuarios_id: user.id, role:'creator' }]);
    alert("Partido creado exitosamente");
    statusText.textContent = '¬°Partido creado!';
    partyForm.reset();
    candidateInputs.innerHTML='<input type="text" placeholder="Nombre candidato" class="candidateName">';
    loadParties();
  }catch(err){ console.error(err); alert("Error creando partido: "+err.message);}
});

// =======================
// Funci√≥n unirse / mostrar partido
// =======================
window.joinParty = async function(partyId){
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  const { data: existing } = await supabase.from("party_members")
    .select("party_id").eq("usuarios_id", user.id);

  if(existing && existing.length > 0){
    showParty(existing[0].party_id);
    return;
  }

  const { error } = await supabase.from("party_members")
    .insert([{ party_id:partyId, usuarios_id:user.id, role:"member" }]);
  if(error){ alert("No se pudo unir: "+error.message); return; }

  localStorage.setItem("currentPartyId", partyId);
  showParty(partyId);
}

// ==========================
// FUNCION PARA MOSTRAR PARTIDO
// ==========================
async function showParty(partyId){
  mainContainer.style.display = "none";
  partyView.style.display = "block";

  // Traer datos del partido
  const { data: party, error: partyError } = await supabase
    .from("parties")
    .select("id,name,description,logo_path,manifesto")
    .eq("id", partyId)
    .single();

  if(partyError || !party){
    console.error("Error cargando partido:", partyError);
    alert("No se pudo cargar el partido.");
    return;
  }

  partyNameView.textContent = party.name;
  partyDescriptionView.textContent = party.description;
  
  if(party.logo_path){
    partyLogoView.src = supabase.storage.from("logos").getPublicUrl(party.logo_path).data.publicUrl;
    partyLogoView.style.display = "block";
  } else {
    partyLogoView.style.display = "none";
  }

  manifestoList.innerHTML = party.manifesto?.map(line => `<li>${line}</li>`).join("") || "<li>No hay manifesto</li>";

// Traer miembros del partido con relaci√≥n correcta a tabla "usuarios"
const { data: members, error: membersError } = await supabase
  .from("party_members")
  .select(`
    usuarios_id,
    usuarios:usuarios_id ( username )
  `)
  .eq("party_id", partyId);


if(membersError){
  console.error("Error cargando miembros:", membersError);
  // Mostrar el mensaje de error exacto en la lista
  partyMembersList.innerHTML = `<li>Error cargando miembros: ${membersError.message}</li>`;
} else {
  partyMembersList.innerHTML = members.length > 0
    ? members.map(m => `<li>${m.usuarios?.nombre || "Anon"}</li>`).join("")
    : "<li>No hay miembros</li>";
}


  await loadMessages(partyId);
  localStorage.setItem("currentPartyId", partyId);
}

// ==========================
// FUNCION PARA UNIRSE AL PARTIDO
// ==========================
window.joinParty = async function(partyId){
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  // Comprobar si ya est√° en un partido
  const { data: existing } = await supabase.from("party_members")
    .select("party_id")
    .eq("usuarios_id", user.id);

  if(existing && existing.length > 0){
    showParty(existing[0].party_id);
    return;
  }

  // Insertar al usuario en el partido
  const { error } = await supabase.from("party_members")
    .insert([{ party_id: partyId, usuarios_id: user.id, role: "member" }]);

  if(error){ alert("No se pudo unir: "+error.message); return; }

  showParty(partyId);
}

// ==========================
// SALIR DEL PARTIDO
// ==========================
leaveBtn.addEventListener("click", async ()=>{
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const partyId = localStorage.getItem("currentPartyId");
  if(!user || !partyId) return;

  const { error } = await supabase.from("party_members")
    .delete()
    .eq("party_id", partyId)
    .eq("usuarios_id", user.id);

  if(error){
    console.error("Error saliendo del partido:", error);
    alert("No se pudo salir del partido");
    return;
  }

  localStorage.removeItem("currentPartyId");
  partyView.style.display = "none";
  mainContainer.style.display = "block";
  loadParties();
});

// ==========================
// BOTON VOLVER AL HUB
// ==========================
hubBtn.addEventListener("click", ()=>{
  localStorage.removeItem("currentPartyId"); // opcional, si quieres limpiar
  window.location.href = "Hub.html";
});

// Mensajes
async function loadMessages(partyId){
  const { data } = await supabase.from("party_messages")
    .select("message,usuarios(nombre)").eq("party_id",partyId).order("created_at",{ascending:true});
  document.getElementById("partyChat").innerHTML = data.map(m=>`<p><b>${m.usuarios?.nombre||'Anon'}:</b> ${m.message}</p>`).join("");
}

// Detectar si ya pertenece a un partido al cargar
window.addEventListener("DOMContentLoaded", async ()=>{
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const savedPartyId = localStorage.getItem("currentPartyId");

  if(savedPartyId){
    showParty(savedPartyId);
  } else if(user){
    const { data: membership } = await supabase.from("party_members")
      .select("party_id").eq("usuarios_id", user.id);
    if(membership && membership.length>0){
      localStorage.setItem("currentPartyId", membership[0].party_id);
      showParty(membership[0].party_id);
    }
  }
});
</script>

</body>
</html>
