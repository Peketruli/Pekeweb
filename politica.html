<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crear Partido Pol√≠tico</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 600px;
    margin: 40px auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  h1 { text-align: center; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type="text"], textarea, input[type="file"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    margin-top: 20px;
    padding: 10px 20px;
    background: #0077ff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover { background: #0055aa; }
  .candidate-inputs { margin-top: 10px; }
  .candidate-inputs input { margin-top: 5px; }
  #backBtn {
    background: #555;
    margin-top: 10px;
  }
  #backBtn:hover {
    background: #333;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Crear Partido Pol√≠tico</h1>
  <form id="partyForm">
    <label>Nombre del Partido</label>
    <input type="text" id="partyName" required>

    <label>Descripci√≥n</label>
    <textarea id="partyDescription" rows="4" required></textarea>

    <label>Logo</label>
    <input type="file" id="partyLogo" accept="image/*">

    <label>Programa / Manifesto (un punto por l√≠nea)</label>
    <textarea id="partyManifesto" rows="4"></textarea>

    <label>Candidatos</label>
    <div class="candidate-inputs" id="candidateInputs">
      <input type="text" placeholder="Nombre candidato" class="candidateName">
    </div>
    <button type="button" id="addCandidate">+ A√±adir otro candidato</button>

    <button type="submit">Crear Partido</button>
  </form>
  <button id="backBtn" onclick="window.location.href='Hub.html'">‚¨Ö Volver al Hub</button>
  <p id="status"></p>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const SUPABASE_KEY = 'TU_API_KEY_AQUI';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const partyForm = document.getElementById('partyForm');
  const candidateInputs = document.getElementById('candidateInputs');
  const addCandidateBtn = document.getElementById('addCandidate');
  const statusText = document.getElementById('status');

  addCandidateBtn.addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Nombre candidato';
    input.className = 'candidateName';
    candidateInputs.appendChild(input);
  });

  function slugify(text) {
    return text.toString().toLowerCase()
      .replace(/\s+/g,'-')
      .replace(/[^\w\-]+/g,'')
      .replace(/\-\-+/g,'-')
      .replace(/^-+|-+$/g,'');
  }

  async function cryptoRandomUUID() {
    return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2,10));
  }

  partyForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    statusText.textContent = 'Creando partido...';

    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!user) {
      alert("‚ö†Ô∏è Debes iniciar sesi√≥n primero.");
      statusText.textContent = 'Debes iniciar sesi√≥n primero.';
      return;
    }

    alert("üü¢ Usuario detectado: " + JSON.stringify(user)); // para debug

    const name = document.getElementById('partyName').value;
    const description = document.getElementById('partyDescription').value;
    const manifestoText = document.getElementById('partyManifesto').value;
    const manifestoArray = manifestoText.split('\n').filter(l => l.trim() !== '');
    const logoFile = document.getElementById('partyLogo').files[0];

    const slug = `${slugify(name)}-${Math.random().toString(36).slice(2,6)}`;
    let logo_path = null;

    // Si hay logo, s√∫belo al storage
    if (logoFile) {
      const fileExt = logoFile.name.split('.').pop();
      const fileName = await cryptoRandomUUID() + '.' + fileExt;
      logo_path = `parties/logos/${fileName}`;
      const { error: uploadError } = await supabase.storage.from('logos').upload(logo_path, logoFile);
      if (uploadError) {
        alert("‚ùå Error subiendo logo: " + uploadError.message);
        return;
      }
    }

    try {
      // Crear partido
      const { data: party, error: partyError } = await supabase
        .from('parties')
        .insert([{
          name,
          slug,
          description,
          manifesto: manifestoArray,
          logo_path,
          creator_id: user.id || user.user?.id // <-- Ajusta seg√∫n c√≥mo se guarde el usuario
        }])
        .select()
        .single();

      if (partyError) throw partyError;

      // Insertar candidatos
      const candidates = Array.from(document.querySelectorAll('.candidateName'))
        .map(c => c.value.trim())
        .filter(c => c !== '');
      if (candidates.length > 0) {
        const candidatesToInsert = candidates.map((c, i) => ({
          party_id: party.id,
          name: c,
          order_index: i
        }));
        const { error: candError } = await supabase.from('party_candidates').insert(candidatesToInsert);
        if (candError) console.error('Error candidatos', candError);
      }

      // Insertar miembro creador
      await supabase.from('party_members').insert([{
        party_id: party.id,
        user_id: user.id || user.user?.id,
        role: 'creator'
      }]);

      alert("‚úÖ Partido creado exitosamente");
      statusText.textContent = '¬°Partido creado exitosamente!';
      partyForm.reset();
      candidateInputs.innerHTML = '<input type="text" placeholder="Nombre candidato" class="candidateName">';
    } catch (err) {
      console.error(err);
      alert("‚ùå Error al crear el partido: " + err.message);
      statusText.textContent = 'Error al crear el partido: ' + err.message;
    }
  });
</script>
</body>
</html>
