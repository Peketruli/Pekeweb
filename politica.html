<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pol√≠tica - Partidos</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
.container { max-width:800px; margin:40px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1,h2 { text-align:center; }
label { display:block; margin-top:15px; font-weight:bold; }
input[type="text"], textarea, input[type="file"], input[type="color"] { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { margin-top:20px; padding:10px 20px; background:#0077ff; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#0055aa; }
.candidate-inputs input { margin-top:5px; }
#backBtn { background:#555; margin-top:10px; }
#backBtn:hover { background:#333; }

#partiesList { margin-top:30px; display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; }
.party-card { border:1px solid #ddd; border-radius:10px; padding:15px; display:flex; flex-direction:column; align-items:center; }
.party-card img { max-width:80px; max-height:80px; margin-bottom:10px; }
.party-card h3 { margin:5px 0; text-align:center; }
.party-card p { text-align:center; }

/* Vista del partido */
#partyView { display:none; padding:20px; max-width:800px; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
#partyMembers { list-style:none; padding:0; }
#partyChat { margin-top:15px; border-top:1px solid #ddd; padding-top:10px; max-height:200px; overflow-y:auto; background:#f0f0f0; padding:10px; border-radius:8px;}
#chatInput { width:100%; padding:8px; margin-top:5px; box-sizing:border-box; }
#leaveBtn, #hubBtn { margin-top:10px; margin-right:5px; }
#leaveBtn { background:#ff5555; }
#hubBtn { background:#555; }
#leaveBtn:hover { background:#cc4444; }
#hubBtn:hover { background:#333; }
#editPartyBtn { background:#ffaa00; margin-top:10px; }
#editPartyBtn:hover { background:#cc8800; }
</style>
</head>
<body>

<div id="mainContainer" class="container">
  <h1>Crear Partido Pol√≠tico</h1>
  <div id="error-box" style="color:red; font-weight:bold; margin:10px 0;"></div>
  <form id="partyForm">
    <label>Nombre del Partido</label>
    <input type="text" id="partyName" required>

    <label>Descripci√≥n</label>
    <textarea id="partyDescription" rows="3" required></textarea>

    <label>Logo</label>
    <input type="file" id="partyLogo" accept="image/*">

    <label>Color del Partido</label>
    <input type="color" id="partyColor" value="#0077ff">

    <label>Programa / Manifesto (un punto por l√≠nea)</label>
    <textarea id="partyManifesto" rows="4"></textarea>

    <label>Candidatos</label>
    <div class="candidate-inputs" id="candidateInputs">
      <input type="text" placeholder="Nombre candidato" class="candidateName">
    </div>
    <button type="button" id="addCandidate">+ A√±adir otro candidato</button>

    <button type="submit">Crear Partido</button>
  </form>

  <button id="backBtn" onclick="window.location.href='Hub.html'">‚¨Ö Volver al Hub</button>
  <p id="status"></p>

  <h2>üìå Partidos Creados</h2>
  <div id="partiesList"></div>
</div>

<!-- Vista del partido -->
<div id="partyView">
  <button id="leaveBtn">Salir del Partido</button>
  <button id="hubBtn">‚¨Ö Volver al Hub</button>
  <img id="partyLogoView" style="max-width:120px; display:block; margin:0 auto 10px;">
  <h2 id="partyNameView"></h2>
  <p id="partyDescriptionView"></p>
  
  <!-- Bot√≥n y formulario de edici√≥n -->
  <button id="editPartyBtn" style="display:none;">‚úèÔ∏è Editar Partido</button>
  <div id="editPartyForm" style="display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
    <label>Nombre del Partido</label>
    <input type="text" id="editPartyName">
    <label>Descripci√≥n</label>
    <textarea id="editPartyDescription" rows="3"></textarea>
    <label>Color del Partido</label>
    <input type="color" id="editPartyColor" value="#0077ff">
    <label>Manifesto</label>
    <textarea id="editPartyManifesto" rows="4"></textarea>
    <label>Nuevo Logo (opcional)</label>
    <input type="file" id="editPartyLogo" accept="image/*">
    <button id="saveEditBtn">üíæ Guardar Cambios</button>
    <button id="cancelEditBtn" type="button">Cancelar</button>
  </div>

  <div id="partyManifestoView"><h3>Manifesto / Programa</h3><ul></ul></div>
  <h3>Miembros</h3>
  <ul id="partyMembers"></ul>
  <h3>Chat del Partido</h3>
  <div id="partyChat"></div>
  <input type="text" id="chatInput" placeholder="Escribe un mensaje y presiona Enter">
</div>

<script type="module">
  const errorBox = document.getElementById("error-box");

function showError(msg){
  errorBox.innerHTML = msg;
}

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const partyForm = document.getElementById('partyForm');
const candidateInputs = document.getElementById('candidateInputs');
const addCandidateBtn = document.getElementById('addCandidate');
const statusText = document.getElementById('status');
const partiesList = document.getElementById('partiesList');

const mainContainer = document.getElementById('mainContainer');
const partyView = document.getElementById('partyView');
const partyNameView = document.getElementById('partyNameView');
const partyDescriptionView = document.getElementById('partyDescriptionView');
const partyMembersList = document.getElementById('partyMembers');
const chatInput = document.getElementById('chatInput');
const leaveBtn = document.getElementById('leaveBtn');
const hubBtn = document.getElementById('hubBtn');
const partyLogoView = document.getElementById('partyLogoView');
const manifestoList = document.querySelector("#partyManifestoView ul");
const editBtn = document.getElementById("editPartyBtn");
const editForm = document.getElementById("editPartyForm");
const saveEditBtn = document.getElementById("saveEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const editPartyColorInput = document.getElementById('editPartyColor');

let chatInterval;

// a√±adir candidato din√°micamente (opcional)
addCandidateBtn.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Nombre candidato';
  input.className = 'candidateName';
  candidateInputs.appendChild(input);
});

// ====================
// AUX
// ====================
function slugify(text){ return text.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+|-+$/g,''); }
async function cryptoRandomUUID(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2,10)); }

// ====================
// CARGAR PARTIDOS
// ====================
async function loadParties(){
  partiesList.innerHTML = "Cargando partidos...";
  const { data, error } = await supabase
    .from("parties")
    .select("id, name, description, logo_path, color");

  if(error){
    partiesList.innerHTML = "‚ùå Error cargando partidos";
    showError("‚ùå " + (error.message || error));
    return;
  }
  if(!data || data.length===0){
    partiesList.innerHTML = "<p>No hay partidos creados a√∫n.</p>";
    return;
  }

  partiesList.innerHTML = "";
  data.forEach(party=>{
  const div = document.createElement("div");
  div.className = "party-card";
  // aplicar color (si tiene)
  div.style.backgroundColor = party.color || "#fafafa";
  let logoHtml = "";

  if (party.logo_path) {
    const { data: urlData } = supabase.storage.from("logos").getPublicUrl(party.logo_path);
    if (urlData?.publicUrl) {
      logoHtml = `<img src="${urlData.publicUrl}" alt="Logo">`;
    }
  }

  // Mostrar las primeras l√≠neas del manifesto (si existe)
  let manifestoPreview = "";
  if(party.manifesto && party.manifesto.length > 0){
    manifestoPreview = "<ul>" + party.manifesto.slice(0,3).map(line => `<li>${line}</li>`).join("") + "</ul>";
  }

  div.innerHTML = `
    ${logoHtml}
    <h3>${party.name}</h3>
    <p>${party.description}</p>
    ${manifestoPreview}
    <button onclick="joinParty('${party.id}')">Unirse</button>
  `;
  partiesList.appendChild(div);
});


  // Mostrar las primeras l√≠neas del manifesto (si existe)
  let manifestoPreview = "";
  if(party.manifesto && party.manifesto.length > 0){
    manifestoPreview = "<ul>" + party.manifesto.slice(0,3).map(line => `<li>${line}</li>`).join("") + "</ul>";
  }

  div.innerHTML = `
    ${logoHtml}
    <h3>${party.name}</h3>
    <p>${party.description}</p>
    ${manifestoPreview}
    <button onclick="joinParty('${party.id}')">Unirse</button>
  `;
  partiesList.appendChild(div);
});


// ====================
// CREAR PARTIDO
// ====================
partyForm.addEventListener('submit', async e=>{
  e.preventDefault();
  statusText.textContent = 'Creando partido...';
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  const name = document.getElementById('partyName').value;
  const description = document.getElementById('partyDescription').value;
  const manifestoArray = document.getElementById('partyManifesto').value.split('\n').filter(l=>l.trim()!=='');
  const logoFile = document.getElementById('partyLogo').files[0];
  const color = document.getElementById('partyColor').value;
  const slug = `${slugify(name)}-${Math.random().toString(36).slice(2,6)}`;
  let logo_path = null;
  if(logoFile){
    const fileExt = logoFile.name.split('.').pop();
    const fileName = await cryptoRandomUUID()+'.'+fileExt;
    // puedes usar solo fileName o carpetas; aqu√≠ usamos parties/logos/
    logo_path = `parties/logos/${fileName}`;
    const { error: uploadError } = await supabase.storage.from('logos').upload(logo_path, logoFile);
    if(uploadError){ alert("Error subiendo logo: "+uploadError.message); return; }
  }

  try{
    const { data: party, error: partyError } = await supabase.from('parties')
      .insert([{ name, slug, description, manifesto: manifestoArray, logo_path, color, creator_id: user.id }])
      .select().single();
    if(partyError) throw partyError;

    const candidates = Array.from(document.querySelectorAll('.candidateName')).map(c=>c.value.trim()).filter(c=>c!=='');
    if(candidates.length){
      await supabase.from('party_candidates').insert(candidates.map((c,i)=>({ party_id: party.id, name:c, order_index:i })));
    }
    await supabase.from('party_members').insert([{ party_id: party.id, usuarios_id: user.id, role:'creator' }]);
    alert("Partido creado exitosamente");
    statusText.textContent = '¬°Partido creado!';
    partyForm.reset();
    candidateInputs.innerHTML='<input type="text" placeholder="Nombre candidato" class="candidateName">';
    // recargar lista
    loadParties();
  }catch(err){ console.error(err); alert("Error creando partido: "+err.message);}
});

// ====================
// UNIRSE A PARTIDO
// ====================
window.joinParty = async function(partyId){
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  // Verifica si ya est√° en este partido espec√≠fico
  const { data: existing } = await supabase.from("party_members")
    .select("party_id")
    .eq("usuarios_id", user.id)
    .eq("party_id", partyId);

  if(existing && existing.length > 0){
    alert("Ya est√°s en este partido");
    showParty(partyId);
    return;
  }

  const { error } = await supabase.from("party_members")
    .insert([{ party_id:partyId, usuarios_id:user.id, role:"member" }]);
  if(error){ alert("No se pudo unir: "+error.message); return; }

  localStorage.setItem("currentPartyId", partyId);
  showParty(partyId);
}

// ====================
// MOSTRAR PARTIDO
// ====================
async function showParty(partyId){
  mainContainer.style.display = "none";
  partyView.style.display = "block";

  const user = JSON.parse(localStorage.getItem("currentUser"));

  const { data: party, error: partyError } = await supabase
    .from("parties")
    .select("id,name,description,logo_path,manifesto,creator_id,color")
    .eq("id", partyId)
    .single();

  if(partyError || !party){
    showError("‚ùå " + (error.message || error));
    alert("No se pudo cargar el partido.");
    return;
  }

  // Aplicar color a la vista del partido
  partyView.style.backgroundColor = party.color || "#fff";

  partyNameView.textContent = party.name;
  partyDescriptionView.textContent = party.description;
  manifestoList.innerHTML = party.manifesto?.map(line => `<li>${line}</li>`).join("") || "<li>No hay manifesto</li>";

  if(party.logo_path){
    const { data: urlData } = supabase.storage.from("logos").getPublicUrl(party.logo_path);
    if(urlData?.publicUrl){
      partyLogoView.src = urlData.publicUrl;
      partyLogoView.style.display = "block";
    } else {
      partyLogoView.style.display = "none";
    }
  } else {
    partyLogoView.style.display = "none";
  }

  if(user && user.id === party.creator_id){
    editBtn.style.display = "inline-block";
  } else {
    editBtn.style.display = "none";
  }

  // Cargar miembros
  const { data: members, error: membersError } = await supabase
    .from("party_members")
    .select("usuarios_id, usuarios:usuarios_id ( username )")
    .eq("party_id", partyId);

  if (membersError) {
    showError("‚ùå " + (error.message || error));
    partyMembersList.innerHTML = `<li>Error cargando miembros: ${membersError.message}</li>`;
  } else {
    partyMembersList.innerHTML = members.length > 0
      ? members.map(m => `<li>${m.usuarios?.username || "Anon"}</li>`).join("")
      : "<li>No hay miembros</li>";
  }

  // Iniciar chat
  startChatPolling(partyId);

  localStorage.setItem("currentPartyId", partyId);

  // Edici√≥n
  editBtn.onclick = () => {
    document.getElementById("editPartyName").value = party.name;
    document.getElementById("editPartyDescription").value = party.description;
    document.getElementById("editPartyManifesto").value = party.manifesto?.join("\n") || "";
    // prefill color
    document.getElementById("editPartyColor").value = party.color || "#0077ff";
    editForm.style.display = "block";
  };
  cancelEditBtn.onclick = () => { editForm.style.display = "none"; };
  saveEditBtn.onclick = async () => {
    const newName = document.getElementById("editPartyName").value;
    const newDesc = document.getElementById("editPartyDescription").value;
    const newManifesto = document.getElementById("editPartyManifesto").value.split("\n").filter(l => l.trim() !== "");
    const newLogoFile = document.getElementById("editPartyLogo").files[0];
    const newColor = document.getElementById("editPartyColor").value;

    let newLogoPath = null;

    if (newLogoFile) {
      const fileExt = newLogoFile.name.split('.').pop();
      const fileName = await cryptoRandomUUID() + '.' + fileExt;
      newLogoPath = `parties/logos/${fileName}`;
      const { error: uploadError } = await supabase.storage
        .from('logos')
        .upload(newLogoPath, newLogoFile, { upsert: true });
      if (uploadError) { alert("‚ùå Error subiendo nuevo logo: " + uploadError.message); return; }
    }

    const updateData = { name: newName, description: newDesc, manifesto: newManifesto, color: newColor };
    if(newLogoPath) updateData.logo_path = newLogoPath;

    const { error: updateError } = await supabase
      .from("parties")
      .update(updateData)
      .eq("id", partyId);

    if(updateError){ alert("‚ùå Error actualizando partido: " +updateError.message); return; }

    alert("‚úÖ Partido actualizado con √©xito");
    editForm.style.display = "none";
    showParty(partyId);
    // actualizar lista de partidos para ver color/logo nuevo
    loadParties();
  };
}

// ====================
// CHAT
// ====================
async function loadMessages(partyId){
  const { data, error } = await supabase
    .from("party_messages")
    .select("id, message, created_at, usuarios:usuarios_id ( username )")
    .eq("party_id", partyId)
    .order("created_at", { ascending:true });

  if(error){
    showError("‚ùå " + (error.message || error));
    return;
  }

  document.getElementById("partyChat").innerHTML = data?.map(m =>
    `<p><b>${m.usuarios?.username || 'Anon'}:</b> ${m.message}</p>`).join("") || "";
  // Auto-scroll al final
  const chatDiv = document.getElementById("partyChat");
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function startChatPolling(partyId){
  clearInterval(chatInterval);
  loadMessages(partyId);
  chatInterval = setInterval(()=>loadMessages(partyId), 3000);
}

// Enviar mensaje con Enter
chatInput.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter" && chatInput.value.trim() !== ""){
    e.preventDefault(); // evita salto de l√≠nea
    const user = JSON.parse(localStorage.getItem("currentUser"));
    const partyId = localStorage.getItem("currentPartyId");
    if(!user || !partyId) return;

    const message = chatInput.value.trim();
    chatInput.value = "";

    const { error } = await supabase.from("party_messages")
      .insert([{ party_id: partyId, usuarios_id: user.id, message }]);

    if(error){ showError("‚ùå " + (error.message || error)); return; }

    loadMessages(partyId);
  }
});

// ====================
// SALIR DEL PARTIDO
// ====================
leaveBtn.addEventListener("click", async ()=>{
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const partyId = localStorage.getItem("currentPartyId");
  if(!user || !partyId) return;

  const { error } = await supabase.from("party_members")
    .delete()
    .eq("party_id", partyId)
    .eq("usuarios_id", user.id);

  if(error){
    console.error("Error saliendo del partido:", error);
    alert("No se pudo salir del partido");
    return;
  }

  localStorage.removeItem("currentPartyId");
  clearInterval(chatInterval); // Detener el polling del chat
  partyView.style.display = "none";
  mainContainer.style.display = "block";
  loadParties();
});

// ====================
// VOLVER AL HUB
// ====================
hubBtn.addEventListener("click", ()=>{
  localStorage.removeItem("currentPartyId");
  clearInterval(chatInterval); // Detener el polling del chat
  window.location.href = "Hub.html";
});

// ====================
// DETECTAR SI YA EST√Å EN UN PARTIDO
// ====================
window.addEventListener("DOMContentLoaded", async ()=>{
  // 1) cargar lista de partidos
  await loadParties();

  // 2) si hay sesi√≥n / party guardado, abrir vista
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const savedPartyId = localStorage.getItem("currentPartyId");

  if(savedPartyId){
    showParty(savedPartyId);
  } else if(user){
    const { data: membership } = await supabase.from("party_members")
      .select("party_id").eq("usuarios_id", user.id);
    if(membership && membership.length>0){
      localStorage.setItem("currentPartyId", membership[0].party_id);
      showParty(membership[0].party_id);
    }
  }
});
</script>

</body>
</html>
