<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta Casino</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
    body {
        background-color: #1e1e1e;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    #pekePuntos { font-size: 1.5em; margin-bottom: 20px; }
    canvas { background: #0c0c0c; border-radius: 50%; margin-top: 20px; }
    #result { font-size: 1.3em; margin-top: 15px; color: #ffd700; }
    button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; margin: 3px; font-size: 14px; }
    button:hover { transform: scale(1.05); }
    #spin-button { background-color: #28a745; color: white; margin-top: 10px; }
    #bet-buttons { margin-top: 15px; display:flex; flex-wrap:wrap; justify-content:center; max-width:400px; margin:auto; }
    .bet-btn { min-width:40px; margin:2px; }
</style>
</head>
<body>
<h1>ðŸŽ¡ Ruleta Casino ðŸŽ¡</h1>
<div id="pekePuntos">Pekepuntos: 0</div>
<div id="bet-buttons"></div>
<canvas id="roulette" width="400" height="400"></canvas>
<div id="result"></div>
<button id="spin-button" disabled>Girar Ruleta</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBet = 0;
let betNumber = null;

const numbers = Array.from({length:37},(_,i)=>i);
const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
function getColor(num){ return num===0?'green':redNumbers.includes(num)?'red':'black'; }

const canvas = document.getElementById("roulette");
const ctx = canvas.getContext("2d");
const radius = canvas.width/2;
let currentAngle=0, spinning=false, finalNumber=null;

// --- Dibujar ruleta ---
function drawRoulette(){
    const step = 2*Math.PI/numbers.length;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(radius,radius);
    ctx.rotate(currentAngle);
    numbers.forEach((num,i)=>{
        const start=i*step, end=start+step;
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,start,end);
        ctx.fillStyle=getColor(num);
        ctx.fill();
        ctx.strokeStyle="white";
        ctx.stroke();
        ctx.save();
        ctx.rotate(start+step/2);
        ctx.fillStyle="white";
        ctx.textAlign="right";
        ctx.font="14px Arial";
        ctx.fillText(num,num<10?radius-15:radius-20,5);
        ctx.restore();
    });
    ctx.restore();
    ctx.beginPath();
    ctx.moveTo(radius-10,0); ctx.lineTo(radius+10,0);
    ctx.lineWidth=4; ctx.strokeStyle="yellow"; ctx.stroke();
}

// --- Girar ---
function spinRoulette(){
    if(spinning) return;
    spinning=true;
    let velocity=Math.random()*0.2+0.25;
    let deceleration=0.002+Math.random()*0.002;
    function animate(){
        if(velocity<=0){
            spinning=false;
            const step=2*Math.PI/numbers.length;
            let idx=Math.floor(((2*Math.PI-(currentAngle%(2*Math.PI)))/step))%numbers.length;
            finalNumber=numbers[idx];
            document.getElementById("result").textContent=`NÃºmero: ${finalNumber} (${getColor(finalNumber)})`;
            checkWin();
            return;
        }
        currentAngle+=velocity;
        velocity-=deceleration;
        drawRoulette();
        requestAnimationFrame(animate);
    }
    animate();
}

// --- Supabase ---
async function loadPekePuntos(){
    currentUser=JSON.parse(localStorage.getItem("currentUser"));
    if(!currentUser){ alert("Debes iniciar sesiÃ³n."); return; }
    const { data } = await supabase.from("usuarios").select("pekepuntos").eq("id",currentUser.id).single();
    if(data){ currentUser.pekepuntos=data.pekepuntos; document.getElementById("pekePuntos").textContent=`Pekepuntos: ${data.pekepuntos}`; localStorage.setItem("currentUser",JSON.stringify(currentUser)); }
}
async function updatePoints(multiplier){
    if(multiplier>0) currentUser.pekepuntos+=currentBet*multiplier;
    document.getElementById("pekePuntos").textContent=`Pekepuntos: ${currentUser.pekepuntos}`;
    await supabase.from("usuarios").update({pekepuntos:currentUser.pekepuntos}).eq("id",currentUser.id);
    localStorage.setItem("currentUser",JSON.stringify(currentUser));
    currentBet=0;
    document.getElementById("spin-button").disabled=true;
}

// --- Comprobar victoria ---
function checkWin(){
    if(finalNumber===betNumber){ alert("Â¡Ganaste!"); updatePoints(36); }
    else { alert("Perdiste"); updatePoints(0); }
}

// --- Botones de apuesta ---
function createBetButtons(){
    const container=document.getElementById("bet-buttons");
    numbers.forEach(num=>{
        const btn=document.createElement("button");
        btn.textContent=num;
        btn.className="bet-btn";
        btn.style.backgroundColor=getColor(num);
        btn.style.color=num===0?'black':'white';
        btn.onclick=()=> {
            const amount=parseInt(prompt(`Apostar cuÃ¡ntos PekePuntos al nÃºmero ${num}?`));
            if(isNaN(amount)||amount<=0||amount>currentUser.pekepuntos){ alert("Cantidad invÃ¡lida"); return; }
            betNumber=num; currentBet=amount; currentUser.pekepuntos-=amount;
            document.getElementById("pekePuntos").textContent=`Pekepuntos: ${currentUser.pekepuntos}`;
            localStorage.setItem("currentUser",JSON.stringify(currentUser));
            document.getElementById("spin-button").disabled=false;
            document.getElementById("result").textContent=`Apuesta: ${currentBet} PekePuntos al nÃºmero ${num}`;
        };
        container.appendChild(btn);
    });
}

// --- Eventos ---
document.getElementById("spin-button").addEventListener("click", spinRoulette);

// --- Inicializar ---
drawRoulette();
loadPekePuntos();
createBetButtons();
</script>
</body>
</html>
