<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ruleta</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  #bet-board {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 4px;
    margin: 20px auto;
    max-width: 700px;
  }
  .cell {
    padding: 10px;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  .cell.red { background:#c0392b; }
  .cell.black { background:#2c3e50; }
  .cell.green { background:#27ae60; grid-column: span 2; }
  .special-bets {
    margin-top: 20px;
  }
  .special-bets button {
    margin: 5px;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>🎡 Ruleta 🎡</h1>
<div id="pekePuntos">PekePuntos: 0</div>

<div id="bet-container">
  <label for="bet-amount">Apuesta: </label>
  <input type="number" id="bet-amount" min="1" placeholder="Cantidad">
  <select id="bet-type">
    <option value="number">Número exacto (0-36)</option>
    <option value="color">Color (rojo/negro)</option>
    <option value="paridad">Par/Impar</option>
  </select>
  <input type="text" id="bet-choice" placeholder="Ej: 17 / rojo / par">
  <button id="place-bet-button">Apostar</button>
</div>

<div id="bet-board"></div>

<div class="special-bets">
  <button onclick="selectBet('color','rojo')">Rojo 🔴</button>
  <button onclick="selectBet('color','negro')">Negro ⚫</button>
  <button onclick="selectBet('paridad','par')">Par</button>
  <button onclick="selectBet('paridad','impar')">Impar</button>
</div>
  
<div id="game-container">
  <button id="spin-button" disabled>Girar Ruleta</button>
  <div id="result"></div>
  <div id="error"></div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; // <-- reemplaza esto por tu key real
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBet = 0;
let betType = "";
let betChoice = "";

// Números rojos de la ruleta
const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

const $peke = id => document.getElementById(id);

// Carga inicial de puntos
async function loadPekePuntos(){
  try {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if(!currentUser) {
      alert("Debes iniciar sesión para jugar.");
      window.location.href = "login.html";
      return;
    }
    const { data, error } = await supabase.from("usuarios").select("pekepuntos").eq("id", currentUser.id).single();
    if(error) { console.error("Supabase read error:", error); /*pero seguimos con lo que haya en local*/ }
    if(data && data.pekepuntos !== undefined) currentUser.pekepuntos = data.pekepuntos;
    $peke("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  } catch (e) {
    console.error("loadPekePuntos error:", e);
  }
}

// Guarda puntos en supabase de forma segura (no rompe la UI si falla)
async function savePekePuntos(){
  try {
    const { error } = await supabase.from("usuarios").update({ pekepuntos: currentUser.pekepuntos }).eq("id", currentUser.id);
    if(error) throw error;
  } catch (e) {
    console.error("Error guardando PekePuntos en Supabase:", e);
    $peke("error").textContent = "Warning: no se pudieron guardar los puntos en el servidor (revisa la consola).";
    // seguimos para que el usuario pueda jugar aunque falle el guardado remoto
  } finally {
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  }
}

// updatePoints recibe un multiplicador numérico (0 = pierde)
async function updatePoints(multiplier){
  if(typeof multiplier !== "number") multiplier = 0;
  if(multiplier > 0){
    // ya restamos la apuesta al colocarla; ahora devolvemos + premios
    currentUser.pekepuntos += currentBet * multiplier;
  } // si multiplier === 0 -> ya perdió (no devolvemos nada)

  $peke("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;
  await savePekePuntos();
  currentBet = 0;
}

// Valida entrada según tipo de apuesta
function validateBetChoice(type, choice){
  if(type === "number"){
    const n = parseInt(choice, 10);
    if(Number.isNaN(n)) return { ok:false, msg:"Número inválido" };
    if(n < 0 || n > 36) return { ok:false, msg:"El número debe estar entre 0 y 36" };
    return { ok:true, value:n };
  }
  if(type === "color"){
    const c = choice.toLowerCase();
    if(!["rojo","negro"].includes(c)) return { ok:false, msg:"Color inválido (rojo o negro)" };
    return { ok:true, value:c };
  }
  if(type === "paridad"){
    const p = choice.toLowerCase();
    if(!["par","impar"].includes(p)) return { ok:false, msg:"Paridad inválida (par o impar)" };
    return { ok:true, value:p };
  }
  return { ok:false, msg:"Tipo de apuesta desconocido" };
}

// Girar ruleta
async function spinRoulette(){
  try {
    // proteger contra doble click
    $peke("spin-button").disabled = true;
    $peke("error").textContent = "";

    const result = Math.floor(Math.random() * 37); // 0-36
    const color = (result === 0) ? "verde" : (redNumbers.includes(result) ? "rojo" : "negro");

    let win = false;
    let multiplier = 0;

    if(betType === "number" && parseInt(betChoice, 10) === result) { win = true; multiplier = 36; }
    if(betType === "color" && betChoice.toLowerCase() === color) { win = true; multiplier = 2; }
    if(betType === "paridad") {
      if(betChoice.toLowerCase() === "par" && result % 2 === 0 && result !== 0) { win = true; multiplier = 2; }
      if(betChoice.toLowerCase() === "impar" && result % 2 === 1) { win = true; multiplier = 2; }
    }

    $peke("result").textContent = `Número: ${result} (${color}) - ${win ? "Ganaste 🎉" : "Perdiste ❌"}`;

    // actualizar puntos en servidor (esperamos que acabe antes de permitir nueva apuesta)
    await updatePoints(win ? multiplier : 0);

  } catch (e) {
    console.error("spinRoulette error:", e);
    $peke("error").textContent = "Error en la ruleta (mira consola).";
  } finally {
    // permitir una nueva apuesta
    $peke("place-bet-button").disabled = false;
    $peke("bet-amount").disabled = false;
    $peke("spin-button").disabled = true;
    // limpiar elección (opcional)
    $peke("bet-choice").value = "";
    betType = "";
    betChoice = "";
  }
}

// Evento apostar (descuenta al momento)
$peke("place-bet-button").addEventListener("click", async ()=>{
  try {
    $peke("error").textContent = "";

    const bet = parseInt($peke("bet-amount").value, 10);
    if(Number.isNaN(bet) || bet <= 0){ alert("Introduce una cantidad válida."); return; }

    // cargar usuario si no está en memoria
    if(!currentUser){
      await loadPekePuntos();
      if(!currentUser) return;
    }

    if(bet > currentUser.pekepuntos){ alert("No tienes suficientes PekePuntos."); return; }

    const type = $peke("bet-type").value;
    const choiceRaw = $peke("bet-choice").value.trim();
    const validated = validateBetChoice(type, choiceRaw);
    if(!validated.ok){ alert(validated.msg); return; }

    // TODO: aquí puedes guardar también la apuesta en una tabla "partidas" si quieres auditar
    currentBet = bet;
    betType = type;
    betChoice = validated.value;

    // Descontar al momento
    currentUser.pekepuntos -= currentBet;
    $peke("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;

    // Intentamos guardar inmediatamente, pero no bloqueamos si falla
    await savePekePuntos();

    // Mostrar apuesta y habilitar girar
    $peke("result").textContent = `Apuesta: ${currentBet} PekePuntos a ${choiceRaw}`;
    $peke("place-bet-button").disabled = true;
    $peke("bet-amount").disabled = true;
    $peke("spin-button").disabled = false;

  } catch (e) {
    console.error("place-bet error:", e);
    $peke("error").textContent = "Error al apostar (mira consola).";
  }
});

// botón girar
$peke("spin-button").addEventListener("click", spinRoulette);

// Inicializar al cargar
loadPekePuntos();
</script>
</body>
</html>
