<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta Casino</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body {
    background-color: #1e1e1e;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
}
#pekePuntos { font-size: 1.5em; margin-bottom: 20px; }
canvas { background: #0c0c0c; border-radius: 50%; margin-top: 20px; }
#result { font-size: 1.3em; margin-top: 15px; color: #ffd700; }
button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; margin: 3px; font-size: 14px; }
button:hover { transform: scale(1.05); }
#spin-button { background-color: #28a745; color: white; margin-top: 10px; }
#bet-buttons, #bet-options { margin-top: 15px; display:flex; flex-wrap:wrap; justify-content:center; max-width:500px; margin:auto; }
.bet-btn { min-width:40px; margin:2px; }
.option-btn { min-width:60px; margin:2px; }
</style>
</head>
<body>
<h1>ðŸŽ¡ Ruleta Casino ðŸŽ¡</h1>
<div id="pekePuntos">Pekepuntos: 0</div>

<!-- Botones de nÃºmeros -->
<div id="bet-buttons"></div>
<!-- Botones de color/paridad -->
<div id="bet-options"></div>

<label for="bet-amount">Cantidad a apostar: </label>
<input type="number" id="bet-amount" min="1" placeholder="Puntos a apostar">
<button id="confirm-bet-button">Confirmar Apuesta</button>

<canvas id="roulette" width="400" height="400"></canvas>
<div id="result"></div>
<button id="spin-button" disabled>Girar Ruleta</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImF4IiwiaWF0IjoxNzU4MDM2NTIxLCJleHAiOjIwNzM2MTI1MjF9.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBet = 0;
let selectedNumbers = new Set();
let selectedColor = null;
let selectedParity = null;

const numbers = Array.from({length:37},(_,i)=>i);
const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
function getColor(num){ return num===0?'green':redNumbers.includes(num)?'red':'black'; }

const canvas = document.getElementById("roulette");
const ctx = canvas.getContext("2d");
const radius = canvas.width/2;
let currentAngle=0, spinning=false, finalNumber=null;

// --- Dibujar ruleta ---
function drawRoulette(){
    const step = 2*Math.PI/numbers.length;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(radius,radius);
    ctx.rotate(currentAngle);
    numbers.forEach((num,i)=>{
        const start=i*step, end=start+step;
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,start,end);
        ctx.fillStyle=getColor(num);
        ctx.fill();
        ctx.strokeStyle="white";
        ctx.stroke();
        ctx.save();
        ctx.rotate(start+step/2);
        ctx.fillStyle="white";
        ctx.textAlign="right";
        ctx.font="14px Arial";
        ctx.fillText(num,num<10?radius-15:radius-20,5);
        ctx.restore();
    });
    ctx.restore();
    ctx.beginPath();
    ctx.moveTo(radius-10,0); ctx.lineTo(radius+10,0);
    ctx.lineWidth=4; ctx.strokeStyle="yellow"; ctx.stroke();
}

// --- Girar ---
function spinRoulette(){
    if(spinning) return;
    if(currentBet<=0){ alert("Debes confirmar la apuesta"); return; }
    spinning=true;
    let velocity=Math.random()*0.2+0.25;
    let deceleration=0.002+Math.random()*0.002;
    function animate(){
        if(velocity<=0){
            spinning=false;
            const step=2*Math.PI/numbers.length;
            let idx=Math.floor(((2*Math.PI-(currentAngle%(2*Math.PI)))/step))%numbers.length;
            finalNumber=numbers[idx];
            const color=getColor(finalNumber);
            const parity=finalNumber===0?null:(finalNumber%2===0?"even":"odd");
            document.getElementById("result").textContent=`NÃºmero: ${finalNumber} (${color})`;
            calculateWinnings(finalNumber,color,parity);
            return;
        }
        currentAngle+=velocity;
        velocity-=deceleration;
        drawRoulette();
        requestAnimationFrame(animate);
    }
    animate();
}

// --- Supabase ---
async function loadPekePuntos() {
    // Intentar cargar usuario desde localStorage (opcional)
    currentUser = JSON.parse(localStorage.getItem("currentUser"));

    // Si no hay usuario, pedir login o abortar
    if (!currentUser || !currentUser.id) {
        alert("Debes iniciar sesiÃ³n.");
        return;
    }

    // Cargar los puntos directamente desde Supabase
    const { data, error } = await supabase
        .from("usuarios")
        .select("pekepuntos")
        .eq("id", currentUser.id)
        .single();

    if (error) {
        console.error("Error cargando puntos:", error);
        alert("No se pudieron cargar tus PekePuntos.");
        return;
    }

    currentUser.pekepuntos = data.pekepuntos;
    document.getElementById("pekePuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos}`;
    // Guardar actualizado en localStorage
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

async function updatePoints(wonAmount){
    if(wonAmount>0) currentUser.pekepuntos+=wonAmount;
    document.getElementById("pekePuntos").textContent=`Pekepuntos: ${currentUser.pekepuntos}`;
    await supabase.from("usuarios").update({pekepuntos:currentUser.pekepuntos}).eq("id",currentUser.id);
    localStorage.setItem("currentUser",JSON.stringify(currentUser));
    resetSelections();
}

// --- Calcular ganancias ---
function calculateWinnings(number,color,parity){
    let won=0;
    if(selectedNumbers.has(number)) won += currentBet*36/selectedNumbers.size;
    if(selectedColor && color===selectedColor) won += currentBet*2;
    if(selectedParity && ((parity==="even" && selectedParity==="even") || (parity==="odd" && selectedParity==="odd"))) won += currentBet*2;
    alert(won>0?`Â¡Ganaste ${won} PekePuntos!`:"Perdiste la apuesta");
    updatePoints(won);
}

// --- Crear botones de apuesta ---
function createBetButtons(){
    const container=document.getElementById("bet-buttons");
    numbers.forEach(num=>{
        const btn=document.createElement("button");
        btn.textContent=num;
        btn.className="bet-btn";
        btn.style.backgroundColor=getColor(num);
        btn.style.color=num===0?'black':'white';
        btn.onclick=()=> {
            if(selectedNumbers.has(num)) { selectedNumbers.delete(num); btn.style.border=""; }
            else { selectedNumbers.add(num); btn.style.border="2px solid yellow"; }
        };
        container.appendChild(btn);
    });
    // Colores
    const optionsContainer=document.getElementById("bet-options");
    ["red","black"].forEach(c=>{
        const btn=document.createElement("button");
        btn.textContent=c;
        btn.className="option-btn";
        btn.style.backgroundColor=c;
        btn.style.color="white";
        btn.onclick=()=> { selectedColor = selectedColor===c?null:c; btn.style.border=selectedColor===c?"2px solid yellow":""; };
        optionsContainer.appendChild(btn);
    });
    // Paridad
    ["even","odd"].forEach(p=>{
        const btn=document.createElement("button");
        btn.textContent=p==="even"?"Par":"Impar";
        btn.className="option-btn";
        btn.style.backgroundColor="#444";
        btn.style.color="white";
        btn.onclick=()=> { selectedParity = selectedParity===p?null:p; btn.style.border=selectedParity===p?"2px solid yellow":""; };
        optionsContainer.appendChild(btn);
    });
}

// --- Confirmar apuesta ---
document.getElementById("confirm-bet-button").addEventListener("click",()=>{
    const amount=parseInt(document.getElementById("bet-amount").value);
    if(isNaN(amount)||amount<=0||amount>currentUser.pekepuntos){ alert("Cantidad invÃ¡lida"); return; }
    if(selectedNumbers.size===0 && !selectedColor && !selectedParity){ alert("Debes seleccionar al menos un nÃºmero, color o paridad"); return; }
    currentBet=amount;
    currentUser.pekepuntos-=currentBet;
    document.getElementById("pekePuntos").textContent=`Pekepuntos: ${currentUser.pekepuntos}`;
    document.getElementById("spin-button").disabled=false;
});

// --- Resetear selecciÃ³n ---
function resetSelections(){
    selectedNumbers.clear(); selectedColor=null; selectedParity=null; currentBet=0;
    document.getElementById("spin-button").disabled=true;
    document.getElementById("bet-amount").value="";
    document.querySelectorAll(".bet-btn,.option-btn").forEach(b=>b.style.border="");
}

// --- Inicializar ---
drawRoulette();
loadPekePuntos();
createBetButtons();
document.getElementById("spin-button").addEventListener("click",spinRoulette);
</script>
</body>
</html>
