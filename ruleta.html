<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruleta</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
    body {
        background-color: #2c2c2c;
        color: white;
        font-family: 'Arial', sans-serif;
        text-align: center;
        padding: 30px;
    }
    #pekePuntos { font-size: 2em; margin-bottom: 20px; }
    #bet-container { margin-bottom: 20px; }

    input, select {
        padding: 5px;
        border-radius: 5px;
        border: none;
        font-size: 16px;
        margin: 5px;
    }
    button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    #spin-button { background-color: #28a745; color: white; }
    #place-bet-button { background-color: #ffc107; color: black; }

    #game-container {
        background-color: #004400;
        border-radius: 15px;
        padding: 20px;
        margin: 0 auto;
        max-width: 600px;
    }
    #result {
        font-size: 1.5em;
        margin-top: 20px;
        color: #ffd700;
    }
</style>
</head>
<body>

<h1>🎡 Ruleta 🎡</h1>
<div id="pekePuntos">Pekepuntos: 0</div>

<div id="bet-container">
    <label for="bet-amount">Apuesta: </label>
    <input type="number" id="bet-amount" min="1" placeholder="Cantidad">
    <select id="bet-type">
        <option value="number">Número exacto (0-36)</option>
        <option value="color">Color (rojo/negro)</option>
        <option value="paridad">Par/Impar</option>
    </select>
    <input type="text" id="bet-choice" placeholder="Ej: 17 / rojo / par">
    <button id="place-bet-button">Apostar</button>
</div>

<div id="game-container">
    <button id="spin-button" disabled>Girar Ruleta</button>
    <div id="result"></div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; // ⚠️ pon tu key
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBet = 0;
let betType = "";
let betChoice = "";

// Colores de números en la ruleta
const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

// --- Cargar usuario ---
async function loadPekePuntos() {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if(!currentUser) {
        alert("Debes iniciar sesión para jugar.");
        window.location.href = "login.html";
        return;
    }
    const { data, error } = await supabase.from("usuarios").select("pekepuntos").eq("id", currentUser.id).single();
    if(error) { console.error(error); return; }
    currentUser.pekepuntos = data.pekepuntos;
    document.getElementById("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

// --- Actualizar Puntos ---
    async function updatePoints(result) {
    if(result === "win"){
        // gana: recupera la apuesta multiplicada x2
        currentUser.pekepuntos += currentBet * 2;
    } else if(result === "draw"){
        // empate: recupera solo la apuesta
        currentUser.pekepuntos += currentBet;
    }
    // si pierde no hacemos nada (ya perdió al apostar)

    document.getElementById("pekePuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos}`;
    await supabase.from("usuarios")
        .update({ pekepuntos: currentUser.pekepuntos })
        .eq("id", currentUser.id);
    localStorage.setItem("currentUser", JSON.stringify(currentUser));

    currentBet = 0;
}


// --- Lógica Ruleta ---
function spinRoulette() {
    const result = Math.floor(Math.random() * 37); // 0-36
    const color = result === 0 ? "verde" : (redNumbers.includes(result) ? "rojo" : "negro");

    let win = false;
    let multiplier = 0;

    if(betType === "number" && parseInt(betChoice) === result) { win = true; multiplier = 36; }
    if(betType === "color" && betChoice.toLowerCase() === color) { win = true; multiplier = 2; }
    if(betType === "paridad") {
        if(betChoice.toLowerCase() === "par" && result % 2 === 0 && result !== 0) { win = true; multiplier = 2; }
        if(betChoice.toLowerCase() === "impar" && result % 2 === 1) { win = true; multiplier = 2; }
    }

    document.getElementById("result").textContent = `Número: ${result} (${color}) - ${win ? "Ganaste 🎉" : "Perdiste ❌"}`;
    updatePoints(win ? multiplier : 0);
    document.getElementById("spin-button").disabled = true;
    document.getElementById("place-bet-button").disabled = false;
    document.getElementById("bet-amount").disabled = false;
}

// --- Eventos ---
document.getElementById("place-bet-button").addEventListener("click", async ()=>{
    const bet = parseInt(document.getElementById("bet-amount").value);
    if(isNaN(bet) || bet<=0){ alert("Introduce una cantidad válida."); return; }
    if(bet>currentUser.pekepuntos){ alert("No tienes suficientes PekePuntos."); return; }

    currentBet = bet;

    // 💰 Restar inmediatamente la apuesta
    currentUser.pekepuntos -= currentBet;
    document.getElementById("pekePuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos}`;
    await supabase.from("usuarios")
        .update({ pekepuntos: currentUser.pekepuntos })
        .eq("id", currentUser.id);
    localStorage.setItem("currentUser", JSON.stringify(currentUser));

    // Iniciar la partida normalmente
    startGame();

    // Deshabilitar inputs mientras se juega
    document.getElementById("place-bet-button").disabled = true;
    document.getElementById("bet-amount").disabled = true;
});

document.getElementById("spin-button").addEventListener("click", spinRoulette);

// Inicializar
loadPekePuntos();
</script>
</body>
</html>
