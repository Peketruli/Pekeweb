<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Archivos - PekeOS</title>

<script type="text/javascript">
    // Si esta p√°gina es la ventana principal (no est√° dentro de un iframe/ventana)
    if (window.self === window.top) {
        // Redirigir al sistema operativo
        window.location.replace("PekeOS.html");
    }
</script>
<style>
  :root{--neon:#00ffd0;--muted:#9ef7ea;--bg-dark:#02040a;--border:rgba(0,255,208,0.06)}
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:linear-gradient(180deg,#03040a,#07131a);color:var(--muted);padding:12px;height:100vh;overflow:hidden}
  
  /* Header & Controls */
  .header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:rgba(0,255,208,0.02);border:1px solid var(--border);padding:8px 12px;border-radius:6px;cursor:pointer;color:var(--muted);transition:0.2s}
  .btn:hover{background:rgba(0,255,208,0.1);border-color:var(--neon);color:#fff}
  .btn-danger:hover{background:rgba(255, 50, 50, 0.2);border-color:#ff4444}
  
  /* Layout Main */
  .layout{display:flex;gap:12px;height:calc(100% - 60px)}
  .sidebar{width:220px;background:rgba(255,255,255,0.01);padding:10px;border-radius:10px;border:1px solid rgba(0,255,208,0.04);display:flex;flex-direction:column;gap:8px}
  .main{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  
  /* Views & Grid */
  .view{flex:1;background:var(--bg-dark);padding:12px;border-radius:10px;border:1px solid rgba(0,255,208,0.03);display:flex;gap:12px;overflow:hidden}
  .content-area{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
  
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px, 1fr));gap:12px;align-content:flex-start;overflow-y:auto;padding:4px}
  .item{text-align:center;padding:10px;border-radius:8px;border:1px solid transparent;cursor:pointer;user-select:none;transition:0.1s}
  .item:hover{background:rgba(0,255,208,0.05);border-color:rgba(0,255,208,0.1)}
  .item.selected{background:rgba(0,255,208,0.1);border-color:var(--neon)}
  .icon{font-size:32px;margin-bottom:4px}
  
  .list{display:flex;flex-direction:column;gap:2px;overflow-y:auto}
  .row{display:flex;justify-content:space-between;padding:8px;border-radius:4px;align-items:center;cursor:pointer}
  .row:hover{background:rgba(0,255,208,0.05)}
  .row.selected{background:rgba(0,255,208,0.1)}

  /* Preview Pane */
  .preview{width:300px;background:#010306;border-radius:8px;padding:12px;border:1px solid rgba(0,255,208,0.03);display:flex;flex-direction:column;gap:10px}
  .preview img{max-width:100%;border-radius:6px;max-height:200px;object-fit:contain}
  
  /* Forms */
  .input{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.3);color:#fff;outline:none}
  .input:focus{border-color:var(--neon)}
  .hidden{display:none !important}
  
  .dropzone{border:2px dashed rgba(0,255,208,0.1);padding:15px;border-radius:8px;text-align:center;color:var(--muted);margin-top:auto}
  .dropzone:hover{border-color:var(--neon);background:rgba(0,255,208,0.02)}
  
  .backbar{display:flex;gap:8px;align-items:center;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.05)}
  .small{font-size:11px;color:rgba(158, 247, 234, 0.6)}
</style>
</head>
<body>

  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn" onclick="window.location.href='PekeOS.html'">üíª Escritorio</button>
      <div>
        <div style="font-weight:800;font-size:18px">üìÅ Archivos</div>
        <div class="small">Sistema de archivos local</div>
      </div>
    </div>
    <div class="controls">
      <input id="searchInput" class="input" placeholder="Buscar..." />
      <button class="btn" id="newFile" title="Nuevo Archivo">üìÑ +</button>
      <button class="btn" id="newFolder" title="Nueva Carpeta">üìÅ +</button>
      <button class="btn" id="uploadBtn" title="Subir desde PC">‚¨ÜÔ∏è Subir</button>
      <input id="filePicker" type="file" class="hidden" multiple />
      <button class="btn" id="toggleViewBtn">üîÅ Vista</button>
      <button class="btn" id="exportFS">üíæ Backup</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="backbar">
        <button class="btn" id="backBtn">‚¨ÖÔ∏è</button>
        <div id="pathBar" style="font-family:monospace;font-size:12px;overflow:hidden;text-overflow:ellipsis">/</div>
      </div>
      
      <div style="font-weight:700;margin-top:4px;font-size:12px;text-transform:uppercase;opacity:0.7">Acciones</div>
      <button class="btn" id="saveFSBtn">‚úî Guardar Cambios</button>
      <button class="btn" id="loadFSBtn">üìÇ Restaurar Backup</button>
      
      <div class="dropzone" id="dropzone">Arrastra archivos aqu√≠</div>
    </div>

    <div class="view">
      <div class="content-area">
        <div id="gridArea" class="grid"></div>
        <div id="listArea" class="list hidden"></div>
      </div>

      <div id="preview" class="preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="previewTitle">Info</div>
          <div class="small" id="previewType"></div>
        </div>
        
        <div id="previewContent" style="flex:1;overflow:auto;font-size:13px;color:#bfffee;word-break:break-all;">
          Selecciona un archivo.
        </div>

        <div id="editorWrap" class="hidden" style="flex:1;display:flex;flex-direction:column;gap:8px">
          <textarea id="textEditor" style="flex:1;background:#000;border-radius:6px;border:1px solid rgba(255,255,255,0.1);color:var(--muted);padding:8px;resize:none;font-family:monospace"></textarea>
          <div style="display:flex;gap:8px">
            <button class="btn" id="saveEdit" style="flex:1">üíæ Guardar</button>
            <button class="btn" id="cancelEdit">‚úñ</button>
          </div>
        </div>

        <div class="controls" style="margin-top:auto;flex-wrap:wrap;justify-content:center">
           <button class="btn" id="editBtn" title="Editar">‚úèÔ∏è</button>
           <button class="btn" id="renameBtn" title="Renombrar">üî§</button>
           <button class="btn" id="downloadBtn" title="Descargar">‚¨áÔ∏è</button>
           <button class="btn btn-danger" id="deleteBtn" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------- Configuraci√≥n FS ---------------- */
const LS_KEY = 'pekeos_fs_v1';

function defaultFS(){ return {name:'root', type:'folder', children:[
  {name:'Documentos', type:'folder', children:[{name:'Leeme.txt', type:'file', mime:'text/plain', content:'Bienvenido a PekeOS.\nPuedes editar este archivo.', size:45}]},
  {name:'Imagenes', type:'folder', children:[]}
]}; }

let FS = null;
let cwd = ['/']; // current working directory stack

/* Inicializaci√≥n */
function loadFS(){ 
  try{ 
    const raw=localStorage.getItem(LS_KEY); 
    FS = raw ? JSON.parse(raw) : defaultFS(); 
  }catch(e){ FS = defaultFS(); } 
}
function saveFS(){ 
  localStorage.setItem(LS_KEY, JSON.stringify(FS)); 
  console.log('FS Guardado'); 
}
loadFS();

/* Navegaci√≥n */
function getNodeByPath(pathArr){
  let node = FS;
  for(let i=1;i<pathArr.length;i++){
    const part = pathArr[i];
    node = (node.children||[]).find(x=>x.name===part && x.type==='folder');
    if(!node) return null;
  }
  return node;
}
function currentFolder(){ return getNodeByPath(cwd) || FS; }

/* Referencias UI */
const gridArea = document.getElementById('gridArea');
const listArea = document.getElementById('listArea');
const pathBar = document.getElementById('pathBar');
const previewTitle = document.getElementById('previewTitle');
const previewContent = document.getElementById('previewContent');
const previewType = document.getElementById('previewType');
const editorWrap = document.getElementById('editorWrap');
const textEditor = document.getElementById('textEditor');

let selectedName = null; 
let viewMode = 'grid';

/* ---------------- Renderizado ---------------- */
function renderFS(filter=''){
  const folder = currentFolder(); 
  pathBar.textContent = cwd.join('/') || '/';
  
  const items = folder.children || [];
  const q = (filter||'').toLowerCase().trim();
  const shown = q ? items.filter(it=>it.name.toLowerCase().includes(q)) : items;
  
  // Render Grid
  gridArea.innerHTML = shown.map(it=>{
    const icon = getIcon(it);
    const isSel = selectedName === it.name ? 'selected' : '';
    return `<div class="item ${isSel}" data-name="${escapeHtml(it.name)}">
              <div class="icon">${icon}</div>
              <div style="font-weight:600;font-size:12px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(it.name)}</div>
            </div>`;
  }).join('');

  // Render List
  listArea.innerHTML = shown.map(it=>{
    const icon = getIcon(it);
    const isSel = selectedName === it.name ? 'selected' : '';
    return `<div class="row ${isSel}" data-name="${escapeHtml(it.name)}">
              <div style="display:flex;align-items:center;gap:10px">
                <div style="width:24px">${icon}</div>
                <div>${escapeHtml(it.name)}</div>
              </div>
              <div class="small">${it.type==='folder'?'Carpeta':formatSize(it.size)}</div>
            </div>`;
  }).join('');
  
  attachHandlers();
}

function getIcon(it){
    if(it.type==='folder') return 'üìÅ';
    if(it.mime && it.mime.startsWith('image/')) return 'üñºÔ∏è';
    if(it.mime && it.mime.startsWith('audio/')) return 'üéµ';
    if(it.mime && it.mime.startsWith('video/')) return 'üé•';
    return 'üìÑ';
}

function formatSize(bytes){
    if(!bytes) return '-';
    if(bytes<1024) return bytes+' B';
    return (bytes/1024).toFixed(1)+' KB';
}

function attachHandlers(){
  const clickHandler = (name) => selectItem(name);
  const dblClickHandler = (name) => openItem(name);

  document.querySelectorAll('.item, .row').forEach(el=>{
    const name = el.dataset.name;
    el.onclick = ()=> clickHandler(name);
    el.ondblclick = ()=> dblClickHandler(name);
    
    // Drag start
    el.draggable = true;
    el.ondragstart = e => e.dataTransfer.setData('text/name', name);
  });
}

function escapeHtml(s){ 
  return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
}

/* ---------------- L√≥gica Selecci√≥n y Editor ---------------- */

function toggleEditor(show){
    if(show){
        editorWrap.classList.remove('hidden');
        previewContent.classList.add('hidden');
        document.getElementById('editBtn').classList.add('hidden'); 
    } else {
        editorWrap.classList.add('hidden');
        previewContent.classList.remove('hidden');
        document.getElementById('editBtn').classList.remove('hidden');
    }
}

function selectItem(name){
  selectedName = name;
  renderFS(); // Re-render para mostrar la clase .selected
  
  const folder = currentFolder(); 
  const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  
  previewTitle.textContent = it.name;
  previewType.textContent = it.type === 'folder' ? 'Carpeta' : (it.mime || 'Archivo');
  
  toggleEditor(false); // Reset editor view

  if(it.type==='folder'){
    previewContent.innerHTML = `<div style="text-align:center;padding:20px">üìÇ<br>${it.children?it.children.length:0} elementos</div>`;
  } else if(it.mime && it.mime.startsWith('image/')){
    previewContent.innerHTML = `<img src="${it.content}" alt="${it.name}">`;
  } else if(it.mime && it.mime.startsWith('audio/')){
    previewContent.innerHTML = `<audio controls src="${it.content}" style="width:100%"></audio>`;
  } else {
    // Texto simple preview
    const shortContent = it.content ? (it.content.length > 500 ? it.content.substring(0,500)+'...' : it.content) : '(Vac√≠o)';
    previewContent.innerHTML = `<pre style="white-space:pre-wrap;font-family:monospace;margin:0">${escapeHtml(shortContent)}</pre>`;
  }
}

function openItem(name){
  const folder = currentFolder(); 
  const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  
  if(it.type==='folder'){ 
    cwd.push(it.name); 
    selectedName = null;
    renderFS(); 
  } else {
    // Intentar abrir
    if(it.content && it.content.startsWith('data:')) {
        const win = window.open();
        win.document.write('<img src="'+it.content+'" style="max-width:100%">');
    } else {
       // Descarga/abrir blob
       const blob = new Blob([it.content||''], {type: it.mime||'text/plain'});
       const url = URL.createObjectURL(blob);
       window.open(url, '_blank');
    }
  }
}

/* ---------------- Acciones (CRUD) ---------------- */

document.getElementById('newFile').addEventListener('click', ()=>{
  const name = prompt('Nombre archivo (ej: nota.txt)'); if(!name) return;
  const folder = currentFolder();
  if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name, type:'file', mime:'text/plain', content:'', size:0});
  saveFS(); renderFS();
});

document.getElementById('newFolder').addEventListener('click', ()=>{
  const name = prompt('Nombre carpeta'); if(!name) return;
  const folder = currentFolder();
  if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name, type:'folder', children:[]});
  saveFS(); renderFS();
});

document.getElementById('renameBtn').addEventListener('click', ()=>{
  if(!selectedName) return;
  const newName = prompt('Renombrar a:', selectedName); if(!newName || newName===selectedName) return;
  const folder = currentFolder(); 
  if(folder.children.find(x=>x.name===newName)){ alert('Ya existe un archivo con ese nombre'); return; }
  const it = folder.children.find(x=>x.name===selectedName); 
  if(it){ it.name=newName; selectedName=newName; saveFS(); renderFS(); selectItem(newName); }
});

document.getElementById('deleteBtn').addEventListener('click', ()=>{
  if(!selectedName) return;
  if(!confirm('¬øEliminar "'+selectedName+'"?')) return;
  const folder = currentFolder(); 
  folder.children = folder.children.filter(x=>x.name!==selectedName); 
  selectedName=null; 
  previewTitle.textContent='Info'; 
  previewContent.innerHTML='Selecciona un archivo.'; 
  saveFS(); renderFS();
});

/* Editor de Texto */
document.getElementById('editBtn').addEventListener('click', ()=>{
  if(!selectedName){ alert('Selecciona un archivo'); return; }
  const folder = currentFolder(); 
  const it = folder.children.find(x=>x.name===selectedName); 
  
  if(!it || it.type==='folder'){ alert('No se puede editar una carpeta'); return; }
  if(!(it.mime && (it.mime.startsWith('text') || it.mime==='text/plain' || !it.mime))){ alert('Solo archivos de texto'); return; }
  
  textEditor.value = it.content || '';
  toggleEditor(true);
});

document.getElementById('saveEdit').addEventListener('click', ()=> {
  const folder = currentFolder(); 
  const it = folder.children.find(x=>x.name===selectedName); 
  if(it){
      it.content = textEditor.value; 
      it.size = it.content.length; 
      saveFS(); 
      toggleEditor(false);
      selectItem(selectedName); // Refrescar preview
  }
});

document.getElementById('cancelEdit').addEventListener('click', ()=> toggleEditor(false));

/* ---------------- Subidas y Descargas ---------------- */

const filePicker = document.getElementById('filePicker');
document.getElementById('uploadBtn').addEventListener('click', ()=> filePicker.click());

filePicker.addEventListener('change', async (e)=>{ 
    const files = Array.from(e.target.files || []); 
    await processUpload(files); 
    filePicker.value=''; 
});

async function processUpload(files){
  const folder = currentFolder();
  for(const f of files){
    const data = await readFileAsDataURL(f);
    let finalName = f.name; 
    let idx=1;
    // Evitar duplicados
    while(folder.children.find(x=>x.name===finalName)){ 
        finalName = `${f.name.replace(/(\.\w+)?$/,'')} (${idx})${(f.name.match(/\.\w+$/)||[''])[0]}`; 
        idx++; 
    }
    folder.children.push({name:finalName,type:'file',mime:f.type||'application/octet-stream',content:data,size:f.size});
  }
  saveFS(); renderFS();
}

function readFileAsDataURL(file){ 
    return new Promise((res,rej)=>{ 
        const r=new FileReader(); 
        r.onload=()=>res(r.result); 
        r.onerror=rej; 
        r.readAsDataURL(file); 
    }); 
}

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!selectedName) return;
  const folder = currentFolder(); 
  const it = folder.children.find(x=>x.name===selectedName); if(!it) return;
  if(it.type==='folder') return; // No zip support implemented

  const a=document.createElement('a'); 
  if(it.content && it.content.startsWith('data:')){
      a.href=it.content; 
  } else {
      const blob = new Blob([it.content||''], {type: it.mime||'text/plain'});
      a.href = URL.createObjectURL(blob);
  }
  a.download = it.name; 
  a.click(); 
});

/* ---------------- Drag & Drop ---------------- */
const dropzone = document.getElementById('dropzone');

dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor='#00ffd0'; background:'rgba(0,255,208,0.1)'; });
dropzone.addEventListener('dragleave', ()=> { dropzone.style.borderColor='rgba(0,255,208,0.1)'; background:'transparent'; });
dropzone.addEventListener('drop', async (e)=>{ 
    e.preventDefault(); 
    dropzone.style.borderColor='rgba(0,255,208,0.1)';
    
    const files = Array.from(e.dataTransfer.files || []); 
    if(files.length){
        await processUpload(files); 
    } else { 
        // Movimiento interno
        const name = e.dataTransfer.getData('text/name'); 
        if(name) moveItemToCurrent(name); 
    } 
});

function moveItemToCurrent(name){
    // Busca recursivamente el item en todo el FS para moverlo aqu√≠
    let found=null, parentNode=null;
    (function walk(node){
        if(node.children){
          for(const c of node.children){ 
              if(c.name===name){ found=c; parentNode=node; return true;} 
              if(c.type==='folder' && walk(c)) return true; 
          }
        }
    })(FS);
    
    if(found && parentNode){
        if(parentNode === currentFolder()) return; // Ya est√° aqu√≠
        parentNode.children = parentNode.children.filter(x=>x!==found);
        const folder = currentFolder();
        if(folder.children.find(x=>x.name===found.name)){
             found.name = "Copia_" + found.name;
        }
        folder.children.push(found);
        saveFS(); renderFS();
    }
}

/* Utils y Eventos Varios */
document.getElementById('searchInput').addEventListener('input', (e)=> renderFS(e.target.value));

document.getElementById('toggleViewBtn').addEventListener('click', ()=>{
  if(viewMode==='grid'){ 
      viewMode='list'; 
      gridArea.style.display='none'; 
      listArea.classList.remove('hidden'); 
      document.getElementById('toggleViewBtn').textContent='üîÅ Lista'; 
  } else { 
      viewMode='grid'; 
      gridArea.style.display='grid'; 
      listArea.classList.add('hidden'); 
      document.getElementById('toggleViewBtn').textContent='üîÅ Cuadr√≠cula'; 
  }
});

document.getElementById('backBtn').addEventListener('click', ()=>{
  if(cwd.length>1){ cwd.pop(); selectedName=null; renderFS(); }
});

document.getElementById('saveFSBtn').addEventListener('click', saveFS);
document.getElementById('loadFSBtn').addEventListener('click', ()=> {
    const txt = prompt('Pega el JSON de backup aqu√≠:');
    if(!txt) return;
    try { FS = JSON.parse(txt); cwd=['/']; saveFS(); renderFS(); } catch(e){ alert('JSON inv√°lido'); }
});

document.getElementById('exportFS').addEventListener('click', ()=> {
    const data = JSON.stringify(FS, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pekeos_backup.json';
    a.click();
});

</script>
</body>
</html>
