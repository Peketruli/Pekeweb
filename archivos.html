<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Archivos - PekeOS</title>
<style>
:root{--accent:#00ffd0;--bg:#04060a}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:var(--bg);color:#bfffee;padding:12px;height:100vh;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:#9ef7ea;cursor:pointer}
.layout{display:flex;gap:12px;margin-top:12px;height:calc(100% - 86px)}
.sidebar{width:220px;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;overflow:auto}
.main{flex:1;display:flex;flex-direction:column}
.view{flex:1;background:rgba(0,0,0,0.3);padding:12px;border-radius:10px;overflow:hidden;display:flex}
.grid{display:grid;grid-template-columns:repeat(auto-fill,120px);gap:12px;align-content:flex-start;overflow:auto;padding:6px}
.item{width:120px;text-align:center;padding:8px;border-radius:8px;cursor:pointer}
.item .icon{height:68px;display:flex;align-items:center;justify-content:center;font-size:32px;border-radius:8px}
.list{display:flex;flex-direction:column;gap:6px;overflow:auto;padding:6px}
.preview{width:320px;background:rgba(0,0,0,0.4);padding:10px;border-radius:8px}
.hidden{display:none}
.input{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:#bfffee}
.small{font-size:12px;color:#9ef7ea}
</style>
</head>
<body>
  <div class="header">
    <div><strong>üìÅ Archivos</strong></div>
    <div>
      <input id="searchInput" class="input" placeholder="Buscar...">
      <button class="btn" id="newFile">Nuevo</button>
      <button class="btn" id="newFolder">Carpeta</button>
      <button class="btn" id="uploadBtn">Subir</button>
      <input id="filePicker" type="file" class="hidden" multiple>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div><button class="btn" id="backBtn">‚¨ÖÔ∏è Atr√°s</button></div>
      <div style="margin-top:10px" id="pathBar">/</div>
      <div style="margin-top:10px"><button class="btn" id="saveBtn">Guardar FS</button> <button class="btn" id="exportBtn">Exportar</button></div>
      <div style="margin-top:12px" class="small">Arrastra archivos al √°rea principal para subirlos</div>
    </div>

    <div class="main">
      <div class="view">
        <div style="flex:1;display:flex;gap:12px">
          <div style="flex:1;min-width:300px;display:flex;flex-direction:column">
            <div id="gridArea" class="grid"></div>
            <div id="listArea" class="list hidden"></div>
          </div>
          <div class="preview" id="preview">
            <div id="previewTitle"><strong>Previsualizaci√≥n</strong></div>
            <div id="previewContent" style="margin-top:8px;color:#bfffee">Selecciona un archivo</div>
            <div id="editorWrap" class="hidden" style="margin-top:8px">
              <textarea id="textEditor" style="width:100%;height:220px;background:#000;border-radius:6px;border:1px solid rgba(255,255,255,0.02);color:#bfffee;padding:8px"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="saveEdit">Guardar</button><button class="btn" id="cancelEdit">Cancelar</button></div>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:8px" class="small">LocalStorage: <code>pekeos_fs_v1</code></div>
    </div>
  </div>

<script>
/* ---------- FS en localStorage ---------- */
const LS_KEY = 'pekeos_fs_v1';
function defaultFS(){ return {name:'root', type:'folder', children:[
  {name:'Documentos',type:'folder',children:[{name:'Bienvenida.txt',type:'file',mime:'text/plain',content:'Bienvenido a PekeOS. Edita este archivo.',size:0}]},
  {name:'Imagenes',type:'folder',children:[]}
]}; }

let FS = null;
function loadFS(){ try{ const raw=localStorage.getItem(LS_KEY); FS = raw ? JSON.parse(raw) : defaultFS(); }catch(e){ FS=defaultFS(); } }
function saveFS(){ localStorage.setItem(LS_KEY, JSON.stringify(FS)); showToast('FS guardado'); }
loadFS();

/* navigation stack */
let cwd = ['/'];
function getNodeByPath(pathArr){
  let node = FS;
  for(let i=1;i<pathArr.length;i++){
    const part = pathArr[i];
    node = (node.children||[]).find(x=>x.name===part && x.type==='folder');
    if(!node) return null;
  }
  return node;
}
function currentFolder(){ return getNodeByPath(cwd) || FS; }

/* render */
const gridArea = document.getElementById('gridArea'), listArea = document.getElementById('listArea'), pathBar = document.getElementById('pathBar');
const previewTitle = document.getElementById('previewTitle'), previewContent = document.getElementById('previewContent');
let selectedName=null, viewMode='grid';

function renderFS(filter=''){
  const folder = currentFolder();
  pathBar.textContent = cwd.join('/') || '/';
  const items = folder.children || [];
  const q = (filter||'').toLowerCase().trim();
  const shown = q ? items.filter(it=>it.name.toLowerCase().includes(q)) : items;

  gridArea.innerHTML = shown.map(it=>`<div class="item" data-name="${escapeHtml(it.name)}"><div class="icon">${it.type==='folder'?'üìÅ':(it.mime&&it.mime.startsWith('image/')?'üñºÔ∏è':'üìÑ')}</div><div style="margin-top:6px;font-weight:700">${escapeHtml(it.name)}</div></div>`).join('');
  listArea.innerHTML = shown.map(it=>`<div class="row" data-name="${escapeHtml(it.name)}"><div>${escapeHtml(it.name)}</div><div>${it.type}</div></div>`).join('');
  attachHandlers();
}
function attachHandlers(){
  document.querySelectorAll('#gridArea .item').forEach(el=>{
    const name = el.dataset.name;
    el.onclick = ()=> selectItem(name);
    el.ondblclick = ()=> openItem(name);
  });
  document.querySelectorAll('#listArea .row').forEach(el=>{
    const name = el.dataset.name;
    el.onclick = ()=> selectItem(name);
    el.ondblclick = ()=> openItem(name);
  });
}
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function selectItem(name){
  selectedName=name; const folder = currentFolder(); const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  previewTitle.textContent = it.name;
  if(it.type==='folder'){ previewContent.innerHTML = `<div style="font-weight:700">${it.name}</div><div class="small">Carpeta ‚Ä¢ ${it.children?it.children.length:0} elementos</div>`; toggleEditor(false);}
  else if(it.mime && it.mime.startsWith('image/')){ previewContent.innerHTML = `<img src="${it.content}" style="max-width:100%;border-radius:6px">`; toggleEditor(false); }
  else { previewContent.innerHTML = `<pre style="white-space:pre-wrap;color:#bfffee">${escapeHtml(it.content||'')}</pre>`; toggleEditor(false); }
}
function openItem(name){
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  if(it.type==='folder'){ cwd.push(it.name); renderFS(); }
  else {
    // abrir en ventana padre si existe
    try{ if(parent && parent.createWindow){ if(it.mime && it.mime.startsWith('text')){ const blob=new Blob([it.content||''],{type:it.mime||'text/plain'}); const url=URL.createObjectURL(blob); parent.createWindow(it.name, url); } else parent.createWindow(it.name, it.content); } else window.open(it.content || ''); }catch(e){ if(it.content) window.open(it.content); }
  }
}

/* create file/folder */
document.getElementById('newFile').addEventListener('click', ()=>{
  const name = prompt('Nombre archivo (ej: nota.txt)'); if(!name) return;
  const folder = currentFolder();
  if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name,type:'file',mime:'text/plain',content:'',size:0}); saveFS(); renderFS();
});
document.getElementById('newFolder').addEventListener('click', ()=>{
  const name = prompt('Nombre carpeta'); if(!name) return;
  const folder = currentFolder(); if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name,type:'folder',children:[]}); saveFS(); renderFS();
});

/* upload */
const filePicker = document.getElementById('filePicker');
document.getElementById('uploadBtn').addEventListener('click', ()=> filePicker.click());
filePicker.addEventListener('change', async e => { const files = Array.from(e.target.files||[]); await processUpload(files); e.target.value=''; });
async function processUpload(files){
  const folder = currentFolder();
  for(const f of files){
    const data = await readFileAsDataURL(f);
    let finalName = f.name, idx=1; while(folder.children.find(x=>x.name===finalName)){ finalName = `${f.name.replace(/(\.\w+)?$/,'')} (${idx})${(f.name.match(/\.\w+$/)||[''])[0]}`; idx++; }
    folder.children.push({name:finalName,type:'file',mime:f.type||'application/octet-stream',content:data,size:f.size});
  }
  saveFS(); renderFS();
}
function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* back button */
document.getElementById('backBtn').addEventListener('click', ()=>{ if(cwd.length>1){ cwd.pop(); renderFS(); } });

/* rename/delete/download/edit */
document.getElementById('saveEdit').addEventListener('click', ()=> {
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===selectedName); if(!it) return; it.content = document.getElementById('textEditor').value; it.size = it.content.length; saveFS(); renderFS(); document.getElementById('editorWrap').classList.add('hidden'); document.getElementById('previewContent').classList.remove('hidden');
});
document.getElementById('saveBtn').addEventListener('click', ()=> saveFS());
document.getElementById('exportBtn').addEventListener('click', ()=> { const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(FS,null,2)); a.download='pekeos-fs.json'; a.click(); });

/* search */
document.getElementById('searchInput').addEventListener('input', e=> renderFS(e.target.value));

/* drop to upload */
document.querySelector('.view').addEventListener('dragover', e=> e.preventDefault());
document.querySelector('.view').addEventListener('drop', async e=>{ e.preventDefault(); const files = Array.from(e.dataTransfer.files || []); if(files.length) await processUpload(files); });

/* tiny toast */
function showToast(s){ console.log('FS:',s); }

/* initial render */
renderFS();
</script>
</body>
</html>
