<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Archivos - PekeOS</title>
<style>
:root{--neon:#00ffd0;--muted:#9ef7ea}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:linear-gradient(180deg,#03040a,#07131a);color:var(--muted);padding:12px;height:100vh;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:center;gap:10px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(0,255,208,0.06);padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
.layout{display:flex;gap:12px;margin-top:12px;height:calc(100% - 86px)}
.sidebar{width:220px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:10px;border-radius:10px;border:1px solid rgba(0,255,208,0.04);overflow:auto}
.main{flex:1;display:flex;flex-direction:column;gap:10px}
.view{flex:1;background:#02040a;padding:12px;border-radius:10px;border:1px solid rgba(0,255,208,0.03);display:flex;flex-direction:column;overflow:hidden}
.grid{display:grid;grid-template-columns:repeat(auto-fill,120px);gap:12px;align-content:flex-start;overflow:auto;padding:6px}
.item{width:120px;text-align:center;padding:8px;border-radius:8px;border:1px solid transparent;cursor:pointer;user-select:none}
.item:hover{background:rgba(0,255,208,0.03);border-color:rgba(0,255,208,0.04)}
.icon{height:68px;display:flex;align-items:center;justify-content:center;font-size:34px;border-radius:10px}
.list{display:flex;flex-direction:column;gap:6px;overflow:auto;padding:6px}
.row{display:flex;justify-content:space-between;padding:8px;border-radius:6px;align-items:center}
.preview{width:360px;background:#010306;border-radius:8px;padding:10px;border:1px solid rgba(0,255,208,0.03);min-width:220px;max-width:40%}
.preview img{max-width:100%;border-radius:6px}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--muted)}
.hidden{display:none}
.dropzone{border:2px dashed rgba(0,255,208,0.04);padding:8px;border-radius:8px;text-align:center;color:var(--muted);margin-top:8px}
.backbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.small{font-size:12px;color:#9ef7ea}
.rename-input{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--muted)}
</style>
</head>
<body>
  <div class="header">
    <div>
      <div style="font-weight:800;font-size:18px">ğŸ“ Archivos</div>
      <div style="font-size:12px;color:#9ef7ea">NavegaciÃ³n real â€¢ Subida desde PC â€¢ Editar / Renombrar</div>
    </div>
    <div class="controls">
      <input id="searchInput" class="input" placeholder="Buscar..." />
      <button class="btn" id="newFile">ğŸ“„ Nuevo</button>
      <button class="btn" id="newFolder">ğŸ“ Carpeta</button>
      <button class="btn" id="uploadBtn">â¬†ï¸ Subir</button>
      <input id="filePicker" type="file" class="hidden" multiple />
      <button class="btn" id="toggleViewBtn">ğŸ” Vista</button>
      <button class="btn" id="exportFS">ğŸ’¾ Exportar</button>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="backbar">
        <button class="btn" id="backBtn">â¬…ï¸ AtrÃ¡s</button>
        <div id="pathBar" class="small">/</div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.02);margin:8px 0">
      <div style="font-weight:700;margin-bottom:8px">Acciones</div>
      <button class="btn" id="saveFSBtn">âœ” Guardar FS</button>
      <button class="btn" id="loadFSBtn">ğŸ“‚ Cargar FS</button>
      <div class="dropzone" id="dropzone">Arrastra aquÃ­ para subir</div>
    </div>

    <div class="main">
      <div class="view">
        <div style="display:flex;gap:12px;align-items:flex-start;height:100%">
          <div style="flex:1;min-width:320px;height:100%;display:flex;flex-direction:column;gap:8px">
            <div id="gridArea" class="grid"></div>
            <div id="listArea" class="list hidden"></div>
          </div>
          <div id="preview" class="preview">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700" id="previewTitle">PrevisualizaciÃ³n</div>
              <div style="display:flex;gap:6px">
                <button class="btn" id="editBtn">âœï¸ Editar</button>
                <button class="btn" id="renameBtn">ğŸ”¤ Renombrar</button>
                <button class="btn" id="downloadBtn">â¬‡ï¸ Descargar</button>
                <button class="btn" id="deleteBtn">ğŸ—‘ï¸ Eliminar</button>
              </div>
            </div>
            <div id="previewContent" style="margin-top:8px;color:#bfffee">Selecciona un archivo o carpeta.</div>
            <div id="editorWrap" class="hidden" style="margin-top:8px">
              <textarea id="textEditor" style="width:100%;height:200px;background:#000;border-radius:6px;border:1px solid rgba(255,255,255,0.02);color:var(--muted);padding:8px"></textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" id="saveEdit">ğŸ’¾ Guardar</button>
                <button class="btn" id="cancelEdit">âœ– Cancelar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="font-size:12px;color:#8fffe2;margin-top:6px">Nota: los archivos se guardan en LocalStorage (mismo navegador).</div>
    </div>
  </div>

<script>
/* ---------------- LocalStorage FS ---------------- */
const LS_KEY = 'pekeos_fs_v1';
function defaultFS(){ return {name:'root', type:'folder', children:[
  {name:'Documentos', type:'folder', children:[{name:'Bienvenida.txt', type:'file', mime:'text/plain', content:'Bienvenido a PekeOS. Edita este archivo.', size:0}]},
  {name:'Imagenes', type:'folder', children:[]}
]}; }
let FS = null;
function loadFS(){ try{ const raw=localStorage.getItem(LS_KEY); FS = raw ? JSON.parse(raw) : defaultFS(); }catch(e){ FS = defaultFS(); } }
function saveFS(){ localStorage.setItem(LS_KEY, JSON.stringify(FS)); showToast('FS guardado'); }
loadFS();

/* cwd stack for navigation */
let cwd = ['/']; // root = ['/']
function getNodeByPath(pathArr){
  let node = FS;
  for(let i=1;i<pathArr.length;i++){
    const part = pathArr[i];
    node = (node.children||[]).find(x=>x.name===part && x.type==='folder');
    if(!node) return null;
  }
  return node;
}
function currentFolder(){ return getNodeByPath(cwd) || FS; }

/* UI refs */
const gridArea = document.getElementById('gridArea'), listArea = document.getElementById('listArea'), pathBar = document.getElementById('pathBar');
const previewTitle = document.getElementById('previewTitle'), previewContent = document.getElementById('previewContent');
let selectedName = null; let viewMode = 'grid';

/* render */
function renderFS(filter=''){
  const folder = currentFolder(); pathBar.textContent = cwd.join('/') || '/';
  const items = folder.children || [];
  const q = (filter||'').toLowerCase().trim();
  const shown = q ? items.filter(it=>it.name.toLowerCase().includes(q)) : items;
  gridArea.innerHTML = shown.map(it=>{
    const icon = it.type==='folder' ? 'ğŸ“' : (it.mime && it.mime.startsWith('image/') ? 'ğŸ–¼ï¸' : it.mime && it.mime.startsWith('audio/') ? 'ğŸµ' : 'ğŸ“„');
    return `<div class="item" data-name="${escapeHtml(it.name)}"><div class="icon">${icon}</div><div style="margin-top:6px;font-weight:700">${escapeHtml(it.name)}</div><div class="small">${it.type==='folder'?'Carpeta':(it.mime||'archivo')}</div></div>`;
  }).join('');
  listArea.innerHTML = shown.map(it=>`<div class="row" data-name="${escapeHtml(it.name)}"><div style="display:flex;align-items:center;gap:10px"><div style="width:30px">${it.type==='folder'?'ğŸ“':(it.mime&&it.mime.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„')}</div><div>${escapeHtml(it.name)}</div></div><div class="small">${it.type==='folder'?'-':(it.size||'-')}</div></div>`).join('');
  attachHandlers();
}

/* attach handlers */
function attachHandlers(){
  document.querySelectorAll('#gridArea .item').forEach(el=>{
    const name = el.dataset.name;
    el.ondblclick = ()=> openItem(name);
    el.onclick = ()=> selectItem(name);
    el.draggable = true;
    el.ondragstart = e => e.dataTransfer.setData('text/name', name);
  });
  document.querySelectorAll('#listArea .row').forEach(el=>{
    const name = el.dataset.name;
    el.ondblclick = ()=> openItem(name);
    el.onclick = ()=> selectItem(name);
    el.draggable = true;
    el.ondragstart = e => e.dataTransfer.setData('text/name', name);
  });
}

/* helpers */
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* select & preview */
function selectItem(name){
  selectedName = name;
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  previewTitle.textContent = it.name;
  if(it.type==='folder'){
    previewContent.innerHTML = `<div style="font-weight:700">${it.name}</div><div class="small">Carpeta â€¢ ${it.children?it.children.length:0} elementos</div>`;
    toggleEditor(false);
  } else if(it.mime && it.mime.startsWith('image/')){
    previewContent.innerHTML = `<div style="font-weight:700">${it.name}</div><img src="${it.content}" alt="${it.name}" style="max-width:100%;border-radius:6px;margin-top:8px">`;
    toggleEditor(false);
  } else if(it.mime && it.mime.startsWith('audio/')){
    previewContent.innerHTML = `<div style="font-weight:700">${it.name}</div><audio controls src="${it.content}" style="width:100%;margin-top:8px"></audio>`;
    toggleEditor(false);
  } else {
    previewContent.innerHTML = `<div style="font-weight:700">${it.name}</div><pre style="white-space:pre-wrap;margin-top:8px;color:#bfffee">${escapeHtml(it.content||'')}</pre>`;
    toggleEditor(false);
  }
}

/* open item (dblclick) */
function openItem(name){
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===name);
  if(!it) return;
  if(it.type==='folder'){ cwd.push(it.name); renderFS(); }
  else {
    // open in parent window using parent.createWindow if available
    try{
      if(parent && parent.createWindow){
        if(it.mime && it.mime.startsWith('text')){
          const blob = new Blob([it.content||''], {type: it.mime||'text/plain'});
          const url = URL.createObjectURL(blob);
          parent.createWindow(it.name, url);
        } else {
          parent.createWindow(it.name, it.content);
        }
      } else {
        if(it.content && it.content.startsWith('data:')) window.open(it.content, '_blank');
        else {
          const blob = new Blob([it.content||''], {type: it.mime||'application/octet-stream'});
          const url = URL.createObjectURL(blob); window.open(url,'_blank');
        }
      }
    }catch(e){ if(it.content && it.content.startsWith('data:')) window.open(it.content,'_blank'); }
  }
}

/* create file/folder */
document.getElementById('newFile').addEventListener('click', ()=>{
  const name = prompt('Nombre archivo (ej: nota.txt)'); if(!name) return;
  const folder = currentFolder();
  if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name,type:'file', mime:'text/plain', content:'', size:0});
  saveFS(); renderFS();
});
document.getElementById('newFolder').addEventListener('click', ()=>{
  const name = prompt('Nombre carpeta'); if(!name) return;
  const folder = currentFolder();
  if(folder.children.find(x=>x.name===name)){ alert('Ya existe'); return; }
  folder.children.push({name,type:'folder', children:[]});
  saveFS(); renderFS();
});

/* upload from PC */
const filePicker = document.getElementById('filePicker');
document.getElementById('uploadBtn').addEventListener('click', ()=> filePicker.click());
filePicker.addEventListener('change', async (e)=>{ const files = Array.from(e.target.files || []); await processUpload(files); filePicker.value=''; });
async function processUpload(files){
  const folder = currentFolder();
  for(const f of files){
    const data = await readFileAsDataURL(f);
    let finalName = f.name; let idx=1;
    while(folder.children.find(x=>x.name===finalName)){ finalName = `${f.name.replace(/(\.\w+)?$/,'')} (${idx})${(f.name.match(/\.\w+$/)||[''])[0]}`; idx++; }
    folder.children.push({name:finalName,type:'file',mime:f.type||'application/octet-stream',content:data,size:f.size});
  }
  saveFS(); renderFS();
}
function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* dropzone */
const dropzone = document.getElementById('dropzone');
dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.opacity=.9; });
dropzone.addEventListener('dragleave', ()=> dropzone.style.opacity=1);
dropzone.addEventListener('drop', async (e)=>{ e.preventDefault(); dropzone.style.opacity=1; const files = Array.from(e.dataTransfer.files || []); if(files.length) await processUpload(files); else { const name = e.dataTransfer.getData('text/name'); if(name) moveItemToCurrent(name); } });

function moveItemToCurrent(name){
  let found=null, parentNode=null;
  (function walk(node){
    if(node.children){
      for(const c of node.children){ if(c.name===name){ found=c; parentNode=node; return true;} if(c.type==='folder' && walk(c)) return true; }
    }
  })(FS);
  if(found && parentNode){
    parentNode.children = parentNode.children.filter(x=>x!==found);
    const folder = currentFolder(); folder.children.push(found);
    saveFS(); renderFS();
    showToast(`Movido ${name}`);
  }
}

/* rename, delete, download */
document.getElementById('renameBtn').addEventListener('click', ()=>{
  if(!selectedName){ alert('Selecciona'); return; }
  const newName = prompt('Nuevo nombre', selectedName); if(!newName) return;
  const folder = currentFolder(); if(folder.children.find(x=>x.name===newName)){ alert('Ya existe'); return; }
  const it = folder.children.find(x=>x.name===selectedName); if(!it) return; it.name=newName; saveFS(); renderFS();
});
document.getElementById('deleteBtn').addEventListener('click', ()=>{
  if(!selectedName){ alert('Selecciona'); return; }
  if(!confirm('Eliminar "'+selectedName+'"?')) return;
  const folder = currentFolder(); folder.children = folder.children.filter(x=>x.name!==selectedName); selectedName=null; previewTitle.textContent='PrevisualizaciÃ³n'; previewContent.innerHTML='Selecciona un archivo o carpeta.'; saveFS(); renderFS();
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!selectedName){ alert('Selecciona'); return; }
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===selectedName); if(!it) return;
  if(it.type==='folder'){ alert('Descarga de carpetas no implementada'); return; }
  if(it.content && it.content.startsWith('data:')){ const a=document.createElement('a'); a.href=it.content; a.download = it.name; a.click(); }
  else { const blob = new Blob([it.content||''], {type: it.mime||'application/octet-stream'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=it.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000); }
});

/* edit text */
const editorWrap = document.getElementById('editorWrap'), textEditor = document.getElementById('textEditor');
document.getElementById('editBtn').addEventListener('click', ()=>{
  if(!selectedName){ alert('Selecciona'); return; }
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===selectedName); if(!it || it.type==='folder'){ alert('Solo archivos'); return; }
  if(!(it.mime && (it.mime.startsWith('text') || it.mime==='text/plain' || !it.mime))){ alert('Tipo no editable'); return; }
  editorWrap.classList.remove('hidden'); document.getElementById('previewContent').classList.add('hidden');
  textEditor.value = it.content || '';
});
document.getElementById('saveEdit').addEventListener('click', ()=> {
  const folder = currentFolder(); const it = folder.children.find(x=>x.name===selectedName); if(!it) return; it.content = textEditor.value; it.size = it.content.length; saveFS(); renderFS(); editorWrap.classList.add('hidden'); document.getElementById('previewContent').classList.remove('hidden'); showToast('Archivo guardado');
});
document.getElementById('cancelEdit').addEventListener('click', ()=> { editorWrap.classList.add('hidden'); document.getElementById('previewContent').classList.remove('hidden'); });

/* search */
document.getElementById('searchInput').addEventListener('input', (e)=> renderFS(e.target.value));

/* view toggle */
document.getElementById('toggleViewBtn').addEventListener('click', ()=>{
  if(viewMode==='grid'){ viewMode='list'; gridArea.style.display='none'; listArea.classList.remove('hidden'); document.getElementById('toggleViewBtn').textContent='ğŸ” Vista: Lista'; }
  else if(viewMode==='list'){ viewMode='mixed'; gridArea.style.display='grid'; listArea.classList.remove('hidden'); document.getElementById('toggleViewBtn').textContent='ğŸ” Vista: Mixto'; }
  else { viewMode='grid'; gridArea.style.display='grid'; listArea.classList.add('hidden'); document.getElementById('toggleViewBtn').textContent='ğŸ” Vista: CuadrÃ­cula'; }
});

/* breadcrumbs back button */
document.getElementById('backBtn').addEventListener('click', ()=>{
  if(cwd.length>1){ cwd.pop(); renderFS(); }
});

/* export / load FS */
document.getElementById('exportFS').addEventListener('click', ()=> { const data=JSON.stringify(FS,null,2); const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(data); a.download='pekeos-fs.json'; a.click(); });
document.getElementById('loadFSBtn').addEventListener('click', ()=> {
  const txt = prompt('Pega JSON del FS para cargar (sobrescribe)'); if(!txt) return;
  try{ FS = JSON.parse(txt); cwd=['/']; saveFS(); renderFS(); showToast('FS cargado'); }catch(e){ alert('JSON invÃ¡lido'); }
});

/* save */
document.getElementById('saveFSBtn').addEventListener('click', ()=> saveFS());

/* download/upload helpers */
function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
document.getElementById('filePicker').addEventListener('change', async (e)=>{ const files = Array.from(e.target.files||[]); await processUpload(files); e.target.value=''; });

/* move items (if dragged from our grid) */
function moveItemToCurrent(name){ let found=null, parentNode=null; (function walk(node){ if(node.children){ for(const c of node.children){ if(c.name===name){ found=c; parentNode=node; return true;} if(c.type==='folder' && walk(c)) return true; } } })(FS); if(found && parentNode){ parentNode.children = parentNode.children.filter(x=>x!==found); const folder = currentFolder(); folder.children.push(found); saveFS(); renderFS(); showToast(`Movido ${name}`); } }

/* dropzone handler already above - also allow moving from grid */

/* simple toast (console) */
function showToast(s){ console.log('FS:',s); }

/* initial render */
renderFS();
</script>
</body>
</html>
