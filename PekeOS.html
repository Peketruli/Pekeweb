<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PekeOS ‚Äî Modular (iframes)</title>
<style>
:root{
  --accent:#00ffd0;
  --bg-1:linear-gradient(180deg,#02060a,#06121a);
  --taskbar-bg: rgba(6,8,10,0.75);
  --win-opacity:1;
  --text: #cfeff0;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
html,body{height:100%;margin:0;background:var(--bg-1);color:var(--text);overflow:hidden}
#desktop{position:relative;width:100%;height:100%;padding:16px;background-size:cover;background-position:center;transition:background .3s}

/* icons */
.icons{position:absolute;inset:0}
.icon{width:90px;text-align:center;cursor:pointer;position:absolute;user-select:none}
.icon .thumb{width:72px;height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:34px;background:rgba(255,255,255,0.02);border:2px solid rgba(255,255,255,0.02);color:var(--accent)}
.icon span{display:block;margin-top:6px;font-size:12px;color:var(--accent)}

/* taskbar */
.taskbar{position:fixed;left:12px;right:12px;bottom:12px;height:56px;display:flex;align-items:center;gap:12px;padding:8px;border-radius:12px;background:var(--taskbar-bg);backdrop-filter:blur(6px);border:1px solid rgba(0,255,208,0.06);z-index:1200}
.start-btn{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,255,208,0.08);background:rgba(255,255,255,0.02)}
.task-apps{display:flex;gap:8px;align-items:center;flex:1;padding-left:8px}
.task-btn{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;color:var(--text)}
.clock{min-width:72px;text-align:right;color:var(--accent);font-weight:600}

/* start menu */
#startMenu{position:fixed;left:20px;bottom:80px;width:300px;background:rgba(4,6,8,0.95);border-radius:10px;padding:10px;display:none;z-index:1300;border:1px solid rgba(0,255,208,0.05)}
.start-item{display:flex;gap:10px;padding:8px;border-radius:8px;align-items:center;cursor:pointer}
.start-item:hover{background:rgba(255,255,255,0.02)}

/* windows */
.win{position:absolute;width:740px;height:480px;background:rgba(0,0,0,0.72);border:2px solid var(--accent);border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,0.6);display:flex;flex-direction:column;overflow:hidden;z-index:200;opacity:var(--win-opacity)}
.titlebar{height:44px;display:flex;align-items:center;padding:0 12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);user-select:none}
.titlebar .title{flex:1;font-weight:700}
.win .controls{display:flex;gap:8px}
.win .control-btn{width:30px;height:30px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,0.02)}
.content{flex:1; background:#000}
/* small */
.hidden{display:none}

</style>
</head>
<body>

<div id="desktop">
  <div class="icons">
    <div class="icon" data-app="archivos.html" style="top:10px;left:10px"><div class="thumb">üìÅ</div><span>Archivos</span></div>
    <div class="icon" data-app="ajustes.html" style="top:110px;left:10px"><div class="thumb">‚öôÔ∏è</div><span>Ajustes</span></div>
    <div class="icon" data-app="estado.html" style="top:210px;left:10px"><div class="thumb">üìä</div><span>Estado OS</span></div>
  </div>
</div>

<div class="taskbar" id="taskbar">
  <div class="start-btn" id="startBtn">‚ò∞</div>
  <div class="task-apps" id="taskApps"></div>
  <div class="clock" id="clock">00:00</div>
</div>

<div id="startMenu" role="dialog" aria-label="Inicio">
  <div style="font-weight:700;margin-bottom:6px">Apps</div>
  <div class="start-item" data-file="archivos.html"><div style="font-size:20px">üìÅ</div><div><strong>Archivos</strong><div style="font-size:12px;color:#9ef7ea">Explorador</div></div></div>
  <div class="start-item" data-file="ajustes.html"><div style="font-size:20px">‚öôÔ∏è</div><div><strong>Ajustes</strong><div style="font-size:12px;color:#9ef7ea">Tema y fondo</div></div></div>
  <div class="start-item" data-file="estado.html"><div style="font-size:20px">üìä</div><div><strong>Estado OS</strong><div style="font-size:12px;color:#9ef7ea">Monitor</div></div></div>
</div>

<!-- window template -->
<template id="winTpl">
  <div class="win" data-winid="">
    <div class="titlebar">
      <div class="title">Ventana</div>
      <div class="controls">
        <div class="control-btn" data-action="min">‚àí</div>
        <div class="control-btn" data-action="max">‚ñ¢</div>
        <div class="control-btn" data-action="close">‚úï</div>
      </div>
    </div>
    <div class="content"></div>
  </div>
</template>

<script>
/* ---------- reloj ---------- */
function updateClock(){ const n=new Date(); document.getElementById('clock').textContent = String(n.getHours()).padStart(2,'0')+':'+String(n.getMinutes()).padStart(2,'0'); }
setInterval(updateClock,1000); updateClock();

/* ---------- ventanas / tareas ---------- */
const winTpl = document.getElementById('winTpl');
const taskAppsEl = document.getElementById('taskApps');
let z=300, idc=0;
const windows = new Map(); // id -> {el,taskBtn,iframe}

function createWindow(title, src){
  const node = winTpl.content.firstElementChild.cloneNode(true);
  const id = 'win_' + (++idc);
  node.dataset.winid = id;
  node.querySelector('.title').textContent = title;

  // iframe content
  const iframe = document.createElement('iframe');
  iframe.src = src;
  iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0';
  node.querySelector('.content').appendChild(iframe);

  // position
  node.style.left = (120 + Math.random()*200) + 'px';
  node.style.top = (80 + Math.random()*120) + 'px';
  node.style.zIndex = ++z;
  node.style.opacity = getComputedStyle(document.documentElement).getPropertyValue('--win-opacity') || 1;

  document.body.appendChild(node);
  makeDraggable(node);
  makeResizable(node);
  attachWinControls(node);

  // task button
  const tbtn = document.createElement('div');
  tbtn.className='task-btn';
  tbtn.textContent = title;
  taskAppsEl.appendChild(tbtn);
  tbtn.addEventListener('click', ()=> {
    const info = windows.get(id);
    if(!info) return;
    if(info.minimized){ restoreWindow(id); } else { minimizeWindow(id); }
  });

  windows.set(id, { el: node, taskBtn: tbtn, iframe, minimized:false, maxed:false });
  focus(node);
  return id;
}

function focus(el){
  z++; el.style.zIndex=z;
  // highlight active
  windows.forEach(v=> v.taskBtn.classList.toggle('active', v.el === el));
}

function minimizeWindow(id){
  const info = windows.get(id);
  if(!info) return;
  info.el.style.display='none'; info.minimized=true; info.taskBtn.classList.remove('active');
}
function restoreWindow(id){
  const info = windows.get(id);
  if(!info) return;
  info.el.style.display='flex'; info.minimized=false; focus(info.el);
}
function toggleMax(id){
  const info = windows.get(id);
  if(!info) return;
  const win = info.el;
  if(info.maxed){
    info.maxed=false;
    if(win._prev){ Object.assign(win.style, win._prev); }
  } else {
    win._prev = { left:win.style.left, top:win.style.top, width:win.style.width, height:win.style.height };
    win.style.left='8px'; win.style.top='8px';
    win.style.width=(window.innerWidth-16)+'px'; win.style.height=(window.innerHeight-110)+'px';
    info.maxed=true;
  }
  focus(win);
}
function closeWindow(id){
  const info = windows.get(id); if(!info) return;
  info.el.remove(); info.taskBtn.remove(); windows.delete(id);
}

/* attach controls for each newly created window */
function attachWinControls(winEl){
  const id = winEl.dataset.winid;
  winEl.querySelectorAll('.control-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const action = btn.dataset.action;
      if(action==='min') minimizeWindow(id);
      if(action==='max') toggleMax(id);
      if(action==='close') closeWindow(id);
    });
  });
  winEl.addEventListener('mousedown', ()=> focus(winEl));
  winEl.querySelector('.titlebar').addEventListener('dblclick', ()=> toggleMax(id));
}

/* drag */
function makeDraggable(winEl){
  const bar = winEl.querySelector('.titlebar');
  let drag=false, ox=0, oy=0, sx=0, sy=0;
  bar.addEventListener('mousedown',(e)=>{
    if(e.button!==0) return;
    drag=true; ox=e.clientX; oy=e.clientY;
    const r=winEl.getBoundingClientRect(); sx=r.left; sy=r.top;
    document.addEventListener('mousemove', onmove); document.addEventListener('mouseup', onup);
  });
  function onmove(e){ if(!drag) return; winEl.style.left = (sx + e.clientX - ox) + 'px'; winEl.style.top = (sy + e.clientY - oy) + 'px'; }
  function onup(){ drag=false; document.removeEventListener('mousemove', onmove); document.removeEventListener('mouseup', onup); }
}

/* resize bottom-right simple */
function makeResizable(winEl){
  const grip = document.createElement('div'); grip.style.position='absolute'; grip.style.right='6px'; grip.style.bottom='6px'; grip.style.width='12px'; grip.style.height='12px'; grip.style.cursor='se-resize';
  winEl.appendChild(grip);
  let resizing=false, sx=0, sy=0, sw=0, sh=0;
  grip.addEventListener('mousedown', (e)=>{
    if(e.button!==0) return;
    resizing=true; sx=e.clientX; sy=e.clientY; sw=winEl.offsetWidth; sh=winEl.offsetHeight;
    document.addEventListener('mousemove', onmove); document.addEventListener('mouseup', onup);
  });
  function onmove(e){ if(!resizing) return; winEl.style.width = Math.max(320, sw + (e.clientX - sx)) + 'px'; winEl.style.height = Math.max(200, sh + (e.clientY - sy)) + 'px'; }
  function onup(){ resizing=false; document.removeEventListener('mousemove', onmove); document.removeEventListener('mouseup', onup); }
}

/* open apps by double click on desktop icons */
document.querySelectorAll('.icon').forEach(ic=>{
  ic.addEventListener('dblclick', ()=> {
    const app = ic.dataset.app;
    const title = ic.querySelector('span').textContent;
    createWindow(title, app);
  });
});

/* start menu wiring */
const startBtn = document.getElementById('startBtn'), startMenu = document.getElementById('startMenu');
startBtn.addEventListener('click', ()=> startMenu.style.display = startMenu.style.display === 'flex' ? 'none' : 'flex');
startMenu.querySelectorAll('.start-item').forEach(el=>{
  el.addEventListener('click', ()=> {
    const file = el.dataset.file;
    createWindow(el.querySelector('strong').textContent, file);
    startMenu.style.display='none';
  });
});
document.addEventListener('click',(e)=>{ if(!startMenu.contains(e.target) && e.target!==startBtn) startMenu.style.display='none'; });

/* ---------- SETTINGS (load & watch) ---------- */
const SETTINGS_KEY = 'pekeos_settings';
function defaultSettings(){ return { accent:'#00ffd0', wallpaper:null, opacity:1 }; }

function loadSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(!raw) return defaultSettings();
    const s = JSON.parse(raw);
    return Object.assign(defaultSettings(), s);
  }catch(e){ return defaultSettings(); }
}

function aplicarAjustes(){
  const s = loadSettings();
  // wallpaper
  const desk = document.getElementById('desktop');
  if(s.wallpaper){ desk.style.backgroundImage = `url(${s.wallpaper})`; desk.style.backgroundSize='cover'; desk.style.backgroundPosition='center'; }
  else { desk.style.backgroundImage=''; desk.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-1'); }

  // accent
  if(s.accent){
    document.documentElement.style.setProperty('--accent', s.accent);
    // update some element colors directly that use accent variable
    document.querySelectorAll('.icon span').forEach(el=> el.style.color = s.accent);
    document.querySelectorAll('.thumb').forEach(el=> el.style.color = s.accent);
    document.querySelectorAll('.task-btn').forEach(el=> el.style.borderColor = 'transparent');
  }

  // opacity windows
  if(s.opacity !== undefined){
    document.documentElement.style.setProperty('--win-opacity', s.opacity);
    document.querySelectorAll('.win').forEach(w=> w.style.opacity = s.opacity);
  }
}

// load at start
window.addEventListener('load', ()=> aplicarAjustes());

// listen storage changes (from ajustes.html)
window.addEventListener('storage', (e)=>{
  if(e.key === 'pekeos_update'){
    aplicarAjustes();
  }
});
</script>
</body>
</html>
