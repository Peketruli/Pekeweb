<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PekeSocial</title>
<style>
  body { font-family: Arial; background:#f2f2f2; margin:0; padding:0; }
  header { background:#ff4da6; color:white; padding:15px; font-size:24px; font-weight:bold; text-align:center; }
  .card { background:white; padding:15px; margin:15px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
  input, textarea { width:100%; padding:10px; margin-top:8px; border:1px solid #ccc; border-radius:8px; }
  button { margin-top:10px; padding:10px 15px; background:#ff4da6; color:white; border:none; border-radius:10px; font-size:16px; cursor:pointer; }
  .post { border-bottom:1px solid #ddd; padding-bottom:12px; margin-bottom:12px; }
  .hidden { display:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>PekeSocial</header>

<!-- LOGIN / REGISTER -->
<div id="auth" class="card">
  <h2>Entrar a PekeSocial</h2>
  <input id="email" placeholder="Email" />
  <input id="pass" type="password" placeholder="Contraseña" />
  <button onclick="register()">Registrarme</button>
  <button onclick="login()">Entrar</button>
  <p id="authMsg"></p>
</div>

<!-- COMPLETE PROFILE -->
<div id="profileSetup" class="card hidden">
  <h2>Completa tu Perfil</h2>
  <input id="username" placeholder="Nombre de usuario" />
  <textarea id="bio" placeholder="Biografía"></textarea>
  <button onclick="saveProfile()">Guardar Perfil</button>
  <p id="profileMsg"></p>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
  <div class="card">
    <h2>Crear Post</h2>
    <textarea id="postContent" placeholder="¿Qué quieres contar?"></textarea>
    <button onclick="publishPost()">Publicar</button>
    <p id="postMsg"></p>
  </div>
  <div class="card">
    <h2>Últimos posts</h2>
    <div id="posts"></div>
  </div>
</div>

<script>
const supabase = window.supabase.createClient("https://jdvwlfogkzrzovepzjqa.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI");

async function register() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;
  let { error } = await supabase.auth.signUp({ email, password: pass });
  document.getElementById("authMsg").innerText = error ? error.message : "Revisa tu email para verificar la cuenta";
}

async function login() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("pass").value;
  let { error } = await supabase.auth.signInWithPassword({ email, password: pass });
  document.getElementById("authMsg").innerText = error ? error.message : "Entrando...";
  checkUser();
}

async function checkUser() {
  const { data } = await supabase.auth.getSession();
  if (!data.session) return;
  loadProfile();
}

async function loadProfile() {
  const { data: userData } = await supabase.auth.getUser();
  const id = userData.user.id;

  const { data: profile } = await supabase
    .from("profiles")
    .select("username, bio")
    .eq("id", id)
    .single();

  if (!profile.username) {
    document.getElementById("auth").classList.add("hidden");
    document.getElementById("profileSetup").classList.remove("hidden");
  } else {
    startFeed();
  }
}

async function saveProfile() {
  const { data: userData } = await supabase.auth.getUser();
  const id = userData.user.id;

  const username = document.getElementById("username").value;
  const bio = document.getElementById("bio").value;

  const { error } = await supabase
    .from("profiles")
    .update({ username, bio })
    .eq("id", id);

  document.getElementById("profileMsg").innerText = error ? error.message : "Perfil guardado";
  if (!error) startFeed();
}

function startFeed() {
  document.getElementById("auth").classList.add("hidden");
  document.getElementById("profileSetup").classList.add("hidden");
  document.getElementById("feed").classList.remove("hidden");
  loadPosts();
}

async function publishPost() {
  const { data: userData } = await supabase.auth.getUser();
  const author = userData.user.id;
  const content = document.getElementById("postContent").value;

  let { error } = await supabase
    .from("postsApp")
    .insert({ content, author });

  document.getElementById("postMsg").innerText = error ? error.message : "Publicado";
  loadPosts();
}

async function loadPosts() {
  const { data: posts } = await supabase
    .from("postsApp")
    .select("*")
    .order("created_at", { ascending: false });

  let html = "";
  posts.forEach(p => {
    html += `<div class='post'><strong>${p.content}</strong><br><small>${p.created_at}</small></div>`;
  });

  document.getElementById("posts").innerHTML = html;
}

checkUser();
</script>
</body>
</html>
