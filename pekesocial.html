<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PekeSocial ‚Äî PekeOS</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style>
    :root{--primary:#4A78FF;--bg:#f6f8ff;--card:#fff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#eef2ff);color:#111}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:var(--primary);color:#fff;display:grid;place-items:center;font-weight:700}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(20,25,40,0.06);margin-top:16px}
    .grid{display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
    .sidebar, .right{overflow:auto}
    .hidden{display:none}
    .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--primary)}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-bottom:8px}
    .post-card{padding:12px;border-radius:12px;background:#fff;margin-bottom:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(90deg,#c7d2fe,#4A78FF);display:inline-block}
    .muted{color:var(--muted);font-size:13px}
    .fab{position:fixed;right:28px;bottom:28px;width:62px;height:62px;border-radius:50%;background:var(--primary);display:grid;place-items:center;color:#fff;font-size:28px;box-shadow:0 12px 30px rgba(74,120,255,0.28);cursor:pointer}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.right{display:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PS</div>
      <h1>PekeSocial</h1>
    </header>

    <div id="appRoot">
      <!-- Auth / Profile / App views controlled via JS -->
      <div id="viewAuth" class="card">
        <h2>Accede o reg√≠strate</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="email" placeholder="Email" />
          <input id="password" type="password" placeholder="Contrase√±a (min. 6)" />
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnLogin">Entrar</button>
          <button class="btn ghost" id="btnSign">Registrarme</button>
        </div>
        <p class="muted">Se enviar√° un correo de verificaci√≥n. Comprueba la URL de redirecci√≥n en tu proyecto Supabase.</p>
      </div>

      <div id="viewProfile" class="card hidden">
        <h2>Completa tu perfil</h2>
        <p class="muted">Antes de entrar a PekeSocial necesitamos algunos datos p√∫blicos (username √∫nico).</p>
        <input id="username" placeholder="Nombre de usuario (sin espacios)" />
        <input id="display_name" placeholder="Nombre para mostrar" />
        <textarea id="bio" placeholder="Biograf√≠a corta"></textarea>
        <label>Avatar (opcional)</label>
        <input type="file" id="avatarFile" accept="image/*" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnSaveProfile">Guardar y entrar</button>
        </div>
      </div>

      <div id="viewApp" class="hidden">
        <div class="grid">
          <div class="sidebar">
            <div class="card">
              <div style="display:flex;gap:12px;align-items:center">
                <div id="leftAvatar" class="avatar"></div>
                <div>
                  <div id="leftName" style="font-weight:700">Usuario</div>
                  <div id="leftHandle" class="muted">@handle</div>
                </div>
              </div>
              <div style="margin-top:12px">
                <button class="btn ghost" id="btnLogout">Cerrar sesi√≥n</button>
              </div>
            </div>

            <div class="card">
              <h4 class="muted">Sugerencias</h4>
              <div id="suggestions"></div>
            </div>
          </div>

          <main>
            <div class="card">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="avatar"></div>
                <textarea id="newText" placeholder="¬øQu√© est√° pasando?"></textarea>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <input type="file" id="newImage" accept="image/*" />
                <button class="btn ghost" id="btnPreview">Vista previa</button>
                <button class="btn" id="btnPost">Publicar</button>
              </div>
            </div>

            <div id="feed"></div>
          </main>

          <div class="right">
            <div class="card">
              <h4 class="muted">Notificaciones</h4>
              <div id="notifications"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4 class="muted">Tus estad√≠sticas</h4>
              <div>Posts: <span id="statPosts">0</span></div>
              <div>Seguidores: <span id="statFollowers">0</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="fab" id="openComposer">+</div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // === CONFIGURATION: replace with your project values ===
  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'
  const AVATAR_BUCKET = 'avatars'
  const POSTS_BUCKET = 'posts'
  // ========================================================

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true }
  })

  // Elements
  const viewAuth = document.getElementById('viewAuth')
  const viewProfile = document.getElementById('viewProfile')
  const viewApp = document.getElementById('viewApp')
  const btnLogin = document.getElementById('btnLogin')
  const btnSign = document.getElementById('btnSign')
  const btnSaveProfile = document.getElementById('btnSaveProfile')
  const btnLogout = document.getElementById('btnLogout')
  const btnPost = document.getElementById('btnPost')
  const feedEl = document.getElementById('feed')
  const suggestionsEl = document.getElementById('suggestions')
  const notificationsEl = document.getElementById('notifications')

  // State
  let me = null
  let session = null

  // Helpers
  function show(v){ viewAuth.classList.add('hidden'); viewProfile.classList.add('hidden'); viewApp.classList.add('hidden'); v.classList.remove('hidden') }
  function toast(msg){ alert(msg) }

  // Auth actions
  btnLogin.onclick = async ()=>{
    const email = document.getElementById('email').value.trim()
    const password = document.getElementById('password').value
    if(!email || !password) return toast('Email y contrase√±a son necesarios')
    const { error } = await supabase.auth.signInWithPassword({ email, password })
    if(error) return toast(error.message)
    // session will be available via onAuthStateChange
  }

  btnSign.onclick = async ()=>{
    const email = document.getElementById('email').value.trim()
    const password = document.getElementById('password').value
    if(!email || !password) return toast('Email y contrase√±a son necesarios')
    const { data, error } = await supabase.auth.signUp({ email, password })
    if(error) return toast(error.message)
    toast('Correo de verificaci√≥n enviado. Revisa tu bandeja (y spam).')
  }

  btnLogout.onclick = async ()=>{
    await supabase.auth.signOut(); location.reload();
  }

  // After sign-in, check profile completeness
  async function ensureProfile(uid){
    const { data, error } = await supabase.from('profiles').select('*').eq('id', uid).single()
    if(error && error.code === 'PGRST116') return null // not found
    return data
  }

  // Profile save
  btnSaveProfile.onclick = async ()=>{
    const username = document.getElementById('username').value.trim()
    const display_name = document.getElementById('display_name').value.trim()
    const bio = document.getElementById('bio').value.trim()
    const avatarFile = document.getElementById('avatarFile').files[0]
    if(!username) return toast('El username es obligatorio')
    // validate username: no spaces
    if(/\s/.test(username)) return toast('El username no puede contener espacios')

    // check username uniqueness
    const { data: existing } = await supabase.from('profiles').select('id').eq('username', username).limit(1)
    if(existing && existing.length>0) return toast('Ese username ya est√° en uso')

    let avatar_path = null
    if(avatarFile){
      const path = `avatars/${session.user.id}/${Date.now()}_${avatarFile.name}`
      const { error: upErr } = await supabase.storage.from(AVATAR_BUCKET).upload(path, avatarFile, { upsert: false })
      if(upErr){ console.error(upErr); return toast('Error subiendo avatar') }
      const { data: pub } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(path)
      avatar_path = pub.publicUrl
    }

    // insert profile
    const { error } = await supabase.from('profiles').insert([{ id: session.user.id, username, display_name, bio, avatar_path }])
    if(error) return toast('Error guardando perfil: '+error.message)

    // now enter app
    await enterApp()
  }

  // Create post
  btnPost.onclick = async ()=>{
    const text = document.getElementById('newText').value.trim()
    const file = document.getElementById('newImage').files[0]
    let image_path = null
    if(file){
      const path = `posts/${session.user.id}/${Date.now()}_${file.name}`
      const { error: upErr } = await supabase.storage.from(POSTS_BUCKET).upload(path, file)
      if(upErr){ console.error(upErr); return toast('Error subiendo imagen') }
      const { data: pub } = supabase.storage.from(POSTS_BUCKET).getPublicUrl(path)
      image_path = pub.publicUrl
    }
    const payload = { author: session.user.id, content: text, image_path }
    const { error } = await supabase.from('postsApp').insert([payload])
    if(error) return toast('Error publicando: '+error.message)
    document.getElementById('newText').value = ''
    document.getElementById('newImage').value = ''
  }

  // Load feed
  async function loadFeed(){
    const { data: posts, error } = await supabase
      .from('postsApp')
      .select('id,content,image_path,created_at,author, profiles:author(username,display_name,avatar_path)')
      .order('created_at', { ascending: false })
      .limit(50)
    if(error) return console.error(error)
    feedEl.innerHTML = ''
    posts.forEach(p => {
      const el = document.createElement('div'); el.className='post-card'
      el.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:44px;height:44px;border-radius:50%;background-image:url('${p.profiles?.avatar_path || ''}');background-size:cover"></div>
          <div>
            <div style="font-weight:700">${p.profiles?.display_name || p.profiles?.username || 'Usuario'}</div>
            <div class="muted">@${p.profiles?.username || ''} ¬∑ ${new Date(p.created_at).toLocaleString()}</div>
          </div>
        </div>
        <div style="margin-top:10px">${escapeHtml(p.content || '')}</div>
        ${p.image_path?`<img src="${p.image_path}" style="width:100%;max-height:420px;object-fit:cover;border-radius:8px;margin-top:8px"/>`:''}
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button class="btn ghost" data-id="${p.id}" onclick="window.react('${p.id}','like')">üëç</button>
          <button class="btn ghost" data-id="${p.id}" onclick="window.react('${p.id}','laugh')">üòÇ</button>
          <button class="btn ghost" data-id="${p.id}" onclick="window.openProfile('${p.author}')">Ver perfil</button>
        </div>
        <div id="comments_${p.id}" style="margin-top:10px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="cinput_${p.id}" placeholder="Escribe un comentario..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)" />
          <button class="btn" onclick="window.addComment('${p.id}')">Comentar</button>
        </div>
      `
      feedEl.appendChild(el)
      // load comments
      loadComments(p.id)
    })
  }

  // Comments
  window.addComment = async (postId)=>{
    const input = document.getElementById('cinput_'+postId)
    const txt = input.value.trim()
    if(!txt) return
    const { error } = await supabase.from('comments').insert([{ post_id: postId, author: session.user.id, content: txt }])
    if(error) return toast('Error al comentar: '+error.message)
    input.value = ''
  }

  async function loadComments(postId){
    const { data } = await supabase.from('comments').select('id,content,created_at,author, profiles:author(username,display_name)').eq('post_id', postId).order('created_at',{ascending:true})
    const container = document.getElementById('comments_'+postId)
    container.innerHTML = ''
    data.forEach(c => {
      const d = document.createElement('div'); d.className='post-card'; d.style.padding='8px'
      d.innerHTML = `<div style="font-weight:700">${c.profiles?.display_name || c.profiles?.username || 'Usuario'} <span class='muted' style='font-size:12px'>¬∑ ${new Date(c.created_at).toLocaleString()}</span></div><div>${escapeHtml(c.content)}</div>`
      container.appendChild(d)
    })
  }

  // Realtime: reactions/comments/posts
  function subscribeRealtime(){
    // posts
    supabase.channel('posts')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'postsApp' }, payload => { loadFeed() })
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'postsApp' }, payload => { loadFeed() })
      .subscribe();

    // comments
    supabase.channel('comments')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, payload => { loadFeed() })
      .subscribe();

    // notifications
    supabase.channel('notifications-'+(session?.user?.id || 'anon'))
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${session?.user?.id}` }, payload => { renderNotifications() })
      .subscribe();
  }

  // React function (simple insert to reactions table)
  window.react = async (postId, type)=>{
    const { error } = await supabase.from('reactions').insert([{ post_id: postId, author: session.user.id, reaction_type: type }])
    if(error){
      // if unique constraint fails, try delete (toggle)
      if(error.message && error.message.includes('duplicate key')){
        // delete existing reaction
        await supabase.from('reactions').delete().match({ post_id: postId, author: session.user.id, reaction_type: type })
      } else console.error(error)
    }
  }

  // Notifications
  async function renderNotifications(){
    if(!session) return
    const { data } = await supabase.from('notifications').select('id,type,actor_id,post_id,created_at,read, actor:actor_id(id)')
      .eq('user_id', session.user.id).order('created_at',{ascending:false}).limit(20)
    notificationsEl.innerHTML = ''
    data.forEach(n=>{
      const d = document.createElement('div'); d.className='post-card'; d.style.padding='8px';
      d.innerHTML = `<div class='muted' style='font-size:13px'>${n.type}</div><div class='muted' style='font-size:12px'>${new Date(n.created_at).toLocaleString()}</div>`
      notificationsEl.appendChild(d)
    })
  }

  // Suggestions (simple: list recent users excluding current)
  async function renderSuggestions(){
    const { data } = await supabase.from('profiles').select('id,username,display_name,avatar_path').limit(10)
    suggestionsEl.innerHTML = ''
    data.filter(u=>u.id!==session.user.id).forEach(u=>{
      const el = document.createElement('div'); el.className='post-card'; el.style.display='flex'; el.style.alignItems='center'
      el.innerHTML = `<div style="width:44px;height:44px;border-radius:50%;background-image:url('${u.avatar_path||''}');background-size:cover"></div><div style='margin-left:8px'><strong>${u.display_name||u.username}</strong><div class='muted'>@${u.username}</div></div>`
      const btn = document.createElement('button'); btn.className='btn ghost'; btn.style.marginLeft='auto'; btn.textContent='Seguir'; btn.onclick = async ()=>{ await supabase.from('followers').insert([{ user_id: u.id, follower_id: session.user.id }]); toast('Sigues a '+(u.display_name||u.username)); }
      el.appendChild(btn); suggestionsEl.appendChild(el)
    })
  }

  // Enter app (after session + profile ok)
  async function enterApp(){
    // set me/session
    session = (await supabase.auth.getSession()).data.session
    if(!session){ show(viewAuth); return }
    me = session.user
    const profile = await ensureProfile(me.id)
    if(!profile){ show(viewProfile); return }

    // render left
    document.getElementById('leftName').textContent = profile.display_name || profile.username
    document.getElementById('leftHandle').textContent = '@'+profile.username
    document.getElementById('leftAvatar').style.backgroundImage = profile.avatar_path ? `url(${profile.avatar_path})` : ''

    show(viewApp)
    await loadFeed()
    renderSuggestions()
    renderNotifications()
    subscribeRealtime()
  }

  // Utility: escape
  function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

  // Handle redirects after email verify: Supabase persists session - just call enterApp
  // When the page loads, check if a session exists
  window.addEventListener('load', async ()=>{
    const s = await supabase.auth.getSession()
    if(s.data.session){ session = s.data.session; await enterApp(); }
    else show(viewAuth)
  })

  // Listen auth state changes (login/logout)
  supabase.auth.onAuthStateChange((event, s)=>{
    if(s?.session) { session = s.session; enterApp(); }
    if(event === 'SIGNED_OUT') { session = null; show(viewAuth) }
  })

  // Expose small helpers to window for UI buttons
  window.openProfile = async (userId) => {
    // load profile by userId and show minimal modal
    const { data } = await supabase.from('profiles').select('id,username,display_name,avatar_path,bio').eq('id', userId).single()
    if(!data) return toast('Perfil no encontrado')
    alert(`${data.display_name || data.username}\n@${data.username}\n\n${data.bio || ''}`)
  }

  // Expose react/addComment already set above

</script>
</body>
</html>
