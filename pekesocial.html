<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PekeSocial — PekeOS</title>

  <!-- supabase client (ESM) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

  <style>
    :root{
      --primary:#4A78FF; --bg:#f6f8ff; --card:#fff; --muted:#6b7280;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#eef2ff);color:#111}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:var(--primary);color:#fff;display:grid;place-items:center;font-weight:700}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 20px rgba(20,25,40,0.06);margin-top:16px}
    .grid{display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
    .sidebar, .right{overflow:auto}
    .hidden{display:none}
    .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--primary)}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-bottom:8px}
    .post-card{padding:12px;border-radius:12px;background:#fff;margin-bottom:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(90deg,#c7d2fe,#4A78FF);display:inline-block;background-size:cover;background-position:center}
    .muted{color:var(--muted);font-size:13px}
    .fab{position:fixed;right:28px;bottom:28px;width:62px;height:62px;border-radius:50%;background:var(--primary);display:grid;place-items:center;color:#fff;font-size:28px;box-shadow:0 12px 30px rgba(74,120,255,0.28);cursor:pointer}
    .row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.right{display:none}}
    /* small utilities */
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PS</div>
      <h1>PekeSocial</h1>
    </header>

    <div id="appRoot">
      <!-- AUTH VIEW -->
      <div id="viewAuth" class="card">
        <h2>Accede o regístrate</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="email" placeholder="Email" autocomplete="username"/>
          <input id="password" type="password" placeholder="Contraseña (min. 6)" autocomplete="current-password"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnLogin">Entrar</button>
          <button class="btn ghost" id="btnSign">Registrarme</button>
        </div>
        <p class="muted">Se enviará un correo de verificación. Revisa spam si no llega.</p>
        <div id="authLogs" class="small muted"></div>
      </div>

      <!-- PROFILE SETUP -->
      <div id="viewProfile" class="card hidden">
        <h2>Completa tu perfil</h2>
        <p class="muted">Este paso es obligatorio para entrar a PekeSocial</p>
        <input id="username" placeholder="Nombre de usuario (sin espacios)" />
        <input id="display_name" placeholder="Nombre para mostrar" />
        <textarea id="bio" placeholder="Biografía corta"></textarea>
        <label class="small">Avatar (opcional)</label>
        <input type="file" id="avatarFile" accept="image/*" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="btnSaveProfile">Guardar y entrar</button>
          <button class="btn ghost" id="btnSkipProfile">Omitir (completar luego)</button>
        </div>
        <div id="profileLogs" class="small muted"></div>
      </div>

      <!-- APP VIEW -->
      <div id="viewApp" class="hidden">
        <div class="grid">
          <div class="sidebar">
            <div class="card">
              <div style="display:flex;gap:12px;align-items:center">
                <div id="leftAvatar" class="avatar"></div>
                <div>
                  <div id="leftName" style="font-weight:700">Usuario</div>
                  <div id="leftHandle" class="muted">@handle</div>
                </div>
              </div>
              <div style="margin-top:12px">
                <button class="btn ghost" id="btnLogout">Cerrar sesión</button>
              </div>
            </div>

            <div class="card">
              <h4 class="muted">Sugerencias</h4>
              <div id="suggestions"></div>
            </div>
          </div>

          <main>
            <div class="card">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="avatar" id="composerAvatar"></div>
                <textarea id="newText" placeholder="¿Qué está pasando?"></textarea>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <input type="file" id="newImage" accept="image/*" />
                <button class="btn ghost" id="btnPreview">Vista previa</button>
                <button class="btn" id="btnPost">Publicar</button>
              </div>
            </div>

            <div id="feed"></div>
          </main>

          <div class="right">
            <div class="card">
              <h4 class="muted">Notificaciones</h4>
              <div id="notifications"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4 class="muted">Tus estadísticas</h4>
              <div>Posts: <span id="statPosts">0</span></div>
              <div>Seguidores: <span id="statFollowers">0</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="fab" id="openComposer">+</div>
  </div>

<script>
/* ------------------ CONFIG SUPABASE ------------------ */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------ RAMAS y ASIGNATURAS ------------------ */
const data = {
  "Letras": ["Latín", "Frances", "Historia del arte"],
  "Ciencias": ["Biología", "Química", "Física", "Mates", "Tecnologia"],
  "Orokorrak": ["Fisiologia", "Geografía", "Empresa"],
  "Obligatorias": ["Historia de España", "Inglés", "Euskera", "Lengua", "Filosofía"]
};

let currentBranch = null;
let currentSubject = null;

function loadBranches() {
  const container = document.getElementById("branchList");
  container.innerHTML = "";

  Object.keys(data).forEach(branch => {
    const div = document.createElement("div");
    div.textContent = branch;
    div.onclick = () => selectBranch(branch, div);
    container.appendChild(div);
  });
}

function selectBranch(branch, element) {
  currentBranch = branch;

  [...document.querySelectorAll("#branchList div")].forEach(d => d.classList.remove("active"));
  element.classList.add("active");

  const subjects = data[branch];
  const container = document.getElementById("subjectList");
  container.innerHTML = "";

  subjects.forEach(sub => {
    const div = document.createElement("div");
    div.textContent = sub;
    div.onclick = () => selectSubject(sub, div);
    container.appendChild(div);
  });
}

function selectSubject(subject, element) {
  currentSubject = subject;

  [...document.querySelectorAll("#subjectList div")].forEach(d => d.classList.remove("active"));
  element.classList.add("active");

  document.getElementById("subjectTitle").textContent = subject;
  document.getElementById("addNoteBtn").style.display = "block";

  loadNotes();
}

/* ------------------ CARGAR NOTAS ------------------ */
async function loadNotes() {
  const container = document.getElementById("notesList");
  container.innerHTML = "Cargando...";

  const search = document.getElementById("searchInput").value.toLowerCase();

  let { data: notes, error } = await db
    .from("apuntes")
    .select("*")
    .eq("subject", currentSubject)
    .order("created_at", { ascending: false });

  if (error) {
    container.innerHTML = "Error cargando apuntes.";
    console.error(error);
    return;
  }

  notes = notes.filter(n =>
    n.title.toLowerCase().includes(search) ||
    n.content.toLowerCase().includes(search)
  );

  container.innerHTML = "";

  notes.forEach(note => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${note.title}</strong><br>${note.content}`;
    container.appendChild(div);
  });
}

document.getElementById("searchInput").oninput = loadNotes;

/* ------------------ MODAL ------------------ */
function openModal() {
  document.getElementById("modalBg").style.display = "block";
}
function closeModal() {
  document.getElementById("modalBg").style.display = "none";
}

document.getElementById("addNoteBtn").onclick = openModal;

/* ------------------ GUARDAR NOTA ------------------ */
async function saveNote() {
  const title = document.getElementById("noteTitle").value.trim();
  const content = document.getElementById("noteContent").value.trim();

  if (!title || !content) return alert("Rellena todos los campos.");

  const { error } = await db
    .from("apuntes")
    .insert({
      subject: currentSubject,
      title,
      content
    });

  if (error) {
    alert("Error guardando apunte.");
    console.error(error);
    return;
  }

  closeModal();
  loadNotes();

  document.getElementById("noteTitle").value = "";
  document.getElementById("noteContent").value = "";
}

/* ------------------ INICIO ------------------ */
loadBranches();

</script>
</body>
</html>
