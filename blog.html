<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Blog - Rebeldía IN.AR</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background: linear-gradient(45deg, #FF5733, #FF8D1A, #FFC300, #FF5733);
    background-size: 400% 400%;
    animation: gradientBG 10s ease infinite;
    color: black;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 50px;
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .home-btn { position: absolute; top: 20px; left: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; }
  .home-btn:hover { background: #555; }
  .auth-container, .user-info { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; }
  .auth-button { padding: 10px 20px; font-size: 1em; color: white; background-color: #333; border: none; cursor: pointer; border-radius: 5px; }
  .user-info { display: none; cursor: pointer; }
  #userLogo { width: 40px; height: 40px; border-radius: 50%; }
  #userName { font-weight: bold; }
  .dropdown-menu { display: none; position: absolute; top: 60px; right: 20px; background: white; color: black; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 150px; text-align: left; }
  .dropdown-menu td { padding: 10px; cursor: pointer; }
  .dropdown-menu td:hover { background-color: #ddd; }
  .blog-container { max-width: 800px; margin-top: 80px; padding: 20px; text-align: center; width: 100%; }
  .blog-post, .new-blog, .blog-details { background: white; color: black; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .blog-post { cursor: pointer; border: 1px solid #ddd; transition: transform 0.2s; }
  .blog-post:hover { transform: scale(1.02); }
  .hidden { display: none; }
  input, textarea { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
  .btn { padding: 10px 15px; border: none; border-radius: 8px; background: #e11d48; color: white; cursor: pointer; margin: 5px; }
  .btn:hover { background: #be123c; }
  #commentsList div { border-bottom: 1px solid #ccc; padding: 5px 0; text-align: left; }
  .like-btn { background:none; border:none; cursor:pointer; font-size:1.5em; color:#ff4081; margin-top:5px; }
  .like-btn.liked { color:red; }
  .blog-media { margin-top:10px; max-width:100%; border-radius:6px; }
</style>
</head>
<body>

<button class="home-btn" onclick="window.location.href='Hub.html'"> Volver a la Página Principal</button>

<div class="auth-container" id="authContainer">
  <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesión o registrarse</button>
</div>

<div class="user-info" id="userInfo">
  <h3 id="userName"></h3>
  <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
</div>

<div class="dropdown-menu" id="dropdownMenu">
  <table><tr><td onclick="logout()">Cerrar sesión</td></tr></table>
</div>

<div class="blog-container">
  <h1>Blog</h1>
  <button class="btn" onclick="showNewBlogForm()">Publicar nuevo blog</button>

  <div id="newBlogForm" class="new-blog hidden">
    <h2>Nuevo Blog</h2>
    <input type="text" id="newTitle" placeholder="Título">
    <textarea id="newContent" rows="5" placeholder="Escribe tu blog aquí..."></textarea>
    <input type="file" id="newMedia" accept="image/*,video/*,image/gif">
    <button class="btn" onclick="publishBlog()">Publicar</button>
    <button class="btn" onclick="hideNewBlogForm()">Cancelar</button>
  </div>

  <div id="blogsList"></div>

  <div id="blogDetails" class="blog-details hidden">
    <h2 id="blogTitleDetail"></h2>
    <div id="blogMediaDetail"></div>
    <p id="blogContentDetail"></p>
    <h3>Comentarios</h3>
    <div id="commentsList"></div>
    <div id="newCommentForm">
      <textarea id="newCommentText" rows="3" placeholder="Escribe tu comentario..."></textarea>
      <button class="btn" onclick="publishComment()">Publicar comentario</button>
    </div>
    <button class="btn" onclick="closeBlog()">Volver</button>
  </div>
</div>

<script>
const { createClient } = supabase;
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------- SESIÓN ----------
function getCurrentUser() { return JSON.parse(localStorage.getItem("currentUser")) || null; }
function isUserLoggedIn() { return !!getCurrentUser(); }

function loadUserInfo() {
  const user = getCurrentUser();
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");
  if(user) {
    userInfo.style.display = "flex";
    authContainer.style.display = "none";
    document.getElementById("userName").textContent = user.username || "Usuario";
    document.getElementById("userLogo").src = user.logo || "logoDefault.png";
  } else {
    userInfo.style.display = "none";
    authContainer.style.display = "flex";
  }
}

function logout() {
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
}

// Dropdown
const userInfoDiv = document.getElementById("userInfo");
const dropdownMenu = document.getElementById("dropdownMenu");
userInfoDiv.addEventListener("click", () => {
  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
});
document.addEventListener("click", (e) => {
  if (!userInfoDiv.contains(e.target) && !dropdownMenu.contains(e.target))
    dropdownMenu.style.display = "none";
});

// ---------- BLOG ----------
function showNewBlogForm() {
  if (!isUserLoggedIn()) { alert("Debes iniciar sesión para publicar un blog"); return; }
  document.getElementById("newBlogForm").classList.remove("hidden");
}
function hideNewBlogForm() { document.getElementById("newBlogForm").classList.add("hidden"); }

async function loadBlogs() {
  const { data, error } = await db.from("blog").select("*").order("created_at", { ascending: false });
  const blogsList = document.getElementById("blogsList");
  blogsList.innerHTML = "";

  if(error){ console.error(error); blogsList.innerHTML="<p>Error al cargar blogs</p>"; return; }
  if(!data || data.length===0){ blogsList.innerHTML="<p>No hay blogs publicados.</p>"; return; }

  const user = getCurrentUser();

  data.forEach(blog => {
    const div = document.createElement("div");
    div.className = "blog-post";
    div.innerHTML = `
      <h3>${blog.title}</h3>
      <p style="font-size:0.9em;color:gray;">Autor: ${blog.author || "Anónimo"}</p>
      ${blog.media_url ? (blog.media_url.endsWith(".mp4") ? `<video src="${blog.media_url}" controls class="blog-media"></video>` : `<img src="${blog.media_url}" class="blog-media">`) : ""}
      <p>❤️ <span id="likeCount-${blog.id}">${blog.likes || 0}</span></p>
      <button class="like-btn" id="likeBtn-${blog.id}">❤️</button>
    `;

    // Abrir blog solo si no se clickea el botón de like
    div.addEventListener("click", (e) => {
      if(!e.target.classList.contains("like-btn")) openBlog(blog);
    });

    // Like
    const likeBtn = div.querySelector(`#likeBtn-${blog.id}`);
    likeBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      await toggleLike(blog.id);
    });

    // Marcar si ya dio like
    if(user && localStorage.getItem(`like_${blog.id}_${user.id}`)) likeBtn.classList.add("liked");

    blogsList.appendChild(div);
  });
}

// Likes
async function toggleLike(blogId) {
  const user = getCurrentUser();
  if(!user){ alert("Inicia sesión para dar like"); return; }

  const likeKey = `like_${blogId}_${user.id}`;
  const likeEl = document.getElementById(`likeCount-${blogId}`);
  const btn = document.getElementById(`likeBtn-${blogId}`);

  const alreadyLiked = localStorage.getItem(likeKey);
  const currentLikes = parseInt(likeEl.textContent) || 0;
  const newLikes = alreadyLiked ? currentLikes - 1 : currentLikes + 1;

  likeEl.textContent = newLikes;
  btn.classList.toggle("liked");

  if(alreadyLiked) localStorage.removeItem(likeKey);
  else localStorage.setItem(likeKey, "true");

  await db.from("blog").update({ likes: newLikes }).eq("id", blogId);
}

// Publicar blog
async function publishBlog() {
  const user = getCurrentUser();
  if(!user){ alert("Debes iniciar sesión"); return; }

  const title = document.getElementById("newTitle").value.trim();
  const content = document.getElementById("newContent").value.trim();
  const mediaInput = document.getElementById("newMedia");
  let mediaUrl = "";

  if(!title || !content){ alert("Completa todos los campos"); return; }

  if(mediaInput.files.length > 0){
    const file = mediaInput.files[0];
    const fileName = `${user.id}_${Date.now()}_${file.name}`;
    const { error: uploadError } = await db.storage.from("blog-media").upload(fileName, file, { upsert: true });
    if(uploadError){ console.error(uploadError); alert("Error subiendo archivo"); return; }

    const { data: publicData, error: urlError } = db.storage.from("blog-media").getPublicUrl(fileName);
    if(urlError){ console.error(urlError); alert("Error al obtener URL pública"); return; }
    mediaUrl = publicData.publicUrl;
  }

  const { error } = await db.from("blog").insert([{ title, content, author:user.username, media_url:mediaUrl, likes:0 }]);
  if(error){ console.error(error); alert("Error al publicar"); return; }

  hideNewBlogForm();
  document.getElementById("newTitle").value = "";
  document.getElementById("newContent").value = "";
  document.getElementById("newMedia").value = "";

  loadBlogs();
}

// Abrir y cerrar blog
function openBlog(blog){
  document.getElementById("blogTitleDetail").textContent = blog.title;
  document.getElementById("blogContentDetail").textContent = blog.content;
  const mediaDiv = document.getElementById("blogMediaDetail");
  mediaDiv.innerHTML = "";
  if(blog.media_url){
    if(blog.media_url.endsWith(".mp4"))
      mediaDiv.innerHTML = `<video src="${blog.media_url}" controls class="blog-media"></video>`;
    else
      mediaDiv.innerHTML = `<img src="${blog.media_url}" class="blog-media">`;
  }
  document.getElementById("blogsList").classList.add("hidden");
  document.getElementById("blogDetails").classList.remove("hidden");
  window.currentBlogId = blog.id;
  loadComments(blog.id);
}
function closeBlog(){
  document.getElementById("blogDetails").classList.add("hidden");
  document.getElementById("blogsList").classList.remove("hidden");
}

// Comentarios
async function loadComments(blogId){
  const { data, error } = await db.from("comments").select("*").eq("blog_id", blogId).order("created_at",{ascending:true});
  const commentsList = document.getElementById("commentsList");
  commentsList.innerHTML = "";
  if(error){ console.error(error); commentsList.innerHTML="<p>Error al cargar comentarios</p>"; return; }
  if(!data || data.length===0){ commentsList.innerHTML="<p>No hay comentarios todavía.</p>"; return; }

  data.forEach(comment=>{
    const div=document.createElement("div");
    div.innerHTML=`<strong>${comment.author}</strong>: ${comment.comment}`;
    commentsList.appendChild(div);
  });
}

async function publishComment(){
  const user = getCurrentUser();
  if(!user){ alert("Debes iniciar sesión"); return; }

  const commentText = document.getElementById("newCommentText").value.trim();
  if(!commentText){ alert("Escribe un comentario"); return; }

  const { error } = await db.from("comments").insert([{ blog_id: window.currentBlogId, author:user.username, comment: commentText }]);
  if(error){ console.error(error); alert("Error al publicar comentario"); return; }

  document.getElementById("newCommentText").value = "";
  loadComments(window.currentBlogId);
}

// ---------- Cargar al inicio ----------
document.addEventListener("DOMContentLoaded", ()=>{
  loadUserInfo();
  loadBlogs();
});
</script>
</body>
</html>
