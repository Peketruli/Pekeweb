<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pac-Man Clásico</title>
<style>
  body{margin:0;background:#000;overflow:hidden;font-family:Arial,sans-serif;}
  canvas{display:block;margin:auto;background:#000;image-rendering:pixelated;}
  #scoreBoard{position:absolute;top:10px;left:10px;color:#fff;font-weight:bold;}
</style>
</head>
<body>
<div id="scoreBoard">Puntuación: 0 | Vidas: 3</div>
<canvas id="gameCanvas"></canvas>
<script>
// ---------------- Configuración ----------------
const TILE = 20;
const ROWS = 31;
const COLS = 28;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = COLS*TILE;
canvas.height = ROWS*TILE;

const RAW_MAP = [
"############################",
"#............##............#",
"#.####.#####.##.#####.####.#",
"#o####.#####.##.#####.####o#",
"#.####.#####.##.#####.####.#",
"#..........................#",
"#.####.##.########.##.####.#",
"#.####.##.########.##.####.#",
"#......##....##....##......#",
"######.##### ## #####.######",
"######.##### ## #####.######",
"######.##          ##.######",
"######.## ###--### ##.######",
"######.## #      # ##.######",
"      .   #      #   .      ",
"######.## #      # ##.######",
"######.## ######## ##.######",
"######.##          ##.######",
"######.## ######## ##.######",
"######.## ######## ##.######",
"#............##............#",
"#.####.#####.##.#####.####.#",
"#o####.#####.##.#####.####o#",
"#...##................##...#",
"###.##.##.########.##.##.###",
"###.##.##.########.##.##.###",
"#......##....##....##......#",
"#.##########.##.##########.#",
"#.##########.##.##########.#",
"#..........................#",
"############################"
];

// ---------------- Utilidades ----------------
function cloneMap(raw){return raw.map(r=>r.split(''));}
function inside(x,y){return x>=0 && x<COLS && y>=0 && y<ROWS;}
function isWall(map,tx,ty){return !inside(tx,ty) || map[ty][tx]==='#';}
function tileCenterX(tx){return tx*TILE + TILE/2;}
function tileCenterY(ty){return ty*TILE + TILE/2;}
function distanceSq(a,b){const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;}
function tileFromPx(x,y){return {x:Math.floor(x/TILE),y:Math.floor(y/TILE)};}

// ---------------- Estado del Juego ----------------
let map = cloneMap(RAW_MAP);
let score=0,lives=3;

// Pac-Man
let pac = {
  x: tileCenterX(13),
  y: tileCenterY(23),
  dir: {x:0,y:0},
  nextDir: {x:0,y:0},
  speed:2,
  radius:8,
  mouth:0
};

// Fantasmas
const ghosts = [
  {name:'blinky', color:'#ff0000', tx:13,ty:11,x:tileCenterX(13),y:tileCenterY(11),mode:'scatter',state:'normal',speed:2,scatterTarget:{x:27,y:0}},
  {name:'pinky', color:'#ffb8ff', tx:14,ty:11,x:tileCenterX(14),y:tileCenterY(11),mode:'scatter',state:'normal',speed:2,scatterTarget:{x:0,y:0}},
  {name:'inky', color:'#00ffff', tx:12,ty:11,x:tileCenterX(12),y:tileCenterY(11),mode:'scatter',state:'normal',speed:2,scatterTarget:{x:27,y:30}},
  {name:'clyde', color:'#ffb852', tx:15,ty:11,x:tileCenterX(15),y:tileCenterY(11),mode:'scatter',state:'normal',speed:2,scatterTarget:{x:0,y:30}}
];

let powerMode=false,powerTimer=0;

// Input
const keyMap={'ArrowUp':{x:0,y:-1},'ArrowDown':{x:0,y:1},'ArrowLeft':{x:-1,y:0},'ArrowRight':{x:1,y:0}};
document.addEventListener('keydown',e=>{if(keyMap[e.key]){pac.nextDir={...keyMap[e.key]};e.preventDefault();}});

// ---------------- Movimiento ----------------
function canMoveToTile(tx,ty){return !isWall(map,tx,ty);}
function tryApplyNextDir(){
  const nextTile={x:Math.floor((pac.x+pac.nextDir.x*TILE/2)/TILE),y:Math.floor((pac.y+pac.nextDir.y*TILE/2)/TILE)};
  if(canMoveToTile(nextTile.x,nextTile.y)) pac.dir={...pac.nextDir};
}
function movePac(){
  tryApplyNextDir();
  pac.x+=pac.dir.x*pac.speed;
  pac.y+=pac.dir.y*pac.speed;
  // túneles
  if(pac.x<-pac.radius) pac.x=canvas.width+pac.radius;
  if(pac.x>canvas.width+pac.radius) pac.x=-pac.radius;
  // colisiones pared
  const t=tileFromPx(pac.x,pac.y);
  if(isWall(map,t.x,t.y)){pac.x-=pac.dir.x*pac.speed;pac.y-=pac.dir.y*pac.speed;pac.dir={x:0,y:0};}
}

// ---------------- Pellets ----------------
function checkPelletConsumption(){
  const t=tileFromPx(pac.x,pac.y);
  const c=map[t.y][t.x];
  if(c==='.'){map[t.y][t.x]=' ';score+=10;}
  else if(c==='o'){map[t.y][t.x]=' ';score+=50;powerMode=true;powerTimer=600;ghosts.forEach(g=>{if(g.state==='normal')g.state='frightened';});}
}

// ---------------- Ghosts ----------------
function moveGhosts(){
  for(const g of ghosts){
    const startTile=tileFromPx(g.x,g.y);
    if(g.state==='eyes' && startTile.x===13 && startTile.y===11){g.state='normal';g.mode='scatter';g.x=tileCenterX(13);g.y=tileCenterY(11);}
    let targetTile={x:pac.x/TILE|0,y:pac.y/TILE|0};
    if(g.state==='frightened'){targetTile={x:Math.floor(Math.random()*COLS),y:Math.floor(Math.random()*ROWS));}
    const dx=(targetTile.x*TILE+TILE/2-g.x);
    const dy=(targetTile.y*TILE+TILE/2-g.y);
    const len=Math.sqrt(dx*dx+dy*dy)||1;
    let speed=g.speed;
    if(g.state==='frightened') speed*=0.9;
    if(g.state==='eyes') speed*=1.5;
    g.x+=dx/len*speed;
    g.y+=dy/len*speed;
  }
}

// ---------------- Colisiones ----------------
function checkCollisions(){
  for(const g of ghosts){
    const d2=distanceSq({x:pac.x,y:pac.y},{x:g.x,y:g.y});
    if(d2<(pac.radius*2)*(pac.radius*2)*0.8){
      if(powerMode && g.state==='frightened'){score+=100;g.state='eyes';}
      else if(!powerMode && g.state!=='eyes'){lives--;if(lives<=0){alert('GAME OVER '+score);location.reload();} else resetPositions();}
    }
  }
}

function resetPositions(){
  pac.x=tileCenterX(13);pac.y=tileCenterY(23);pac.dir={x:0,y:0};pac.nextDir={x:0,y:0};
  ghosts.forEach((g,i)=>{g.x=tileCenterX(13+i);g.y=tileCenterY(11);g.state='normal';g.mode='scatter';});
}

// ---------------- Dibujo ----------------
function draw(){
  ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);
  // Mapa
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      const c=map[y][x];const px=x*TILE,py=y*TILE;
      if(c==='#'){ctx.fillStyle='#001f6f';ctx.fillRect(px,py,TILE,TILE);}
      else if(c==='.'){ctx.fillStyle='#ffd54d';ctx.beginPath();ctx.arc(px+TILE/2,py+TILE/2,2,0,Math.PI*2);ctx.fill();}
      else if(c==='o'){ctx.fillStyle='#ffd54d';ctx.beginPath();ctx.arc(px+TILE/2,py+TILE/2,5,0,Math.PI*2);ctx.fill();}
    }
  }
  // Pac-Man
  const mouthAngle=0.25+0.25*Math.sin(pac.mouth);
  const dirAngle=Math.atan2(pac.dir.y,pac.dir.x)||0;
  ctx.fillStyle='#ffea00';
  if(pac.dir.x===0&&pac.dir.y===0){ctx.beginPath();ctx.arc(pac.x,pac.y,pac.radius,0,Math.PI*2);ctx.fill();}
  else{ctx.beginPath();ctx.moveTo(pac.x,pac.y);ctx.arc(pac.x,pac.y,pac.radius,-mouthAngle+dirAngle,mouthAngle+dirAngle,false);ctx.closePath();ctx.fill();}
  pac.mouth+=0.3;
  // Ghosts
  ghosts.forEach(g=>{
    ctx.fillStyle=g.state==='frightened'?'#0000cc':g.state==='eyes'?'#fff':g.color;
    ctx.beginPath();ctx.arc(g.x,g.y,pac.radius,Math.PI,0,false);ctx.lineTo(g.x+pac.radius,g.y+pac.radius);ctx.lineTo(g.x-pac.radius,g.y+pac.radius);ctx.closePath();ctx.fill();
    // ojos
    ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(g.x-4,g.y-2,3,4,0,0,Math.PI*2);ctx.ellipse(g.x+4,g.y-2,3,4,0,0,Math.PI*2);ctx.fill();
    const dx=pac.x-g.x,dy=pac.y-g.y,len=Math.sqrt(dx*dx+dy*dy)||1;
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(g.x-4+dx/len*2,g.y-2+dy/len*2,1.5,0,Math.PI*2);ctx.arc(g.x+4+dx/len*2,g.y-2+dy/len*2,1.5,0,Math.PI*2);ctx.fill();
  });
  document.getElementById('scoreBoard').innerText=`Puntuación: ${score} | Vidas: ${lives}`;
}

// ---------------- Loop ----------------
function update(){
  movePac();
  checkPelletConsumption();
  moveGhosts();
  checkCollisions();
  if(powerMode){powerTimer--;if(powerTimer<=0){powerMode=false;ghosts.forEach(g=>{if(g.state==='frightened')g.state='normal';});}}
  draw();
  requestAnimationFrame(update);
}

resetPositions();
update();

</script>
</body>
</html>
