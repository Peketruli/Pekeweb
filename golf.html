<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pac-Man (Arcade Físicas Correctas)</title>
<style>
  body {
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
  }
  #score {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 18px;
  }
  canvas {
    display: block;
    margin: 40px auto;
    background: black;
    image-rendering: pixelated;
  }
</style>
</head>
<body>
<div id="score">Puntos: 0 | Vidas: 3</div>
<canvas id="game" width="448" height="496"></canvas>

<script>
const TILE = 16;
const ROWS = 31;
const COLS = 28;
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");

// Mapa original del Pac-Man
const map = [
"############################",
"#............##............#",
"#.####.#####.##.#####.####.#",
"#o####.#####.##.#####.####o#",
"#.####.#####.##.#####.####.#",
"#..........................#",
"#.####.##.########.##.####.#",
"#.####.##.########.##.####.#",
"#......##....##....##......#",
"######.##### ## #####.######",
"######.##### ## #####.######",
"######.##          ##.######",
"######.## ###--### ##.######",
"######.## #      # ##.######",
"      .   #      #   .      ",
"######.## #      # ##.######",
"######.## ######## ##.######",
"######.##          ##.######",
"######.## ######## ##.######",
"######.## ######## ##.######",
"#............##............#",
"#.####.#####.##.#####.####.#",
"#o####.#####.##.#####.####o#",
"#...##................##...#",
"###.##.##.########.##.##.###",
"###.##.##.########.##.##.###",
"#......##....##....##......#",
"#.##########.##.##########.#",
"#.##########.##.##########.#",
"#..........................#",
"############################"
].map(r => r.split(''));

const dirs = {
  up: {x: 0, y: -1},
  down: {x: 0, y: 1},
  left: {x: -1, y: 0},
  right: {x: 1, y: 0}
};

let score = 0;
let lives = 3;
let powerTimer = 0;

// --- ENTIDADES ---
const pacman = {
  x: 13, y: 23,
  dir: "left",
  nextDir: "left",
  speed: 6, // tiles por segundo
};

const ghosts = [
  {x: 13, y: 11, dir: "left", color: "#ff0000"},
  {x: 14, y: 11, dir: "right", color: "#ffb8ff"},
  {x: 12, y: 11, dir: "up", color: "#00ffff"},
  {x: 15, y: 11, dir: "down", color: "#ffb852"},
];

let lastTime = 0;

document.addEventListener("keydown", e => {
  if (e.key === "ArrowUp") pacman.nextDir = "up";
  if (e.key === "ArrowDown") pacman.nextDir = "down";
  if (e.key === "ArrowLeft") pacman.nextDir = "left";
  if (e.key === "ArrowRight") pacman.nextDir = "right";
});

function isWall(tx, ty) {
  if (tx < 0 || tx >= COLS || ty < 0 || ty >= ROWS) return true;
  return map[ty][tx] === "#";
}

function moveEntity(entity, dt) {
  const dir = dirs[entity.dir];
  const step = entity.speed * dt / 1000; // tiles por frame
  const nextX = entity.x + dir.x * step;
  const nextY = entity.y + dir.y * step;

  const nextTileX = Math.round(nextX);
  const nextTileY = Math.round(nextY);

  if (!isWall(nextTileX, nextTileY)) {
    entity.x = nextX;
    entity.y = nextY;
  } else {
    entity.x = Math.round(entity.x);
    entity.y = Math.round(entity.y);
  }

  // túneles laterales
  if (entity.x < 0) entity.x = COLS - 1;
  if (entity.x >= COLS) entity.x = 0;
}

function canMove(entity, dirKey) {
  const dir = dirs[dirKey];
  const tx = Math.round(entity.x) + dir.x;
  const ty = Math.round(entity.y) + dir.y;
  return !isWall(tx, ty);
}

function update(time = 0) {
  const dt = time - lastTime;
  lastTime = time;

  // actualizar dirección solo si está centrado en celda
  const cx = Math.round(pacman.x);
  const cy = Math.round(pacman.y);
  if (Math.abs(pacman.x - cx) < 0.1 && Math.abs(pacman.y - cy) < 0.1) {
    if (canMove(pacman, pacman.nextDir)) pacman.dir = pacman.nextDir;
  }

  moveEntity(pacman, dt);

  // comer puntos
  const px = Math.round(pacman.x);
  const py = Math.round(pacman.y);
  const cell = map[py][px];
  if (cell === ".") {
    map[py][px] = " ";
    score += 10;
  } else if (cell === "o") {
    map[py][px] = " ";
    score += 50;
    powerTimer = 600;
  }

  // mover fantasmas
  for (const g of ghosts) {
    if (Math.abs(g.x - Math.round(g.x)) < 0.1 && Math.abs(g.y - Math.round(g.y)) < 0.1) {
      const possible = Object.keys(dirs).filter(d => canMove(g, d));
      // Evitar volver hacia atrás
      const opposite = {
        up: "down", down: "up", left: "right", right: "left"
      };
      const valid = possible.filter(d => d !== opposite[g.dir]);
      // Buscar dirección más cercana a Pac-Man
      let best = g.dir;
      let bestDist = Infinity;
      for (const d of valid) {
        const nx = Math.round(g.x) + dirs[d].x;
        const ny = Math.round(g.y) + dirs[d].y;
        const dx = pacman.x - nx;
        const dy = pacman.y - ny;
        const dist = dx*dx + dy*dy;
        if (dist < bestDist) { bestDist = dist; best = d; }
      }
      g.dir = best;
    }
    moveEntity(g, dt);

    const dx = g.x - pacman.x;
    const dy = g.y - pacman.y;
    if (dx*dx + dy*dy < 0.25) {
      if (powerTimer > 0) {
        g.x = 13; g.y = 11;
        score += 200;
      } else {
        lives--;
        if (lives <= 0) {
          alert("GAME OVER\nPuntos: " + score);
          location.reload();
        }
        resetPositions();
      }
    }
  }

  if (powerTimer > 0) powerTimer--;

  draw();
  scoreEl.textContent = `Puntos: ${score} | Vidas: ${lives}`;
  requestAnimationFrame(update);
}

function resetPositions() {
  pacman.x = 13; pacman.y = 23;
  pacman.dir = "left"; pacman.nextDir = "left";
  ghosts[0].x = 13; ghosts[0].y = 11;
  ghosts[1].x = 14; ghosts[1].y = 11;
  ghosts[2].x = 12; ghosts[2].y = 11;
  ghosts[3].x = 15; ghosts[3].y = 11;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for (let y=0; y<ROWS; y++){
    for (let x=0; x<COLS; x++){
      if (map[y][x] === "#"){
        ctx.fillStyle = "#001f6f";
        ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
      } else if (map[y][x] === "."){
        ctx.fillStyle = "#ffd54d";
        ctx.beginPath();
        ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 2, 0, Math.PI*2);
        ctx.fill();
      } else if (map[y][x] === "o"){
        ctx.fillStyle = "#ffd54d";
        ctx.beginPath();
        ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 5, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }

  // Pac-Man
  ctx.fillStyle = "#ffea00";
  ctx.beginPath();
  ctx.arc(pacman.x*TILE+TILE/2, pacman.y*TILE+TILE/2, 7, 0, Math.PI*2);
  ctx.fill();

  // Fantasmas
  for (const g of ghosts) {
    ctx.fillStyle = powerTimer>0 ? "#0000cc" : g.color;
    ctx.beginPath();
    ctx.arc(g.x*TILE+TILE/2, g.y*TILE+TILE/2, 7, 0, Math.PI*2);
    ctx.fill();
  }
}

resetPositions();
requestAnimationFrame(update);
</script>
</body>
</html>
