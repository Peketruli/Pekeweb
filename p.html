<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juego de Cartas</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    #menu, #gameArea {
      display: none;
      padding: 20px;
    }

    #menu.active, #gameArea.active {
      display: block;
    }

    .room {
      background: #222;
      border-radius: 10px;
      padding: 10px;
      margin: 10px auto;
      width: 300px;
      cursor: pointer;
      transition: 0.3s;
    }

    .room:hover {
      background: #333;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      justify-items: center;
      margin-top: 30px;
    }

    .playerSlot {
      width: 120px;
      height: 120px;
      background: #222;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .centerCards {
      grid-column: 2;
      width: 300px;
      height: 150px;
      background: #333;
      border-radius: 10px;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #sidePanel {
      position: fixed;
      right: 0;
      top: 0;
      width: 250px;
      height: 100%;
      background: #222;
      padding: 15px;
      box-shadow: -3px 0 5px rgba(0,0,0,0.5);
    }

    button {
      background: orange;
      border: none;
      border-radius: 10px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: gold;
    }
  </style>
</head>
<body>
  <div id="menu" class="active">
    <h1>Salas del Juego de Cartas</h1>
    <div id="roomsList"></div>
    <input type="text" id="roomName" placeholder="Nombre de la sala" />
    <br />
    <button id="createRoomBtn">Crear Sala</button>
  </div>

  <div id="gameArea">
    <h2 id="roomTitle"></h2>
    <div id="board"></div>
    <div class="centerCards">Zona de cartas (5 huecos más adelante)</div>
    <div id="sidePanel">
      <h3>Jugadores (<span id="playerCount">0</span>/5)</h3>
      <ul id="playerList"></ul>
      <hr>
      <h4>Mis fichas</h4>
      <p>Blancas: <span id="fBlanca">0</span></p>
      <p>Rojas: <span id="fRoja">0</span></p>
      <p>Azules: <span id="fAzul">0</span></p>
      <p>Verdes: <span id="fVerde">0</span></p>
      <hr>
      <button id="startGameBtn">Iniciar Partida</button>
      <button id="leaveRoomBtn">Salir</button>
    </div>
  </div>

  <script>
    // --- CONFIGURACIÓN SUPABASE ---
    const SUPABASE_URL = "https://TU_URL.supabase.co"; // ⬅️ Cambia esto
    const SUPABASE_ANON_KEY = "TU_ANON_KEY";           // ⬅️ Cambia esto
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentRoom = null;

    async function init() {
      const userData = JSON.parse(localStorage.getItem("usuarioActual"));
      if (!userData || !userData.username) {
        alert("Debes iniciar sesión primero");
        return;
      }

      currentUser = userData;
      await loadRooms();
      document.getElementById("menu").classList.add("active");
    }

    async function loadRooms() {
      const { data, error } = await supabase.from("rooms").select("*");
      if (error) return console.error("Error cargando salas:", error);

      const roomsList = document.getElementById("roomsList");
      roomsList.innerHTML = "";
      data.forEach(room => {
        const div = document.createElement("div");
        div.className = "room";
        const players = Array.isArray(room.players) ? room.players : [];
        div.textContent = `${room.name} (${players.length}/5 jugadores)`;
        div.onclick = () => joinRoom(room);
        roomsList.appendChild(div);
      });
    }

    async function createRoom() {
      const name = document.getElementById("roomName").value.trim();
      if (!name) return alert("Pon un nombre para la sala");

      const playerData = { username: currentUser.username, id: currentUser.id };
      const { data, error } = await supabase
        .from("rooms")
        .insert([{ name, players: [playerData] }])
        .select()
        .single();

      if (error) return console.error("Error creando sala:", error);
      joinRoom(data);
    }

    async function joinRoom(room) {
      let players = Array.isArray(room.players) ? room.players : [];
      if (players.find(p => p.id === currentUser.id)) {
        // Ya estaba dentro
      } else if (players.length >= 5) {
        return alert("La sala está llena");
      } else {
        players.push({ username: currentUser.username, id: currentUser.id });
        const { error } = await supabase
          .from("rooms")
          .update({ players })
          .eq("id", room.id);
        if (error) return console.error("Error al unirse:", error);
      }

      currentRoom = room;
      showGameUI(room.name);
      loadPlayerList(players);
      loadUserChips();
    }

    function showGameUI(roomName) {
      document.getElementById("menu").classList.remove("active");
      document.getElementById("gameArea").classList.add("active");
      document.getElementById("roomTitle").textContent = `Sala: ${roomName}`;

      const board = document.getElementById("board");
      board.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const slot = document.createElement("div");
        slot.className = "playerSlot";
        slot.textContent = `Jugador ${i + 1}`;
        board.appendChild(slot);
      }
    }

    function loadPlayerList(players) {
      const list = document.getElementById("playerList");
      list.innerHTML = "";
      players.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.username;
        list.appendChild(li);
      });
      document.getElementById("playerCount").textContent = players.length;
    }

    async function loadUserChips() {
      const { data, error } = await supabase
        .from("usuarios")
        .select("ficha_blanca, ficha_roja, ficha_azul, ficha_verde")
        .eq("username", currentUser.username)
        .single();
      if (error) return console.error("Error cargando fichas:", error);

      document.getElementById("fBlanca").textContent = data.ficha_blanca;
      document.getElementById("fRoja").textContent = data.ficha_roja;
      document.getElementById("fAzul").textContent = data.ficha_azul;
      document.getElementById("fVerde").textContent = data.ficha_verde;
    }

    document.getElementById("createRoomBtn").onclick = createRoom;
    document.getElementById("leaveRoomBtn").onclick = () => location.reload();
    document.getElementById("startGameBtn").onclick = () => alert("Partida iniciada (por implementar)");

    init();
  </script>
</body>
</html>
