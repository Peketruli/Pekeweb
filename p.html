<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Fichas y Tablero</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    margin: 0;
    padding: 0;
  }

  h1 {
    color: #ff9a33;
    text-align: center;
  }

  .card {
    background: #1b1b1b;
    border-radius: 10px;
    padding: 14px;
    width: 95%;
    max-width: 980px;
    margin: 12px auto;
    border: 1px solid rgba(255,140,50,0.06);
  }

  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  button {
    background: #ff7f2a;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
  }

  button.secondary { background: #444; }

  input, select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #333;
    background: #0f0f0f;
    color: #fff;
  }

  /* === TABLERO === */
  #tableroContainer {
    display: none;
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at center, #202020 0%, #0b0b0b 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
  }

  #tableroTop {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #jugadoresInfo {
    font-size: 16px;
    color: #ffb866;
  }

  #mesa {
    position: relative;
    width: 90%;
    max-width: 800px;
    height: 450px;
    background: radial-gradient(circle at center, #144914 0%, #0a240a 100%);
    border: 4px solid #2c2c2c;
    border-radius: 50%;
    box-shadow: 0 0 25px #000 inset;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Huecos para cartas centrales */
  .cartasMesa {
    display: flex;
    gap: 10px;
  }
  .huecoCarta {
    width: 70px;
    height: 100px;
    border: 2px dashed rgba(255,255,255,0.3);
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
  }

  /* Posiciones de jugadores */
  .jugador {
    position: absolute;
    text-align: center;
    width: 120px;
    color: #fff;
    font-size: 14px;
  }

  .jugador span {
    display: block;
    margin-top: 4px;
    color: #ffb866;
  }

  .jugador1 { bottom: 10px; left: 50%; transform: translateX(-50%); }
  .jugador2 { top: 10px; left: 50%; transform: translateX(-50%); }
  .jugador3 { left: 20px; top: 50%; transform: translateY(-50%); }
  .jugador4 { right: 20px; top: 50%; transform: translateY(-50%); }
  .jugador5 { top: 25%; left: 50%; transform: translateX(-50%); }

  .hidden { display: none; }
</style>
</head>
<body>

<h1>Juego de Cartas ‚Äî Fichas y Salas</h1>

<!-- === CONVERSI√ìN === -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos actuales: <strong id="pekepuntosActuales">0</strong></p>
  <div class="row">
    <select id="tipoFicha">
      <option value="1">Blanca (1)</option>
      <option value="5">Roja (5)</option>
      <option value="25">Azul (25)</option>
      <option value="100">Verde (100)</option>
    </select>
    <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" style="width:120px" />
    <button id="canjearBtn">Canjear</button>
  </div>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- === SALAS === -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <div style="margin-bottom:8px" class="row">
    <input id="nombreSala" placeholder="Nombre de la sala" style="flex:1;max-width:360px" />
    <button id="crearSalaBtn">Crear sala</button>
    <button id="refreshSalas" class="secondary">Actualizar</button>
  </div>
  <div id="salasContainer"></div>
</div>

<!-- === TABLERO === -->
<div id="tableroContainer">
  <div id="tableroTop">
    <button id="salirBtn">‚Üê Salir de la partida</button>
    <div id="jugadoresInfo">Jugadores: 0 / 5</div>
  </div>
  <div id="mesa">
    <div class="jugador jugador1" id="pos1"><div>Jugador 1<span></span></div></div>
    <div class="jugador jugador2" id="pos2"><div>Jugador 2<span></span></div></div>
    <div class="jugador jugador3" id="pos3"><div>Jugador 3<span></span></div></div>
    <div class="jugador jugador4" id="pos4"><div>Jugador 4<span></span></div></div>
    <div class="jugador jugador5" id="pos5"><div>Jugador 5<span></span></div></div>
    <div class="cartasMesa">
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

let usuarioSesion = JSON.parse(localStorage.getItem('currentUser')) || { username: "Invitado", pekepuntos: 500 };
let fichas = JSON.parse(localStorage.getItem('fichas')) || { blanca:0, roja:0, azul:0, verde:0 };
let salaActual = null;

// Elementos
const salasContainer = document.getElementById('salasContainer');
const crearSalaBtn = document.getElementById('crearSalaBtn');
const refreshSalasBtn = document.getElementById('refreshSalas');
const conversionCard = document.getElementById('conversionCard');
const salasCard = document.getElementById('salasCard');
const tableroContainer = document.getElementById('tableroContainer');
const salirBtn = document.getElementById('salirBtn');
const jugadoresInfo = document.getElementById('jugadoresInfo');
const pekepuntosActualesEl = document.getElementById('pekepuntosActuales');
const fichaResumen = document.getElementById('fichaResumen');

// Mostrar fichas
function renderFichas(){
  fichaResumen.textContent = `‚ö™ ${fichas.blanca} üî¥ ${fichas.roja} üîµ ${fichas.azul} üü¢ ${fichas.verde}`;
  localStorage.setItem('fichas', JSON.stringify(fichas));
  localStorage.setItem('currentUser', JSON.stringify(usuarioSesion));
  pekepuntosActualesEl.textContent = usuarioSesion.pekepuntos;
}
renderFichas();

// Canje
document.getElementById('canjearBtn').addEventListener('click', ()=>{
  const tipo = Number(document.getElementById('tipoFicha').value);
  const cantidad = parseInt(document.getElementById('cantidadFichas').value);
  if(!cantidad || cantidad<=0) return alert('Cantidad inv√°lida');
  const total = tipo * cantidad;
  if(usuarioSesion.pekepuntos < total) return alert('No tienes suficientes pekepuntos');
  usuarioSesion.pekepuntos -= total;
  if(tipo===1) fichas.blanca += cantidad;
  if(tipo===5) fichas.roja += cantidad;
  if(tipo===25) fichas.azul += cantidad;
  if(tipo===100) fichas.verde += cantidad;
  renderFichas();
  alert('Canje realizado con √©xito');
});

// Mostrar salas
async function mostrarSalas(){
  const { data: salas } = await supabase.from('rooms').select('*').order('created_at',{ascending:true});
  salasContainer.innerHTML = '';
  salas.forEach(s=>{
    const div = document.createElement('div');
    div.style = 'background:#222;padding:10px;margin:6px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;';
    div.innerHTML = `<strong>${s.name}</strong><button>Unirse</button>`;
    div.querySelector('button').addEventListener('click', ()=> unirseASala(s.name));
    salasContainer.appendChild(div);
  });
}
refreshSalasBtn.addEventListener('click', mostrarSalas);

// Crear nueva sala
crearSalaBtn.addEventListener('click', async ()=>{
  const nombre = document.getElementById('nombreSala').value.trim();
  if(!nombre) return alert('Nombre vac√≠o');
  await supabase.from('rooms').insert([{ name:nombre }]);
  mostrarSalas();
});

// Unirse a sala
async function unirseASala(nombreSala){
  salaActual = nombreSala;
  salasCard.style.display = 'none';
  conversionCard.style.display = 'none';
  tableroContainer.style.display = 'flex';
  await actualizarTablero();
}

// Actualiza tablero
async function actualizarTablero(){
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
  const total = jugadores?.length || 1;
  jugadoresInfo.textContent = `Jugadores: ${total} / 5`;
  const posiciones = [pos1,pos2,pos3,pos4,pos5];
  posiciones.forEach((el,i)=>{
    const j = jugadores?.[i];
    el.querySelector('span').textContent = j ? j.player : '';
  });
}

// Salir
salirBtn.addEventListener('click', ()=>{
  salaActual = null;
  tableroContainer.style.display = 'none';
  salasCard.style.display = 'block';
  conversionCard.style.display = 'block';
  mostrarSalas();
});

window.addEventListener('DOMContentLoaded', mostrarSalas);
</script>
</body>
</html>
