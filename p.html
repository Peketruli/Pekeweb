<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas - Salas</title>
<style>
body { font-family: Arial, sans-serif; background:#1a1a1a; color:#fff; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center;}
h1, h2 { text-align:center; margin:10px 0;}
.crear-sala, .salas-container, .sala-activa { margin:20px; text-align:center; }
.sala, .jugador { background:#333; padding:15px; border-radius:10px; margin:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;}
button, input { padding:10px; border-radius:5px; border:none; margin:5px; }
button { cursor:pointer; background:#ff6600; color:#fff; }
button:disabled { opacity:0.4; cursor:default; }
.fichas button { margin:5px; }
</style>
</head>
<body>

<h1>Juego de Cartas - Salas</h1>

<!-- Contenedor de iniciar sesión -->
<div id="authContainer">
  <button id="loginBtn">Iniciar sesión / Registrarse</button>
</div>

<!-- Contenedor de usuario logueado -->
<div id="userInfo" style="display:none;">
  <span id="userName"></span>
</div>

<!-- Crear sala -->
<div class="crear-sala" id="crearSalaContainer" style="display:none;">
  <input type="text" id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear Sala</button>
</div>

<h2>Salas disponibles</h2>
<div class="salas-container" id="salasContainer"></div>

<div class="sala-activa" id="salaActiva" style="display:none;">
  <h2 id="nombreSalaActiva"></h2>
  <div id="jugadoresSala"></div>
  <h3>Apostar fichas</h3>
  <div class="fichas" id="fichasContainer"></div>
  <button id="startBtn" disabled>Iniciar Partida</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

let usuarioSesion = null;
const maxJugadoresPorSala = 5;
let salaActual = null;

// ---------- CARGAR USUARIO ----------
function loadUser() {
    usuarioSesion = JSON.parse(localStorage.getItem("currentUser"));
    const authContainer = document.getElementById("authContainer");
    const userInfo = document.getElementById("userInfo");
    const crearSalaContainer = document.getElementById("crearSalaContainer");
    if(usuarioSesion) {
        authContainer.style.display = "none";
        userInfo.style.display = "block";
        document.getElementById("userName").innerText = `Bienvenido, ${usuarioSesion.username || usuarioSesion.nombre || "Usuario"}`;
        crearSalaContainer.style.display = "block";
    } else {
        authContainer.style.display = "block";
        userInfo.style.display = "none";
        crearSalaContainer.style.display = "none";
    }
}

// ---------- MOSTRAR SALAS ----------
async function mostrarSalas() {
    const { data: salas } = await supabase.from('rooms').select('*').order('created_at', {ascending:true});
    const container = document.getElementById('salasContainer');
    container.innerHTML = '';
    salas.forEach(sala => {
        const salaDiv = document.createElement('div');
        salaDiv.classList.add('sala');

        const nombre = document.createElement('span');
        nombre.innerText = sala.name;

        const boton = document.createElement('button');
        boton.innerText = 'Unirse';
        boton.addEventListener('click', () => unirseASala(sala.id, sala.name));

        salaDiv.appendChild(nombre);
        salaDiv.appendChild(boton);
        container.appendChild(salaDiv);
    });
}

// ---------- CREAR SALA ----------
async function crearSala() {
    const nombre = document.getElementById('nombreSala').value.trim();
    if(!nombre) return alert("Introduce un nombre de sala");
    const { data } = await supabase.from('rooms').insert([{name: nombre}]).select().single();
    document.getElementById('nombreSala').value = '';
    await unirseASala(data.id, data.name);
    mostrarSalas();
}

// ---------- UNIRSE A SALA ----------
async function unirseASala(salaId, salaName) {
    if(!usuarioSesion) return alert("Debes iniciar sesión primero");
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaName);
    if(jugadores.length >= maxJugadoresPorSala) return alert("Sala llena");
    if(jugadores.some(j => j.user_id === usuarioSesion.id)) return alert("Ya estás en la sala");

    await supabase.from('card_game').insert([{
        user_id: usuarioSesion.id,
        player: usuarioSesion.username || usuarioSesion.nombre,
        room: salaName,
        hand: '',
        points: usuarioSesion.pekepuntos || 1000
    }]);

    salaActual = salaName;
    mostrarSalaActiva();
}

// ---------- MOSTRAR SALA ACTIVA ----------
async function mostrarSalaActiva() {
    if(!salaActual) return;
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
    document.getElementById('salaActiva').style.display = 'block';
    document.getElementById('nombreSalaActiva').innerText = `Sala: ${salaActual}`;

    const cont = document.getElementById('jugadoresSala');
    cont.innerHTML = '';
    jugadores.forEach(j => {
        const div = document.createElement('div');
        div.classList.add('jugador');
        div.innerText = `${j.player} - Pekepuntos: ${j.points} - Apuesta: ${j.apuesta || 0}`;
        cont.appendChild(div);
    });

    // Mostrar botones de apuestas
    const fichasContainer = document.getElementById('fichasContainer');
    fichasContainer.innerHTML = '';
    [1,5,25,100].forEach(valor => {
        const btn = document.createElement('button');
        btn.innerText = valor === 1 ? 'Blanca (1)' :
                        valor === 5 ? 'Roja (5)' :
                        valor === 25 ? 'Azul (25)' :
                        'Verde (100)';
        btn.addEventListener('click', () => apostar(valor));
        fichasContainer.appendChild(btn);
    });

    verificarApuestas(jugadores);
}

// ---------- APOSTAR ----------
async function apostar(valor) {
    if(!salaActual) return;
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
    const jugador = jugadores.find(j => j.user_id === usuarioSesion.id && (!j.apuesta || j.apuesta === 0));
    if(!jugador) return alert("Ya apostaste o no estás en la sala");
    if(jugador.points < valor) return alert("No tienes suficientes pekepuntos");

    await supabase.from('card_game').update({apuesta:valor, points: jugador.points - valor}).eq('id', jugador.id);
    mostrarSalaActiva();
}

// ---------- VERIFICAR APUESTAS ----------
function verificarApuestas(jugadores) {
    const todosApostaron = jugadores.length>0 && jugadores.every(j => j.apuesta && j.apuesta>0);
    document.getElementById('startBtn').disabled = !todosApostaron;
}

// ---------- INICIAR PARTIDA ----------
function iniciarPartida() {
    alert("¡La partida comienza!");
    // Aquí irá la lógica del juego de cartas
}

// ---------- EVENTOS ----------
document.getElementById('crearSalaBtn').addEventListener('click', crearSala);
document.getElementById('startBtn').addEventListener('click', iniciarPartida);
document.getElementById('loginBtn').addEventListener('click', () => window.location.href='l.html');

// ---------- INICIALIZACIÓN ----------
loadUser();
mostrarSalas();

// Hacer funciones globales (por si las quieres usar fuera)
window.crearSala = crearSala;
window.unirseASala = unirseASala;
window.apostar = apostar;
window.iniciarPartida = iniciarPartida;
</script>
</body>
</html>

