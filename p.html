<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Salas y Fichas Online</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
  h1 { text-align:center; color:#ff9a33; margin:10px 0; }

  .card {
    background:#1b1b1b; border-radius:10px; padding:14px;
    width:95%; max-width:960px; margin:12px auto;
  }
  button { background:#ff7f2a; color:#fff; border:none; padding:8px 12px;
    border-radius:8px; cursor:pointer; font-weight:bold; }
  button.secondary { background:#444; }
  input, select { padding:8px; border-radius:6px; border:1px solid #333; background:#0f0f0f; color:#fff; }

  /* === Tablero === */
  #tableroContainer {
    display:none; position:fixed; inset:0;
    background:radial-gradient(circle at center,#202020 0%,#0b0b0b 100%);
    flex-direction:row; align-items:stretch; justify-content:center; gap:10px; padding:10px;
  }

  #mesa {
    flex:1; position:relative;
    background:radial-gradient(circle at center,#144914 0%,#0a240a 100%);
    border-radius:50%; border:4px solid #222; box-shadow:inset 0 0 30px #000;
    display:flex; align-items:center; justify-content:center;
  }

  .jugador { position:absolute; text-align:center; font-size:14px; color:#fff; }
  .jugador span { color:#ffb866; }
  .jugador1 { bottom:10px; left:50%; transform:translateX(-50%); }
  .jugador2 { top:10px; left:50%; transform:translateX(-50%); }
  .jugador3 { left:10px; top:50%; transform:translateY(-50%); }
  .jugador4 { right:10px; top:50%; transform:translateY(-50%); }
  .jugador5 { top:25%; left:50%; transform:translateX(-50%); }

  #panelLateral {
    width:280px; background:#181818; border-radius:10px;
    padding:15px; display:flex; flex-direction:column; justify-content:space-between;
  }
</style>
</head>
<body>
<h1>Juego de Cartas â€” Online</h1>

<!-- === Fichas === -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos: <strong id="pekepuntosActuales">0</strong></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1">
  <button id="canjearBtn">Canjear</button>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- === Salas === -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <input id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear sala</button>
  <button id="refreshSalas" class="secondary">Actualizar</button>
  <div id="salasContainer"></div>
</div>

<!-- === Tablero === -->
<div id="tableroContainer">
  <div id="mesa">
    <div class="jugador jugador1" id="pos1"></div>
    <div class="jugador jugador2" id="pos2"></div>
    <div class="jugador jugador3" id="pos3"></div>
    <div class="jugador jugador4" id="pos4"></div>
    <div class="jugador jugador5" id="pos5"></div>
  </div>

  <div id="panelLateral">
    <div>
      <h3>InformaciÃ³n</h3>
      <div id="infoJugador"></div>
      <div id="fichasPanel"></div>
      <div id="jugadoresSala"></div>
    </div>
    <div>
      <button id="iniciarPartidaBtn">Iniciar partida</button>
      <button id="salirBtn" class="secondary">Salir</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = '<TU-CLAVE-PUBLICA>';
const supabase = createClient(supabaseUrl, supabaseKey);

// SimulaciÃ³n de login (puedes usar supabase.auth luego)
let usuario = JSON.parse(localStorage.getItem('currentUser')) || { id: crypto.randomUUID(), username: "Jugador"+Math.floor(Math.random()*1000) };
localStorage.setItem('currentUser', JSON.stringify(usuario));

let salaActual = null;

// === ELEMENTOS ===
const salasContainer = document.getElementById('salasContainer');
const salasCard = document.getElementById('salasCard');
const tableroContainer = document.getElementById('tableroContainer');
const conversionCard = document.getElementById('conversionCard');
const fichaResumen = document.getElementById('fichaResumen');
const pekepuntosActualesEl = document.getElementById('pekepuntosActuales');
const infoJugador = document.getElementById('infoJugador');
const fichasPanel = document.getElementById('fichasPanel');
const jugadoresSala = document.getElementById('jugadoresSala');
const iniciarPartidaBtn = document.getElementById('iniciarPartidaBtn');
const salirBtn = document.getElementById('salirBtn');

// Render fichas
async function renderFichas(){
  const user = await obtenerDatosUsuario();
  fichaResumen.textContent = `âšª ${user.ficha_blanca||0} ðŸ”´ ${user.ficha_roja||0} ðŸ”µ ${user.ficha_azul||0} ðŸŸ¢ ${user.ficha_verde||0}`;
  pekepuntosActualesEl.textContent = user.pekepuntos||0;
}

// Canjear
document.getElementById('canjearBtn').addEventListener('click', async ()=>{
  const tipo = Number(document.getElementById('tipoFicha').value);
  const cantidad = parseInt(document.getElementById('cantidadFichas').value);
  const user = await obtenerDatosUsuario();
  if(!cantidad || cantidad<=0) return alert('Cantidad invÃ¡lida');
  const total = tipo * cantidad;
  if(user.pekepuntos < total) return alert('No tienes suficientes pekepuntos');
  const cambios = {
    ficha_blanca: user.ficha_blanca||0,
    ficha_roja: user.ficha_roja||0,
    ficha_azul: user.ficha_azul||0,
    ficha_verde: user.ficha_verde||0,
    pekepuntos: user.pekepuntos - total
  };
  if(tipo===1) cambios.ficha_blanca += cantidad;
  if(tipo===5) cambios.ficha_roja += cantidad;
  if(tipo===25) cambios.ficha_azul += cantidad;
  if(tipo===100) cambios.ficha_verde += cantidad;
  await supabase.from('users').update(cambios).eq('id', usuario.id);
  renderFichas();
});

// Mostrar salas
async function mostrarSalas(){
  const { data: salas } = await supabase.from('rooms').select('*');
  salasContainer.innerHTML = '';
  salas.forEach(s=>{
    const players = s.players ? s.players.length : 0;
    const div = document.createElement('div');
    div.style = 'background:#222;padding:10px;margin:6px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;';
    div.innerHTML = `<strong>${s.name}</strong><span>${players}/5</span><button>Unirse</button>`;
    div.querySelector('button').addEventListener('click', ()=> unirseASala(s));
    salasContainer.appendChild(div);
  });
}

// Crear sala
document.getElementById('crearSalaBtn').addEventListener('click', async ()=>{
  const nombre = document.getElementById('nombreSala').value.trim();
  if(!nombre) return alert('Nombre vacÃ­o');
  const room = { name: nombre, players: [{id:usuario.id, username:usuario.username}] };
  const { data, error } = await supabase.from('rooms').insert([room]).select().single();
  if(error) return alert(error.message);
  await unirseASala(data, true);
});

async function obtenerDatosUsuario(){
  const { data } = await supabase.from('usuarios').select('*').eq('id', usuario.id).maybeSingle();
  if(!data){
    await supabase.from('usuarios').insert([{ 
      id: usuario.id, 
      username: usuario.username, 
      pekepuntos: 500,
      ficha_blanca: 0, ficha_roja: 0, ficha_azul: 0, ficha_verde: 0
    }]);
    return obtenerDatosUsuario();
  }
  return data;
}

// ...

async function unirseASala(room, esCreador=false){
  salaActual = room;
  const lista = Array.isArray(room.players) ? room.players : [];
  if(!lista.some(p=>p.id===usuario.id)){
    lista.push({id:usuario.id, username:usuario.username});
    await supabase.from('rooms').update({ players: lista }).eq('id', room.id);
  }
  salasCard.style.display='none';
  conversionCard.style.display='none';
  tableroContainer.style.display='flex';
  iniciarPartidaBtn.style.display = esCreador ? 'block' : 'none';
  actualizarPanel();
}

// ...

async function actualizarPanel(){
  const { data: sala } = await supabase.from('rooms').select('*').eq('id', salaActual.id).single();
  const jugadores = Array.isArray(sala.players) ? sala.players : [];
  infoJugador.innerHTML = `<strong>${usuario.username}</strong><br>Sala: ${sala.name}`;
  fichasPanel.innerHTML = fichaResumen.textContent;
  jugadoresSala.innerHTML = `<h4>Jugadores (${jugadores.length})</h4>` +
    jugadores.map(j=>`<div>ðŸ‘¤ ${j.username}</div>`).join('');
}


document.getElementById('refreshSalas').addEventListener('click', mostrarSalas);

// === INIT ===
window.addEventListener('DOMContentLoaded', async ()=>{
  await renderFichas();
  await mostrarSalas();
});
</script>
</body>
</html>
