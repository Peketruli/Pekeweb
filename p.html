<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PÃ³ker Online</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
/* --- ESTILOS --- */
body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#1f2937,#4b5563); color: #fff; margin:0; padding:0; }
header { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:#111827; box-shadow:0 2px 6px rgba(0,0,0,0.5); }
#userInfo { display:flex; align-items:center; gap:10px; }
#userLogo { width:40px; height:40px; border-radius:50%; border:2px solid #fff; }
main { padding:20px; text-align:center; }
button { padding:10px 20px; margin:5px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
button.primary { background:#3b82f6; color:white; } button.primary:hover { background:#2563eb; }
button.danger { background:#ef4444; color:white; } button.danger:hover { background:#b91c1c; }
button.sala-btn { background:#10b981; color:white; } button.sala-btn:hover { background:#059669; }
#salas { margin-top:15px; }
#juego { display:none; margin-top:20px; }
.carta { display:inline-block; width:60px; height:90px; line-height:90px; border:2px solid #fff; border-radius:10px; margin:5px; background:#fff; color:#000; font-weight:bold; font-size:20px; cursor:pointer; }
.carta:hover { background:#f3f4f6; color:#000; }
.ficha { display:inline-block; width:50px; height:50px; border-radius:50%; margin:5px; line-height:50px; font-weight:bold; cursor:pointer; border:2px solid #fff; }
#fichasJugador { margin-top:10px; }
#estadoJuego { margin-top:15px; text-align:left; }
#cartasComunitarias { margin-top:10px; }
</style>
</head>
<body>

<header>
<h2>ðŸŽ´ PÃ³ker Online</h2>
<div id="userInfo">
  <img id="userLogo" src="logoDefault.png" alt="Logo">
  <span id="userName"></span>
  <button id="logoutBtn" class="danger">Cerrar sesiÃ³n</button>
</div>
</header>

<main>
<div id="zonaInicial">
<h3>Pekepuntos â†’ Fichas</h3>
<input type="number" id="depositoCantidad" placeholder="Cantidad a cambiar" min="1">
<button id="depositarBtn" class="primary">Cambiar</button>
<div id="fichasJugador"></div>
<hr>
<button id="crearBtn" class="primary">Crear nueva sala</button>
<h3>Salas disponibles</h3>
<div id="salas">Cargando salas...</div>
</div>

<div id="juego">
<h3>Sala: <span id="salaCodigo"></span></h3>
<div id="estadoJuego"></div>
<div>
<h4>Cartas Comunitarias</h4>
<div id="cartasComunitarias"></div>
</div>
<div>
<h4>Tu Mano</h4>
<div id="manoJugador"></div>
</div>
<div>
<h4>Apuestas</h4>
<input type="number" id="montoApuesta" placeholder="Cantidad a apostar" min="1">
<button id="apostarBtn" class="primary">Apostar</button>
</div>
<button id="salirSalaBtn" class="danger">Salir de la sala</button>
</div>
</main>

<script>
// --- SUPABASE ---
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'TU_SUPABASE_KEY_AQUI';
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- VARIABLES ---
let usuarioActual = null;
let salaActual = '';
let manoJugador = [];
let cartasComunitarias = [];
let fichas = {1:0,5:0,25:0,100:0};
let intervaloActualizacion = null;

// --- USUARIO ---
async function cargarUsuario(){
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if(!user){ alert('Inicia sesiÃ³n'); window.location.href='login.html'; return; }
  usuarioActual = user.username;
  document.getElementById('userName').textContent = usuarioActual;
  document.getElementById('userLogo').src = user.logo || 'logoDefault.png';
}

// --- FICHAS ---
function mostrarFichas(){
  const div = document.getElementById('fichasJugador'); div.innerHTML='';
  const colores={1:'#fff',5:'#ef4444',25:'#3b82f6',100:'#10b981'};
  for(const [v,c] of Object.entries(fichas)){
    if(c>0){
      const chip=document.createElement('div'); chip.className='ficha';
      chip.style.background=colores[v];
      chip.style.color=(v==1)?'#000':'#fff';
      chip.textContent=`${v}x${c}`;
      div.appendChild(chip);
    }
  }
}
document.getElementById('depositarBtn').onclick=async()=>{
  const cantidad=parseInt(document.getElementById('depositoCantidad').value);
  if(!cantidad || cantidad<=0) return alert('Cantidad invÃ¡lida');
  const { data:user }=await supabase.from('usuarios').select('pekepuntos').eq('username',usuarioActual).single();
  if(!user || user.pekepuntos<cantidad) return alert('No tienes suficientes Pekepuntos');
  await supabase.from('usuarios').update({pekepuntos:user.pekepuntos-cantidad}).eq('username',usuarioActual);
  let restante=cantidad; [100,25,5,1].forEach(v=>{ const num=Math.floor(restante/v); fichas[v]+=num; restante-=num*v; });
  mostrarFichas();
};

// --- LOGOUT ---
document.getElementById('logoutBtn').onclick=()=>{
  localStorage.removeItem('currentUser'); window.location.href='login.html';
};

// --- SALAS ---
async function listarSalas(){
  const div=document.getElementById('salas'); div.innerHTML='Cargando salas...';
  const { data,error }=await supabase.from('rooms').select('*').order('created_at',{ascending:false});
  if(error){ div.innerHTML='Error al cargar salas'; console.error(error); return; }
  if(!data || data.length===0){ div.innerHTML='No hay salas'; return; }
  div.innerHTML='';
  data.forEach(sala=>{
    const btn=document.createElement('button'); btn.textContent=`Unirse a ${sala.name}`;
    btn.className='sala-btn'; btn.onclick=()=>unirseASala(sala.name);
    div.appendChild(btn);
  });
}
document.getElementById('crearBtn').onclick=async()=>{
  const codigo='sala_'+Math.floor(Math.random()*10000);
  await supabase.from('rooms').insert([{name:codigo, created_by:usuarioActual}]);
  listarSalas(); alert('Sala creada: '+codigo);
};

// --- CARTAS ---
function crearBaraja(){ const palos=['â™ ','â™¥','â™¦','â™£']; const valores=['A','2','3','4','5','6','7','8','9','10','J','Q','K']; const baraja=[]; for(let palo of palos) for(let val of valores) baraja.push(val+palo); return baraja; }
function barajar(baraja){ for(let i=baraja.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [baraja[i],baraja[j]]=[baraja[j],baraja[i]]; } }
function mostrarMano(){ const div=document.getElementById('manoJugador'); div.innerHTML=''; manoJugador.forEach(c=>{ const d=document.createElement('div'); d.className='carta'; d.textContent=c; div.appendChild(d); }); }
function mostrarComunitarias(){ const div=document.getElementById('cartasComunitarias'); div.innerHTML=''; cartasComunitarias.forEach(c=>{ const d=document.createElement('div'); d.className='carta'; d.textContent=c; div.appendChild(d); }); }

// --- UNIRSE ---
async function unirseASala(nombreSala){
  salaActual=nombreSala; document.getElementById('zonaInicial').style.display='none'; document.getElementById('juego').style.display='block';
  document.getElementById('salaCodigo').textContent=salaActual;
  const baraja=crearBaraja(); barajar(baraja);
  manoJugador=baraja.splice(0,2); cartasComunitarias=baraja.splice(0,5);
  mostrarMano(); mostrarComunitarias();
  const { data: existe }=await supabase.from('card_game').select('*').eq('player',usuarioActual).eq('room',salaActual).maybeSingle();
  if(!existe){ await supabase.from('card_game').insert([{player:usuarioActual, room:salaActual, hand:manoJugador, played:null, bet:null, fichas}]); }
  if(intervaloActualizacion) clearInterval(intervaloActualizacion);
  intervaloActualizacion=setInterval(actualizarEstado,2000);
}

// --- ACTUALIZAR SALA ---
async function actualizarEstado(){
  if(!salaActual) return; const div=document.getElementById('estadoJuego');
  const { data: jugadores }=await supabase.from('card_game').select('*').eq('room',salaActual);
  div.innerHTML='<h4>Jugadores en sala</h4>';
  if(!jugadores || jugadores.length===0){ div.innerHTML+='<p>(ninguno aÃºn)</p>'; return; }
  jugadores.forEach(j=>{ div.innerHTML+=`<p>${j.player} - Fichas: ${JSON.stringify(j.fichas)} - Apuesta: ${j.bet||0}</p>`; });
}

// --- APOSTAR ---
document.getElementById('apostarBtn').onclick=async()=>{
  const monto=parseInt(document.getElementById('montoApuesta').value);
  if(!monto || monto<=0) return alert('Cantidad invÃ¡lida');
  await supabase.from('card_game').update({ bet:monto }).eq('player',usuarioActual).eq('room',salaActual);
  actualizarEstado();
};

// --- SALIR ---
document.getElementById('salirSalaBtn').onclick=async()=>{
  if(!salaActual) return;
  await supabase.from('card_game').delete().eq('player',usuarioActual).eq('room',salaActual);
  salaActual=''; document.getElementById('juego').style.display='none'; document.getElementById('zonaInicial').style.display='block';
  if(intervaloActualizacion) clearInterval(intervaloActualizacion); listarSalas();
};

// --- INICIO ---
window.onload=()=>{
  cargarUsuario(); listarSalas(); mostrarFichas();
};
</script>
</body>
</html>
