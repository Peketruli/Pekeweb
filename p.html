<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Diagn√≥stico de sesi√≥n</title>
<style>
  body{font-family:Arial,sans-serif;background:#111;color:#eee;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;}
  .card{background:#1b1b1b;border-radius:10px;padding:14px;width:95%;max-width:980px;margin:12px 0;border:1px solid rgba(255,140,50,0.06);}
  h1{color:#ff9a33;text-align:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:#ff7f2a;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#444}
  .small{font-size:13px;color:#ccc}
  .klist{background:#0f0f0f;padding:8px;border-radius:8px;max-height:180px;overflow:auto}
  .kitem{padding:8px;border-radius:6px;margin-bottom:8px;background:linear-gradient(180deg,#151515,#111);display:flex;justify-content:space-between;align-items:center}
  pre{white-space:pre-wrap;word-break:break-word;color:#dcdcdc;background:transparent;margin:6px 0}
  .hidden{display:none}
  .fichaResumen span{margin-right:12px}
  .sala {display:flex;justify-content:space-between;align-items:center;background:#222;padding:10px;border-radius:8px;margin:8px 0}
  input,select,textarea{padding:8px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff}
  textarea{resize:none;}
</style>
</head>
<body>

<h1>Juego de Cartas ‚Äî Diagn√≥stico de sesi√≥n</h1>

<!-- DIAGN√ìSTICO -->
<div class="card" id="diagCard">
  <h3>Diagn√≥stico de session storage / localStorage</h3>
  <p class="small">Esta herramienta buscar√° autom√°ticamente objetos en <code>localStorage</code> que parezcan ser tu sesi√≥n.</p>
  <div class="row" style="margin-bottom:8px;">
    <button id="scanBtn">üîé Detectar sesi√≥n en localStorage</button>
    <button id="forceBtn" class="secondary">üìù Forzar sesi√≥n manual (JSON)</button>
    <button id="clearDetected" class="secondary">üóëÔ∏è Borrar currentUser</button>
    <span id="diagStatus" class="small" style="margin-left:6px"></span>
  </div>

  <div id="scanResults" class="klist hidden"></div>

  <div id="manualArea" class="hidden" style="margin-top:8px"></div>
</div>

<!-- RESUMEN SESI√ìN ACTUAL -->
<div class="card" id="sessionCard">
  <h3>Sesi√≥n detectada</h3>
  <div id="sessionInfo">Ninguna sesi√≥n activa</div>
  <pre id="sessionRaw" class="hidden"></pre>
</div>

<!-- CONVERSION / FICHAS -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <div id="conversionUi">
    <p class="small">Pekepuntos actuales: <strong id="pekepuntosActuales">0</strong></p>
    <div class="row" style="margin-bottom:8px">
      <select id="tipoFicha"><option value="1">Blanca (1)</option><option value="5">Roja (5)</option><option value="25">Azul (25)</option><option value="100">Verde (100)</option></select>
      <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" style="width:120px" />
      <button id="canjearBtn">Canjear</button>
    </div>
    <div><strong>Mis fichas:</strong> <span class="fichaResumen" id="fichaResumen"></span></div>
  </div>
  <div id="noSessionConv" class="small hidden">Inicia sesi√≥n para utilizar la conversi√≥n.</div>
</div>

<!-- SALAS -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <div style="margin-bottom:8px" class="row">
    <input id="nombreSala" placeholder="Nombre de la sala" style="flex:1;max-width:360px" />
    <button id="crearSalaBtn">Crear sala</button>
    <button id="refreshSalas" class="secondary">Actualizar</button>
  </div>
  <div id="salasContainer"></div>
</div>

<!-- SALA ACTIVA -->
<div class="card hidden" id="salaActivaCard">
  <h3 id="nombreSalaActiva">Sala: ‚Äî</h3>
  <div id="jugadoresSala"></div>
  <h4>Apostar (usa fichas)</h4>
  <div id="fichasContainer" class="row"></div>
  <div style="margin-top:10px"><button id="startBtn" disabled>Iniciar Partida</button></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- CONFIG SUPABASE ---
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

// --- ESTADO ---
let usuarioSesion = null;
let fichas = { blanca:0, roja:0, azul:0, verde:0 };
let salaActual = null;
const maxJugadoresPorSala = 5;

// --- ELEMENTOS UI ---
const scanBtn = document.getElementById('scanBtn');
const scanResults = document.getElementById('scanResults');
const diagStatus = document.getElementById('diagStatus');
const sessionInfo = document.getElementById('sessionInfo');
const sessionRaw = document.getElementById('sessionRaw');
const conversionUi = document.getElementById('conversionUi');
const noSessionConv = document.getElementById('noSessionConv');
const pekepuntosActualesEl = document.getElementById('pekepuntosActuales');
const fichaResumen = document.getElementById('fichaResumen');
const canjearBtn = document.getElementById('canjearBtn');
const tipoFichaSel = document.getElementById('tipoFicha');
const cantidadFichasInp = document.getElementById('cantidadFichas');
const crearSalaBtn = document.getElementById('crearSalaBtn');
const salasContainer = document.getElementById('salasContainer');
const refreshSalasBtn = document.getElementById('refreshSalas');
const salaActivaCard = document.getElementById('salaActivaCard');
const nombreSalaActivaEl = document.getElementById('nombreSalaActiva');
const jugadoresSalaEl = document.getElementById('jugadoresSala');
const fichasContainer = document.getElementById('fichasContainer');
const startBtn = document.getElementById('startBtn');
const forceBtn = document.getElementById('forceBtn');
const manualArea = document.getElementById('manualArea');

// --- UTIL ---
function isLikelyUser(obj){
  if(!obj || typeof obj !== 'object') return false;
  const keys = Object.keys(obj).map(k=>k.toLowerCase());
  return keys.includes('username') || keys.includes('nombre') || keys.includes('user');
}

function quantityOrFix(v){ return Number.isInteger(v)?v:Math.floor(v); }

// --- SESI√ìN ---
function loadUserFromLocal(){
  usuarioSesion = null;
  const posibles = ["currentUser","usuario","user","session"];
  for(const k of posibles){
    const val = localStorage.getItem(k);
    if(!val) continue;
    try{
      const parsed = JSON.parse(val);
      if(isLikelyUser(parsed)){
        usuarioSesion = parsed;
        localStorage.setItem('currentUser', JSON.stringify(parsed));
        break;
      }
    }catch(e){}
  }
  // fallback: buscar cualquier clave
  if(!usuarioSesion){
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(posibles.includes(k)) continue;
      const val = localStorage.getItem(k);
      try{
        const parsed = JSON.parse(val);
        if(isLikelyUser(parsed)){
          usuarioSesion = parsed;
          localStorage.setItem('currentUser', JSON.stringify(parsed));
          break;
        }
      }catch(e){}
    }
  }
  // fallback de prueba si no hay usuario
  if(!usuarioSesion){
    usuarioSesion = { username:'Invitado', pekepuntos:500 };
    localStorage.setItem('currentUser', JSON.stringify(usuarioSesion));
  }
  updateSessionUI();
  loadFichasFromStorage();
}

// --- UI SESI√ìN ---
function updateSessionUI(){
  if(usuarioSesion){
    sessionInfo.innerHTML = `<strong>${usuarioSesion.username}</strong> ‚Äî id: ${usuarioSesion.id||'n/a'}`;
    sessionRaw.classList.remove('hidden');
    sessionRaw.textContent = JSON.stringify(usuarioSesion,null,2);
    conversionUi.classList.remove('hidden');
    noSessionConv.classList.add('hidden');
    pekepuntosActualesEl.textContent = usuarioSesion.pekepuntos ?? 0;
  } else {
    sessionInfo.innerText = 'Ninguna sesi√≥n activa';
    sessionRaw.classList.add('hidden');
    conversionUi.classList.add('hidden');
    noSessionConv.classList.remove('hidden');
    pekepuntosActualesEl.textContent = '0';
    fichaResumen.innerHTML = '';
  }
}

// --- FICHAS ---
function loadFichasFromStorage(){
  try{
    const fs = JSON.parse(localStorage.getItem('fichas'));
    if(fs && typeof fs === 'object') fichas = Object.assign(fichas, fs);
  }catch(e){}
  renderFichas();
}
function renderFichas(){
  fichaResumen.innerHTML = `‚ö™ ${fichas.blanca}  üî¥ ${fichas.roja}  üîµ ${fichas.azul}  üü¢ ${fichas.verde}`;
  localStorage.setItem('fichas', JSON.stringify(fichas));
}

// --- CANJEAR ---
canjearBtn.addEventListener('click', ()=>{
  if(!usuarioSesion) return alert('No hay sesi√≥n');
  const tipo = Number(tipoFichaSel.value);
  const cantidad = parseInt(cantidadFichasInp.value,10);
  if(!cantidad || cantidad<=0) return alert('Cantidad inv√°lida');
  const pekes = usuarioSesion.pekepuntos ?? 0;
  const total = tipo * cantidad;
  if(pekes < total) return alert('No tienes suficientes pekepuntos');
  usuarioSesion.pekepuntos -= total;
  localStorage.setItem('currentUser', JSON.stringify(usuarioSesion));
  pekepuntosActualesEl.textContent = usuarioSesion.pekepuntos;
  if(tipo===1) fichas.blanca += cantidad;
  if(tipo===5) fichas.roja += quantityOrFix(cantidad);
  if(tipo===25) fichas.azul += cantidad;
  if(tipo===100) fichas.verde += cantidad;
  renderFichas();
  cantidadFichasInp.value='';
  alert('Canje realizado.');
});

// --- SALAS ---
async function mostrarSalas(){
  try{
    const { data: salas } = await supabase.from('rooms').select('*').order('created_at',{ascending:true});
    salasContainer.innerHTML = '';
    salas.forEach(s=>{
      const div = document.createElement('div');
      div.className='sala';
      const left = document.createElement('div'); 
      left.innerHTML = `<strong>${s.name}</strong><div class="small">creada: ${new Date(s.created_at).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const btn = document.createElement('button'); btn.innerText='Unirse';
      btn.addEventListener('click', ()=> unirseASala(s.id,s.name));
      right.appendChild(btn);
      div.appendChild(left); div.appendChild(right);
      salasContainer.appendChild(div);
    });
  }catch(e){ salasContainer.innerHTML='<div class="small">Error al cargar salas</div>'; }
}
refreshSalasBtn.addEventListener('click', mostrarSalas);

async function crearSala(){
  if(!usuarioSesion) return alert('Debes tener sesi√≥n');
  const nombre = document.getElementById('nombreSala').value.trim();
  if(!nombre) return alert('Nombre vac√≠o');
  const { data, error } = await supabase.from('rooms').insert([{ name:nombre }]).select().single();
  if(error) return alert('Error creando sala: '+(error.message||error));
  document.getElementById('nombreSala').value='';
  await unirseASala(data.id,data.name);
  await mostrarSalas();
}
crearSalaBtn.addEventListener('click', crearSala);

// --- UNIRSE ---
async function unirseASala(roomId, roomName){
  if(!usuarioSesion) return alert('Debes iniciar sesi√≥n');
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', roomName);
  if(jugadores && jugadores.length >= maxJugadoresPorSala) return alert('Sala llena');
  if(jugadores && jugadores.some(j=> j.user_id === (usuarioSesion.id||null))) return alert('Ya est√°s en la sala');
  const inserir = { user_id: usuarioSesion.id||null, player: usuarioSesion.username, room: roomName, hand:null, points: usuarioSesion.pekepuntos??0 };
  const { error } = await supabase.from('card_game').insert([inserir]);
  if(error) return alert('Error al unirse: '+(error.message||error));
  salaActual = roomName;
  mostrarSalaActiva(roomName);
}

// --- MOSTRAR SALA ACTIVA ---
async function mostrarSalaActiva(roomName){
  salaActivaCard.classList.remove('hidden');
  nombreSalaActivaEl.innerText = `Sala: ${roomName}`;
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', roomName);
  jugadoresSalaEl.innerHTML='';
  jugadores.forEach(j=>{
    const div = document.createElement('div'); div.className='small'; div.innerText = `${j.player} ‚Äî pekepuntos: ${j.points} ‚Äî apuesta: ${j.apuesta||0}`;
    jugadoresSalaEl.appendChild(div);
  });
  fichasContainer.innerHTML='';
  [[1,'Blanca'],[5,'Roja'],[25,'Azul'],[100,'Verde']].forEach(([v,label])=>{
    const b = document.createElement('button'); b.innerText = `${label} (${v})`;
    b.addEventListener('click', ()=> apostarConFichas(v));
    fichasContainer.appendChild(b);
  });
  verificarApuestas(jugadores);
}

// --- APOSTAR ---
async function apostarConFichas(valor){
  if(!salaActual) return alert('No est√°s en sala');
  const tipo = valor===1?'blanca':valor===5?'roja':valor===25?'azul':'verde';
  if(fichas[tipo]<=0) return alert(`No tienes fichas ${tipo}`);
  fichas[tipo]-=1;
  renderFichas();
  const idUsuario = usuarioSesion.id||null;
  const { data: registros } = await supabase.from('card_game').select('*').eq('room', salaActual).eq('user_id', idUsuario);
  if(!registros || registros.length===0) return alert('Registro no encontrado.');
  const reg = registros[0];
  const nuevaApuesta = (reg.apuesta||0)+valor;
  await supabase.from('card_game').update({apuesta:nuevaApuesta, points:(reg.points||0)-valor}).eq('id',reg.id);
  mostrarSalaActiva(salaActual);
}

// --- VERIFICAR APUESTAS ---
function verificarApuestas(jugadores){
  const todosApostaron = jugadores.length>0 && jugadores.every(j => j.apuesta && j.apuesta>0);
  startBtn.disabled = !todosApostaron;
}

// start btn
startBtn.addEventListener('click', ()=> alert('Comienza la partida ‚Äî l√≥gica por implementar'));

// --- DIAGN√ìSTICO ---
scanBtn.addEventListener('click', ()=> { scanResults.classList.remove('hidden'); scanLocalStorage(); });

document.getElementById('clearDetected').addEventListener('click', ()=>{
  localStorage.removeItem('currentUser');
  usuarioSesion = null;
  updateSessionUI();
  alert('currentUser borrado de localStorage.');
});

// --- MANUAL ---
forceBtn.addEventListener('click', ()=> {
  manualArea.classList.toggle('hidden');
  if(manualArea.classList.contains('hidden')) return;
  manualArea.innerHTML = `
    <p class="small">Pega aqu√≠ el JSON que representa al usuario:</p>
    <textarea id="manualJson" rows="5"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="applyManual">Aplicar JSON</button>
    </div>
  `;
  document.getElementById('applyManual').addEventListener('click', ()=>{
    try{
      const val = JSON.parse(document.getElementById('manualJson').value);
      if(!isLikelyUser(val)) return alert('JSON inv√°lido');
      usuarioSesion = val;
      localStorage.setItem('currentUser', JSON.stringify(val));
      updateSessionUI();
      alert('Usuario aplicado.');
    }catch(e){ alert('JSON inv√°lido'); }
  });
});

// --- SCAN LOCALSTORAGE ---
function scanLocalStorage(){
  scanResults.innerHTML = '';
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    const val = localStorage.getItem(k);
    let parsed=null;
    try{ parsed=JSON.parse(val); }catch(e){ continue; }
    if(isLikelyUser(parsed)){
      const div = document.createElement('div'); div.className='kitem';
      div.innerHTML = `<span>${k}: ${JSON.stringify(parsed)}</span> <button>Aplicar</button>`;
      div.querySelector('button').addEventListener('click', ()=>{
        usuarioSesion = parsed;
        localStorage.setItem('currentUser', JSON.stringify(parsed));
        updateSessionUI();
        alert(`Usuario ${parsed.username||parsed.user||'n/a'} aplicado`);
      });
      scanResults.appendChild(div);
    }
  }
}

window.addEventListener('DOMContentLoaded', async ()=>{
  loadUserFromLocal();
  await mostrarSalas();
});
</script>
</body>
</html>
