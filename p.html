<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Salas y Tablero</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    margin: 0;
    padding: 0;
  }

  h1 {
    text-align: center;
    color: #ff9a33;
    margin-top: 10px;
  }

  .card {
    background: #1b1b1b;
    border-radius: 10px;
    padding: 14px;
    width: 95%;
    max-width: 960px;
    margin: 12px auto;
    border: 1px solid rgba(255,140,50,0.1);
  }

  button {
    background: #ff7f2a;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }
  button.secondary { background: #444; }
  input, select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #333;
    background: #0f0f0f;
    color: #fff;
  }

  /* === TABLERO === */
  #tableroContainer {
    display: none;
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at center, #202020 0%, #0b0b0b 100%);
    flex-direction: row;
    align-items: stretch;
    justify-content: center;
    gap: 10px;
    padding: 10px;
  }

  /* Mesa central */
  #mesa {
    flex: 1;
    position: relative;
    background: radial-gradient(circle at center, #144914 0%, #0a240a 100%);
    border-radius: 50%;
    border: 4px solid #222;
    box-shadow: inset 0 0 30px #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Panel lateral */
  #panelLateral {
    width: 280px;
    background: #181818;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  #panelLateral h3 {
    margin-top: 0;
    color: #ff9a33;
  }

  .infoJugador {
    font-size: 15px;
    margin-bottom: 15px;
  }

  .fichasPanel span {
    display: inline-block;
    width: 100%;
    margin: 2px 0;
  }

  /* Huecos para cartas */
  .cartasMesa {
    display: flex;
    gap: 10px;
  }

  .huecoCarta {
    width: 70px;
    height: 100px;
    border: 2px dashed rgba(255,255,255,0.3);
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
  }

  /* Posiciones de jugadores */
  .jugador {
    position: absolute;
    text-align: center;
    color: #fff;
    font-size: 14px;
  }

  .jugador span { color: #ffb866; }

  .jugador1 { bottom: 10px; left: 50%; transform: translateX(-50%); }
  .jugador2 { top: 10px; left: 50%; transform: translateX(-50%); }
  .jugador3 { left: 10px; top: 50%; transform: translateY(-50%); }
  .jugador4 { right: 10px; top: 50%; transform: translateY(-50%); }
  .jugador5 { top: 25%; left: 50%; transform: translateX(-50%); }
</style>
</head>
<body>

<h1>Juego de Cartas â€” Fichas y Salas</h1>

<!-- CONVERSIÃ“N -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos actuales: <strong id="pekepuntosActuales">0</strong></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1">
  <button id="canjearBtn">Canjear</button>
  <div><strong>Mis fichas:</strong> <span id="fichaResumen"></span></div>
</div>

<!-- SALAS -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <input id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear sala</button>
  <button id="refreshSalas" class="secondary">Actualizar</button>
  <div id="salasContainer"></div>
</div>

<!-- TABLERO -->
<div id="tableroContainer">
  <div id="mesa">
    <div class="jugador jugador1" id="pos1"><div>Jugador 1<span></span></div></div>
    <div class="jugador jugador2" id="pos2"><div>Jugador 2<span></span></div></div>
    <div class="jugador jugador3" id="pos3"><div>Jugador 3<span></span></div></div>
    <div class="jugador jugador4" id="pos4"><div>Jugador 4<span></span></div></div>
    <div class="jugador jugador5" id="pos5"><div>Jugador 5<span></span></div></div>
    <div class="cartasMesa">
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
      <div class="huecoCarta"></div>
    </div>
  </div>

  <!-- Panel lateral -->
  <div id="panelLateral">
    <div>
      <h3>InformaciÃ³n</h3>
      <div class="infoJugador" id="infoJugador"></div>
      <div class="fichasPanel" id="fichasPanel"></div>
    </div>
    <div>
      <button id="iniciarPartidaBtn">Iniciar partida</button>
      <button id="salirBtn" class="secondary">Salir</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

// Variables globales
let usuarioSesion = JSON.parse(localStorage.getItem('currentUser')) || { username: "Invitado", pekepuntos: 500 };
let fichas = JSON.parse(localStorage.getItem('fichas')) || { blanca:0, roja:0, azul:0, verde:0 };
let salaActual = null;

// Elementos
const salasContainer = document.getElementById('salasContainer');
const crearSalaBtn = document.getElementById('crearSalaBtn');
const refreshSalasBtn = document.getElementById('refreshSalas');
const conversionCard = document.getElementById('conversionCard');
const salasCard = document.getElementById('salasCard');
const tableroContainer = document.getElementById('tableroContainer');
const salirBtn = document.getElementById('salirBtn');
const iniciarPartidaBtn = document.getElementById('iniciarPartidaBtn');
const infoJugador = document.getElementById('infoJugador');
const fichasPanel = document.getElementById('fichasPanel');
const pekepuntosActualesEl = document.getElementById('pekepuntosActuales');
const fichaResumen = document.getElementById('fichaResumen');

// Mostrar fichas
function renderFichas(){
  fichaResumen.textContent = `âšª ${fichas.blanca} ðŸ”´ ${fichas.roja} ðŸ”µ ${fichas.azul} ðŸŸ¢ ${fichas.verde}`;
  localStorage.setItem('fichas', JSON.stringify(fichas));
  pekepuntosActualesEl.textContent = usuarioSesion.pekepuntos;
}
renderFichas();

// Canje
document.getElementById('canjearBtn').addEventListener('click', ()=>{
  const tipo = Number(document.getElementById('tipoFicha').value);
  const cantidad = parseInt(document.getElementById('cantidadFichas').value);
  if(!cantidad || cantidad<=0) return alert('Cantidad invÃ¡lida');
  const total = tipo * cantidad;
  if(usuarioSesion.pekepuntos < total) return alert('No tienes suficientes pekepuntos');
  usuarioSesion.pekepuntos -= total;
  if(tipo===1) fichas.blanca += cantidad;
  if(tipo===5) fichas.roja += cantidad;
  if(tipo===25) fichas.azul += cantidad;
  if(tipo===100) fichas.verde += cantidad;
  renderFichas();
  alert('Canje realizado');
});

// Mostrar salas
async function mostrarSalas(){
  const { data: salas } = await supabase.from('rooms').select('*').order('created_at',{ascending:true});
  salasContainer.innerHTML = '';
  salas.forEach(s=>{
    const div = document.createElement('div');
    div.style = 'background:#222;padding:10px;margin:6px 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;';
    div.innerHTML = `<strong>${s.name}</strong><button>Unirse</button>`;
    div.querySelector('button').addEventListener('click', ()=> unirseASala(s.name));
    salasContainer.appendChild(div);
  });
}
refreshSalasBtn.addEventListener('click', mostrarSalas);

// Crear sala â†’ se une instantÃ¡neamente
crearSalaBtn.addEventListener('click', async ()=>{
  const nombre = document.getElementById('nombreSala').value.trim();
  if(!nombre) return alert('Nombre vacÃ­o');
  const { data, error } = await supabase.from('rooms').insert([{ name:nombre }]).select().single();
  if(error) return alert('Error al crear sala');
  await unirseASala(nombre, true); // true = creador
});

// Unirse a sala
async function unirseASala(nombreSala, esCreador = false){
  salaActual = nombreSala;
  salasCard.style.display = 'none';
  conversionCard.style.display = 'none';
  tableroContainer.style.display = 'flex';
  iniciarPartidaBtn.style.display = esCreador ? 'block' : 'none';
  actualizarPanelLateral();
}

// Panel lateral
function actualizarPanelLateral(){
  infoJugador.innerHTML = `
    <strong>${usuarioSesion.username}</strong><br>
    Sala: ${salaActual}
  `;
  fichasPanel.innerHTML = `
    <span>âšª Blancas: ${fichas.blanca}</span>
    <span>ðŸ”´ Rojas: ${fichas.roja}</span>
    <span>ðŸ”µ Azules: ${fichas.azul}</span>
    <span>ðŸŸ¢ Verdes: ${fichas.verde}</span>
  `;
}

// Salir
salirBtn.addEventListener('click', ()=>{
  salaActual = null;
  tableroContainer.style.display = 'none';
  salasCard.style.display = 'block';
  conversionCard.style.display = 'block';
  mostrarSalas();
});

// Inicializar
window.addEventListener('DOMContentLoaded', ()=>{
  salaActual = null;
  tableroContainer.style.display = 'none';
  salasCard.style.display = 'block';
  conversionCard.style.display = 'block';
  mostrarSalas();
});
</script>
</body>
</html>
