<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas - Salas</title>
<style>
body { font-family: Arial, sans-serif; background:#1a1a1a; color:#fff; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center;}
h1, h2 { text-align:center; margin:10px 0;}
.crear-sala, .salas-container, .sala-activa { margin:20px; text-align:center; }
.sala, .jugador { background:#333; padding:15px; border-radius:10px; margin:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;}
button, input, select { padding:10px; border-radius:5px; border:none; margin:5px; }
button { cursor:pointer; background:#ff6600; color:#fff; }
button:disabled { opacity:0.4; cursor:default; }
.fichas button { margin:5px; }
#conversionContainer { background:#222; padding:15px; border-radius:10px; margin-bottom:20px; width:90%; max-width:500px; text-align:center; }
.fichaResumen span { margin:0 10px; }
</style>
</head>
<body>

<h1>Juego de Cartas - Salas</h1>

<!-- Iniciar sesiÃ³n -->
<div id="authContainer">
  <button id="loginBtn">Iniciar sesiÃ³n / Registrarse</button>
</div>

<!-- Usuario logueado -->
<div id="userInfo" style="display:none;">
  <span id="userName"></span>
</div>

<!-- ConversiÃ³n de pekepuntos -->
<div id="conversionContainer" style="display:none;">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <p>Pekepuntos actuales: <span id="pekepuntosActuales">0</span></p>
  <select id="tipoFicha">
    <option value="1">Blanca (1)</option>
    <option value="5">Roja (5)</option>
    <option value="25">Azul (25)</option>
    <option value="100">Verde (100)</option>
  </select>
  <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1">
  <button id="canjearBtn">Canjear</button>

  <h4>Mis Fichas</h4>
  <div class="fichaResumen" id="fichaResumen"></div>
</div>

<!-- Crear sala -->
<div class="crear-sala" id="crearSalaContainer" style="display:none;">
  <input type="text" id="nombreSala" placeholder="Nombre de la sala">
  <button id="crearSalaBtn">Crear Sala</button>
</div>

<h2>Salas disponibles</h2>
<div class="salas-container" id="salasContainer"></div>

<div class="sala-activa" id="salaActiva" style="display:none;">
  <h2 id="nombreSalaActiva"></h2>
  <div id="jugadoresSala"></div>
  <h3>Apostar fichas</h3>
  <div class="fichas" id="fichasContainer"></div>
  <button id="startBtn" disabled>Iniciar Partida</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

let usuarioSesion = null;
let fichas = { blanca: 0, roja: 0, azul: 0, verde: 0 };
let salaActual = null;
const maxJugadoresPorSala = 5;

// ---------- CARGAR USUARIO ----------
function loadUser() {
    usuarioSesion = JSON.parse(localStorage.getItem("currentUser"));
    const authContainer = document.getElementById("authContainer");
    const userInfo = document.getElementById("userInfo");
    const crearSalaContainer = document.getElementById("crearSalaContainer");
    const conversionContainer = document.getElementById("conversionContainer");

    if(usuarioSesion) {
        authContainer.style.display = "none";
        userInfo.style.display = "block";
        userInfo.innerText = `Bienvenido, ${usuarioSesion.username || usuarioSesion.nombre || "Usuario"}`;
        crearSalaContainer.style.display = "block";
        conversionContainer.style.display = "block";
        document.getElementById("pekepuntosActuales").innerText = usuarioSesion.pekepuntos || 1000;
        cargarFichas();
    } else {
        authContainer.style.display = "block";
        userInfo.style.display = "none";
        crearSalaContainer.style.display = "none";
        conversionContainer.style.display = "none";
    }
}

// ---------- CARGAR FICHAS ----------
function cargarFichas() {
    const guardadas = JSON.parse(localStorage.getItem("fichas"));
    if(guardadas) fichas = guardadas;
    mostrarFichas();
}

function guardarFichas() {
    localStorage.setItem("fichas", JSON.stringify(fichas));
}

function mostrarFichas() {
    const resumen = document.getElementById("fichaResumen");
    resumen.innerHTML = `
        <span>âšª Blancas: ${fichas.blanca}</span>
        <span>ðŸ”´ Rojas: ${fichas.roja}</span>
        <span>ðŸ”µ Azules: ${fichas.azul}</span>
        <span>ðŸŸ¢ Verdes: ${fichas.verde}</span>
    `;
}

// ---------- CANJEAR PEKEPUNTOS ----------
function canjearFichas() {
    const tipo = parseInt(document.getElementById("tipoFicha").value);
    const cantidad = parseInt(document.getElementById("cantidadFichas").value);
    if(!cantidad || cantidad <= 0) return alert("Introduce una cantidad vÃ¡lida");

    const totalCosto = tipo * cantidad;
    const pekepuntosActuales = usuarioSesion.pekepuntos || 1000;
    if(pekepuntosActuales < totalCosto) return alert("No tienes suficientes pekepuntos");

    usuarioSesion.pekepuntos -= totalCosto;
    localStorage.setItem("currentUser", JSON.stringify(usuarioSesion));
    document.getElementById("pekepuntosActuales").innerText = usuarioSesion.pekepuntos;

    if(tipo === 1) fichas.blanca += cantidad;
    if(tipo === 5) fichas.roja += cantidad;
    if(tipo === 25) fichas.azul += cantidad;
    if(tipo === 100) fichas.verde += cantidad;

    guardarFichas();
    mostrarFichas();
    document.getElementById("cantidadFichas").value = '';
}

// ---------- EVENTOS ----------
document.getElementById('canjearBtn').addEventListener('click', canjearFichas);
document.getElementById('loginBtn').addEventListener('click', () => window.location.href='l.html');

// ---------- EXISTENTES ----------
window.crearSala = crearSala;
window.unirseASala = unirseASala;
window.apostar = apostar;
window.iniciarPartida = iniciarPartida;

// ---------- SUPABASE Y SALAS ----------
async function mostrarSalas() {
    const { data: salas } = await supabase.from('rooms').select('*').order('created_at', {ascending:true});
    const container = document.getElementById('salasContainer');
    container.innerHTML = '';
    salas.forEach(sala => {
        const salaDiv = document.createElement('div');
        salaDiv.classList.add('sala');

        const nombre = document.createElement('span');
        nombre.innerText = sala.name;

        const boton = document.createElement('button');
        boton.innerText = 'Unirse';
        boton.addEventListener('click', () => unirseASala(sala.id, sala.name));

        salaDiv.appendChild(nombre);
        salaDiv.appendChild(boton);
        container.appendChild(salaDiv);
    });
}

async function crearSala() {
    const nombre = document.getElementById('nombreSala').value.trim();
    if(!nombre) return alert("Introduce un nombre de sala");
    const { data } = await supabase.from('rooms').insert([{name: nombre}]).select().single();
    document.getElementById('nombreSala').value = '';
    await unirseASala(data.id, data.name);
    mostrarSalas();
}

async function unirseASala(salaId, salaName) {
    if(!usuarioSesion) return alert("Debes iniciar sesiÃ³n primero");
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaName);
    if(jugadores.length >= maxJugadoresPorSala) return alert("Sala llena");
    if(jugadores.some(j => j.user_id === usuarioSesion.id)) return alert("Ya estÃ¡s en la sala");

    await supabase.from('card_game').insert([{
        user_id: usuarioSesion.id,
        player: usuarioSesion.username || usuarioSesion.nombre,
        room: salaName,
        hand: '',
        points: usuarioSesion.pekepuntos
    }]);

    salaActual = salaName;
    mostrarSalaActiva();
}

// Inicializar
loadUser();
mostrarSalas();
</script>
</body>
</html>
