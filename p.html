<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego de Cartas - Diagn√≥stico de sesi√≥n</title>
<style>
  body{font-family:Arial, sans-serif;background:#111;color:#eee;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;}
  .card{background:#1b1b1b;border-radius:10px;padding:14px;width:95%;max-width:980px;margin:12px 0;border:1px solid rgba(255,140,50,0.06);}
  h1{color:#ff9a33;text-align:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{background:#ff7f2a;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#444}
  .small{font-size:13px;color:#ccc}
  .klist{background:#0f0f0f;padding:8px;border-radius:8px;max-height:180px;overflow:auto}
  .kitem{padding:8px;border-radius:6px;margin-bottom:8px;background:linear-gradient(180deg,#151515,#111);display:flex;justify-content:space-between;align-items:center}
  pre{white-space:pre-wrap;word-break:break-word;color:#dcdcdc;background:transparent;margin:6px 0}
  .hidden{display:none}
  .fichaResumen span{margin-right:12px}
  .sala {display:flex;justify-content:space-between;align-items:center;background:#222;padding:10px;border-radius:8px;margin:8px 0}
  input,select{padding:8px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff}
</style>
</head>
<body>

<h1>Juego de Cartas ‚Äî Diagn√≥stico de sesi√≥n</h1>

<!-- DIAGN√ìSTICO -->
<div class="card" id="diagCard">
  <h3>Diagn√≥stico de session storage / localStorage</h3>
  <p class="small">Esta herramienta buscar√° autom√°ticamente objetos en <code>localStorage</code> que parezcan ser tu sesi√≥n. Si encuentra coincidencias, podr√°s seleccionarla.</p>
  <div class="row" style="margin-bottom:8px;">
    <button id="scanBtn">üîé Detectar sesi√≥n en localStorage</button>
    <button id="forceBtn" class="secondary">üìù Forzar sesi√≥n manual (JSON)</button>
    <button id="clearDetected" class="secondary">üóëÔ∏è Borrar currentUser</button>
    <span id="diagStatus" class="small" style="margin-left:6px"></span>
  </div>

  <div id="scanResults" class="klist hidden"></div>

  <div id="manualArea" class="hidden" style="margin-top:8px">
    <p class="small">Pega aqu√≠ el objeto JSON del usuario (ej: {"id":"uuid","username":"Alice","pekepuntos":500})</p>
    <textarea id="manualJson" rows="4" style="width:100%;background:#0f0f0f;color:#fff;border:1px solid #333;padding:8px;border-radius:6px"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="applyManual">Aplicar como sesi√≥n</button>
      <button id="cancelManual" class="secondary">Cancelar</button>
    </div>
  </div>
</div>

<!-- RESUMEN SESI√ìN ACTUAL -->
<div class="card" id="sessionCard">
  <h3>Sesi√≥n detectada</h3>
  <div id="sessionInfo">Ninguna sesi√≥n activa</div>
  <pre id="sessionRaw" class="hidden"></pre>
</div>

<!-- CONVERSION / FICHAS -->
<div class="card" id="conversionCard">
  <h3>Canjear Pekepuntos por Fichas</h3>
  <div id="conversionUi" class="">
    <p class="small">Pekepuntos actuales: <strong id="pekepuntosActuales">0</strong></p>
    <div class="row" style="margin-bottom:8px">
      <select id="tipoFicha"><option value="1">Blanca (1)</option><option value="5">Roja (5)</option><option value="25">Azul (25)</option><option value="100">Verde (100)</option></select>
      <input type="number" id="cantidadFichas" placeholder="Cantidad" min="1" style="width:120px" />
      <button id="canjearBtn">Canjear</button>
    </div>
    <div><strong>Mis fichas:</strong> <span class="fichaResumen" id="fichaResumen"></span></div>
  </div>
  <div id="noSessionConv" class="small hidden">Inicia sesi√≥n para utilizar la conversi√≥n.</div>
</div>

<!-- SALAS -->
<div class="card" id="salasCard">
  <h3>Salas disponibles</h3>
  <div style="margin-bottom:8px" class="row">
    <input id="nombreSala" placeholder="Nombre de la sala" style="flex:1;max-width:360px" />
    <button id="crearSalaBtn">Crear sala</button>
    <button id="refreshSalas" class="secondary">Actualizar</button>
  </div>
  <div id="salasContainer"></div>
</div>

<!-- SALA ACTIVA -->
<div class="card hidden" id="salaActivaCard">
  <h3 id="nombreSalaActiva">Sala: ‚Äî</h3>
  <div id="jugadoresSala"></div>
  <h4>Apostar (usa fichas)</h4>
  <div id="fichasContainer" class="row"></div>
  <div style="margin-top:10px"><button id="startBtn" disabled>Iniciar Partida</button></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- CONFIG SUPABASE (mant√©n tus keys) ---
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(supabaseUrl, supabaseKey);

// --- ESTADO ---
let usuarioSesion = null;
let fichas = { blanca:0, roja:0, azul:0, verde:0 };
let salaActual = null;
const maxJugadoresPorSala = 5;

// --- UI elements ---
const scanBtn = document.getElementById('scanBtn');
const scanResults = document.getElementById('scanResults');
const diagStatus = document.getElementById('diagStatus');
const sessionInfo = document.getElementById('sessionInfo');
const sessionRaw = document.getElementById('sessionRaw');
const loginBtn = document.getElementById('loginBtn');

const conversionUi = document.getElementById('conversionUi');
const noSessionConv = document.getElementById('noSessionConv');
const pekepuntosActualesEl = document.getElementById('pekepuntosActuales');
const fichaResumen = document.getElementById('fichaResumen');
const canjearBtn = document.getElementById('canjearBtn');
const tipoFichaSel = document.getElementById('tipoFicha');
const cantidadFichasInp = document.getElementById('cantidadFichas');

const crearSalaBtn = document.getElementById('crearSalaBtn');
const salasContainer = document.getElementById('salasContainer');
const refreshSalasBtn = document.getElementById('refreshSalas');

const salaActivaCard = document.getElementById('salaActivaCard');
const nombreSalaActivaEl = document.getElementById('nombreSalaActiva');
const jugadoresSalaEl = document.getElementById('jugadoresSala');
const fichasContainer = document.getElementById('fichasContainer');
const startBtn = document.getElementById('startBtn');

// --- UTIL: detectar objetos JSON que parezcan usuarios ---
function isLikelyUser(obj){
  if(!obj || typeof obj !== 'object') return false;
  const keys = Object.keys(obj).map(k=>k.toLowerCase());
  // buscamos se√±ales t√≠picas
  const hasId = keys.includes('id') || keys.includes('user_id') || keys.includes('uuid');
  const hasName = keys.includes('username') || keys.includes('nombre') || keys.includes('user') || keys.includes('name');
  return (hasId && hasName) || keys.includes('pekepuntos') || keys.includes('points');
}

// --- ESCANEAR localStorage ---
function scanLocalStorage(){
  scanResults.innerHTML = '';
  scanResults.classList.remove('hidden');
  diagStatus.textContent = ' buscando‚Ä¶';
  const found = [];
  for(const i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    const val = localStorage.getItem(key);
    let parsed = null;
    try { parsed = JSON.parse(val); } catch(e){ parsed = null; }
    const possible = isLikelyUser(parsed);
    const container = document.createElement('div');
    container.className = 'kitem';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${key}</strong><div class="small">${typeof val === 'string' ? (val.length>200? val.slice(0,200)+'‚Ä¶': val) : String(val)}</div>`;
    const right = document.createElement('div');
    if(possible){
      const btn = document.createElement('button');
      btn.innerText = 'Usar esta sesi√≥n';
      btn.addEventListener('click', ()=> applyDetected(key, parsed));
      right.appendChild(btn);
      found.push({key, parsed});
    } else {
      const span = document.createElement('span');
      span.className='small';
      span.innerText = 'No parece sesi√≥n';
      right.appendChild(span);
    }
    container.appendChild(left);
    container.appendChild(right);
    scanResults.appendChild(container);
  }
  diagStatus.textContent = ` ${localStorage.length} claves examinadas`;
  if(scanResults.children.length===0) scanResults.innerHTML = '<div class="small">localStorage vac√≠o</div>';
}

// --- APLICAR SESI√ìN detectada ---
function applyDetected(key, parsed){
  if(!parsed) return alert('Valor no parseable');
  // guardar uniformemente como "currentUser"
  localStorage.setItem('currentUser', JSON.stringify(parsed));
  loadUserFromLocal();
  alert(`Sesi√≥n aplicada desde clave "${key}".`);
  scanResults.classList.add('hidden');
}

// --- FORZAR SESI√ìN MANUAL (UI) ---
const forceBtn = document.getElementById('forceBtn');
const manualArea = document.getElementById('manualArea') || (() => {
  const ma = document.createElement('div'); ma.id='manualArea'; ma.className='hidden'; document.getElementById('diagCard').appendChild(ma); return ma;
})();
forceBtn.addEventListener('click', ()=> {
  manualArea.classList.toggle('hidden');
  if(manualArea.classList.contains('hidden')) return;
  manualArea.innerHTML = `
    <p class="small">Pega aqu√≠ el JSON que representa al usuario:</p>
    <textarea id="manualJson" rows="5" style="width:100%;background:#0f0f0f;color:#fff;border:1px solid #333;padding:8px;border-radius:6px"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="applyManual">Aplicar como sesi√≥n</button>
      <button id="cancelManual" class="secondary">Cancelar</button>
    </div>`;
  document.getElementById('applyManual').addEventListener('click', ()=>{
    const t = document.getElementById('manualJson').value.trim();
    if(!t) return alert('Pega primero el JSON');
    try{
      const obj = JSON.parse(t);
      localStorage.setItem('currentUser', JSON.stringify(obj));
      manualArea.classList.add('hidden');
      loadUserFromLocal();
      alert('Sesi√≥n manual aplicada.');
    }catch(e){
      alert('JSON inv√°lido: '+e.message);
    }
  });
  document.getElementById('cancelManual').addEventListener('click', ()=> manualArea.classList.add('hidden'));
});

// --- BORRAR currentUser ---
document.getElementById('clearDetected').addEventListener('click', ()=>{
  localStorage.removeItem('currentUser');
  usuarioSesion = null;
  updateSessionUI();
  alert('currentUser borrado de localStorage.');
});

// --- CARGAR SESI√ìN desde m√∫ltiples claves e inicializar estado ---
function loadUserFromLocal(){
  usuarioSesion = null;
  const posibles = ["currentUser","usuario","user","session"];
  for(const k of posibles){
    const val = localStorage.getItem(k);
    if(!val) continue;
    try{
      const parsed = JSON.parse(val);
      if(isLikelyUser(parsed)){
        usuarioSesion = parsed;
        // unify under currentUser
        localStorage.setItem('currentUser', JSON.stringify(parsed));
        break;
      }
    }catch(e){}
  }
  // si no se detect√≥ a√∫n, tambi√©n intentar cualquier clave gen√©rica:
  if(!usuarioSesion){
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(['currentUser','usuario','user','session'].includes(k)) continue;
      const val = localStorage.getItem(k);
      try{
        const parsed = JSON.parse(val);
        if(isLikelyUser(parsed)){
          usuarioSesion = parsed;
          localStorage.setItem('currentUser', JSON.stringify(parsed));
          break;
        }
      }catch(e){}
    }
  }
  updateSessionUI();
}

// --- UPDATE UI sesi√≥n ---
function updateSessionUI(){
  if(usuarioSesion){
    sessionInfo.innerHTML = `<strong>${usuarioSesion.username || usuarioSesion.nombre || usuarioSesion.user || 'Usuario'}</strong> ‚Äî id: ${usuarioSesion.id || usuarioSesion.user_id || 'n/a'}`;
    sessionRaw.classList.remove('hidden');
    sessionRaw.textContent = JSON.stringify(usuarioSesion, null, 2);
    // habilitar conversion y carga de fichas
    conversionUi.classList.remove('hidden');
    noSessionConv.classList.add('hidden');
    pekepuntosActualesEl.textContent = usuarioSesion.pekepuntos ?? (usuarioSesion.points ?? 0);
    loadFichasFromStorage();
  } else {
    sessionInfo.innerText = 'Ninguna sesi√≥n activa';
    sessionRaw.classList.add('hidden');
    conversionUi.classList.add('hidden');
    noSessionConv.classList.remove('hidden');
    pekepuntosActualesEl.textContent = '0';
    fichaResumen.innerHTML = '';
  }
}

// --- FICHAS: persistencia y UI ---
function loadFichasFromStorage(){
  try{
    const fs = JSON.parse(localStorage.getItem('fichas'));
    if(fs && typeof fs === 'object') fichas = Object.assign(fichas, fs);
  }catch(e){}
  renderFichas();
}
function renderFichas(){
  fichaResumen.innerHTML = `‚ö™ ${fichas.blanca}  üî¥ ${fichas.roja}  üîµ ${fichas.azul}  üü¢ ${fichas.verde}`;
  localStorage.setItem('fichas', JSON.stringify(fichas));
}

// --- CANJEAR FICHAS ---
canjearBtn.addEventListener('click', ()=>{
  if(!usuarioSesion) return alert('No hay sesi√≥n: inicia sesi√≥n o usa Detectar sesi√≥n.');
  const tipo = Number(tipoFichaSel.value);
  const cantidad = parseInt(cantidadFichasInp.value,10);
  if(!cantidad || cantidad<=0) return alert('Cantidad inv√°lida');
  const pekes = usuarioSesion.pekepuntos ?? usuarioSesion.points ?? 0;
  const total = tipo * cantidad;
  if(pekes < total) return alert('No tienes suficientes pekepuntos');
  // restar y guardar
  usuarioSesion.pekepuntos = (usuarioSesion.pekepuntos ?? usuarioSesion.points ?? 0) - total;
  localStorage.setItem('currentUser', JSON.stringify(usuarioSesion));
  document.getElementById('pekepuntosActuales').textContent = usuarioSesion.pekepuntos;
  // a√±adir fichas
  if(tipo===1) fichas.blanca += cantidad;
  if(tipo===5) fichas.roja += quantityOrFix(cantidad);
  if(tipo===25) fichas.azul += cantidad;
  if(tipo===100) fichas.verde += cantidad;
  renderFichas();
  alert('Canje realizado.');
  cantidadFichasInp.value = '';
});

// peque√±a correcci√≥n si hay tipos raros
function quantityOrFix(v){ return Number.isInteger(v)?v:Math.floor(v); }

// --- SALAS (Supabase) ---
async function mostrarSalas(){
  try{
    const { data: salas } = await supabase.from('rooms').select('*').order('created_at',{ascending:true});
    salasContainer.innerHTML = '';
    salas.forEach(s => {
      const div = document.createElement('div');
      div.className='sala';
      const left = document.createElement('div'); left.innerHTML = `<strong>${s.name}</strong><div class="small">creada: ${new Date(s.created_at).toLocaleString()}</div>`;
      const right = document.createElement('div');
      const btn = document.createElement('button'); btn.innerText='Unirse';
      btn.addEventListener('click', ()=> unirseASala(s.id, s.name));
      right.appendChild(btn);
      div.appendChild(left); div.appendChild(right);
      salasContainer.appendChild(div);
    });
  }catch(e){
    salasContainer.innerHTML = '<div class="small">Error al cargar salas</div>';
  }
}

refreshSalasBtn.addEventListener('click', mostrarSalas);

async function crearSala(){
  if(!usuarioSesion) return alert('Debes tener sesi√≥n para crear una sala');
  const nombre = document.getElementById('nombreSala').value.trim();
  if(!nombre) return alert('Nombre vac√≠o');
  const { data, error } = await supabase.from('rooms').insert([{ name: nombre }]).select().single();
  if(error) return alert('Error creando sala: '+(error.message||error));
  document.getElementById('nombreSala').value='';
  await unirseASala(data.id, data.name);
  await mostrarSalas();
}
crearSalaBtn.addEventListener('click', crearSala);


// --- UNIRSE ---
async function unirseASala(roomId, roomName){
  if(!usuarioSesion) return alert('Debes iniciar sesi√≥n (usa Detectar sesi√≥n si no est√°s detectado).');

  // contar jugadores en esa room (por name)
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', roomName);
  if(jugadores && jugadores.length >= maxJugadoresPorSala) return alert('Sala llena');
  if(jugadores && jugadores.some(j=> j.user_id === (usuarioSesion.id || usuarioSesion.user_id))) return alert('Ya est√°s en la sala');

  // üîß inserci√≥n segura: evitar cadenas vac√≠as o tipos err√≥neos
  const inserir = {
    user_id: usuarioSesion.id || usuarioSesion.user_id || null,
    player: usuarioSesion.username || usuarioSesion.nombre || 'Jugador',
    room: roomName,
    hand: null, // ‚úÖ evita "malformed array literal"
    points: usuarioSesion.pekepuntos ?? usuarioSesion.points ?? 0
  };

  const { error } = await supabase.from('card_game').insert([inserir]);
  if(error) {
    console.error('Error al unirse:', error);
    return alert('Error al unirse: ' + (error.message || error));
  }

  salaActual = roomName;
  mostrarSalaActiva(roomName);
}


// --- MOSTRAR SALA ACTIVA ---
async function mostrarSalaActiva(roomName){
  salaActivaCard.classList.remove('hidden');
  nombreSalaActivaEl.innerText = `Sala: ${roomName}`;
  // cargar jugadores
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', roomName);
  jugadoresSalaEl.innerHTML = '';
  jugadores.forEach(j=>{
    const div = document.createElement('div'); div.className='small'; div.innerText = `${j.player} ‚Äî pekepuntos: ${j.points} ‚Äî apuesta: ${j.apuesta||0}`;
    jugadoresSalaEl.appendChild(div);
  });
  // generar botones para apostar (usar fichas)
  fichasContainer.innerHTML = '';
  [[1,'Blanca'],[5,'Roja'],[25,'Azul'],[100,'Verde']].forEach(([v,label])=>{
    const b = document.createElement('button'); b.innerText = `${label} (${v})`;
    b.addEventListener('click', ()=> apostarConFichas(v));
    fichasContainer.appendChild(b);
  });
  // habilitar start si todos apostaron
  verificarApuestas(jugadores);
}

// --- APOSTAR usando fichas ---
async function apostarConFichas(valor){
  if(!salaActual) return alert('No est√°s en sala');
  // comprobar si el usuario tiene suficientes fichas del tipo
  // valor-> cu√°l ficha restaremos: 1->blanca,5->roja,25->azul,100->verde
  const tipo = valor === 1 ? 'blanca' : valor ===5 ? 'roja' : valor===25 ? 'azul' : 'verde';
  if(fichas[tipo] <= 0) return alert(`No tienes fichas ${tipo}`);
  // restar 1 ficha de ese tipo (o permitir apostar cantidad? por simplicidad restamos 1)
  fichas[tipo] -= 1;
  renderFichas();
  // actualizar en tabla card_game la columna apuesta del jugador en esta sala
  // buscamos registro del usuario en card_game dentro de salaActual:
  const idUsuario = usuarioSesion.id || usuarioSesion.user_id || null;
  const { data: registros } = await supabase.from('card_game').select('*').eq('room', salaActual).eq('user_id', idUsuario);
  if(!registros || registros.length===0) return alert('Registro del jugador no encontrado en la sala (recarga la sala).');
  const reg = registros[0];
  const nuevaApuesta = (reg.apuesta || 0) + valor;
  // actualizar puntos guardados en el registro (points) opcionalmente
  await supabase.from('card_game').update({apuesta: nuevaApuesta, points: (reg.points||0) - valor}).eq('id', reg.id);
  // refrescar sala
  mostrarSalaActiva(salaActual);
}

// --- VERIFICAR APUESTAS ---
function verificarApuestas(jugadores){
  const todosApostaron = jugadores.length>0 && jugadores.every(j => j.apuesta && j.apuesta>0);
  startBtn.disabled = !todosApostaron;
}

// start btn (placeholder)
startBtn.addEventListener('click', ()=> alert('Comienza la partida ‚Äî l√≥gica por implementar'));

// --- BOTONES DIAGN√ìSTICO ---
scanBtn.addEventListener('click', ()=> {
  scanResults.classList.remove('hidden');
  scanLocalStorage();
});
document.getElementById('loginBtn').addEventListener('click', ()=> { window.location.href = 'l.html' });

// --- INICIALIZACI√ìN ---
loadUserFromLocal();
updateSessionUI();
mostrarSalas();

</script>
</body>
</html>
