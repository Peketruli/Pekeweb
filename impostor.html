<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CONFIGURACI√ìN DE COLORES Y ESTILO --- */
        :root { 
            --p: #6366f1;           /* Color Principal (Morado) */
            --bg: #030712;          /* Fondo muy oscuro */
            --card: #111827;        /* Color de las tarjetas */
            --accent: #f59e0b;      /* Acento (Naranja) para pistas */
            --active: #10b981;      /* Verde para turnos y botones */
            --danger: #ef4444;      /* Rojo para salir/impostor */
            --txt: #f8fafc;         /* Texto blanco */
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg); 
            color: var(--txt); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%);
        }

        .hidden { display: none !important; }

        /* --- PANTALLA DE LOGIN (LOBBY) --- */
        #screen-login { 
            position:fixed; inset:0; z-index:5000; 
            background:var(--bg); 
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; 
        }
        .login-container { display: flex; gap: 20px; width: 90%; max-width: 900px; height: 500px; }
        
        @media(max-width: 700px) { .login-container { flex-direction: column; height: auto; } }

        .lobby-box { 
            flex: 1; 
            background: rgba(17, 24, 39, 0.8); 
            backdrop-filter: blur(10px); 
            border-radius: 24px; 
            padding: 30px; 
            border: 1px solid var(--border); 
            overflow-y: auto; 
        }

        .room-card { 
            background: #1f2937; padding: 15px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; border: 1px solid transparent;
        }
        .room-card:hover { border-color: var(--p); transform: translateX(5px); }

        /* --- INTERFAZ DEL JUEGO --- */
        .main-game { flex: 2; padding: 25px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .sidebar { 
            flex: 0.8; min-width: 300px;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); 
            display: flex; flex-direction: column; padding: 20px; 
            border-left: 1px solid var(--border); 
        }
        .panel { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); }

        /* --- JUGADORES --- */
        #player-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        
        .player-tag { 
            padding: 12px; border-radius: 14px; background: #1f2937; 
            text-align: center; font-weight: 700; border: 2px solid transparent; position: relative;
        }
        
        /* Efecto cuando es el turno del jugador */
        .is-active-turn { 
            border-color: var(--active); background: #064e3b; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(16,185,129,0); } 
            100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); } 
        }
        
        .dead { opacity: 0.4; filter: grayscale(1); text-decoration: line-through; }

        /* --- CHAT --- */
        #chat-messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        
        .msg { padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05); font-size: 0.9rem; border-left: 3px solid transparent; }
        
        /* CLASE IMPORTANTE: MENSAJE VERDE (PISTA) */
        .msg-clue { 
            background: rgba(16, 185, 129, 0.15) !important; 
            border-left-color: var(--active) !important; 
            color: #d1fae5; 
        }
        .msg b { display: block; font-size: 0.75rem; opacity: 0.7; margin-bottom: 2px; text-transform: uppercase; }

        /* --- ELEMENTOS DE FORMULARIO --- */
        input, select, button { 
            padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
            background: #0f172a; color: white; outline: none; width: 100%; 
            font-family: inherit; margin-bottom: 10px; font-size: 1rem;
        }
        
        button { background: var(--p); cursor: pointer; border: none; font-weight: 800; text-transform: uppercase; margin-bottom: 0; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-start { background: var(--active); box-shadow: 0 4px 15px rgba(16,185,129,0.2); }
        .btn-exit { background: var(--danger); width: auto; font-size: 0.7rem; padding: 8px 16px; margin: 0; }

        /* --- PANTALLA FINAL --- */
        #end-screen { 
            position: fixed; inset: 0; z-index: 9999; 
            background: rgba(0,0,0,0.96); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
        }
    </style>
</head>
<body>

    <div id="screen-login">
        <h1 style="font-size: 3rem; margin: 0;">üïµÔ∏è IMPOSTOR </h1>
        <div class="login-container">
            <div class="lobby-box">
                <h3 style="margin-top:0; color:var(--active);">üåê SALAS P√öBLICAS</h3>
                <div id="public-rooms-list">
                    <p style="color:gray;">Buscando salas...</p>
                </div>
            </div>
            <div class="lobby-box" style="max-width: 350px; display:flex; flex-direction:column; justify-content:center;">
                <h3>ENTRAR A JUGAR</h3>
                <input type="text" id="in-user" placeholder="Tu Apodo (Ej: Alex)">
                <input type="text" id="in-room" placeholder="C√≥digo Sala (Ej: SALA1)">
                <button onclick="entrarAlJuego()" style="height: 55px; font-size: 1.1rem;">üöÄ CONECTAR</button>
            </div>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h1 id="end-title" style="font-size: 4rem; margin: 0;">---</h1>
        <p id="end-subtitle" style="font-size: 1.5rem; color: gray; margin-bottom: 30px;"></p>
        <div id="host-controls" class="hidden">
            <button onclick="reiniciarSala()" class="btn-start" style="width: auto; padding: 15px 40px;">üîÑ VOLVER AL LOBBY</button>
        </div>
    </div>

    <div id="game-layout" style="display: flex; width: 100%;">
        
        <div class="main-game">
            <div class="panel" style="display:flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="room-display" style="margin:0; color:var(--p);">SALA: ---</h2>
                    <div id="imp-status" class="hidden" style="color:var(--danger); font-weight:bold; font-size:0.9rem; margin-top:5px;">
                        ‚ö†Ô∏è IMPOSTORES VIVOS: <span id="imp-count-val">0</span>
                    </div>
                </div>
                <button onclick="salirDelJuego()" class="btn-exit">SALIR</button>
            </div>

            <div id="host-panel" class="panel hidden" style="border-color: var(--active);">
                <h4 style="margin:0 0 10px 0; color:var(--active);">‚öôÔ∏è AJUSTES DE PARTIDA</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CANTIDAD IMPOSTORES</label>
                        <select id="set-imps" onchange="actualizarSala()">
                            <option value="1">1 Impostor</option>
                            <option value="2">2 Impostores</option>
                            <option value="rand">üé≤ Aleatorio</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CATEGOR√çA</label>
                        <select id="set-cat" onchange="actualizarSala()">
                            <option value="all">Mezclado</option>
                            <option value="animals">Animales</option>
                            <option value="food">Comida</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">PRIVACIDAD</label>
                        <select id="set-priv" onchange="actualizarSala()">
                            <option value="true">üîì P√∫blica</option>
                            <option value="false">üîí Privada</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CONTADOR IMPOSTORES</label>
                        <select id="set-vis" onchange="actualizarSala()">
                            <option value="true">üëÅÔ∏è Visible</option>
                            <option value="false">üï∂Ô∏è Oculto</option>
                        </select>
                    </div>
                </div>
                <button onclick="iniciarPartida()" class="btn-start">EMPEZAR PARTIDA</button>
            </div>

            <div class="panel">
                <h4 style="margin:0 0 10px 0; font-size:0.8rem; color:gray;">JUGADORES EN SALA</h4>
                <div id="player-list"></div>
            </div>

            <div id="role-box" class="panel hidden" style="text-align:center; border: 2px solid var(--p);">
                <div id="role-label" style="font-size:0.7rem; font-weight:bold; letter-spacing:2px; color:gray;">TU PALABRA</div>
                <h2 id="word-display" style="font-size: 2.5rem; margin:10px 0;">---</h2>
                <p id="hint-display" style="color:var(--accent); font-weight:bold; margin:0;"></p>
            </div>

            <div id="vote-box" class="panel hidden">
                <h3 style="color:var(--danger); margin:0 0 10px 0;">üó≥Ô∏è HORA DE VOTAR</h3>
                <div id="vote-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>
        </div>

        <div class="sidebar">
            <div id="turn-display" style="text-align:center; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; font-weight:bold; margin-bottom:15px; color:var(--active);">ESPERANDO...</div>
            
            <div id="chat-messages">
                </div>
            
            <div style="display:flex; gap:5px;">
                <input type="text" id="chat-input" placeholder="Escribe aqu√≠..." style="margin:0;">
                <button onclick="enviarMensaje()" style="width:50px;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN SUPABASE ---
        // IMPORTANTE: Aseg√∫rate de que estos son tus datos reales
        const SB_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // Variables Globales
        let myU = "", myR = "", pList = [], gState = "waiting", tIdx = 0;

        // Base de Datos de Palabras
        const DATA = {
            all: [{w:"YOUTUBE", h:"Internet"}, {w:"PIZZA", h:"Comida"}, {w:"TIGRE", h:"Animal"}, {w:"AVI√ìN", h:"Transporte"}, {w:"F√öTBOL", h:"Deporte"}, {w:"GUITARRA", h:"Instrumento"}],
            animals: [{w:"LE√ìN", h:"Rey"}, {w:"GATO", h:"Mascota"}, {w:"TIBUR√ìN", h:"Mar"}, {w:"√ÅGUILA", h:"Vuela"}],
            food: [{w:"SUSHI", h:"Jap√≥n"}, {w:"TACO", h:"M√©xico"}, {w:"PASTA", h:"Italia"}]
        };

        // --- 2. FUNCIONES DE INICIO ---

        async function loadPublicRooms() {
            const { data } = await sb.from('rooms').select('code').eq('status', 'waiting').eq('is_public', true).limit(10);
            const list = document.getElementById('public-rooms-list');
            
            if(!data || data.length === 0) { 
                list.innerHTML = "<small style='color:gray;'>No hay salas p√∫blicas disponibles.</small>"; 
                return; 
            }
            
            list.innerHTML = data.map(r => `
                <div class="room-card" onclick="document.getElementById('in-room').value='${r.code}'">
                    <span>üè† <b>${r.code}</b></span>
                    <small style="color:var(--p);">UNIRSE</small>
                </div>
            `).join('');
        }
        setInterval(loadPublicRooms, 5000); 
        loadPublicRooms(); 

        async function entrarAlJuego() {
            myU = document.getElementById('in-user').value.trim();
            myR = document.getElementById('in-room').value.trim().toUpperCase();
            if(!myU || !myR) return alert("Faltan datos.");

            try {
                // Limpieza previa local
                await sb.from('players').delete().match({ room_id: myR, username: myU });
                
                let { data: r } = await sb.from('rooms').select('*').eq('code', myR).maybeSingle();
                let esHost = false;

                if(!r) {
                    esHost = true;
                    // Creamos sala
                    await sb.from('rooms').insert([{ code: myR, status: 'waiting', is_public:true, show_counter:true }]);
                } else if(r.status !== 'waiting') {
                    return alert("¬°Partida empezada!");
                }

                await sb.from('players').insert([{ room_id: myR, username: myU, is_host: esHost }]);
                
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('room-display').innerText = "SALA: " + myR;
                
                setupRealtime();
                uiUpdate(); 
            } catch(e) { console.error(e); }
        }

        async function salirDelJuego() {
            if(confirm("¬øSalir?")) {
                // 1. Borrarme a m√≠ mismo
                await sb.from('players').delete().match({ room_id: myR, username: myU });
                
                // 2. COMPROBAR SI LA SALA QUED√ì VAC√çA (NUEVO)
                // Usamos count: 'exact' y head: true para solo contar sin bajar datos
                const { count } = await sb.from('players').select('*', { count: 'exact', head: true }).eq('room_id', myR);
                
                if(count === 0) {
                    // Si hay 0 jugadores, borrar la sala y los mensajes
                    await sb.from('rooms').delete().eq('code', myR);
                    await sb.from('messages').delete().eq('room_id', myR);
                    console.log("Sala vac√≠a eliminada.");
                }

                location.reload();
            }
        }

        // --- 3. TIEMPO REAL ---
        function setupRealtime() {
            const channel = sb.channel('game_channel');

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, (payload) => {
                // Si la sala se borr√≥ (payload.eventType === 'DELETE'), recargamos a los que queden (por seguridad)
                if(payload.eventType === 'DELETE' && payload.old.code === myR) {
                    alert("El anfitri√≥n cerr√≥ la sala o se vaci√≥.");
                    location.reload();
                }
                if(payload.new && payload.new.code === myR) uiUpdate();
            });

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, (payload) => {
                if((payload.new && payload.new.room_id === myR) || (payload.old && payload.old.room_id === myR)) uiUpdate();
            });

            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                if(payload.new.room_id === myR) {
                    const chat = document.getElementById('chat-messages');
                    const msg = document.createElement('div');
                    const claseExtra = payload.new.is_clue ? ' msg-clue' : '';
                    msg.className = 'msg' + claseExtra;
                    msg.innerHTML = `<b>${payload.new.username}</b> ${payload.new.content}`;
                    chat.appendChild(msg);
                    chat.scrollTop = chat.scrollHeight; 
                }
            });

            channel.subscribe();
        }

        // --- 4. ACTUALIZACI√ìN UI (CORE) ---
        async function uiUpdate() {
            if(!myR) return;

            const { data: ps } = await sb.from('players').select('*').eq('room_id', myR).order('created_at');
            const { data: r } = await sb.from('rooms').select('*').eq('code', myR).maybeSingle();

            if(!ps || !r) return; // Si algo falla o la sala se borr√≥

            pList = ps; 
            gState = r.status; 
            tIdx = r.turn_index;
            const me = ps.find(p => p.username === myU);
            
            // Si yo ya no existo (kick o error), recargo
            if(!me) { location.reload(); return; }

            // --- A) PANTALLA FINAL ---
            // CORRECCI√ìN: Si status es 'waiting', ocultamos pantalla final S√ç O S√ç.
            if(r.status === 'waiting') {
                document.getElementById('end-screen').classList.add('hidden');
            } else if(r.winner_side) {
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-title').innerText = "GANAN: " + r.winner_side.toUpperCase();
                document.getElementById('end-subtitle').innerText = "Impostores: " + r.impostor_id;
                
                if(me.is_host) document.getElementById('host-controls').classList.remove('hidden');
                else document.getElementById('host-controls').classList.add('hidden');
            }

            // --- B) PANEL HOST Y SINCRONIZACI√ìN ---
            if(me.is_host && gState === 'waiting') {
                document.getElementById('host-panel').classList.remove('hidden');
                
                // Sincronizar men√∫s visuales solo si no los estoy tocando
                if(document.activeElement.tagName !== 'SELECT') {
                    document.getElementById('set-priv').value = r.is_public ? 'true' : 'false';
                    document.getElementById('set-vis').value = r.show_counter ? 'true' : 'false';
                }
            } else {
                document.getElementById('host-panel').classList.add('hidden');
            }

            // --- C) CONTADORES Y JUGADORES ---
            const infoDiv = document.getElementById('imp-status');
            if(gState !== 'waiting' && r.show_counter) {
                infoDiv.classList.remove('hidden');
                document.getElementById('imp-count-val').innerText = r.impostores_vivos;
            } else {
                infoDiv.classList.add('hidden');
            }

            document.getElementById('player-list').innerHTML = ps.map((p, i) => `
                <div class="player-tag ${i===tIdx && gState==='playing' ? 'is-active-turn' : ''} ${!p.is_alive ? 'dead' : ''}">
                    ${p.is_host ? 'üëë ' : ''}${p.username} ${p.has_voted ? '‚úÖ' : ''}
                </div>
            `).join('');

            // --- D) ESTADO JUEGO ---
            const turnLabel = document.getElementById('turn-display');
            if(gState === 'playing') {
                document.getElementById('role-box').classList.remove('hidden');
                const imps = (r.impostor_id || "").split(',');
                const soyImp = imps.includes(myU);
                document.getElementById('role-label').innerText = soyImp ? "TU MISI√ìN" : "TU PALABRA";
                document.getElementById('word-display').innerText = soyImp ? "üïµÔ∏è IMPOSTOR" : r.word;
                document.getElementById('hint-display').innerText = soyImp ? "Enga√±a a todos." : "Categor√≠a: " + r.hint;
                
                const activeP = ps[tIdx];
                if(activeP) {
                    turnLabel.innerText = "HABLA: " + activeP.username;
                    turnLabel.style.color = (activeP.username === myU) ? "var(--active)" : "white";
                    if(activeP.username === myU) turnLabel.innerText += " (¬°TU TURNO!)";
                }
            } else if(gState === 'voting') {
                document.getElementById('role-box').classList.add('hidden');
                turnLabel.innerText = "üó≥Ô∏è MOMENTO DE VOTAR";
                turnLabel.style.color = "var(--danger)";
            } else {
                document.getElementById('role-box').classList.add('hidden');
                turnLabel.innerText = "ESPERANDO JUGADORES...";
                turnLabel.style.color = "var(--active)";
            }

            // --- E) VOTACI√ìN ---
            const vb = document.getElementById('vote-box');
            if(gState === 'voting' && me.is_alive && !me.has_voted) {
                vb.classList.remove('hidden');
                vb.querySelector('#vote-options').innerHTML = ps.filter(p=>p.is_alive).map(p => `
                    <button onclick="votar('${p.username}')">${p.username}</button>
                `).join('') + `<button onclick="votar('skip')" style="background:gray; grid-column:span 2;">‚è≠Ô∏è SALTAR VOTO</button>`;
            } else {
                vb.classList.add('hidden');
            }

            // --- CORRECCI√ìN FINAL DEL BUCLE ---
            // Solo ejecutamos l√≥gica de host si estamos JUGANDO o VOTANDO.
            // Si estamos 'waiting', NO HACEMOS NADA. Esto arregla el reinicio infinito.
            if(me.is_host && gState !== 'waiting') {
                hostLogic(r, ps);
            }
        }

        // --- 5. L√ìGICA DE JUEGO ---

        async function actualizarSala() {
            const esPublica = document.getElementById('set-priv').value === 'true';
            const mostrarContador = document.getElementById('set-vis').value === 'true';
            
            await sb.from('rooms').update({
                is_public: esPublica,
                show_counter: mostrarContador
            }).eq('code', myR);
        }

        async function iniciarPartida() {
            if(pList.length < 3) return alert("M√≠nimo 3 jugadores.");
            
            const cat = document.getElementById('set-cat').value;
            const impVal = document.getElementById('set-imps').value;
            
            let numImp = (impVal === 'rand') ? Math.floor(Math.random() * (pList.length - 1)) + 1 : parseInt(impVal);
            if(numImp >= pList.length) numImp = pList.length - 1;

            const shuffled = [...pList].sort(() => 0.5 - Math.random());
            const chosenImps = shuffled.slice(0, numImp).map(p => p.username);
            const wData = DATA[cat][Math.floor(Math.random() * DATA[cat].length)];

            // Importante: Actualizamos el estado con los ajustes actuales del DOM
            const esPublica = document.getElementById('set-priv').value === 'true';
            const mostrarContador = document.getElementById('set-vis').value === 'true';

            await sb.from('messages').delete().eq('room_id', myR);
            await sb.from('players').update({ is_alive:true, has_voted:false, voted_for:null }).eq('room_id', myR);
            
            await sb.from('rooms').update({
                status: 'playing',
                word: wData.w,
                hint: wData.h,
                impostor_id: chosenImps.join(','),
                impostores_vivos: chosenImps.length,
                winner_side: null,
                turn_index: 0,
                is_public: esPublica,
                show_counter: mostrarContador
            }).eq('code', myR);
        }

        async function enviarMensaje() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;

            const turnoPlayer = pList[tIdx];
            const esMiTurno = (gState === 'playing' && turnoPlayer && turnoPlayer.username === myU);

            await sb.from('messages').insert([{ 
                room_id: myR, username: myU, content: txt, is_clue: esMiTurno 
            }]);
            inp.value = "";

            if(esMiTurno) {
                let nextIdx = tIdx + 1;
                while(pList[nextIdx] && !pList[nextIdx].is_alive) nextIdx++;

                if(nextIdx >= pList.length) await sb.from('rooms').update({ status:'voting' }).eq('code', myR);
                else await sb.from('rooms').update({ turn_index: nextIdx }).eq('code', myR);
            }
        }

        async function votar(voto) { 
            await sb.from('players').update({ has_voted:true, voted_for:voto }).match({ room_id:myR, username:myU });
            document.getElementById('vote-box').classList.add('hidden');
        }

        async function reiniciarSala() {
            document.getElementById('end-screen').classList.add('hidden');
            
            // Reseteamos TODO para evitar que la hostLogic se confunda
            await sb.from('rooms').update({ 
                status:'waiting', winner_side:null, word:null, impostor_id:null, impostores_vivos:0
            }).eq('code',myR);
            
            await sb.from('players').update({ 
                is_alive:true, has_voted:false, voted_for:null 
            }).eq('room_id',myR);
        }

        // --- 6. C√ÅLCULO RESULTADOS (HOST) ---
        async function hostLogic(r, ps) {
            // DOBLE SEGURIDAD: Si estamos esperando, FUERA.
            if(r.status === 'waiting') return;

            const vivos = ps.filter(p => p.is_alive);
            const hanVotado = vivos.filter(p => p.has_voted);

            if(vivos.length > 0 && vivos.length === hanVotado.length) {
                let counts = {}; 
                hanVotado.forEach(p => { counts[p.voted_for] = (counts[p.voted_for] || 0) + 1; });
                
                let expulsado = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                if(expulsado !== 'skip') {
                    await sb.from('players').update({ is_alive:false }).match({ room_id:myR, username:expulsado });
                    
                    const listaImps = (r.impostor_id || "").split(',');
                    if(listaImps.includes(expulsado)) {
                        const quedan = r.impostores_vivos - 1;
                        if(quedan <= 0) return await sb.from('rooms').update({ winner_side:'tripulaci√≥n', impostores_vivos:0 }).eq('code', myR);
                        await sb.from('rooms').update({ impostores_vivos: quedan }).eq('code', myR);
                    }
                }

                // Recalcular post-muerte
                const nuevosVivos = ps.filter(p => p.is_alive && p.username !== expulsado);
                const listaImps = (r.impostor_id || "").split(',');
                const impsVivos = nuevosVivos.filter(p => listaImps.includes(p.username)).length;
                const crewVivos = nuevosVivos.length - impsVivos;

                if(impsVivos >= crewVivos) return await sb.from('rooms').update({ winner_side:'impostores' }).eq('code', myR);

                await sb.from('players').update({ has_voted:false, voted_for:null }).eq('room_id', myR);
                await sb.from('rooms').update({ status:'playing', turn_index:0 }).eq('code', myR);
            }
        }

        document.getElementById('chat-input').onkeypress = (e) => { if(e.key === 'Enter') enviarMensaje(); };
    </script>
</body>
</html>
