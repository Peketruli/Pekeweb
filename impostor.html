<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego de Deducci√≥n</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f0f2f5; text-align: center; }
        .screen { display: none; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .active { display: block; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; }
        button.danger { background: #dc3545; }
        input { padding: 10px; width: 70%; margin-bottom: 10px; }
        .role-card { font-size: 1.5em; padding: 20px; border: 2px dashed #333; margin: 20px 0; background: #fff3cd; }
        .player-list { list-style: none; padding: 0; }
        .player-list li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è ¬øQui√©n es el Impostor?</h1>

    <div id="screen-login" class="screen active">
        <h3>Entrar o Crear Sala</h3>
        <input type="text" id="username" placeholder="Tu nombre" required>
        <input type="text" id="roomCode" placeholder="C√≥digo de Sala (ej: A1B2)">
        <br>
        <button onclick="createRoom()">Crear Sala Nueva</button>
        <button onclick="joinRoom()">Unirse a Sala</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h3>Sala: <span id="lobby-code"></span></h3>
        <p>Esperando jugadores...</p>
        <ul id="lobby-players" class="player-list"></ul>
        
        <div id="host-controls" style="display:none; border-top: 1px solid #ccc; padding-top:10px;">
            <h4>Configuraci√≥n (Solo Host)</h4>
            <select id="category-select">
                <option value="animales">Animales</option>
                <option value="comida">Comida</option>
                <option value="lugares">Lugares</option>
            </select>
            <button onclick="startGame()">¬°Empezar Partida!</button>
        </div>
        <p id="waiting-msg">Esperando a que el l√≠der inicie...</p>
    </div>

    <div id="screen-game" class="screen">
        <h3>Tu Rol</h3>
        <div class="role-card" id="my-word-display">
            Cargando...
        </div>
        
        <div id="impostor-actions" style="display:none;">
            <p>‚ö†Ô∏è Eres el Impostor. Tu objetivo es sobrevivir y adivinar la palabra de los civiles.</p>
            <input type="text" id="guess-input" placeholder="Adivina la palabra exacta">
            <button class="danger" onclick="attemptWin()">¬°S√© la palabra!</button>
        </div>

        <h4>Jugadores Vivos (Votar para echar)</h4>
        <ul id="game-players" class="player-list"></ul>
    </div>

<script>
    // --- CONFIGURACI√ìN ---
    const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARIABLES GLOBALES ---
    let myId = null;
    let myName = "";
    let currentRoom = "";
    let isHost = false;
    let myRoleData = null; // { is_impostor, word }

    // --- DICCIONARIO DE PALABRAS (Ejemplo simplificado) ---
    // Estructura: [Palabra Civil, Palabra Impostor (Similar)]
    const WORDS = {
        animales: [
            ['Perro', 'Lobo'], ['Gato', 'Tigre'], ['Caballo', 'Burro'], ['√Åguila', 'Halc√≥n']
        ],
        comida: [
            ['Pizza', 'Lasa√±a'], ['Hamburguesa', 'Sandwich'], ['Taco', 'Burrito'], ['Sopa', 'Crema']
        ],
        lugares: [
            ['Playa', 'Piscina'], ['Cine', 'Teatro'], ['Escuela', 'Universidad'], ['Hospital', 'Cl√≠nica']
        ]
    };

    // --- FUNCIONES DE NAVEGACI√ìN ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- L√ìGICA DE CONEXI√ìN ---
    async function createRoom() {
        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        myName = document.getElementById('username').value;
        if (!myName) return alert("Pon tu nombre");

        // 1. Crear Sala en DB
        const { error } = await supabase.from('rooms').insert({ 
            code: code, host_id: null, status: 'waiting' 
        }); // El host_id lo ponemos luego al crear el jugador para tener su UUID

        if (error) return alert("Error creando sala");
        
        await joinRoomProcess(code, true);
    }

    async function joinRoom() {
        const code = document.getElementById('roomCode').value.toUpperCase();
        myName = document.getElementById('username').value;
        if (!myName || !code) return alert("Faltan datos");
        await joinRoomProcess(code, false);
    }

    async function joinRoomProcess(code, hostStatus) {
        currentRoom = code;
        isHost = hostStatus;

        // 1. Crear Jugador en DB
        const { data, error } = await supabase.from('players').insert({
            room_code: code,
            name: myName,
            is_impostor: false
        }).select().single();

        if (error) return alert("Error al unirse. ¬øExiste la sala?");
        myId = data.id;

        // Si soy host, actualizo la sala para decir que soy el due√±o
        if (isHost) {
            await supabase.from('rooms').update({ host_id: myId }).eq('code', code);
            document.getElementById('host-controls').style.display = 'block';
            document.getElementById('waiting-msg').style.display = 'none';
        }

        document.getElementById('lobby-code').innerText = code;
        showScreen('screen-lobby');
        subscribeToRoom();
    }

    // --- SUSCRIPCI√ìN A CAMBIOS (REALTIME DB) ---
    function subscribeToRoom() {
        // Escuchar cambios en la SALA (ej: cuando empieza el juego)
        supabase.channel('room-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `code=eq.${currentRoom}` }, 
            (payload) => {
                const room = payload.new;
                if (room.status === 'playing') {
                    enterGame(room);
                } else if (room.status === 'finished') {
                    alert("¬°Juego Terminado!");
                    location.reload();
                }
            })
            .subscribe();

        // Escuchar cambios en JUGADORES (nuevos jugadores, votos, muertes)
        supabase.channel('players-updates')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `room_code=eq.${currentRoom}` }, 
            () => { refreshPlayerList(); })
            .subscribe();

        refreshPlayerList();
    }

    async function refreshPlayerList() {
        const { data: players } = await supabase.from('players').select('*').eq('room_code', currentRoom);
        
        // Renderizar lista del Lobby
        const lobbyList = document.getElementById('lobby-players');
        lobbyList.innerHTML = players.map(p => `<li>${p.name}</li>`).join('');

        // Renderizar lista del Juego (para votar)
        const gameList = document.getElementById('game-players');
        gameList.innerHTML = players.map(p => {
            if (!p.is_alive) return `<li style="opacity:0.5">üíÄ ${p.name} (Eliminado)</li>`;
            
            // Bot√≥n de votar (solo si estoy vivo y no soy yo mismo)
            const voteBtn = (p.id !== myId) 
                ? `<button onclick="votePlayer('${p.id}')">Votar (${p.votes})</button>` 
                : `<span>(Votos: ${p.votes})</span>`;
                
            return `<li>${p.name} ${voteBtn}</li>`;
        }).join('');
        
        // Chequeo simple de "Game Over" por votaci√≥n (L√≥gica b√°sica)
        // En un juego real, esto deber√≠a hacerlo el servidor o el host
        players.forEach(p => {
            if (p.votes >= Math.floor(players.length / 2) + 1 && p.is_alive) {
                eliminatePlayer(p);
            }
        });
    }

    // --- L√ìGICA DEL HOST (START GAME) ---
    async function startGame() {
        const category = document.getElementById('category-select').value;
        
        // 1. Elegir par de palabras aleatorio
        const pair = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
        const wordCivilian = pair[0];
        const wordImpostor = pair[1];

        // 2. Obtener jugadores y elegir impostor
        const { data: players } = await supabase.from('players').select('id').eq('room_code', currentRoom);
        const impostorIndex = Math.floor(Math.random() * players.length);
        const impostorId = players[impostorIndex].id;

        // 3. Actualizar Jugadores (Asignar rol)
        // Primero reseteamos a todos a falso
        await supabase.from('players').update({ is_impostor: false, votes: 0, is_alive: true }).eq('room_code', currentRoom);
        // Luego ponemos al impostor
        await supabase.from('players').update({ is_impostor: true }).eq('id', impostorId);

        // 4. Actualizar Sala (Guardar palabras y cambiar estado)
        await supabase.from('rooms').update({
            category: category,
            word_civilian: wordCivilian,
            word_impostor: wordImpostor,
            status: 'playing'
        }).eq('code', currentRoom);
    }

    // --- L√ìGICA DEL CLIENTE (ENTRAR AL JUEGO) ---
    async function enterGame(roomData) {
        // Consultar mi rol actualizado
        const { data: me } = await supabase.from('players').select('*').eq('id', myId).single();
        
        const myWord = me.is_impostor ? roomData.word_impostor : roomData.word_civilian;
        const roleTitle = me.is_impostor ? "üïµÔ∏è ERES EL IMPOSTOR" : "üòÄ ERES CIUDADANO";
        
        document.getElementById('my-word-display').innerHTML = `
            <strong>${roleTitle}</strong><br><br>
            Tu palabra secreta es: <br>
            <h2 style="color: #333">${myWord}</h2>
            <small>Categor√≠a: ${roomData.category}</small>
        `;

        if (me.is_impostor) {
            document.getElementById('impostor-actions').style.display = 'block';
            // Guardamos la palabra real del civil localmente para comprobar si gana
            myRoleData = { targetWord: roomData.word_civilian };
        } else {
            document.getElementById('impostor-actions').style.display = 'none';
        }

        showScreen('screen-game');
    }

    // --- ACCIONES DEL JUEGO ---
    
    // 1. Votar para echar
    async function votePlayer(targetId) {
        // En una implementaci√≥n real, deber√≠as tener una tabla 'votes' para evitar doble voto.
        // Aqu√≠ hacemos un incremento simple (+1 voto).
        // Nota: esto tiene problemas de concurrencia en SQL puro, pero sirve para MVP.
        const { data } = await supabase.rpc('increment_vote', { row_id: targetId }); 
        // *Nota: Necesitar√≠as crear una funci√≥n RPC en Supabase o hacerlo con una lectura+escritura r√°pida.
        // Para simplificar este ejemplo sin RPC, haremos lectura + escritura:
        
        const { data: p } = await supabase.from('players').select('votes').eq('id', targetId).single();
        await supabase.from('players').update({ votes: p.votes + 1 }).eq('id', targetId);
    }

    // 2. Eliminar jugador (si recibe muchos votos)
    async function eliminatePlayer(player) {
        if(isHost) { // Solo el host ejecuta la eliminaci√≥n para evitar conflictos
            await supabase.from('players').update({ is_alive: false, votes: 0 }).eq('id', player.id);
            if (player.is_impostor) {
                // Si echaron al impostor, ganan los civiles
                 supabase.from('rooms').update({ status: 'finished' }).eq('code', currentRoom);
                 alert("¬°El Impostor fue eliminado! Ganan los Ciudadanos.");
            }
        }
    }

    // 3. Impostor intenta adivinar
    async function attemptWin() {
        const guess = document.getElementById('guess-input').value.trim().toLowerCase();
        const target = myRoleData.targetWord.toLowerCase();

        if (guess === target) {
            alert("¬°CORRECTO! El Impostor ha adivinado la palabra y GANA.");
            await supabase.from('rooms').update({ status: 'finished' }).eq('code', currentRoom);
        } else {
            alert("¬°INCORRECTO! Te has delatado.");
            // Podr√≠as matarlo autom√°ticamente aqu√≠
        }
    }

</script>
</body>
</html>
