<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Online v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #6366f1; --bg: #0f172a; --card: #1e293b; --txt: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        .hidden { display: none !important; }
        .screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .panel { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }

        /* Lobby & Chat Layout */
        #game-layout { display: flex; flex: 1; height: 100vh; }
        .main-game { flex: 2; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .chat-sidebar { flex: 1; background: #111827; display: flex; flex-direction: column; padding: 15px; border-left: 1px solid #334155; }

        input, button, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        input { background: #334155; color: white; }
        button { background: var(--p); color: white; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; }

        #chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 0.9rem; }
        .msg { background: #1e293b; padding: 8px; border-radius: 5px; margin-bottom: 5px; }
        .msg b { color: var(--p); }

        .player-tag { display: inline-block; background: #475569; padding: 5px 12px; border-radius: 20px; margin: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen">
        <div class="panel">
            <h1>üïµÔ∏è El Impostor</h1>
            <input type="text" id="in-user" placeholder="Tu Nombre">
            <input type="text" id="in-room" placeholder="C√≥digo de Sala">
            <button onclick="entrarAlJuego()">ENTRAR A LA SALA</button>
            <p id="status-text" style="font-size: 0.8rem; color: #94a3b8; text-align: center;"></p>
        </div>
    </div>

    <div id="screen-game" class="hidden" style="display: flex; flex: 1;">
        <div class="main-game">
            <div class="panel">
                <h2 id="display-room-name">Sala: ---</h2>
                <div id="player-list"></div>
            </div>

            <div id="host-panel" class="panel hidden">
                <h3>Ajustes de Anfitri√≥n</h3>
                <label>Categor√≠a:</label>
                <select id="sel-cat">
                    <option value="Comida">Comida üçî</option>
                    <option value="Lugares">Lugares üóº</option>
                </select>
                <button onclick="iniciarPartida()" style="background: #10b981;">EMPEZAR JUEGO</button>
            </div>

            <div id="role-panel" class="panel hidden" style="border: 2px solid gold; text-align: center;">
                <h1 id="display-word">---</h1>
                <p id="display-hint"></p>
            </div>

            <div id="waiting-msg" class="panel" style="text-align: center;">
                Esperando al anfitri√≥n...
            </div>
        </div>

        <div class="chat-sidebar">
            <h3>Chat</h3>
            <div id="chat-messages"></div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="Escribe..." style="margin: 0;">
                <button onclick="enviarMensaje()" style="width: 60px; margin: 0;">‚úàÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let myUser = "", myRoom = "", isHost = false;

        async function entrarAlJuego() {
            const status = document.getElementById('status-text');
            myUser = document.getElementById('in-user').value.trim();
            myRoom = document.getElementById('in-room').value.trim();

            if (!myUser || !myRoom) return alert("Rellena los datos");

            status.innerText = "Conectando...";

            try {
                // 1. Ver si la sala existe
                let { data: room } = await sb.from('rooms').select('*').eq('code', myRoom).maybeSingle();
                
                if (!room) {
                    isHost = true;
                    await sb.from('rooms').insert([{ code: myRoom, status: 'waiting' }]);
                }

                // 2. Unirse como jugador
                await sb.from('players').insert([{ room_id: myRoom, username: myUser, is_host: isHost }]);

                // 3. Cambiar de pantalla
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('display-room-name').innerText = "Sala: " + myRoom;
                
                if(isHost) {
                    document.getElementById('host-panel').classList.remove('hidden');
                    document.getElementById('waiting-msg').classList.add('hidden');
                }

                conectarRealtime();
                cargarMensajes();
                actualizarJugadores();

            } catch (err) {
                status.innerText = "Error: " + err.message;
            }
        }

        function conectarRealtime() {
            // Escuchar Mensajes
            sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${myRoom}` }, 
                p => dibujarMensaje(p.new)).subscribe();

            // Escuchar Jugadores
            sb.channel('players').on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `room_id=eq.${myRoom}` }, 
                () => actualizarJugadores()).subscribe();

            // Escuchar Sala (Inicio de juego)
            sb.channel('room').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `code=eq.${myRoom}` }, 
                p => renderizarRonda(p.new)).subscribe();
        }

        async function enviarMensaje() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            await sb.from('messages').insert([{ room_id: myRoom, username: myUser, content: input.value }]);
            input.value = "";
        }

        function dibujarMensaje(m) {
            const container = document.getElementById('chat-messages');
            container.innerHTML += `<div class="msg"><b>${m.username}:</b> ${m.content}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        async function cargarMensajes() {
            const { data } = await sb.from('messages').select('*').eq('room_id', myRoom).order('created_at', {ascending: true});
            data?.forEach(m => dibujarMensaje(m));
        }

        async function actualizarJugadores() {
            const { data } = await sb.from('players').select('*').eq('room_id', myRoom);
            if(data) {
                document.getElementById('player-list').innerHTML = data.map(p => 
                    `<span class="player-tag">${p.is_host ? 'üëë':'üë§'} ${p.username}</span>`).join('');
            }
        }

        async function iniciarPartida() {
            const { data: ps } = await sb.from('players').select('username').eq('room_id', myRoom);
            const imp = ps[Math.floor(Math.random() * ps.length)].username;
            const cat = document.getElementById('sel-cat').value;
            const word = cat === "Comida" ? "Pizza" : "Par√≠s";
            const hint = cat === "Comida" ? "Es redonda e italiana" : "Ciudad de la torre Eiffel";

            await sb.from('rooms').update({
                status: 'playing',
                word: word,
                hint: hint,
                impostor_id: imp
            }).eq('code', myRoom);
        }

        function renderizarRonda(sala) {
            if (sala.status === 'playing') {
                document.getElementById('host-panel').classList.add('hidden');
                document.getElementById('waiting-msg').classList.add('hidden');
                document.getElementById('role-panel').classList.remove('hidden');

                const esImpostor = sala.impostor_id === myUser;
                document.getElementById('display-word').innerText = esImpostor ? "¬°ERES EL IMPOSTOR!" : sala.word;
                document.getElementById('display-hint').innerText = esImpostor ? "Pista: " + sala.hint : "Encuentra al impostor.";
            }
        }
    </script>
</body>
</html>
