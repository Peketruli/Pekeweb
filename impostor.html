<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Impostor Online</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  background:#0b0f1a;
  color:#fff;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  background:#141a2e;
  padding:20px;
  border-radius:14px;
  width:360px;
}
button,input,select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:none;
}
button{background:#ff4757;color:white}
.hidden{display:none}
.code{font-size:22px;text-align:center;background:#000;padding:10px}
.big{text-align:center;font-size:20px;margin:20px 0}
</style>
</head>
<body>

<div class="card" id="menu">
  <h2>üïµÔ∏è Impostor Online</h2>
  <input id="name" placeholder="Tu nombre">
  <button onclick="crearSala()">Crear sala</button>
  <input id="roomCode" placeholder="C√≥digo de sala">
  <button onclick="unirse()">Unirse</button>
</div>

<div class="card hidden" id="host">
  <h3>Ajustes</h3>
  <select id="genre">
    <option value="general">General</option>
    <option value="lugares">Lugares</option>
  </select>
  <input id="impostors" type="number" value="1" min="1">
  <button onclick="startGame()">Iniciar juego</button>
  <div class="code" id="code"></div>
</div>

<div class="card hidden" id="game">
  <h2>Tu rol</h2>
  <div class="big" id="roleText"></div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

let roomId = "";
let playerName = "";

const words = {
  general:[
    ["Playa","Vacaciones"],
    ["Hospital","M√©dicos"]
  ],
  lugares:[
    ["Cine","Pel√≠culas"],
    ["Escuela","Clases"]
  ]
};

async function crearSala(){
  playerName = name.value;
  roomId = Math.random().toString(36).substring(2,7).toUpperCase();

  await supabase.from("rooms").insert({
    id:roomId,
    settings:{genre:"general",impostors:1}
  });

  await supabase.from("players").insert({
    room_id:roomId,
    name:playerName
  });

  menu.classList.add("hidden");
  host.classList.remove("hidden");
  code.innerText = roomId;
}

async function unirse(){
  playerName = name.value;
  roomId = roomCode.value.toUpperCase();

  await supabase.from("players").insert({
    room_id:roomId,
    name:playerName
  });

  menu.classList.add("hidden");
  esperarInicio();
}

async function startGame(){
  const genre = document.getElementById("genre").value;
  const imp = +document.getElementById("impostors").value;

  const list = words[genre];
  const chosen = list[Math.floor(Math.random()*list.length)];

  const { data:players } = await supabase
    .from("players")
    .select("*")
    .eq("room_id",roomId);

  let roles = Array(players.length).fill("civil");
  for(let i=0;i<imp;i++) roles[i]="impostor";
  roles.sort(()=>Math.random()-0.5);

  for(let i=0;i<players.length;i++){
    await supabase.from("players")
      .update({role:roles[i]})
      .eq("id",players[i].id);
  }

  await supabase.from("rooms")
    .update({started:true,word:chosen[0],hint:chosen[1]})
    .eq("id",roomId);
}

function esperarInicio(){
  supabase.channel("room")
    .on("postgres_changes",{event:"UPDATE",schema:"public",table:"rooms"},
    payload=>{
      if(payload.new.started){
        mostrarRol();
      }
    }).subscribe();
}

async function mostrarRol(){
  const { data:player } = await supabase
    .from("players")
    .select("*")
    .eq("room_id",roomId)
    .eq("name",playerName)
    .single();

  const { data:room } = await supabase
    .from("rooms")
    .select("*")
    .eq("id",roomId)
    .single();

  menu.classList.add("hidden");
  host.classList.add("hidden");
  game.classList.remove("hidden");

  roleText.innerText =
    player.role==="impostor"
    ? "IMPOSTOR\nPista: "+room.hint
    : room.word;
}
</script>

</body>
</html>
