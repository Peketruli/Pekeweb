<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #6366f1; --bg: #030712; --card: #111827; --accent: #f59e0b; 
            --active: #10b981; --danger: #ef4444; --txt: #f8fafc; --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { 
            font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--txt); margin: 0; 
            display: flex; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%);
        }

        .hidden { display: none !important; }

        /* --- PANTALLA INICIO MEJORADA --- */
        #screen-login { position:fixed; inset:0; background:var(--bg); z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
        .login-container { display: flex; gap: 20px; width: 90%; max-width: 900px; height: 500px; }
        .lobby-box { flex: 1; background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); border-radius: 24px; padding: 30px; border: 1px solid var(--border); overflow-y: auto; }
        .room-card { 
            background: #1f2937; padding: 15px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid transparent;
        }
        .room-card:hover { border-color: var(--p); transform: translateX(5px); }

        /* --- GAME UI --- */
        .main-game { flex: 2; padding: 25px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .sidebar { flex: 0.8; background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); display: flex; flex-direction: column; padding: 20px; border-left: 1px solid var(--border); }
        .panel { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); }

        /* --- ESTADOS --- */
        #player-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .player-tag { padding: 12px; border-radius: 14px; background: #1f2937; text-align: center; font-weight: 700; border: 2px solid transparent; }
        .is-active-turn { border-color: var(--active); background: #064e3b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); } 70% { box-shadow: 0 0 0 10px rgba(16,185,129,0); } 100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); } }
        .dead { opacity: 0.3; filter: grayscale(1); }

        /* --- BOTONES --- */
        input, select, button { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #0f172a; color: white; outline: none; }
        button { background: var(--p); cursor: pointer; border: none; font-weight: 800; }
        .btn-start { background: var(--active); width: 100%; margin-top: 10px; }
        .btn-exit { background: var(--danger); font-size: 0.8rem; padding: 8px 15px; }

        /* --- END SCREEN --- */
        #end-screen { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
    </style>
</head>
<body>

    <div id="screen-login">
        <h1 style="font-size: 3rem; margin: 0;">üïµÔ∏è IMPOSTOR</h1>
        <div class="login-container">
            <div class="lobby-box">
                <h3 style="margin-top:0; color:var(--active);">üåê SALAS P√öBLICAS</h3>
                <div id="public-rooms-list">Cargando salas...</div>
            </div>
            <div class="lobby-box" style="max-width: 350px; display:flex; flex-direction:column; gap:12px;">
                <h3>UNIRSE / CREAR</h3>
                <input type="text" id="in-user" placeholder="Tu Apodo">
                <input type="text" id="in-room" placeholder="C√≥digo de Sala">
                <button onclick="entrarAlJuego()" style="height: 55px;">ENTRAR AHORA</button>
            </div>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h1 id="end-title" style="font-size: 5rem;">---</h1>
        <p id="end-subtitle" style="font-size: 1.5rem; color: gray;"></p>
        <div id="host-controls" class="hidden" style="margin-top: 30px;">
            <button onclick="reiniciarSala()" class="btn-start" style="padding: 15px 40px;">üîÑ VOLVER AL LOBBY</button>
        </div>
    </div>

    <div id="game-layout" style="display: flex; width: 100%;">
        <div class="main-game">
            <div class="panel" style="display:flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="room-display" style="margin:0; color:var(--p);">SALA: ---</h2>
                    <div id="imp-status" class="hidden" style="color:var(--danger); font-weight:bold; font-size:0.9rem; margin-top:5px;">
                        ‚ö†Ô∏è IMPOSTORES VIVOS: <span id="imp-count-val">0</span>
                    </div>
                </div>
                <button onclick="salirDelJuego()" class="btn-exit">SALIR DEL JUEGO</button>
            </div>

            <div id="host-panel" class="panel hidden">
                <h4 style="margin:0 0 10px 0;">üîß AJUSTES DEL ANFITRI√ìN</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="set-imps"><option value="1">1 Impostor</option><option value="2">2 Impostores</option></select>
                    <select id="set-cat"><option value="all">Todo Mezclado</option><option value="animals">Animales</option><option value="food">Comida</option></select>
                </div>
                <button onclick="iniciarPartida()" class="btn-start">üöÄ EMPEZAR PARTIDA</button>
            </div>

            <div class="panel"><div id="player-list"></div></div>

            <div id="role-box" class="panel hidden" style="text-align:center; border: 2px solid var(--p);">
                <div id="role-label" class="badge">TU PALABRA</div>
                <h2 id="word-display" style="font-size: 2.5rem; margin:10px 0;">---</h2>
                <p id="hint-display" style="color:var(--accent); font-weight:bold;"></p>
            </div>

            <div id="vote-box" class="panel hidden">
                <h3 style="color:var(--danger); margin:0 0 15px 0;">üó≥Ô∏è VOTACI√ìN: ¬øQUI√âN ES?</h3>
                <div id="vote-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>
        </div>

        <div class="sidebar">
            <div id="turn-label" style="text-align:center; font-weight: 800; margin-bottom: 15px; color:var(--active);">ESPERANDO...</div>
            <div id="chat-messages"></div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="chat-input" placeholder="Escribe..." style="flex:1;">
                <button onclick="enviarMensaje()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let myU = "", myR = "", isH = false, pList = [], gState = "waiting", tIdx = 0;
        const DATA = {
            all: [{w:"PIZZA", h:"Comida"}, {w:"TIGRE", h:"Animal"}, {w:"AVI√ìN", h:"Transporte"}, {w:"TEL√âFONO", h:"Objeto"}],
            animals: [{w:"GATO", h:"Animal"}, {w:"ELEFANTE", h:"Animal"}],
            food: [{w:"SUSHI", h:"Comida"}]
        };

        // --- L√ìGICA INICIAL ---
        async function loadPublicRooms() {
            const { data } = await sb.from('rooms').select('code').eq('status', 'waiting').limit(10);
            const list = document.getElementById('public-rooms-list');
            if(!data || data.length === 0) { list.innerHTML = "<p style='color:gray;'>No hay salas activas...</p>"; return; }
            list.innerHTML = data.map(r => `
                <div class="room-card" onclick="document.getElementById('in-room').value='${r.code}'">
                    <span>üè† SALA: <b>${r.code}</b></span>
                    <small style="color:var(--p);">UNIRSE ‚Üí</small>
                </div>
            `).join('');
        }
        setInterval(loadPublicRooms, 10000); loadPublicRooms();

        async function entrarAlJuego() {
            myU = document.getElementById('in-user').value.trim();
            myR = document.getElementById('in-room').value.trim().toUpperCase();
            if(!myU || !myR) return alert("Rellena los campos");

            let { data: room } = await sb.from('rooms').select('*').eq('code', myR).maybeSingle();
            if(!room) {
                isH = true;
                await sb.from('rooms').insert([{ code: myR, status: 'waiting' }]);
            } else if(room.status !== 'waiting') return alert("Sala en juego");

            await sb.from('players').insert([{ room_id: myR, username: myU, is_host: isH }]);
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('room-display').innerText = "SALA: " + myR;
            setupRealtime();
            actualizarUI();
            setInterval(actualizarUI, 4000);
        }

        async function salirDelJuego() {
            await sb.from('players').delete().eq('username', myU).eq('room_id', myR);
            location.reload();
        }

        function setupRealtime() {
            sb.channel('r').on('postgres_changes', { event: '*', schema: 'public', table: 'rooms', filter: `code=eq.${myR}` }, () => actualizarUI()).subscribe();
            sb.channel('p').on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `room_id=eq.${myR}` }, () => actualizarUI()).subscribe();
            sb.channel('c').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${myR}` }, p => {
                const b = document.getElementById('chat-messages');
                const d = document.createElement('div');
                d.className = 'msg' + (p.new.is_clue ? ' msg-clue' : '');
                d.innerHTML = `<b>${p.new.username}:</b> ${p.new.content}`;
                b.appendChild(d); b.scrollTop = b.scrollHeight;
            }).subscribe();
        }

        async function actualizarUI() {
            const { data: ps } = await sb.from('players').select('*').eq('room_id', myR).order('created_at');
            const { data: sa } = await sb.from('rooms').select('*').eq('code', myR).single();
            if(!ps || !sa) return;

            pList = ps; gState = sa.status; tIdx = sa.turn_index;
            const me = ps.find(p => p.username === myU);
            if(!me) return location.reload(); // Expulsado o sali√≥

            // Fin de Juego
            if(sa.winner_side) {
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-title').innerText = "GANAN LOS " + sa.winner_side.toUpperCase();
                document.getElementById('end-title').style.color = sa.winner_side === 'impostores' ? 'var(--danger)' : 'var(--active)';
                document.getElementById('end-subtitle').innerText = "Los impostores eran: " + sa.impostor_id;
                if(me.is_host) document.getElementById('host-controls').classList.remove('hidden');
            } else {
                document.getElementById('end-screen').classList.add('hidden');
            }

            // Panel Host e Impostores
            if(me.is_host && gState === 'waiting') document.getElementById('host-panel').classList.remove('hidden');
            else document.getElementById('host-panel').classList.add('hidden');

            if(gState !== 'waiting' && !sa.winner_side) {
                document.getElementById('imp-status').classList.remove('hidden');
                document.getElementById('imp-count-val').innerText = sa.impostores_vivos;
            } else document.getElementById('imp-status').classList.add('hidden');

            // Jugadores
            document.getElementById('player-list').innerHTML = ps.map((p, i) => `
                <div class="player-tag ${i===tIdx && gState==='playing'?'is-active-turn':''} ${!p.is_alive?'dead':''}">
                    ${p.is_host?'üëë ':''}${p.username} ${p.has_voted?'‚úÖ':''}
                </div>`).join('');

            // Role Box
            if(gState === 'playing') {
                document.getElementById('role-box').classList.remove('hidden');
                const imps = sa.impostor_id.split(',');
                const soyImp = imps.includes(myU);
                document.getElementById('role-label').innerText = soyImp ? "TU OBJETIVO" : "TU PALABRA";
                document.getElementById('word-display').innerText = soyImp ? "üïµÔ∏è IMPOSTOR" : sa.word;
                document.getElementById('hint-display').innerText = soyImp ? "¬°No dejes que te descubran!" : "PISTA: " + sa.hint;
                document.getElementById('turn-label').innerText = "üó£Ô∏è TURNO DE: " + (ps[tIdx]?.username || "");
            } else {
                document.getElementById('role-box').classList.add('hidden');
                document.getElementById('turn-label').innerText = gState === 'voting' ? "üó≥Ô∏è VOTANDO..." : "ESPERANDO...";
            }

            // Votos
            if(gState === 'voting' && me.is_alive && !me.has_voted) {
                document.getElementById('vote-box').classList.remove('hidden');
                document.getElementById('vote-options').innerHTML = ps.filter(p=>p.is_alive).map(p => `
                    <button onclick="votar('${p.username}')">${p.username}</button>
                `).join('') + `<button onclick="votar('skip')" style="background:#374151; grid-column:span 2;">‚è≠Ô∏è SALTAR</button>`;
            } else document.getElementById('vote-box').classList.add('hidden');

            if(me.is_host) procesarVotos(sa);
        }

        async function iniciarPartida() {
            if(pList.length < 3) return alert("M√≠nimo 3 jugadores");
            const cat = document.getElementById('set-cat').value;
            const item = DATA[cat][Math.floor(Math.random()*DATA[cat].length)];
            
            // L√≥gica corregida para m√∫ltiples impostores
            let numI = parseInt(document.getElementById('set-imps').value);
            let imps = [...pList].sort(() => 0.5 - Math.random()).slice(0, numI).map(p => p.username);

            await sb.from('messages').delete().eq('room_id', myR);
            await sb.from('players').update({ is_alive:true, has_voted:false, voted_for:null }).eq('room_id', myR);
            await sb.from('rooms').update({ 
                status:'playing', word:item.w, hint:item.h, impostor_id:imps.join(','), 
                turn_index:0, winner_side:null, impostores_vivos:imps.length 
            }).eq('code', myR);
        }

        async function reiniciarSala() {
            await sb.from('rooms').update({ status:'waiting', winner_side:null, word:null, impostor_id:null }).eq('code', myR);
            await sb.from('players').update({ is_alive:true, has_voted:false, voted_for:null }).eq('room_id', myR);
        }

        async function enviarMensaje() {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if(!val) return;
            const esT = (pList[tIdx]?.username === myU && gState === 'playing');
            await sb.from('messages').insert([{ room_id: myR, username: myU, content: val, is_clue: esT }]);
            input.value = "";
            if(esT) {
                let n = tIdx + 1;
                while(pList[n] && !pList[n].is_alive) n++;
                if(n >= pList.length) await sb.from('rooms').update({ status:'voting' }).eq('code', myR);
                else await sb.from('rooms').update({ turn_index:n }).eq('code', myR);
            }
        }

        async function votar(dest) { await sb.from('players').update({ has_voted: true, voted_for: dest }).eq('username', myU).eq('room_id', myR); }

        async function procesarVotos(sala) {
            const vivos = pList.filter(p => p.is_alive);
            const votos = pList.filter(p => p.is_alive && p.has_voted);
            if(votos.length === vivos.length && vivos.length > 0) {
                let c = {}; votos.forEach(v => c[v.voted_for] = (c[v.voted_for] || 0) + 1);
                let expulsado = Object.keys(c).reduce((a, b) => c[a] > c[b] ? a : b);
                
                if(expulsado !== 'skip') {
                    await sb.from('players').update({ is_alive: false }).eq('username', expulsado).eq('room_id', myR);
                    if(sala.impostor_id.split(',').includes(expulsado)) {
                        let rest = sala.impostores_vivos - 1;
                        if(rest <= 0) return await sb.from('rooms').update({ winner_side: 'tripulaci√≥n', impostores_vivos: 0 }).eq('code', myR);
                        await sb.from('rooms').update({ impostores_vivos: rest }).eq('code', myR);
                    }
                }
                
                const nuevosVivos = pList.filter(p => p.is_alive && p.username !== expulsado);
                const impsRest = nuevosVivos.filter(p => sala.impostor_id.split(',').includes(p.username)).length;
                if(impsRest >= (nuevosVivos.length - impsRest)) {
                    await sb.from('rooms').update({ winner_side: 'impostores' }).eq('code', myR);
                } else {
                    await sb.from('players').update({ has_voted: false, voted_for: null }).eq('room_id', myR);
                    await sb.from('rooms').update({ status: 'playing', turn_index: 0 }).eq('code', myR);
                }
            }
        }
        document.getElementById('chat-input').onkeypress = (e) => { if(e.key === 'Enter') enviarMensaje(); };
    </script>
</body>
</html>
