<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego Impostor - DiagnÃ³stico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; text-align: center; padding: 20px; }
        
        /* ESTILOS DEL DEBUGGER VISUAL */
        #debug-log {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #0f0;
            text-align: left;
            min-height: 100px;
            font-size: 12px;
            white-space: pre-wrap;
        }

        button { padding: 15px; width: 100%; margin: 5px 0; font-size: 16px; cursor: pointer; }
        input { padding: 10px; width: 90%; margin: 5px 0; }
        .screen { display: none; }
        .active { display: block; }
    </style>
</head>
<body>

    <h3>ðŸ”§ Consola de DiagnÃ³stico</h3>
    <div id="debug-log">Iniciando sistema...</div>

    <hr>

    <div id="screen-login" class="screen active">
        <h2>Entrar al Juego</h2>
        <input type="text" id="username" placeholder="Nombre">
        <input type="text" id="roomCode" placeholder="CÃ³digo (solo para unirse)">
        <button onclick="debugCreate()">Crear Sala</button>
        <button onclick="debugJoin()">Unirse a Sala</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>Sala: <span id="lobby-code"></span></h2>
        <ul id="lobby-players"></ul>
        <p>Esperando...</p>
    </div>

<script>
    // --- FUNCIÃ“N PARA ESCRIBIR EN PANTALLA ---
    function log(msg) {
        const box = document.getElementById('debug-log');
        const time = new Date().toLocaleTimeString();
        box.innerHTML += `\n[${time}] ${msg}`;
        // Scroll al fondo
        box.scrollTop = box.scrollHeight;
    }

    // --- PROTECCIÃ“N DE ERRORES GLOBAL ---
    window.onerror = function(msg, url, line) {
        log(`âŒ ERROR CRÃTICO (LÃ­nea ${line}): ${msg}`);
        return false;
    };

    // --- 1. INTENTAR INICIAR SUPABASE ---
    log("Cargando script...");
    
    // ==========================================
    // PON TUS CLAVES AQUÃ ABAJO
    // ==========================================
    const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';

    let supabase;

    try {
        if (!window.supabase) {
            log("âŒ ERROR: La librerÃ­a de Supabase no cargÃ³.");
        } else {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            log("âœ… Supabase inicializado correctamente.");
            log("Esperando acciÃ³n del usuario...");
        }
    } catch (e) {
        log("âŒ ExcepciÃ³n al iniciar: " + e.message);
    }

    // --- FUNCIONES DE BOTONES ---

    async function debugCreate() {
        log("ðŸ‘‰ BotÃ³n 'Crear' presionado.");
        
        const name = document.getElementById('username').value;
        if (!name) return log("âš ï¸ Falta el nombre.");

        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        log(`Intentando crear sala ${code} en DB...`);

        try {
            // Test de conexiÃ³n simple
            const { error } = await supabase.from('rooms').insert({ code: code, status: 'waiting' });
            
            if (error) {
                log("âŒ ERROR SQL: " + error.message);
                log("Â¿Has ejecutado el script SQL en Supabase?");
            } else {
                log("âœ… Sala creada en DB exitosamente.");
                // Unirse
                joinProcess(code, name);
            }
        } catch (err) {
            log("âŒ ERROR JS: " + err.message);
        }
    }

    async function debugJoin() {
        log("ðŸ‘‰ BotÃ³n 'Unirse' presionado.");
        const name = document.getElementById('username').value;
        const code = document.getElementById('roomCode').value.toUpperCase();

        if (!name || !code) return log("âš ï¸ Faltan datos (nombre o cÃ³digo).");

        // Verificar si existe
        const { data, error } = await supabase.from('rooms').select('*').eq('code', code).single();
        
        if (error) return log("âŒ Error buscando sala: " + error.message);
        if (!data) return log("âŒ La sala no existe.");

        log("âœ… Sala encontrada. UniÃ©ndose...");
        joinProcess(code, name);
    }

    async function joinProcess(code, name) {
        try {
            const { data, error } = await supabase.from('players').insert({
                room_code: code,
                name: name,
                is_impostor: false
            }).select();

            if (error) {
                log("âŒ Error al crear jugador: " + error.message);
            } else {
                log("âœ… Â¡Jugador unido! Cambiando pantalla...");
                document.getElementById('screen-login').style.display = 'none';
                document.getElementById('screen-lobby').style.display = 'block';
                document.getElementById('lobby-code').innerText = code;
                
                // Suscribirse
                log("Suscribiendo a cambios en tiempo real...");
                supabase.channel('public:players')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, payload => {
                        log("ðŸ”” Cambio detectado en jugadores");
                        updateList(code);
                    })
                    .subscribe();
                
                updateList(code);
            }
        } catch (e) {
            log("âŒ Error fatal en joinProcess: " + e.message);
        }
    }

    async function updateList(code) {
        const { data } = await supabase.from('players').select('name').eq('room_code', code);
        const list = document.getElementById('lobby-players');
        list.innerHTML = "";
        data.forEach(p => {
            list.innerHTML += `<li>${p.name}</li>`;
        });
    }

</script>
</body>
</html>
