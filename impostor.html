<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego Impostor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #2c3e50; color: white; text-align: center; }
        .screen { display: none; background: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .active { display: block; }
        button { padding: 12px 24px; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 5px; margin: 5px; font-size: 16px; font-weight: bold;}
        button:hover { background: #2ecc71; }
        button.danger { background: #c0392b; }
        input, select { padding: 12px; width: 80%; margin-bottom: 15px; border-radius: 5px; border: none; }
        .role-card { font-size: 1.5em; padding: 20px; border: 2px dashed #ecf0f1; margin: 20px 0; background: #2c3e50; }
        .player-list { list-style: none; padding: 0; text-align: left;}
        .player-list li { padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è ¬øQui√©n es el Impostor?</h1>

    <div id="screen-login" class="screen active">
        <h3>Entrar o Crear Sala</h3>
        <input type="text" id="username" placeholder="Tu nombre (ej: Alex)" required>
        <input type="text" id="roomCode" placeholder="C√≥digo de Sala (solo para unirse)">
        <br>
        <button onclick="createRoom()">Crear Nueva Sala</button>
        <button onclick="joinRoom()" style="background:#2980b9">Unirse a Sala</button>
        <p style="font-size: 0.8em; color: #aaa;">Abre la consola (F12) si tienes errores.</p>
    </div>

    <div id="screen-lobby" class="screen">
        <h3>Sala: <span id="lobby-code" style="color:#f1c40f"></span></h3>
        <p>Jugadores conectados:</p>
        <ul id="lobby-players" class="player-list"></ul>
        
        <div id="host-controls" class="hidden" style="border-top: 1px solid #7f8c8d; padding-top:10px;">
            <h4>üëë Eres el Admin</h4>
            <label>Categor√≠a:</label>
            <select id="category-select">
                <option value="animales">Animales</option>
                <option value="comida">Comida</option>
                <option value="lugares">Lugares</option>
            </select>
            <button onclick="startGame()">¬°Empezar Partida!</button>
        </div>
        <p id="waiting-msg">Esperando a que el l√≠der inicie...</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="role-card" id="my-word-display">Cargando...</div>
        
        <div id="impostor-actions" class="hidden" style="background: #c0392b; padding:10px; border-radius:5px;">
            <p>‚ö†Ô∏è <strong>IMPOSTOR:</strong> Adivina la palabra para ganar.</p>
            <input type="text" id="guess-input" placeholder="Escribe la palabra secreta">
            <button onclick="attemptWin()" style="background: white; color: #c0392b;">¬°S√© la palabra!</button>
        </div>

        <h4>Votaci√≥n en curso:</h4>
        <ul id="game-players" class="player-list"></ul>
    </div>

<script>
    // ==========================================
    // 1. PON TUS CLAVES DE SUPABASE AQU√ç
    // ==========================================
    const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
    
    // Inicializar cliente
    let supabase;
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Supabase inicializado correctamente.");
    } catch (e) {
        alert("Error iniciando Supabase. Revisa las claves en el c√≥digo.");
        console.error(e);
    }

    // Variables globales
    let myId = null;
    let myName = "";
    let currentRoom = "";
    let isHost = false;
    let myRoleData = null; 

    // Palabras
    const WORDS = {
        animales: [['Perro', 'Lobo'], ['Gato', 'Le√≥n'], ['Caballo', 'Burro'], ['Delf√≠n', 'Tibur√≥n']],
        comida: [['Pizza', 'Pasta'], ['Hamburguesa', 'Sandwich'], ['Taco', 'Fajita'], ['Manzana', 'Pera']],
        lugares: [['Playa', 'Piscina'], ['Cine', 'Teatro'], ['Hotel', 'Hospital'], ['Bar', 'Restaurante']]
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- CREAR SALA ---
    async function createRoom() {
        myName = document.getElementById('username').value;
        if (!myName) return alert("¬°Escribe tu nombre!");

        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        console.log("Intentando crear sala:", code);

        // Crear la sala
        const { error } = await supabase.from('rooms').insert({ 
            code: code, 
            status: 'waiting' 
        });

        if (error) {
            console.error("Error creando sala:", error);
            return alert("Error al crear sala: " + error.message);
        }

        // Si funciona, nos unimos como Host
        joinRoomProcess(code, true);
    }

    // --- UNIRSE A SALA ---
    async function joinRoom() {
        myName = document.getElementById('username').value;
        const code = document.getElementById('roomCode').value.toUpperCase();
        if (!myName || !code) return alert("Faltan datos");

        // Verificar si la sala existe
        const { data, error } = await supabase.from('rooms').select('*').eq('code', code).single();
        if (error || !data) return alert("La sala no existe.");

        joinRoomProcess(code, false);
    }

    // --- PROCESO COM√öN DE UNI√ìN ---
    async function joinRoomProcess(code, hostStatus) {
        currentRoom = code;
        isHost = hostStatus;

        console.log("Uniendo jugador...");
        const { data, error } = await supabase.from('players').insert({
            room_code: code,
            name: myName,
            is_impostor: false,
            votes: 0
        }).select().single();

        if (error) {
            console.error(error);
            return alert("Error al unirse a la DB.");
        }
        
        myId = data.id;
        console.log("Jugador creado con ID:", myId);

        // Si soy host, me guardo como due√±o de la sala
        if (isHost) {
            await supabase.from('rooms').update({ host_id: myId }).eq('code', code);
            document.getElementById('host-controls').classList.remove('hidden');
            document.getElementById('waiting-msg').classList.add('hidden');
        }

        document.getElementById('lobby-code').innerText = code;
        showScreen('screen-lobby');
        
        // Iniciar escucha en tiempo real
        subscribeToRoom();
    }

    // --- REALTIME ---
    function subscribeToRoom() {
        console.log("Suscribiendo a cambios...");
        const channel = supabase.channel('game_channel')
            // Escuchar cambios en la SALA
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `code=eq.${currentRoom}` }, 
            (payload) => {
                const room = payload.new;
                if (room.status === 'playing') enterGame(room);
                if (room.status === 'finished') { alert("Juego terminado"); location.reload(); }
            })
            // Escuchar cambios en JUGADORES
            .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: `room_code=eq.${currentRoom}` }, 
            () => refreshPlayerList())
            .subscribe((status) => {
                console.log("Estado suscripci√≥n:", status);
            });

        // Cargar lista inicial
        refreshPlayerList();
    }

    async function refreshPlayerList() {
        const { data: players } = await supabase.from('players').select('*').eq('room_code', currentRoom).order('name');
        
        // Lobby HTML
        document.getElementById('lobby-players').innerHTML = players.map(p => `<li>${p.name}</li>`).join('');

        // Juego HTML (Votaciones)
        document.getElementById('game-players').innerHTML = players.map(p => {
            if (!p.is_alive) return `<li style="opacity:0.5">üíÄ ${p.name} (Eliminado)</li>`;
            
            // Bot√≥n de votar (si no soy yo)
            const voteBtn = (p.id !== myId && p.is_alive) 
                ? `<button style="padding:5px; font-size:12px;" onclick="votePlayer('${p.id}', ${p.votes})">Votar (${p.votes})</button>` 
                : `<span>Votos: ${p.votes}</span>`;
                
            return `<li>${p.name} ${voteBtn}</li>`;
        }).join('');

        // Verificar eliminaci√≥n autom√°tica (si > 50% votos)
        const alivePlayers = players.filter(p => p.is_alive).length;
        if (isHost && alivePlayers > 0) {
            players.forEach(p => {
                if (p.votes > alivePlayers / 2 && p.is_alive) {
                    eliminatePlayer(p);
                }
            });
        }
    }

    // --- L√ìGICA DE JUEGO ---
    async function startGame() {
        const category = document.getElementById('category-select').value;
        const pair = WORDS[category][Math.floor(Math.random() * WORDS[category].length)];
        
        // Asignar Impostor
        const { data: players } = await supabase.from('players').select('id').eq('room_code', currentRoom);
        if(players.length < 2) return alert("Se necesitan al menos 2 jugadores");

        const impostorId = players[Math.floor(Math.random() * players.length)].id;

        // Resetear jugadores
        await supabase.from('players').update({ is_impostor: false, votes: 0, is_alive: true }).eq('room_code', currentRoom);
        await supabase.from('players').update({ is_impostor: true }).eq('id', impostorId);

        // Iniciar sala
        await supabase.from('rooms').update({
            category: category,
            word_civilian: pair[0],
            word_impostor: pair[1],
            status: 'playing'
        }).eq('code', currentRoom);
    }

    async function enterGame(roomData) {
        const { data: me } = await supabase.from('players').select('*').eq('id', myId).single();
        
        const myWord = me.is_impostor ? roomData.word_impostor : roomData.word_civilian;
        const roleText = me.is_impostor ? "Eres el IMPOSTOR üòà" : "Eres CIUDADANO üòá";
        const color = me.is_impostor ? "#c0392b" : "#27ae60";

        document.getElementById('my-word-display').innerHTML = `
            <h3 style="color:${color}">${roleText}</h3>
            <p>Tu palabra es:</p>
            <h1 style="font-size:3em; margin:10px 0;">${myWord}</h1>
            <small>Categor√≠a: ${roomData.category}</small>
        `;

        if (me.is_impostor) {
            document.getElementById('impostor-actions').classList.remove('hidden');
            myRoleData = { target: roomData.word_civilian };
        } else {
            document.getElementById('impostor-actions').classList.add('hidden');
        }

        showScreen('screen-game');
    }

    async function votePlayer(targetId, currentVotes) {
        await supabase.from('players').update({ votes: currentVotes + 1 }).eq('id', targetId);
    }

    async function eliminatePlayer(player) {
        await supabase.from('players').update({ is_alive: false }).eq('id', player.id);
        if (player.is_impostor) {
            alert("¬°Cazaron al impostor! Ganan los Ciudadanos.");
            await supabase.from('rooms').update({ status: 'finished' }).eq('code', currentRoom);
        }
    }

    async function attemptWin() {
        const guess = document.getElementById('guess-input').value.trim().toLowerCase();
        if (guess === myRoleData.target.toLowerCase()) {
            alert("¬°El Impostor adivin√≥! Gana el Impostor.");
            await supabase.from('rooms').update({ status: 'finished' }).eq('code', currentRoom);
        } else {
            alert("Fallaste. Te descubriste.");
        }
    }
</script>
</body>
</html>
