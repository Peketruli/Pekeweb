<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CONFIGURACI√ìN DE COLORES Y ESTILO --- */
        :root { 
            --p: #6366f1;           /* Color Principal (Morado) */
            --bg: #030712;          /* Fondo muy oscuro */
            --card: #111827;        /* Color de las tarjetas */
            --accent: #f59e0b;      /* Acento (Naranja) para pistas */
            --active: #10b981;      /* Verde para turnos y botones */
            --danger: #ef4444;      /* Rojo para salir/impostor */
            --txt: #f8fafc;         /* Texto blanco */
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg); 
            color: var(--txt); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%);
        }

        .hidden { display: none !important; }

        /* --- PANTALLA DE LOGIN (LOBBY) --- */
        #screen-login { 
            position:fixed; inset:0; z-index:5000; 
            background:var(--bg); 
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; 
        }
        .login-container { display: flex; gap: 20px; width: 90%; max-width: 900px; height: 500px; }
        
        @media(max-width: 700px) { .login-container { flex-direction: column; height: auto; } }

        .lobby-box { 
            flex: 1; 
            background: rgba(17, 24, 39, 0.8); 
            backdrop-filter: blur(10px); 
            border-radius: 24px; 
            padding: 30px; 
            border: 1px solid var(--border); 
            overflow-y: auto; 
        }

        .room-card { 
            background: #1f2937; padding: 15px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; border: 1px solid transparent;
        }
        .room-card:hover { border-color: var(--p); transform: translateX(5px); }

        /* --- INTERFAZ DEL JUEGO --- */
        .main-game { flex: 2; padding: 25px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .sidebar { 
            flex: 0.8; min-width: 300px;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); 
            display: flex; flex-direction: column; padding: 20px; 
            border-left: 1px solid var(--border); 
        }
        .panel { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); }

        /* --- JUGADORES --- */
        #player-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        
        .player-tag { 
            padding: 12px; border-radius: 14px; background: #1f2937; 
            text-align: center; font-weight: 700; border: 2px solid transparent; position: relative;
        }
        
        /* Efecto cuando es el turno del jugador */
        .is-active-turn { 
            border-color: var(--active); background: #064e3b; 
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(16,185,129,0); } 
            100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); } 
        }
        
        .dead { opacity: 0.4; filter: grayscale(1); text-decoration: line-through; }

        /* --- CHAT --- */
        #chat-messages { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        
        .msg { padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05); font-size: 0.9rem; border-left: 3px solid transparent; }
        
        /* CLASE IMPORTANTE: MENSAJE VERDE (PISTA) */
        .msg-clue { 
            background: rgba(16, 185, 129, 0.15) !important; 
            border-left-color: var(--active) !important; 
            color: #d1fae5; 
        }
        .msg b { display: block; font-size: 0.75rem; opacity: 0.7; margin-bottom: 2px; text-transform: uppercase; }

        /* --- ELEMENTOS DE FORMULARIO --- */
        input, select, button { 
            padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
            background: #0f172a; color: white; outline: none; width: 100%; 
            font-family: inherit; margin-bottom: 10px; font-size: 1rem;
        }
        
        button { background: var(--p); cursor: pointer; border: none; font-weight: 800; text-transform: uppercase; margin-bottom: 0; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .btn-start { background: var(--active); box-shadow: 0 4px 15px rgba(16,185,129,0.2); }
        .btn-exit { background: var(--danger); width: auto; font-size: 0.7rem; padding: 8px 16px; margin: 0; }

        /* --- PANTALLA FINAL --- */
        #end-screen { 
            position: fixed; inset: 0; z-index: 9999; 
            background: rgba(0,0,0,0.96); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
        }
    </style>
</head>
<body>

    <div id="screen-login">
        <h1 style="font-size: 3rem; margin: 0;">üïµÔ∏è IMPOSTOR </h1>
        <div class="login-container">
            <div class="lobby-box">
                <h3 style="margin-top:0; color:var(--active);">üåê SALAS P√öBLICAS</h3>
                <div id="public-rooms-list">
                    <p style="color:gray;">Buscando salas...</p>
                </div>
            </div>
            <div class="lobby-box" style="max-width: 350px; display:flex; flex-direction:column; justify-content:center;">
                <h3>ENTRAR A JUGAR</h3>
                <input type="text" id="in-user" placeholder="Tu Apodo (Ej: Alex)">
                <input type="text" id="in-room" placeholder="C√≥digo Sala (Ej: SALA1)">
                <button onclick="entrarAlJuego()" style="height: 55px; font-size: 1.1rem;">üöÄ CONECTAR</button>
            </div>
        </div>
    </div>

    <div id="end-screen" class="hidden">
        <h1 id="end-title" style="font-size: 4rem; margin: 0;">---</h1>
        <p id="end-subtitle" style="font-size: 1.5rem; color: gray; margin-bottom: 30px;"></p>
        <div id="host-controls" class="hidden">
            <button onclick="reiniciarSala()" class="btn-start" style="width: auto; padding: 15px 40px;">üîÑ VOLVER AL LOBBY</button>
        </div>
    </div>

    <div id="game-layout" style="display: flex; width: 100%;">
        
        <div class="main-game">
            <div class="panel" style="display:flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="room-display" style="margin:0; color:var(--p);">SALA: ---</h2>
                    <div id="imp-status" class="hidden" style="color:var(--danger); font-weight:bold; font-size:0.9rem; margin-top:5px;">
                        ‚ö†Ô∏è IMPOSTORES VIVOS: <span id="imp-count-val">0</span>
                    </div>
                </div>
                <button onclick="salirDelJuego()" class="btn-exit">SALIR</button>
            </div>

            <div id="host-panel" class="panel hidden" style="border-color: var(--active);">
                <h4 style="margin:0 0 10px 0; color:var(--active);">‚öôÔ∏è AJUSTES DE PARTIDA</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CANTIDAD IMPOSTORES</label>
                        <select id="set-imps" onchange="actualizarSala()">
                            <option value="1">1 Impostor</option>
                            <option value="2">2 Impostores</option>
                            <option value="rand">üé≤ Aleatorio</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CATEGOR√çA</label>
                        <select id="set-cat" onchange="actualizarSala()">
                            <option value="all">üé≤ MIX SUPREMO (Recomendado)</option>
                             <option value="animals">ü¶Å Reino Animal</option>
                            <option value="food">üçî Comida y Bebida</option>
                            <option value="geek">ü¶∏ Cine, Juegos y Geek</option>
                            <option value="places">üåç Lugares del Mundo</option>
                            <option value="jobs">üíº Profesiones</option>
                            <option value="objects">üí° Objetos de Casa</option>
                            <option value="sports">‚öΩ Deportes y Hobbies</option>
                            <option value="history">üìú Historia y Cultura</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">PRIVACIDAD</label>
                        <select id="set-priv" onchange="actualizarSala()">
                            <option value="true">üîì P√∫blica</option>
                            <option value="false">üîí Privada</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.7rem; color:gray;">CONTADOR IMPOSTORES</label>
                        <select id="set-vis" onchange="actualizarSala()">
                            <option value="true">üëÅÔ∏è Visible</option>
                            <option value="false">üï∂Ô∏è Oculto</option>
                        </select>
                    </div>
                </div>
                <button onclick="iniciarPartida()" class="btn-start">EMPEZAR PARTIDA</button>
            </div>

            <div class="panel">
                <h4 style="margin:0 0 10px 0; font-size:0.8rem; color:gray;">JUGADORES EN SALA</h4>
                <div id="player-list"></div>
            </div>

            <div id="role-box" class="panel hidden" style="text-align:center; border: 2px solid var(--p);">
                <div id="role-label" style="font-size:0.7rem; font-weight:bold; letter-spacing:2px; color:gray;">TU PALABRA</div>
                <h2 id="word-display" style="font-size: 2.5rem; margin:10px 0;">---</h2>
                <p id="hint-display" style="color:var(--accent); font-weight:bold; margin:0;"></p>
            </div>

            <div id="vote-box" class="panel hidden">
                <h3 style="color:var(--danger); margin:0 0 10px 0;">üó≥Ô∏è HORA DE VOTAR</h3>
                <div id="vote-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
            </div>
        </div>

        <div class="sidebar">
            <div id="turn-display" style="text-align:center; padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; font-weight:bold; margin-bottom:15px; color:var(--active);">ESPERANDO...</div>
            
            <div id="chat-messages">
                </div>
            
            <div style="display:flex; gap:5px;">
                <input type="text" id="chat-input" placeholder="Escribe aqu√≠..." style="margin:0;">
                <button onclick="enviarMensaje()" style="width:50px;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN SUPABASE ---
        // IMPORTANTE: Aseg√∫rate de que estos son tus datos reales
        const SB_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // Variables Globales
        let myU = "", myR = "", pList = [], gState = "waiting", tIdx = 0;

        // Base de Datos de Palabras
       // --- BASE DE DATOS MASIVA (ULTIMATE PACK 600+ PALABRAS) ---
const DATA = {
    // 1. MIX GENERAL (Pistas gen√©ricas manuales para el modo Mezcla)
    all: [
        {w:"YOUTUBE", h:"INTERNET"}, {w:"TIKTOK", h:"INTERNET"}, {w:"WHATSAPP", h:"APP"},
        {w:"GOOGLE", h:"INTERNET"}, {w:"AMAZON", h:"TIENDA"}, {w:"NETFLIX", h:"APP"},
        {w:"IPHONE", h:"TECNOLOG√çA"}, {w:"SAMSUNG", h:"TECNOLOG√çA"}, {w:"WINDOWS", h:"TECNOLOG√çA"},
        {w:"PLAYSTATION", h:"JUEGOS"}, {w:"NINTENDO", h:"JUEGOS"}, {w:"MINECRAFT", h:"JUEGOS"},
        {w:"FORTNITE", h:"JUEGOS"}, {w:"FIFA", h:"DEPORTE"}, {w:"POKEMON", h:"ANIME/JUEGO"},
        {w:"HARRY POTTER", h:"CINE"}, {w:"STAR WARS", h:"CINE"}, {w:"AVENGERS", h:"CINE"},
        {w:"BATMAN", h:"CINE"}, {w:"SPIDERMAN", h:"CINE"}, {w:"JOKER", h:"CINE"},
        {w:"BARBIE", h:"JUGUETE"}, {w:"LEGO", h:"JUGUETE"}, {w:"IKEA", h:"TIENDA"},
        {w:"MCDONALDS", h:"COMIDA"}, {w:"COCA COLA", h:"BEBIDA"}, {w:"NIKE", h:"ROPA"},
        {w:"ADIDAS", h:"ROPA"}, {w:"ZARA", h:"ROPA"}, {w:"ROLEX", h:"ACCESORIO"},
        {w:"FERRARI", h:"VEH√çCULO"}, {w:"TESLA", h:"VEH√çCULO"}, {w:"CORONAVIRUS", h:"SALUD"},
        {w:"MESSI", h:"FAMOSO"}, {w:"CRISTIANO", h:"FAMOSO"}, {w:"SHAKIRA", h:"FAMOSA"},
        {w:"ELON MUSK", h:"FAMOSO"}, {w:"MRBEAST", h:"FAMOSO"}, {w:"IBAI", h:"FAMOSO"},
        {w:"NAVIDAD", h:"FIESTA"}, {w:"HALLOWEEN", h:"FIESTA"}, {w:"CARNAVAL", h:"FIESTA"},
        {w:"BODA", h:"EVENTO"}, {w:"CUMPLEA√ëOS", h:"EVENTO"}, {w:"EXAMEN", h:"ESTUDIOS"},
        {w:"VACACIONES", h:"OCIO"}, {w:"WIFI", h:"TECNOLOG√çA"}, {w:"ROBOT", h:"TECNOLOG√çA"},
        {w:"ZOMBIE", h:"MONSTRUO"}, {w:"VAMPIRO", h:"MONSTRUO"}, {w:"FANTASMA", h:"MONSTRUO"},
        {w:"DINERO", h:"ECONOM√çA"}, {w:"BITCOIN", h:"ECONOM√çA"}, {w:"ORO", h:"MATERIAL"},
        {w:"SOL", h:"NATURALEZA"}, {w:"LUNA", h:"NATURALEZA"}, {w:"LLUVIA", h:"CLIMA"},
        {w:"FUEGO", h:"ELEMENTO"}, {w:"AGUA", h:"ELEMENTO"}, {w:"PIZZA", h:"COMIDA"},
        {w:"SUSHI", h:"COMIDA"}, {w:"CHOCOLATE", h:"COMIDA"}, {w:"CERVEZA", h:"ALCOHOL"},
        {w:"VINO", h:"ALCOHOL"}, {w:"CAF√â", h:"BEBIDA"}, {w:"GUITARRA", h:"M√öSICA"},
        {w:"PIANO", h:"M√öSICA"}, {w:"F√öTBOL", h:"DEPORTE"}, {w:"BALONCESTO", h:"DEPORTE"},
        {w:"TENIS", h:"DEPORTE"}, {w:"LIBRO", h:"CULTURA"}, {w:"PINTURA", h:"ARTE"},
        {w:"CAMA", h:"MUEBLE"}, {w:"SILLA", h:"MUEBLE"}, {w:"RELOJ", h:"OBJETO"},
        {w:"ESPEJO", h:"OBJETO"}, {w:"LLAVE", h:"OBJETO"}, {w:"MOCHILA", h:"OBJETO"}
    ],

    // 2. REINO ANIMAL
    animals: [
        {w:"LE√ìN", h:"x"}, {w:"TIBUR√ìN", h:"x"}, {w:"√ÅGUILA", h:"x"}, {w:"PING√úINO", h:"x"},
        {w:"CANGURO", h:"x"}, {w:"PANDA", h:"x"}, {w:"PERRO", h:"x"}, {w:"GATO", h:"x"},
        {w:"HAMSTER", h:"x"}, {w:"SERPIENTE", h:"x"}, {w:"DINOSAURIO", h:"x"}, {w:"MOSQUITO", h:"x"},
        {w:"ARA√ëA", h:"x"}, {w:"DELF√çN", h:"x"}, {w:"BALLENA", h:"x"}, {w:"JIRAFA", h:"x"},
        {w:"ELEFANTE", h:"x"}, {w:"COCODRILO", h:"x"}, {w:"RANA", h:"x"}, {w:"PATO", h:"x"},
        {w:"VACA", h:"x"}, {w:"CABALLO", h:"x"}, {w:"LOBO", h:"x"}, {w:"OSO", h:"x"},
        {w:"MURCI√âLAGO", h:"x"}, {w:"ABEJA", h:"x"}, {w:"HORMIGA", h:"x"}, {w:"PULPO", h:"x"},
        {w:"CAMELLO", h:"x"}, {w:"GORILA", h:"x"}, {w:"ZEBRA", h:"x"}, {w:"KOALA", h:"x"},
        {w:"TORTUGA", h:"x"}, {w:"CONEJO", h:"x"}, {w:"LORO", h:"x"}, {w:"PEZ PAYASO", h:"x"},
        {w:"MEDUSA", h:"x"}, {w:"CANGREJO", h:"x"}, {w:"ESCORPI√ìN", h:"x"}, {w:"B√öHO", h:"x"},
        {w:"AVESTRUZ", h:"x"}, {w:"HIPOP√ìTAMO", h:"x"}, {w:"RINOCERONTE", h:"x"}, {w:"GUSANO", h:"x"},
        {w:"MARIPOSA", h:"x"}, {w:"CARACOL", h:"x"}, {w:"IGUANA", h:"x"}, {w:"LLAMA", h:"x"},
        {w:"ALCE", h:"x"}, {w:"ZORRO", h:"x"}, {w:"MAPACHE", h:"x"}, {w:"ERIZO", h:"x"},
        {w:"ORNITORRINCO", h:"x"}, {w:"CAPIBARA", h:"x"}, {w:"PEREZOSO", h:"x"}, {w:"LEMUR", h:"x"},
        {w:"MANTA RAYA", h:"x"}, {w:"CALAMAR", h:"x"}, {w:"ESTRELLA DE MAR", h:"x"}, {w:"CABALLITO DE MAR", h:"x"},
        {w:"TIGRE", h:"x"}, {w:"PANTERA", h:"x"}, {w:"JAGUAR", h:"x"}, {w:"HIENA", h:"x"},
        {w:"BUITRE", h:"x"}, {w:"FLAMENCO", h:"x"}, {w:"CISNE", h:"x"}, {w:"PAVO REAL", h:"x"},
        {w:"TOPO", h:"x"}, {w:"RATA", h:"x"}, {w:"RAT√ìN", h:"x"}, {w:"ARDILLA", h:"x"},
        {w:"CASTOR", h:"x"}, {w:"NUTRIA", h:"x"}, {w:"FOCA", h:"x"}, {w:"MORSA", h:"x"},
        {w:"GAVIOTA", h:"x"}, {w:"PEL√çCANO", h:"x"}, {w:"COLIBR√ç", h:"x"}, {w:"CUCARACHA", h:"x"},
        {w:"GRILLO", h:"x"}, {w:"SALTAMONTES", h:"x"}, {w:"LIB√âLULA", h:"x"}, {w:"ESCARABAJO", h:"x"}
    ],

    // 3. COMIDA Y BEBIDA
    food: [
        {w:"PIZZA", h:"x"}, {w:"SUSHI", h:"x"}, {w:"TACO", h:"x"}, {w:"PAELLA", h:"x"},
        {w:"HAMBURGUESA", h:"x"}, {w:"CHOCOLATE", h:"x"}, {w:"HELADO", h:"x"}, {w:"HUEVO", h:"x"},
        {w:"PAN", h:"x"}, {w:"QUESO", h:"x"}, {w:"CAF√â", h:"x"}, {w:"CERVEZA", h:"x"},
        {w:"PALOMITAS", h:"x"}, {w:"ESPAGUETIS", h:"x"}, {w:"ENSALADA", h:"x"}, {w:"PATATAS FRITAS", h:"x"},
        {w:"KEBAB", h:"x"}, {w:"TORTILLA", h:"x"}, {w:"JAM√ìN", h:"x"}, {w:"MANZANA", h:"x"},
        {w:"PL√ÅTANO", h:"x"}, {w:"SAND√çA", h:"x"}, {w:"UVAS", h:"x"}, {w:"CROQUETAS", h:"x"},
        {w:"SOPA", h:"x"}, {w:"ARROZ", h:"x"}, {w:"POLLO", h:"x"}, {w:"FILETE", h:"x"},
        {w:"GALLETA", h:"x"}, {w:"LECHE", h:"x"}, {w:"AGUA", h:"x"}, {w:"VINO", h:"x"},
        {w:"REFRESCO", h:"x"}, {w:"ZUMO", h:"x"}, {w:"T√â", h:"x"}, {w:"YOGUR", h:"x"},
        {w:"MIEL", h:"x"}, {w:"AZ√öCAR", h:"x"}, {w:"SAL", h:"x"}, {w:"PIMIENTA", h:"x"},
        {w:"KETCHUP", h:"x"}, {w:"MAYONESA", h:"x"}, {w:"MOSTAZA", h:"x"}, {w:"LIM√ìN", h:"x"},
        {w:"FRESA", h:"x"}, {w:"CEREZA", h:"x"}, {w:"PI√ëA", h:"x"}, {w:"COCO", h:"x"},
        {w:"AGUACATE", h:"x"}, {w:"TOMATE", h:"x"}, {w:"CEBOLLA", h:"x"}, {w:"AJO", h:"x"},
        {w:"ZANAHORIA", h:"x"}, {w:"PEPINO", h:"x"}, {w:"BR√ìCOLI", h:"x"}, {w:"COLIFLOR", h:"x"},
        {w:"LECHUGA", h:"x"}, {w:"CHAMPI√ë√ìN", h:"x"}, {w:"PIMIENTO", h:"x"}, {w:"CALABAZA", h:"x"},
        {w:"MEL√ìN", h:"x"}, {w:"MELOCOT√ìN", h:"x"}, {w:"PERA", h:"x"}, {w:"KIWI", h:"x"},
        {w:"MANGO", h:"x"}, {w:"FRAMBUESA", h:"x"}, {w:"AR√ÅNDANO", h:"x"}, {w:"NUECES", h:"x"},
        {w:"ALMENDRAS", h:"x"}, {w:"CACAHUETES", h:"x"}, {w:"PISTACHOS", h:"x"}, {w:"AVELLANAS", h:"x"},
        {w:"CHURROS", h:"x"}, {w:"DONUT", h:"x"}, {w:"CROISSANT", h:"x"}, {w:"MAGDALENA", h:"x"},
        {w:"TARTA", h:"x"}, {w:"FLAN", h:"x"}, {w:"GELATINA", h:"x"}, {w:"TURR√ìN", h:"x"},
        {w:"BOCADILLO", h:"x"}, {w:"S√ÅNDWICH", h:"x"}, {w:"EMPANADA", h:"x"}, {w:"NACHOS", h:"x"},
        {w:"BURRITO", h:"x"}, {w:"LASA√ëA", h:"x"}, {w:"RAVIOLIS", h:"x"}, {w:"FIDEU√Å", h:"x"}
    ],

    // 4. LUGARES Y GEOGRAF√çA
    places: [
        {w:"PLAYA", h:"x"}, {w:"MONTA√ëA", h:"x"}, {w:"CINE", h:"x"}, {w:"HOSPITAL", h:"x"},
        {w:"ESCUELA", h:"x"}, {w:"C√ÅRCEL", h:"x"}, {w:"CEMENTERIO", h:"x"}, {w:"GIMNASIO", h:"x"},
        {w:"BIBLIOTECA", h:"x"}, {w:"DISCOTECA", h:"x"}, {w:"AEROPUERTO", h:"x"}, {w:"BA√ëO", h:"x"},
        {w:"COCINA", h:"x"}, {w:"LUNA", h:"x"}, {w:"MARTE", h:"x"}, {w:"PAR√çS", h:"x"},
        {w:"LONDRES", h:"x"}, {w:"NUEVA YORK", h:"x"}, {w:"TOKIO", h:"x"}, {w:"EGIPTO", h:"x"},
        {w:"MADRID", h:"x"}, {w:"ZOO", h:"x"}, {w:"CIRCO", h:"x"}, {w:"HOTEL", h:"x"},
        {w:"IGLESIA", h:"x"}, {w:"SUPERMERCADO", h:"x"}, {w:"BOSQUE", h:"x"}, {w:"ISLA", h:"x"},
        {w:"VOLC√ÅN", h:"x"}, {w:"PISCINA", h:"x"}, {w:"ESTADIO", h:"x"}, {w:"TEATRO", h:"x"},
        {w:"MUSEO", h:"x"}, {w:"PARQUE", h:"x"}, {w:"FARMACIA", h:"x"}, {w:"GASOLINERA", h:"x"},
        {w:"BANCO", h:"x"}, {w:"RESTAURANTE", h:"x"}, {w:"OFICINA", h:"x"}, {w:"F√ÅBRICA", h:"x"},
        {w:"CASTILLO", h:"x"}, {w:"CUEVA", h:"x"}, {w:"DESIERTO", h:"x"}, {w:"SELVA", h:"x"},
        {w:"POLO NORTE", h:"x"}, {w:"ESPACIO", h:"x"}, {w:"CIELO", h:"x"}, {w:"INFIERNO", h:"x"},
        {w:"UNIVERSIDAD", h:"x"}, {w:"GUARDER√çA", h:"x"}, {w:"PELUQUER√çA", h:"x"}, {w:"TALLER", h:"x"},
        {w:"COMISAR√çA", h:"x"}, {w:"BOMBEROS", h:"x"}, {w:"PUERTO", h:"x"}, {w:"FARO", h:"x"},
        {w:"GRANJA", h:"x"}, {w:"PUEBLO", h:"x"}, {w:"CIUDAD", h:"x"}, {w:"CALLE", h:"x"},
        {w:"CARRETERA", h:"x"}, {w:"PUENTE", h:"x"}, {w:"T√öNEL", h:"x"}, {w:"ASCENSOR", h:"x"},
        {w:"ESCALERAS", h:"x"}, {w:"BALC√ìN", h:"x"}, {w:"JARD√çN", h:"x"}, {w:"S√ìTANO", h:"x"},
        {w:"√ÅTICO", h:"x"}, {w:"GARAJE", h:"x"}, {w:"SAL√ìN", h:"x"}, {w:"HABITACI√ìN", h:"x"},
        {w:"ROMA", h:"x"}, {w:"CHINA", h:"x"}, {w:"M√âXICO", h:"x"}, {w:"ARGENTINA", h:"x"},
        {w:"BRASIL", h:"x"}, {w:"ALEMANIA", h:"x"}, {w:"AUSTRALIA", h:"x"}, {w:"ANT√ÅRTIDA", h:"x"}
    ],

    // 5. OBJETOS
    objects: [
        {w:"RELOJ", h:"x"}, {w:"ESPEJO", h:"x"}, {w:"LLAVE", h:"x"}, {w:"PARAGUAS", h:"x"},
        {w:"GAFAS", h:"x"}, {w:"MOCHILA", h:"x"}, {w:"PAPEL", h:"x"}, {w:"SART√âN", h:"x"},
        {w:"GUITARRA", h:"x"}, {w:"PIANO", h:"x"}, {w:"CAMA", h:"x"}, {w:"SILLA", h:"x"},
        {w:"ORDENADOR", h:"x"}, {w:"COCHE", h:"x"}, {w:"AVI√ìN", h:"x"}, {w:"MANDO", h:"x"},
        {w:"ZAPATOS", h:"x"}, {w:"MASCARILLA", h:"x"}, {w:"LIBRO", h:"x"}, {w:"L√ÅPIZ", h:"x"},
        {w:"TIJERAS", h:"x"}, {w:"CUCHILLO", h:"x"}, {w:"TENEDOR", h:"x"}, {w:"LAVADORA", h:"x"},
        {w:"NEVERA", h:"x"}, {w:"MICROONDAS", h:"x"}, {w:"TELEVISI√ìN", h:"x"}, {w:"BICICLETA", h:"x"},
        {w:"MOTO", h:"x"}, {w:"ANILLO", h:"x"}, {w:"MESA", h:"x"}, {w:"SOF√Å", h:"x"},
        {w:"L√ÅMPARA", h:"x"}, {w:"ALFOMBRA", h:"x"}, {w:"CUADRO", h:"x"}, {w:"JUGUETE", h:"x"},
        {w:"PELOTA", h:"x"}, {w:"MU√ëECA", h:"x"}, {w:"CUNA", h:"x"}, {w:"PA√ëAL", h:"x"},
        {w:"BIBER√ìN", h:"x"}, {w:"CHUPETE", h:"x"}, {w:"ESCOBA", h:"x"}, {w:"FREGONA", h:"x"},
        {w:"CUBO", h:"x"}, {w:"ESPONJA", h:"x"}, {w:"TOALLA", h:"x"}, {w:"JAB√ìN", h:"x"},
        {w:"CHAMP√ö", h:"x"}, {w:"PEINE", h:"x"}, {w:"CEPILLO", h:"x"}, {w:"PASTA DENTAL", h:"x"},
        {w:"HILO DENTAL", h:"x"}, {w:"DESODORANTE", h:"x"}, {w:"PERFUME", h:"x"}, {w:"MAQUILLAJE", h:"x"},
        {w:"PINTALABIOS", h:"x"}, {w:"ESMALTE", h:"x"}, {w:"SECADOR", h:"x"}, {w:"PLANCHA", h:"x"},
        {w:"ASPIRADORA", h:"x"}, {w:"VENTILADOR", h:"x"}, {w:"AIRE ACONDICIONADO", h:"x"}, {w:"RADIADOR", h:"x"},
        {w:"ESTUFA", h:"x"}, {w:"HORNO", h:"x"}, {w:"TOSTADORA", h:"x"}, {w:"BATIDORA", h:"x"},
        {w:"CAFETERA", h:"x"}, {w:"OLLA", h:"x"}, {w:"CAZUELA", h:"x"}, {w:"PLATO", h:"x"},
        {w:"VASO", h:"x"}, {w:"TAZA", h:"x"}, {w:"COPA", h:"x"}, {w:"BOTELLA", h:"x"},
        {w:"LATA", h:"x"}, {w:"ABRELATAS", h:"x"}, {w:"SACACORCHOS", h:"x"}, {w:"MECHERO", h:"x"},
        {w:"CERILLAS", h:"x"}, {w:"VELA", h:"x"}, {w:"INCIENSO", h:"x"}, {w:"JARR√ìN", h:"x"},
        {w:"MACETA", h:"x"}, {w:"REGADERA", h:"x"}, {w:"MANGUERA", h:"x"}, {w:"RASTRILLO", h:"x"},
        {w:"PALA", h:"x"}, {w:"MARTILLO", h:"x"}, {w:"DESTORNILLADOR", h:"x"}, {w:"TALADRO", h:"x"}
    ],

    // 6. PROFESIONES
    jobs: [
        {w:"M√âDICO", h:"x"}, {w:"POLIC√çA", h:"x"}, {w:"BOMBERO", h:"x"}, {w:"PROFESOR", h:"x"},
        {w:"ASTRONAUTA", h:"x"}, {w:"PAYASO", h:"x"}, {w:"MAGO", h:"x"}, {w:"COCINERO", h:"x"},
        {w:"YOUTUBER", h:"x"}, {w:"FUTBOLISTA", h:"x"}, {w:"PRESIDENTE", h:"x"}, {w:"DETECTIVE", h:"x"},
        {w:"LADR√ìN", h:"x"}, {w:"JUEZ", h:"x"}, {w:"PILOTO", h:"x"}, {w:"PIRATA", h:"x"},
        {w:"NINJA", h:"x"}, {w:"VAMPIRO", h:"x"}, {w:"ZOMBIE", h:"x"}, {w:"FANTASMA", h:"x"},
        {w:"REY", h:"x"}, {w:"SOLDADO", h:"x"}, {w:"GRANJERO", h:"x"}, {w:"MEC√ÅNICO", h:"x"},
        {w:"PELUQUERO", h:"x"}, {w:"DENTISTA", h:"x"}, {w:"CAMARERO", h:"x"}, {w:"ALBA√ëIL", h:"x"},
        {w:"FONTANERO", h:"x"}, {w:"ELECTRICISTA", h:"x"}, {w:"PINTOR", h:"x"}, {w:"ESCRITOR", h:"x"},
        {w:"CANTANTE", h:"x"}, {w:"ACTOR", h:"x"}, {w:"MODELO", h:"x"}, {w:"CIENT√çFICO", h:"x"},
        {w:"VETERINARIO", h:"x"}, {w:"ABOGADO", h:"x"}, {w:"CURA", h:"x"}, {w:"MONJA", h:"x"},
        {w:"TAXISTA", h:"x"}, {w:"CONDUCTOR", h:"x"}, {w:"CARTERO", h:"x"}, {w:"JARDINERO", h:"x"},
        {w:"PESCADOR", h:"x"}, {w:"MINERO", h:"x"}, {w:"ARQUE√ìLOGO", h:"x"}, {w:"ESPIA", h:"x"},
        {w:"ENFERMERO", h:"x"}, {w:"FARMAC√âUTICO", h:"x"}, {w:"PSIC√ìLOGO", h:"x"}, {w:"ARQUITECTO", h:"x"},
        {w:"INGENIERO", h:"x"}, {w:"PROGRAMADOR", h:"x"}, {w:"DISE√ëADOR", h:"x"}, {w:"PERIODISTA", h:"x"},
        {w:"FOT√ìGRAFO", h:"x"}, {w:"M√öSICO", h:"x"}, {w:"BAILAR√çN", h:"x"}, {w:"DEPORTISTA", h:"x"},
        {w:"ENTRENADOR", h:"x"}, {w:"√ÅRBITRO", h:"x"}, {w:"GUARDAESPALDAS", h:"x"}, {w:"PORTERO", h:"x"},
        {w:"AZAFATA", h:"x"}, {w:"CAPIT√ÅN", h:"x"}, {w:"MARINERO", h:"x"}, {w:"CARNICERO", h:"x"},
        {w:"PESCADERO", h:"x"}, {w:"FRUTERO", h:"x"}, {w:"PANADERO", h:"x"}, {w:"PASTELERO", h:"x"},
        {w:"CAJERO", h:"x"}, {w:"LIMPIADOR", h:"x"}, {w:"BASURERO", h:"x"}, {w:"BUTANERO", h:"x"},
        {w:"REPARTIDOR", h:"x"}, {w:"TAXISTA", h:"x"}, {w:"CAMIONERO", h:"x"}, {w:"ASTR√ìLOGO", h:"x"}
    ],

    // 7. CINE Y GEEK
    geek: [
        {w:"BATMAN", h:"x"}, {w:"SPIDERMAN", h:"x"}, {w:"SUPERMAN", h:"x"}, {w:"JOKER", h:"x"},
        {w:"THANOS", h:"x"}, {w:"GOKU", h:"x"}, {w:"NARUTO", h:"x"}, {w:"PIKACHU", h:"x"},
        {w:"MARIO", h:"x"}, {w:"SONIC", h:"x"}, {w:"DARTH VADER", h:"x"}, {w:"YODA", h:"x"},
        {w:"HOMER SIMPSON", h:"x"}, {w:"BOB ESPONJA", h:"x"}, {w:"MICKEY MOUSE", h:"x"}, {w:"ELSA", h:"x"},
        {w:"SHREK", h:"x"}, {w:"BARBIE", h:"x"}, {w:"IRON MAN", h:"x"}, {w:"CAPIT√ÅN AM√âRICA", h:"x"},
        {w:"THOR", h:"x"}, {w:"HULK", h:"x"}, {w:"WONDER WOMAN", h:"x"}, {w:"DEADPOOL", h:"x"},
        {w:"LUFFY", h:"x"}, {w:"ZORO", h:"x"}, {w:"SAILOR MOON", h:"x"}, {w:"TOTORO", h:"x"},
        {w:"GODZILLA", h:"x"}, {w:"KING KONG", h:"x"}, {w:"TERMINATOR", h:"x"}, {w:"ROBOCOP", h:"x"},
        {w:"ALIEN", h:"x"}, {w:"PREDATOR", h:"x"}, {w:"MATRIX", h:"x"}, {w:"TITANIC", h:"x"},
        {w:"AVATAR", h:"x"}, {w:"JURASSIC PARK", h:"x"}, {w:"FROZEN", h:"x"}, {w:"TOY STORY", h:"x"},
        {w:"CARS", h:"x"}, {w:"NEMO", h:"x"}, {w:"MINIONS", h:"x"}, {w:"GRU", h:"x"},
        {w:"VOLDEMORT", h:"x"}, {w:"DOBBY", h:"x"}, {w:"GANDALF", h:"x"}, {w:"FRODO", h:"x"},
        {w:"GOLLUM", h:"x"}, {w:"LEGOLAS", h:"x"}, {w:"JON SNOW", h:"x"}, {w:"DAENERYS", h:"x"},
        {w:"WALTER WHITE", h:"x"}, {w:"SQUID GAME", h:"x"}, {w:"STRANGER THINGS", h:"x"}, {w:"WEDNESDAY", h:"x"},
        {w:"MANDALORIAN", h:"x"}, {w:"BABY YODA", h:"x"}, {w:"LUIGI", h:"x"}, {w:"BOWSER", h:"x"},
        {w:"PEACH", h:"x"}, {w:"ZELDA", h:"x"}, {w:"LINK", h:"x"}, {w:"KIRBY", h:"x"},
        {w:"DONKEY KONG", h:"x"}, {w:"PACMAN", h:"x"}, {w:"TETRIS", h:"x"}, {w:"AMONG US", h:"x"},
        {w:"CREEPER", h:"x"}, {w:"ENDRMAN", h:"x"}, {w:"STEVE", h:"x"}, {w:"HEROBRINE", h:"x"},
        {w:"KRATOS", h:"x"}, {w:"MASTER CHIEF", h:"x"}, {w:"LARA CROFT", h:"x"}, {w:"CRASH BANDICOOT", h:"x"}
    ],

    // 8. DEPORTES Y HOBBIES
    sports: [
        {w:"F√öTBOL", h:"x"}, {w:"BALONCESTO", h:"x"}, {w:"TENIS", h:"x"}, {w:"NATACI√ìN", h:"x"},
        {w:"AJEDREZ", h:"x"}, {w:"BOXEO", h:"x"}, {w:"BAILE", h:"x"}, {w:"PINTURA", h:"x"},
        {w:"LECTURA", h:"x"}, {w:"YOGA", h:"x"}, {w:"PESCA", h:"x"}, {w:"SKATE", h:"x"},
        {w:"ESQU√ç", h:"x"}, {w:"SURF", h:"x"}, {w:"GOLF", h:"x"}, {w:"KARATE", h:"x"},
        {w:"VIDEOJUEGOS", h:"x"}, {w:"FOTOGRAF√çA", h:"x"}, {w:"CAMPING", h:"x"}, {w:"POKER", h:"x"},
        {w:"RUGBY", h:"x"}, {w:"BEISBOL", h:"x"}, {w:"VOLEIBOL", h:"x"}, {w:"ATLETISMO", h:"x"},
        {w:"CICLISMO", h:"x"}, {w:"FORMULA 1", h:"x"}, {w:"MOTOGP", h:"x"}, {w:"ESCALADA", h:"x"},
        {w:"BUCEO", h:"x"}, {w:"PARACAIDAS", h:"x"}, {w:"SENDERISMO", h:"x"}, {w:"GIMNASIA", h:"x"},
        {w:"JUDO", h:"x"}, {w:"TAEKWONDO", h:"x"}, {w:"LUCHA LIBRE", h:"x"}, {w:"ESGRIMA", h:"x"},
        {w:"TIRO CON ARCO", h:"x"}, {w:"PING PONG", h:"x"}, {w:"BADMINTON", h:"x"}, {w:"PADEL", h:"x"},
        {w:"WATERPOLO", h:"x"}, {w:"REMO", h:"x"}, {w:"VELA", h:"x"}, {w:"KAYAK", h:"x"},
        {w:"RAFTING", h:"x"}, {w:"PARAPENTE", h:"x"}, {w:"PUENTING", h:"x"}, {w:"PATINAJE", h:"x"},
        {w:"HOCKEY", h:"x"}, {w:"CURLING", h:"x"}, {w:"BALONMANO", h:"x"}, {w:"F√öTBOL AMERICANO", h:"x"},
        {w:"CRICKET", h:"x"}, {w:"BILLAR", h:"x"}, {w:"BOLOS", h:"x"}, {w:"DARDOS", h:"x"},
        {w:"JARDINER√çA", h:"x"}, {w:"COCINA", h:"x"}, {w:"COSTURA", h:"x"}, {w:"TEJER", h:"x"},
        {w:"CER√ÅMICA", h:"x"}, {w:"ORIGAMI", h:"x"}, {w:"MAGIA", h:"x"}, {w:"ASTRONOM√çA", h:"x"}
    ],

    // 9. HISTORIA
    history: [
        {w:"PIR√ÅMIDE", h:"x"}, {w:"COLISEO", h:"x"}, {w:"MURALLA CHINA", h:"x"}, {w:"TORRE EIFFEL", h:"x"},
        {w:"ESTATUA LIBERTAD", h:"x"}, {w:"TAJ MAHAL", h:"x"}, {w:"MACHU PICCHU", h:"x"}, {w:"CRISTOBAL COL√ìN", h:"x"},
        {w:"NAPOLE√ìN", h:"x"}, {w:"CLEOPATRA", h:"x"}, {w:"JULIO C√âSAR", h:"x"}, {w:"EINSTEIN", h:"x"},
        {w:"DA VINCI", h:"x"}, {w:"MOZART", h:"x"}, {w:"BEETHOVEN", h:"x"}, {w:"HITLER", h:"x"},
        {w:"GANDHI", h:"x"}, {w:"MANDELA", h:"x"}, {w:"JESUCRISTO", h:"x"}, {w:"BUDA", h:"x"},
        {w:"VIKINGO", h:"x"}, {w:"SAMURAI", h:"x"}, {w:"CABALLERO", h:"x"}, {w:"MOMIA", h:"x"},
        {w:"GLADIADOR", h:"x"}, {w:"FARA√ìN", h:"x"}, {w:"EMPERADOR", h:"x"}, {w:"DICTADOR", h:"x"},
        {w:"REINA ISABEL", h:"x"}, {w:"LADY DI", h:"x"}, {w:"KENNEDY", h:"x"}, {w:"LINCOLN", h:"x"},
        {w:"CHE GUEVARA", h:"x"}, {w:"FIDEL CASTRO", h:"x"}, {w:"MAO", h:"x"}, {w:"LENIN", h:"x"},
        {w:"STALIN", h:"x"}, {w:"CHURCHILL", h:"x"}, {w:"ARMSTRONG", h:"x"}, {w:"GAGARIN", h:"x"},
        {w:"NEWTON", h:"x"}, {w:"DARWIN", h:"x"}, {w:"GALILEO", h:"x"}, {w:"TESLA", h:"x"},
        {w:"EDISON", h:"x"}, {w:"BELL", h:"x"}, {w:"CURIE", h:"x"}, {w:"PICASSO", h:"x"},
        {w:"DAL√ç", h:"x"}, {w:"VAN GOGH", h:"x"}, {w:"SHAKESPEARE", h:"x"}, {w:"CERVANTES", h:"x"},
        {w:"ELVIS", h:"x"}, {w:"MICHAEL JACKSON", h:"x"}, {w:"MARILYN MONROE", h:"x"}, {w:"CHAPLIN", h:"x"},
        {w:"WALT DISNEY", h:"x"}, {w:"STEVE JOBS", h:"x"}, {w:"BILL GATES", h:"x"}, {w:"ZUCKERBERG", h:"x"}
    ],

    // 10. CIENCIA Y NATURALEZA
    science: [
        {w:"SOL", h:"x"}, {w:"TIERRA", h:"x"}, {w:"LLUVIA", h:"x"}, {w:"NIEVE", h:"x"},
        {w:"FUEGO", h:"x"}, {w:"VIENTO", h:"x"}, {w:"ARCO√çRIS", h:"x"}, {w:"TERREMOTO", h:"x"},
        {w:"TSUNAMI", h:"x"}, {w:"CEREBRO", h:"x"}, {w:"CORAZ√ìN", h:"x"}, {w:"HUESO", h:"x"},
        {w:"SANGRE", h:"x"}, {w:"ADN", h:"x"}, {w:"ROBOT", h:"x"}, {w:"COHETE", h:"x"},
        {w:"√ÅTOMO", h:"x"}, {w:"GRAVEDAD", h:"x"}, {w:"OX√çGENO", h:"x"}, {w:"ORO", h:"x"},
        {w:"PLATA", h:"x"}, {w:"BRONCE", h:"x"}, {w:"HIERRO", h:"x"}, {w:"ALUMINIO", h:"x"},
        {w:"PL√ÅSTICO", h:"x"}, {w:"VIDRIO", h:"x"}, {w:"MADERA", h:"x"}, {w:"PIEDRA", h:"x"},
        {w:"ARENA", h:"x"}, {w:"BARRO", h:"x"}, {w:"NUBE", h:"x"}, {w:"TRUENO", h:"x"},
        {w:"RAYO", h:"x"}, {w:"HURAC√ÅN", h:"x"}, {w:"TORNADO", h:"x"}, {w:"INUNDACI√ìN", h:"x"},
        {w:"SEQU√çA", h:"x"}, {w:"AVALANCHA", h:"x"}, {w:"METEORITO", h:"x"}, {w:"AGUJERO NEGRO", h:"x"},
        {w:"GALAXIA", h:"x"}, {w:"ESTRELLA", h:"x"}, {w:"PLANETA", h:"x"}, {w:"SAT√âLITE", h:"x"},
        {w:"COMETA", h:"x"}, {w:"ECLIPSE", h:"x"}, {w:"ESTACIONES", h:"x"}, {w:"PRIMAVERA", h:"x"},
        {w:"VERANO", h:"x"}, {w:"OTO√ëO", h:"x"}, {w:"INVIERNO", h:"x"}, {w:"D√çA", h:"x"},
        {w:"NOCHE", h:"x"}, {w:"PULM√ìN", h:"x"}, {w:"H√çGADO", h:"x"}, {w:"EST√ìMAGO", h:"x"},
        {w:"RI√ë√ìN", h:"x"}, {w:"M√öSCULO", h:"x"}, {w:"PIEL", h:"x"}, {w:"DIENTES", h:"x"},
        {w:"LENGUA", h:"x"}, {w:"OJOS", h:"x"}, {w:"OREJAS", h:"x"}, {w:"NARIZ", h:"x"},
        {w:"PELO", h:"x"}, {w:"U√ëAS", h:"x"}, {w:"VIRUS", h:"x"}, {w:"BACTERIA", h:"x"},
        {w:"C√âLULA", h:"x"}, {w:"MICROSCOPIO", h:"x"}, {w:"TELESCOPIO", h:"x"}, {w:"TERM√ìMETRO", h:"x"}
    ]
};

        // --- 2. FUNCIONES DE INICIO ---

        async function loadPublicRooms() {
            const { data } = await sb.from('rooms').select('code').eq('status', 'waiting').eq('is_public', true).limit(10);
            const list = document.getElementById('public-rooms-list');
            
            if(!data || data.length === 0) { 
                list.innerHTML = "<small style='color:gray;'>No hay salas p√∫blicas disponibles.</small>"; 
                return; 
            }
            
            list.innerHTML = data.map(r => `
                <div class="room-card" onclick="document.getElementById('in-room').value='${r.code}'">
                    <span>üè† <b>${r.code}</b></span>
                    <small style="color:var(--p);">UNIRSE</small>
                </div>
            `).join('');
        }
        setInterval(loadPublicRooms, 5000); 
        loadPublicRooms(); 

        async function entrarAlJuego() {
            myU = document.getElementById('in-user').value.trim();
            myR = document.getElementById('in-room').value.trim().toUpperCase();
            if(!myU || !myR) return alert("Faltan datos.");

            try {
                // Limpieza previa local
                await sb.from('players').delete().match({ room_id: myR, username: myU });
                
                let { data: r } = await sb.from('rooms').select('*').eq('code', myR).maybeSingle();
                let esHost = false;

                if(!r) {
                    esHost = true;
                    // Creamos sala
                    await sb.from('rooms').insert([{ code: myR, status: 'waiting', is_public:true, show_counter:true }]);
                } else if(r.status !== 'waiting') {
                    return alert("¬°Partida empezada!");
                }

                await sb.from('players').insert([{ room_id: myR, username: myU, is_host: esHost }]);
                
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('room-display').innerText = "SALA: " + myR;
                
                setupRealtime();
                uiUpdate(); 
            } catch(e) { console.error(e); }
        }

        async function salirDelJuego() {
            if(confirm("¬øSalir?")) {
                // 1. Borrarme a m√≠ mismo
                await sb.from('players').delete().match({ room_id: myR, username: myU });
                
                // 2. COMPROBAR SI LA SALA QUED√ì VAC√çA (NUEVO)
                // Usamos count: 'exact' y head: true para solo contar sin bajar datos
                const { count } = await sb.from('players').select('*', { count: 'exact', head: true }).eq('room_id', myR);
                
                if(count === 0) {
                    // Si hay 0 jugadores, borrar la sala y los mensajes
                    await sb.from('rooms').delete().eq('code', myR);
                    await sb.from('messages').delete().eq('room_id', myR);
                    console.log("Sala vac√≠a eliminada.");
                }

                location.reload();
            }
        }

        // --- 3. TIEMPO REAL ---
        function setupRealtime() {
            const channel = sb.channel('game_channel');

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, (payload) => {
                // Si la sala se borr√≥ (payload.eventType === 'DELETE'), recargamos a los que queden (por seguridad)
                if(payload.eventType === 'DELETE' && payload.old.code === myR) {
                    alert("El anfitri√≥n cerr√≥ la sala o se vaci√≥.");
                    location.reload();
                }
                if(payload.new && payload.new.code === myR) uiUpdate();
            });

            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, (payload) => {
                if((payload.new && payload.new.room_id === myR) || (payload.old && payload.old.room_id === myR)) uiUpdate();
            });

            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                if(payload.new.room_id === myR) {
                    const chat = document.getElementById('chat-messages');
                    const msg = document.createElement('div');
                    const claseExtra = payload.new.is_clue ? ' msg-clue' : '';
                    msg.className = 'msg' + claseExtra;
                    msg.innerHTML = `<b>${payload.new.username}</b> ${payload.new.content}`;
                    chat.appendChild(msg);
                    chat.scrollTop = chat.scrollHeight; 
                }
            });

            channel.subscribe();
        }

        // --- 4. ACTUALIZACI√ìN UI (CORE) ---
        async function uiUpdate() {
            if(!myR) return;

            const { data: ps } = await sb.from('players').select('*').eq('room_id', myR).order('created_at');
            const { data: r } = await sb.from('rooms').select('*').eq('code', myR).maybeSingle();

            if(!ps || !r) return; // Si algo falla o la sala se borr√≥

            pList = ps; 
            gState = r.status; 
            tIdx = r.turn_index;
            const me = ps.find(p => p.username === myU);
            
            // Si yo ya no existo (kick o error), recargo
            if(!me) { location.reload(); return; }

            // --- A) PANTALLA FINAL ---
            // CORRECCI√ìN: Si status es 'waiting', ocultamos pantalla final S√ç O S√ç.
            if(r.status === 'waiting') {
                document.getElementById('end-screen').classList.add('hidden');
            } else if(r.winner_side) {
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-title').innerText = "GANAN: " + r.winner_side.toUpperCase();
                document.getElementById('end-subtitle').innerText = "Impostores: " + r.impostor_id;
                
                if(me.is_host) document.getElementById('host-controls').classList.remove('hidden');
                else document.getElementById('host-controls').classList.add('hidden');
            }

            // --- B) PANEL HOST Y SINCRONIZACI√ìN ---
            if(me.is_host && gState === 'waiting') {
                document.getElementById('host-panel').classList.remove('hidden');
                
                // Sincronizar men√∫s visuales solo si no los estoy tocando
                if(document.activeElement.tagName !== 'SELECT') {
                    document.getElementById('set-priv').value = r.is_public ? 'true' : 'false';
                    document.getElementById('set-vis').value = r.show_counter ? 'true' : 'false';
                }
            } else {
                document.getElementById('host-panel').classList.add('hidden');
            }

            // --- C) CONTADORES Y JUGADORES ---
            const infoDiv = document.getElementById('imp-status');
            if(gState !== 'waiting' && r.show_counter) {
                infoDiv.classList.remove('hidden');
                document.getElementById('imp-count-val').innerText = r.impostores_vivos;
            } else {
                infoDiv.classList.add('hidden');
            }

            document.getElementById('player-list').innerHTML = ps.map((p, i) => `
                <div class="player-tag ${i===tIdx && gState==='playing' ? 'is-active-turn' : ''} ${!p.is_alive ? 'dead' : ''}">
                    ${p.is_host ? 'üëë ' : ''}${p.username} ${p.has_voted ? '‚úÖ' : ''}
                </div>
            `).join('');

            // --- D) ESTADO JUEGO ---
            const turnLabel = document.getElementById('turn-display');
            if(gState === 'playing') {
                document.getElementById('role-box').classList.remove('hidden');
                const imps = (r.impostor_id || "").split(',');
                const soyImp = imps.includes(myU);
                document.getElementById('role-label').innerText = soyImp ? "TU MISI√ìN" : "TU PALABRA";
                document.getElementById('word-display').innerText = soyImp ? "üïµÔ∏è IMPOSTOR" : r.word;
                document.getElementById('hint-display').innerText = soyImp ? "Pista: " + r.hint : "Categor√≠a: " + r.hint;
                
                const activeP = ps[tIdx];
                if(activeP) {
                    turnLabel.innerText = "HABLA: " + activeP.username;
                    turnLabel.style.color = (activeP.username === myU) ? "var(--active)" : "white";
                    if(activeP.username === myU) turnLabel.innerText += " (¬°TU TURNO!)";
                }
            } else if(gState === 'voting') {
                document.getElementById('role-box').classList.add('hidden');
                turnLabel.innerText = "üó≥Ô∏è MOMENTO DE VOTAR";
                turnLabel.style.color = "var(--danger)";
            } else {
                document.getElementById('role-box').classList.add('hidden');
                turnLabel.innerText = "ESPERANDO JUGADORES...";
                turnLabel.style.color = "var(--active)";
            }

            // --- E) VOTACI√ìN ---
            const vb = document.getElementById('vote-box');
            if(gState === 'voting' && me.is_alive && !me.has_voted) {
                vb.classList.remove('hidden');
                vb.querySelector('#vote-options').innerHTML = ps.filter(p=>p.is_alive).map(p => `
                    <button onclick="votar('${p.username}')">${p.username}</button>
                `).join('') + `<button onclick="votar('skip')" style="background:gray; grid-column:span 2;">‚è≠Ô∏è SALTAR VOTO</button>`;
            } else {
                vb.classList.add('hidden');
            }

            // --- CORRECCI√ìN FINAL DEL BUCLE ---
            // Solo ejecutamos l√≥gica de host si estamos JUGANDO o VOTANDO.
            // Si estamos 'waiting', NO HACEMOS NADA. Esto arregla el reinicio infinito.
            if(me.is_host && gState !== 'waiting') {
                hostLogic(r, ps);
            }
        }

        // --- 5. L√ìGICA DE JUEGO ---

        async function actualizarSala() {
            const esPublica = document.getElementById('set-priv').value === 'true';
            const mostrarContador = document.getElementById('set-vis').value === 'true';
            
            await sb.from('rooms').update({
                is_public: esPublica,
                show_counter: mostrarContador
            }).eq('code', myR);
        }

        async function iniciarPartida() {
            if(pList.length < 3) return alert("M√≠nimo 3 jugadores.");
            
            const cat = document.getElementById('set-cat').value;
            const impVal = document.getElementById('set-imps').value;
            
            let numImp = (impVal === 'rand') ? Math.floor(Math.random() * (pList.length - 1)) + 1 : parseInt(impVal);
            if(numImp >= pList.length) numImp = pList.length - 1;

            const shuffled = [...pList].sort(() => 0.5 - Math.random());
            const chosenImps = shuffled.slice(0, numImp).map(p => p.username);
            const wData = DATA[cat][Math.floor(Math.random() * DATA[cat].length)];

            // Importante: Actualizamos el estado con los ajustes actuales del DOM
            const esPublica = document.getElementById('set-priv').value === 'true';
            const mostrarContador = document.getElementById('set-vis').value === 'true';

            await sb.from('messages').delete().eq('room_id', myR);
            await sb.from('players').update({ is_alive:true, has_voted:false, voted_for:null }).eq('room_id', myR);
            
            await sb.from('rooms').update({
                status: 'playing',
                word: wData.w,
                hint: wData.h,
                impostor_id: chosenImps.join(','),
                impostores_vivos: chosenImps.length,
                winner_side: null,
                turn_index: 0,
                is_public: esPublica,
                show_counter: mostrarContador
            }).eq('code', myR);
        }

        async function enviarMensaje() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt) return;

            const turnoPlayer = pList[tIdx];
            const esMiTurno = (gState === 'playing' && turnoPlayer && turnoPlayer.username === myU);

            await sb.from('messages').insert([{ 
                room_id: myR, username: myU, content: txt, is_clue: esMiTurno 
            }]);
            inp.value = "";

            if(esMiTurno) {
                let nextIdx = tIdx + 1;
                while(pList[nextIdx] && !pList[nextIdx].is_alive) nextIdx++;

                if(nextIdx >= pList.length) await sb.from('rooms').update({ status:'voting' }).eq('code', myR);
                else await sb.from('rooms').update({ turn_index: nextIdx }).eq('code', myR);
            }
        }

        async function votar(voto) { 
            await sb.from('players').update({ has_voted:true, voted_for:voto }).match({ room_id:myR, username:myU });
            document.getElementById('vote-box').classList.add('hidden');
        }

        async function reiniciarSala() {
            document.getElementById('end-screen').classList.add('hidden');
            
            // Reseteamos TODO para evitar que la hostLogic se confunda
            await sb.from('rooms').update({ 
                status:'waiting', winner_side:null, word:null, impostor_id:null, impostores_vivos:0
            }).eq('code',myR);
            
            await sb.from('players').update({ 
                is_alive:true, has_voted:false, voted_for:null 
            }).eq('room_id',myR);
        }

        // --- 6. C√ÅLCULO RESULTADOS (HOST) ---
        async function hostLogic(r, ps) {
            // DOBLE SEGURIDAD: Si estamos esperando, FUERA.
            if(r.status === 'waiting') return;

            const vivos = ps.filter(p => p.is_alive);
            const hanVotado = vivos.filter(p => p.has_voted);

            if(vivos.length > 0 && vivos.length === hanVotado.length) {
                let counts = {}; 
                hanVotado.forEach(p => { counts[p.voted_for] = (counts[p.voted_for] || 0) + 1; });
                
                let expulsado = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                if(expulsado !== 'skip') {
                    await sb.from('players').update({ is_alive:false }).match({ room_id:myR, username:expulsado });
                    
                    const listaImps = (r.impostor_id || "").split(',');
                    if(listaImps.includes(expulsado)) {
                        const quedan = r.impostores_vivos - 1;
                        if(quedan <= 0) return await sb.from('rooms').update({ winner_side:'tripulaci√≥n', impostores_vivos:0 }).eq('code', myR);
                        await sb.from('rooms').update({ impostores_vivos: quedan }).eq('code', myR);
                    }
                }

                // Recalcular post-muerte
                const nuevosVivos = ps.filter(p => p.is_alive && p.username !== expulsado);
                const listaImps = (r.impostor_id || "").split(',');
                const impsVivos = nuevosVivos.filter(p => listaImps.includes(p.username)).length;
                const crewVivos = nuevosVivos.length - impsVivos;

                if(impsVivos >= crewVivos) return await sb.from('rooms').update({ winner_side:'impostores' }).eq('code', myR);

                await sb.from('players').update({ has_voted:false, voted_for:null }).eq('room_id', myR);
                await sb.from('rooms').update({ status:'playing', turn_index:0 }).eq('code', myR);
            }
        }

        document.getElementById('chat-input').onkeypress = (e) => { if(e.key === 'Enter') enviarMensaje(); };
    </script>
</body>
</html>
