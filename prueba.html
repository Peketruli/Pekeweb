<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:400px;background:var(--panel);padding:20px;border-radius:12px;
    display:none;z-index:10;max-height:80vh;overflow:auto;}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
  .gameUI{display:flex;flex-direction:column;}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
(async function main(){
  // ---------- CONFIG / BALANCE ----------
  const container = document.getElementById('container');
  const balanceSpan = document.getElementById('balance');
  const modal = document.getElementById('modal');
  const npcMsgEl = document.getElementById('npcMsg');

  let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{"id":1,"pekepuntos":1000}');
  let balance = Number(currentUser.pekepuntos || 1000);
  function refreshBalanceUI(){ balanceSpan.textContent = balance; }
  refreshBalanceUI();
  function saveBalance(){ currentUser.pekepuntos = balance; localStorage.setItem('currentUser', JSON.stringify(currentUser)); refreshBalanceUI(); }

  // ---------- HELPER ----------
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ---------- THREE.JS ----------
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f1a);

  const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0, 1.6, 5);
  camera.rotation.order = 'YXZ';

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);

  // Luces
  scene.add(new THREE.HemisphereLight(0xffffff,0x222233,0.8));
  scene.add(new THREE.AmbientLight(0xffffff,0.25));
  const dir = new THREE.DirectionalLight(0xfff6d6,0.6);
  dir.position.set(5,10,5); scene.add(dir);

  // Texturas Canvas
  function canvasTextureGradient(a,b,size=512){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d');
    const g=ctx.createLinearGradient(0,0,size,size); g.addColorStop(0,a); g.addColorStop(1,b);
    ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
    return new THREE.CanvasTexture(c);
  }

  // Suelo
  const floorMat = new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#2a0033','#550077'), roughness:0.9 });
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(30,30), floorMat);
  floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

  // Mesas/objetos
  const interactables=[];
  function addTable(x,z,type){
    const mat = new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#222','#550') });
    const geom = (type==='slots')? new THREE.BoxGeometry(1,2,1) : new THREE.CylinderGeometry(1.5,1.5,0.3,32);
    const mesh=new THREE.Mesh(geom,mat);
    mesh.position.set(x,(type==='slots'?1:0.3),z);
    mesh.userData.type=type;
    mesh.castShadow=true; mesh.receiveShadow=true;
    scene.add(mesh); interactables.push(mesh); return mesh;
  }
  const tableBJ=addTable(-4,0,'blackjack');
  const tableR=addTable(0,0,'roulette');
  const tableS=addTable(4,0,'slots');

  // NPC
  const npcMesh=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.6,16),
                               new THREE.MeshStandardMaterial({ color:0x999999 }));
  npcMesh.position.set(0,1,5); npcMesh.userData.type='npc';
  scene.add(npcMesh); interactables.push(npcMesh);

  // ---------- CAMARA Y MOVIMIENTO ----------
  const keys={};
  document.addEventListener('keydown',e=>keys[e.code]=true);
  document.addEventListener('keyup',e=>keys[e.code]=false);
  let yaw=0, pitch=0;
  function updateCamera(dt){
    const yawSpeed=1.8, pitchSpeed=1.2;
    if(keys['ArrowLeft']) yaw+=yawSpeed*dt;
    if(keys['ArrowRight']) yaw-=yawSpeed*dt;
    if(keys['ArrowUp']) pitch+=pitchSpeed*dt;
    if(keys['ArrowDown']) pitch-=pitchSpeed*dt;

    const pitchLimit=Math.PI/2-0.05;
    pitch=Math.max(-pitchLimit,Math.min(pitchLimit,pitch));
    camera.rotation.y=yaw;
    camera.rotation.x=pitch;

    const forward=new THREE.Vector3();
    camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3(); right.crossVectors(forward,camera.up).normalize();
    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward);
    if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right);
    if(keys['KeyA']) move.sub(right);
    move.multiplyScalar(3*dt);
    camera.position.add(move);
  }

  // ---------- RAYCAST INTERACCION ----------
  const ray=new THREE.Raycaster();
  let lookingAt=null;
  function checkInteraction(){
    ray.set(camera.position,camera.getWorldDirection(new THREE.Vector3()));
    const hits=ray.intersectObjects(interactables,false);
    if(hits.length===0 || hits[0].distance>4){ lookingAt=null; npcMsgEl.style.display='none'; return; }
    lookingAt=hits[0].object;
    if(lookingAt.userData.type==='npc'){ npcMsgEl.style.display='block'; npcMsgEl.innerText='Pulsa E para recoger fichas diarias'; }
    else npcMsgEl.style.display='none';
  }

  // ---------- JUEGOS ----------
  function showGameUI(content){ modal.innerHTML=content; modal.style.display='block'; }
  function hideGameUI(){ modal.style.display='none'; }

  async function claimDaily(){
    const today=new Date().toISOString().slice(0,10);
    const last=currentUser.last_claim?currentUser.last_claim.slice(0,10):null;
    if(last===today){ alert('Ya reclamaste hoy.'); return; }
    balance+=100; currentUser.last_claim=new Date().toISOString(); saveBalance();
    alert('Â¡+100 Pekepuntos!'); 
  }

  // Blackjack
  function openBlackjack(){
    showGameUI(`
      <div class="gameUI">
        <h2>Blackjack</h2>
        <label>Apuesta: <input type="number" id="bjBet" value="50" min="1" max="${balance}"></label>
        <button id="deal">Repartir cartas</button>
        <div id="bjActions" style="display:none;">
          <button id="hit">Pedir</button>
          <button id="stand">Plantarse</button>
        </div>
      </div>
    `);
    const betInput=document.getElementById('bjBet');
    const dealBtn=document.getElementById('deal');
    const actionsDiv=document.getElementById('bjActions');

    let player=0, dealer=0;
    dealBtn.onclick=()=>{
      const bet=Math.min(Number(betInput.value),balance);
      player=rand(15,21); dealer=rand(16,21);
      actionsDiv.style.display='flex';
      alert(`Reparto inicial: Tu ${player}, Dealer ???`);
    };
    document.getElementById('hit').onclick=()=>{
      player+=rand(1,5);
      if(player>21){ balance-=Number(betInput.value); saveBalance(); alert('Te pasaste!'); hideGameUI(); } 
      else alert('Tu suma: '+player);
    };
    document.getElementById('stand').onclick=()=>{
      dealer=rand(16,21);
      const bet=Number(betInput.value);
      if(player>21) balance-=bet;
      else if(dealer>21||player>dealer) balance+=bet;
      else if(player===dealer) {}
      else balance-=bet;
      saveBalance();
      alert(`Resultado final: Tu ${player}, Dealer ${dealer}`);
      hideGameUI();
    };
  }

  // Ruleta
  function openRoulette(){
    showGameUI(`
      <div class="gameUI">
        <h2>Ruleta</h2>
        <label>Apuesta: <input type="number" id="rBet" value="50" min="1" max="${balance}"></label>
        <select id="rType">
          <option value="number">NÃºmero</option>
          <option value="color">Color</option>
          <option value="par">Par/Impar</option>
        </select>
        <input type="text" id="rValue" placeholder="NÃºmero o color"/>
        <button id="rSpin">Jugar</button>
      </div>
    `);
    document.getElementById('rSpin').onclick=()=>{
      const bet=Math.min(Number(document.getElementById('rBet').value),balance);
      const type=document.getElementById('rType').value;
      const val=document.getElementById('rValue').value;
      const result=rand(0,36);
      let win=false;
      if(type==='number' && Number(val)===result) win=true;
      else if(type==='color'){
        const red=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        const isRed=red.includes(result);
        if((val.toLowerCase()==='rojo' && isRed) || (val.toLowerCase()==='negro' && !isRed)) win=true;
      }
      else if(type==='par') win=(result%2===0 && val==='par')||(result%2!==0 && val==='impar');
      if(win){ balance+=bet*2; alert(`Ganaste! SaliÃ³ ${result}`); } 
      else { balance-=bet; alert(`Perdiste. SaliÃ³ ${result}`); }
      saveBalance(); hideGameUI();
    };
  }

  // Slots
  function openSlots(){
    showGameUI(`
      <div class="gameUI">
        <h2>Tragamonedas</h2>
        <label>Apuesta: <input type="number" id="sBet" value="50" min="1" max="${balance}"></label>
        <button id="sPlay">Jugar</button>
      </div>
    `);
    document.getElementById('sPlay').onclick=()=>{
      const bet=Math.min(Number(document.getElementById('sBet').value),balance);
      const symbols=['ðŸ’','ðŸ‹','ðŸŠ','ðŸ‡','ðŸ’Ž','7ï¸âƒ£'];
      const r=[rand(0,5),rand(0,5),rand(0,5)];
      const res=r.map(i=>symbols[i]).join(' | ');
      let won=r[0]===r[1] && r[1]===r[2];
      if(won){ balance+=bet*5; alert(`${res}\nJackpot!`); } 
      else { balance-=bet; alert(`${res}\nPerdiste.`); }
      saveBalance(); hideGameUI();
    };
  }

  // ---------- INTERACCION TECLA E ----------
  document.addEventListener('keydown',async(e)=>{
    if(e.code!=='KeyE') return;
    if(!lookingAt) return;
    const t=lookingAt.userData.type;
    if(t==='npc') await claimDaily();
    else if(t==='blackjack') openBlackjack();
    else if(t==='roulette') openRoulette();
    else if(t==='slots') openSlots();
  });

  // ---------- ANIMACION ----------
  const clock=new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    updateCamera(dt);
    checkInteraction();
    renderer.render(scene,camera);
  }
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

})();
</script>
</body>
</html>
