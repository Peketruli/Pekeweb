<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D — Simple</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> €</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';

////////////////////////////////////////////////////////////////
// ESCENA
////////////////////////////////////////////////////////////////
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f1a);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,1.6,5);
camera.rotation.order = 'YXZ';

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.getElementById('container').appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0x222233,1));

////////////////////////////////////////////////////////////////
// SUELO
////////////////////////////////////////////////////////////////
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(20,20),
  new THREE.MeshStandardMaterial({color:0x111826})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

////////////////////////////////////////////////////////////////
// INTERACTUABLES
////////////////////////////////////////////////////////////////
const interact = [];
function addObject(mesh,type){ mesh.userData.type=type; interact.push(mesh); scene.add(mesh); }

const bj = new THREE.Mesh(new THREE.BoxGeometry(2,0.2,1), new THREE.MeshStandardMaterial({color:0x225533}));
bj.position.set(-4,1,0);
addObject(bj,"blackjack");

const ruleta = new THREE.Mesh(new THREE.CylinderGeometry(1,1,0.4,32), new THREE.MeshStandardMaterial({color:0x552222}));
ruleta.position.set(0,1,0);
addObject(ruleta,"roulette");

const slot = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({color:0x333366}));
slot.position.set(4,1,0);
addObject(slot,"slots");

const npc = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.6), new THREE.MeshStandardMaterial({color:0x666666}));
npc.position.set(0,1,4);
addObject(npc,"npc");

////////////////////////////////////////////////////////////////
// CONTROLES
////////////////////////////////////////////////////////////////
const keys = {};
document.addEventListener('keydown', e => keys[e.code]=true);
document.addEventListener('keyup', e => keys[e.code]=false);

let balance = 1000;
const balanceEl = document.getElementById('balance');
function setBal(v){ balance = Math.round(v); balanceEl.textContent = balance; }
setBal(balance);

////////////////////////////////////////////////////////////////
// ROTACIÓN (yaw/pitch)
////////////////////////////////////////////////////////////////
let yaw = 0;
let pitch = 0;
const yawSpeed = 1.8;
const pitchSpeed = 1.2;
const pitchLimit = Math.PI/2 - 0.05;

function updateCameraRotation(dt){
  if(keys['ArrowLeft']) yaw += yawSpeed * dt;
  if(keys['ArrowRight']) yaw -= yawSpeed * dt;

  // invertido correctamente: ArrowUp = mirar arriba
  if(keys['ArrowUp']) pitch -= pitchSpeed * dt;
  if(keys['ArrowDown']) pitch += pitchSpeed * dt;

  if(pitch > pitchLimit) pitch = pitchLimit;
  if(pitch < -pitchLimit) pitch = -pitchLimit;

  camera.rotation.y = yaw;
  camera.rotation.x = pitch;
}

////////////////////////////////////////////////////////////////
// RAYCAST PARA INTERACCIÓN
////////////////////////////////////////////////////////////////
let lookingAt = null;
const ray = new THREE.Raycaster();
function checkInteraction(){
  ray.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
  const hits = ray.intersectObjects(interact, false);
  if(hits.length===0 || hits[0].distance > 4){ lookingAt=null; document.getElementById('npcMsg').style.display='none'; return; }
  lookingAt = hits[0].object;
  if(lookingAt.userData.type === 'npc') document.getElementById('npcMsg').style.display='block';
  else document.getElementById('npcMsg').style.display='none';
}

////////////////////////////////////////////////////////////////
// UI Y JUEGOS (sin cambios)
////////////////////////////////////////////////////////////////
const modal = document.getElementById('modal');

function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function createDeck(){
  const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const suits = ['♠','♥','♦','♣'];
  const d=[]; for(const s of suits) for(const v of vals) d.push({v,s});
  for(let i=d.length-1;i>0;i--){ const j=rand(0,i); [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}
function cardValue(c){ if(c.v==='A') return 11; if(['J','Q','K'].includes(c.v)) return 10; return parseInt(c.v); }
function handScore(hand){ let sum=0, aces=0; for(const c of hand){ if(c.v==='A') aces++; sum += cardValue(c); } while(sum>21 && aces>0){ sum-=10; aces--; } return sum; }

function renderBlackjackUI(){
  modal.innerHTML = '';
  const containerEl = document.createElement('div'); containerEl.className='gameUI';
  containerEl.innerHTML = `
    <h2>Blackjack</h2>
    <div>Saldo: <span id='bjBal'>${balance}</span> €</div>
    <label>Apuesta: <input id='bjBet' type='number' value='10' min='1' style='width:80px'></label>
    <div id='bjTable' style='margin-top:8px'></div>
    <div style='margin-top:8px'><button id='bjDeal'>Repartir</button> <button id='bjClose'>Cerrar</button></div>
  `;
  modal.appendChild(containerEl);

  let deck=null, player=[], dealer=[], bet=0, inRound=false;
  const bjTable = containerEl.querySelector('#bjTable');
  const bjBal = containerEl.querySelector('#bjBal');

  function updateTable(){ bjTable.innerHTML = `<div>Jugador: ${player.map(c=>c.v+c.s).join(' ')} (${handScore(player)})</div><div>Dealer: ${dealer.map(c=>c.v+c.s).join(' ')} (${inRound? '?': handScore(dealer)})</div>`; bjBal.textContent = balance; }

  containerEl.querySelector('#bjDeal').onclick = ()=>{
    bet = Math.min(balance, Number(containerEl.querySelector('#bjBet').value)||0);
    if(bet<=0){ alert('Apuesta inválida'); return; }
    balance -= bet; setBal(balance); deck = createDeck(); player=[deck.pop(), deck.pop()]; dealer=[deck.pop(), deck.pop()]; inRound=true; updateTable();

    const hitBtn = document.createElement('button'); hitBtn.textContent='Pedir';
    const standBtn = document.createElement('button'); standBtn.textContent='Plantarse';
    bjTable.appendChild(hitBtn); bjTable.appendChild(standBtn);

    hitBtn.onclick = ()=>{ player.push(deck.pop()); updateTable(); if(handScore(player)>21){ finish(); } };
    standBtn.onclick = ()=>{ while(handScore(dealer)<17) dealer.push(deck.pop()); finish(); };

    function finish(){ inRound=false; updateTable(); const p=handScore(player), d=handScore(dealer);
      let res='Empate'; if(p>21) res='Pierdes'; else if(d>21 || p>d){ res='Ganas'; balance += bet*2; setBal(balance); } else if(p===d){ balance += bet; setBal(balance); res='Empate'; } else res='Pierdes'; bjTable.innerHTML += `<div style='margin-top:8px'>Resultado: ${res}</div>`; }
  };

  containerEl.querySelector('#bjClose').onclick = ()=>{ modal.style.display='none'; };
}

function renderRouletteUI(){ /* igual que antes */ }
function isRed(n){ const reds = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]); return reds.has(n); }
function renderSlotsUI(){ /* igual que antes */ }

function openUI(type){
  if(type === 'blackjack') modal.style.display = 'block', renderBlackjackUI();
  else if(type === 'roulette') modal.style.display = 'block', renderRouletteUI();
  else if(type === 'slots') modal.style.display = 'block', renderSlotsUI();
  else if(type === 'npc'){ setBal(balance+100); document.getElementById('npcMsg').innerText='¡Has recogido tus fichas diarias!'; document.getElementById('npcMsg').style.display='block'; setTimeout(()=>document.getElementById('npcMsg').style.display='none',1400); }
}

document.addEventListener('keydown', e=>{ if(e.code==='KeyE' && lookingAt) openUI(lookingAt.userData.type); });
document.getElementById('container').addEventListener('click', ()=>{ if(lookingAt) openUI(lookingAt.userData.type); });

////////////////////////////////////////////////////////////////
// LOOP PRINCIPAL (con movimiento relativo a la cámara)
////////////////////////////////////////////////////////////////
const clock = new THREE.Clock();
function loop(){
  requestAnimationFrame(loop);
  const dt = clock.getDelta();

  const speed = 3.0;
  const direction = new THREE.Vector3();

  if(keys['KeyW']) direction.z -= 1;
  if(keys['KeyS']) direction.z += 1;
  if(keys['KeyA']) direction.x -= 1;
  if(keys['KeyD']) direction.x += 1;

  if(direction.length()>0){
    direction.normalize();
    const yawMatrix = new THREE.Matrix4().makeRotationY(yaw);
    direction.applyMatrix4(yawMatrix);
    camera.position.addScaledVector(direction, speed*dt);
  }

  updateCameraRotation(dt);
  checkInteraction();
  renderer.render(scene,camera);
}
loop();

////////////////////////////////////////////////////////////////
// RESPONSIVE
////////////////////////////////////////////////////////////////
window.onresize = ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
