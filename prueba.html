<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D - Movimiento corregido</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:Arial, Helvetica, sans-serif; }
  #hint {
    position: absolute; left: 12px; top: 12px; z-index: 5;
    background: rgba(0,0,0,0.5); color: #fff; padding:8px 10px; border-radius:8px;
    font-size:13px;
  }
</style>
</head>
<body>
<div id="hint">Mover: W A S D — Mirar: mueve el ratón</div>
<script>
// ---------- Scene, camera, renderer ----------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050505);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(0, 1.7, 10);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

// ---------- Lights ----------
scene.add(new THREE.AmbientLight(0xffffff, 0.45));
const pt = new THREE.PointLight(0xff66ff, 1.8, 50);
pt.position.set(0, 6, 0);
scene.add(pt);

// ---------- Floor & walls ----------
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(50, 50),
  new THREE.MeshStandardMaterial({ color: 0x222222 })
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

const wallMat = new THREE.MeshStandardMaterial({ color: 0x330033 });
const backWall = new THREE.Mesh(new THREE.BoxGeometry(50, 10, 1), wallMat);
backWall.position.set(0, 5, -20);
scene.add(backWall);

const leftWall = new THREE.Mesh(new THREE.BoxGeometry(1, 10, 50), wallMat);
leftWall.position.set(-25, 5, 5);
scene.add(leftWall);

const rightWall = new THREE.Mesh(new THREE.BoxGeometry(1, 10, 50), wallMat);
rightWall.position.set(25, 5, 5);
scene.add(rightWall);

// ---------- Corridor elements ----------
const corridorWallMat = new THREE.MeshStandardMaterial({ color: 0x440044 });
for (let i = -20; i < 5; i += 5) {
  const wallL = new THREE.Mesh(new THREE.BoxGeometry(1,10,5), corridorWallMat);
  wallL.position.set(-5, 5, i);
  scene.add(wallL);
  const wallR = wallL.clone();
  wallR.position.set(5, 5, i);
  scene.add(wallR);
}

// ---------- Casino objects ----------
const slotMat = new THREE.MeshStandardMaterial({ color: 0xff00ff, emissive: 0x330033 });
for (let i = 0; i < 6; i++) {
  const slot = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2.5, 1.5), slotMat);
  slot.position.set(i * 3 - 7.5, 1.25, -5);
  scene.add(slot);
}

const table = new THREE.Mesh(
  new THREE.CylinderGeometry(5, 5, 0.5, 32),
  new THREE.MeshStandardMaterial({ color: 0x004400 })
);
table.position.set(0, 0.25, 5);
scene.add(table);

const ruleta = new THREE.Mesh(
  new THREE.CylinderGeometry(2, 2, 0.3, 32),
  new THREE.MeshStandardMaterial({ color: 0x990000 })
);
ruleta.position.set(-10, 0.15, 8);
scene.add(ruleta);

// ---------- Movement & Look (fixed) ----------
// Use yaw/pitch angles and compute forward from camera.getWorldDirection()
// This ensures forward is always where the camera is looking.

let yaw = 0;   // horizontal rotation
let pitch = 0; // vertical rotation
const sens = 0.0026; // mouse sensitivity

// Mouse look: track pointer movement even if not locked.
// On some browsers movementX/Y are zero until user interacts; this method will work when user moves mouse.
window.addEventListener('mousemove', (e) => {
  // e.movementX/movementY work even without pointer lock in most browsers during mouse move
  // but if they are zero (touchpad, mobile), the user still can use arrow keys later if needed.
  yaw -= (e.movementX || 0) * sens;
  pitch -= (e.movementY || 0) * sens;
  // clamp pitch to avoid flipping
  const maxPitch = Math.PI / 2 - 0.05;
  pitch = Math.max(-maxPitch, Math.min(maxPitch, pitch));
});

// Keyboard move
const keys = {};
window.addEventListener('keydown', (e) => { keys[e.code] = true; });
window.addEventListener('keyup', (e) => { keys[e.code] = false; });

// Smooth movement velocity (simple)
const velocity = new THREE.Vector3();
const accel = 30.0;
const damping = 10.0;

// Temporary vectors to avoid allocations
const forwardVec = new THREE.Vector3();
const rightVec = new THREE.Vector3();
const upVec = new THREE.Vector3(0,1,0);

const clock = new THREE.Clock();

function updateMovement(dt) {
  // get camera forward (world) direction
  camera.rotation.set(pitch, yaw, 0, "ZYX"); // apply pitch & yaw to camera
  camera.updateMatrixWorld();

  camera.getWorldDirection(forwardVec); // points where camera looks
  forwardVec.y = 0; // keep movement on XZ plane
  forwardVec.normalize();

  // right vector = forward cross up
  rightVec.copy(forwardVec).cross(upVec).negate(); // ensure right points to camera's right

  // desired direction
  let moveX = 0, moveZ = 0;
  if (keys['KeyW']) moveZ += 1;
  if (keys['KeyS']) moveZ -= 1;
  if (keys['KeyD']) moveX += 1;
  if (keys['KeyA']) moveX -= 1;

  const desired = new THREE.Vector3();
  desired.addScaledVector(forwardVec, moveZ);
  desired.addScaledVector(rightVec, moveX);
  if (desired.lengthSq() > 0) desired.normalize();

  // accelerate / damp
  velocity.addScaledVector(desired, accel * dt);
  velocity.multiplyScalar(1 / (1 + damping * dt));

  // move camera position
  camera.position.addScaledVector(velocity, dt);
}

// ---------- Animation loop ----------
function animate() {
  requestAnimationFrame(animate);
  const dt = Math.min(clock.getDelta(), 0.05); // clamp delta

  updateMovement(dt);

  // small ambient animation
  ruleta.rotation.y += 0.01;

  renderer.render(scene, camera);
}
animate();

// ---------- Resize ----------
window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// ---------- Helpful: center the mouse cursor hint removal ----------
const hint = document.getElementById('hint');
let hintTimeout = setTimeout(()=>{ hint.style.display = 'none'; }, 4000);

// Optional: If you want the cursor visible, remove 'cursor:none' from body style.
// End of script
</script>
</body>
</html>
