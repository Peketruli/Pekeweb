<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Casino — Sala y Pasillo ajustados</title>
<style>
html,body{height:100%;margin:0;overflow:hidden;background:#111;font-family:Inter,Arial,Helvetica,sans-serif}
canvas{display:block;width:100vw;height:100vh}
#prompt {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -120%);
  background: rgba(0,0,0,0.72);
  color: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 18px;
  pointer-events: none;
  display: none;
  z-index: 20;
  box-shadow: 0 4px 18px rgba(0,0,0,0.6);
}
#hint {
  position: fixed;
  right: 12px;
  top: 12px;
  color: #fff;
  z-index: 10;
  background: rgba(0,0,0,0.45);
  padding: 8px;
  border-radius: 6px;
  font-size: 13px;
}
</style>
</head>
<body>
<div id="prompt">Presiona <b>E</b> para abrir</div>
<div id="hint">W/S mover • A/D girar • Shift correr • Espacio saltar • Acércate a la puerta</div>
<canvas id="c"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script>
// ------------------------
// Setup
// ------------------------
const canvas=document.getElementById('c');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
const scene=new THREE.Scene();
scene.background=new THREE.Color(0xebe6dc);

const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,50);
camera.position.set(0,1.7,0.5);
camera.lookAt(0,1.7,-4);
scene.add(camera);

// ------------------------
// Materiales
// ------------------------
const wallMat=new THREE.MeshBasicMaterial({color:0xD3C6B2});
const floorMat=new THREE.MeshBasicMaterial({color:0x7a7a7a});
const ceilingMat=new THREE.MeshBasicMaterial({color:0x3b3b3b});
const doorMat=new THREE.MeshBasicMaterial({color:0x3f2a18});
const frameMat=new THREE.MeshBasicMaterial({color:0x2e1d12});
const roomFloorMat=new THREE.MeshBasicMaterial({color:0x5a0b0b});
const roomWallMat=new THREE.MeshBasicMaterial({color:0xCFC0B0});

// ------------------------
// Parámetros
// ------------------------
const pasillo={L:5,W:2,H:2.5,thick:0.12};
const sala={L:10,W:12,H:3};

// ------------------------
// Pasillo
// ------------------------
const floorGeo=new THREE.PlaneGeometry(pasillo.W,pasillo.L);
const floor=new THREE.Mesh(floorGeo,floorMat);
floor.rotation.x=-Math.PI/2;
floor.position.set(0,0,-pasillo.L/2);
scene.add(floor);

const ceiling=new THREE.Mesh(new THREE.BoxGeometry(pasillo.W,pasillo.thick,pasillo.L),ceilingMat);
ceiling.position.set(0,pasillo.H-pasillo.thick/2,-pasillo.L/2);
scene.add(ceiling);

const leftWall=new THREE.Mesh(new THREE.BoxGeometry(pasillo.thick,pasillo.H,pasillo.L),wallMat);
leftWall.position.set(-pasillo.W/2-pasillo.thick/2,pasillo.H/2,-pasillo.L/2);
scene.add(leftWall);
const rightWall=leftWall.clone(); rightWall.position.set(pasillo.W/2+pasillo.thick/2,pasillo.H/2,-pasillo.L/2);
scene.add(rightWall);
const backWall=new THREE.Mesh(new THREE.BoxGeometry(pasillo.W,pasillo.H,pasillo.thick),wallMat);
backWall.position.set(0,pasillo.H/2,0.1);
scene.add(backWall);

// ------------------------
// Puerta ajustada
// ------------------------
const doorW=1,doorH=2,doorD=0.12;
// ajustamos la puerta a la derecha y un poco más arriba
const hingeX=-pasillo.W/2 + 0.4;
const hingeY=doorH/2 + 0.3;
const hingeZ=-pasillo.L-0.01;
const doorPivot=new THREE.Object3D();
doorPivot.position.set(hingeX,hingeY,hingeZ);
scene.add(doorPivot);

const doorMesh=new THREE.Mesh(new THREE.BoxGeometry(doorW,doorH,doorD),doorMat);
doorMesh.position.set(doorW/2,0,0);
doorPivot.add(doorMesh);

// Marco puerta
const frameLeft=new THREE.Mesh(new THREE.BoxGeometry(0.12,doorH+0.12,0.2),frameMat);
frameLeft.position.set(hingeX-0.06,hingeY,hingeZ-0.06); scene.add(frameLeft);
const frameRight=new THREE.Mesh(new THREE.BoxGeometry(0.12,doorH+0.12,0.2),frameMat);
frameRight.position.set(hingeX+doorW+0.06,hingeY,hingeZ-0.06); scene.add(frameRight);
const frameTop=new THREE.Mesh(new THREE.BoxGeometry(doorW+0.24,0.12,0.2),frameMat);
frameTop.position.set(hingeX+doorW/2,doorH+0.06,hingeZ-0.06); scene.add(frameTop);

// ------------------------
// Sala
// ------------------------
const roomFloor=new THREE.Mesh(new THREE.PlaneGeometry(sala.W,sala.L),roomFloorMat);
roomFloor.rotation.x=-Math.PI/2;
roomFloor.position.set(0,0,hingeZ-sala.L/2);
scene.add(roomFloor);

const roomBack=new THREE.Mesh(new THREE.BoxGeometry(sala.W,sala.H,0.2),roomWallMat);
roomBack.position.set(0,sala.H/2,hingeZ-sala.L); scene.add(roomBack);
const roomLeft=new THREE.Mesh(new THREE.BoxGeometry(0.2,sala.H,sala.L),roomWallMat);
roomLeft.position.set(-sala.W/2,sala.H/2,hingeZ-sala.L/2); scene.add(roomLeft);
const roomRight=roomLeft.clone(); roomRight.position.set(sala.W/2,sala.H/2,hingeZ-sala.L/2); scene.add(roomRight);

// Techo sala
const roomCeiling=new THREE.Mesh(new THREE.BoxGeometry(sala.W,pasillo.thick,sala.L),ceilingMat);
roomCeiling.position.set(0,sala.H-pasillo.thick/2,hingeZ-sala.L/2);
scene.add(roomCeiling);

// Pared frontal dividida para no tapar la puerta
const roomFrontLeft=new THREE.Mesh(new THREE.BoxGeometry((sala.W-doorW)/2,sala.H,0.2),roomWallMat);
roomFrontLeft.position.set(-doorW/2-(sala.W-doorW)/4,sala.H/2,hingeZ); scene.add(roomFrontLeft);
const roomFrontRight=new THREE.Mesh(new THREE.BoxGeometry((sala.W-doorW)/2,sala.H,0.2),roomWallMat);
roomFrontRight.position.set(doorW/2+(sala.W-doorW)/4,sala.H/2,hingeZ); scene.add(roomFrontRight);

// ------------------------
// Sonido puerta
// ------------------------
const doorAudio=new Audio('https://cdn.jsdelivr.net/gh/Peketruli/sounds/door-light.mp3');
function playDoorSound(opening=true){doorAudio.currentTime=0;doorAudio.play();}

// ------------------------
// Estados puerta
// ------------------------
let doorState='closed',animT=0,autoCloseTimeout=null;
const openAngle=-Math.PI*0.45,closedAngle=0,animDur=0.6;

// ------------------------
// Movimiento jugador
// ------------------------
const keys={};
window.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='KeyE') triggerDoor();});
window.addEventListener('keyup',e=>{keys[e.code]=false;});

let velY=0, canJump=true, walkSpeed=0.1, runSpeed=0.24, rotSpeed=0.05;
function distToDoor(){
  const doorWorld=new THREE.Vector3();
  doorMesh.getWorldPosition(doorWorld);
  const dx=camera.position.x-doorWorld.x;
  const dz=camera.position.z-doorWorld.z;
  const dy=camera.position.y-doorWorld.y;
  return Math.sqrt(dx*dx+dy*dy+dz*dz);
}
const promptEl=document.getElementById('prompt');
function updatePrompt(){ promptEl.style.display = distToDoor()<2 ? 'block' : 'none'; }

function triggerDoor(){
  if(distToDoor()<2){
    if(doorState==='closed'||doorState==='closing'){
      doorState='opening'; animT=0; playDoorSound(true);
      if(autoCloseTimeout) clearTimeout(autoCloseTimeout);
      setTimeout(()=>{if(doorState==='open') autoCloseTimeout=setTimeout(()=>{if(doorState==='open'){doorState='closing';animT=0;playDoorSound(false);}},3000);}, animDur*1000);
    } else if(doorState==='open'){ doorState='closing'; animT=0; playDoorSound(false); if(autoCloseTimeout) clearTimeout(autoCloseTimeout);}
  }
}

// ------------------------
// Animación y límites físicos
// ------------------------
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(0.05,clock.getDelta());

  // Rotación
  if(keys['KeyA']) camera.rotation.y+=rotSpeed;
  if(keys['KeyD']) camera.rotation.y-=rotSpeed;

  // Movimiento
  const dir=new THREE.Vector3(); camera.getWorldDirection(dir); dir.y=0; dir.normalize();
  const speed=(keys['ShiftLeft']||keys['ShiftRight'])?runSpeed:walkSpeed;
  if(keys['KeyW']) camera.position.addScaledVector(dir,speed);
  if(keys['KeyS']) camera.position.addScaledVector(dir,-speed);

  // Salto y gravedad
  if(keys['Space'] && canJump) { velY=0.32; canJump=false; }
  velY-=0.02; camera.position.y+=velY;
  if(camera.position.y<1.7){camera.position.y=1.7; velY=0; canJump=true;}

  // Límites pasillo sin bloquear entrada a la sala
  const halfW=pasillo.W/2-0.05;
  if(camera.position.x<-halfW) camera.position.x=-halfW;
  if(camera.position.x>halfW) camera.position.x=halfW;
  if(camera.position.z>0) camera.position.z=0;

  // Límites sala
  const doorOpen = (doorState==='open');
  const roomHalfW=sala.W/2-0.05;
  const roomFrontZ=hingeZ;
  const roomBackZ=hingeZ-sala.L;
  if(camera.position.x<-roomHalfW) camera.position.x=-roomHalfW;
  if(camera.position.x>roomHalfW) camera.position.x=roomHalfW;
  if(!doorOpen && camera.position.z>roomFrontZ-0.05) camera.position.z=roomFrontZ-0.05;
  if(camera.position.z<roomBackZ) camera.position.z=roomBackZ;

  updatePrompt();

  // Animar puerta
  if(doorState==='opening'){animT+=dt; const t=Math.min(1,animT/animDur); const ease=t*(2-t); doorPivot.rotation.y=closedAngle+(openAngle-closedAngle)*ease; if(t>=1) doorState='open';}
  else if(doorState==='closing'){animT+=dt; const t=Math.min(1,animT/animDur); const ease=t*(2-t); doorPivot.rotation.y=openAngle+(closedAngle-openAngle)*ease;if(t>=1) doorState='closed';}

  renderer.render(scene,camera);
}
animate();

// ------------------------
// Resize
// ------------------------
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
