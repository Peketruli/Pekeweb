<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado UI</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10;max-height:70vh;overflow:auto}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0; cursor:pointer}
  .gameUI{position:absolute;top:50px; left:10px; background:rgba(0,0,0,0.6); padding:10px; border-radius:8px; display:none; z-index:10; min-width:180px;}
  .gameUI h2{margin:0 0 8px 0; font-size:1.2rem}
</style>
</head>
<body>
<div id="container"></div>

<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
  <div id="pekepuntos" class="panel">Pekepuntos: 0</div>
</div>

<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<div id="gameUI" class="gameUI">
  <h2 id="gameTitle">Juego</h2>
  <div id="gameControls"></div>
</div>

<!-- three.js (min) -->
<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
(async function main(){

  // ---------- Config Supabase ----------
  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anF6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';

  if(!window.supabase){
    await new Promise((res, rej)=>{
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/@supabase/supabase-js';
      s.onload = ()=>res();
      s.onerror = ()=>rej(new Error('No se pudo cargar supabase.js'));
      document.head.appendChild(s);
    }).catch(e=>alert('Error cargando Supabase: '+e));
  }

  let supabase = null;
  if(window.supabase && typeof window.supabase.createClient==='function'){
    supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  }

  // ---------- Helpers ----------
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  const container = document.getElementById('container');
  const balanceSpan = document.getElementById('balance');
  const pekepuntosEl = document.getElementById('pekepuntos');
  const npcMsgEl = document.getElementById('npcMsg');
  const gameUI = document.getElementById('gameUI');
  const gameTitle = document.getElementById('gameTitle');
  const gameControls = document.getElementById('gameControls');

  // ---------- Usuario ----------
  let currentUser = null;
  try { currentUser = JSON.parse(localStorage.getItem('currentUser')||'null'); } catch(e){ currentUser=null; }
  if(!currentUser){ alert('Debes iniciar sesiÃ³n para jugar'); return; }

  let balance = Number(currentUser.pekepuntos||0);
  function refreshBalanceUI(){
    if(balanceSpan) balanceSpan.textContent = balance;
    if(pekepuntosEl) pekepuntosEl.textContent = `Pekepuntos: ${balance}`;
  }
  refreshBalanceUI();

  async function saveBalance(){
    try{
      if(supabase){
        const { error } = await supabase.from('usuarios').update({pekepuntos:balance}).eq('id',currentUser.id);
        if(error) throw error;
      }
      currentUser.pekepuntos=balance;
      localStorage.setItem('currentUser',JSON.stringify(currentUser));
      refreshBalanceUI();
    } catch(err){
      alert('Error guardando balance: '+(err?.message||err));
    }
  }

  // ---------- Claim diario ----------
  async function claimDaily(){
    const today = new Date().toISOString().slice(0,10);
    const last = currentUser.last_claim?currentUser.last_claim.slice(0,10):null;
    if(last===today){ alert('Ya reclamaste hoy'); return; }
    balance+=100;
    currentUser.last_claim = new Date().toISOString();
    if(supabase){
      const {error}=await supabase.from('usuarios').update({pekepuntos:balance,last_claim:currentUser.last_claim}).eq('id',currentUser.id);
      if(error) console.warn(error);
    }
    localStorage.setItem('currentUser',JSON.stringify(currentUser));
    refreshBalanceUI();
    npcMsgEl.innerText='Â¡Has recogido tus fichas diarias!'; npcMsgEl.style.display='block';
    setTimeout(()=> npcMsgEl.style.display='none',1400);
  }

  // ---------- Juegos ----------
  function showGameUI(type){
    gameTitle.innerText = type.charAt(0).toUpperCase()+type.slice(1);
    gameControls.innerHTML='';

    if(type==='blackjack'){
      ['50','100'].forEach(b=>{
        const btn=document.createElement('button'); btn.textContent='Apostar '+b;
        btn.onclick=()=> playBlackjackUI(Number(b));
        gameControls.appendChild(btn);
      });
    }
    else if(type==='roulette'){
      const input=document.createElement('input'); input.placeholder='NÃºmero (0-36) o color'; input.id='rouletteInput';
      gameControls.appendChild(input);
      const btn=document.createElement('button'); btn.textContent='Apostar';
      btn.onclick=()=> playRouletteUI(50);
      gameControls.appendChild(btn);
    }
    else if(type==='slots'){
      const btn=document.createElement('button'); btn.textContent='Girar 50';
      btn.onclick=()=> playSlotsUI(50);
      gameControls.appendChild(btn);
    }
    gameUI.style.display='block';
  }

  function hideGameUI(){ gameUI.style.display='none'; gameControls.innerHTML=''; }

  async function playBlackjackUI(bet){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    const player=rand(15,21), dealer=rand(16,21);
    let result='lose';
    if(player>21) result='lose';
    else if(dealer>21 || player>dealer) result='win';
    else if(player===dealer) result='tie';
    else result='lose';
    if(result==='win') balance+=bet;
    else if(result==='lose') balance-=bet;
    await saveBalance(); hideGameUI();
    alert(`Blackjack: Tu ${player} â€” Dealer ${dealer}\nResultado: ${result}`);
  }

  async function playRouletteUI(bet){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    const input=document.getElementById('rouletteInput');
    const chosen=input.value;
    if(!chosen) return;
    const result=rand(0,36);
    const color=result%2===0?'rojo':'negro';
    let win=false;
    if(!isNaN(chosen) && Number(chosen)===result) win=true;
    else if(chosen.toLowerCase()===color) win=true;
    if(win) balance+=bet*2; else balance-=bet;
    await saveBalance(); hideGameUI();
    alert(`Ruleta: SaliÃ³ ${result} (${color})\nResultado: ${win?'Ganaste':'Perdiste'}`);
  }

  async function playSlotsUI(bet){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    const symbols=['ðŸ’','ðŸ‹','ðŸŠ','ðŸ‡','ðŸ’Ž','7ï¸âƒ£'];
    const r=[rand(0,5),rand(0,5),rand(0,5)];
    const res=r.map(i=>symbols[i]).join(' | ');
    const won=(r[0]===r[1] && r[1]===r[2]);
    if(won) balance+=bet*5; else balance-=bet;
    await saveBalance(); hideGameUI();
    alert(`Slots: ${res}\n${won?'Jackpot! Ganaste':'Perdiste'}`);
  }

  // ---------- THREE.JS Escena ----------
  const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0f1a);
  const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
  camera.position.set(0,1.6,5); camera.rotation.order='YXZ';
  const renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight); renderer.shadowMap.enabled=true; container.appendChild(renderer.domElement);

  const hemi=new THREE.HemisphereLight(0xffffff,0x222233,0.8); hemi.position.set(0,50,0); scene.add(hemi);
  scene.add(new THREE.AmbientLight(0xffffff,0.25));
  const dir=new THREE.DirectionalLight(0xfff6d6,0.6); dir.position.set(5,10,5); scene.add(dir);

  function canvasTextureGradient(a,b,size=512){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d'); const g=ctx.createLinearGradient(0,0,size,size); g.addColorStop(0,a); g.addColorStop(1,b);
    ctx.fillStyle=g; ctx.fillRect(0,0,size,size); return new THREE.CanvasTexture(c);
  }

  const floorMat=new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#2a0033','#550077'), roughness:0.9 });
  const floor=new THREE.Mesh(new THREE.PlaneGeometry(30,30), floorMat);
  floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

  const interactables=[];
  function addTable(x,z,type){
    const mat=new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#222','#550') });
    const geom=(type==='slots')?new THREE.BoxGeometry(1,2,1):new THREE.CylinderGeometry(1.5,1.5,0.3,32);
    const mesh=new THREE.Mesh(geom, mat); mesh.position.set(x,(type==='slots'?1:0.3),z);
    mesh.userData.type=type; mesh.castShadow=true; mesh.receiveShadow=true;
    scene.add(mesh); interactables.push(mesh); return mesh;
  }

  const tableBJ=addTable(-4,0,'blackjack');
  const tableR=addTable(0,0,'roulette');
  const tableS=addTable(4,0,'slots');

  const npcGeom=new THREE.CylinderGeometry(0.4,0.4,1.6,16);
  const npcMat=new THREE.MeshStandardMaterial({ color:0x999999 });
  const npcMesh=new THREE.Mesh(npcGeom,npcMat);
  npcMesh.position.set(0,1,5); npcMesh.userData.type='npc';
  scene.add(npcMesh); interactables.push(npcMesh);

  // Movimiento cÃ¡mara
  const keys={};
  document.addEventListener('keydown',e=>keys[e.code]=true);
  document.addEventListener('keyup',e=>keys[e.code]=false);
  let yaw=0,pitch=0;
  function updateCamera(dt){
    const yawSpeed=1.8,pitchSpeed=1.2;
    if(keys['ArrowLeft']) yaw+=yawSpeed*dt;
    if(keys['ArrowRight']) yaw-=yawSpeed*dt;
    if(keys['ArrowUp']) pitch+=pitchSpeed*dt;
    if(keys['ArrowDown']) pitch-=pitchSpeed*dt;
    const pitchLimit=Math.PI/2-0.05; pitch=Math.max(-pitchLimit,Math.min(pitchLimit,pitch));
    camera.rotation.y=yaw; camera.rotation.x=pitch;
    const forward=new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3(); right.crossVectors(forward,camera.up).normalize();
    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward); if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right); if(keys['KeyA']) move.sub(right);
    move.multiplyScalar(3*dt); camera.position.add(move);
  }

  // Raycast interacciÃ³n
  const ray=new THREE.Raycaster(); let lookingAt=null;
  function checkInteraction(){
    ray.set(camera.position,camera.getWorldDirection(new THREE.Vector3()));
    const hits=ray.intersectObjects(interactables,false);
    if(!hits.length||hits[0].distance>4){ lookingAt=null; npcMsgEl.style.display='none'; hideGameUI(); return; }
    lookingAt=hits[0].object;
    if(lookingAt.userData.type==='npc'){
      npcMsgEl.style.display='block'; npcMsgEl.innerText='Pulsa E para fichas diarias';
      hideGameUI();
    } else if(['blackjack','roulette','slots'].includes(lookingAt.userData.type)){
      showGameUI(lookingAt.userData.type);
      npcMsgEl.style.display='none';
    } else hideGameUI();
  }

  document.addEventListener('keydown',async e=>{
    if(e.code!=='KeyE') return;
    if(!lookingAt) return;
    const t=lookingAt.userData.type;
    if(t==='npc') await claimDaily();
  });

  const clock=new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    updateCamera(dt);
    checkInteraction();
    renderer.render(scene,camera);
  }
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);
  });

  window._casino={playBlackjackUI,playRouletteUI,playSlotsUI,claimDaily,currentUser};

})();
</script>
</body>
</html>
