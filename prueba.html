<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Primera persona (Demo)</title>
<style>
  :root{--bg:#071022;--panel:#0b1220;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, sans-serif;background:var(--bg);color:#e6eef6}
  #container{width:100%;height:100%;position:relative;overflow:hidden}
  canvas{display:block}
  #hud{position:absolute;left:12px;top:12px;z-index:10}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15));border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(6px);padding:10px;border-radius:8px;margin-bottom:8px}
  #instructions{width:300px}
  #crosshair{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:20px;opacity:0.8;z-index:9}
  #uiModal{position:absolute;right:20px;top:20px;width:420px;max-width:calc(100% - 40px);z-index:20;display:none}
  .gameUI{padding:12px;background:var(--panel);border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
  .gameUI h2{margin:0 0 8px 0}
  .row{display:flex;gap:8px;align-items:center}
  button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:6px;color:#e6eef6;cursor:pointer}
  input[type=number]{width:80px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef6}
  #log{margin-top:8px;font-size:13px;color:var(--muted);max-height:120px;overflow:auto}
  /* small help */
  #help{position:absolute;left:12px;bottom:12px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div id="container"></div>
<div id="hud">
  <div id="instructions" class="panel">
    <strong>Casino 3D â€” Demo</strong>
    <div style="margin-top:8px">WASD mover Â· SPACE saltar Â· Click izquierda interactuar Â· E abrir/cerrar mesa</div>
  </div>
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
</div>
<div id="crosshair">+</div>
<div id="uiModal"></div>
<div id="help">Mira a un objeto y haz click para interactuar</div>

<script type="module">
// ----- Imports from CDN (module) -----
import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.155.0/examples/jsm/controls/PointerLockControls.js';

// ----- Basic scene setup -----
const container = document.getElementById('container');
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x071022, 0.02);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
container.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,1.6,5);

// Lights
const hemi = new THREE.HemisphereLight(0xffffee, 0x080820, 0.8);
scene.add(hemi);
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5,10,7);
scene.add(dir);

// Floor
const floorGeo = new THREE.PlaneGeometry(80,80);
const floorMat = new THREE.MeshStandardMaterial({color:0x0b1220,roughness:0.9,metalness:0.1});
const floor = new THREE.Mesh(floorGeo, floorMat);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// Walls (simple)
const wallMat = new THREE.MeshStandardMaterial({color:0x091226,roughness:0.95});
const wallGeo = new THREE.BoxGeometry(80,6,1);
const back = new THREE.Mesh(wallGeo, wallMat); back.position.set(0,3,-40); scene.add(back);
const left = new THREE.Mesh(wallGeo, wallMat); left.scale.set(1,1,1); left.rotation.y = Math.PI/2; left.position.set(-40,3,0); scene.add(left);
const right = new THREE.Mesh(wallGeo, wallMat); right.rotation.y = Math.PI/2; right.position.set(40,3,0); scene.add(right);

// Simple casino objects: tables
const interactables = []; // {mesh, type, id}

function createTable(x,z,label,type){
  const g = new THREE.BoxGeometry(2.4,0.2,1.4);
  const m = new THREE.MeshStandardMaterial({color: type==='blackjack'?0x1a5a2a:0x733333,roughness:0.6});
  const table = new THREE.Mesh(g,m);
  table.position.set(x,0.9,z);
  table.userData = {type};
  scene.add(table);

  // small pole
  const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.8), new THREE.MeshStandardMaterial({color:0x222222}));
  pole.position.set(x,0.45,z);
  scene.add(pole);

  // label
  const canvas = document.createElement('canvas'); canvas.width=256; canvas.height=64;
  const ctx = canvas.getContext('2d'); ctx.fillStyle='#222'; ctx.fillRect(0,0,256,64);
  ctx.fillStyle='white'; ctx.font='20px sans-serif'; ctx.fillText(label,12,40);
  const tex = new THREE.CanvasTexture(canvas);
  const labelMesh = new THREE.Mesh(new THREE.PlaneGeometry(1.2,0.3), new THREE.MeshBasicMaterial({map:tex,transparent:true}));
  labelMesh.position.set(x,1.4,z);
  scene.add(labelMesh);

  interactables.push({mesh:table, type, id:interactables.length});
}

createTable(-4, -6, 'BLACKJACK', 'blackjack');
createTable(0, -6, 'ROULETTE', 'roulette');
createTable(4, -6, 'SLOTS', 'slots');

// Decorative columns
for(let i=-3;i<=3;i++){
  const col = new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,3), new THREE.MeshStandardMaterial({color:0x111827}));
  col.position.set(i*6,1.6,-12);
  scene.add(col);
}

// ----- Controls: PointerLock first-person -----
const controls = new PointerLockControls(camera, renderer.domElement);

const blocker = document.createElement('div');
blocker.style.position='absolute';blocker.style.top=0;blocker.style.left=0;blocker.style.width='100%';blocker.style.height='100%';
blocker.style.zIndex=5;blocker.style.display='none';
container.appendChild(blocker);

renderer.domElement.addEventListener('click', ()=>{
  controls.lock();
});
controls.addEventListener('lock', ()=>{document.getElementById('crosshair').style.display='block';});
controls.addEventListener('unlock', ()=>{document.getElementById('crosshair').style.display='none';});

// simple movement
const move = {forward:false,back:false,left:false,right:false,jump:false};
let velocity = new THREE.Vector3();
let canJump=false;

document.addEventListener('keydown', (e)=>{
  if(e.code==='KeyW') move.forward=true;
  if(e.code==='KeyS') move.back=true;
  if(e.code==='KeyA') move.left=true;
  if(e.code==='KeyD') move.right=true;
  if(e.code==='Space' && canJump){ velocity.y += 5; canJump=false; }
});
document.addEventListener('keyup', (e)=>{
  if(e.code==='KeyW') move.forward=false;
  if(e.code==='KeyS') move.back=false;
  if(e.code==='KeyA') move.left=false;
  if(e.code==='KeyD') move.right=false;
});

// Raycast for interactions
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

renderer.domElement.addEventListener('click', (ev)=>{
  if(!controls.isLocked) return;
  // ray from camera center forward
  raycaster.setFromCamera({x:0,y:0}, camera);
  const hits = raycaster.intersectObjects(interactables.map(i=>i.mesh));
  if(hits.length>0){
    const hit = hits[0].object;
    const item = interactables.find(x=>x.mesh===hit);
    if(item) openGameUI(item.type);
  }
});

// ----- Basic game state -----
let balance = 1000; // euros
const balanceEl = document.getElementById('balance');
function setBalance(v){ balance = v; balanceEl.textContent = Math.max(0, Math.round(balance)); }
setBalance(balance);

// UI Modal
const uiModal = document.getElementById('uiModal');
let currentGame = null;

function openGameUI(type){
  currentGame = type; uiModal.innerHTML=''; uiModal.style.display='block';
  if(type==='blackjack') renderBlackjackUI();
  else if(type==='roulette') renderRouletteUI();
  else if(type==='slots') renderSlotsUI();
}

function closeUI(){ uiModal.style.display='none'; currentGame=null; }

// Close on Escape
document.addEventListener('keydown', (e)=>{ if(e.key==='e' || e.key==='E' || e.key==='Escape'){ closeUI(); } });

// ----- BLACKJACK Implementation (basic, single-player vs dealer) -----
function renderBlackjackUI(){
  uiModal.innerHTML = `<div class="gameUI"><h2>Blackjack</h2>
    <div class="row"><label>Apuesta: <input id="bjBet" type="number" value="10" min="1"></label>
    <button id="bjStart">Iniciar</button></div>
    <div id="bjArea" style="margin-top:10px"></div>
    <div id="bjLog" style="margin-top:8px;color:var(--muted)"></div>
  </div>`;

  const bjArea = document.getElementById('bjArea');
  const bjLog = document.getElementById('bjLog');
  let deck=null, playerHand=[], dealerHand=[], bet=0, finished=false;

  function makeDeck(){
    const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const suits = ['â™ ','â™¥','â™¦','â™£'];
    const d=[]; for(const s of suits) for(const v of vals) d.push({v,s});
    // shuffle
    for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]]}
    return d;
  }
  function valOf(card){
    if(card.v==='A') return 11;
    if(['J','Q','K'].includes(card.v)) return 10;
    return parseInt(card.v);
  }
  function score(hand){
    let sum=0, aces=0; for(const c of hand){ if(c.v==='A') aces++; sum += valOf(c); }
    while(sum>21 && aces>0){ sum-=10; aces--; }
    return sum;
  }
  function renderHands(){
    bjArea.innerHTML = `<div>Jugador: ${handToStr(playerHand)} (${score(playerHand)})</div><div>Dealer: ${handToStr(dealerHand)} (${finished?score(dealerHand):'?'})</div>`;
  }
  function handToStr(h){ return h.map(c=>c.v+c.s).join(' ');
  }
  function log(s){ bjLog.textContent = s; }

  document.getElementById('bjStart').onclick = ()=>{
    bet = Number(document.getElementById('bjBet').value) || 0;
    if(bet<=0 || bet>balance){ log('Apuesta invÃ¡lida.'); return; }
    deck = makeDeck(); playerHand=[]; dealerHand=[]; finished=false;
    // deal
    playerHand.push(deck.pop()); dealerHand.push(deck.pop()); playerHand.push(deck.pop()); dealerHand.push(deck.pop());
    setBalance(balance - bet);
    renderHands(); log('Tu turno.');
    // add buttons hit/stand
    bjArea.innerHTML += `<div style="margin-top:8px"><button id="hitBtn">Pedir</button><button id="standBtn">Plantarse</button></div>`;
    document.getElementById('hitBtn').onclick = ()=>{ playerHand.push(deck.pop()); renderHands(); const sc=score(playerHand); if(sc>21){ finishRound(); }};
    document.getElementById('standBtn').onclick = ()=>{ dealerPlay(); };
  };
  function dealerPlay(){
    while(score(dealerHand)<17) dealerHand.push(deck.pop()); finished=true; renderHands(); finishRound();
  }
  function finishRound(){
    finished=true; renderHands(); const p=score(playerHand), d=score(dealerHand);
    let res='Empate'; if(p>21){ res='Pierdes'; }
    else if(d>21 || p>d){ res='Ganas'; setBalance(balance + bet*2); }
    else if(p===d){ setBalance(balance + bet); }
    else { res='Pierdes'; }
    log(`Resultado: ${res} â€” Jugador ${p} vs Dealer ${d}`);
  }
}

// ----- ROULETTE Implementation (simple european 0-36) -----
function renderRouletteUI(){
  uiModal.innerHTML = `<div class="gameUI"><h2>Ruleta</h2>
    <div class="row"><label>Apuesta (â‚¬): <input id="rBet" type="number" value="10" min="1"></label>
    <select id="rChoice"><option value="number">NÃºmero (paga 35x)</option><option value="red">Rojo (2x)</option><option value="black">Negro (2x)</option><option value="even">Par (2x)</option><option value="odd">Impar (2x)</option></select>
    <input id="rNumber" type="number" min="0" max="36" value="7" style="width:70px"></div>
    <div style="margin-top:8px"><button id="rSpin">Girar</button></div>
    <div id="rLog" style="margin-top:8px;color:var(--muted)"></div>
  </div>`;

  const rLog = document.getElementById('rLog');
  document.getElementById('rSpin').onclick = ()=>{
    const bet = Number(document.getElementById('rBet').value)||0;
    if(bet<=0 || bet>balance){ rLog.textContent='Apuesta invÃ¡lida'; return; }
    setBalance(balance - bet);
    const choice = document.getElementById('rChoice').value;
    const num = Number(document.getElementById('rNumber').value)||0;
    // spin animation (visual omitted) -> choose random 0..36
    const result = Math.floor(Math.random()*37);
    let color = isRed(result)?'red':'black';
    let win=false; let payout=0;
    if(choice==='number' && result===num){ win=true; payout=bet*35; }
    if(choice==='red' && color==='red'){ win=true; payout=bet*2; }
    if(choice==='black' && color==='black'){ win=true; payout=bet*2; }
    if(choice==='even' && result!==0 && result%2===0){ win=true; payout=bet*2; }
    if(choice==='odd' && result%2===1){ win=true; payout=bet*2; }
    if(win){ setBalance(balance + payout); rLog.textContent = `Sale ${result} (${color}) â€” Â¡Ganas ${payout}â‚¬!`; }
    else { rLog.textContent = `Sale ${result} (${color}) â€” Pierdes ${bet}â‚¬`; }
  };
}
function isRed(n){
  // standard roulette reds
  const reds = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
  return reds.has(n);
}

// ----- SLOTS Implementation (3 reels, simple icons) -----
function renderSlotsUI(){
  uiModal.innerHTML = `<div class="gameUI"><h2>Tragaperras</h2>
    <div class="row"><label>Apuesta: <input id="sBet" type="number" value="5" min="1"></label>
    <button id="sSpin">Girar</button></div>
    <div id="sReels" style="margin-top:10px;font-size:28px;letter-spacing:12px"></div>
    <div id="sLog" style="margin-top:8px;color:var(--muted)"></div>
  </div>`;
  const icons = ['ðŸ’','ðŸ””','â­','7','ðŸ‹','ðŸŠ'];
  const reelsEl = document.getElementById('sReels');
  const sLog = document.getElementById('sLog');
  function show(reels){ reelsEl.textContent = reels.join(' '); }
  show(['â€¢','â€¢','â€¢']);
  document.getElementById('sSpin').onclick = ()=>{
    const bet = Number(document.getElementById('sBet').value)||0; if(bet<=0||bet>balance){ sLog.textContent='Apuesta invÃ¡lida'; return; }
    setBalance(balance - bet);
    // animate simple
    let spins = [30,40,50]; const result = [];
    let t=0; const interval = setInterval(()=>{
      t++; for(let r=0;r<3;r++){ const idx = Math.floor(Math.random()*icons.length); result[r]=icons[idx]; }
      show(result);
      if(t>spins[2]){ clearInterval(interval); compute(); }
    },40);
    function compute(){ show(result); // simple payouts
      if(result[0]===result[1] && result[1]===result[2]){ let pay = bet*10; setBalance(balance + pay); sLog.textContent=`Â¡Jackpot! Tres ${result[0]} â€” Ganaste ${pay}â‚¬`; }
      else if(result[0]===result[1] || result[1]===result[2] || result[0]===result[2]){ let pay = bet*2; setBalance(balance + pay); sLog.textContent=`Dos iguales â€” Ganaste ${pay}â‚¬`; }
      else { sLog.textContent=`No hay coincidencias â€” Pierdes ${bet}â‚¬`; }
    }
  };
}

// ----- Animation loop -----
const clock = new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  // movement physics
  const speed = 6.0;
  velocity.x -= velocity.x * 10.0 * dt;
  velocity.z -= velocity.z * 10.0 * dt;
  velocity.y -= 9.8 * dt; // gravity

  if(move.forward) velocity.z -= speed * dt;
  if(move.back) velocity.z += speed * dt;
  if(move.left) velocity.x -= speed * dt;
  if(move.right) velocity.x += speed * dt;

  controls.moveRight(-velocity.x * dt);
  controls.moveForward(-velocity.z * dt);
  camera.position.y += velocity.y * dt;
  if(camera.position.y < 1.6){ velocity.y = 0; camera.position.y = 1.6; canJump = true; }

  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', ()=>{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

</script>
</body>
</html>
