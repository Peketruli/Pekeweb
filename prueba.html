<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Casino 3D â€” BÃ¡sico</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html, body {height:100%; margin:0; background:#030612; color:#fff; font-family:Arial, Helvetica, sans-serif; overflow:hidden;}
#wrap {position:relative; width:100%; height:100vh;}
canvas {display:block;}
.hud {position:absolute; top:12px; right:12px; max-width:300px; z-index:10;}
.panel {background:rgba(0,0,0,0.7); padding:10px; border-radius:8px; margin-bottom:10px;}
.info-row {display:flex; justify-content:space-between; margin:4px 0;}
#prompt {position:absolute; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); padding:6px 10px; border-radius:6px; display:none; z-index:20;}
#interaction-panel {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:350px; background:rgba(8,10,12,0.95); padding:16px; border-radius:10px; display:none; z-index:30;}
.btn {background:#d95d00; color:white; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; margin-top:6px;}
</style>
</head>
<body>
<div id="wrap">
  <div class="hud">
    <div class="panel">
      <div class="info-row"><span>Saldo</span><strong id="balance">1000</strong></div>
      <div class="info-row"><span>Apuesta</span><strong id="bet">0</strong></div>
    </div>
  </div>
  <div id="prompt">[E] Interactuar</div>
  <div id="interaction-panel">
    <h3 id="panel-title">Juego</h3>
    <div id="panel-content"></div>
    <button class="btn" onclick="closePanel()">Cerrar</button>
  </div>
</div>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script>
// ---------- CONFIG / HUD ----------
const wrap = document.getElementById('wrap');
const balanceEl = document.getElementById('balance');
const betEl = document.getElementById('bet');
const prompt = document.getElementById('prompt');
const panel = document.getElementById('interaction-panel');
const panelTitle = document.getElementById('panel-title');
const panelContent = document.getElementById('panel-content');

let balance = 1000;
let currentBet = 0;
function updateHUD() {
    if (balanceEl) balanceEl.textContent = balance;
    if (betEl) betEl.textContent = currentBet;
}
function addLog(msg) {
    const logs = document.getElementById('log');
    if (logs) {
        const d = document.createElement('div'); d.className = 'log-entry'; d.textContent = msg; logs.prepend(d);
    } else console.log(msg);
}
updateHUD();

// ---------- THREE SCENE ----------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x041018);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(wrap.clientWidth, wrap.clientHeight);
wrap.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(72, wrap.clientWidth / wrap.clientHeight, 0.1, 2000);
camera.position.set(0, 1.7, 12);

// Lights
const amb = new THREE.AmbientLight(0xffffff, 0.55); scene.add(amb);
const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(8, 20, 6); scene.add(dir);

// Floor
const floor = new THREE.Mesh(new THREE.PlaneGeometry(80, 80), new THREE.MeshStandardMaterial({ color: 0x091217, roughness: 0.95 }));
floor.rotation.x = -Math.PI / 2; scene.add(floor);

// ---------- PLAYER / CONTROLS ----------
let playerPos = new THREE.Vector3(0, 0, 12);
let yaw = 0, pitch = 0;
const keys = { w: false, a: false, s: false, d: false, ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false };
window.addEventListener('keydown', e => { if (e.key in keys) keys[e.key] = true; });
window.addEventListener('keyup', e => { if (e.key in keys) keys[e.key] = false; });

const speed = 5;
function computeDelta(dt) {
    const rotSpeed = 1.5 * dt;
    if (keys.ArrowLeft) yaw += rotSpeed; if (keys.ArrowRight) yaw -= rotSpeed;
    if (keys.ArrowUp) pitch += rotSpeed * 0.5; if (keys.ArrowDown) pitch -= rotSpeed * 0.5;
    pitch = Math.max(-1.2, Math.min(1.2, pitch));
    const e = new THREE.Euler(pitch, yaw, 0, 'YXZ');
    const q = new THREE.Quaternion().setFromEuler(e);
    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(q); forward.y = 0; forward.normalize();
    const right = new THREE.Vector3(1, 0, 0).applyQuaternion(q); right.y = 0; right.normalize();

    let mf = 0, mr = 0;
    if (keys.w) mf += 1; if (keys.s) mf -= 1; if (keys.a) mr -= 1; if (keys.d) mr += 1;
    const len = Math.hypot(mf, mr); if (len > 0) { mf /= len; mr /= len; }
    const delta = new THREE.Vector3();
    delta.addScaledVector(forward, mf * speed * dt);
    delta.addScaledVector(right, mr * speed * dt);
    return delta;
}

// ---------- ZONAS (Ruleta, Blackjack, Slots) ----------
const zones = [
    { x: 0, z: 0, label: 'Ruleta', action: openRouletteUI },
    { x: -10, z: -5, label: 'Blackjack', action: openBlackjackUI },
    { x: 10, z: -5, label: 'Tragaperras', action: openSlotsUI }
];
let currentZone = null;

function detectZones() {
    currentZone = null;
    for (const z of zones) {
        const dx = playerPos.x - z.x, dz = playerPos.z - z.z;
        if (Math.hypot(dx, dz) < 3) {
            currentZone = z;
            prompt.style.display = 'block';
            prompt.textContent = '[E] ' + z.label;
            return;
        }
    }
    prompt.style.display = 'none';
}
document.addEventListener('keydown', e => {
    if (e.key.toLowerCase() === 'e' && currentZone) currentZone.action();
    if (e.key === 'Escape') panel.style.display = 'none';
});

// ---------- UTIL: canvas textures ----------
function createNumberCanvasLabel(text, size = 256, bg = '#111', fg = '#fff') {
    const c = document.createElement('canvas'); c.width = c.height = size;
    const ctx = c.getContext('2d');
    ctx.fillStyle = bg; ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = fg; ctx.font = `${Math.floor(size * 0.18)}px sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(text, size / 2, size / 2);
    return c;
}
function createCardCanvas(rank, suit, sizeW = 256, sizeH = 360) {
    const c = document.createElement('canvas'); c.width = sizeW; c.height = sizeH;
    const ctx = c.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, sizeW, sizeH);
    ctx.fillStyle = '#0b5c0a'; ctx.fillRect(6, 6, sizeW - 12, sizeH - 12);
    ctx.fillStyle = '#e9e9e9'; ctx.fillRect(12, 12, sizeW - 24, sizeH - 24);
    ctx.fillStyle = '#000'; ctx.font = '28px sans-serif'; ctx.textAlign = 'left'; ctx.fillText(rank + suit, 18, 36);
    ctx.font = '72px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(suit, sizeW / 2, sizeH / 2 + 10);
    ctx.font = '20px sans-serif'; ctx.textAlign = 'right'; ctx.fillText(rank, sizeW - 18, sizeH - 18);
    return c;
}

// ---------- RULETE ----------
const wheelRadius = 3.8;
const pockets = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
const anglePerPocket = (Math.PI * 2) / pockets.length;

function createWheelCanvas(size = 1024) {
    const c = document.createElement('canvas'); c.width = c.height = size;
    const ctx = c.getContext('2d');
    const cx = size / 2, cy = size / 2, r = size * 0.45;
    ctx.fillStyle = '#072b22'; ctx.fillRect(0, 0, size, size);
    for (let i = 0; i < pockets.length; i++) {
        const a0 = i * anglePerPocket - Math.PI / 2;
        const a1 = (i + 1) * anglePerPocket - Math.PI / 2;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, a0, a1); ctx.closePath();
        const col = pockets[i] === 0 ? '#1b8b41' : (i % 2 ? '#b71c1c' : '#000000');
        ctx.fillStyle = col; ctx.fill();
        const mid = a0 + (a1 - a0) / 2;
        ctx.save(); ctx.translate(cx + Math.cos(mid) * r * 0.66, cy + Math.sin(mid) * r * 0.66); ctx.rotate(mid + Math.PI / 2);
        ctx.fillStyle = '#fff'; ctx.font = `${Math.floor(size * 0.04)}px sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(pockets[i], 0, 0); ctx.restore();
    }
    ctx.beginPath(); ctx.fillStyle = '#111'; ctx.arc(cx, cy, r * 0.45, 0, Math.PI * 2); ctx.fill();
    return c;
}
const wheelTexture = new THREE.CanvasTexture(createWheelCanvas(1024));
wheelTexture.needsUpdate = true;
const wheelMesh = new THREE.Mesh(
    new THREE.CylinderGeometry(wheelRadius, wheelRadius, 1.2, 128),
    new THREE.MeshStandardMaterial({ map: wheelTexture })
);
wheelMesh.rotation.x = Math.PI;
wheelMesh.position.set(0, 0.35, 0);
scene.add(wheelMesh);

// rim and ball
const rimGeom = new THREE.RingGeometry(wheelRadius + 0.05, wheelRadius + 0.15, 128);
const rimMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
const rimMesh = new THREE.Mesh(rimGeom, rimMat);
rimMesh.rotation.x = -Math.PI / 2; rimMesh.position.y = 0.36; scene.add(rimMesh);
const ballMesh = new THREE.Mesh(new THREE.SphereGeometry(0.18, 16, 16), new THREE.MeshStandardMaterial({ color: 0xffffff }));
ballMesh.position.y = 1.2; scene.add(ballMesh);
function isPocketRed(n) { if (n === 0) return false; const idx = pockets.indexOf(n); return (idx % 2 === 0); }

// ---------- RULETE UI ----------
function openRouletteUI() {
    panelTitle.textContent = 'Ruleta';
    panel.style.display = 'block';
    panelContent.innerHTML = `
    <div style="font-size:13px;margin-bottom:8px">Tipo de apuesta:</div>
    <select id="rType" style="width:100%;margin-bottom:8px">
      <option value="number">NÃºmero</option>
      <option value="color">Color</option>
      <option value="par">Par/Impar</option>
      <option value="dozen">Docena</option>
      <option value="column">Columna</option>
      <option value="highlow">Alto/Bajo</option>
    </select>
    <div id="rParams" style="margin-bottom:8px">
      <input id="rNumber" type="number" min="0" max="36" placeholder="NÃºmero (ej: 7)" style="width:100%;display:block"/>
    </div>
    <label>$ A apostar:</label><br>
    <input id="rouletteBet" type="number" value="10" style="width:100%;margin-top:6px"/><br>
    <button class="btn" id="rSpin" style="width:100%;margin-top:10px">Girar Ruleta</button>
    <div style="font-size:12px;margin-top:8px">NÃºmero=35x Â· Docena/Columna=3x Â· Par/Color/HighLow=2x</div>
  `;
    const rType = document.getElementById('rType');
    const rParams = document.getElementById('rParams');
    rType.addEventListener('change', () => {
        const t = rType.value;
        if (t === 'number') rParams.innerHTML = `<input id="rNumber" type="number" min="0" max="36" placeholder="NÃºmero (ej: 7)" style="width:100%;display:block"/>`;
        else if (t === 'color') rParams.innerHTML = `<select id="rColor" style="width:100%"><option value="red">Rojo</option><option value="black">Negro</option></select>`;
        else if (t === 'par') rParams.innerHTML = `<select id="rPar" style="width:100%"><option value="even">Par</option><option value="odd">Impar</option></select>`;
        else if (t === 'dozen') rParams.innerHTML = `<select id="rDozen" style="width:100%"><option value="1">1 (1-12)</option><option value="2">2 (13-24)</option><option value="3">3 (25-36)</option></select>`;
        else if (t === 'column') rParams.innerHTML = `<select id="rColumn" style="width:100%"><option value="1">Columna 1</option><option value="2">Columna 2</option><option value="3">Columna 3</option></select>`;
        else if (t === 'highlow') rParams.innerHTML = `<select id="rHighLow" style="width:100%"><option value="low">1-18</option><option value="high">19-36</option></select>`;
    });
    document.getElementById('rSpin').addEventListener('click', () => {
        const type = document.getElementById('rType').value;
        const betAmt = parseInt(document.getElementById('rouletteBet').value) || 0;
        if (betAmt <= 0) { addLog('Ruleta: apuesta invÃ¡lida'); return; }
        let betObj = { type: type, amount: betAmt };
        if (type === 'number') { betObj.value = parseInt(document.getElementById('rNumber').value); if (isNaN(betObj.value) || betObj.value < 0 || betObj.value > 36) { addLog('NÃºmero invÃ¡lido'); return; } }
        else if (type === 'color') { betObj.value = document.getElementById('rColor').value; }
        else if (type === 'par') { betObj.value = document.getElementById('rPar').value; }
        else if (type === 'dozen') { betObj.value = parseInt(document.getElementById('rDozen').value); }
        else if (type === 'column') { betObj.value = parseInt(document.getElementById('rColumn').value); }
        else if (type === 'highlow') { betObj.value = document.getElementById('rHighLow').value; }
        panel.style.display = 'none';
        spinRouletteWithBet(betObj);
    });
}

// ---------- RULETA: SPIN + PAGO ----------
function spinRouletteWithBet(bet) {
    if (bet.amount > balance) { addLog('Saldo insuficiente'); return; }
    balance -= bet.amount; updateHUD();

    // Girar ruleta
    const spins = Math.floor(Math.random() * pockets.length); // nÃºmero de pocket
    let targetAngle = spins * anglePerPocket + Math.PI * 10 + Math.random() * anglePerPocket;
    let start = performance.now(), duration = 3000, initial = wheelMesh.rotation.y;

    function animateWheel(t) {
        let elapsed = t - start;
        let progress = Math.min(1, elapsed / duration);
        let ease = 1 - Math.pow(1 - progress, 3);
        wheelMesh.rotation.y = initial + (targetAngle - initial) * ease;
        const ballAngle = initial + (targetAngle - initial) * (1 - ease); // la bola gira al revÃ©s
        ballMesh.position.x = Math.cos(ballAngle) * (wheelRadius + 0.25);
        ballMesh.position.z = Math.sin(ballAngle) * (wheelRadius + 0.25);
        if (progress < 1) requestAnimationFrame(animateWheel);
        else {
            const pocketIndex = Math.floor((wheelMesh.rotation.y % (Math.PI * 2)) / anglePerPocket + pockets.length) % pockets.length;
            const number = pockets[pocketIndex];
            addLog(`La ruleta cae en ${number} ${isPocketRed(number) ? '(Rojo)' : '(Negro)'}`);
            const payout = payoutForBet(bet, number);
            balance += payout; updateHUD();
            if (payout > 0) addLog(`Ganaste $${payout}!`);
        }
    }
    requestAnimationFrame(animateWheel);
}

function payoutForBet(bet, result) {
    if (bet.type === 'number') return bet.value === result ? bet.amount * 35 : 0;
    if (bet.type === 'color') return (isPocketRed(result) && bet.value === 'red' || !isPocketRed(result) && bet.value === 'black') ? bet.amount * 2 : 0;
    if (bet.type === 'par') return ((result !== 0) && ((result % 2 === 0 && bet.value === 'even') || (result % 2 !== 0 && bet.value === 'odd'))) ? bet.amount * 2 : 0;
    if (bet.type === 'dozen') {
        const dozen = Math.ceil(result / 12); return dozen === bet.value ? bet.amount * 3 : 0;
    }
    if (bet.type === 'column') {
        const col = ((result - 1) % 3) + 1; return col === bet.value ? bet.amount * 3 : 0;
    }
    if (bet.type === 'highlow') return ((bet.value === 'low' && result >= 1 && result <= 18) || (bet.value === 'high' && result >= 19 && result <= 36)) ? bet.amount * 2 : 0;
    return 0;
}

// ---------- TRAGAPERRAS ----------
function openSlotsUI() {
    panelTitle.textContent = 'Tragaperras';
    panel.style.display = 'block';
    panelContent.innerHTML = `
        <label>$ A apostar:</label><br>
        <input id="slotBet" type="number" value="10" style="width:100%;margin-top:6px"/><br>
        <button class="btn" id="slotSpin" style="width:100%;margin-top:10px">Girar Rodillos</button>
        <div style="font-size:12px;margin-top:8px">3 sÃ­mbolos iguales = 5x Â· 2 iguales = 2x</div>
    `;
    document.getElementById('slotSpin').addEventListener('click', () => {
        const betAmt = parseInt(document.getElementById('slotBet').value) || 0;
        if (betAmt > balance) { addLog('Saldo insuficiente'); return; }
        balance -= betAmt; updateHUD();
        panel.style.display = 'none';
        spinSlots(betAmt);
    });
}

function spinSlots(bet) {
    const symbols = ['ðŸ’','ðŸ‹','ðŸ””','â­','ðŸ’Ž'];
    const result = [symbols[Math.floor(Math.random()*symbols.length)], symbols[Math.floor(Math.random()*symbols.length)], symbols[Math.floor(Math.random()*symbols.length)]];
    addLog(`Resultado: ${result.join(' | ')}`);
    const counts = {}; result.forEach(s => counts[s] = (counts[s]||0)+1);
    let payout = 0;
    if (Object.values(counts).includes(3)) payout = bet*5;
    else if (Object.values(counts).includes(2)) payout = bet*2;
    balance += payout; updateHUD();
    if (payout > 0) addLog(`Ganaste $${payout}!`);
}

// ---------- BLACKJACK ----------
function openBlackjackUI() {
    panelTitle.textContent = 'Blackjack';
    panel.style.display = 'block';
    panelContent.innerHTML = `
        <label>$ A apostar:</label><br>
        <input id="bjBet" type="number" value="10" style="width:100%;margin-top:6px"/><br>
        <button class="btn" id="bjStart" style="width:100%;margin-top:10px">Iniciar Mano</button>
        <div id="bjMsg" style="margin-top:8px;font-size:13px"></div>
    `;
    document.getElementById('bjStart').addEventListener('click', () => {
        const betAmt = parseInt(document.getElementById('bjBet').value) || 0;
        if (betAmt > balance) { addLog('Saldo insuficiente'); return; }
        balance -= betAmt; updateHUD();
        panelContent.innerHTML += '<div id="bjCards" style="margin-top:8px"></div><button id="bjHit" class="btn" style="width:48%;margin-top:6px">Pedir</button><button id="bjStand" class="btn" style="width:48%;margin-left:4%;margin-top:6px">Plantarse</button>';
        startBlackjack(betAmt);
    });
}

function startBlackjack(bet) {
    const deck = [];
    const suits = ['â™ ','â™¥','â™¦','â™£']; const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    suits.forEach(s => ranks.forEach(r => deck.push({r,s})));
    shuffle(deck);

    const player = [deck.pop(), deck.pop()];
    const dealer = [deck.pop(), deck.pop()];

    function handValue(hand) {
        let val = 0, aces = 0;
        hand.forEach(c => { if (c.r==='A') aces++; else if (['J','Q','K'].includes(c.r)) val+=10; else val+=parseInt(c.r); });
        for (let i=0;i<aces;i++) val += (val+11<=21?11:1);
        return val;
    }

    function renderHands() {
        const bjCards = document.getElementById('bjCards');
        bjCards.innerHTML = 'Tus cartas: ' + player.map(c=>c.r+c.s).join(' | ') + '<br>Dealer: ' + dealer.map((c,i)=>i===0?c.r+c.s:'??').join(' | ');
    }

    renderHands();

    document.getElementById('bjHit').onclick = () => {
        player.push(deck.pop());
        renderHands();
        const val = handValue(player);
        if (val > 21) endHand('dealer');
    };
    document.getElementById('bjStand').onclick = () => {
        let dVal = handValue(dealer);
        while(dVal<17){ dealer.push(deck.pop()); dVal=handValue(dealer); }
        const pVal = handValue(player);
        if (dVal>21 || pVal>dVal) endHand('player');
        else if (pVal===dVal) endHand('tie');
        else endHand('dealer');
    };

    function endHand(winner) {
        let msg='';
        if (winner==='player'){ balance += bet*2; msg='Ganaste!'; }
        else if (winner==='tie'){ balance += bet; msg='Empate'; }
        else msg='Perdiste';
        updateHUD(); document.getElementById('bjMsg').textContent=msg;
        document.getElementById('bjHit').disabled=true; document.getElementById('bjStand').disabled=true;
    }

    function shuffle(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } }
}

// ---------- RENDER LOOP ----------
let last = performance.now();
function animate(now){
    const dt = (now-last)/1000; last=now;
    playerPos.add(computeDelta(dt));
    camera.position.copy(playerPos).add(new THREE.Vector3(0,1.7,0));
    camera.lookAt(playerPos.clone().add(new THREE.Vector3(Math.sin(-yaw), Math.sin(pitch), -Math.cos(yaw))));
    detectZones();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

window.addEventListener('resize',()=>{ camera.aspect=wrap.clientWidth/wrap.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(wrap.clientWidth,wrap.clientHeight); });

</script>
</body>
</html>
