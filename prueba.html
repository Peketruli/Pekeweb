<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';

////////////////////////////////////////////////////////////////
// ESCENA Y CÃMARA
////////////////////////////////////////////////////////////////
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f1a);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 5);
camera.rotation.order = 'YXZ';

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.getElementById('container').appendChild(renderer.domElement);

////////////////////////////////////////////////////////////////
// LUCES
////////////////////////////////////////////////////////////////
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
scene.add(hemi);
const ambient = new THREE.AmbientLight(0xffffff, 0.3);
scene.add(ambient);

////////////////////////////////////////////////////////////////
// LOADER DE TEXTURAS
////////////////////////////////////////////////////////////////
const loader = new THREE.TextureLoader();

// Textura de terciopelo (tapete) â€” textura PBR tela Velvet
const velvetTex = loader.load('https://aitextured.com/downloads/seamless-3d-texture-pbr-8k-soft-velvety-plush-fabric-surface.png');  
velvetTex.wrapS = velvetTex.wrapT = THREE.RepeatWrapping;
velvetTex.repeat.set(2, 1);

// Textura de tela para ruleta o otras partes
const fabricTex = loader.load('https://aitextured.com/downloads/high-quality-seamless-fabric-texture-x2.png');
fabricTex.wrapS = fabricTex.wrapT = THREE.RepeatWrapping;
fabricTex.repeat.set(3, 3);

// Textura de madera para suelo
const woodTex = loader.load('https://threejs.org/examples/textures/hardwood2_diffuse.jpg');
woodTex.wrapS = woodTex.wrapT = THREE.RepeatWrapping;
woodTex.repeat.set(4, 4);

////////////////////////////////////////////////////////////////
// SUELO Y PAREDES
////////////////////////////////////////////////////////////////
const floorMat = new THREE.MeshStandardMaterial({
  map: woodTex,
  roughness: 0.8,
});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), floorMat);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

const wallMat = new THREE.MeshStandardMaterial({
  map: fabricTex,
  roughness: 0.9,
});
function makeWall(x, z, rotY = 0) {
  const wall = new THREE.Mesh(new THREE.BoxGeometry(30, 6, 0.2), wallMat);
  wall.position.set(x, 3, z);
  wall.rotation.y = rotY;
  scene.add(wall);
}
makeWall(0, -15);          // pared trasera
makeWall(0, 15, Math.PI);  // pared delantera
makeWall(-15, 0, Math.PI / 2); // izquierda
makeWall(15, 0, -Math.PI / 2); // derecha

////////////////////////////////////////////////////////////////
// MESH INTERACTUABLES (Mesas, Ruleta, Slots, NPC)
////////////////////////////////////////////////////////////////
const interact = [];
function addObject(mesh, type) {
  mesh.userData.type = type;
  interact.push(mesh);
  scene.add(mesh);
}

// Mesa Blackjack â€” tapete velvet
const bjMat = new THREE.MeshStandardMaterial({
  map: velvetTex,
  roughness: 0.6,
  metalness: 0.1
});
const bjTable = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.6, 0.3, 32), bjMat);
bjTable.position.set(-4, 0.3, 0);
addObject(bjTable, 'blackjack');

// Ruleta â€” base de tela / madera
const ruletaMat = new THREE.MeshStandardMaterial({
  map: fabricTex,
  roughness: 0.7,
  metalness: 0.2
});
const ruleta = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 0.4, 64), ruletaMat);
ruleta.position.set(0, 0.2, 0);
addObject(ruleta, 'roulette');

// Tragaperras â€” mÃ¡quina con textura tambiÃ©n de tela / metal
const slotMat = new THREE.MeshStandardMaterial({
  map: fabricTex,
  roughness: 0.5,
  metalness: 0.4
});
const slot = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), slotMat);
slot.position.set(4, 1, 0);
addObject(slot, 'slots');

// NPC
const npc = new THREE.Mesh(
  new THREE.CylinderGeometry(0.4, 0.4, 1.6),
  new THREE.MeshStandardMaterial({ color: 0x999999 })
);
npc.position.set(0, 1, 5);
addObject(npc, 'npc');

////////////////////////////////////////////////////////////////
// ILUMINACIÃ“N LOCAL (sobre mesas)
////////////////////////////////////////////////////////////////
function addTableLight(x, z) {
  const light = new THREE.PointLight(0xffddaa, 0.8, 6);
  light.position.set(x, 3, z);
  scene.add(light);
}
addTableLight(-4, 0); // luz sobre blackjack
addTableLight(0, 0);  // luz sobre ruleta
addTableLight(4, 0);  // luz sobre slot

////////////////////////////////////////////////////////////////
// CONTROLES DE MOVIMIENTO
////////////////////////////////////////////////////////////////
const keys = {};
document.addEventListener('keydown', e => keys[e.code] = true);
document.addEventListener('keyup', e => keys[e.code] = false);

let balance = 1000;
const balanceEl = document.getElementById('balance');
function setBal(v) { balance = Math.round(v); balanceEl.textContent = balance; }
setBal(balance);

let yaw = 0, pitch = 0;
const yawSpeed = 1.8, pitchSpeed = 1.2, pitchLimit = Math.PI/2 - 0.05;

function updateCameraRotation(dt) {
  if (keys['ArrowLeft']) yaw += yawSpeed * dt;
  if (keys['ArrowRight']) yaw -= yawSpeed * dt;
  if (keys['ArrowUp']) pitch += pitchSpeed * dt;
  if (keys['ArrowDown']) pitch -= pitchSpeed * dt;
  if (pitch > pitchLimit) pitch = pitchLimit;
  if (pitch < -pitchLimit) pitch = -pitchLimit;
  camera.rotation.y = yaw;
  camera.rotation.x = pitch;
}

function updateCameraPosition(dt) {
  const speed = 3.0;
  const forward = new THREE.Vector3();
  camera.getWorldDirection(forward);
  forward.y = 0;
  forward.normalize();
  const right = new THREE.Vector3();
  right.crossVectors(forward, camera.up).normalize();
  const move = new THREE.Vector3();
  if (keys['KeyW']) move.add(forward);
  if (keys['KeyS']) move.sub(forward);
  if (keys['KeyD']) move.add(right);
  if (keys['KeyA']) move.sub(right);
  move.multiplyScalar(speed * dt);
  camera.position.add(move);
}

////////////////////////////////////////////////////////////////
// RAYCAST PARA INTERACCIÃ“N
////////////////////////////////////////////////////////////////
const ray = new THREE.Raycaster();
let lookingAt = null;
function checkInteraction() {
  ray.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
  const hits = ray.intersectObjects(interact, false);
  if (hits.length === 0 || hits[0].distance > 4) {
    lookingAt = null;
    document.getElementById('npcMsg').style.display = 'none';
    return;
  }
  lookingAt = hits[0].object;
  if (lookingAt.userData.type === 'npc') {
    document.getElementById('npcMsg').style.display = 'block';
  } else {
    document.getElementById('npcMsg').style.display = 'none';
  }
}

////////////////////////////////////////////////////////////////
// LOGICA DE JUEGOS
function createDeck(){
  const vals=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const suits=['â™ ','â™¥','â™¦','â™£'];
  const d=[]; for(const s of suits) for(const v of vals) d.push({v,s});
  for(let i=d.length-1;i>0;i--){ const j=rand(0,i); [d[i],d[j]]=[d[j],d[i]]; }
  return d;
}
function cardValue(c){ if(c.v==='A') return 11; if(['J','Q','K'].includes(c.v)) return 10; return parseInt(c.v); }
function handScore(hand){ let sum=0, aces=0; for(const c of hand){ if(c.v==='A') aces++; sum+=cardValue(c); } while(sum>21 && aces>0){ sum-=10; aces--; } return sum; }

function renderBlackjackUI(){
  modal.innerHTML='';
  const el=document.createElement('div'); el.className='gameUI';
  el.innerHTML=`
    <h2>Blackjack</h2>
    <div>Saldo: <span id='bjBal'>${balance}</span> â‚¬</div>
    <label>Apuesta: <input id='bjBet' type='number' value='10' min='1' style='width:80px'></label>
    <div id='bjTable' style='margin-top:8px'></div>
    <div style='margin-top:8px'>
      <button id='bjDeal'>Repartir</button>
      <button id='bjHit' disabled>Pedir</button>
      <button id='bjStand' disabled>Plantarse</button>
      <button id='bjDouble' disabled>Doblar</button>
      <button id='bjSplit' disabled>Dividir</button>
      <button id='bjClose'>Cerrar</button>
    </div>
  `;
  modal.appendChild(el);

  const bjTable=el.querySelector('#bjTable');
  const bjBal=el.querySelector('#bjBal');
  const btnHit=el.querySelector('#bjHit');
  const btnStand=el.querySelector('#bjStand');
  const btnDouble=el.querySelector('#bjDouble');
  const btnSplit=el.querySelector('#bjSplit');

  let deck, player=[], player2=[], dealer=[], bet=0, inRound=false, splitMode=false;

  function updateTable(){
    let dealerDisplay = inRound ? dealer[0].v+dealer[0].s+' ?' : dealer.map(c=>c.v+c.s).join(' ');
    let playerDisplay = player.map(c=>c.v+c.s).join(' ');
    if(splitMode) playerDisplay += ` | ${player2.map(c=>c.v+c.s).join(' ')}`;
    bjTable.innerHTML = `<div>Jugador: ${playerDisplay} (${handScore(player)})</div>
                         <div>Dealer: ${dealerDisplay}</div>`;
    bjBal.textContent=balance;
  }

  function finishHand(h){
    const score=handScore(h);
    if(score>21) return 'Pierdes';
    while(handScore(dealer)<17) dealer.push(deck.pop());
    const dealerScore=handScore(dealer);
    if(dealerScore>21) return 'Ganas';
    if(score>dealerScore) return 'Ganas';
    if(score===dealerScore) return 'Empate';
    return 'Pierdes';
  }

  function endRound(){
    btnHit.disabled=true; btnStand.disabled=true; btnDouble.disabled=true; btnSplit.disabled=true;
    inRound=false;

    if(splitMode){
      const res1=finishHand(player);
      const res2=finishHand(player2);
      let payout=0;
      if(res1==='Ganas') payout+=bet*2; else if(res1==='Empate') payout+=bet;
      if(res2==='Ganas') payout+=bet*2; else if(res2==='Empate') payout+=bet;
      balance+=payout; setBal(balance);
      bjTable.innerHTML+=`<div>Resultado Mano 1: ${res1}</div><div>Resultado Mano 2: ${res2}</div><div>Total ganado: ${payout}â‚¬</div>`;
    } else {
      const res=finishHand(player);
      if(res==='Ganas') balance+=bet*2; else if(res==='Empate') balance+=bet;
      setBal(balance);
      bjTable.innerHTML+=`<div>Resultado: ${res}</div>`;
    }
  }

  el.querySelector('#bjDeal').onclick = ()=>{
    bet = Math.min(balance, Number(el.querySelector('#bjBet').value)||0);
    if(bet<=0){ alert('Apuesta invÃ¡lida'); return; }
    balance-=bet; setBal(balance);
    deck=createDeck();
    player=[deck.pop(),deck.pop()]; dealer=[deck.pop(),deck.pop()]; player2=[]; inRound=true; splitMode=false;

    btnHit.disabled=false; btnStand.disabled=false; btnDouble.disabled=false;
    btnSplit.disabled = (player[0].v!==player[1].v);
    updateTable();
  };

  btnHit.onclick = ()=>{
    if(!inRound) return;
    player.push(deck.pop());
    if(handScore(player)>21){ endRound(); }
    updateTable();
  };

  btnStand.onclick = ()=>{
    endRound();
    updateTable();
  };

  btnDouble.onclick = ()=>{
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    balance-=bet; bet*=2; setBal(balance);
    player.push(deck.pop());
    endRound();
    updateTable();
  };

  btnSplit.onclick = ()=>{
    if(player[0].v!==player[1].v){ alert('No se puede dividir'); return; }
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    balance-=bet; setBal(balance);
    player2.push(player.pop());
    player.push(deck.pop());
    player2.push(deck.pop());
    splitMode=true;
    btnSplit.disabled=true;
    updateTable();
  };

  el.querySelector('#bjClose').onclick = ()=>{ modal.style.display='none'; };
}

////////////////////////////////////////////////////////////////
// ROULETTE
////////////////////////////////////////////////////////////////
function isRed(n){ const reds=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]); return reds.has(n); }

function renderRouletteUI(){
  modal.innerHTML='';
  const el=document.createElement('div'); el.className='gameUI';
  el.innerHTML=`
    <h2>Ruleta</h2>
    <div>Saldo: <span id='rBal'>${balance}</span> â‚¬</div>
    <label>Apuesta: <input id='rBet' type='number' value='10' min='1' style='width:80px'></label>
    <label>Tipo: <select id='rType'><option value='number'>NÃºmero</option><option value='color'>Color</option><option value='par'>Par/Impar</option></select></label>
    <label id='rNumberWrap'><input id='rNumber' type='number' min='0' max='36' value='7' style='width:80px'></label>
    <label id='rColorWrap' style='display:none'><select id='rColor'><option value='red'>Rojo</option><option value='black'>Negro</option></select></label>
    <div style='margin-top:8px'><button id='rSpin'>Girar</button> <button id='rClose'>Cerrar</button></div>
    <div id='rOut' style='margin-top:8px'></div>
  `;
  modal.appendChild(el);

  const rBal=el.querySelector('#rBal');
  const rType=el.querySelector('#rType');
  const rNumberWrap=el.querySelector('#rNumberWrap');
  const rColorWrap=el.querySelector('#rColorWrap');
  const rOut=el.querySelector('#rOut');

  rType.onchange=()=>{
    rNumberWrap.style.display=rType.value==='number'?'inline-block':'none';
    rColorWrap.style.display=rType.value==='color'?'inline-block':'none';
  };

  el.querySelector('#rSpin').onclick=()=>{
    const bet=Math.min(balance, Number(el.querySelector('#rBet').value)||0);
    if(bet<=0){ alert('Apuesta invÃ¡lida'); return; }
    balance-=bet; setBal(balance); rBal.textContent=balance;
    const result=rand(0,36); const color=isRed(result)?'red':'black';
    let win=false, payout=0;
    if(rType.value==='number'){ const pick=Number(el.querySelector('#rNumber').value); if(pick===result){ win=true; payout=bet*35; }}
    else if(rType.value==='color'){ const pick=el.querySelector('#rColor').value; if(pick===color){ win=true; payout=bet*2; }}
    else if(rType.value==='par'){ const pick=el.querySelector('#rColor').value; if(result!==0 && ((pick==='red' && result%2===1)||(pick==='black' && result%2===0))){ win=true; payout=bet*2; }}
    rOut.innerHTML=`<div>Sale ${result} (${result===0?'green':color})</div>`;
    if(win){ balance+=payout; setBal(balance); rOut.innerHTML+=`<div>Â¡Ganas ${payout}â‚¬!</div>`; } else rOut.innerHTML+=`<div>Pierdes ${bet}â‚¬</div>`;
  };

  el.querySelector('#rClose').onclick=()=>{ modal.style.display='none'; };
}

////////////////////////////////////////////////////////////////
// SLOTS
////////////////////////////////////////////////////////////////
function renderSlotsUI(){
  modal.innerHTML='';
  const el=document.createElement('div'); el.className='gameUI';
  el.innerHTML=`
    <h2>Tragaperras</h2>
    <div>Saldo: <span id='sBal'>${balance}</span> â‚¬</div>
    <label>Apuesta: <input id='sBet' type='number' value='5' min='1' style='width:80px'></label>
    <div style='margin-top:8px'><div id='reels' style='font-size:40px'>â€¢ â€¢ â€¢</div></div>
    <div style='margin-top:8px'><button id='sSpin'>Girar</button> <button id='sClose'>Cerrar</button></div>
    <div id='sOut' style='margin-top:8px'></div>
  `;
  modal.appendChild(el);

  const sBal=el.querySelector('#sBal');
  const reels=el.querySelector('#reels');
  const sOut=el.querySelector('#sOut');
  const symbols=['ðŸ’','ðŸ””','7ï¸âƒ£','â­','ðŸ‹'];

  el.querySelector('#sSpin').onclick=()=>{
    const bet=Math.min(balance, Number(el.querySelector('#sBet').value)||0);
    if(bet<=0){ alert('Apuesta invÃ¡lida'); return; }
    balance-=bet; setBal(balance); sBal.textContent=balance; el.querySelector('#sSpin').disabled=true;

    let t=0; const interval=setInterval(()=>{
      t++;
      const a=symbols[rand(0,4)], b=symbols[rand(0,4)], c=symbols[rand(0,4)];
      reels.textContent=`${a} ${b} ${c}`;
      if(t>20){ clearInterval(interval); el.querySelector('#sSpin').disabled=false;
        if(a===b && b===c){ const win=bet*10; balance+=win; setBal(balance); sOut.innerHTML=`<div>Â¡Jackpot! Ganaste ${win}â‚¬</div>`; }
        else if(a===b || b===c || a===c){ const win=bet*2; balance+=win; setBal(balance); sOut.innerHTML=`<div>Dos iguales â€” Ganaste ${win}â‚¬</div>`; }
        else sOut.innerHTML=`<div>No hay coincidencias â€” Pierdes ${bet}â‚¬</div>`;
      }
    },60);
  };

  el.querySelector('#sClose').onclick=()=>{ modal.style.display='none'; };
}
////////////////////////////////////////////////////////////////
// ABRIR UI
////////////////////////////////////////////////////////////////
function openUI(type) {
  if (type === 'blackjack') { modal.style.display = 'block'; renderBlackjackUI(); }
  else if (type === 'roulette') { modal.style.display = 'block'; renderRouletteUI(); }
  else if (type === 'slots') { modal.style.display = 'block'; renderSlotsUI(); }
  else if (type === 'npc') {
    setBal(balance + 100);
    document.getElementById('npcMsg').innerText = 'Â¡Has recogido tus fichas diarias!';
    document.getElementById('npcMsg').style.display = 'block';
    setTimeout(() => document.getElementById('npcMsg').style.display = 'none', 1400);
  }
}

document.addEventListener('keydown', e => { if (e.code === 'KeyE' && lookingAt) openUI(lookingAt.userData.type); });
document.getElementById('container').addEventListener('click', () => { if (lookingAt) openUI(lookingAt.userData.type); });

////////////////////////////////////////////////////////////////
// LOOP DE ANIMACIÃ“N
////////////////////////////////////////////////////////////////
const clock = new THREE.Clock();
function animate() {
  requestAnimationFrame(animate);
  const dt = clock.getDelta();
  updateCameraPosition(dt);
  updateCameraRotation(dt);
  checkInteraction();
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

</script>
</body>
</html>
