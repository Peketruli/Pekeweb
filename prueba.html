<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Casino 3D — Básico</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
html, body {height:100%; margin:0; background:#030612; color:#fff; font-family:Arial, Helvetica, sans-serif; overflow:hidden;}
#wrap {position:relative; width:100%; height:100vh;}
canvas {display:block;}
.hud {position:absolute; top:12px; right:12px; max-width:300px; z-index:10;}
.panel {background:rgba(0,0,0,0.7); padding:10px; border-radius:8px; margin-bottom:10px;}
.info-row {display:flex; justify-content:space-between; margin:4px 0;}
#prompt {position:absolute; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); padding:6px 10px; border-radius:6px; display:none; z-index:20;}
#interaction-panel {position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:350px; background:rgba(8,10,12,0.95); padding:16px; border-radius:10px; display:none; z-index:30;}
.btn {background:#d95d00; color:white; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; margin-top:6px;}
</style>
</head>
<body>
<div id="wrap">
  <div class="hud">
    <div class="panel">
      <div class="info-row"><span>Saldo</span><strong id="balance">1000</strong></div>
      <div class="info-row"><span>Apuesta</span><strong id="bet">0</strong></div>
    </div>
  </div>
  <div id="prompt">[E] Interactuar</div>
  <div id="interaction-panel">
    <h3 id="panel-title">Juego</h3>
    <div id="panel-content"></div>
    <button class="btn" onclick="closePanel()">Cerrar</button>
  </div>
</div>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script>
// ==================== CONFIG ====================
const wrap = document.getElementById('wrap');
const balanceEl = document.getElementById('balance');
const betEl = document.getElementById('bet');
const logEl = document.getElementById('log');
const prompt = document.getElementById('prompt');
const panel = document.getElementById('interaction-panel');
const panelTitle = document.getElementById('panel-title');
const panelContent = document.getElementById('panel-content');

let balance = 1000;
let currentBet = 0;

function updateHUD(){
  balanceEl.textContent = balance;
  betEl.textContent = currentBet;
}

function addLog(msg){
  console.log(msg); // por ahora log simple
}

updateHUD();

// ==================== THREE SCENE ====================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x041018);
const camera = new THREE.PerspectiveCamera(75, wrap.clientWidth/wrap.clientHeight, 0.1, 1000);
camera.position.set(0,1.7,10);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(wrap.clientWidth, wrap.clientHeight);
wrap.appendChild(renderer.domElement);

// luces
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const dirLight = new THREE.DirectionalLight(0xffffff,0.8);
dirLight.position.set(10,20,10);
scene.add(dirLight);

// suelo
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x091217})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// paredes simples
function addWall(x,y,z,w,h,d){
  const wall = new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color:0x071018})
  );
  wall.position.set(x,y,z);
  scene.add(wall);
}
addWall(0,5,-25,50,10,2);
addWall(0,5,25,50,10,2);
addWall(-25,5,0,2,10,50);
addWall(25,5,0,2,10,50);

// ==================== PLAYER ====================
let playerPos = new THREE.Vector3(0,0,10);
let yaw = 0, pitch = 0;

// ==================== ZONAS ====================
const zones = [
  {x:0,z:0,label:'Ruleta', action:()=>openPanel('Ruleta')},
  {x:-10,z:-5,label:'Blackjack', action:()=>openPanel('Blackjack')},
  {x:10,z:-5,label:'Tragaperras', action:()=>openPanel('Tragaperras')}
];

let currentZone = null;
function detectZones(){
  if(!playerPos) return;
  currentZone = null;
  for(const z of zones){
    const dx = playerPos.x - z.x;
    const dz = playerPos.z - z.z;
    if(Math.sqrt(dx*dx+dz*dz) < 3){
      currentZone = z;
      prompt.style.display = 'block';
      prompt.textContent = '[E] ' + z.label;
      return;
    }
  }
  prompt.style.display = 'none';
}

// ==================== PANEL ====================
function openPanel(game){
  panelTitle.textContent = game;
  panelContent.innerHTML = `<p>Panel de ${game} (prototipo)</p>`;
  panel.style.display = 'block';
}
function closePanel(){ panel.style.display = 'none'; }

// ==================== CONTROLS ====================
const keys={w:false,a:false,s:false,d:false,ArrowLeft:false,ArrowRight:false,ArrowUp:false,ArrowDown:false};
window.addEventListener('keydown',e=>{ if(e.key in keys) keys[e.key]=true; });
window.addEventListener('keyup',e=>{ if(e.key in keys) keys[e.key]=false; });

// ==================== ANIMATION ====================
const speed = 5;
function computeDelta(dt){
  const rotSpeed = 1.5*dt;
  if(keys.ArrowLeft) yaw += rotSpeed;
  if(keys.ArrowRight) yaw -= rotSpeed;
  if(keys.ArrowUp) pitch += rotSpeed*0.5;
  if(keys.ArrowDown) pitch -= rotSpeed*0.5;
  pitch = Math.max(-1.2, Math.min(1.2, pitch));

  const e = new THREE.Euler(pitch,yaw,0,'YXZ');
  const q = new THREE.Quaternion().setFromEuler(e);

  const forward = new THREE.Vector3(0,0,-1).applyQuaternion(q); forward.y=0; forward.normalize();
  const right = new THREE.Vector3(1,0,0).applyQuaternion(q); right.y=0; right.normalize();

  let mf=0, mr=0;
  if(keys.w) mf+=1;
  if(keys.s) mf-=1;
  if(keys.a) mr-=1;
  if(keys.d) mr+=1;

  const len = Math.hypot(mf,mr);
  if(len>0){ mf/=len; mr/=len; }

  const delta = new THREE.Vector3();
  delta.addScaledVector(forward, mf*speed*dt);
  delta.addScaledVector(right, mr*speed*dt);
  return delta;
}

document.addEventListener('keydown',(e)=>{
  if(e.key.toLowerCase()==='e' && currentZone) currentZone.action();
  if(e.key==='Escape') panel.style.display='none';
});

let lastTime = 0;
function animate(ts){
  requestAnimationFrame(animate);
  const dt = (ts-lastTime)*0.001; lastTime = ts;

  detectZones();
  playerPos.add(computeDelta(dt));

  camera.position.copy(playerPos);
  camera.position.y = 1.7;
  camera.rotation.set(pitch,yaw,0,'YXZ');

  renderer.render(scene,camera);
}
requestAnimationFrame(animate);

// ==================== RESIZE ====================
window.addEventListener('resize', ()=>{
  camera.aspect = wrap.clientWidth / wrap.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(wrap.clientWidth, wrap.clientHeight);
});

  // ==================== RULETA 3D ====================
const wheelRadius = 3.5;
const pockets = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const anglePerPocket = (Math.PI*2) / pockets.length;

// Crear textura de la rueda
function createWheelCanvas(size=512){
  const c = document.createElement('canvas');
  c.width = c.height = size;
  const ctx = c.getContext('2d');
  const cx=size/2, cy=size/2, r=size*0.45;

  ctx.fillStyle='#072b22';
  ctx.fillRect(0,0,size,size);

  for(let i=0;i<pockets.length;i++){
    const a0=i*anglePerPocket-Math.PI/2;
    const a1=(i+1)*anglePerPocket-Math.PI/2;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1);
    ctx.closePath();
    ctx.fillStyle = pockets[i]===0?"#1b8b41":(i%2===0?"#b71c1c":"#000");
    ctx.fill();

    const mid = a0 + (a1-a0)/2;
    ctx.save();
    ctx.translate(cx + Math.cos(mid)*r*0.66, cy + Math.sin(mid)*r*0.66);
    ctx.rotate(mid+Math.PI/2);
    ctx.fillStyle="#fff";
    ctx.font = `${Math.floor(size*0.04)}px sans-serif`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(pockets[i],0,0);
    ctx.restore();
  }

  ctx.beginPath();
  ctx.fillStyle="#111";
  ctx.arc(cx,cy,r*0.45,0,Math.PI*2);
  ctx.fill();

  return c;
}

const wheelTexture = new THREE.CanvasTexture(createWheelCanvas());
const wheelMesh = new THREE.Mesh(
  new THREE.CylinderGeometry(wheelRadius,wheelRadius,1.2,64),
  new THREE.MeshStandardMaterial({ map: wheelTexture })
);
wheelMesh.rotation.x = Math.PI/2;
wheelMesh.position.set(0,0.3,0);
scene.add(wheelMesh);

const ballMesh = new THREE.Mesh(
  new THREE.SphereGeometry(0.18,16,16),
  new THREE.MeshStandardMaterial({color:0xffffff})
);
scene.add(ballMesh);

let spinning = false;

// ==================== RULETA UI ====================
function openRouletteUI(){
  const html = `
    <label>Números a apostar (separados por coma):</label><br>
    <input type="text" id="rouletteInput" placeholder="0,7,14" style="width:90%"><br><br>
    <label>$ A apostar:</label><br>
    <input type="number" id="rouletteBet" value="10"><br><br>
    <button class="btn" onclick="spinRoulette()">Girar Ruleta</button>
  `;
  panelTitle.textContent='Ruleta';
  panelContent.innerHTML = html;
  panel.style.display='block';
}

function spinRoulette(){
  if(spinning) return;

  const nums = document.getElementById("rouletteInput").value.split(",").map(n=>parseInt(n.trim())).filter(n=>!isNaN(n));
  const bet = parseInt(document.getElementById("rouletteBet").value);
  if(balance<bet){ addLog("Ruleta: saldo insuficiente"); return; }

  balance -= bet; updateHUD(); panel.style.display='none';
  spinning = true;

  // --- seleccionar ganador ---
  const chosen = pockets[Math.floor(Math.random()*pockets.length)];
  const pocketIndex = pockets.indexOf(chosen);

  const totalRot = 8 + Math.floor(Math.random()*4); // vueltas
  const baseRotation = Math.PI*2*totalRot;
  const tinyOffset = (Math.random()-0.5)*anglePerPocket*0.6;
  const target = (pocketIndex + 0.5)*anglePerPocket - Math.PI/2 + baseRotation + tinyOffset;

  let wheelAngle = 0;
  let ballAngle = Math.random()*Math.PI*2;
  let wheelSpeed = 8;
  let ballSpeed = 30;
  const ballRadius = wheelRadius-0.25;
  const ballHeight = 1.2;

  const interval = setInterval(()=>{
    const dt = 0.016;
    if(wheelAngle<target){
      wheelSpeed *= 0.98; // frena
      const delta = wheelSpeed*dt;
      wheelAngle += delta;
      if(wheelAngle>target) wheelAngle = target;
      wheelMesh.rotation.z = wheelAngle;
    }

    ballSpeed *= 0.992;
    ballAngle += ballSpeed*dt;
    ballMesh.position.x = Math.cos(ballAngle)*ballRadius;
    ballMesh.position.z = Math.sin(ballAngle)*ballRadius;
    ballMesh.position.y = ballHeight;

    if(wheelAngle>=target){
      clearInterval(interval);
      spinning=false;
      addLog(`Ruleta salió ${chosen}`);
      if(nums.includes(chosen)){
        const win = bet*35;
        balance+=win;
        addLog(`Ganaste $${win}!`);
      } else addLog("Perdiste.");
      updateHUD();
    }
  },16);
}
</script>
</body>
</html>
