<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Casino 3D â€” Ruleta, Slots y Blackjack</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{height:100%;margin:0;background:#030612;color:#fff;font-family:Inter,Arial,Helvetica, sans-serif;overflow:hidden}
  #wrap{position:relative;height:100vh;overflow:hidden}
  canvas{display:block}
  .hud{position:absolute;right:12px;top:12px;z-index:40;max-width:380px}
  .panel{background:rgba(0,0,0,0.56);padding:10px;border-radius:10px;margin-bottom:10px}
  .info-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:13px}
  #prompt{position:absolute;left:50%;transform:translateX(-50%);bottom:92px;background:rgba(0,0,0,0.7);padding:8px 12px;border-radius:8px;display:none;z-index:45}
  #overlay{position:absolute;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;z-index:60}
  #overlay .ui{background:rgba(8,10,12,0.96);padding:14px;border-radius:10px;width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.7);color:#ddd;max-height:80vh;overflow:auto}
  .btn{background:#d95d00;color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  footer{position:absolute;left:12px;bottom:12px;color:#bbb;font-size:13px}
  #minimap{position:absolute;left:12px;top:12px;width:120px;height:120px;background:rgba(255,255,255,0.02);border-radius:8px;z-index:30}
  .small{font-size:12px;color:#bbb}
  /* Blackjack UI small tweaks */
  .bj-cards{display:flex;gap:8px;margin-top:8px}
  .card{background:#111;padding:6px 8px;border-radius:6px;border:1px solid #333}
</style>
</head>
<body>
  <div id="wrap">
    <div id="minimap"></div>

    <div class="hud">
      <div class="panel">
        <h3>Casino 3D</h3>
        <div class="info-row"><span>Saldo</span><strong id="balance">1000</strong></div>
        <div class="info-row"><span>Apuesta</span><strong id="bet">0</strong></div>
        <div style="font-size:13px;margin-top:6px">
          Controles: <strong>W A S D</strong> moverse Â· <strong>Flechas</strong> girar cÃ¡mara Â· <strong>E</strong> interactuar
        </div>
      </div>
      <div class="panel">
        <h4>InteractÃºa</h4>
        <div id="interact-info" style="font-size:13px">AcÃ©rcate y pulsa <strong>E</strong> (o usa UI).</div>
      </div>
      <div class="panel">
        <h4>Historial</h4>
        <div id="log" style="max-height:120px;overflow:auto;font-size:12px;background:rgba(255,255,255,0.02);padding:6px;border-radius:6px"></div>
      </div>
    </div>

    <div id="prompt">[E] Interactuar</div>
    <div id="blackjack-ui" style="display:none">
  <button onclick="playBlackjack()">Jugar</button>
</div>

<div id="slots-ui" style="display:none">
  <button onclick="spinSlots()">Girar</button>
</div>

<div id="roulette-ui" style="display:none">
  <button onclick="spinRoulette()">Girar Ruleta</button>
</div>

    <div id="overlay"><div class="ui" id="ui-box"></div></div>

    <footer>Primera persona Â· Ruleta europea (0â€“36) Â· Tragaperras Â· Blackjack</footer>
  </div>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <script>// ==================== SETUP GENERAL ====================
const wrap = document.getElementById('wrap');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x041018);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(wrap.clientWidth, wrap.clientHeight);
wrap.appendChild(renderer.domElement);

// CÃ¡mara FPS
const camera = new THREE.PerspectiveCamera(72, wrap.clientWidth/wrap.clientHeight, 0.1, 1000);
camera.position.set(0,1.7,12);

let playerPos = new THREE.Vector3(0,0,12);
let yaw = 0;
let pitch = 0;

// ==================== LUCES ====================
scene.add(new THREE.AmbientLight(0xffffff,0.35));
const dir = new THREE.DirectionalLight(0xffffff,0.9);
dir.position.set(8,20,10);
scene.add(dir);
const bulb = new THREE.PointLight(0xfff3d6,0.9,200);
bulb.position.set(0,20,0);
scene.add(bulb);

// ==================== SUELO + HABITACIÃ“N ====================
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(90,90),
  new THREE.MeshStandardMaterial({color:0x091217,roughness:0.95})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

function wall(w,h,d,x,y,z,rotY){
  const m=new THREE.Mesh(
    new THREE.BoxGeometry(w,h,d),
    new THREE.MeshStandardMaterial({color:0x071018})
  );
  m.position.set(x,y,z);
  if(rotY) m.rotation.y = rotY;
  scene.add(m);
  return m;
}

// Paredes
wall(50,10,2,0,5,-40);
wall(2,10,50,-24,5,0);
wall(2,10,50,24,5,0);
wall(50,10,2,0,5,40);

// Alfombra central
const rug = new THREE.Mesh(
  new THREE.CircleGeometry(14,32),
  new THREE.MeshStandardMaterial({color:0x183430})
);
rug.rotation.x = -Math.PI/2;
rug.position.y = 0.01;
scene.add(rug);

// ==================== RECURSOS DEL CASINO ====================

// ---- RULETA ----
const wheelRadius = 6;
const pockets = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,
                 23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const pocketCount = pockets.length;
const anglePerPocket = (Math.PI*2) / pocketCount;

// Canvas de ruleta
function createWheelCanvas(size=1024){
  const c=document.createElement('canvas'); 
  c.width=c.height=size;
  const ctx=c.getContext('2d');
  const cx=size/2, cy=size/2, r=size*0.45;

  ctx.fillStyle='#072b22';
  ctx.fillRect(0,0,size,size);

  for(let i=0;i<pocketCount;i++){
    const a0=i*anglePerPocket-Math.PI/2;
    const a1=(i+1)*anglePerPocket-Math.PI/2;

    ctx.beginPath(); 
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1);
    ctx.closePath();
    ctx.fillStyle = (pockets[i]===0)?'#1b8b41':((i%2===0)?'#b71c1c':'#000');
    ctx.fill();

    const mid=a0+(a1-a0)/2;
    ctx.save();
    ctx.translate(cx+Math.cos(mid)*r*0.66, cy+Math.sin(mid)*r*0.66);
    ctx.rotate(mid+Math.PI/2);
    ctx.fillStyle='#fff';
    ctx.font=`${Math.floor(size*0.04)}px sans-serif`;
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(pockets[i],0,0);
    ctx.restore();
  }

  ctx.beginPath();
  ctx.fillStyle='#111';
  ctx.arc(cx,cy,r*0.45,0,Math.PI*2);
  ctx.fill();

  return c;
}

const wheelTex = new THREE.CanvasTexture(createWheelCanvas());
wheelTex.anisotropy = renderer.capabilities.getMaxAnisotropy();

const wheelMesh = new THREE.Mesh(
  new THREE.CylinderGeometry(wheelRadius, wheelRadius, 1.4, 128),
  new THREE.MeshStandardMaterial({map:wheelTex})
);
wheelMesh.position.y = 0.7;
scene.add(wheelMesh);

const ball = new THREE.Mesh(
  new THREE.SphereGeometry(0.2,16,16),
  new THREE.MeshStandardMaterial({color:0xffffff,metalness:0.8,roughness:0.2})
);
ball.position.set(wheelRadius-0.6,0.55,0);
scene.add(ball);

// ---- BLACKJACK ----
const bjTable = new THREE.Mesh(
  new THREE.BoxGeometry(12,0.8,5),
  new THREE.MeshStandardMaterial({color:0x1b4f2a})
);
bjTable.position.set(-14,0.4,-6);
scene.add(bjTable);

// ---- TRAGAPERRAS / ARCADE ----
const slotBody = new THREE.Mesh(
  new THREE.BoxGeometry(3,6,2),
  new THREE.MeshStandardMaterial({color:0x8a0f05})
);
slotBody.position.set(14,3,-6);
scene.add(slotBody);

// ==================== RUEDAS DE LA TRAGAPERRAS ====================
const symbols = ['ðŸ’','â­','7','ðŸ‹','ðŸ””','ðŸ‰'];
const reelCanvases = [], reelTexes = [], reelPlanes = [];

for(let i=0;i<3;i++){
  const c=document.createElement('canvas'); 
  c.width=128; 
  c.height=192;

  const ctx=c.getContext('2d');
  ctx.fillStyle='#070707';
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle='#fff';
  ctx.font='64px sans-serif';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(symbols[Math.floor(Math.random()*symbols.length)], c.width/2, c.height/2);

  reelCanvases.push(c);

  const t=new THREE.CanvasTexture(c);
  reelTexes.push(t);

  const p=new THREE.Mesh(
    new THREE.PlaneGeometry(1,1.5),
    new THREE.MeshBasicMaterial({map:t})
  );
  p.position.set(14+(i-1)*1.1,4,-5.1);
  scene.add(p);
  reelPlanes.push(p);
}

// ==================== ZONAS DE INTERACCIÃ“N ======================
// ahora AGANDADAS y con zona para la ruleta
const ruletaZone = new THREE.Box3().setFromCenterAndSize(
  new THREE.Vector3(0,0.7,0),
  new THREE.Vector3(16,6,16)
);

const slotZone = new THREE.Box3().setFromCenterAndSize(
  new THREE.Vector3(14,3,-6),
  new THREE.Vector3(7,7,6)
);

const bjZone = new THREE.Box3().setFromCenterAndSize(
  new THREE.Vector3(-14,1,-6),
  new THREE.Vector3(15,6,8)
);

// ==================== MOVIMIENTO + COLISIONES ====================
const keys = {
  w:false, a:false, s:false, d:false,
  ArrowLeft:false, ArrowRight:false, ArrowUp:false, ArrowDown:false
};

const speed = 5.2;

window.addEventListener("keydown", e=>{
  if(e.key in keys) keys[e.key] = true;
});
window.addEventListener("keyup", e=>{
  if(e.key in keys) keys[e.key] = false;
});

// Movimiento FPS
function computeDelta(dt){
  // RotaciÃ³n con flechas
  const rotSpeed = 1.4 * dt;
  if(keys.ArrowLeft) yaw += rotSpeed;
  if(keys.ArrowRight) yaw -= rotSpeed;
  if(keys.ArrowUp) pitch += rotSpeed * 0.5;
  if(keys.ArrowDown) pitch -= rotSpeed * 0.5;

  // Limitar pitch
  pitch = Math.max(-1.2, Math.min(1.2, pitch));

  const e=new THREE.Euler(pitch, yaw, 0, "YXZ");
  const q=new THREE.Quaternion().setFromEuler(e);

  const forward=new THREE.Vector3(0,0,-1).applyQuaternion(q);
  forward.y=0; forward.normalize();

  const right=new THREE.Vector3(1,0,0).applyQuaternion(q);
  right.y=0; right.normalize();

  let mf=0, mr=0;
  if(keys.w) mf+=1;
  if(keys.s) mf-=1;
  if(keys.a) mr-=1;
  if(keys.d) mr+=1;

  const len=Math.hypot(mf,mr);
  if(len>0){ mf/=len; mr/=len; }

  const delta=new THREE.Vector3();
  delta.addScaledVector(forward, mf*speed*dt);
  delta.addScaledVector(right, mr*speed*dt);

  return delta;
}

// colisiones simples con paredes
function checkCollision(pos){
  if(Math.abs(pos.x)>28) return true;
  if(Math.abs(pos.z)>28) return true;
  return false;
}

// ==================== HUD / INTERACCIÃ“N ====================
const prompt = document.getElementById("prompt");
let nearZone = null;

function detectZones(){
  const eye = playerPos.clone();
  eye.y = camera.position.y;

  if(ruletaZone.containsPoint(eye)){
    nearZone = "ruleta";
    prompt.style.display = "block";
    prompt.textContent = "[E] Ruleta";
    return;
  }
  if(slotZone.containsPoint(eye)){
    nearZone = "slot";
    prompt.style.display = "block";
    prompt.textContent = "[E] Tragaperras";
    return;
  }
  if(bjZone.containsPoint(eye)){
    nearZone = "blackjack";
    prompt.style.display = "block";
    prompt.textContent = "[E] Blackjack";
    return;
  }

  nearZone = null;
  prompt.style.display = "none";
}

window.addEventListener("keydown", e=>{
  if(e.key==="e" && nearZone){
    alert("InteracciÃ³n con: " + nearZone + " (UI todavÃ­a no implementada)");
  }
});

    // ==========================
// CONTROLES DE CÃMARA
// ==========================
document.addEventListener("keydown", (e) => {
    const rotSpeed = 0.03;
    if (e.key === "ArrowLeft") camera.rotation.y += rotSpeed;
    if (e.key === "ArrowRight") camera.rotation.y -= rotSpeed;
});


// ==========================
// ZONAS DE INTERACCIÃ“N
// ==========================

// FORMATO:
// { x, z, radius, label, action }

const interactionZones = [
    {
        label: "Blackjack",
        x: 5,
        z: -4,
        radius: 2.8, // AUMENTADO
        action: openBlackjackUI
    },
    {
        label: "Tragaperras",
        x: -4,
        z: 0,
        radius: 3.2, // AUMENTADO
        action: openSlotsUI
    },
    {
        label: "Ruleta",
        x: 5,
        z: 4,
        radius: 3.5, // AÃ‘ADIDA
        action: openRouletteUI
    }
];


// ==========================
// DETECTAR ZONA ACTIVA
// ==========================
let currentZone = null;

function checkInteractionZones() {
    currentZone = null;

    for (const zone of interactionZones) {
        const dx = camera.position.x - zone.x;
        const dz = camera.position.z - zone.z;
        const dist = Math.sqrt(dx * dx + dz * dz);

        if (dist < zone.radius) {
            currentZone = zone;
            showInteractionTooltip(zone.label);
            return;
        }
    }

    hideInteractionTooltip();
}

function showInteractionTooltip(name) {
    const t = document.getElementById("interaction-tip");
    t.textContent = `Pulsa E para interactuar con ${name}`;
    t.style.display = "block";
}

function hideInteractionTooltip() {
    const t = document.getElementById("interaction-tip");
    t.style.display = "none";
}


// ==========================
// INTERACCIÃ“N (E)
// ==========================
document.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === "e" && currentZone) {
        currentZone.action();
    }
});


// ==========================
// COLISIONES SIMPLES
// ==========================

const colliders = [
    { x: 5, z: -4, radius: 2 },   // Blackjack
    { x: -4, z: 0, radius: 2 },   // Tragaperras
    { x: 5, z: 4, radius: 2 },    // Ruleta
];

function preventWalkingThroughMachines() {
    const speed = 0.15;

    let intendedX = camera.position.x;
    let intendedZ = camera.position.z;

    // Movimiento (WASD)
    document.addEventListener("keydown", (e) => {
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);

        if (e.key === "w") {
            intendedX += dir.x * speed;
            intendedZ += dir.z * speed;
        }
        if (e.key === "s") {
            intendedX -= dir.x * speed;
            intendedZ -= dir.z * speed;
        }
        if (e.key === "a") {
            intendedX += dir.z * speed;
            intendedZ -= dir.x * speed;
        }
        if (e.key === "d") {
            intendedX -= dir.z * speed;
            intendedZ += dir.x * speed;
        }

        // Comprobar colisiones
        for (const c of colliders) {
            const dx = intendedX - c.x;
            const dz = intendedZ - c.z;
            const dist = Math.sqrt(dx * dx + dz * dz);

            if (dist < c.radius) {
                return; // BLOQUEA movimiento
            }
        }

        // Si no hay colisiones: actualizar posiciÃ³n
        camera.position.x = intendedX;
        camera.position.z = intendedZ;
    });
}

preventWalkingThroughMachines();


// ==========================
// FUNCIONES DE JUEGO
// ==========================

function openBlackjackUI() {
    document.getElementById("blackjack-ui").style.display = "block";
}

function openSlotsUI() {
    document.getElementById("slots-ui").style.display = "block";
}

function openRouletteUI() {
    document.getElementById("roulette-ui").style.display = "block";
}

    function playBlackjack() {
    const result = Math.random() < 0.5 ? "Ganaste!" : "Perdiste!";
    alert(`Blackjack: ${result}`);
}

    function spinSlots() {
    for(let i=0; i<3; i++){
        const symbol = symbols[Math.floor(Math.random()*symbols.length)];
        const ctx = reelCanvases[i].getContext("2d");

        // Limpiar y dibujar nuevo sÃ­mbolo
        ctx.fillStyle='#070707';
        ctx.fillRect(0,0,reelCanvases[i].width,reelCanvases[i].height);
        ctx.fillStyle='#fff';
        ctx.font='64px sans-serif';
        ctx.textAlign='center';
        ctx.textBaseline='middle';
        ctx.fillText(symbol, reelCanvases[i].width/2, reelCanvases[i].height/2);

        reelTexes[i].needsUpdate = true;
    }

    // Comprobar si hay premio (si los 3 coinciden)
    const s0 = reelCanvases[0].getContext("2d").canvas.toDataURL();
    const s1 = reelCanvases[1].getContext("2d").canvas.toDataURL();
    const s2 = reelCanvases[2].getContext("2d").canvas.toDataURL();

    // Muy bÃ¡sico: solo notificaciÃ³n
    alert("Tragaperras girada!");
}

    function spinRoulette() {
    // Elegir nÃºmero aleatorio
    const chosenIndex = Math.floor(Math.random() * pockets.length);
    const chosenNumber = pockets[chosenIndex];

    // Animar la ruleta (simplificado)
    let startRotation = wheelMesh.rotation.y;
    const spins = 5; // vueltas completas
    const endRotation = startRotation + spins * Math.PI*2 + chosenIndex * anglePerPocket;

    const duration = 2000; // 2 segundos
    const startTime = performance.now();

    function animateSpin(now) {
        const t = (now - startTime)/duration;
        if(t < 1){
            const ease = 1 - Math.pow(1-t,3); // easing cubic out
            wheelMesh.rotation.y = startRotation + (endRotation-startRotation)*ease;
            requestAnimationFrame(animateSpin);
        } else {
            wheelMesh.rotation.y = endRotation;
            alert(`Ruleta: saliÃ³ el ${chosenNumber}`);
        }
    }
    requestAnimationFrame(animateSpin);
}

// ==================== ANIMACIÃ“N ====================
let lastTime = 0;

function animate(ts){
  requestAnimationFrame(animate);
  const dt = (ts - lastTime) * 0.001;
  lastTime = ts;

  detectZones();

  const delta = computeDelta(dt);
  const next = playerPos.clone().add(delta);

  if(!checkCollision(next)){
    playerPos.copy(next);
  }

  camera.position.copy(playerPos);
  camera.position.y = 1.7;
  camera.rotation.set(pitch, yaw, 0, "YXZ");

  renderer.render(scene, camera);
}

requestAnimationFrame(animate);

// Responsive
window.addEventListener("resize", ()=>{
  camera.aspect = wrap.clientWidth / wrap.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(wrap.clientWidth, wrap.clientHeight);
});
  </script>
</body>
</html>
