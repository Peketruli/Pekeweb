<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado UI & Texturas</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:400px;background:var(--panel);padding:20px;border-radius:12px;
    display:none;z-index:10;max-height:80vh;overflow:auto;}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0;cursor:pointer;}
  .gameUI h2{margin:0 0 8px 0;text-align:center;}
  .gameUI{display:flex;flex-direction:column;align-items:center;}
  .gameUI button{width:80%;margin-top:4px;}
  .gameResult{margin-top:8px;color:#f5b642;}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
(async function main(){
  const container=document.getElementById('container');
  const balanceSpan=document.getElementById('balance');
  const modal=document.getElementById('modal');
  const npcMsgEl=document.getElementById('npcMsg');

  let currentUser=JSON.parse(localStorage.getItem('currentUser') || '{"id":1,"pekepuntos":1000}');
  let balance=Number(currentUser.pekepuntos || 1000);
  function refreshBalanceUI(){ balanceSpan.textContent=balance; }
  refreshBalanceUI();
  function saveBalance(){ currentUser.pekepuntos=balance; localStorage.setItem('currentUser',JSON.stringify(currentUser)); refreshBalanceUI(); }
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ---------- THREE JS ----------
  const scene=new THREE.Scene(); 
  scene.background=new THREE.Color(0x0b0f1a);

  const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
  camera.position.set(0,1.6,5); 
  camera.rotation.order='YXZ';

  const renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.shadowMap.enabled=true;
  container.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff,0x222233,0.8));
  scene.add(new THREE.AmbientLight(0xffffff,0.25));
  const dir=new THREE.DirectionalLight(0xfff6d6,0.6);
  dir.position.set(5,10,5);
  scene.add(dir);

  // ---------- TEXTURAS ----------
  function canvasChecker(size=512, c1='#2a0033', c2='#550077', squares=8){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d'); const s=size/squares;
    for(let i=0;i<squares;i++)
      for(let j=0;j<squares;j++){
        ctx.fillStyle=((i+j)%2===0)?c1:c2;
        ctx.fillRect(i*s,j*s,s,s);
      }
    return new THREE.CanvasTexture(c);
  }

  function canvasMarble(size=512, color1='#666666', color2='#cccccc'){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d');
    ctx.fillStyle=color1; ctx.fillRect(0,0,size,size);
    for(let i=0;i<200;i++){
      ctx.strokeStyle=color2;
      ctx.beginPath();
      ctx.moveTo(Math.random()*size, Math.random()*size);
      ctx.lineTo(Math.random()*size, Math.random()*size);
      ctx.stroke();
    }
    return new THREE.CanvasTexture(c);
  }

  function canvasTable(color='#003300'){
    const c=document.createElement('canvas'); c.width=c.height=256;
    const ctx=c.getContext('2d');
    ctx.fillStyle=color; ctx.fillRect(0,0,256,256);
    for(let i=0;i<50;i++){
      ctx.strokeStyle='rgba(255,255,255,0.05)';
      ctx.beginPath();
      ctx.moveTo(Math.random()*256, Math.random()*256);
      ctx.lineTo(Math.random()*256, Math.random()*256);
      ctx.stroke();
    }
    return new THREE.CanvasTexture(c);
  }

  function canvasMetal(size=256){
    const c=document.createElement('canvas'); c.width=c.height=size;
    const ctx=c.getContext('2d');
    const grd=ctx.createLinearGradient(0,0,size,size);
    grd.addColorStop(0,'#888'); grd.addColorStop(1,'#ccc');
    ctx.fillStyle=grd; ctx.fillRect(0,0,size,size);
    return new THREE.CanvasTexture(c);
  }

  // ---------- SUELO Y PAREDES ----------
  const floor=new THREE.Mesh(
    new THREE.PlaneGeometry(30,30),
    new THREE.MeshStandardMaterial({map:canvasChecker(),roughness:0.9})
  );
  floor.rotation.x=-Math.PI/2;
  floor.receiveShadow=true;
  scene.add(floor);

  const walls=new THREE.Mesh(
    new THREE.BoxGeometry(30,10,30),
    new THREE.MeshStandardMaterial({map:canvasMarble(),side:THREE.BackSide,roughness:0.8})
  );
  walls.position.y=5;
  scene.add(walls);

  // ---------- MESAS & NPC (MEJORADOS) ----------

// â€”â€”â€” TEXTURA TAPETE BLACKJACK â€”â€”â€”
function blackjackTexture(){
  const c=document.createElement('canvas'); 
  c.width=512; c.height=512;
  const ctx=c.getContext('2d');

  // Fondo
  ctx.fillStyle="#006622";
  ctx.fillRect(0,0,512,512);

  // LÃ­neas semicÃ­rculo
  ctx.strokeStyle="white";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.arc(256,420,260,Math.PI,2*Math.PI);
  ctx.stroke();

  // Texto
  ctx.fillStyle="white";
  ctx.font="32px Arial";
  ctx.textAlign="center";
  ctx.fillText("BLACKJACK PAYS 3 TO 2",256,80);
  ctx.fillText("DEALER MUST STAND ON 17",256,120);

  return new THREE.CanvasTexture(c);
}

// â€”â€”â€” RULETA 3D â€”â€”â€”
function rouletteModel(){
  const group=new THREE.Group();

  // Base
  const base=new THREE.Mesh(
    new THREE.CylinderGeometry(1.5,1.5,0.3,64),
    new THREE.MeshStandardMaterial({color:0x2d1a07,metalness:0.2,roughness:0.8})
  );
  base.position.y=0.15;
  group.add(base);

  // Rueda
  const wheel=new THREE.Mesh(
    new THREE.CylinderGeometry(1.4,1.4,0.2,64),
    new THREE.MeshStandardMaterial({color:0x111111,metalness:0.3,roughness:0.4})
  );
  wheel.position.y=0.26;
  group.add(wheel);

  // Segmentos NUMERADOS
  const redNums=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];

  for(let i=0;i<37;i++){
    const segGeom=new THREE.RingGeometry(0.9,1.35,2,1,0,Math.PI*2/37);
    const segMat=new THREE.MeshStandardMaterial({
      color: i===0 ? 0x00aa00 : (redNums.includes(i)?0xaa0000:0x000000),
      side: THREE.DoubleSide,
      metalness:0.5,
      roughness:0.5
    });
    const seg=new THREE.Mesh(segGeom,segMat);
    seg.rotation.x = -Math.PI/2;
    seg.rotation.z = (i * (Math.PI*2/37));
    seg.position.y = 0.271;
    group.add(seg);

    // NÃºmeros
    const numCanvas=document.createElement('canvas');
    numCanvas.width=64; numCanvas.height=64;
    const ctx=numCanvas.getContext('2d');
    ctx.fillStyle="white";
    ctx.font="32px Arial";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(i.toString(),32,32);

    const tex=new THREE.CanvasTexture(numCanvas);
    const numPlane=new THREE.Mesh(
      new THREE.PlaneGeometry(0.25,0.25),
      new THREE.MeshBasicMaterial({map:tex,transparent:true})
    );
    numPlane.position.set(
      Math.cos(i*(Math.PI*2/37))*1.15,
      0.29,
      Math.sin(i*(Math.PI*2/37))*1.15
    );
    numPlane.lookAt(0,0.29,0);
    group.add(numPlane);
  }

  return group;
}

// â€”â€”â€” MÃQUINA TRAGAPERRAS â€”â€”â€”
function slotMachineModel(){
  const g=new THREE.Group();

  const body=new THREE.Mesh(
    new THREE.BoxGeometry(1,2,1),
    new THREE.MeshStandardMaterial({color:0x333333,metalness:0.8,roughness:0.3})
  );
  body.position.y=1;
  g.add(body);

  const screen=new THREE.Mesh(
    new THREE.PlaneGeometry(0.8,0.6),
    new THREE.MeshStandardMaterial({color:0x222222,emissive:0x444444})
  );
  screen.position.set(0,1.4,0.51);
  g.add(screen);

  const lever=new THREE.Mesh(
    new THREE.CylinderGeometry(0.05,0.05,0.8,16),
    new THREE.MeshStandardMaterial({color:0xaa0000})
  );
  lever.position.set(0.55,1.1,0);
  lever.rotation.z=-Math.PI/2;
  g.add(lever);

  const ball=new THREE.Mesh(
    new THREE.SphereGeometry(0.12,16,16),
    new THREE.MeshStandardMaterial({color:0xff0000})
  );
  ball.position.set(0.95,1.1,0);
  g.add(ball);

  return g;
}

// â€”â€”â€” GENERADOR DE OBJETOS â€”â€”â€”
// Blackjack (mesa)
const blackjackObj = addTable(-4, 0, 'blackjack');
blackjackObj.scale.set(1, 1, 1);

// Ruleta (modelo 3D)
const rouletteObj = addTable(0, 0, 'roulette');
rouletteObj.scale.set(1, 1, 1);

// Tragaperras (mÃ¡quina 3D)
const slotsObj = addTable(4, 0, 'slots');
slotsObj.scale.set(1, 1, 1);

// NPC cilindro metÃ¡lico
const npcMesh = new THREE.Mesh(
  new THREE.CylinderGeometry(0.4, 0.4, 1.6, 16),
  new THREE.MeshStandardMaterial({ color: 0xdddddd, metalness: 0.6, roughness: 0.3 })
);
npcMesh.position.set(0, 1, 5);
npcMesh.userData.type = 'npc';

npcMesh.castShadow = true;
npcMesh.receiveShadow = true;

scene.add(npcMesh);
interactables.push(npcMesh);


  // ---------- MOVIMIENTO ----------
  const keys={};
  document.addEventListener('keydown',e=>keys[e.code]=true);
  document.addEventListener('keyup',e=>keys[e.code]=false);

  let yaw=0,pitch=0;

  function updateCamera(dt){
    if(keys['ArrowLeft']) yaw+=1.8*dt;
    if(keys['ArrowRight']) yaw-=1.8*dt;
    if(keys['ArrowUp']) pitch+=1.2*dt;
    if(keys['ArrowDown']) pitch-=1.2*dt;

    const limit=Math.PI/2-0.05;
    pitch=Math.max(-limit,Math.min(limit,pitch));

    camera.rotation.set(pitch,yaw,0);

    const forward=new THREE.Vector3();
    camera.getWorldDirection(forward);
    forward.y=0; forward.normalize();

    const right=new THREE.Vector3();
    right.crossVectors(forward,camera.up).normalize();

    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward);
    if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right);
    if(keys['KeyA']) move.sub(right);

    camera.position.addScaledVector(move,3*dt);
  }

  // ---------- INTERACCIÃ“N ----------
  const ray=new THREE.Raycaster();
  let lookingAt=null;

  function checkInteraction(){
    ray.set(camera.position,camera.getWorldDirection(new THREE.Vector3()));
    const hits=ray.intersectObjects(interactables,false);
    if(!hits.length || hits[0].distance>4){
      lookingAt=null;
      npcMsgEl.style.display='none';
      return;
    }
    lookingAt=hits[0].object;
    npcMsgEl.style.display = lookingAt.userData.type==='npc' ? 'block' : 'none';
  }

  function showGameUI(html){ modal.innerHTML=html; modal.style.display='block'; }
  function hideGameUI(){ modal.style.display='none'; }

  async function claimDaily(){
    const today=new Date().toISOString().slice(0,10);
    const last=currentUser.last_claim?currentUser.last_claim.slice(0,10):null;
    if(last===today) return;
    balance+=100;
    currentUser.last_claim=new Date().toISOString();
    saveBalance();
  }
// ---------- BLACKJACK ----------
  function openBlackjack(){
  showGameUI(`
    <div class="gameUI">
      <h2>Blackjack</h2>
      <label>Apuesta: <input type="number" id="bjBet" value="50" min="1" max="${balance}"></label>
      <button id="deal">Repartir cartas</button>
      <div id="bjActions" style="display:none;">
        <button id="hit">Pedir</button>
        <button id="stand">Plantarse</button>
        <button id="double">Doblar</button>
        <button id="split">Dividir</button>
      </div>
      <div class="gameResult" id="bjResult"></div>
    </div>
  `);
  const betInput=document.getElementById('bjBet');
  const dealBtn=document.getElementById('deal');
  const actionsDiv=document.getElementById('bjActions');
  const resultDiv=document.getElementById('bjResult');

  let player=0,dealer=0,bet=0,hand1=null,hand2=null,canSplit=false;

  dealBtn.onclick=()=>{
    bet=Math.min(Number(betInput.value),balance);
    player=rand(15,21); dealer=rand(16,21);
    canSplit=(rand(0,1)===1); // Simulamos que se puede dividir aleatoriamente
    actionsDiv.style.display='flex';
    resultDiv.textContent=`Reparto inicial: Tu ${player}, Dealer ???`;
    if(!canSplit) document.getElementById('split').disabled=true;
  };

  document.getElementById('hit').onclick=()=>{
    player+=rand(1,5);
    if(player>21){ balance-=bet; saveBalance(); resultDiv.textContent=`Te pasaste! Tu ${player}. Perdida de ${bet}`; hideGameUI(); } 
    else resultDiv.textContent=`Tu suma: ${player}`;
  };

  document.getElementById('stand').onclick=()=>{
    dealer=rand(16,21);
    if(player>21) balance-=bet;
    else if(dealer>21||player>dealer) balance+=bet;
    else if(player===dealer) {}
    else balance-=bet;
    saveBalance();
    resultDiv.textContent=`Resultado final: Tu ${player}, Dealer ${dealer}`;
    hideGameUI();
  };

  document.getElementById('double').onclick=()=>{
    if(balance<2*bet){ resultDiv.textContent="No tienes suficiente saldo para doblar."; return; }
    bet*=2;
    player+=rand(1,5); // solo una carta mÃ¡s
    dealer=rand(16,21);
    if(player>21) balance-=bet;
    else if(dealer>21||player>dealer) balance+=bet;
    else if(player===dealer) {}
    else balance-=bet;
    saveBalance();
    resultDiv.textContent=`Doblar: Tu ${player}, Dealer ${dealer}. Apuesta: ${bet}`;
    hideGameUI();
  };

  document.getElementById('split').onclick=()=>{
    if(!canSplit){ resultDiv.textContent="No puedes dividir."; return; }
    hand1=rand(7,11); hand2=rand(7,11); // simulamos dos manos
    bet=Math.min(bet,balance/2);
    resultDiv.textContent=`Dividido: Mano1 ${hand1}, Mano2 ${hand2}.`;
    // Para simplificar, se juega cada mano como Blackjack normal
  };
}

  // ---------- RULETA ----------
  function openRoulette(){
    showGameUI(`
      <div class="gameUI">
        <h2>Ruleta</h2>
        <label>Apuesta: <input type="number" id="rBet" value="50" min="1" max="${balance}"></label>
        <div>
          <button id="numBtn">NÃºmero</button>
          <button id="colorBtn">Color</button>
          <button id="parBtn">Par/Impar</button>
        </div>
        <div id="rOptions" style="margin-top:8px;"></div>
        <div class="gameResult" id="rResult"></div>
      </div>
    `);
    const betInput=document.getElementById('rBet');
    const optionsDiv=document.getElementById('rOptions');
    const resultDiv=document.getElementById('rResult');

    function spinRoulette(type,value){
      const bet=Math.min(Number(betInput.value),balance);
      const result=rand(0,36);
      let win=false;
      if(type==='number' && Number(value)===result) win=true;
      else if(type==='color'){
        const red=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        const isRed=red.includes(result);
        if((value==='rojo'&&isRed)||(value==='negro'&&!isRed)) win=true;
      }
      else if(type==='par') win=(result%2===0 && value==='par')||(result%2!==0 && value==='impar');
      if(win){ balance+=bet*2; resultDiv.textContent=`Ganaste! SaliÃ³ ${result}`; } 
      else { balance-=bet; resultDiv.textContent=`Perdiste. SaliÃ³ ${result}`; }
      saveBalance(); hideGameUI();
    }

    document.getElementById('numBtn').onclick=()=>{
      optionsDiv.innerHTML='';
      for(let i=0;i<=36;i++){
        const b=document.createElement('button'); b.textContent=i; b.onclick=()=>spinRoulette('number',i);
        optionsDiv.appendChild(b);
      }
    };
    document.getElementById('colorBtn').onclick=()=>{
      optionsDiv.innerHTML='';
      ['rojo','negro'].forEach(c=>{
        const b=document.createElement('button'); b.textContent=c; b.onclick=()=>spinRoulette('color',c);
        optionsDiv.appendChild(b);
      });
    };
    document.getElementById('parBtn').onclick=()=>{
      optionsDiv.innerHTML='';
      ['par','impar'].forEach(p=>{
        const b=document.createElement('button'); b.textContent=p; b.onclick=()=>spinRoulette('par',p);
        optionsDiv.appendChild(b);
      });
    };
  }

  // ---------- TRAGAPERRAS ----------
  function openSlots(){
    showGameUI(`
      <div class="gameUI">
        <h2>Tragamonedas</h2>
        <label>Apuesta: <input type="number" id="sBet" value="50" min="1" max="${balance}"></label>
        <button id="sPlay">Jugar</button>
        <div class="gameResult" id="sResult"></div>
      </div>
    `);
    const betInput=document.getElementById('sBet');
    const resultDiv=document.getElementById('sResult');
    document.getElementById('sPlay').onclick=()=>{
      const bet=Math.min(Number(betInput.value),balance);
      const symbols=['ðŸ’','ðŸ‹','ðŸŠ','ðŸ‡','ðŸ’Ž','7ï¸âƒ£'];
      const r=[rand(0,5),rand(0,5),rand(0,5)];
      const res=r.map(i=>symbols[i]).join(' | ');
      let won=r[0]===r[1]&&r[1]===r[2];
      if(won){ balance+=bet*5; resultDiv.textContent=`${res} Jackpot! Ganaste ${bet*5}`; } 
      else { balance-=bet; resultDiv.textContent=`${res} Perdiste ${bet}`; }
      saveBalance();
    };
  }

  // ---------- TECLA E ----------
  document.addEventListener('keydown',async e=>{
    if(e.code!=='KeyE') return;
    if(!lookingAt) return;

    const t=lookingAt.userData.type;
    if(t==='npc') await claimDaily();
    else if(t==='blackjack') openBlackjack();
    else if(t==='roulette') openRoulette();
    else if(t==='slots') openSlots();
  });

  // ---------- ANIMATE LOOP (solo uno) ----------
  const clock=new THREE.Clock();
  function animate(){
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    updateCamera(dt);
    checkInteraction();
    renderer.render(scene,camera);
  }
  animate();

  // ---------- RESIZE ----------
  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

})();
</script>
</body>
</html>
