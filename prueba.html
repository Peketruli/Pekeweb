<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10;max-height:70vh;overflow:auto}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<!-- three.js (min) -->
<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
(async function main(){
  const container = document.getElementById('container');
  const balanceSpan = document.getElementById('balance');
  const npcMsgEl = document.getElementById('npcMsg');

  // ---------- Usuario ----------
  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if(!currentUser){ alert('Debes iniciar sesiÃ³n para jugar.'); return; }
  let balance = Number(currentUser.pekepuntos || 0);

  function refreshBalanceUI(){
    if(balanceSpan) balanceSpan.textContent = balance;
  }
  refreshBalanceUI();

  async function saveBalance(){
    currentUser.pekepuntos = balance;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshBalanceUI();
  }

  // ---------- Helpers ----------
  function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // ---------- THREE.js ----------
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f1a);

  const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0,1.6,5);
  camera.rotation.order = 'YXZ';

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);

  // luces
  scene.add(new THREE.AmbientLight(0xffffff,0.3));
  const dir = new THREE.DirectionalLight(0xfff6d6,0.7);
  dir.position.set(5,10,5); scene.add(dir);

  // ---------- Texturas Canvas ----------
  function canvasTexture(color1,color2,size=512){
    const c = document.createElement('canvas'); c.width=c.height=size;
    const ctx = c.getContext('2d');
    const g = ctx.createLinearGradient(0,0,size,size);
    g.addColorStop(0,color1); g.addColorStop(1,color2);
    ctx.fillStyle = g; ctx.fillRect(0,0,size,size);
    return new THREE.CanvasTexture(c);
  }

  // ---------- Suelo ----------
  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(30,30),
    new THREE.MeshStandardMaterial({map:canvasTexture('#2a0033','#550077'), roughness:0.9})
  );
  floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

  // ---------- Mesas / Interactuables ----------
  const interactables = [];

  function addTable(x,z,type){
    let geom, mat;
    if(type==='slots'){
      geom = new THREE.BoxGeometry(1,2,1);
      mat = new THREE.MeshStandardMaterial({map:canvasTexture('#111','#6600ff')});
    } else if(type==='blackjack'){
      geom = new THREE.CylinderGeometry(1.5,1.5,0.3,32);
      mat = new THREE.MeshStandardMaterial({map:canvasTexture('#006600','#00aa00')});
    } else if(type==='roulette'){
      geom = new THREE.CylinderGeometry(1.5,1.5,0.3,32);
      mat = new THREE.MeshStandardMaterial({map:canvasTexture('#222200','#ffaa00')});
    }
    const mesh = new THREE.Mesh(geom, mat);
    mesh.position.set(x,(type==='slots'?1:0.3),z);
    mesh.userData.type = type;
    scene.add(mesh); interactables.push(mesh); return mesh;
  }

  const tableBJ = addTable(-4,0,'blackjack');
  const tableR  = addTable(0,0,'roulette');
  const tableS  = addTable(4,0,'slots');

  // ---------- NPC ----------
  const npc = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.6,16), new THREE.MeshStandardMaterial({color:0x999999}));
  npc.position.set(0,1,5); npc.userData.type='npc';
  scene.add(npc); interactables.push(npc);

  // ---------- Movimiento cÃ¡mara ----------
  const keys={};
  document.addEventListener('keydown',e=>keys[e.code]=true);
  document.addEventListener('keyup',e=>keys[e.code]=false);
  let yaw=0,pitch=0;

  function updateCamera(dt){
    const ys=1.8, ps=1.2;
    if(keys['ArrowLeft']) yaw+=ys*dt; if(keys['ArrowRight']) yaw-=ys*dt;
    if(keys['ArrowUp']) pitch+=ps*dt; if(keys['ArrowDown']) pitch-=ps*dt;
    const limit = Math.PI/2-0.05; pitch=Math.max(-limit,Math.min(limit,pitch));
    camera.rotation.y=yaw; camera.rotation.x=pitch;
    const forward=new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3(); right.crossVectors(forward,camera.up).normalize();
    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward); if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right); if(keys['KeyA']) move.sub(right);
    move.multiplyScalar(3*dt); camera.position.add(move);
  }

  // ---------- Raycast interacciÃ³n ----------
  const ray = new THREE.Raycaster(); let lookingAt=null;
  function checkInteraction(){
    ray.set(camera.position,camera.getWorldDirection(new THREE.Vector3()));
    const hits = ray.intersectObjects(interactables,false);
    if(!hits.length || hits[0].distance>4){ lookingAt=null; npcMsgEl.style.display='none'; return; }
    lookingAt = hits[0].object;
    if(lookingAt.userData.type==='npc'){ npcMsgEl.style.display='block'; npcMsgEl.innerText='Pulsa E para fichas diarias'; }
    else npcMsgEl.style.display='none';
  }

  // ---------- Juegos ----------
  async function claimDaily(){
    const today = new Date().toISOString().slice(0,10);
    const last = currentUser.last_claim?currentUser.last_claim.slice(0,10):null;
    if(last===today){ alert('Ya has reclamado hoy'); return; }
    balance+=100; currentUser.last_claim=new Date().toISOString();
    await saveBalance();
    npcMsgEl.innerText='Â¡Has recogido tus fichas diarias!'; npcMsgEl.style.display='block';
    setTimeout(()=>npcMsgEl.style.display='none',1400);
  }

  async function playBlackjack(bet=50){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    let player=rand(15,21), dealer=rand(16,21);
    let action=prompt(`Blackjack\nTu: ${player}\nDealer: ???\nÂ¿PedÃ­s pedir/plantarse? (p/l)`);
    if(action==='p'){ player+=rand(1,5); } // simple pedir
    let result='lose';
    if(player>21) result='lose';
    else if(dealer>21||player>dealer) result='win';
    else if(player===dealer) result='tie';
    else result='lose';
    if(result==='win'){ balance+=bet; alert(`Ganaste! Tu: ${player} Dealer: ${dealer} +${bet}`); }
    else if(result==='lose'){ balance-=bet; alert(`Perdiste! Tu: ${player} Dealer: ${dealer} -${bet}`); }
    else alert(`Empate! Tu: ${player} Dealer: ${dealer}`);
    await saveBalance();
  }

  async function playRoulette(bet=50){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    const chosen = prompt('NÃºmero (0-36) o color (rojo/negro)?');
    if(!chosen) return;
    const result = rand(0,36);
    const color = (result%2===0)?'rojo':'negro';
    let win=false;
    if(!isNaN(chosen) && Number(chosen)===result) win=true;
    else if(chosen.toLowerCase()===color) win=true;
    if(win){ balance+=bet*2; alert(`Ganaste! SaliÃ³ ${result} (${color}) +${bet*2}`); }
    else { balance-=bet; alert(`Perdiste! SaliÃ³ ${result} (${color}) -${bet}`); }
    await saveBalance();
  }

  async function playSlots(bet=50){
    if(balance<bet){ alert('Saldo insuficiente'); return; }
    const symbols=['ðŸ’','ðŸ‹','ðŸŠ','ðŸ‡','ðŸ’Ž','7ï¸âƒ£'];
    const r=[rand(0,5),rand(0,5),rand(0,5)];
    const res=r.map(i=>symbols[i]).join(' | ');
    const won=(r[0]===r[1] && r[1]===r[2]);
    if(won){ balance+=bet*5; alert(`${res}\nJackpot! +${bet*5}`); }
    else { balance-=bet; alert(`${res}\nPerdiste -${bet}`); }
    await saveBalance();
  }

  document.addEventListener('keydown',async(e)=>{
    if(e.code!=='KeyE') return;
    if(!lookingAt) return;
    const t=lookingAt.userData.type;
    if(t==='npc') await claimDaily();
    else if(t==='blackjack') await playBlackjack(50);
    else if(t==='roulette') await playRoulette(50);
    else if(t==='slots') await playSlots(50);
  });

  // ---------- AnimaciÃ³n ----------
  const clock=new THREE.Clock();
  function animate(){ requestAnimationFrame(animate); const dt=clock.getDelta(); updateCamera(dt); checkInteraction(); renderer.render(scene,camera);}
  animate();

  window.addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

})();
</script>
</body>
</html>
