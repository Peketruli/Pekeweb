<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D — Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10;max-height:70vh;overflow:auto}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> €</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// -------------------- USUARIO --------------------
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
if (!currentUser) {
    alert("Debes iniciar sesión para jugar.");
    throw "Usuario no identificado";
}

let balance = currentUser.pekepuntos || 0;
document.getElementById("balance").textContent = balance;

// -------------------- Helpers --------------------
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

async function saveBalance() {
    try {
        await supabase.from("usuarios").update({ pekepuntos: balance }).eq("id", currentUser.id);
        currentUser.pekepuntos = balance;
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
    } catch(err) { alert("Error guardando balance: " + err.message); }
}

// -------------------- Recompensa diaria --------------------
async function claimDaily() {
    const today = new Date().toISOString().slice(0,10);
    const lastClaim = currentUser.last_claim ? currentUser.last_claim.slice(0,10) : null;
    if (lastClaim === today) {
        alert("Ya has recogido tus fichas diarias hoy.");
        return;
    }
    balance += 100;
    currentUser.pekepuntos = balance;
    currentUser.last_claim = new Date().toISOString();
    try {
        await supabase.from("usuarios").update({ pekepuntos: balance, last_claim: currentUser.last_claim }).eq("id", currentUser.id);
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        document.getElementById("balance").textContent = balance;
        alert("¡Has recogido tus 100 fichas diarias!");
    } catch(err) { alert("Error al reclamar diario: " + err.message); }
}

// -------------------- ESCENA 3D --------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f1a);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 5);
camera.rotation.order = 'YXZ';

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.getElementById("container").appendChild(renderer.domElement);

// Luces
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 0.8);
hemi.position.set(0,50,0); scene.add(hemi);
scene.add(new THREE.AmbientLight(0xffffff,0.25));
const dir = new THREE.DirectionalLight(0xfff6d6,0.6);
dir.position.set(5,10,5); dir.castShadow=true;
scene.add(dir);

// Texturas básicas
function createCanvasTexture(drawFn, size=512){
    const canvas = document.createElement('canvas'); canvas.width=canvas.height=size;
    const ctx = canvas.getContext('2d');
    drawFn(ctx,size);
    const tex = new THREE.CanvasTexture(canvas);
    tex.wrapS=tex.wrapT=THREE.RepeatWrapping;
    return tex;
}
const velvetTex = createCanvasTexture((ctx,s)=>{ctx.fillStyle="#174938";ctx.fillRect(0,0,s,s);});

// Suelo
const floorMat = new THREE.MeshStandardMaterial({map: velvetTex, roughness:0.9});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(30,30), floorMat);
floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

// Objetos de juego
const bjTable = new THREE.Mesh(new THREE.CylinderGeometry(1.6,1.6,0.3,32), new THREE.MeshStandardMaterial({map:velvetTex}));
bjTable.position.set(-4,0.3,0); bjTable.userData.type='blackjack';
scene.add(bjTable);

const ruletaBase = new THREE.Mesh(new THREE.CylinderGeometry(1.2,1.2,0.4,64), new THREE.MeshStandardMaterial({color:0x222222}));
ruletaBase.position.set(0,0.2,0); ruletaBase.userData.type='roulette';
scene.add(ruletaBase);

const slot = new THREE.Mesh(new THREE.BoxGeometry(1,2,1), new THREE.MeshStandardMaterial({map:velvetTex}));
slot.position.set(4,1,0); slot.userData.type='slots';
scene.add(slot);

const npc = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,1.6,16), new THREE.MeshStandardMaterial({color:0x999999}));
npc.position.set(0,1,5); npc.userData.type='npc';
scene.add(npc);

const interact = [bjTable, ruletaBase, slot, npc];

// -------------------- Movimiento y cámara --------------------
const keys = {}; document.addEventListener('keydown', e=>keys[e.code]=true);
document.addEventListener('keyup', e=>keys[e.code]=false);
let yaw=0,pitch=0;
function updateCameraRotation(dt){
    if(keys['ArrowLeft']) yaw+=1.8*dt;
    if(keys['ArrowRight']) yaw-=1.8*dt;
    if(keys['ArrowUp']) pitch+=1.2*dt;
    if(keys['ArrowDown']) pitch-=1.2*dt;
    pitch=Math.max(-Math.PI/2+0.05,Math.min(Math.PI/2-0.05,pitch));
    camera.rotation.y=yaw; camera.rotation.x=pitch;
}
function updateCameraPosition(dt){
    const speed=3; const forward=new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3(); right.crossVectors(forward,camera.up).normalize();
    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward);
    if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right);
    if(keys['KeyA']) move.sub(right);
    move.multiplyScalar(speed*dt); camera.position.add(move);
}

// -------------------- Interacción --------------------
const ray = new THREE.Raycaster(); let lookingAt=null;
function checkInteraction(){
    ray.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
    const hits = ray.intersectObjects(interact,false);
    if(hits.length===0 || hits[0].distance>4){ lookingAt=null; return; }
    lookingAt=hits[0].object;
}
document.addEventListener('keydown', async e=>{
    if(e.code==='KeyE' && lookingAt){
        const type = lookingAt.userData.type;
        if(type==='npc'){ await claimDaily(); }
        else if(type==='blackjack'){ alert("Blackjack aún no implementado"); }
        else if(type==='roulette'){ alert("Ruleta aún no implementada"); }
        else if(type==='slots'){ alert("Slots aún no implementados"); }
    }
});

// -------------------- Animación --------------------
const clock = new THREE.Clock();
function animate(){
    requestAnimationFrame(animate);
    const dt = clock.getDelta();
    updateCameraPosition(dt);
    updateCameraRotation(dt);
    checkInteraction();
    renderer.render(scene,camera);
}
animate();

// -------------------- Resize --------------------
window.addEventListener('resize', ()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
