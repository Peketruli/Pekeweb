<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D - Clásico Mejorado</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; font-family:Arial, Helvetica, sans-serif; }
  #hint {
    position: absolute; left: 12px; top: 12px; z-index: 5;
    background: rgba(0,0,0,0.6); color: #fff; padding:8px 10px; border-radius:8px;
    font-size:13px;
  }
</style>
</head>
<body>
<div id="hint">🎰 Mover: W A S D — Mirar: ratón — Salir: E cerca de puerta</div>

<script>
// ---------- Escena, cámara, renderer ----------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x060304);
scene.fog = new THREE.FogExp2(0x060304,0.012);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,1.7,12); // spawn detrás de la mesa

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

// ---------- Texturas ----------
const loader = new THREE.TextureLoader();
const woodTex = loader.load('https://threejs.org/examples/textures/brick_diffuse.jpg');
const floorTex = loader.load('https://cdn.pixabay.com/photo/2016/11/21/15/55/pattern-1846866_1280.jpg');
floorTex.wrapS = floorTex.wrapT = THREE.RepeatWrapping;
floorTex.repeat.set(8,8);
const feltTex = createGreenFeltTexture();
const rouletteWood = loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');

// ---------- Luces ----------
scene.add(new THREE.AmbientLight(0xffecd6,0.45));
const dir = new THREE.DirectionalLight(0xffe0b5,0.6);
dir.position.set(5,20,10);
dir.castShadow = true;
scene.add(dir);

const spot1 = new THREE.SpotLight(0xffe6c2,0.9,30,Math.PI/6,0.4);
spot1.position.set(0,8,2);
spot1.castShadow = true;
scene.add(spot1);

const accent1 = new THREE.PointLight(0xffd8a8,0.7,12);
accent1.position.set(0,5,4);
scene.add(accent1);

// ---------- Suelo, techo, paredes ----------
const floorMat = new THREE.MeshStandardMaterial({ map: floorTex, roughness:0.9, metalness:0.02 });
const floor = new THREE.Mesh(new THREE.PlaneGeometry(80,80), floorMat);
floor.rotation.x = -Math.PI/2;
floor.receiveShadow = true;
scene.add(floor);

const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshStandardMaterial({ color:0x1b0d05, roughness:1 }));
ceiling.rotation.x = Math.PI/2; ceiling.position.y=7;
scene.add(ceiling);

const wallMat = new THREE.MeshStandardMaterial({ map: woodTex, roughness:1.0, metalness:0.05 });
const backWall = new THREE.Mesh(new THREE.BoxGeometry(40,8,0.8), wallMat); backWall.position.set(0,4,-30); scene.add(backWall);
const frontWall = backWall.clone(); frontWall.position.set(0,4,30); scene.add(frontWall);
const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.8,8,60), wallMat); leftWall.position.set(-20,4,0); scene.add(leftWall);
const rightWall = leftWall.clone(); rightWall.position.set(20,4,0); scene.add(rightWall);

// ---------- Puerta ----------
const doorMat = new THREE.MeshStandardMaterial({ color:0x6b3f1a, roughness:0.7 });
const door = new THREE.Mesh(new THREE.BoxGeometry(3,4,0.3), doorMat);
door.position.set(0,2,-29.6); scene.add(door);

// ---------- Mesa Blackjack ----------
const tableTop = new THREE.Mesh(new THREE.CylinderGeometry(4.2,4.2,0.4,32), new THREE.MeshStandardMaterial({ map: feltTex, roughness:0.8 }));
tableTop.position.set(0,0.6,6); tableTop.castShadow=true; scene.add(tableTop);

// Borde madera
const rim = new THREE.Mesh(new THREE.TorusGeometry(4.35,0.25,16,100), new THREE.MeshStandardMaterial({ color:0x4a2b12 }));
rim.rotation.x = Math.PI/2; rim.position.set(0,0.9,6); scene.add(rim);

// ---------- Ruleta horizontal ----------
const wheelGroup = new THREE.Group();
const wheelBase = new THREE.Mesh(new THREE.CylinderGeometry(2.2,2.2,0.6,48), new THREE.MeshStandardMaterial({ color:0x2f1608 }));
wheelBase.position.y = 0.5; wheelGroup.add(wheelBase);

const rimMesh = new THREE.Mesh(new THREE.TorusGeometry(2.4,0.18,16,100), new THREE.MeshStandardMaterial({ map: rouletteWood }));
rimMesh.rotation.x = Math.PI/2; rimMesh.position.y = 0.85; wheelGroup.add(rimMesh);

// Wheel plate
const wheelCanvas = document.createElement('canvas'); wheelCanvas.width=1024; wheelCanvas.height=1024; drawRouletteWheel(wheelCanvas);
const wheelTex = new THREE.CanvasTexture(wheelCanvas);
const wheelPlate = new THREE.Mesh(new THREE.CylinderGeometry(1.9,1.9,0.08,64), new THREE.MeshStandardMaterial({ map: wheelTex }));
wheelPlate.rotation.x = Math.PI/2; wheelPlate.position.y = 0.86; wheelGroup.add(wheelPlate);

wheelGroup.position.set(-10,0,8); wheelGroup.castShadow=true; scene.add(wheelGroup);

// ---------- Slots ----------
const machines = [];
for(let i=0;i<6;i++){
  const group = new THREE.Group();
  const body = new THREE.Mesh(new THREE.BoxGeometry(1.6,2.6,1.2), new THREE.MeshStandardMaterial({ color:0x2b1a14 }));
  body.position.y=1.3; group.add(body);

  const screenCanvas = document.createElement('canvas'); screenCanvas.width=256; screenCanvas.height=256;
  const sctx=screenCanvas.getContext('2d'); drawSlotScreen(sctx,["7","★","🍒","🔔","BAR"],0);
  const screenTex = new THREE.CanvasTexture(screenCanvas);
  const screenMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.8), new THREE.MeshBasicMaterial({ map: screenTex }));
  screenMesh.position.set(0,1.4,0.66); group.add(screenMesh);

  group.position.set(i*3 - 7.5,0,-12);
  group.userData={screenCanvas,sctx,screenTex,reels:["7","★","🍒","🔔","BAR"],spinning:false};
  group.castShadow=true; scene.add(group); machines.push(group);
}

// ---------- Movimiento cámara con colisiones ----------
let yaw=0, pitch=0, sens=0.0026;
window.addEventListener('mousemove',e=>{ yaw-=(e.movementX||0)*sens; pitch-=(e.movementY||0)*sens; pitch=Math.max(-Math.PI/2+0.05, Math.min(Math.PI/2-0.05,pitch)); });
const keys={};
window.addEventListener('keydown',e=>{ keys[e.code]=true; });
window.addEventListener('keyup',e=>{ keys[e.code]=false; });

const velocity = new THREE.Vector3();
const accel=30,damping=10;
const forwardVec = new THREE.Vector3();
const rightVec = new THREE.Vector3();
const upVec = new THREE.Vector3(0,1,0);
const clock = new THREE.Clock();

// Lista de objetos con colisión
const colliders = [tableTop, rim, wheelBase, backWall, frontWall, leftWall, rightWall, door];

function checkCollision(pos){
  const radius = 0.4; // tamaño del jugador
  for(const c of colliders){
    const min = new THREE.Vector3(); const max = new THREE.Vector3();
    c.geometry.computeBoundingBox(); c.geometry.boundingBox.getMin(min); c.geometry.boundingBox.getMax(max);
    min.add(c.position); max.add(c.position);
    if(pos.x+radius>min.x && pos.x-radius<max.x && pos.y+radius>min.y && pos.y-radius<max.y && pos.z+radius>min.z && pos.z-radius<max.z){
      return true;
    }
  }
  return false;
}

function updateMovement(dt){
  camera.rotation.set(pitch,yaw,0,"ZYX");
  camera.updateMatrixWorld();
  camera.getWorldDirection(forwardVec);
  forwardVec.y=0; forwardVec.normalize();
  rightVec.copy(forwardVec).cross(upVec).negate();

  let moveX=0, moveZ=0;
  if(keys['KeyW']) moveZ+=1;
  if(keys['KeyS']) moveZ-=1;
  if(keys['KeyD']) moveX-=1;
  if(keys['KeyA']) moveX+=1;

  const desired = new THREE.Vector3();
  desired.addScaledVector(forwardVec,moveZ);
  desired.addScaledVector(rightVec,moveX);
  if(desired.lengthSq()>0) desired.normalize();
  velocity.addScaledVector(desired,accel*dt);
  velocity.multiplyScalar(1/(1+damping*dt));

  const newPos = camera.position.clone().addScaledVector(velocity,dt);
  if(!checkCollision(newPos)) camera.position.copy(newPos);
}

// ---------- Slot screens ----------
let slotTick=0;
function animateSlotScreens(dt){
  slotTick+=dt*8;
  machines.forEach((m,idx)=>{
    const data = m.userData;
    const center = Math.floor((slotTick+idx*3)%data.reels.length);
    drawSlotScreen(data.sctx,data.reels,center);
    data.screenTex.needsUpdate=true;
  });
}

// ---------- Interacción puerta ----------
window.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='e'){
    if(camera.position.distanceTo(door.position)<3.2){
      window.location.href='h.html';
    }
  }
});

// ---------- Animación general ----------
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clock.getDelta(),0.05);
  updateMovement(dt);
  wheelGroup.rotation.y+=0.02;
  animateSlotScreens(dt);
  const t=Date.now()*0.001;
  accent1.intensity=0.65+Math.sin(t*1.3)*0.15;
  spot1.intensity=0.6+Math.sin(t*0.7)*0.1;
  renderer.render(scene,camera);
}
animate();

// ---------- Resize ----------
window.addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

// ---------- Helpers ----------
function createGreenFeltTexture(){
  const c=document.createElement('canvas'); c.width=c.height=512;
  const ctx=c.getContext('2d'); ctx.fillStyle='#0b5b35'; ctx.fillRect(0,0,c.width,c.height);
  for(let i=0;i<30000;i++){
    const x=Math.random()*c.width, y=Math.random()*c.height, a=Math.random()*30;
    ctx.fillStyle=`rgba(0,0,0,${a/255})`; ctx.fillRect(x,y,1,1);
  }
  const tex=new THREE.CanvasTexture(c); tex.wrapS=tex.wrapT=THREE.RepeatWrapping; tex.repeat.set(2,2); return tex;
}

function drawRouletteWheel(canvas){
  const ctx=canvas.getContext('2d'); const size=canvas.width;
  ctx.fillStyle='#3b2b20'; ctx.fillRect(0,0,size,size);
  const cx=size/2,cy=size/2,r=size*0.42;
  const segments=18;
  for(let i=0;i<segments;i++){
    ctx.beginPath();
    const start=(i/segments)*Math.PI*2, end=((i+1)/segments)*Math.PI*2;
    ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
    ctx.fillStyle=(i%2===0)?'#9b0000':'#000000'; ctx.fill();
  }
  ctx.beginPath(); ctx.fillStyle='#222'; ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.fillStyle='#d1c6b3'; ctx.arc(cx,cy,r*0.12,0,Math.PI*2); ctx.fill();
}

function drawSlotScreen(ctx,reels,centerIndex){
  ctx.clearRect(0,0,256,256); ctx.fillStyle='#080300'; ctx.fillRect(0,0,256,256);
  ctx.fillStyle='#ffd27f'; ctx.fillRect(8,8,240,240);
  ctx.fillStyle='#000'; ctx.fillRect(12,12,232,232);
  ctx.font='48px serif'; ctx.textAlign='center'; ctx.fillStyle='#fff';
  for(let col=0;col<3;col++){ const sym=reels[(centerIndex+col)%reels.length]; ctx.fillText(sym,40+col*85,130); }
  ctx.strokeStyle='rgba(255,215,140,0.18)'; ctx.lineWidth=6; ctx.strokeRect(8,8,240,240);
}
</script>
</body>
</html>
