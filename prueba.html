<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10;max-height:70vh;overflow:auto}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';

const supabase = supabase.createClient
    ? supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
    : window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// -------------------- USUARIO --------------------
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
if(!currentUser){ alert("Debes iniciar sesiÃ³n para jugar."); throw "Usuario no identificado"; }
let balance = currentUser.pekepuntos || 0;
document.getElementById("pekepuntos").textContent = `Pekepuntos: ${balance}`;

// -------------------- Helpers --------------------
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
async function saveBalance(){
    try{
        await supabase.from("usuarios").update({ pekepuntos: balance }).eq("id", currentUser.id);
        currentUser.pekepuntos = balance;
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        document.getElementById("pekepuntos").textContent = `Pekepuntos: ${balance}`;
    }catch(err){ alert("Error guardando balance: "+err.message); }
}

// -------------------- Juegos --------------------
async function playBlackjack(bet=50){
    if(balance<bet){ alert("No tienes suficientes Pekepuntos."); return; }
    let player = rand(15,21);
    let dealer = rand(16,21);
    let win=false;
    if(player>21) win=false;
    else if(dealer>21 || player>dealer) win=true;
    else if(player===dealer) win=null;
    if(win===true){ balance+=bet; alert(`Ganaste! Tu: ${player} / Dealer: ${dealer}`); }
    else if(win===false){ balance-=bet; alert(`Perdiste! Tu: ${player} / Dealer: ${dealer}`); }
    else alert(`Empate! Tu: ${player} / Dealer: ${dealer}`);
    await saveBalance();
}

async function playRoulette(bet=50){
    if(balance<bet){ alert("No tienes suficientes Pekepuntos."); return; }
    const number = rand(0,36);
    const choice = prompt("Apuesta a un nÃºmero (0-36)");
    if(choice===null) return;
    if(Number(choice)===number){ balance+=bet*35; alert(`Â¡NÃºmero ${number}! Ganaste x35`); }
    else{ balance-=bet; alert(`SaliÃ³ ${number}, perdiste.`); }
    await saveBalance();
}

async function playSlots(bet=50){
    if(balance<bet){ alert("No tienes suficientes Pekepuntos."); return; }
    const reels = [rand(0,5), rand(0,5), rand(0,5)];
    const symbols = ['ðŸ’','ðŸ‹','ðŸŠ','ðŸ‡','ðŸ’Ž','7ï¸âƒ£'];
    const result = reels.map(r=>symbols[r]).join(' | ');
    let win=false;
    if(reels[0]===reels[1] && reels[1]===reels[2]) win=true;
    if(win){ balance+=bet*5; alert(`${result} â†’ Â¡Ganaste x5!`); }
    else{ balance-=bet; alert(`${result} â†’ Perdiste.`); }
    await saveBalance();
}

// -------------------- Recompensa diaria --------------------
async function claimDaily(){
    const today = new Date().toISOString().slice(0,10);
    const lastClaim = currentUser.last_claim ? currentUser.last_claim.slice(0,10) : null;
    if(lastClaim===today){ alert("Ya reclamaste hoy."); return; }
    balance+=100; currentUser.last_claim=new Date().toISOString();
    await saveBalance();
    await supabase.from("usuarios").update({ pekepuntos: balance, last_claim: currentUser.last_claim }).eq("id", currentUser.id);
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
    alert("Â¡Recompensa diaria: +100 Pekepuntos!");
}

// -------------------- Escena 3D --------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0f1a);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 1.6, 5);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

// Luces
const hemi = new THREE.HemisphereLight(0xffffff,0x222233,0.8); hemi.position.set(0,50,0); scene.add(hemi);
scene.add(new THREE.AmbientLight(0xffffff,0.25));
const dir = new THREE.DirectionalLight(0xfff6d6,0.6); dir.position.set(5,10,5); scene.add(dir);

// -------------------- Texturas simples --------------------
function createTexture(color1,color2){
    const canvas=document.createElement('canvas'); canvas.width=canvas.height=512;
    const ctx=canvas.getContext('2d');
    const grad=ctx.createLinearGradient(0,0,512,512);
    grad.addColorStop(0,color1); grad.addColorStop(1,color2);
    ctx.fillStyle=grad; ctx.fillRect(0,0,512,512);
    return new THREE.CanvasTexture(canvas);
}

// Suelo
const floorMat = new THREE.MeshStandardMaterial({map:createTexture('#2a0033','#550077'), roughness:0.9});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(30,30), floorMat);
floor.rotation.x=-Math.PI/2; scene.add(floor);

// -------------------- Objetos de juego --------------------
const interactables=[];
function addTable(x,y,type){
    const mat=new THREE.MeshStandardMaterial({map:createTexture('#222','#550')});
    const geom=type==='slots'? new THREE.BoxGeometry(1,2,1) : new THREE.CylinderGeometry(1.5,1.5,0.3,32);
    const mesh=new THREE.Mesh(geom,mat);
    mesh.position.set(x,y,0);
    mesh.userData.type=type;
    scene.add(mesh);
    interactables.push(mesh);
}

addTable(-4,0.3,'blackjack');
addTable(0,0.2,'roulette');
addTable(4,1,'slots');

// -------------------- Movimiento cÃ¡mara --------------------
const keys={}; document.addEventListener('keydown',e=>keys[e.code]=true);
document.addEventListener('keyup',e=>keys[e.code]=false);
let yaw=0,pitch=0;
function updateCamera(dt){
    if(keys['ArrowLeft']) yaw+=1.8*dt; if(keys['ArrowRight']) yaw-=1.8*dt;
    if(keys['ArrowUp']) pitch+=1.2*dt; if(keys['ArrowDown']) pitch-=1.2*dt;
    pitch=Math.max(-Math.PI/2+0.05,Math.min(Math.PI/2-0.05,pitch));
    camera.rotation.y=yaw; camera.rotation.x=pitch;

    const forward=new THREE.Vector3(); camera.getWorldDirection(forward); forward.y=0; forward.normalize();
    const right=new THREE.Vector3(); right.crossVectors(forward,camera.up).normalize();
    const move=new THREE.Vector3();
    if(keys['KeyW']) move.add(forward);
    if(keys['KeyS']) move.sub(forward);
    if(keys['KeyD']) move.add(right);
    if(keys['KeyA']) move.sub(right);
    move.multiplyScalar(3*dt); camera.position.add(move);
}

// -------------------- InteracciÃ³n --------------------
const ray=new THREE.Raycaster(); let lookingAt=null;
function checkInteraction(){
    ray.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
    const hits=ray.intersectObjects(interactables,false);
    if(hits.length===0 || hits[0].distance>4){ lookingAt=null; return; }
    lookingAt=hits[0].object;
}

document.addEventListener('keydown', async e=>{
    if(e.code==='KeyE' && lookingAt){
        const t=lookingAt.userData.type;
        if(t==='blackjack') await playBlackjack(50);
        else if(t==='roulette') await playRoulette(50);
        else if(t==='slots') await playSlots(50);
    }
});

// -------------------- AnimaciÃ³n --------------------
const clock=new THREE.Clock();
function animate(){ requestAnimationFrame(animate); const dt=clock.getDelta(); updateCamera(dt); checkInteraction(); renderer.render(scene,camera);}
animate();

// -------------------- Resize --------------------
window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
