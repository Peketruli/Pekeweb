<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Casino 3D - Peketruli</title>
  <!-- Three.js and PointerLockControls from CDN -->
  <script src="https://unpkg.com/three@0.163.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.163.0/examples/js/controls/PointerLockControls.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
    #container{width:100%;height:100%;position:relative;background:#111}
    canvas{display:block}

    /* UI overlays */
    .hud{position:absolute;left:12px;top:12px;color:#fff;z-index:5;}
    #pekepoints{background:rgba(0,0,0,0.5);padding:10px;border-radius:8px}
    #minimap{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.5);padding:6px;border-radius:8px;z-index:5}
    #prompt{position:absolute;left:50%;bottom:60px;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:6px;color:#fff;display:none;z-index:6}

    /* Modal */
    .modal{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#222;color:#fff;padding:16px;border-radius:8px;z-index:10;display:none;min-width:320px}
    .modal h2{margin:0 0 8px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
    .btn{background:#0a74ff;padding:8px 12px;border-radius:6px;border:none;color:white;cursor:pointer}
    .close{background:#444}

    /* Interaction hint */
    #hint{position:absolute;left:12px;bottom:12px;color:#eee;z-index:5}
    /* Small crosshair */
    #crosshair{position:absolute;left:50%;top:50%;width:8px;height:8px;margin:-4px 0 0 -4px;border-radius:50%;background:rgba(255,255,255,0.6);z-index:4}

    /* Simple responsive */
    @media (max-width:600px){.modal{min-width:90%}}
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="crosshair"></div>
  <div class="hud">
    <div id="pekepoints">Pekepoints: <span id="ppValue">1000</span></div>
  </div>
  <canvas id="mapCanvas" width="180" height="180" style="position:absolute;right:12px;top:12px;z-index:7;border-radius:6px;background:#111"></canvas>
  <div id="prompt">Presiona <b>E</b> para interactuar</div>
  <div id="hint">WASD mover • Shift correr • Barra espacio saltar • Click para bloquear ratón</div>

  <!-- Blackjack modal -->
  <div id="blackjack" class="modal">
    <h2>Blackjack</h2>
    <div>Tu apuesta: <input id="bjBet" type="number" value="10" min="1" style="width:80px"></div>
    <div class="controls">
      <button id="bjPlay" class="btn">Jugar</button>
      <button id="bjClose" class="btn close">Cerrar</button>
    </div>
    <div id="bjResult" style="margin-top:8px"></div>
  </div>

  <!-- Roulette modal -->
  <div id="roulette" class="modal">
    <h2>Ruleta</h2>
    <div>Tu apuesta (número 0-36): <input id="rNum" type="number" value="7" min="0" max="36" style="width:80px"></div>
    <div>Tu apuesta (cantidad): <input id="rBet" type="number" value="10" min="1" style="width:80px"></div>
    <div class="controls">
      <button id="rPlay" class="btn">Girar</button>
      <button id="rClose" class="btn close">Cerrar</button>
    </div>
    <div id="rResult" style="margin-top:8px"></div>
  </div>

  <!-- Slot modal -->
  <div id="slots" class="modal">
    <h2>Tragaperras</h2>
    <div>Apuesta: <input id="sBet" type="number" value="5" min="1" style="width:80px"></div>
    <div class="controls">
      <button id="sPlay" class="btn">Girar</button>
      <button id="sClose" class="btn close">Cerrar</button>
    </div>
    <div id="sResult" style="margin-top:8px"></div>
  </div>

<script>
// --- CASINO 3D COMPLETO ---
let scene, camera, renderer, controls;
let objects = [];
let move = {forward:false,back:false,left:false,right:false,run:false};
let velocity = new THREE.Vector3();
let canJump = false;
let prevTime = performance.now();
let playerHeight = 1.8;
let pekepoints = 1000;
const container = document.getElementById('container');
const ppValue = document.getElementById('ppValue');
ppValue.textContent = pekepoints;

init();
animate();

function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x222233);

  camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0, playerHeight, 6);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);

  const hemi = new THREE.HemisphereLight(0xffffff,0x444444,1.0);
  hemi.position.set(0,50,0);
  scene.add(hemi);

  const dir = new THREE.DirectionalLight(0xffffff,1.2);
  dir.position.set(-10,20,10);
  scene.add(dir);

  const floorGeo = new THREE.PlaneGeometry(60,60);
  const floorMat = new THREE.MeshStandardMaterial({color:0x555566});
  const floor = new THREE.Mesh(floorGeo,floorMat);
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  buildCorridorAndRoom();

  addBlackjackTable(new THREE.Vector3(0,0,-6));
  addRoulette(new THREE.Vector3(6,0,-6));
  addSlots(new THREE.Vector3(-6,0,-6));
  addDoor(new THREE.Vector3(0,0,10));

  controls = new THREE.PointerLockControls(camera, document.body);
  document.addEventListener('click', ()=>{ controls.lock(); }, false);

  scene.add(controls.getObject());
  controls.getObject().position.set(0, playerHeight, 6);
  controls.getObject().lookAt(0, playerHeight, 0);

  const onKeyDown = e => {
    switch(e.code){
      case 'KeyW': move.forward=true; break;
      case 'KeyA': move.left=true; break;
      case 'KeyS': move.back=true; break;
      case 'KeyD': move.right=true; break;
      case 'ShiftLeft': move.run=true; break;
      case 'Space': if(canJump){velocity.y+=6;canJump=false;} break;
      case 'KeyE': tryInteract(); break;
    }
  };
  const onKeyUp = e => {
    switch(e.code){
      case 'KeyW': move.forward=false; break;
      case 'KeyA': move.left=false; break;
      case 'KeyS': move.back=false; break;
      case 'KeyD': move.right=false; break;
      case 'ShiftLeft': move.run=false; break;
    }
  };
  document.addEventListener('keydown',onKeyDown);
  document.addEventListener('keyup',onKeyUp);

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  setupMiniMap();
}

function buildCorridorAndRoom(){
  const wallMat = new THREE.MeshStandardMaterial({color:0x888899});
  const corridorWidth = 4;
  const corridorLength = 12;
  const corridorHeight = 3;

  const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.2,corridorHeight,corridorLength),wallMat);
  leftWall.position.set(-corridorWidth/2,corridorHeight/2,6);
  scene.add(leftWall);

  const rightWall = leftWall.clone();
  rightWall.position.set(corridorWidth/2,corridorHeight/2,6);
  scene.add(rightWall);

  const ceiling = new THREE.Mesh(new THREE.BoxGeometry(corridorWidth,0.2,corridorLength),wallMat);
  ceiling.position.set(0,corridorHeight,6);
  scene.add(ceiling);

  const roomFloor = new THREE.Mesh(new THREE.BoxGeometry(12,0.1,12), new THREE.MeshStandardMaterial({color:0x333344}));
  roomFloor.position.set(0,0,-6);
  scene.add(roomFloor);
}

function addBlackjackTable(pos){
  const table = new THREE.Mesh(new THREE.CylinderGeometry(1.6,1.6,0.4,24), new THREE.MeshStandardMaterial({color:0x003300}));
  table.position.copy(pos); table.position.y=0.2; scene.add(table);
  objects.push({type:'blackjack',pos:pos,range:2});
}

function addRoulette(pos){
  const base = new THREE.Mesh(new THREE.CylinderGeometry(1.6,1.6,0.6,32), new THREE.MeshStandardMaterial({color:0x552200}));
  base.position.copy(pos); base.position.y=0.3; scene.add(base);
  const wheel = new THREE.Mesh(new THREE.CylinderGeometry(1.3,1.3,0.1,36), new THREE.MeshStandardMaterial({color:0x222222}));
  wheel.position.copy(pos); wheel.position.y=0.7; wheel.rotation.x=Math.PI/2; scene.add(wheel);
  objects.push({type:'roulette',pos:pos,range:2.2});
}

function addSlots(pos){
  const body = new THREE.Mesh(new THREE.BoxGeometry(1,1.6,0.6), new THREE.MeshStandardMaterial({color:0x880033}));
  body.position.copy(pos); body.position.y=0.8; scene.add(body);
  objects.push({type:'slots',pos:pos,range:2});
}

function addDoor(pos){
  const door = new THREE.Mesh(new THREE.BoxGeometry(1.6,2.2,0.1), new THREE.MeshStandardMaterial({color:0x4444aa}));
  door.position.copy(pos); door.position.y=1.1; scene.add(door);
  objects.push({type:'door',pos:pos,range:2});
}

function tryInteract(){
  const origin = controls.getObject().position;
  let nearest=null; let nd=Infinity;
  for(const o of objects){
    const d=o.pos.distanceTo(origin);
    if(d<o.range && d<nd){nearest=o;nd=d;}
  }
  if(!nearest)return;
  switch(nearest.type){
    case 'blackjack': showModal('blackjack'); break;
    case 'roulette': showModal('roulette'); break;
    case 'slots': showModal('slots'); break;
    case 'door': window.location.href='h.html'; break;
  }
}

function showModal(id){document.getElementById(id).style.display='block';controls.unlock();document.body.style.cursor='auto';}
function closeModal(id){document.getElementById(id).style.display='none';}

// Blackjack
bjPlay.onclick=()=>{
  const bet=+bjBet.value||1;
  if(bet>pekepoints){bjResult.textContent='No tienes puntos.';return;}
  const p=Math.floor(Math.random()*11)+11;
  const d=Math.floor(Math.random()*11)+11;
  let res='Empate';
  if(p>21)res='Pierdes'; else if(p>d){res='Ganas';pekepoints+=bet;} else if(p<d){res='Pierdes';pekepoints-=bet;}
  bjResult.textContent=`Tú:${p} Crupier:${d} ${res}`;
  updatePP();
};
bjClose.onclick=()=>closeModal('blackjack');

// Ruleta
rPlay.onclick=()=>{
  const n=+rNum.value||0;const bet=+rBet.value||1;
  if(bet>pekepoints){rResult.textContent='Sin puntos';return;}
  const out=Math.floor(Math.random()*37);
  let t=`Sale ${out}. `;
  if(out===n){pekepoints+=bet*35;t+='Ganaste!';}else{pekepoints-=bet;t+='Perdiste.';}
  rResult.textContent=t;updatePP();
};
rClose.onclick=()=>closeModal('roulette');

// Slots
sPlay.onclick=()=>{
  const bet=+sBet.value||1;
  if(bet>pekepoints){sResult.textContent='Sin puntos';return;}
  const sym=['🍒','🔔','⭐','7'];
  const a=sym[Math.random()*sym.length|0];
  const b=sym[Math.random()*sym.length|0];
  const c=sym[Math.random()*sym.length|0];
  let t=`${a} ${b} ${c} `;
  if(a===b&&b===c){pekepoints+=bet*10;t+='Gran premio!';}
  else if(a===b||b===c||a===c){pekepoints+=bet*2;t+='Pequeña victoria';}
  else{pekepoints-=bet;t+='Perdiste';}
  sResult.textContent=t;updatePP();
};
sClose.onclick=()=>closeModal('slots');

function updatePP(){ppValue.textContent=pekepoints;}

function animate(){
  requestAnimationFrame(animate);
  const time=performance.now();
  const delta=(time-prevTime)/1000;
  if(controls.isLocked===true){
    const speed=move.run?10:4;
    velocity.x-=velocity.x*10*delta;
    velocity.z-=velocity.z*10*delta;
    velocity.y-=9.8*5*delta;
    if(move.forward)velocity.z-=speed*delta;
    if(move.back)velocity.z+=speed*delta;
    if(move.left)velocity.x-=speed*delta;
    if(move.right)velocity.x+=speed*delta;
    controls.getObject().translateX(velocity.x);
    controls.getObject().translateY(velocity.y*delta);
    controls.getObject().translateZ(velocity.z);
    if(controls.getObject().position.y<playerHeight){velocity.y=0;controls.getObject().position.y=playerHeight;canJump=true;}
  }
  prevTime=time;
  renderer.render(scene,camera);
  updateInteractionPrompt();
  drawMiniMap();
}

function updateInteractionPrompt(){
  const origin=controls.getObject().position;let near=false;
  for(const o of objects){if(o.pos.distanceTo(origin)<o.range){near=true;break;}}
  document.getElementById('prompt').style.display=near?'block':'none';
}

let mapCanvas,mapCtx;
function setupMiniMap(){mapCanvas=document.getElementById('mapCanvas');mapCtx=mapCanvas.getContext('2d');}
function drawMiniMap(){if(!mapCtx)return;const w=mapCanvas.width,h=mapCanvas.height;mapCtx.fillStyle='#0b0b0b';mapCtx.fillRect(0,0,w,h);const scale=6,cx=w/2,cy=h/2;mapCtx.strokeStyle='#666';mapCtx.lineWidth=2;mapCtx.strokeRect(cx-60,cy-60,120,120);for(const o of objects){const x=cx+o.pos.x*scale,y=cy-o.pos.z*scale;mapCtx.fillStyle=o.type==='blackjack'?'#0f0':o.type==='roulette'?'#ff0':o.type==='slots'?'#f0f':'#fff';mapCtx.beginPath();mapCtx.arc(x,y,6,0,Math.PI*2);mapCtx.fill();}const p=controls.getObject().position;const px=cx+p.x*scale,py=cy-p.z*scale;mapCtx.fillStyle='#00f';mapCtx.beginPath();mapCtx.arc(px,py,6,0,Math.PI*2);mapCtx.fill();}
</script>
</body>
</html>
