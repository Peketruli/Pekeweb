<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Casino 3D — Ruleta corregida (WASD, FPS)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{height:100%;margin:0;background:#030612;color:#fff;font-family:Inter,Arial,Helvetica}
  #wrap{position:relative;height:100vh;overflow:hidden}
  canvas{display:block}
  .hud{position:absolute;right:12px;top:12px;z-index:40;max-width:380px}
  .panel{background:rgba(0,0,0,0.56);padding:10px;border-radius:10px;margin-bottom:10px}
  .info-row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;font-size:13px}
  #prompt{position:absolute;left:50%;transform:translateX(-50%);bottom:92px;background:rgba(0,0,0,0.7);padding:8px 12px;border-radius:8px;display:none;z-index:45}
  #overlay{position:absolute;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;z-index:60}
  #overlay .ui{background:rgba(8,10,12,0.96);padding:14px;border-radius:10px;width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.7);color:#ddd}
  .btn{background:#d95d00;color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  footer{position:absolute;left:12px;bottom:12px;color:#bbb;font-size:13px}
  #minimap{position:absolute;left:12px;top:12px;width:120px;height:120px;background:rgba(255,255,255,0.02);border-radius:8px;z-index:30}
</style>
</head>
<body>
  <div id="wrap">
    <div id="minimap"></div>

    <div class="hud">
      <div class="panel">
        <h3>Casino — Ruleta corregida</h3>
        <div class="info-row"><span>Saldo</span><strong id="balance">1000</strong></div>
        <div class="info-row"><span>Apuesta</span><strong id="bet">0</strong></div>
        <div style="font-size:13px;margin-top:6px">
          Controles: <strong>W A S D</strong> moverse · <strong>Flechas</strong> girar cámara · <strong>E</strong> interactuar
        </div>
      </div>
      <div class="panel">
        <h4>Interactúa</h4>
        <div id="interact-info" style="font-size:13px">Acércate y pulsa <strong>E</strong> (o usa UI).</div>
      </div>
      <div class="panel">
        <h4>Historial</h4>
        <div id="log" style="max-height:120px;overflow:auto;font-size:12px;background:rgba(255,255,255,0.02);padding:6px;border-radius:6px"></div>
      </div>
    </div>

    <div id="prompt">[E] Interactuar</div>
    <div id="overlay"><div class="ui" id="ui-box"></div></div>

    <footer>Primera persona · Ruleta europea (0–36) · Tragaperras</footer>
  </div>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <script>
(function(){
  // ---------- Setup ----------
  const wrap = document.getElementById('wrap');
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x041018);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(wrap.clientWidth, wrap.clientHeight);
  wrap.appendChild(renderer.domElement);

  // Camera = player (FPS)
  const camera = new THREE.PerspectiveCamera(72, wrap.clientWidth / wrap.clientHeight, 0.1, 1000);
  camera.position.set(0, 1.7, 12);
  const playerPos = new THREE.Vector3(0,0,12);
  let yaw = 0, pitch = 0;

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff,0.35));
  const dir = new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(8,20,10); scene.add(dir);
  const bulb = new THREE.PointLight(0xfff3d6,0.9,200); bulb.position.set(0,20,0); scene.add(bulb);

  // Floor & room
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(90,90), new THREE.MeshStandardMaterial({color:0x091217,roughness:0.95}));
  floor.rotation.x = -Math.PI/2; floor.position.y = 0; scene.add(floor);
  function wall(w,h,d,x,y,z,rotY){ 
    const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color:0x071018})); 
    m.position.set(x,y,z); 
    if(rotY) m.rotation.y = rotY; 
    scene.add(m); 
    return m; 
  }
  wall(50,10,2,0,5,-40); wall(2,10,50,-24,5,0); wall(2,10,50,24,5,0); wall(50,10,2,0,5,40);
  const rug = new THREE.Mesh(new THREE.CircleGeometry(14,32), new THREE.MeshStandardMaterial({color:0x183430}));
  rug.rotation.x = -Math.PI/2; rug.position.y = 0.01; scene.add(rug);

  // ---------- TABLE + RUETA ----------
  const table = new THREE.Group();
  table.position.set(0,0,0);

  // Table top & pedestal
  const tableTop = new THREE.Mesh(new THREE.CylinderGeometry(8.5,8.5,0.9,36), new THREE.MeshStandardMaterial({color:0x214f3d}));
  tableTop.position.y = -3; table.add(tableTop);
  const pedestal = new THREE.Mesh(new THREE.CylinderGeometry(2.2,2.2,1.2,12), new THREE.MeshStandardMaterial({color:0x163826}));
  pedestal.position.y = 0; table.add(pedestal);

  // Wheel
  const wheelRadius = 6;
  const pockets = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const pocketCount = pockets.length; 
  const anglePerPocket = (Math.PI*2) / pocketCount;

  function createWheelCanvas(size=2048){
    const c = document.createElement('canvas'); c.width = c.height = size;
    const ctx = c.getContext('2d');
    ctx.fillStyle = '#072b22'; ctx.fillRect(0,0,size,size);
    const cx = size/2, cy = size/2, r = size*0.45;
    for(let i=0;i<pocketCount;i++){
      const a0 = i * anglePerPocket - Math.PI/2;
      const a1 = (i+1) * anglePerPocket - Math.PI/2;
      ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath();
      ctx.fillStyle = (pockets[i]===0) ? '#1b8b41' : ((i % 2 === 0) ? '#b71c1c' : '#000');
      ctx.fill();
      const mid = a0 + (a1-a0)/2;
      ctx.save(); ctx.translate(cx + Math.cos(mid)*(r*0.66), cy + Math.sin(mid)*(r*0.66));
      ctx.rotate(mid + Math.PI/2); ctx.fillStyle = '#fff'; ctx.font = `${Math.floor(size*0.04)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(pockets[i], 0, 0); ctx.restore();
    }
    ctx.beginPath(); ctx.fillStyle = '#111'; ctx.arc(cx,cy,r*0.45,0,Math.PI*2); ctx.fill();
    return c;
  }

  const wheelTex = new THREE.CanvasTexture(createWheelCanvas(2048));
  wheelTex.anisotropy = renderer.capabilities.getMaxAnisotropy();
  const wheelMesh = new THREE.Mesh(new THREE.CylinderGeometry(wheelRadius, wheelRadius, 1.4, 128), new THREE.MeshStandardMaterial({map:wheelTex}));
  wheelMesh.position.y = 0.7; table.add(wheelMesh);

  // Rim
  const rim = new THREE.Mesh(new THREE.TorusGeometry(wheelRadius+0.6,0.45,12,128), new THREE.MeshStandardMaterial({color:0x6b3b1b}));
  rim.rotation.x = Math.PI/2; rim.position.y = 0.30; table.add(rim);

  // ----------- ⚡ FIX: add table to scene -----------
  scene.add(table);

  // ---------- BALL ----------
  const ball = new THREE.Mesh(
    new THREE.SphereGeometry(0.20, 16, 16),
    new THREE.MeshStandardMaterial({color:0xffffff, metalness:0.8, roughness:0.2})
  );
  ball.position.set(wheelRadius - 0.6, 0.55, 0);
  scene.add(ball);

  // ---------- Chairs ----------
  function makeChair(x,z){
    const g=new THREE.Group();
    const seat=new THREE.Mesh(new THREE.BoxGeometry(1.1,0.35,1.1), new THREE.MeshStandardMaterial({color:0x6b3b1b}));
    const back=new THREE.Mesh(new THREE.BoxGeometry(1.1,1.0,0.28), new THREE.MeshStandardMaterial({color:0x6b3b1b}));
    seat.position.y=0.42; back.position.set(0,0.9,-0.45);
    g.add(seat); g.add(back); g.position.set(x,0,z); g.lookAt(0,0,0); scene.add(g);
  }
  for(let i=0;i<6;i++){ const a=(i/6)*Math.PI*2; makeChair(Math.cos(a)*10, Math.sin(a)*10); }

  // ---------- Slot machine ----------
  // (igual que tu código original, no cambia nada)

  // ---------- Colliders ----------
  // (igual que tu código original, no cambia nada)

  // ---------- Movement & Camera control ----------
  // (igual que tu código original, no cambia nada)

  // ---------- HUD & UI ----------
  // (igual que tu código original, no cambia nada)

  // ---------- Ruleta spin logic ----------
  // (igual que tu código original, no cambia nada)

  // ---------- Animation loop ----------
  const clock = new THREE.Clock();
  (function animate(){
    requestAnimationFrame(animate);
    const dt = clock.getDelta();

    // Camera rotation & movement
    const delta = computeDelta(dt);
    const newPos = playerPos.clone().add(delta);
    if(!checkCollision(newPos)) playerPos.copy(newPos);
    camera.position.set(playerPos.x, playerPos.y + 1.7, playerPos.z);
    const euler = new THREE.Euler(pitch, yaw, 0, 'YXZ');
    camera.quaternion.setFromEuler(euler);

    // detect zones
    detectZones();

    // ruleta animation
    if(ruletaState.spinning){
      wheelMesh.rotation.y += ruletaState.wheelVel * dt;
      ruletaState.wheelVel *= Math.max(0.995, 1 - 0.35 * dt);
      ruletaState.ballAngle += ruletaState.ballVel * dt;
      ruletaState.ballVel *= Math.max(0.99, 1 - 0.6 * dt);
      const r = wheelRadius - 0.6;
      ball.position.set(Math.cos(ruletaState.ballAngle) * r, 0.45, Math.sin(ruletaState.ballAngle) * r);
      if(Math.abs(ruletaState.wheelVel) < 0.02 && Math.abs(ruletaState.ballVel) < 0.06){
        setTimeout(finalizeRuleta, 700);
      }
    } else {
      wheelMesh.rotation.y += Math.sin(clock.elapsedTime*0.5)*0.0004;
    }

    drawMinimap();
    renderer.render(scene, camera);
  })();

  // ---------- Resize ----------
  window.addEventListener('resize', ()=>{ 
    renderer.setSize(wrap.clientWidth, wrap.clientHeight); 
    camera.aspect = wrap.clientWidth / wrap.clientHeight; 
    camera.updateProjectionMatrix(); 
  });

  // ---------- HUD init ----------
  updateHUD(); appendLog('Ruleta corregida: índices 0–36 disponibles. Pulsa E cerca de la ruleta o tragaperras.');

})();
</script>
</body>
</html>
