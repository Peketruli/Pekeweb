<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Casino 3D â€” Mejorado</title>
<style>
  :root{--bg:#0b0f1a;--panel:#101625;--accent:#f5b642;--muted:#9aa5b1}
  html,body{height:100%;margin:0;font-family:Arial;background:var(--bg);color:white;overflow:hidden}
  #container{width:100%;height:100%}
  #ui{position:absolute;top:10px;left:10px;z-index:5}
  .panel{background:rgba(0,0,0,0.4);padding:10px;border-radius:8px;margin-bottom:8px}
  #modal{position:absolute;right:20px;top:20px;width:380px;background:var(--panel);padding:14px;border-radius:12px;display:none;z-index:10;max-height:70vh;overflow:auto}
  #npcMsg{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;display:none}
  button,input,select{background:#182034;color:white;border:1px solid #334;padding:6px;border-radius:6px;margin:4px 0}
  .gameUI h2{margin:0 0 8px 0}
</style>
</head>
<body>
<div id="container"></div>
<div id="ui">
  <div class="panel">Saldo: <span id="balance">1000</span> â‚¬</div>
  <div class="panel">Pulsa <b>E</b> para interactuar</div>
</div>
<div id="modal"></div>
<div id="npcMsg">Pulsa E para recoger fichas diarias</div>

<!-- three.js (min) -->
<script src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>

<script>
(async function main() {
  // ---------- Config Supabase ----------
  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';

  if (!window.supabase) {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/@supabase/supabase-js';
      s.onload = res;
      s.onerror = rej;
      document.head.appendChild(s);
    }).catch(e => alert('Error cargando Supabase: ' + e));
  }

  let supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

  // ---------- Helpers ----------
  const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const container = document.getElementById('container');
  const balanceSpan = document.getElementById('balance');
  let pekepuntosEl = document.getElementById('pekepuntos');
  const npcMsgEl = document.getElementById('npcMsg');

  if (!pekepuntosEl) {
    pekepuntosEl = document.createElement('div');
    pekepuntosEl.id = 'pekepuntos';
    pekepuntosEl.style.marginTop = '8px';
    pekepuntosEl.style.fontSize = '1rem';
    pekepuntosEl.textContent = 'Pekepuntos: 0';
    document.getElementById('ui').appendChild(pekepuntosEl);
  }

  let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!currentUser) { alert('Debes iniciar sesiÃ³n.'); return; }

  let balance = Number(currentUser.pekepuntos || 0);
  function refreshBalanceUI() {
    balanceSpan.textContent = balance;
    pekepuntosEl.textContent = `Pekepuntos: ${balance}`;
  }
  refreshBalanceUI();

  async function saveBalance() {
    if (supabase) {
      const { error } = await supabase.from('usuarios').update({ pekepuntos: balance }).eq('id', currentUser.id);
      if (error) alert('Error guardando en Supabase: ' + error.message);
    }
    currentUser.pekepuntos = balance;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshBalanceUI();
  }

  async function claimDaily() {
    const today = new Date().toISOString().slice(0, 10);
    const last = currentUser.last_claim ? currentUser.last_claim.slice(0, 10) : null;
    if (last === today) { alert('Ya reclamaste hoy.'); return; }
    balance += 100;
    currentUser.last_claim = new Date().toISOString();
    if (supabase) await supabase.from('usuarios').update({ pekepuntos: balance, last_claim: currentUser.last_claim }).eq('id', currentUser.id);
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshBalanceUI();
    if (npcMsgEl) { npcMsgEl.innerText = 'Â¡Has recogido tus fichas diarias!'; npcMsgEl.style.display = 'block'; setTimeout(() => npcMsgEl.style.display = 'none', 1400); }
    alert('Â¡+100 Pekepuntos!');
  }

  async function playBlackjack(bet = 50) {
    if (balance < bet) { alert('Saldo insuficiente'); return; }
    const player = rand(15, 21), dealer = rand(16, 21);
    let result;
    if (player > 21) result = 'lose';
    else if (dealer > 21 || player > dealer) result = 'win';
    else if (player === dealer) result = 'tie';
    else result = 'lose';

    if (result === 'win') { balance += bet; alert(`Â¡Ganaste Blackjack! Tu:${player} Dealer:${dealer} +${bet}`); }
    else if (result === 'lose') { balance -= bet; alert(`Perdiste Blackjack. Tu:${player} Dealer:${dealer} -${bet}`); }
    else alert(`Empate Blackjack. Tu:${player} Dealer:${dealer}`);

    await saveBalance();
  }

  async function playRoulette(bet = 50) {
    if (balance < bet) { alert('Saldo insuficiente'); return; }
    const chosen = prompt('Apuesta a un nÃºmero (0-36):');
    if (chosen === null) return;
    const pick = Number(chosen);
    if (Number.isNaN(pick) || pick < 0 || pick > 36) { alert('NÃºmero invÃ¡lido'); return; }
    const result = rand(0, 36);
    if (pick === result) { balance += bet * 35; alert(`Â¡Ha salido ${result}! Ganaste ${bet * 35}`); }
    else { balance -= bet; alert(`SaliÃ³ ${result}. Pierdes ${bet}`); }
    await saveBalance();
  }

  async function playSlots(bet = 50) {
    if (balance < bet) { alert('Saldo insuficiente'); return; }
    const symbols = ['ðŸ’', 'ðŸ‹', 'ðŸŠ', 'ðŸ‡', 'ðŸ’Ž', '7ï¸âƒ£'];
    const r = [rand(0, 5), rand(0, 5), rand(0, 5)];
    const res = r.map(i => symbols[i]).join(' | ');
    if (r[0] === r[1] && r[1] === r[2]) { balance += bet * 5; alert(`${res}\nÂ¡Jackpot! +${bet*5}`); }
    else { balance -= bet; alert(`${res}\nPierdes ${bet}`); }
    await saveBalance();
  }

  // ---------- THREE.JS escena ----------
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f1a);
  const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.position.set(0, 1.6, 5);
  camera.rotation.order = 'YXZ';

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x222233, 0.8));
  scene.add(new THREE.AmbientLight(0xffffff, 0.25));
  const dir = new THREE.DirectionalLight(0xfff6d6, 0.6);
  dir.position.set(5, 10, 5);
  scene.add(dir);

  // ---------- Canvas textures ----------
  function canvasTextureGradient(color1, color2, size = 512) {
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    const g = ctx.createLinearGradient(0, 0, size, size);
    g.addColorStop(0, color1); g.addColorStop(1, color2);
    ctx.fillStyle = g; ctx.fillRect(0, 0, size, size);
    return new THREE.CanvasTexture(c);
  }

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(30, 30),
    new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#2a0033', '#550077'), roughness: 0.9 })
  );
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);

  const interactables = [];
  function addTable(x, z, type) {
    const geom = type === 'slots' ? new THREE.BoxGeometry(1, 2, 1) : new THREE.CylinderGeometry(1.5, 1.5, 0.3, 32);
    const mat = new THREE.MeshStandardMaterial({ map: canvasTextureGradient('#222', '#550') });
    const mesh = new THREE.Mesh(geom, mat);
    mesh.position.set(x, type === 'slots' ? 1 : 0.3, z);
    mesh.userData.type = type;
    mesh.castShadow = true;
    mesh.receiveShadow = true;
    scene.add(mesh);
    interactables.push(mesh);
    return mesh;
  }

  addTable(-4, 0, 'blackjack');
  addTable(0, 0, 'roulette');
  addTable(4, 0, 'slots');

  const npc = new THREE.Mesh(
    new THREE.CylinderGeometry(0.4, 0.4, 1.6, 16),
    new THREE.MeshStandardMaterial({ color: 0x999999 })
  );
  npc.position.set(0, 1, 5);
  npc.userData.type = 'npc';
  scene.add(npc);
  interactables.push(npc);

  // ---------- Camara y movimiento ----------
  const keys = {};
  document.addEventListener('keydown', e => keys[e.code] = true);
  document.addEventListener('keyup', e => keys[e.code] = false);

  let yaw = 0, pitch = 0;
  function updateCamera(dt) {
    const yawSpeed = 1.8, pitchSpeed = 1.2;
    if (keys['ArrowLeft']) yaw += yawSpeed * dt;
    if (keys['ArrowRight']) yaw -= yawSpeed * dt;
    if (keys['ArrowUp']) pitch += pitchSpeed * dt;
    if (keys['ArrowDown']) pitch -= pitchSpeed * dt;

    const limit = Math.PI / 2 - 0.05;
    pitch = Math.max(-limit, Math.min(limit, pitch));
    camera.rotation.y = yaw;
    camera.rotation.x = pitch;

    const forward = new THREE.Vector3();
    camera.getWorldDirection(forward);
    forward.y = 0; forward.normalize();
    const right = new THREE.Vector3().crossVectors(forward, camera.up).normalize();
    const move = new THREE.Vector3();
    if (keys['KeyW']) move.add(forward);
    if (keys['KeyS']) move.sub(forward);
    if (keys['KeyD']) move.add(right);
    if (keys['KeyA']) move.sub(right);
    move.multiplyScalar(3 * dt);
    camera.position.add(move);
  }

  const ray = new THREE.Raycaster();
  let lookingAt = null;
  function checkInteraction() {
    ray.set(camera.position, camera.getWorldDirection(new THREE.Vector3()));
    const hits = ray.intersectObjects(interactables, false);
    if (!hits.length || hits[0].distance > 4) { lookingAt = null; if (npcMsgEl) npcMsgEl.style.display = 'none'; return; }
    lookingAt = hits[0].object;
    if (lookingAt.userData.type === 'npc') { npcMsgEl.style.display = 'block'; npcMsgEl.innerText = 'Pulsa E para recoger fichas diarias'; }
    else npcMsgEl.style.display = 'none';
  }

  document.addEventListener('keydown', async e => {
    if (e.code !== 'KeyE' || !lookingAt) return;
    const t = lookingAt.userData.type;
    if (t === 'npc') await claimDaily();
    else if (t === 'blackjack') await playBlackjack(50);
    else if (t === 'roulette') await playRoulette(50);
    else if (t === 'slots') await playSlots(50);
  });

  const clock = new THREE.Clock();
  function animate() { requestAnimationFrame(animate); const dt = clock.getDelta(); updateCamera(dt); checkInteraction(); renderer.render(scene, camera); }
  animate();

  window.addEventListener('resize', () => { camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });

  window._casino = { playBlackjack, playRoulette, playSlots, claimDaily, saveBalance, currentUser };
})();
</script>
</body>
</html>
