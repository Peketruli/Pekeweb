<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Privado Administradores</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; display:flex; justify-content:center; }
#chatContainer { background:#222; padding:20px; border-radius:10px; width:400px; }
#status { white-space: pre-line; margin-bottom:10px; }
#messages { border:1px solid #555; height:250px; overflow-y:auto; padding:10px; margin-bottom:10px; background:#111; color:#fff; }
input[type=text] { width: calc(100% - 60px); padding:5px; }
button { padding:5px 10px; cursor:pointer; border-radius:5px; border:none; }
button#logoutBtn { background:#c33; color:#fff; margin-top:10px; }
</style>
</head>
<body>
<div id="chatContainer">
  <div id="status">Verificando usuario...</div>
  <pre id="localStorageView"></pre>
  <div id="chat" style="display:none;">
    <div id="messages"></div>
    <div style="display:flex; gap:5px;">
      <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
      <button onclick="sendMessage()">Enviar</button>
    </div>
    <button id="logoutBtn" onclick="logout()">Cerrar sesión</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const allowedUsers = ["Peketruli","SabinoArana","Jesus de Nazaret","General Suker","(JUSTICIA POR PEKEPO11AENORME)_69"];
let currentUser = null;

// ---------------- Verificar usuario ----------------
function isAllowed(user){ return user && allowedUsers.includes(user.username); }

function updateLocalStorageView(){
  document.getElementById("localStorageView").innerText = JSON.stringify(Object.fromEntries(Object.entries(localStorage)), null, 2);
}

async function start(){
  const status = document.getElementById("status");
  updateLocalStorageView();

  let storedUser = localStorage.getItem("currentUser");
  if(!storedUser){ 
    status.innerText = "⚠️ No hay sesión activa.";
    return;
  }

  let parsed;
  try{ parsed = JSON.parse(storedUser); }
  catch(e){ status.innerText = "❌ Error parseando JSON: "+e.message; return; }

  currentUser = parsed.username ? parsed : null;

  if(!currentUser || !isAllowed(currentUser)){
    status.innerText = `⛔ Acceso denegado: ${parsed.username||'Desconocido'}`;
    return;
  }

  status.innerText = `✅ Conectado como ${currentUser.username}`;
  document.getElementById("chat").style.display = "block";
  loadMessages();
  subscribeMessages();
}

// ---------------- Funciones de chat ----------------
async function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text) return;
  await supabase.from("mensajes").insert([{username: currentUser.username, text}]);
  input.value = "";
}

async function loadMessages(){
  const { data } = await supabase.from("mensajes").select("*").order("created_at",{ascending:true});
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = data.map(m=>`<b>${m.username}</b>: ${m.text}`).join("<br>");
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function subscribeMessages(){
  supabase.channel('realtime:mensajes')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'mensajes' }, payload=>{
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML += `<br><b>${payload.new.username}</b>: ${payload.new.text}`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }).subscribe();
}

function logout(){
  localStorage.removeItem("currentUser");
  location.reload();
}

window.onload = start;
</script>
</body>
</html>
