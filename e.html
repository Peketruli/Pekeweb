<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas en Vivo - Halloween</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root{
  --text-color: #f5f3f4;
  --accent-orange: #ff8a33;
  --accent-purple: #6b2a7a;
}

body {
  font-family: Arial, sans-serif;
  color: var(--text-color);
  text-align: center;
  margin: 0;
  padding: 50px;
  min-height: 100vh;
  background: linear-gradient(180deg,#1b0b2b 0%,#3a103a 50%,#0b0b0b 100%);
  overflow-x: hidden;
}

/* Fondo decorativo */
.scene-bg {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 50%;
  z-index: 1;
  pointer-events: none;
}
.scene-bg svg { width:100%; height:100%; display:block; }

/* Luna */
.moon {
  position: fixed;
  top: 50px;
  left: 60px;
  width: 130px;
  height: 130px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,230,0.95) 0%, rgba(255,255,220,0.85) 20%, rgba(240,240,200,0.55) 30%, rgba(220,220,200,0.15) 50%, transparent 70%);
  box-shadow:0 0 90px rgba(255,240,180,0.08), 0 6px 40px rgba(0,0,0,0.6) inset;
  z-index:2;
}

/* Niebla */
.fog-layer {
  position: fixed;
  left: -20%;
  width: 140%;
  height: 35vh;
  bottom: -8%;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
  filter: blur(22px);
  opacity: 0.45;
  z-index:3;
  pointer-events:none;
  animation: fogShift 28s linear infinite;
}
.fog-layer.layer2 { bottom:-4%; opacity:0.28; height:30vh; filter: blur(28px); animation-duration:36s }
.fog-layer.layer3 { bottom:-16%; opacity:0.18; height:40vh; filter: blur(36px); animation-duration:46s; transform: scaleX(1.1) }
@keyframes fogShift {
  0%{ transform:translateX(0) }
  50%{ transform:translateX(-8%) }
  100%{ transform:translateX(0) }
}

/* Contenedores y botones */
.poll-container, .create-poll {
  position: relative;
  z-index: 10;
  max-width: 500px;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
  background: rgba(0,0,0,0.6);
  border: 2px solid var(--accent-orange);
  box-shadow: 0 0 20px rgba(255,140,0,0.5);
}

h1, h2 { color: var(--accent-orange); text-shadow: 1px 1px 4px black; }

input, .poll-option, .back-button, .submit-button, .add-option-button, .delete-button {
  display:block;
  width:80%;
  padding:15px;
  margin:10px auto;
  font-size:18px;
  cursor:pointer;
  border-radius:8px;
  border:2px solid var(--accent-orange);
  background:#111;
  color:var(--accent-orange);
  text-shadow: 1px 1px 2px black;
  transition: all 0.3s ease;
}
input:focus, .poll-option:hover, .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover{
  background: var(--accent-orange);
  color: #111;
  transform: scale(1.05);
}

/* Botón volver */
.back-button {
  background: transparent;
  border: 2px solid var(--accent-purple);
  color: var(--accent-purple);
}
.back-button:hover {
  background: var(--accent-purple);
  color: #fff;
}
</style>
</head>
<body>

<div class="scene-bg">
  <svg viewBox="0 0 1440 400" preserveAspectRatio="none">
    <polygon points="0,400 0,300 200,280 400,320 600,300 800,350 1000,310 1200,330 1440,300 1440,400" fill="#0b0b0b"/>
    <circle cx="120" cy="340" r="20" fill="#ff8a33"/>
    <circle cx="400" cy="360" r="15" fill="#ff8a33"/>
    <circle cx="850" cy="370" r="25" fill="#ff8a33"/>
  </svg>
</div>
<div class="moon"></div>
<div class="fog-layer layer1"></div>
<div class="fog-layer layer2"></div>
<div class="fog-layer layer3"></div>

<h1>Encuestas en Vivo</h1>

<!-- Crear encuesta -->
<div id="createPoll" class="create-poll" style="display: none;">
  <h2>Crear una nueva encuesta</h2>
  <input type="text" id="newQuestion" placeholder="Escribe la pregunta"><br><br>
  <div id="optionsContainer">
    <input type="text" class="option-input" placeholder="Opción 1"><br><br>
    <input type="text" class="option-input" placeholder="Opción 2"><br><br>
  </div>
  <button class="add-option-button" onclick="addOption()">Añadir Opción</button><br><br>
  <label>Duración:</label><br>
  <input type="number" id="hours" placeholder="Horas" min="0" value="0"> h
  <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" value="0"> m<br><br>
  <button class="submit-button" onclick="createPoll()">Crear Encuesta</button>
</div>

<!-- Encuesta activa -->
<div class="poll-container" id="pollContainer" style="display: none;">
  <h2 id="question">Pregunta en vivo</h2>
  <div id="pollOptions"></div>
  <p id="timer">Tiempo restante: --</p>
  <p id="results" style="display: none;"></p>
  <button class="delete-button" id="deleteButton" style="display: none;" onclick="deletePoll()">Eliminar Encuesta</button>
</div>

<button class="back-button" onclick="goToMainPage()">Volver a la Página Principal</button>

<script>
// --- Lógica completa de encuestas Supabase (tu versión original) ---
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentPoll = null;
let pollInterval = null;
const user = JSON.parse(localStorage.getItem("currentUser"));

document.addEventListener("DOMContentLoaded", async () => {
  if(user && (user.username === "Peketruli" || user.username === "SabinoArana")){
    document.getElementById("createPoll").style.display = "block";
    document.getElementById("deleteButton").style.display = "block";
  }
  await loadActivePoll();
});

function addOption() {
  const optionsContainer = document.getElementById("optionsContainer");
  const optionCount = optionsContainer.getElementsByClassName("option-input").length + 1;
  const input = document.createElement("input");
  input.type = "text";
  input.className = "option-input";
  input.placeholder = `Opción ${optionCount}`;
  optionsContainer.appendChild(input);
  optionsContainer.appendChild(document.createElement("br"));
}

async function createPoll() {
  const question = document.getElementById("newQuestion").value;
  const options = Array.from(document.getElementsByClassName("option-input"))
    .map(input => ({ text: input.value, votes: 0 }))
    .filter(opt => opt.text);

  const hours = parseInt(document.getElementById("hours").value) || 0;
  const minutes = parseInt(document.getElementById("minutes").value) || 0;
  const duration = (hours*3600)+(minutes*60);

  if(!question || options.length<2 || duration<=0){ alert("Completa todos los campos."); return; }

  const { data, error } = await db.from("polls").insert([
    { question, options, duration, creator:user.username, start_time: new Date() }
  ]).select().single();

  if(error){ alert("Error al crear: "+error.message); return; }
  alert("Encuesta creada!");
  loadPoll(data.id);
}

async function vote(optionIndex){
  if(!currentPoll) return;
  const { error } = await db.from("poll_votes").insert([{ poll_id:currentPoll.id, user_email:user.username, option_index:optionIndex }]);
  if(error){ 
    if(error.message.includes("duplicate key")) alert("Ya votaste"); 
    else alert("Error: "+error.message); 
    return;
  }
  loadPoll(currentPoll.id);
}

async function loadPoll(pollId){
  const { data: poll, error } = await db.from("polls").select("*").eq("id", pollId).single();
  if(error){ console.error(error); return; }
  currentPoll = poll;

  document.getElementById("question").textContent = poll.question;
  const pollOptions = document.getElementById("pollOptions");
  pollOptions.innerHTML = "";

  const { data: votes } = await db.from("poll_votes").select("*").eq("poll_id", poll.id);
  const counts = new Array(poll.options.length).fill(0);
  votes.forEach(v=>counts[v.option_index]++);

  poll.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.className="poll-option";
    btn.textContent = `${opt.text} (${counts[i]} votos)`;
    btn.onclick = ()=>vote(i);
    pollOptions.appendChild(btn);
  });
  document.getElementById("pollContainer").style.display="block";

  if(pollInterval) clearInterval(pollInterval);
  startTimer(new Date(poll.start_time).getTime(), poll.duration);
}

async function loadActivePoll(){
  const { data: polls } = await db.from("polls").select("*").order("created_at",{ascending:false}).limit(1);
  if(polls && polls.length>0) loadPoll(polls[0].id);
}

function startTimer(startTime,duration){
  let timeLeft = duration - Math.floor((Date.now()-startTime)/1000);
  const timerElement = document.getElementById("timer");
  pollInterval=setInterval(()=>{
    timeLeft--;
    timerElement.textContent = `Tiempo restante: ${timeLeft}s`;
    if(timeLeft<=0){ clearInterval(pollInterval); showResults(); }
  },1000);
}

async function showResults(){
  const resultsElement = document.getElementById("results");
  const { data: votes } = await db.from("poll_votes").select("*").eq("poll_id",currentPoll.id);
  const counts = new Array(currentPoll.options.length).fill(0);
  votes.forEach(v=>counts[v.option_index]++);
  const total = counts.reduce((a,b)=>a+b,0);
  resultsElement.innerHTML = total===0?"No hubo votos.":"Resultados:<br>";
  counts.forEach((c,i)=>{ resultsElement.innerHTML+=`${currentPoll.options[i].text}: ${c} votos<br>`; });
  resultsElement.style.display="block";
}

async function deletePoll(){
  if(!currentPoll) return;
  if(!confirm("¿Eliminar esta encuesta?")) return;
  await db.from("polls").delete().eq("id",currentPoll.id);
  await db.from("poll_votes").delete().eq("poll_id",currentPoll.id);
  alert("Encuesta eliminada");
  location.reload();
}

function goToMainPage(){
  window.location.href='h.html';
}
</script>
</body>
</html>
