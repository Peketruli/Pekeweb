<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas en Vivo - Halloween</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root{
  --text-color: #f5f3f4;
  --accent-orange: #ff8a33;
  --accent-purple: #6b2a7a;
}

body {
  font-family: Arial, sans-serif;
  color: var(--text-color);
  text-align: center;
  margin: 0;
  padding: 50px;
  min-height: 100vh;
  background: linear-gradient(180deg,#1b0b2b 0%,#3a103a 50%,#0b0b0b 100%);
  overflow-x: hidden;
}

/* Fondo decorativo */
.scene-bg {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 50%;
  z-index: 0;
  pointer-events: none;
}
.scene-bg svg { width:100%; height:100%; display:block; }

/* Luna */
.moon {
  position: fixed;
  top: 50px;
  left: 60px;
  width: 130px;
  height: 130px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,230,0.95) 0%, rgba(255,255,220,0.85) 20%, rgba(240,240,200,0.55) 30%, rgba(220,220,200,0.15) 50%, transparent 70%);
  box-shadow:0 0 90px rgba(255,240,180,0.08), 0 6px 40px rgba(0,0,0,0.6) inset;
  z-index:1;
}

/* Niebla */
.fog-layer {
  position: fixed;
  left: -20%;
  width: 140%;
  height: 35vh;
  bottom: -8%;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
  filter: blur(22px);
  opacity: 0.45;
  z-index:2;
  pointer-events:none;
  animation: fogShift 28s linear infinite;
}
.fog-layer.layer2 { bottom:-4%; opacity:0.28; height:30vh; filter: blur(28px); animation-duration:36s }
.fog-layer.layer3 { bottom:-16%; opacity:0.18; height:40vh; filter: blur(36px); animation-duration:46s; transform: scaleX(1.1) }
@keyframes fogShift {
  0%{ transform:translateX(0) }
  50%{ transform:translateX(-8%) }
  100%{ transform:translateX(0) }
}

/* Contenedores y botones */
.poll-container, .create-poll {
  position: relative;
  z-index: 10;
  max-width: 500px;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
  background: rgba(0,0,0,0.6);
  border: 2px solid var(--accent-orange);
  box-shadow: 0 0 20px rgba(255,140,0,0.5);
}

h1, h2 { color: var(--accent-orange); text-shadow: 1px 1px 4px black; }

input, .poll-option, .back-button, .submit-button, .add-option-button, .delete-button {
  display:block;
  width:80%;
  padding:15px;
  margin:10px auto;
  font-size:18px;
  cursor:pointer;
  border-radius:8px;
  border:2px solid var(--accent-orange);
  background:#111;
  color:var(--accent-orange);
  text-shadow: 1px 1px 2px black;
  transition: all 0.3s ease;
}
input:focus, .poll-option:hover, .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover{
  background: var(--accent-orange);
  color: #111;
  transform: scale(1.05);
}

/* Bot√≥n para volver al h.html */
#backButton {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(255, 102, 0, 0.9);
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  z-index: 9999; /* üî• Muy alto para estar delante de las monta√±as */
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#backButton:hover {
  transform: scale(1.1);
  box-shadow: 0 0 15px #ff6600;
}
</style>
</head>
<body>


<div class="moon"></div>
<div class="fog-layer layer1"></div>
<div class="fog-layer layer2"></div>
<div class="fog-layer layer3"></div>

<h1>Encuestas en Vivo</h1>

<!-- Crear encuesta -->
<div id="createPoll" class="create-poll" style="display: none;">
  <h2>Crear una nueva encuesta</h2>
  <input type="text" id="newQuestion" placeholder="Escribe la pregunta"><br><br>
  <div id="optionsContainer">
    <input type="text" class="option-input" placeholder="Opci√≥n 1"><br><br>
    <input type="text" class="option-input" placeholder="Opci√≥n 2"><br><br>
  </div>
  <button class="add-option-button" onclick="addOption()">A√±adir Opci√≥n</button><br><br>
  <label>Duraci√≥n:</label><br>
  <input type="number" id="hours" placeholder="Horas" min="0" value="0"> h
  <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" value="0"> m<br><br>
  <button class="submit-button" onclick="createPoll()">Crear Encuesta</button>
</div>

<!-- Encuesta activa -->
<div class="poll-container" id="pollContainer" style="display: none;">
  <h2 id="question">Pregunta en vivo</h2>
  <div id="pollOptions"></div>
  <p id="timer">Tiempo restante: --</p>
  <p id="results" style="display: none;"></p>
  <button class="delete-button" id="deleteButton" style="display: none;" onclick="deletePoll()">Eliminar Encuesta</button>
</div>

<button class="back-button" onclick="goToMainPage()">Volver a la P√°gina Principal</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentPoll = null;
let pollInterval = null;
let pollEnded = false;

const user = JSON.parse(localStorage.getItem("currentUser"));
let votedPollId = localStorage.getItem("votedPollId");

/* üßæ Funci√≥n para registrar actividad en Supabase */
async function registrarActividad(usuario, accion) {
  try {
    const { error } = await db.from("actividad").insert([{ usuario, accion }]);
    if (error) console.error("Error registrando actividad:", error.message);
  } catch (err) {
    console.error("Error inesperado al registrar actividad:", err);
  }
}

/* üöÄ Inicializaci√≥n */
document.addEventListener("DOMContentLoaded", async () => {
  if(user && (user.username === "Peketruli" || user.username === "SabinoArana")){
    document.getElementById("createPoll").style.display = "block";
    document.getElementById("deleteButton").style.display = "block";
  }
  await loadActivePoll();
});

/* ‚ûï A√±adir opci√≥n */
function addOption() {
  const optionsContainer = document.getElementById("optionsContainer");
  const optionCount = optionsContainer.getElementsByClassName("option-input").length + 1;
  const input = document.createElement("input");
  input.type = "text";
  input.className = "option-input";
  input.placeholder = `Opci√≥n ${optionCount}`;
  optionsContainer.appendChild(input);
  optionsContainer.appendChild(document.createElement("br"));
}

/* üß† Crear encuesta */
async function createPoll() {
  const question = document.getElementById("newQuestion").value;
  const options = Array.from(document.getElementsByClassName("option-input"))
    .map(input => input.value)
    .filter(opt => opt);

  const hours = parseInt(document.getElementById("hours").value) || 0;
  const minutes = parseInt(document.getElementById("minutes").value) || 0;
  const duration = (hours*3600)+(minutes*60);

  if(!question || options.length < 2 || duration <= 0){ 
    alert("Completa todos los campos."); 
    return; 
  }

  localStorage.removeItem("votedPollId");

  const { data, error } = await db.from("polls").insert([
    { 
      question, 
      options: options.map(o=>({text:o})), 
      votes: new Array(options.length).fill(0), 
      duration, 
      creator: user.username, 
      start_time: new Date() 
    }
  ]).select().single();

  if(error){ 
    alert("Error al crear: "+error.message); 
    return; 
  }

  await registrarActividad(user.username, `cre√≥ una nueva encuesta: "${question}"`);
  alert("‚úÖ Encuesta creada!");
  loadPoll(data.id);
}

/* üó≥Ô∏è Votar */
async function vote(optionIndex){
  if(!currentPoll) return;
  if(pollEnded){
    alert("La encuesta ha terminado. Ya no puedes votar.");
    return;
  }
  if(localStorage.getItem("votedPollId") === currentPoll.id){
    alert("Ya votaste en esta encuesta");
    return;
  }

  localStorage.setItem("votedPollId", currentPoll.id);
  currentPoll.votes[optionIndex]++;

  const { error } = await db.from("polls").update({ votes: currentPoll.votes }).eq("id", currentPoll.id);
  if(error) alert("Error al registrar el voto: " + error.message);

  const opcionVotada = currentPoll.options[optionIndex].text;
  await registrarActividad(user.username, `vot√≥ por "${opcionVotada}" en la encuesta "${currentPoll.question}"`);

  renderPollOptions();
  showResults();
}

/* üì° Cargar encuesta activa */
async function loadActivePoll(){
  const { data: polls } = await db.from("polls").select("*").order("created_at",{ascending:false}).limit(1);
  if(polls && polls.length>0) loadPoll(polls[0].id);
}

/* üì¶ Cargar encuesta por ID */
async function loadPoll(pollId){
  const { data: poll } = await db.from("polls").select("*").eq("id", pollId).single();
  currentPoll = poll;

  if(!currentPoll.votes || currentPoll.votes.length !== currentPoll.options.length){
    currentPoll.votes = new Array(currentPoll.options.length).fill(0);
    await db.from("polls").update({ votes: currentPoll.votes }).eq("id", currentPoll.id);
  }

  document.getElementById("question").textContent = poll.question;
  renderPollOptions();
  document.getElementById("pollContainer").style.display="block";

  if(pollInterval) clearInterval(pollInterval);
  pollEnded = false;
  startTimer(new Date(poll.start_time).getTime(), poll.duration);
}

/* üß© Mostrar opciones */
function renderPollOptions(){
  const pollOptions = document.getElementById("pollOptions");
  pollOptions.innerHTML = "";

  const maxVotes = Math.max(...currentPoll.votes);
  const winnerIndex = currentPoll.votes.indexOf(maxVotes);

  currentPoll.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.className = "poll-option";
    const votes = currentPoll.votes[i] || 0;
    btn.textContent = `${opt.text} (${votes} votos)`;

    if(pollEnded && i === winnerIndex){
      btn.style.backgroundColor = "green";
      btn.style.color = "#fff";
    }

    btn.disabled = pollEnded;
    btn.onclick = ()=>vote(i);
    pollOptions.appendChild(btn);
  });
}

/* ‚è≥ Temporizador */
function startTimer(startTime,duration){
  let timeLeft = duration - Math.floor((Date.now()-startTime)/1000);
  const timerElement = document.getElementById("timer");
  pollInterval=setInterval(()=>{
    timeLeft--;
    timerElement.textContent = `Tiempo restante: ${timeLeft}s`;
    if(timeLeft <= 0){ 
      clearInterval(pollInterval); 
      pollEnded = true;
      showResults(); 
      renderPollOptions();
    }
  },1000);
}

/* üìä Resultados */
function showResults(){
  const resultsElement = document.getElementById("results");
  const counts = currentPoll.votes;
  const total = counts.reduce((a,b)=>a+b,0);
  resultsElement.innerHTML = total===0 ? "No hubo votos." : "Resultados:<br>";
  counts.forEach((c,i)=>{
    resultsElement.innerHTML += `${currentPoll.options[i].text}: ${c} votos<br>`;
  });
  resultsElement.style.display="block";
}

/* ‚ùå Eliminar encuesta */
async function deletePoll(){
  if(!currentPoll) return;
  if(!confirm("¬øEliminar esta encuesta?")) return;
  await db.from("polls").delete().eq("id",currentPoll.id);
  await registrarActividad(user.username, `elimin√≥ la encuesta "${currentPoll.question}"`);
  alert("Encuesta eliminada");
  location.reload();
}

/* üè† Volver al inicio */
function goToMainPage(){
  window.location.href='h.html';
}
</script>
</body>
</html>
