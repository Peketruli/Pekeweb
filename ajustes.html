<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ajustes - PekeOS</title>
<style>
:root{--accent:#00ffd0}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:linear-gradient(180deg,#021018,#04121a);color:#bfffee;padding:14px;height:100vh;overflow:auto}
.h1{font-weight:800;font-size:20px}
.layout{display:flex;gap:12px;margin-top:12px}
.left{flex:1}
.right{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(0,255,208,0.04);padding:12px;border-radius:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);margin-bottom:12px}
.label{font-weight:700;color:#9ef7ea}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:inherit;width:100%}
.btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;background:transparent;color:inherit}
.previewBox{height:140px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);display:flex;align-items:center;justify-content:center;margin-bottom:8px;background:linear-gradient(180deg,#04101a,#021018)}
.small{font-size:13px;color:#9ef7ea}
.row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <div>
    <div class="h1">‚öôÔ∏è Ajustes ‚Äî PekeOS</div>
    <div style="font-size:13px;color:#9ef7ea">Aplica cambios reales al escritorio. Usa "Aplicar cambios" para probar y "Guardar" para persistir.</div>
  </div>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="label">üé® Color principal</div>
        <input id="accentColor" class="input" type="color" value="#00ffd0" />
      </div>

      <div class="card">
        <div class="label">üñºÔ∏è Fondo del escritorio</div>
        <input id="bgFile" type="file" class="input" accept="image/*" />
        <input id="bgUrl" class="input" placeholder="O pega URL de imagen" style="margin-top:8px" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="applyBg">Aplicar fondo</button>
          <button class="btn" id="clearBg">Quitar fondo</button>
        </div>
      </div>

      <div class="card">
        <div class="label">üî≥ Opacidad de ventanas</div>
        <input id="winOpacity" type="range" min="0.5" max="1" step="0.01" value="0.96" style="width:100%" />
        <div class="small">Valor actual: <span id="opVal">0.96</span></div>
      </div>

      <div class="card">
        <div class="label">‚úî Aplicar y Guardar</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="applySettingsBtn">‚úî Aplicar cambios</button>
          <button class="btn" id="saveSettingsBtn">üíæ Guardar</button>
        </div>
      </div>

      <div class="card">
        <div class="label">Reset</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="resetBtn">‚ôªÔ∏è Restaurar por defecto</button>
        </div>
      </div>

    </div>

    <div class="right">
      <div style="font-weight:700">Previsualizaci√≥n</div>
      <div class="previewBox" id="previewBox">Preview</div>

      <div class="card">
        <div style="font-weight:700">Estado guardado</div>
        <pre id="currentState" style="white-space:pre-wrap;font-size:12px;color:#9ef7ea"></pre>
      </div>
    </div>
  </div>

<script>
/*
  Esta versi√≥n usa la CLAVE √∫nica: "pekeos_settings"
  - Al aplicar se escribe "pekeos_settings" y "pekeos_update" (timestamp)
  - PekeOS debe escuchar 'storage' para la key "pekeos_update" o tener funci√≥n global aplicarAjustes()
*/

const SETTINGS_KEY = 'pekeos_settings';

function defaultSettings(){
  return {
    accent: '#00ffd0',
    wallpaper: null,    // dataURL o URL
    opacity: 0.96,
    theme: 'dark'       // 'dark' o 'light' (opcional)
  };
}

let settings = defaultSettings();
try {
  const raw = localStorage.getItem(SETTINGS_KEY);
  if(raw) settings = Object.assign(defaultSettings(), JSON.parse(raw));
} catch(e){
  settings = defaultSettings();
}

/* ---- elements ---- */
const accentColor = document.getElementById('accentColor'),
      bgFile = document.getElementById('bgFile'),
      bgUrl = document.getElementById('bgUrl'),
      applyBgBtn = document.getElementById('applyBg'),
      clearBgBtn = document.getElementById('clearBg'),
      winOpacity = document.getElementById('winOpacity'),
      opVal = document.getElementById('opVal'),
      previewBox = document.getElementById('previewBox'),
      currentState = document.getElementById('currentState'),
      applyBtn = document.getElementById('applySettingsBtn'),
      saveBtn = document.getElementById('saveSettingsBtn'),
      resetBtn = document.getElementById('resetBtn');

/* init UI from settings */
accentColor.value = settings.accent;
bgUrl.value = settings.wallpaper || '';
winOpacity.value = settings.opacity;
opVal.textContent = winOpacity.value;
updatePreview();
updateStateView();

/* helpers */
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

function hexToRgba(hex,a=1){
  hex = (hex||'#000').replace('#','');
  const r = parseInt(hex.slice(0,2),16);
  const g = parseInt(hex.slice(2,4),16);
  const b = parseInt(hex.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* aplicar ajustes EN EL PADRE (llamada directa si iframe->parent) */
async function applySettingsToSystem(applyToParentFlag = true){
  // build settings from UI
  settings.accent = accentColor.value;
  settings.opacity = parseFloat(winOpacity.value);
  // wallpaper already set when applyBg clicked; but if bgUrl has value use it
  if(bgUrl.value && bgUrl.value.trim()) settings.wallpaper = bgUrl.value.trim();

  // 1) Save to localStorage key used by PekeOS
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  // 2) Fire update signal for other windows (storage event won't fire in this same document)
  localStorage.setItem('pekeos_update', Date.now().toString());

  // 3) Try to call parent.aplicarAjustes() directly (works if same-origin and function exists)
  try {
    if(window.parent && typeof window.parent.aplicarAjustes === 'function' && applyToParentFlag){
      window.parent.aplicarAjustes();
    }
  } catch(e){
    // ignore
  }

  updatePreview();
  updateStateView();
}

/* UI wiring */
applyBtn.addEventListener('click', async ()=>{
  // if a local file selected via bgFile, convert it and set wallpaper first
  if(bgFile.files && bgFile.files[0]){
    const data = await readFileAsDataURL(bgFile.files[0]);
    settings.wallpaper = data;
    bgUrl.value = '';
  }
  await applySettingsToSystem(true);
  alert('Ajustes aplicados ‚úî (se han guardado en localStorage y notificado al sistema)');
});

saveBtn.addEventListener('click', ()=>{
  // ensure current UI is read
  settings.accent = accentColor.value;
  settings.opacity = parseFloat(winOpacity.value);
  if(bgUrl.value && bgUrl.value.trim()) settings.wallpaper = bgUrl.value.trim();
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  updateStateView();
  alert('Ajustes guardados üíæ');
});

winOpacity.addEventListener('input', ()=>{ opVal.textContent = winOpacity.value; });

applyBgBtn.addEventListener('click', async ()=>{
  const file = bgFile.files[0];
  if(file){
    const data = await readFileAsDataURL(file);
    settings.wallpaper = data;
    bgUrl.value = '';
    updatePreview();
    updateStateView();
  } else if(bgUrl.value && bgUrl.value.trim()){
    settings.wallpaper = bgUrl.value.trim();
    updatePreview();
    updateStateView();
  } else {
    alert('Selecciona un archivo o pega una URL');
  }
});

clearBgBtn.addEventListener('click', ()=>{
  settings.wallpaper = null;
  bgUrl.value = '';
  updatePreview();
  updateStateView();
});

resetBtn.addEventListener('click', ()=>{
  settings = defaultSettings();
  accentColor.value = settings.accent;
  winOpacity.value = settings.opacity;
  opVal.textContent = winOpacity.value;
  bgUrl.value = '';
  bgFile.value = '';
  updatePreview();
  updateStateView();
  // also persist and notify
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  localStorage.setItem('pekeos_update', Date.now().toString());
  try{ if(window.parent && typeof window.parent.aplicarAjustes === 'function') window.parent.aplicarAjustes(); }catch(e){}
  alert('Restaurado por defecto');
});

/* preview & status */
function updatePreview(){
  if(settings.wallpaper){
    previewBox.style.background = `url('${settings.wallpaper}') center/cover`;
  } else {
    previewBox.style.background = 'linear-gradient(180deg,#04101a,#021018)';
  }
  previewBox.style.border = `1px solid ${hexToRgba(settings.accent,0.12)}`;
  previewBox.style.boxShadow = `0 10px 30px ${hexToRgba(settings.accent,0.03)}`;
  previewBox.style.color = settings.accent;
}

function updateStateView(){
  currentState.textContent = JSON.stringify(settings, null, 2);
}

/* listen for storage changes (if another window changed settings) */
window.addEventListener('storage', (e)=>{
  if(e.key === 'pekeos_update'){
    // reload settings from storage
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(raw){ settings = Object.assign(defaultSettings(), JSON.parse(raw)); }
      // update UI to reflect external change
      accentColor.value = settings.accent;
      winOpacity.value = settings.opacity;
      opVal.textContent = winOpacity.value;
      bgUrl.value = settings.wallpaper || '';
      updatePreview(); updateStateView();
      // attempt to apply to parent too
      try{ if(window.parent && typeof window.parent.aplicarAjustes === 'function') window.parent.aplicarAjustes(); }catch(e){}
    }catch(err){}
  }
});

/* on load ensure parent reflects stored settings too */
try{
  // Try call parent.aplicarAjustes() so parent updates immediately if possible
  if(window.parent && typeof window.parent.aplicarAjustes === 'function'){
    window.parent.aplicarAjustes();
  }
} catch(e){}

/* initial UI reflect */
updatePreview();
updateStateView();
</script>
</body>
</html>
