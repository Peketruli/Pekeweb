<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ajustes - PekeOS</title>
<style>
:root{--bg:#06121a;--card:#07121a;--accent:#00ffd0}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:linear-gradient(180deg,#04101a,#021018);color:#bfffee;padding:16px}
.h1{font-weight:800;font-size:20px}
.layout{display:flex;gap:12px;margin-top:12px}
.left{flex:1;display:flex;flex-direction:column;gap:12px}
.right{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(0,255,208,0.04);padding:12px;border-radius:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:8px;border:1px solid rgba(0,255,208,0.03)}
.row{display:flex;gap:8px;align-items:center}
.label{width:140px;color:#9ef7ea;font-weight:700}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:inherit}
.previewBox{height:140px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);display:flex;align-items:center;justify-content:center}
.small{font-size:13px;color:#9ef7ea}
.switch{display:inline-flex;align-items:center;gap:8px}
.ext-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;background:transparent;color:inherit}
</style>
</head>
<body>
  <div>
    <div class="h1">‚öôÔ∏è Ajustes Avanzados</div>
    <div style="font-size:13px;color:#9ef7ea">Personaliza tema, comportamiento de ventanas, sonidos y extensiones.</div>
  </div>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">üé® Editor de Tema</div>
        <div class="row">
          <div class="label">Color primario</div>
          <input class="input" id="accentColor" type="color" value="#00ffd0">
        </div>
        <div class="row" style="margin-top:8px">
          <div class="label">Fondo (URL)</div>
          <input class="input" id="bgUrl" placeholder="URL imagen de fondo (opcional)">
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="applyTheme">Aplicar tema</button>
          <button class="btn" id="exportTheme">Exportar</button>
          <button class="btn" id="importTheme">Importar</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">üñ•Ô∏è Comportamiento de Ventanas</div>
        <div class="row"><div class="label">Animaciones</div><select id="animMode" class="input"><option value="smooth">Suave</option><option value="instant">Instant√°neo</option><option value="none">Sin animaciones</option></select></div>
        <div class="row" style="margin-top:8px"><div class="label">Tiempo anim (ms)</div><input id="animTime" class="input" type="number" value="180" min="0"></div>
        <div style="margin-top:8px"><button class="btn" id="applyWindow">Aplicar</button></div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">üîä Sonidos</div>
        <div class="row"><div class="label">Sonidos</div><label class="switch"><input id="soundToggle" type="checkbox" checked> Activar</label></div>
        <div style="margin-top:8px"><button class="btn" id="testSound">Probar sonido</button></div>
      </div>

    </div>

    <div class="right">
      <div style="font-weight:800">Vista previa / Extensiones</div>
      <div class="previewBox" id="previewBox" style="margin-top:8px">Previsualizaci√≥n</div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:700">üîå Extensiones</div>
        <div class="ext-list" id="extList"></div>
        <div style="margin-top:8px"><button class="btn" id="addExt">‚ûï A√±adir extensi√≥n</button></div>
      </div>

    </div>
  </div>

<script>
/* ---------- Temas ---------- */
const accentColor = document.getElementById('accentColor');
const bgUrl = document.getElementById('bgUrl');
const previewBox = document.getElementById('previewBox');

function applyThemeToParent(theme){
  // theme: {accent, bg}
  try{
    const pd = parent.document;
    pd.documentElement.style.setProperty('--neon', theme.accent);
    pd.documentElement.style.setProperty('--accent', theme.accent);
    // intentar cambiar taskbar border glow si existe
    const task = pd.getElementById('taskbar');
    if(task) task.style.boxShadow = `0 10px 40px rgba(0,0,0,0.6), 0 0 30px ${hexToRgba(theme.accent,0.04)}`;
    // cambiar fondo
    const desk = pd.getElementById('desktop');
    if(desk){
      if(theme.bg) desk.style.backgroundImage = `url('${theme.bg}')`;
      else desk.style.background = '';
    }
  }catch(e){
    console.warn('No se pudo aplicar tema al parent (ejecuta dentro del iframe).', e);
  }
  // preview local
  previewBox.style.background = theme.bg ? `url('${theme.bg}') center/cover` : 'linear-gradient(180deg,#04101a,#021018)';
  previewBox.style.borderColor = theme.accent;
}

function hexToRgba(hex, a=1){
  hex = hex.replace('#','');
  const r = parseInt(hex.substring(0,2),16);
  const g = parseInt(hex.substring(2,4),16);
  const b = parseInt(hex.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

document.getElementById('applyTheme').addEventListener('click', ()=>{
  const theme = { accent: accentColor.value, bg: bgUrl.value.trim() || null };
  applyThemeToParent(theme);
  localStorage.setItem('pekeos_theme_v3', JSON.stringify(theme));
  alert('Tema aplicado');
});
document.getElementById('exportTheme').addEventListener('click', ()=>{
  const theme = { accent: accentColor.value, bg: bgUrl.value.trim() || null };
  const a = document.createElement('a'); a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(theme)); a.download='pekeos-theme.json'; a.click();
});
document.getElementById('importTheme').addEventListener('click', ()=>{
  const txt = prompt('Pega JSON del tema');
  try{ const t = JSON.parse(txt); accentColor.value = t.accent||'#00ffd0'; bgUrl.value = t.bg||''; applyThemeToParent(t); }catch(e){ alert('JSON inv√°lido'); }
});

/* ---------- Ventanas ---------- */
document.getElementById('applyWindow').addEventListener('click', ()=>{
  const mode = document.getElementById('animMode').value;
  const t = parseInt(document.getElementById('animTime').value)||180;
  try{
    const pd = parent.document;
    const wins = pd.querySelectorAll('.win');
    wins.forEach(w=>{
      if(mode==='none') { w.style.transition = 'none'; }
      else if(mode==='instant'){ w.style.transition = `transform ${t}ms linear, opacity ${t}ms linear`; }
      else { w.style.transition = `transform ${t}ms cubic-bezier(.2,.9,.3,1), opacity ${t}ms ${t/2}ms`; }
    });
    alert('Ajustes de ventana aplicados');
  }catch(e){ console.warn('No hay parent para aplicar'); alert('Ajustes aplicados (si corresponde)'); }
});

/* ---------- Sonidos ---------- */
let soundsEnabled = true;
document.getElementById('soundToggle').addEventListener('change', (e)=> soundsEnabled = e.target.checked);
document.getElementById('testSound').addEventListener('click', ()=> {
  if(!soundsEnabled){ alert('Sonidos desactivados'); return; }
  // tono simple usando WebAudio
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value=880;
    g.gain.value=0.0001; o.connect(g); g.connect(ctx.destination);
    g.gain.linearRampToValueAtTime(0.05, ctx.currentTime+0.01);
    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.4);
    setTimeout(()=>{ o.stop(); ctx.close(); }, 450);
  }catch(e){ alert('No se pudieron reproducir sonidos'); }
});

/* ---------- Extensiones (simples) ---------- */
const extList = document.getElementById('extList');
let exts = [
  {id:'weather',name:'Widget Clima', enabled:true},
  {id:'notifications',name:'Notificaciones', enabled:true},
  {id:'devtools',name:'Herr. desarrollador', enabled:false}
];
function renderExts(){
  extList.innerHTML = exts.map(x=>`
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${x.name}</strong><div class="small">${x.id}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small"><input type="checkbox" data-id="${x.id}" ${x.enabled? 'checked':''}> Activar</label>
        <button class="btn" data-remove="${x.id}">Eliminar</button>
      </div>
    </div>
  `).join('');
  // handlers
  extList.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=> {
      const id = cb.dataset.id;
      const e = exts.find(x=>x.id===id); if(e){ e.enabled = cb.checked; pushLog(`Extensi√≥n ${e.name} ${e.enabled? 'activada':'desactivada'}`); }
    });
  });
  extList.querySelectorAll('button[data-remove]').forEach(b=>{
    b.addEventListener('click', ()=> {
      const id = b.dataset.remove; exts = exts.filter(x=>x.id!==id); renderExts();
    });
  });
}
document.getElementById('addExt').addEventListener('click', ()=>{
  const id = prompt('ID extensi√≥n (ej: myext)');
  const name = prompt('Nombre de la extensi√≥n');
  if(!id||!name) return;
  exts.push({id,name,enabled:false}); renderExts(); pushLog(`Extensi√≥n ${name} a√±adida`);
});
renderExts();

/* ---------- Logs y preview ---------- */
const previewBox = document.getElementById('previewBox');
const logStack = [];
function pushLog(s){ logStack.unshift(`[${new Date().toLocaleTimeString()}] ${s}`); if(logStack.length>80) logStack.pop(); previewBox.innerHTML = `<div style="text-align:left;padding:8px">${logStack.slice(0,8).join('<br>')}</div>`; }

/* ---------- Init: cargar tema guardado ---------- */
(function init(){
  const t = localStorage.getItem('pekeos_theme_v3');
  if(t){ try{ const th = JSON.parse(t); accentColor.value = th.accent||'#00ffd0'; bgUrl.value = th.bg||''; applyThemeToParent(th); pushLog('Tema cargado'); }catch(e){} }
})();
function applyThemeToParent(theme){ // reuse function from earlier concept - we reimplement minimal
  try{
    const pd = parent.document;
    if(pd){
      pd.documentElement.style.setProperty('--neon', theme.accent);
      pd.documentElement.style.setProperty('--accent', theme.accent);
      const desk = pd.getElementById('desktop');
      if(desk){
        if(theme.bg) desk.style.backgroundImage = `url('${theme.bg}')`;
        else desk.style.background = '';
      }
    }
  }catch(e){}
}
</script>
</body>
</html>
