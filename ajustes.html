<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ajustes de Perfil - Subir Foto</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background-color: #2c2c2c;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 40px;
  }
  .user-info {
    margin-bottom: 20px;
  }
  #userLogo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid #fff;
  }
  input[type="file"] {
    margin-top: 12px;
  }
  button {
    padding: 10px 16px;
    margin-top: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background-color: #ff4081;
    color: white;
  }
  button:hover { transform: scale(1.03); }
  #status { margin-top: 12px; font-size: 0.95rem; color: #ffd54f; }
</style>
</head>
<body>

<h1>⚙️ Ajustes de Perfil</h1>

<button onclick="window.location.href='Hub.html'">⬅️ Volver al Hub</button>

<div class="user-info">
  <img id="userLogo" src="logoDefault.png" alt="Foto de perfil">
  <div id="userName">Usuario</div>
</div>

<input type="file" id="avatarInput" accept="image/*">
<br>
<button id="uploadBtn">Subir Foto</button>

<div id="status"></div>

<script>
/* --------- CONFIGURA SUPABASE AQUI ---------- */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
/* -------------------------------------------- */

let currentUser = null;

document.addEventListener("DOMContentLoaded", async () => {
  await initUser();

  document.getElementById("uploadBtn").addEventListener("click", async () => {
    const fileInput = document.getElementById("avatarInput");
    if (!fileInput.files.length) return alert("Selecciona un archivo primero.");
    const file = fileInput.files[0];
    await uploadAvatar(file);
  });
});

/* ---------- Obtener usuario ---------- */
async function initUser() {
  // primero intentar cargar desde localStorage
  const saved = localStorage.getItem("currentUser");
  let local = saved ? JSON.parse(saved) : null;

  if (local && local.id) {
    currentUser = local;
    document.getElementById("userName").textContent = local.username || "Usuario";
    document.getElementById("userLogo").src = local.logo || "logoDefault.png";
    return;
  }

  // luego intentar desde Supabase Auth
  try {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
      document.getElementById("status").textContent = "Debes iniciar sesión primero.";
      return;
    }
    currentUser = user;

    // cargar info de tabla usuarios
    const { data, error: err } = await supabase.from("usuarios")
      .select("username, logo")
      .eq("auth_id", currentUser.id)
      .single();

    if (err) console.warn(err);

    if (data) {
      document.getElementById("userName").textContent = data.username || "Usuario";
      document.getElementById("userLogo").src = data.logo || "logoDefault.png";
      localStorage.setItem("currentUser", JSON.stringify(data));
    }
  } catch(e) {
    console.error("Error initUser:", e);
  }
}

/* ---------- Subir avatar al bucket ---------- */
async function uploadAvatar(file) {
  if (!currentUser) return alert("No hay usuario logueado.");

  const fileExt = file.name.split(".").pop();
  const fileName = `${currentUser.id}.${fileExt}`;
  const filePath = `avatars/${fileName}`;

  document.getElementById("status").textContent = "Subiendo imagen...";

  const { data, error } = await supabase.storage.from("avatars").upload(filePath, file, {
    upsert: true
  });

  if (error) {
    console.error("Error al subir la imagen:", error);
    document.getElementById("status").textContent = "❌ Error al subir la imagen.";
    return;
  }

  const { publicUrl, error: urlErr } = supabase.storage.from("avatars").getPublicUrl(filePath);
  if (urlErr) {
    console.error("Error al obtener URL:", urlErr);
    document.getElementById("status").textContent = "❌ Error obteniendo la URL de la imagen.";
    return;
  }

  // Actualizar tabla usuarios
  const { error: updErr } = await supabase.from("usuarios")
    .update({ logo: publicUrl })
    .eq("auth_id", currentUser.id);

  if (updErr) {
    console.error("Error al actualizar tabla usuarios:", updErr);
    document.getElementById("status").textContent = "❌ Error guardando la imagen en tu perfil.";
    return;
  }

  document.getElementById("userLogo").src = publicUrl;
  document.getElementById("status").textContent = "✅ Imagen subida correctamente.";
  // actualizar localStorage
  let stored = JSON.parse(localStorage.getItem("currentUser") || "{}");
  stored.logo = publicUrl;
  localStorage.setItem("currentUser", JSON.stringify(stored));
}
  async function uploadProfileImage(file) {
  if (!currentUser || !currentUser.id) return alert("Debes iniciar sesión.");

  try {
    const { data, error } = await supabase.storage
      .from('avatars')
      .upload(`profile_${currentUser.id}.png`, file, { upsert: true });

    if (error) {
      console.error("Error al subir la imagen:", error);
      let errorMsg = `Error al subir la imagen: ${error.message || "Desconocido"}`;
      if (error.status) errorMsg += ` (Status: ${error.status})`;
      if (error.details) errorMsg += ` - Detalles: ${error.details}`;
      return alert(errorMsg);
    }

    const { data: urlData, error: urlError } = supabase.storage
      .from('avatars')
      .getPublicUrl(`profile_${currentUser.id}.png`);

    if (urlError) {
      console.error("Error obteniendo URL pública:", urlError);
      return alert(`Error obteniendo URL de la imagen: ${urlError.message}`);
    }

    // actualizar logo en la UI y en la BDD
    document.getElementById('userLogo').src = urlData.publicUrl;
    await supabase.from('usuarios').update({ logo: urlData.publicUrl }).eq('id', currentUser.id);
    currentUser.logo = urlData.publicUrl;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    alert("✅ Imagen subida correctamente.");
  } catch (e) {
    console.error("Excepción al subir imagen:", e);
    alert(`Excepción al subir imagen: ${e.message || e}`);
  }
}

</script>

</body>
</html>
