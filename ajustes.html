<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ajustes - PekeOS</title>
<style>
:root{--accent:#00ffd0}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:linear-gradient(180deg,#021018,#04121a);color:#bfffee;padding:14px;height:100vh;overflow:auto}
.h1{font-weight:800;font-size:20px}
.layout{display:flex;gap:12px;margin-top:12px}
.left{flex:1}
.right{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(0,255,208,0.04);padding:12px;border-radius:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);margin-bottom:12px}
.label{font-weight:700;color:#9ef7ea}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:inherit;width:100%}
.btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;background:transparent;color:inherit}
.previewBox{height:140px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);display:flex;align-items:center;justify-content:center;margin-bottom:8px}
.small{font-size:13px;color:#9ef7ea}
</style>
</head>
<body>
  <div>
    <div class="h1">‚öôÔ∏è Ajustes ‚Äî PekeOS</div>
    <div style="font-size:13px;color:#9ef7ea">Aplica cambios reales al escritorio y guarda en LocalStorage.</div>
  </div>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="label">üé® Color principal</div>
        <input id="accentColor" class="input" type="color" value="#00ffd0" />
      </div>

      <div class="card">
        <div class="label">üñºÔ∏è Fondo del escritorio</div>
        <input id="bgFile" type="file" class="input" />
        <input id="bgUrl" class="input" placeholder="O pega URL de imagen" style="margin-top:8px" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="applyBg">Aplicar fondo</button>
          <button class="btn" id="clearBg">Quitar fondo</button>
        </div>
      </div>

      <div class="card">
        <div class="label">üî≥ Opacidad de ventanas</div>
        <input id="winOpacity" type="range" min="0.5" max="1" step="0.01" value="0.96" style="width:100%" />
        <div class="small">Valor actual: <span id="opVal">0.96</span></div>
      </div>

      <div class="card">
        <div class="label">‚úî Aplicar y Guardar</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="applySettingsBtn">‚úî Aplicar cambios</button>
          <button class="btn" id="saveSettingsBtn">üíæ Guardar</button>
        </div>
      </div>

    </div>

    <div class="right">
      <div style="font-weight:700">Previsualizaci√≥n</div>
      <div class="previewBox" id="previewBox">Preview</div>

      <div class="card">
        <div style="font-weight:700">Estado guardado</div>
        <pre id="currentState" style="white-space:pre-wrap;font-size:12px;color:#9ef7ea"></pre>
      </div>
    </div>
  </div>

<script>
const THEME_KEY = 'pekeos_theme_v1';
function defaultTheme(){ return { accent:'#00ffd0', bg:null, winOpacity:0.96 }; }
let theme = defaultTheme();
try{ const raw = localStorage.getItem(THEME_KEY); if(raw) theme = JSON.parse(raw); }catch(e){ theme = defaultTheme(); }

/* elements */
const accentColor = document.getElementById('accentColor'), bgFile = document.getElementById('bgFile'), bgUrl = document.getElementById('bgUrl');
const applyBgBtn = document.getElementById('applyBg'), clearBgBtn = document.getElementById('clearBg');
const winOpacity = document.getElementById('winOpacity'), opVal = document.getElementById('opVal'), previewBox = document.getElementById('previewBox');
const currentState = document.getElementById('currentState');

accentColor.value = theme.accent || '#00ffd0'; bgUrl.value = theme.bg || ''; winOpacity.value = theme.winOpacity || 0.96; opVal.textContent = winOpacity.value;
updatePreview(); updateStateView();

function hexToRgba(hex,a=1){ hex=hex.replace('#',''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

function applyToParent(t){
  try{
    const pd = parent.document;
    if(t.accent){ pd.documentElement.style.setProperty('--neon', t.accent); pd.documentElement.style.setProperty('--accent', t.accent); }
    if(t.bg){ pd.getElementById('desktop').style.backgroundImage = `url('${t.bg}')`; pd.getElementById('desktop').style.backgroundSize = 'cover'; } else pd.getElementById('desktop').style.backgroundImage = '';
    if(t.winOpacity!==undefined){ pd.documentElement.style.setProperty('--win-opacity', t.winOpacity); pd.querySelectorAll('.win').forEach(w=> w.style.opacity = t.winOpacity); }
    localStorage.setItem(THEME_KEY, JSON.stringify(t));
  }catch(e){ console.warn('No se pudo aplicar al parent',e); }
  updatePreview(); updateStateView();
}

document.getElementById('applySettingsBtn').addEventListener('click', ()=>{
  theme.accent = accentColor.value; theme.winOpacity = parseFloat(winOpacity.value);
  // bg handled separately
  applyToParent(theme); alert('Ajustes aplicados');
});
document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{ localStorage.setItem(THEME_KEY, JSON.stringify(theme)); alert('Ajustes guardados'); updateStateView(); });

winOpacity.addEventListener('input', ()=>{ opVal.textContent = winOpacity.value; });

applyBgBtn.addEventListener('click', async ()=>{
  const file = bgFile.files[0];
  if(file){
    const data = await readFileAsDataURL(file);
    theme.bg = data; bgUrl.value=''; applyToParent(theme);
  } else if(bgUrl.value.trim()){ theme.bg = bgUrl.value.trim(); applyToParent(theme); }
  else alert('Selecciona archivo o pega URL');
});
clearBgBtn.addEventListener('click', ()=>{ theme.bg = null; bgUrl.value=''; applyToParent(theme); });

function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function updatePreview(){ previewBox.style.background = theme.bg ? `url('${theme.bg}') center/cover` : 'linear-gradient(180deg,#04101a,#021018)'; previewBox.style.border = `1px solid ${hexToRgba(theme.accent,0.12)}`; previewBox.style.boxShadow = `0 10px 30px ${hexToRgba(theme.accent,0.03)}`; previewBox.style.color = theme.accent; }
function updateStateView(){ currentState.textContent = JSON.stringify(theme, null, 2); }
updatePreview(); updateStateView();

/* try apply initially (if open inside PekeOS) */
try{ applyToParent(theme); }catch(e){}

  / Cargar ajustes actuales al abrir ajustes.html
window.addEventListener("load", () => {
    const saved = JSON.parse(localStorage.getItem("pekeos_settings") || "{}");

    if(saved.wallpaper) document.getElementById("wallpaper").value = saved.wallpaper;
    if(saved.theme) document.getElementById("theme").value = saved.theme;
});

// Guardar ajustes al pulsar Aplicar
function aplicarCambios() {
    const ajustes = {
        wallpaper: document.getElementById("wallpaper").value,
        theme: document.getElementById("theme").value
    };

    localStorage.setItem("pekeos_settings", JSON.stringify(ajustes));

    // üî• Notificar a PekeOS que hay cambios
    localStorage.setItem("pekeos_update", Date.now());

    alert("Cambios aplicados correctamente ‚úî");
}
</script>
</body>
</html>
