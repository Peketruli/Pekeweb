<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ajustes - PekeOS (Real)</title>
<style>
:root{--bg:#04101a;--accent:#00ffd0;--win-opacity:0.96;--blur:8px;}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
body{margin:0;background:linear-gradient(180deg,#02060a,#04101a);color:#bfffee;padding:16px;height:100vh;overflow:auto}
.h1{font-weight:800;font-size:20px}
.layout{display:flex;gap:12px;margin-top:12px}
.left{flex:1}
.right{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(0,255,208,0.04);padding:12px;border-radius:10px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:12px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);margin-bottom:12px}
.label{font-weight:700;color:#9ef7ea}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:inherit}
.btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;background:transparent;color:inherit}
.small{font-size:13px;color:#9ef7ea}
.previewBox{height:140px;border-radius:8px;border:1px solid rgba(0,255,208,0.03);display:flex;align-items:center;justify-content:center;margin-bottom:8px}
</style>
</head>
<body>
  <div>
    <div class="h1">‚öôÔ∏è Ajustes reales ‚Äî PekeOS</div>
    <div style="font-size:13px;color:#9ef7ea">Los ajustes se aplican en tiempo real y se guardan en LocalStorage.</div>
  </div>

  <div class="layout">
    <div class="left">
      <div class="card">
        <div class="label">üé® Color principal</div>
        <input id="accentColor" class="input" type="color" value="#00ffd0">
        <div style="margin-top:8px" class="small">Cambia el color ne√≥n principal</div>
      </div>

      <div class="card">
        <div class="label">üñºÔ∏è Fondo del escritorio</div>
        <input id="bgFile" type="file" class="input">
        <input id="bgUrl" class="input" placeholder="O pega URL de imagen" style="margin-top:8px">
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="applyBg">Aplicar fondo</button>
          <button class="btn" id="clearBg">Quitar fondo</button>
        </div>
      </div>

      <div class="card">
        <div class="label">üî≥ Opacidad de ventanas</div>
        <input id="winOpacity" type="range" min="0.5" max="1" step="0.01" value="0.96">
        <div class="small">Valor actual: <span id="opVal">0.96</span></div>
      </div>

      <div class="card">
        <div class="label">üîÅ Restaurar valores</div>
        <button class="btn" id="restoreDefaults">Restaurar por defecto</button>
      </div>
    </div>

    <div class="right">
      <div style="font-weight:700">Previsualizaci√≥n</div>
      <div class="previewBox" id="previewBox">PekeOS preview</div>

      <div class="card">
        <div style="font-weight:700">Estado actual</div>
        <pre id="currentState" style="white-space:pre-wrap;font-size:12px;color:#9ef7ea"></pre>
      </div>
    </div>
  </div>

<script>
const THEME_KEY = 'pekeos_theme_v1';

/* cargar tema guardado o por defecto */
function defaultTheme(){
  return { accent:'#00ffd0', bg:null, winOpacity:0.96 };
}
let theme = defaultTheme();
try{ const raw = localStorage.getItem(THEME_KEY); if(raw) theme = JSON.parse(raw); }catch(e){ theme = defaultTheme(); }

/* elements */
const accentColor = document.getElementById('accentColor');
const bgFile = document.getElementById('bgFile');
const bgUrl = document.getElementById('bgUrl');
const applyBg = document.getElementById('applyBg');
const clearBg = document.getElementById('clearBg');
const winOpacity = document.getElementById('winOpacity');
const opVal = document.getElementById('opVal');
const previewBox = document.getElementById('previewBox');
const currentState = document.getElementById('currentState');

/* inicializar inputs */
accentColor.value = theme.accent || '#00ffd0';
bgUrl.value = theme.bg || '';
winOpacity.value = theme.winOpacity || 0.96;
opVal.textContent = winOpacity.value;
updatePreview();

/* helpers para aplicar al parent (tu index) */
function applyToParent(t){
  try{
    const pd = parent.document;
    // cambiar variables CSS si existen
    pd.documentElement.style.setProperty('--neon', t.accent);
    pd.documentElement.style.setProperty('--accent', t.accent);
    // taskbar box-shadow ajustado si existe
    const task = pd.getElementById('taskbar');
    if(task){
      task.style.boxShadow = `0 10px 40px rgba(2,8,12,0.6), 0 0 30px ${hexToRgba(t.accent,0.04)}`;
    }
    // aplicar fondo al desktop si existe
    const desk = pd.getElementById('desktop');
    if(desk){
      if(t.bg) desk.style.backgroundImage = `url('${t.bg}')`;
      else desk.style.backgroundImage = '';
    }
    // aplicar opacidad en ventanas
    const wins = pd.querySelectorAll('.win');
    wins.forEach(w => {
      w.style.opacity = t.winOpacity;
      // also adjust border glow subtly
      w.style.borderColor = hexToRgba(t.accent,0.16);
      w.style.boxShadow = `0 30px 80px rgba(2,10,16,0.6), 0 0 40px ${hexToRgba(t.accent,0.02)}`;
    });
  }catch(e){
    // si no hay padre (abierto solo), aplicar local preview
    console.warn('No parent to apply theme:', e);
  }
  // actualizar vista local
  updatePreview();
  saveTheme();
}

/* util hex->rgba */
function hexToRgba(hex,a=1){
  hex = hex.replace('#','');
  const r = parseInt(hex.slice(0,2),16), g = parseInt(hex.slice(2,4),16), b = parseInt(hex.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* acciones UI */
accentColor.addEventListener('input', ()=> {
  theme.accent = accentColor.value;
  applyToParent(theme);
});
winOpacity.addEventListener('input', ()=> {
  theme.winOpacity = parseFloat(winOpacity.value);
  opVal.textContent = theme.winOpacity;
  applyToParent(theme);
});
applyBg.addEventListener('click', async ()=>{
  const file = bgFile.files[0];
  if(file){
    const data = await readFileAsDataURL(file);
    theme.bg = data;
    bgUrl.value = '';
    applyToParent(theme);
  } else if(bgUrl.value.trim()){
    theme.bg = bgUrl.value.trim();
    applyToParent(theme);
  } else alert('Selecciona archivo o pega una URL');
});
clearBg.addEventListener('click', ()=> {
  theme.bg = null; bgUrl.value=''; bgFile.value=''; applyToParent(theme);
});
document.getElementById('restoreDefaults').addEventListener('click', ()=>{
  theme = defaultTheme();
  accentColor.value = theme.accent; bgUrl.value=''; bgFile.value=''; winOpacity.value = theme.winOpacity; opVal.textContent = theme.winOpacity;
  applyToParent(theme);
});

/* filereader as dataURL */
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* save theme localStorage */
function saveTheme(){
  try{ localStorage.setItem(THEME_KEY, JSON.stringify(theme)); updateStateView(); }catch(e){ console.warn('No se pudo guardar theme', e); }
}
function updateStateView(){ currentState.textContent = JSON.stringify(theme, null, 2); }
function updatePreview(){
  // show small preview using styles
  previewBox.style.background = theme.bg ? `url('${theme.bg}') center/cover` : 'linear-gradient(180deg,#04101a,#021018)';
  previewBox.style.border = `1px solid ${hexToRgba(theme.accent,0.12)}`;
  previewBox.style.boxShadow = `0 10px 30px ${hexToRgba(theme.accent,0.03)}`;
  previewBox.style.color = theme.accent;
  updateStateView();
}

/* init apply to parent */
applyToParent(theme);

/* guardar on unload */
window.addEventListener('beforeunload', ()=> saveTheme());
</script>
</body>
</html>
