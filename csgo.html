<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Prototipo 2D v11 - IA y Economía</title>
    
    <style>
        body { margin: 0; padding: 0; background-color: #111; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; background-color: #111; margin: 0 auto; cursor: crosshair; }
        #shopMenu { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(30, 30, 30, 0.9); border: 2px solid #ccc; border-radius: 10px; padding: 20px; color: white; z-index: 10; }
        #shopMenu h2 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .shop-category { margin-bottom: 15px; }
        .shop-category h3 { color: #aaa; margin-bottom: 5px; }
        .shop-item { display: block; width: 100%; padding: 10px; margin-bottom: 5px; background-color: #555; color: white; border: 1px solid #777; cursor: pointer; font-size: 16px; text-align: left; }
        .shop-item:hover { background-color: #777; }
    </style>
</head>
<body>
    
    <div id="shopMenu">
        <h2>Tienda (Pulsa 'B' para cerrar)</h2>
        <div class="shop-category">
            <h3>Rifles</h3>
            <button class="shop-item" data-item="ak47" data-cost="2700">AK-47 ($2700)</button>
            <button class="shop-item" data-item="m4a1" data-cost="3100">M4A1-S ($3100)</button>
            <button class="shop-item" data-item="awp" data-cost="4750">AWP ($4750)</button>
        </div>
        <div class="shop-category">
            <h3>Equipo</h3>
            <button class="shop-item" data-item="kevlar" data-cost="650">Chaleco ($650)</button>
            <button class="shop-item" data-item="full_armor" data-cost="1000">Chaleco + Casco ($1000)</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- 1. CONFIGURACIÓN INICIAL ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const shopMenuElement = document.getElementById('shopMenu');
        const shopButtons = document.querySelectorAll('.shop-item');

        const world = { width: 3000, height: 2000 };
        const mapData = { playerSize: 20, botSize: 20 };
        let camera = { x: 0, y: 0 };

        // --- 2. EL MAPA (Tu diseño) ---
        const walls = [ /* Tu array de paredes de 48 líneas va aquí... */ { x: 1696, y: 1311, width: 85, height: 632 }, { x: 1682, y: 1, width: 99, height: 579 }, { x: 1658, y: 774, width: 578, height: 381 }, { x: 1885, y: 429, width: 350, height: 355 }, { x: 1954, y: 1367, width: 328, height: 231 }, { x: 1841, y: 107, width: 395, height: 119 }, { x: 1402, y: 532, width: 135, height: 463 }, { x: 899, y: 209, width: 496, height: 337 }, { x: 881, y: 204, width: 523, height: 423 }, { x: 839, y: 119, width: 59, height: 507 }, { x: -1, y: 2, width: 345, height: 617 }, { x: 542, y: 293, width: 31, height: 22 }, { x: 571, y: 204, width: 33, height: 21 }, { x: 609, y: 268, width: 34, height: 23 }, { x: 493, y: 181, width: 19, height: 166 }, { x: 512, y: 347, width: 133, height: 24 }, { x: 494, y: 348, width: 356, height: 276 }, { x: 493, y: 340, width: 19, height: 15 }, { x: 491, y: 9, width: 26, height: 50 }, { x: 491, y: 3, width: 25, height: 9 }, { x: 594, y: 142, width: 24, height: 12 }, { x: 656, y: 182, width: 66, height: 35 }, { x: 761, y: 106, width: 21, height: 189 }, { x: 1, y: 3, width: 1520, height: 9 }, { x: 1522, y: 5, width: 1453, height: 6 }, { x: 2978, y: 7, width: 10, height: 3 }, { x: 2972, y: 5, width: 17, height: 6 }, { x: 2980, y: 9, width: 5, height: 728 }, { x: 2983, y: 738, width: 3, height: 610 }, { x: 2981, y: 739, width: 4, height: 615 }, { x: 2981, y: 1353, width: 3, height: 627 }, { x: 1465, y: 1943, width: 1520, height: 35 }, { x: -2, y: 1943, width: 1469, height: 35 }, { x: 0, y: 1225, width: 12, height: 720 }, { x: 4, y: 661, width: 8, height: 566 }, { x: 2, y: 604, width: 9, height: 59 }, { x: 1353, y: 1259, width: 200, height: 108 }, { x: 1159, y: 1035, width: 135, height: 123 }, { x: 1339, y: 1367, width: 67, height: 433 }, { x: 533, y: 1479, width: 115, height: 332 }, { x: 815, y: 1333, width: 355, height: 107 }, { x: 535, y: 1129, width: 143, height: 100 }, { x: 767, y: 826, width: 217, height: 236 }, { x: 1137, y: 692, width: 73, height: 55 }, { x: 501, y: 715, width: 58, height: 68 }, { x: 142, y: 1606, width: 405, height: 205 }, { x: 834, y: 1603, width: 40, height: 31 }, { x: 940, y: 1547, width: 260, height: 63 }, { x: 1115, y: 1662, width: 28, height: 76 }, { x: 943, y: 1706, width: 8, height: 31 }, { x: 875, y: 1767, width: 43, height: 29 }, { x: 898, y: 1656, width: 43, height: 15 }, { x: 1046, y: 1812, width: 40, height: 29 }, { x: 838, y: 1873, width: 33, height: 21 }, { x: 989, y: 1840, width: 94, height: 105 }, { x: 1190, y: 1783, width: 66, height: 36 } ];
        const zones = [ { x: 52, y: 969, width: 180, height: 236, color: 'rgba(0, 150, 255, 0.5)', name: 'Spawn AT' }, { x: 2528, y: 976, width: 276, height: 243, color: 'rgba(255, 100, 0, 0.5)', name: 'Spawn T' }, { x: 545, y: 195, width: 130, height: 114, color: 'rgba(255, 69, 0, 0.5)', name: 'Sitio A' }, { x: 814, y: 1572, width: 396, height: 317, color: 'rgba(255, 69, 0, 0.5)', name: 'Sitio B' } ];

        // --- 3. EL JUGADOR ---
        let player = {
            x: 142, y: 1087,
            size: mapData.playerSize,
            color: 'cyan', 
            speed: 4,
            angle: 0,
            health: 100, // (NUEVO)
            money: 800, 
            inventory: { primary: 'pistol', kevlar: false, helmet: false }
        };

        // --- 4. ALMACENES Y ESTADO ---
        let bullets = [];
        let keys = {};
        let mouse = { x: 0, y: 0 }; 
        let isShopOpen = false;
        
        // --- (NUEVO) Almacenes de IA ---
        let bots = [];
        let botBullets = [];

        // --- 5. SEGUIMIENTO DE EVENTOS ---
        window.addEventListener('mousemove', (e) => { 
            mouse.x = e.clientX + camera.x;
            mouse.y = e.clientY + camera.y;
        });
        window.addEventListener('keydown', (e) => { keys[e.key] = true; });
        window.addEventListener('keyup', (e) => {
            delete keys[e.key];
            if (e.key === 'b' || e.key === 'B') {
                let inSpawn = false;
                for (const zone of zones) {
                    if (zone.name === 'Spawn AT' && checkZoneCollision(player, zone)) {
                        inSpawn = true;
                        break;
                    }
                }
                if (inSpawn) isShopOpen = !isShopOpen;
                else isShopOpen = false;
            }
        });
        window.addEventListener('mousedown', (e) => {
            if (isShopOpen) return; 
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            const bullet = {
                x: player.x,
                y: player.y,
                size: 5, 
                color: 'yellow',
                speed: 10,
                angle: angle,
                damage: 34 // (NUEVO) Daño de la bala
            };
            bullets.push(bullet);
        });
        
        shopButtons.forEach(button => {
            button.addEventListener('click', () => {
                const item = button.dataset.item;
                const cost = parseInt(button.dataset.cost);
                if (player.money >= cost) {
                    player.money -= cost;
                    buyItem(item);
                    isShopOpen = false; 
                } else {
                    console.log("Dinero insuficiente");
                }
            });
        });
        function buyItem(item) {
            console.log("Comprado: " + item);
            switch (item) {
                case 'ak47': case 'm4a1': case 'awp':
                    player.inventory.primary = item;
                    break;
                case 'kevlar':
                    player.inventory.kevlar = true;
                    player.inventory.helmet = false; 
                    break;
                case 'full_armor':
                    player.inventory.kevlar = true;
                    player.inventory.helmet = true;
                    break;
            }
        }

        // --- 6. FUNCIONES DE COLISIÓN ---
        function checkCollision(obj, wall) {
            const objLeft = obj.x - obj.size / 2;
            const objRight = obj.x + obj.size / 2;
            const objTop = obj.y - obj.size / 2;
            const objBottom = obj.y + obj.size / 2;
            const wallLeft = wall.x;
            const wallRight = wall.x + wall.width;
            const wallTop = wall.y;
            const wallBottom = wall.y + wall.height;
            return (objRight > wallLeft && objLeft < wallRight && objBottom > wallTop && objTop < wallBottom);
        }
        function checkZoneCollision(player, zone) {
            const playerLeft = player.x - player.size / 2;
            const playerRight = player.x + player.size / 2;
            const playerTop = player.y - player.size / 2;
            const playerBottom = player.y + player.size / 2;
            const zoneLeft = zone.x;
            const zoneRight = zone.x + zone.width;
            const zoneTop = zone.y;
            const zoneBottom = zone.y + zone.height;
            return (playerRight > zoneLeft && playerLeft < zoneRight && playerBottom > zoneTop && playerTop < zoneBottom);
        }
        
        // (NUEVO) Colisión entre dos objetos (ej. bala y jugador)
        function checkObjectCollision(obj1, obj2) {
            const obj1Left = obj1.x - obj1.size / 2;
            const obj1Right = obj1.x + obj1.size / 2;
            const obj1Top = obj1.y - obj1.size / 2;
            const obj1Bottom = obj1.y + obj1.size / 2;
            const obj2Left = obj2.x - obj2.size / 2;
            const obj2Right = obj2.x + obj2.size / 2;
            const obj2Top = obj2.y - obj2.size / 2;
            const obj2Bottom = obj2.y + obj2.size / 2;
            return (obj1Right > obj2Left && obj1Left < obj2Right && obj1Bottom > obj2Top && obj1Top < obj2Bottom);
        }
        
        // --- (NUEVO) LÓGICA DE IA ---
        
        // Función para encontrar el centro de una zona por su nombre
        function getZoneCenter(name) {
            for (const zone of zones) {
                if (zone.name === name) {
                    return {
                        x: zone.x + zone.width / 2,
                        y: zone.y + zone.height / 2
                    };
                }
            }
            return { x: 2666, y: 1097 }; // Fallback si no lo encuentra
        }

        // Crear un bot
        function spawnBot() {
            const spawnPoint = getZoneCenter('Spawn T');
            const bot = {
                x: spawnPoint.x,
                y: spawnPoint.y,
                size: mapData.botSize,
                color: 'red',
                speed: 2.5, // Más lento que el jugador
                angle: 0,
                health: 100,
                state: 'seeking', // 'seeking' o 'attacking'
                lastShotTime: 0,
                shootCooldown: 500 // Dispara cada 0.5s
            };
            bots.push(bot);
        }
        
        // Función de Línea de Visión (LOS)
        // Lanza un "rayo" (una serie de puntos) desde el bot al jugador
        function canSeePlayer(bot) {
            const angle = Math.atan2(player.y - bot.y, player.x - bot.x);
            const distance = Math.hypot(player.x - bot.x, player.y - bot.y);
            
            // Si está muy lejos, no lo ve
            if (distance > 1000) return false; 

            // Probamos 10 puntos a lo largo de la línea
            for (let i = 0.1; i < 1; i += 0.1) {
                const testPoint = {
                    x: bot.x + (player.x - bot.x) * i,
                    y: bot.y + (player.y - bot.y) * i,
                    size: 2 // Un punto pequeño
                };
                // Si algún punto choca con una pared, la visión está bloqueada
                for (const wall of walls) {
                    if (checkCollision(testPoint, wall)) {
                        return false;
                    }
                }
            }
            return true; // No chocó con nada, ¡lo ve!
        }
        
        // El "cerebro" de los bots, se llama cada frame
        function updateBots() {
            for (let i = bots.length - 1; i >= 0; i--) {
                const bot = bots[i];
                
                // Lógica de muerte
                if (bot.health <= 0) {
                    player.money += 300; // ¡ECONOMÍA!
                    bots.splice(i, 1); // Elimina el bot
                    console.log("Bot eliminado, +$300");
                    setTimeout(spawnBot, 3000); // Respawn en 3 segundos
                    continue; // Pasa al siguiente bot
                }

                const angleToPlayer = Math.atan2(player.y - bot.y, player.x - bot.x);

                if (canSeePlayer(bot)) {
                    // --- Estado: ATACANDO ---
                    bot.state = 'attacking';
                    bot.angle = angleToPlayer; // Apunta al jugador
                    
                    // Disparar (con cooldown)
                    if (Date.now() - bot.lastShotTime > bot.shootCooldown) {
                        const bullet = {
                            x: bot.x, y: bot.y, size: 5, color: 'orange', speed: 8, angle: bot.angle, damage: 10
                        };
                        botBullets.push(bullet);
                        bot.lastShotTime = Date.now();
                    }
                } else {
                    // --- Estado: BUSCANDO ---
                    bot.state = 'seeking';
                    bot.angle = angleToPlayer; // Guarda la última dirección conocida
                    
                    // Moverse hacia el jugador (IA "tonta")
                    const oldX = bot.x;
                    const oldY = bot.y;
                    
                    bot.x += Math.cos(bot.angle) * bot.speed;
                    for (const wall of walls) {
                        if (checkCollision(bot, wall)) { bot.x = oldX; break; }
                    }
                    
                    bot.y += Math.sin(bot.angle) * bot.speed;
                    for (const wall of walls) {
                        if (checkCollision(bot, wall)) { bot.y = oldY; break; }
                    }
                }
            }
        }
        
        // --- 7. FUNCIÓN DE ACTUALIZACIÓN (Lógica) ---
        function update() {
            if (isShopOpen) return; // Pausa el juego

            // Lógica del Jugador
            const oldX = player.x;
            const oldY = player.y;
            if (keys['a'] || keys['A']) { player.x -= player.speed; }
            if (keys['d'] || keys['D']) { player.x += player.speed; }
            for (const wall of walls) { if (checkCollision(player, wall)) { player.x = oldX; break; } }
            if (keys['w'] || keys['W']) { player.y -= player.speed; }
            if (keys['s'] || keys['S']) { player.y += player.speed; }
            for (const wall of walls) { if (checkCollision(player, wall)) { player.y = oldY; break; } }
            player.angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);

            // --- Lógica de Balas del JUGADOR ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                let bullet = bullets[i];
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;
                let bulletHit = false;

                // ¿Bala choca con pared?
                for (const wall of walls) {
                    if (checkCollision(bullet, wall)) {
                        bullets.splice(i, 1); bulletHit = true; break; 
                    }
                }
                if (bulletHit) continue; 
                
                // (NUEVO) ¿Bala choca con BOT?
                for (const bot of bots) {
                    if (checkObjectCollision(bullet, bot)) {
                        bot.health -= bullet.damage; // Hace daño al bot
                        bullets.splice(i, 1); bulletHit = true; break;
                    }
                }
                if (bulletHit) continue;

                if (bullet.x < 0 || bullet.x > world.width || bullet.y < 0 || bullet.y > world.height) {
                    bullets.splice(i, 1);
                }
            }
            
            // --- (NUEVO) Lógica de Balas del BOT ---
            for (let i = botBullets.length - 1; i >= 0; i--) {
                let bullet = botBullets[i];
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;
                let bulletHit = false;

                // ¿Bala choca con pared?
                for (const wall of walls) {
                    if (checkCollision(bullet, wall)) {
                        botBullets.splice(i, 1); bulletHit = true; break; 
                    }
                }
                if (bulletHit) continue;
                
                // ¿Bala choca con JUGADOR?
                if (checkObjectCollision(bullet, player)) {
                    player.health -= bullet.damage; // Hace daño al jugador
                    botBullets.splice(i, 1); bulletHit = true;
                    // (Opcional: añadir lógica de muerte del jugador)
                    if (player.health <= 0) console.log("¡HAS MUERTO!");
                }
                if (bulletHit) continue;

                if (bullet.x < 0 || bullet.x > world.width || bullet.y < 0 || bullet.y > world.height) {
                    botBullets.splice(i, 1);
                }
            }
            
            // --- (NUEVO) Actualizar IA ---
            updateBots();
            
            // Lógica de la Cámara
            camera.x = player.x - canvas.width / 2;
            camera.y = player.y - canvas.height / 2;
            if (camera.x < 0) camera.x = 0;
            if (camera.y < 0) camera.y = 0;
            if (camera.x + canvas.width > world.width) camera.x = world.width - canvas.width;
            if (camera.y + canvas.height > world.height) camera.y = world.height - canvas.height;
        }

        // --- 8. FUNCIÓN DE DIBUJADO (Gráficos) ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // Dibujar Suelo
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 0, world.width, world.height);

            // Dibujar Zonas
            for (const zone of zones) {
                ctx.fillStyle = zone.color;
                ctx.fillRect(zone.x, zone.y, zone.width, zone.height);
                ctx.fillStyle = 'white'; ctx.font = '20px Arial'; ctx.textAlign = 'center';
                ctx.fillText(zone.name, zone.x + zone.width / 2, zone.y + zone.height / 2);
            }

            // Dibujar Paredes
            ctx.fillStyle = '#999';
            for (const wall of walls) { ctx.fillRect(wall.x, wall.y, wall.width, wall.height); }

            // Dibujar Balas del Jugador
            ctx.fillStyle = 'yellow';
            for (const bullet of bullets) {
                ctx.beginPath(); ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2); ctx.fill();
            }
            
            // (NUEVO) Dibujar Balas del Bot
            ctx.fillStyle = 'orange';
            for (const bullet of botBullets) {
                ctx.beginPath(); ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2); ctx.fill();
            }

            // (NUEVO) Dibujar Bots
            for (const bot of bots) {
                ctx.save();
                ctx.translate(bot.x, bot.y);
                ctx.rotate(bot.angle);
                ctx.fillStyle = bot.color;
                ctx.fillRect(-bot.size / 2, -bot.size / 2, bot.size, bot.size);
                ctx.strokeStyle = 'black'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(bot.size, 0); ctx.stroke();
                ctx.restore();
                
                // (NUEVO) Barra de vida del bot
                ctx.fillStyle = 'red';
                ctx.fillRect(bot.x - bot.size / 2, bot.y - bot.size / 2 - 10, bot.size, 5);
                ctx.fillStyle = 'green';
                ctx.fillRect(bot.x - bot.size / 2, bot.y - bot.size / 2 - 10, bot.size * (bot.health / 100), 5);
            }

            // Dibujar Jugador
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle);
            ctx.fillStyle = player.color;
            ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(player.size, 0); ctx.stroke();
            ctx.restore(); 
            
            ctx.restore(); // Restaura la cámara

            // Dibujar HUD
            ctx.fillStyle = 'white'; ctx.font = '24px Arial';
            ctx.fillText(`Vida: ${player.health}`, 20, 30);
            ctx.fillText(`Dinero: $${player.money}`, 20, 60); 
            ctx.fillText(`Arma: ${player.inventory.primary}`, 20, 90);
            
            // Controlar UI de Tienda
            if (isShopOpen) {
                shopMenuElement.style.display = 'block'; canvas.style.cursor = 'default';
            } else {
                shopMenuElement.style.display = 'none'; canvas.style.cursor = 'crosshair';
            }
        }

        // --- 9. EL BUCLE DEL JUEGO ---
        function gameLoop() {
            update(); // Lógica
            draw();   // Gráficos
            requestAnimationFrame(gameLoop);
        }

        // --- ¡EMPEZAR JUEGO! ---
        spawnBot(); // ¡Llamamos al primer bot!
        gameLoop(); 
    </script>
</body>
</html>
