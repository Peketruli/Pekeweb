<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CSGO 2D â€” Boceto Dust2 (map funcional)</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f14;color:#fff;font-family:Inter,Arial,sans-serif;}
  canvas{display:block}
  #hud{position:fixed;left:12px;top:12px;background:rgba(0,0,0,0.5);padding:8px;border-radius:8px}
  #tips{position:fixed;right:12px;top:12px;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px;font-size:13px}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="hud">Cargando mapa...</div>
<div id="tips">WASD mover â€¢ Click disparar (no implementado) â€¢ Esc para pausar</div>

<script>
// --- canvas / retina sizing ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');
let W = innerWidth, H = innerHeight;
function resize(){
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
addEventListener('resize', resize);
resize();

// --- ajustes ---
const TILE = 48;
const MAP_GRID = [
  "#############################################",
  "#T............#####..........#..............#",
  "#T..................#........#..............#",
  "###########...#.....#####....#..............#",
  "#.............#.........#....#..............#",
  "#......#####..#.........#...................#",
  "#......####...#######.........##............#",
  "#......###.........#########.......###......#",
  "#......####............#.....#..............#",
  "#......######..........#.....#..............#",
  "#......##########...####.....#..............#",
  "#......######................#..............#",
  "#...............##..####.....#####.......####",
  "#...............##....##....................#",
  "#...............###...##....................#",
  "#...............####..##..............B.....#",
  "#...............####........................#",
  "#.........##########..##....................#",
  "######.................#....................#",
  "#....#.................#....................#",
  "#..A...................#....................#",
  "###....................#....................#",
  "#......................#....................#",
  "#......................#...................c#",
  "#..........................................c#",
  "#############################################"
];

const MAP_W = MAP_GRID[0].length * TILE;
const MAP_H = MAP_GRID.length * TILE;

function findTile(ch){
  for(let y=0;y<MAP_GRID.length;y++){
    for(let x=0;x<MAP_GRID[y].length;x++){
      if(MAP_GRID[y][x]===ch){
        return {x: x*TILE + TILE/2, y: y*TILE + TILE/2};
      }
    }
  }
  return null;
}

// --- paredes y coberturas ---
const walls = [];
const covers = [];
for(let y=0;y<MAP_GRID.length;y++){
  for(let x=0;x<MAP_GRID[y].length;x++){
    const c = MAP_GRID[y][x];
    if(c === "#") walls.push({x:x*TILE,y:y*TILE,w:TILE,h:TILE});
    else if(c === "X") covers.push({x:x*TILE+6,y:y*TILE+6,w:TILE-12,h:TILE-12,hp:3});
  }
}

// --- posiciones clave ---
const spawnT = findTile('T') || {x: TILE*2, y: TILE*2};
const spawnCT = findTile('C') || {x: MAP_W - TILE*3, y: MAP_H - TILE*3};
const siteApos = findTile('A') || {x: MAP_W - TILE*6, y: MAP_H - TILE*9};
const siteBpos = findTile('B') || {x: MAP_W - TILE*5, y: MAP_H - TILE*6};

// --- entidades ---
class Entity {
  constructor(x,y,team,name,color){
    this.x = x; this.y = y;
    this.size = 10;
    this.team = team;
    this.name = name || '';
    this.color = color || (team==='T' ? '#ff6666' : '#66d1ff');
    this.hp = 100;
    this.alive = true;
    this.speed = team==='T'?1.4:1.2;
    this.hasBomb = false;
    this.state = 'idle';
    this.target = null;
  }
  draw(ctx){
    if(!this.alive) return;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
    if(this.hasBomb){
      ctx.fillStyle = "yellow";
      ctx.beginPath();
      ctx.arc(this.x,this.y-14,4,0,Math.PI*2);
      ctx.fill();
    }
    ctx.fillStyle = "#fff";
    ctx.font = "11px Arial";
    ctx.textAlign = "center";
    ctx.fillText(this.name,this.x,this.y+20);
  }
  moveTowards(tx,ty,spd){
    const dx = tx - this.x, dy = ty - this.y;
    const d = Math.hypot(dx,dy)||1;
    const nx = this.x+(dx/d)*spd;
    const ny = this.y+(dy/d)*spd;
    if(!collidesAt(nx,this.y,this.size)) this.x=nx;
    if(!collidesAt(this.x,ny,this.size)) this.y=ny;
  }
}

// Jugador y equipos
const player = new Entity(spawnCT.x, spawnCT.y, 'CT', 'TÃº', '#3fe8d0');
player.speed = 3.2;
const allies = [];
const enemies = [];

// 4 CT aliados
for(let i=0;i<4;i++){
  allies.push(new Entity(spawnCT.x + (Math.random()*100-50), spawnCT.y + (Math.random()*100-50),
    'CT', ['Alpha','Bravo','Charlie','Delta'][i], '#66d1ff'));
}

// 5 Terroristas, el primero lleva la bomba
for(let i=0;i<5;i++){
  const e = new Entity(spawnT.x + Math.random()*100 - 40, spawnT.y + Math.random()*60 - 20,
    'T','T-'+(i+1),'#ff8a7a');
  if(i===0) e.hasBomb = true;
  enemies.push(e);
}

let bomb = {x:0,y:0,planted:false,timer:0,site:null};

// --- input ---
const keys={};
addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;if(e.key==='Escape')paused=!paused;});
addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// --- colisiones ---
function rectIntersects(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}
function collidesAt(px,py,r){
  for(const w of walls)
    if(rectIntersects(w.x,w.y,w.w,w.h,px-r,py-r,r*2,r*2)) return true;
  return false;
}

// --- cÃ¡mara ---
let camX=0, camY=0;
function updateCamera(){
  camX = player.x - W/2;
  camY = player.y - H/2;
  camX = Math.max(0,Math.min(camX,MAP_W-W));
  camY = Math.max(0,Math.min(camY,MAP_H-H));
}

// --- IA ---
function updateAI(bot){
  if(!bot.alive) return;
  if(bot.team==='T'){
    if(!bomb.planted){
      if(!bot.target){
        // el que lleva la bomba elige site A o B
        bot.target = bot.hasBomb ? (Math.random()<0.5?siteApos:siteBpos) : siteBpos;
      }
      bot.moveTowards(bot.target.x,bot.target.y,bot.speed);
      if(bot.hasBomb){
        const dist = Math.hypot(bot.x - bot.target.x, bot.y - bot.target.y);
        if(dist<40){
          bomb = {x:bot.x, y:bot.y, planted:true, timer:600, site:bot.target===siteApos?'A':'B'};
          bot.hasBomb=false;
          console.log("ðŸ’£ Bomba plantada en", bomb.site);
        }
      }
    }
  }else if(bot.team==='CT' && bomb.planted){
    // CTs van hacia la bomba
    bot.moveTowards(bomb.x,bomb.y,bot.speed);
    const dist = Math.hypot(bot.x - bomb.x, bot.y - bomb.y);
    if(dist<30){
      bomb.planted=false;
      bomb.timer=0;
      console.log("ðŸ§° Bomba desactivada por",bot.name);
    }
  }
}

// --- render mapa ---
function drawMap(){
  for(let y=0;y<MAP_GRID.length;y++){
    for(let x=0;x<MAP_GRID[y].length;x++){
      const ch = MAP_GRID[y][x];
      const px = x*TILE, py = y*TILE;
      if(ch==='#'){
        ctx.fillStyle='#2f2f2f';
        ctx.fillRect(px,py,TILE,TILE);
      }else if(ch==='A'||ch==='B'){
        ctx.fillStyle='#3a3a2f';
        ctx.fillRect(px,py,TILE,TILE);
      }else{
        ctx.fillStyle='#272727';
        ctx.fillRect(px,py,TILE,TILE);
      }
    }
  }
  for(const c of covers){
    ctx.fillStyle='#555';
    ctx.fillRect(c.x,c.y,c.w,c.h);
  }
  // Bomb indicator
  if(bomb.planted){
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.arc(bomb.x,bomb.y,10,0,Math.PI*2);
    ctx.fill();
  }
}

// --- bucle principal ---
let paused=false;
function update(){
  if(paused){requestAnimationFrame(update);return;}
  // movimiento jugador
  let mvx=0,mvy=0;
  if(keys['w'])mvy-=player.speed;
  if(keys['s'])mvy+=player.speed;
  if(keys['a'])mvx-=player.speed;
  if(keys['d'])mvx+=player.speed;
  if(mvx&&mvy){mvx*=Math.SQRT1_2;mvy*=Math.SQRT1_2;}
  const nx=player.x+mvx,ny=player.y+mvy;
  if(!collidesAt(nx,player.y,player.size))player.x=nx;
  if(!collidesAt(player.x,ny,player.size))player.y=ny;

  // bots
  for(const a of allies)updateAI(a);
  for(const e of enemies)updateAI(e);

  if(bomb.planted){
    bomb.timer--;
    if(bomb.timer<=0){
      bomb.planted=false;
      console.log("ðŸ’¥ Bomba explotÃ³!");
    }
  }

  updateCamera();
  draw();
  requestAnimationFrame(update);
}

// --- dibujar ---
function draw(){
  ctx.fillStyle='#0b0f14';
  ctx.fillRect(0,0,W,H);
  ctx.save();
  ctx.translate(-camX,-camY);
  drawMap();
  for(const e of enemies)e.draw(ctx);
  for(const a of allies)a.draw(ctx);
  player.draw(ctx);
  ctx.restore();

  // HUD
  if(bomb.planted){
    hud.innerHTML=`<b>ðŸ’£ Bomba plantada en ${bomb.site}</b><br>Tiempo: ${(bomb.timer/60).toFixed(1)}s`;
  }else{
    hud.innerHTML=`<b>CSGO 2D</b><br>HP: ${player.hp} | CT vivos: ${allies.length} | T vivos: ${enemies.length}`;
  }
}

hud.textContent="Mapa listo.";
requestAnimationFrame(update);
</script>
</body>
</html>
