<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CSGO 2D - Menú Corregido</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        #game-container {
            border: 2px solid #555;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
        /* Estilo para los botones que se renderizarán en el DOM (Menú) */
        .menu-button {
            width: 250px;
            padding: 15px;
            margin: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            background-color: #2c3e50; /* Azul oscuro CS:GO */
            border: 2px solid #3498db;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .menu-button:hover {
            background-color: #34495e;
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div id="game-container">
        </div>

    <script>
        //==============================================================
        // CONSTANTES GLOBALES
        //==============================================================
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 800;
        const PLAYER_SPEED = 300;
        const BULLET_SPEED = 800;
        const FIRE_RATE = 150; 

        //==============================================================
        // CLASE ESCENA: MENU PRINCIPAL
        //==============================================================
        class MainMenu extends Phaser.Scene {
            constructor() {
                super('MainMenu');
            }

            create() {
                this.cameras.main.setBackgroundColor('#2c3e50');

                this.add.text(GAME_WIDTH / 2, 150, 'CS:GO 2D', {
                    fontSize: '64px',
                    fill: '#ecf0f1',
                    fontFamily: 'Arial Black'
                }).setOrigin(0.5);

                const container = document.getElementById('game-container');
                const canvas = this.game.canvas;
                
                // Función para añadir y posicionar botones HTML
                const addButton = (text, yOffset, sceneKey) => {
                    let button = document.createElement('button');
                    button.textContent = text;
                    button.className = 'menu-button';
                    
                    // Posicionamiento
                    button.style.position = 'absolute';
                    button.style.left = (canvas.offsetLeft + GAME_WIDTH / 2 - 125) + 'px';
                    button.style.top = (canvas.offsetTop + GAME_HEIGHT / 2 + yOffset) + 'px';
                    
                    button.onclick = () => {
                        // Limpiar los botones al cambiar de escena
                        container.removeChild(onlineButton);
                        container.removeChild(offlineButton);
                        // Iniciar la escena
                        this.scene.start(sceneKey); 
                    };

                    container.appendChild(button);
                    return button;
                };

                // Botón Online llama a la escena de carga
                const onlineButton = addButton('JUGAR ONLINE (5v5)', -50, 'LoadingScene');
                // Botón Offline llama directamente a la escena de juego
                const offlineButton = addButton('PRACTICA / OFFLINE', 50, 'GameScene');

                this.onlineButton = onlineButton;
                this.offlineButton = offlineButton;
            }

            // Limpieza de botones DOM
            shutdown() {
                 const container = document.getElementById('game-container');
                 if (this.onlineButton && this.onlineButton.parentNode === container) container.removeChild(this.onlineButton);
                 if (this.offlineButton && this.offlineButton.parentNode === container) container.removeChild(this.offlineButton);
            }
        }

        //==============================================================
        // CLASE ESCENA: CARGA (ONLINE)
        //==============================================================
        class LoadingScene extends Phaser.Scene {
            constructor() {
                super('LoadingScene');
            }

            create() {
                this.cameras.main.setBackgroundColor('#1c2a35'); // Fondo más oscuro para carga
                
                this.add.text(GAME_WIDTH / 2, GAME_HEIGHT / 2 - 50, 'BUSCANDO PARTIDA...', {
                    fontSize: '32px',
                    fill: '#f39c12', // Naranja/Amarillo
                    fontFamily: 'Arial'
                }).setOrigin(0.5);

                const workingText = this.add.text(GAME_WIDTH / 2, GAME_HEIGHT / 2 + 50, 'Trabajando...', {
                    fontSize: '48px',
                    fill: '#ecf0f1',
                    fontFamily: 'Arial Black'
                }).setOrigin(0.5);

                // Simulación de "trabajo" con puntos suspensivos que parpadean
                let dots = 0;
                this.time.addEvent({
                    delay: 500, // Actualizar cada 0.5 segundos
                    callback: () => {
                        dots = (dots + 1) % 4; // 0, 1, 2, 3
                        let text = 'Trabajando' + '.'.repeat(dots);
                        workingText.setText(text);
                    },
                    loop: true
                });

                // Simular un tiempo de espera de 3 segundos para la "conexión" antes de volver al menú
                // En el futuro, este será el punto donde se conecta a Supabase.
                this.time.delayedCall(3000, () => {
                    // Por ahora, volvemos al menú. Aquí es donde pondríamos la llamada a Supabase.
                    this.scene.start('MainMenu'); 
                });
            }
        }

        //==============================================================
        // CLASE ESCENA: JUEGO PRINCIPAL (OFFLINE)
        //==============================================================
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
                this.player = null;
                this.keys = null;
                this.bullets = null;
                this.lastShotTime = 0;
            }

            create() {
                this.cameras.main.setBackgroundColor('#34495e'); 
                this.createPlayer();
                this.setupControls();
                this.setupBullets();
                this.setupCamera();
            }

            // --- Creación del Jugador ---
            createPlayer() {
                // Jugador de color verde (para diferenciar)
                this.player = this.add.rectangle(400, 300, 32, 32, 0x2ecc71); // Verde esmeralda
                this.physics.add.existing(this.player); 
                this.player.body.setCollideWorldBounds(true);
                this.player.setOrigin(0.5, 0.5);
                
                // Línea de mira
                let sightLine = this.add.graphics().lineStyle(2, 0x000000, 0.8).strokeLineShape(new Phaser.Geom.Line(0, 0, 30, 0));
                this.player.add(sightLine); 
            }

            // --- Controles de Jugador ---
            setupControls() {
                this.keys = this.input.keyboard.addKeys({
                    up: Phaser.Input.Keyboard.KeyCodes.W,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.A,
                    right: Phaser.Input.Keyboard.KeyCodes.D
                });
                this.input.on('pointerdown', this.handleShoot, this);
            }

            // --- Balas ---
            setupBullets() {
                this.bullets = this.physics.add.group({
                    classType: Phaser.GameObjects.Arc,
                    maxSize: 50, 
                    runChildUpdate: true,
                    createCallback: (bullet) => {
                        bullet.setOrigin(0.5).setRadius(4).setFillStyle(0xe74c3c); // Rojo sangre
                        bullet.body.allowGravity = false;
                        bullet.body.setCircle(4);
                    }
                });
            }

            // --- Cámara ---
            setupCamera() {
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
                this.cameras.main.setZoom(1.5);
            }

            // --- Bucle de Actualización ---
            update(time, delta) {
                this.handleMovement();
                this.handleAiming();
            }

            handleMovement() {
                this.player.body.setVelocity(0);
                let moving = false;
                
                if (this.keys.up.isDown) { this.player.body.setVelocityY(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.down.isDown) { this.player.body.setVelocityY(PLAYER_SPEED); moving = true; }
                if (this.keys.left.isDown) { this.player.body.setVelocityX(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.right.isDown) { this.player.body.setVelocityX(PLAYER_SPEED); moving = true; }

                if (moving) { this.player.body.velocity.normalize().scale(PLAYER_SPEED); }
            }

            handleAiming() {
                let pointer = this.input.activePointer;
                let angle = Phaser.Math.Angle.Between(this.player.x, this.player.y, pointer.worldX, pointer.worldY);
                this.player.rotation = angle;
            }

            handleShoot(pointer) {
                let currentTime = this.time.now;

                if (currentTime > this.lastShotTime + FIRE_RATE) {
                    this.lastShotTime = currentTime;
                    
                    let bullet = this.bullets.get(this.player.x, this.player.y);
                    if (bullet) {
                        bullet.setActive(true).setVisible(true);

                        let direction = new Phaser.Math.Vector2().setToPolar(this.player.rotation, 1); 
                        bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                        
                        // Reciclaje de balas
                        bullet.update = () => {
                            if (Phaser.Math.Distance.Between(bullet.x, bullet.y, this.player.x, this.player.y) > 1200) {
                                bullet.setActive(false).setVisible(false).body.stop();
                            }
                        };
                    }
                }
            }
        }

        //==============================================================
        // INICIALIZACIÓN DE PHASER
        //==============================================================
        const gameConfig = {
            type: Phaser.AUTO,
            width: GAME_WIDTH,
            height: GAME_HEIGHT,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 } 
                }
            },
            scene: [MainMenu, LoadingScene, GameScene], // Listado de escenas
            parent: 'game-container'
        };

        const game = new Phaser.Game(gameConfig);
    </script>
</body>
</html>
