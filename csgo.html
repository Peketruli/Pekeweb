<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CSGO 2D - Base Funcional</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #game-container {
            border: 2px solid #555;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div id="game-container">
        </div>

    <script>
        //==============================================================
        // CONSTANTES GLOBALES
        //==============================================================
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 800;
        const PLAYER_SPEED = 300;
        const BULLET_SPEED = 800;

        //==============================================================
        // CLASE ESCENA: JUEGO (ÚNICA ESCENA)
        //==============================================================
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
                this.player = null; // Variable para nuestro jugador
                this.keys = null;   // Variable para las teclas (W,A,S,D)
                this.bullets = null; // Variable para el grupo de balas
            }

            create() {
                // 1. Fondo (Para que no se vea negro)
                this.cameras.main.setBackgroundColor('#34495e');
                this.add.rectangle(GAME_WIDTH / 2, GAME_HEIGHT / 2, GAME_WIDTH, GAME_HEIGHT, 0xbdc3c7);

                // 2. Creación del Personaje
                this.player = this.add.rectangle(GAME_WIDTH / 2, GAME_HEIGHT / 2, 32, 32, 0x2ecc71); // Rectángulo verde
                this.physics.add.existing(this.player); // Añadir físicas
                
                this.player.body.setCollideWorldBounds(true); // No puede salir del mapa
                this.player.setOrigin(0.5, 0.5);
                this.player.body.setCircle(16); // Hitbox circular

                // Añadir una "mira" (línea) al jugador para saber dónde apunta
                let sightLine = this.add.graphics().lineStyle(2, 0x000000, 0.8).strokeLineShape(new Phaser.Geom.Line(0, 0, 30, 0));
                this.player.add(sightLine); 

                // 3. Configuración de la Cámara (Centrada en el jugador)
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
                this.cameras.main.setZoom(1.5); // Zoom para ver mejor

                // 4. Configuración de Controles (Movimiento y Disparo)
                this.keys = this.input.keyboard.addKeys('W,A,S,D'); // Configurar W,A,S,D
                
                // Configurar el clic del ratón para disparar
                this.input.on('pointerdown', this.handleShoot, this);

                // 5. Configuración del Grupo de Balas
                this.bullets = this.physics.add.group({
                    classType: Phaser.GameObjects.Arc, // Las balas serán círculos
                    maxSize: 30, 
                    runChildUpdate: true,
                    createCallback: (bullet) => {
                        bullet.setOrigin(0.5).setRadius(4).setFillStyle(0xe74c3c); // Rojas
                        bullet.body.allowGravity = false;
                        bullet.body.setCircle(4);
                    }
                });
            }

            // --- Bucle Principal (Se llama 60 veces por segundo) ---
            update(time, delta) {
                this.handleMovement();
                this.handleAiming();
            }

            // --- Lógica de Movimiento ---
            handleMovement() {
                this.player.body.setVelocity(0); // El jugador se detiene si no se presiona nada
                let moving = false;
                
                // Vertical
                if (this.keys.W.isDown) { this.player.body.setVelocityY(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.S.isDown) { this.player.body.setVelocityY(PLAYER_SPEED); moving = true; }
                
                // Horizontal
                if (this.keys.A.isDown) { this.player.body.setVelocityX(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.D.isDown) { this.player.body.setVelocityX(PLAYER_SPEED); moving = true; }

                // Normalizar velocidad (para que no vaya más rápido en diagonal)
                if (moving) { 
                    this.player.body.velocity.normalize().scale(PLAYER_SPEED); 
                }
            }

            // --- Lógica de Apuntado ---
            handleAiming() {
                // Rotar el jugador para que mire hacia el cursor del ratón
                let pointer = this.input.activePointer;
                let angle = Phaser.Math.Angle.Between(
                    this.player.x, 
                    this.player.y, 
                    pointer.worldX, // Coordenada X del ratón en el mundo del juego
                    pointer.worldY  // Coordenada Y del ratón en el mundo del juego
                );
                this.player.rotation = angle;
            }

            // --- Lógica de Disparo ---
            handleShoot(pointer) {
                let bullet = this.bullets.get(this.player.x, this.player.y);
                
                if (bullet) {
                    bullet.setActive(true).setVisible(true);

                    // Dirección de la bala (basada en la rotación del jugador)
                    let direction = new Phaser.Math.Vector2().setToPolar(this.player.rotation, 1); 
                    bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                    
                    // Reciclaje de balas (si se alejan mucho)
                    bullet.update = () => {
                        if (Phaser.Math.Distance.Between(bullet.x, bullet.y, this.player.x, this.player.y) > 1200) {
                            bullet.setActive(false).setVisible(false).body.stop();
                        }
                    };
                }
            }
        }

        //==============================================================
        // INICIALIZACIÓN DE PHASER (Carga directa de la escena)
        //==============================================================
        const gameConfig = {
            type: Phaser.AUTO,
            width: GAME_WIDTH,
            height: GAME_HEIGHT,
            physics: {
                default: 'arcade', // Habilita el motor de físicas
                arcade: {
                    gravity: { y: 0 } // Sin gravedad
                }
            },
            scene: [GameScene], // Carga la escena de juego directamente
            parent: 'game-container'
        };

        const game = new Phaser.Game(gameConfig);
    </script>
</body>
</html>
