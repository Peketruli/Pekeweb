<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CSGO 2D - Solución Pantalla Negra</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #game-container {
            border: 2px solid #555;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div id="game-container">
        </div>

    <script>
        // COMPROBACIÓN DE CARGA DE PHASER: Si la librería no se cargó, esto fallará.
        if (typeof Phaser === 'undefined') {
            document.getElementById('game-container').innerHTML = 
                "<h1>ERROR: No se pudo cargar la librería Phaser.</h1><p>Revisa tu conexión a internet o la ruta del script.</p>";
            throw new Error("Phaser no está definido. Verifique el script src.");
        }
        
        //==============================================================
        // CONSTANTES GLOBALES
        //==============================================================
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 800;
        const PLAYER_SPEED = 300;

        // CONSTANTES DEL ARMA (Pistola básica)
        const FIRE_RATE = 150; 
        const BULLET_SPEED = 800; 
        const MAX_AMMO_IN_MAGAZINE = 12; 
        const RELOAD_TIME = 1500; 
        const RECOIL_AMOUNT = 50; 


        //==============================================================
        // CLASE ESCENA: JUEGO CON MAPA Y ARMAS
        //==============================================================
        class GameScene extends Phaser.Scene {
            constructor() {
                super('GameScene');
                this.player = null;
                this.keys = null;
                this.bullets = null;
                this.walls = null;
                
                this.currentAmmo = MAX_AMMO_IN_MAGAZINE;
                this.lastShotTime = 0;
                this.isReloading = false;
            }

            create() {
                // Configuración de fondo (azul oscuro)
                this.cameras.main.setBackgroundColor('#34495e'); 
                
                this.createMap(); // Dibuja el mapa y las paredes
                this.createPlayer(); // Crea el personaje

                if (!this.player || !this.player.body) {
                    console.error("Fallo: El objeto del jugador o su cuerpo de físicas no se inicializó correctamente.");
                    return; // Detiene la ejecución si el jugador no existe
                }

                // Configuración de elementos del juego
                this.setupControls();
                this.setupBullets();
                this.setupCollisions(); 
                this.setupCamera();
                this.setupHUD(); 
            }
            
            // --- Lógica de Creación ---
            createPlayer() {
                const spawnX = GAME_WIDTH / 2;
                const spawnY = GAME_HEIGHT / 2;
                
                this.player = this.add.rectangle(spawnX, spawnY, 32, 32, 0x2ecc71); 
                this.physics.add.existing(this.player); 
                
                if (this.player.body) {
                    this.player.body.setCollideWorldBounds(true);
                    this.player.body.setDrag(100);
                    this.player.body.setCircle(16);
                }
                this.player.setOrigin(0.5, 0.5);
                
                let sightLine = this.add.graphics().lineStyle(2, 0x000000, 0.8).strokeLineShape(new Phaser.Geom.Line(0, 0, 30, 0));
                this.player.add(sightLine); 
            }

            createMap() {
                // Fondo del área jugable (Gris claro)
                this.add.rectangle(GAME_WIDTH / 2, GAME_HEIGHT / 2, GAME_WIDTH, GAME_HEIGHT, 0xbdc3c7);
                
                this.walls = this.physics.add.staticGroup();

                // Paredes para colisión (Gris oscuro)
                this.walls.create(GAME_WIDTH / 2, GAME_HEIGHT / 2 - 150, null).setSize(400, 50).setDisplaySize(400, 50).setTint(0x7f8c8d); 
                this.walls.create(GAME_WIDTH / 2 + 300, GAME_HEIGHT / 2 + 100, null).setSize(50, 200).setDisplaySize(50, 200).setTint(0x7f8c8d); 
            }

            setupCamera() {
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);
                this.cameras.main.setZoom(1.5);
            }

            setupHUD() {
                this.ammoText = this.add.text(10, 10, this.getAmmoStatus(), {
                    fontSize: '28px',
                    fill: '#ecf0f1'
                }).setScrollFactor(0); 

                this.add.text(GAME_WIDTH / 2, GAME_HEIGHT - 50, 'W/A/S/D: Mover | Click: Disparar | R: Recargar', {
                    fontSize: '24px',
                    fill: '#f1c40f'
                }).setOrigin(0.5).setScrollFactor(0); 
            }

            // --- Lógica de Colisiones ---
            setupCollisions() {
                this.physics.add.collider(this.player, this.walls);
                this.physics.add.collider(this.bullets, this.walls, this.bulletHitWall, null, this);
            }
            
            bulletHitWall(bullet, wall) {
                bullet.setActive(false).setVisible(false).body.stop();
            }

            // --- Lógica de Controles/Armas ---
            setupControls() {
                this.keys = this.input.keyboard.addKeys({
                    up: Phaser.Input.Keyboard.KeyCodes.W,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.A,
                    right: Phaser.Input.Keyboard.KeyCodes.D,
                    reload: Phaser.Input.Keyboard.KeyCodes.R
                });
                this.input.on('pointerdown', this.handleShoot, this);
                this.input.keyboard.on('keydown-R', this.startReload, this);
            }

            setupBullets() {
                this.bullets = this.physics.add.group({
                    classType: Phaser.GameObjects.Arc,
                    maxSize: 50, 
                    runChildUpdate: true,
                    createCallback: (bullet) => {
                        bullet.setOrigin(0.5).setRadius(4).setFillStyle(0xe74c3c);
                        bullet.body.allowGravity = false;
                        bullet.body.setCircle(4);
                        bullet.body.setCollideWorldBounds(true);
                        bullet.body.onWorldBounds = true;
                    }
                });
                
                this.physics.world.on('worldbounds', (body) => {
                    if (body.gameObject.parentContainer === this.bullets) {
                        body.gameObject.setActive(false).setVisible(false).body.stop();
                    }
                });
            }
            
            getAmmoStatus() {
                return this.isReloading ? 
                    `RECARGANDO... (${(RELOAD_TIME / 1000).toFixed(1)}s)` : 
                    `MUNICIÓN: ${this.currentAmmo} / ${MAX_AMMO_IN_MAGAZINE}`;
            }

            // --- Bucle Principal de Actualización ---
            update(time, delta) {
                if (this.player && this.player.body) {
                    this.handleMovement();
                    this.handleAiming();
                    this.ammoText.setText(this.getAmmoStatus());
                }
            }

            handleMovement() {
                this.player.body.setVelocity(0);
                let moving = false;
                
                if (this.keys.up.isDown) { this.player.body.setVelocityY(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.down.isDown) { this.player.body.setVelocityY(PLAYER_SPEED); moving = true; }
                if (this.keys.left.isDown) { this.player.body.setVelocityX(-PLAYER_SPEED); moving = true; } 
                else if (this.keys.right.isDown) { this.player.body.setVelocityX(PLAYER_SPEED); moving = true; }

                if (moving) { 
                    this.player.body.velocity.normalize().scale(PLAYER_SPEED); 
                }
            }

            handleAiming() {
                let pointer = this.input.activePointer;
                let angle = Phaser.Math.Angle.Between(this.player.x, this.player.y, pointer.worldX, pointer.worldY);
                this.player.rotation = angle;
            }

            handleShoot(pointer) {
                let currentTime = this.time.now;
                
                if (this.isReloading || currentTime < this.lastShotTime + FIRE_RATE || this.currentAmmo <= 0) {
                    return;
                }

                this.lastShotTime = currentTime;
                this.currentAmmo--;
                
                let bullet = this.bullets.get(this.player.x, this.player.y);
                if (bullet) {
                    bullet.setActive(true).setVisible(true);
                    
                    const spreadAngle = Phaser.Math.Between(-2, 2) * Phaser.Math.DEG_TO_RAD;
                    const finalAngle = this.player.rotation + spreadAngle;

                    let direction = new Phaser.Math.Vector2().setToPolar(finalAngle, 1); 
                    bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                    
                    this.player.body.setVelocityX(-direction.x * RECOIL_AMOUNT);
                    this.player.body.setVelocityY(-direction.y * RECOIL_AMOUNT);

                    bullet.update = () => {
                        if (Phaser.Math.Distance.Between(bullet.x, bullet.y, this.player.x, this.player.y) > 1200) {
                            bullet.setActive(false).setVisible(false).body.stop();
                        }
                    };
                }
                
                if (this.currentAmmo === 0) {
                    this.startReload();
                }
            }
            
            startReload() {
                if (this.isReloading || this.currentAmmo === MAX_AMMO_IN_MAGAZINE) {
                    return;
                }
                
                this.isReloading = true;
                this.time.delayedCall(RELOAD_TIME, () => {
                    this.currentAmmo = MAX_AMMO_IN_MAGAZINE;
                    this.isReloading = false;
                    this.ammoText.setText(this.getAmmoStatus());
                }, [], this);
            }
        }


        //==============================================================
        // INICIALIZACIÓN DE PHASER
        //==============================================================
        const gameConfig = {
            type: Phaser.AUTO,
            width: GAME_WIDTH,
            height: GAME_HEIGHT,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 } 
                }
            },
            scene: [GameScene],
            parent: 'game-container'
        };

        const game = new Phaser.Game(gameConfig);
    </script>
</body>
</html>
