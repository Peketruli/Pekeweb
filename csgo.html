<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CSGO 2D - Prototipo Multijugador Supabase (Corregido)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #game-container {
            border: 2px solid #555;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
        #info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="game-container">
        </div>
    
    <div id="info-panel">
        <p>Mi ID: <span id="my-id"></span></p>
        <p>Jugadores: <span id="player-count">1</span></p>
        <p>Sala: <span id="room-name"></span></p>
        <p>Mueve: **WASD** | Apunta/Dispara: **Rat贸n**</p>
    </div>

    <script>
        //==============================================================
        // *** CONFIGURACIN SUPABASE (隆MODIFICA ESTO!) ***
        //==============================================================
        // Reemplaza los siguientes valores con tus propias claves
        const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'; 
        
        // El cliente de Supabase se inicializa m谩s abajo

        //==============================================================
        // CONSTANTES Y VARIABLES DE JUEGO
        //==============================================================
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 800;
        const PLAYER_SPEED = 300;
        const BULLET_SPEED = 800;
        const FIRE_RATE = 150; 
        const ROOM_NAME = 'csgo_2d_match_1';
        const BROADCAST_INTERVAL = 33; 
        
        let lastMoveBroadcastTime = 0;
        let lastShotTime = 0;
        let playerID = `player_${Math.random().toString(36).substring(2, 9)}`; 

        // Variables de Juego Globales
        let player; 
        let keys;
        let bullets;
        let remotePlayers = {};
        let roomChannel;
        let supabaseClient; // Declaraci贸n de la variable para el cliente de Supabase

        // Configuraci贸n de Phaser
        const config = {
            type: Phaser.AUTO,
            width: GAME_WIDTH,
            height: GAME_HEIGHT,
            physics: {
                default: 'arcade',
                arcade: {
                    // debug: true, 
                    gravity: { y: 0 } 
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update,
                shoot: shoot 
            },
            parent: 'game-container'
        };

        let game = new Phaser.Game(config);

        //==============================================================
        // PHASER FASES
        //==============================================================
        function preload () {
            // No cargamos assets aqu铆; usamos formas geom茅tricas
        }

        function create () {
            // 1. Inicializar el cliente de Supabase (Se hace aqu铆 para asegurar que el SDK est茅 cargado)
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                alert('ERROR CRTICO: El SDK de Supabase no se ha cargado. Revisa la etiqueta <script> en el HTML.');
            }

            // Actualizar panel de informaci贸n
            document.getElementById('my-id').textContent = playerID;
            document.getElementById('room-name').textContent = ROOM_NAME;

            // 2. Crear el Jugador Local (Rect谩ngulo Blanco)
            player = this.add.rectangle(400, 300, 32, 32, 0xFFFFFF);
            this.physics.add.existing(player); 
            player.body.setCollideWorldBounds(true);
            player.setOrigin(0.5, 0.5);
            player.body.setSize(30, 30);
            
            let sightLine = this.add.graphics().lineStyle(2, 0x00FF00, 0.8).strokeLineShape(new Phaser.Geom.Line(0, 0, 30, 0));
            player.add(sightLine); 

            // 3. Control de Teclado (WASD)
            keys = this.input.keyboard.addKeys({
                up: Phaser.Input.Keyboard.KeyCodes.W,
                down: Phaser.Input.Keyboard.KeyCodes.S,
                left: Phaser.Input.Keyboard.KeyCodes.A,
                right: Phaser.Input.Keyboard.KeyCodes.D
            });

            // 4. Crear el Grupo de Balas
            bullets = this.physics.add.group({
                classType: Phaser.GameObjects.Arc,
                runChildUpdate: true,
                maxSize: 50, 
                createCallback: (bullet) => {
                    bullet.setOrigin(0.5, 0.5);
                    bullet.setRadius(4); 
                    bullet.setFillStyle(0xFF0000); 
                    bullet.body.allowGravity = false;
                }
            });

            // 5. Configurar Disparo con Rat贸n
            this.input.on('pointerdown', function (pointer) {
                if (pointer.primaryDown) {
                    this.scene.shoot(pointer); 
                }
            });

            // 6. Configurar la C谩mara
            this.cameras.main.startFollow(player, true, 0.1, 0.1);
            this.cameras.main.setZoom(1.5);
            
            // 7. 隆Conexi贸n a Supabase!
            joinOrCreateRoom.call(this);
        }

        function update (time, delta) {
            player.body.setVelocity(0);
            let moving = false;
            
            // L贸gica de Movimiento WASD
            if (keys.up.isDown) { player.body.setVelocityY(-PLAYER_SPEED); moving = true; } 
            else if (keys.down.isDown) { player.body.setVelocityY(PLAYER_SPEED); moving = true; }
            if (keys.left.isDown) { player.body.setVelocityX(-PLAYER_SPEED); moving = true; } 
            else if (keys.right.isDown) { player.body.setVelocityX(PLAYER_SPEED); moving = true; }

            // Normalizaci贸n de velocidad diagonal
            if (moving) { player.body.velocity.normalize().scale(PLAYER_SPEED); }

            // L贸gica de Apuntado (Rotaci贸n)
            let pointer = this.input.activePointer;
            let angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.worldX, pointer.worldY);
            player.rotation = angle;

            // -------------------------------------------------------------
            // LGICA MULTIJUGADOR: BROADCAST DE MOVIMIENTO
            // -------------------------------------------------------------
            // Nota: Se env铆a broadcast si nos movemos O si la rotaci贸n cambi贸 significativamente
            if ((moving || Math.abs(player.rotation - (player.lastRotation || 0)) > 0.05) && roomChannel && time > lastMoveBroadcastTime + BROADCAST_INTERVAL) {
                lastMoveBroadcastTime = time;
                player.lastRotation = player.rotation;
                
                roomChannel.send({
                    type: 'broadcast',
                    event: 'player_move',
                    payload: {
                        id: playerID, 
                        x: player.x, 
                        y: player.y, 
                        rot: player.rotation 
                    }
                });
            }
            
            // Actualizaci贸n de etiquetas de nombre remotas
            for (const id in remotePlayers) {
                if (remotePlayers[id] && remotePlayers[id].nameTag) {
                    remotePlayers[id].nameTag.x = remotePlayers[id].x;
                    remotePlayers[id].nameTag.y = remotePlayers[id].y - 20;
                }
            }
        }

        function shoot (pointer) {
            let currentTime = this.time.now;

            if (currentTime > lastShotTime + FIRE_RATE) {
                lastShotTime = currentTime;
                
                let bullet = bullets.get(player.x, player.y);
                if (bullet) {
                    bullet.setActive(true).setVisible(true);

                    let direction = new Phaser.Math.Vector2().setToPolar(player.rotation, 1); 
                    bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                    
                    bullet.update = function () {
                        if (Phaser.Math.Distance.Between(this.x, this.y, player.x, player.y) > 1200) {
                            this.setActive(false).setVisible(false).body.stop();
                        }
                    }

                    // Enviar el Broadcast del disparo
                    if (roomChannel) {
                        roomChannel.send({
                            type: 'broadcast',
                            event: 'player_shoot',
                            payload: {
                                id: playerID, 
                                x_start: player.x, 
                                y_start: player.y,
                                rot: player.rotation
                            }
                        });
                    }
                }
            }
        }


        //==============================================================
        // FUNCIONES SUPABASE REALTIME (CON ALERTS)
        //==============================================================

        async function joinOrCreateRoom() {
            // VERIFICACIN DE CREDENCIALES (usando alert)
            if (SUPABASE_URL.includes('https://jdvwlfogkzrzovepzjqa.supabase.co')) {
                alert('隆ERROR DE CONFIGURACIN!  Debes reemplazar SUPABASE_URL y SUPABASE_ANON_KEY con tus propias credenciales en el c贸digo.');
                return; 
            }
            
            if (!supabaseClient) {
                 alert('ERROR: El cliente de Supabase no se ha inicializado correctamente.');
                 return;
            }

            roomChannel = supabaseClient.channel(ROOM_NAME, {
                config: {
                    presence: { key: playerID }
                }
            });

            // 1. Escuchar la Presencia (Conexi贸n/Desconexi贸n)
            roomChannel.on('presence', { event: 'sync' }, () => {
                const presenceState = roomChannel.presenceState();
                const playerKeys = Object.keys(presenceState);
                
                document.getElementById('player-count').textContent = playerKeys.length;

                // L贸gica para limpiar jugadores desconectados
                for (const id in remotePlayers) {
                    if (!playerKeys.includes(id)) {
                        remotePlayers[id].destroy();
                        remotePlayers[id].nameTag.destroy();
                        delete remotePlayers[id];
                        alert(`隆Jugador ${id} se ha desconectado!`);
                    }
                }
            }).subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await roomChannel.track({ key: playerID, x: player.x, y: player.y });
                    alert(`隆Conectado! Tu ID: ${playerID}. Abre otra ventana para probar.`);
                } else if (status === 'TIMED_OUT') {
                    alert('ERROR DE CONEXIN: La conexi贸n a Supabase ha fallado (Timeout). Revisa tu red o las reglas de RLS en Supabase.');
                }
            });

            // 2. Escuchar Broadcasts
            roomChannel.on('broadcast', { event: 'player_move' }, (payload) => {
                handleRemoteMove.call(this, payload.payload);
            });

            roomChannel.on('broadcast', { event: 'player_shoot' }, (payload) => {
                handleRemoteShoot.call(this, payload.payload);
            });
        }
        
        /**
         * Crea/actualiza el sprite de un jugador remoto.
         */
        function handleRemoteMove(data) {
            if (data.id === playerID) return; 

            let remotePlayer = remotePlayers[data.id];

            if (!remotePlayer) {
                // Crear sprite remoto (Azul)
                remotePlayer = this.add.rectangle(data.x, data.y, 32, 32, 0x0000FF);
                this.physics.add.existing(remotePlayer); 
                remotePlayer.setOrigin(0.5, 0.5);
                remotePlayer.body.setImmovable(true);
                remotePlayers[data.id] = remotePlayer;
                
                // Etiqueta de nombre
                remotePlayer.nameTag = this.add.text(data.x, data.y - 20, data.id, { fontSize: '10px', fill: '#00BFFF' }).setOrigin(0.5);
                alert(`隆Nuevo jugador unido! ID: ${data.id}`);
            }

            // Interpolaci贸n (Tweening) para un movimiento suave
            this.tweens.add({
                targets: remotePlayer,
                x: data.x,
                y: data.y,
                rotation: data.rot,
                duration: BROADCAST_INTERVAL * 2, 
                ease: 'Linear'
            });
            
            // Sincronizar tambi茅n la etiqueta
            this.tweens.add({
                targets: remotePlayer.nameTag,
                x: data.x,
                y: data.y - 20,
                duration: BROADCAST_INTERVAL * 2, 
                ease: 'Linear'
            });
        }

        /**
         * Crea una bala localmente para un jugador remoto (simulaci贸n).
         */
        function handleRemoteShoot(data) {
            if (data.id === playerID) return;

            let bullet = this.scene.bullets.get(data.x_start, data.y_start);
            
            if (bullet) {
                bullet.setActive(true).setVisible(true);

                let direction = new Phaser.Math.Vector2().setToPolar(data.rot, 1); 
                bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                
                bullet.update = function () {
                    if (Phaser.Math.Distance.Between(this.x, this.y, data.x_start, data.y_start) > 1200) {
                        this.setActive(false).setVisible(false).body.stop();
                    }
                }
            }
        }
    </script>
</body>
</html>
