<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CSGO 2D — Ciudad (IA FSM, Cámara, FOV)</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f14;color:#fff;font-family:Inter,Arial,sans-serif}
  canvas{display:block}
  #hud{position:fixed;left:10px;top:10px;background:rgba(0,0,0,0.5);padding:8px;border-radius:8px;font-size:14px}
  #tips{position:fixed;right:10px;top:10px;background:rgba(0,0,0,0.45);padding:8px;border-radius:8px;font-size:13px;text-align:right}
</style>
</head>
<body>
<canvas id="cv"></canvas>
<div id="hud">Cargando...</div>
<div id="tips">WASD mover • Click disparar • E plantar (si T) • F desactivar (si CT)</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// === CONFIGURACIÓN ===
const TILE = 64;
const MAP_W = 30, MAP_H = 20;

const map = [
  // 0 = suelo, 1 = pared
  ...Array(MAP_H).fill().map((_, y) => (
    Array(MAP_W).fill().map((_, x) => (
      (y === 0 || y === MAP_H-1 || x === 0 || x === MAP_W-1) ? 1 :
      (Math.random() < 0.1 ? 1 : 0)
    ))
  ))
];

const player = {
  x: TILE*5, y: TILE*10, angle: 0, speed: 3,
  team: "CT", name: "Player"
};

const allies = [
  {x: TILE*6, y: TILE*9, team:"CT", name:"Bot Nico"},
  {x: TILE*7, y: TILE*10, team:"CT", name:"Bot Alex"},
  {x: TILE*8, y: TILE*11, team:"CT", name:"Bot Dani"},
  {x: TILE*9, y: TILE*10, team:"CT", name:"Bot Raul"}
];

const enemies = [
  {x: TILE*22, y: TILE*10, team:"T", name:"Bot Vlad"},
  {x: TILE*23, y: TILE*11, team:"T", name:"Bot Amir"},
  {x: TILE*24, y: TILE*9, team:"T", name:"Bot Hugo"},
  {x: TILE*25, y: TILE*10, team:"T", name:"Bot Omar"},
  {x: TILE*26, y: TILE*11, team:"T", name:"Bot Yuri"}
];

const bullets = [];

// === INPUT ===
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);
window.addEventListener("mousemove", e => {
  player.angle = Math.atan2(
    e.clientY - canvas.height/2,
    e.clientX - canvas.width/2
  );
});
window.addEventListener("click", shoot);

function shoot() {
  bullets.push({
    x: player.x,
    y: player.y,
    dx: Math.cos(player.angle)*10,
    dy: Math.sin(player.angle)*10,
    team: player.team
  });
}

// === FUNCIONES ===
function move(entity) {
  let dx = 0, dy = 0;
  if (entity === player) {
    if (keys["w"]) dy -= entity.speed;
    if (keys["s"]) dy += entity.speed;
    if (keys["a"]) dx -= entity.speed;
    if (keys["d"]) dx += entity.speed;
  } else {
    // IA simple: moverse aleatoriamente o hacia enemigos cercanos
    const target = (entity.team === "CT" ? enemies : [player, ...allies])
      .reduce((acc, e) => {
        const d = Math.hypot(e.x - entity.x, e.y - entity.y);
        return (!acc || d < acc.d) ? {d, e} : acc;
      }, null);

    if (target && target.d < 500) {
      dx = Math.sign(target.e.x - entity.x) * 1.5;
      dy = Math.sign(target.e.y - entity.y) * 1.5;
      // disparar si está a rango y con visión directa
      if (target.d < 400 && Math.random() < 0.03) {
        bullets.push({
          x: entity.x,
          y: entity.y,
          dx: (target.e.x - entity.x)/target.d * 10,
          dy: (target.e.y - entity.y)/target.d * 10,
          team: entity.team
        });
      }
    } else if (Math.random() < 0.01) {
      dx = (Math.random()-0.5)*3;
      dy = (Math.random()-0.5)*3;
    }
  }

  const newX = entity.x + dx;
  const newY = entity.y + dy;
  if (!collides(newX, newY)) {
    entity.x = newX;
    entity.y = newY;
  }
}

function collides(x, y) {
  const tx = Math.floor(x / TILE);
  const ty = Math.floor(y / TILE);
  return map[ty]?.[tx] === 1;
}

// === BUCLE PRINCIPAL ===
function update() {
  move(player);
  [...allies, ...enemies].forEach(move);

  bullets.forEach(b => {
    b.x += b.dx;
    b.y += b.dy;
  });

  // Colisión de balas con paredes
  for (let i = bullets.length-1; i >= 0; i--) {
    const b = bullets[i];
    if (collides(b.x, b.y)) {
      bullets.splice(i, 1);
      continue;
    }
    const targets = (b.team === "CT" ? enemies : [player, ...allies]);
    for (const t of targets) {
      if (Math.hypot(b.x - t.x, b.y - t.y) < 20) {
        t.dead = true;
        bullets.splice(i, 1);
        break;
      }
    }
  }

  draw();
  requestAnimationFrame(update);
}

function draw() {
  // Cámara centrada en el jugador
  const offsetX = player.x - canvas.width/2;
  const offsetY = player.y - canvas.height/2;

  ctx.fillStyle = "#222";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Mapa
  for (let y=0; y<MAP_H; y++) {
    for (let x=0; x<MAP_W; x++) {
      if (map[y][x] === 1) {
        ctx.fillStyle = "#555";
        ctx.fillRect(x*TILE - offsetX, y*TILE - offsetY, TILE, TILE);
      } else {
        ctx.fillStyle = "#333";
        ctx.fillRect(x*TILE - offsetX, y*TILE - offsetY, TILE, TILE);
      }
    }
  }

  // Entidades
  const allEntities = [player, ...allies, ...enemies];
  allEntities.forEach(e => {
    if (e.dead) return;
    ctx.fillStyle = e.team === "CT" ? "#4af" : "#f44";
    ctx.beginPath();
    ctx.arc(e.x - offsetX, e.y - offsetY, 15, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = "#fff";
    ctx.font = "12px Arial";
    ctx.fillText(e.name, e.x - offsetX - 20, e.y - offsetY - 20);
  });

  // Balas
  ctx.fillStyle = "#ff0";
  bullets.forEach(b => {
    ctx.fillRect(b.x - offsetX, b.y - offsetY, 4, 4);
  });

  // Visión limitada
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.fillStyle = "black";
  ctx.beginPath();
  ctx.rect(0, 0, canvas.width, canvas.height);
  ctx.arc(canvas.width/2, canvas.height/2, 250, 0, Math.PI*2, true);
  ctx.fill("evenodd");
  ctx.restore();
}

// === INICIO ===
update();
</script>
</body>
</html>
