<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CSGO 2D - Prototipo Único</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #111; /* Fondo oscuro */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* Evita barras de desplazamiento */
        }
        #game-container {
            border: 2px solid #333; /* Un borde para ver dónde está el juego */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="game-container">
        </div>

    <script>
        //==============================================================
        // CONFIGURACIÓN GENERAL DEL JUEGO
        //==============================================================
        const GAME_WIDTH = 1200;
        const GAME_HEIGHT = 800;
        const PLAYER_SPEED = 300;
        const BULLET_SPEED = 800;
        const FIRE_RATE = 150; // Milisegundos entre disparos (Cadencia de Fuego)

        // Variables globales de la escena
        let player;
        let keys;
        let bullets;
        let lastShotTime = 0;
        
        // Configuración de Phaser
        const config = {
            type: Phaser.AUTO,
            width: GAME_WIDTH,
            height: GAME_HEIGHT,
            physics: {
                default: 'arcade',
                arcade: {
                    // debug: true, // Descomentar para ver cajas de colisión
                    gravity: { y: 0 } 
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update,
                // Añadimos la función de disparo como un método de la escena
                shoot: shoot 
            },
            parent: 'game-container' // ID del contenedor en el HTML
        };

        let game = new Phaser.Game(config);


        //==============================================================
        // FASE 1: CARGA DE RECURSOS (PRELOAD)
        //==============================================================
        function preload () {
            // En un juego real, cargarías aquí imágenes, sonidos y el mapa de Tiled.
            // Para este prototipo, no cargamos nada, ya que usamos figuras geométricas.
        }

        //==============================================================
        // FASE 1 & 2: INICIALIZACIÓN (CREATE)
        //==============================================================
        function create () {
            // 1. Crear el Jugador (Rectángulo Blanco)
            player = this.add.rectangle(400, 300, 32, 32, 0xFFFFFF); // Blanco
            this.physics.add.existing(player); 
            player.body.setCollideWorldBounds(true);
            player.setOrigin(0.5, 0.5); // Pivote central para rotación
            
            // Dibuja una línea de mira para claridad visual
            let sightLine = this.add.graphics();
            sightLine.lineStyle(2, 0x00FF00, 0.8);
            sightLine.strokeLineShape(new Phaser.Geom.Line(0, 0, 30, 0));
            player.line = this.add.container(0, 0, [sightLine]);
            player.add(player.line); // El objeto de la línea sigue al jugador

            // 2. Control de Teclado (WASD)
            keys = this.input.keyboard.addKeys({
                up: Phaser.Input.Keyboard.KeyCodes.W,
                down: Phaser.Input.Keyboard.KeyCodes.S,
                left: Phaser.Input.Keyboard.KeyCodes.A,
                right: Phaser.Input.Keyboard.KeyCodes.D
            });

            // 3. Crear el Grupo de Balas (para reciclaje eficiente)
            bullets = this.physics.add.group({
                classType: Phaser.GameObjects.Arc, // Círculo simple para la bala
                runChildUpdate: true,
                maxSize: 30, 
                createCallback: (bullet) => {
                    bullet.setOrigin(0.5, 0.5);
                    bullet.setRadius(4); 
                    bullet.setFillStyle(0xFF0000); // Color rojo
                    bullet.body.allowGravity = false;
                }
            });

            // 4. Configurar Disparo con Ratón
            this.input.on('pointerdown', function (pointer) {
                if (pointer.primaryDown) {
                    this.scene.shoot(pointer); 
                }
            });

            // 5. Configurar la Cámara
            this.cameras.main.startFollow(player, true, 0.1, 0.1);
            this.cameras.main.setZoom(1.5);
        }

        //==============================================================
        // FASE 1 & 2: BUCLE DE JUEGO (UPDATE)
        //==============================================================
        function update (time, delta) {
            // 1. Resetear la Velocidad
            player.body.setVelocity(0);

            // 2. Lógica de Movimiento (WASD)
            let moving = false;
            
            if (keys.up.isDown) {
                player.body.setVelocityY(-PLAYER_SPEED);
                moving = true;
            } else if (keys.down.isDown) {
                player.body.setVelocityY(PLAYER_SPEED);
                moving = true;
            }

            if (keys.left.isDown) {
                player.body.setVelocityX(-PLAYER_SPEED);
                moving = true;
            } else if (keys.right.isDown) {
                player.body.setVelocityX(PLAYER_SPEED);
                moving = true;
            }

            // Normalización: Asegura que la velocidad en diagonal sea igual a la horizontal/vertical
            if (moving) {
                player.body.velocity.normalize().scale(PLAYER_SPEED);
            }

            // 3. Lógica de Apuntado (Rotar al jugador hacia el ratón)
            let pointer = this.input.activePointer;

            // Calcular el ángulo (en radianes)
            let angle = Phaser.Math.Angle.Between(
                player.x, 
                player.y, 
                pointer.worldX, // Coordenada del ratón ajustada a la cámara
                pointer.worldY
            );
            
            player.rotation = angle;
        }

        //==============================================================
        // FASE 2: FUNCIÓN DE DISPARO (SHOOT)
        //==============================================================
        function shoot (pointer) {
            let currentTime = this.time.now;

            // Control de cadencia de fuego
            if (currentTime > lastShotTime + FIRE_RATE) {
                
                // Obtener una bala del grupo
                let bullet = bullets.get(player.x, player.y);
                
                if (bullet) {
                    lastShotTime = currentTime;
                    bullet.setActive(true);
                    bullet.setVisible(true);

                    // Dirección de la bala (basada en la rotación del jugador)
                    let direction = new Phaser.Math.Vector2();
                    direction.setToPolar(player.rotation, 1); 

                    // Establecer la velocidad de la bala
                    bullet.body.setVelocity(direction.x * BULLET_SPEED, direction.y * BULLET_SPEED);
                    
                    // Configurar la bala para que se desactive si se aleja mucho
                    bullet.update = function (time, delta) {
                        // Desactivar si sale de los límites
                        if (Phaser.Math.Distance.Between(this.x, this.y, player.x, player.y) > 1000) {
                            this.setActive(false);
                            this.setVisible(false);
                            this.body.stop();
                        }
                    }
                }
            }
        }
        
        //==============================================================
        // PRÓXIMO PASO: ESTRUCTURA MULTIJUGADOR CON SUPABASE
        //==============================================================
        /*
        Para integrar Supabase, necesitarías:
        1. Incluir el SDK de Supabase: <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        2. Configurar la conexión al cliente en JS.
        3. En la función 'create', subscribirte a un canal de Realtime.
        4. En la función 'update', si el jugador se mueve, hacer un 'channel.send({ type: 'broadcast', event: 'player_move', ... })' 
        5. En 'create', escuchar el evento 'player_move' para actualizar las posiciones de los jugadores remotos (otros clientes).
        */
    </script>
</body>
</html>
