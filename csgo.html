<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSGO 2D - Minimap y efectos</title>
<style>
  body { margin:0; padding:0; overflow:hidden; background:#111; }
  canvas { display:block; }
  #hud {
    position: absolute; top:10px; left:10px; color:white; font-family:sans-serif;
    font-size:18px; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="hud"></div>

<audio id="shotSound" src="https://freesound.org/data/previews/66/66717_931655-lq.mp3"></audio>
<audio id="deathSound" src="https://freesound.org/data/previews/41/41524_512123-lq.mp3"></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");
const shotSound = document.getElementById("shotSound");
const deathSound = document.getElementById("deathSound");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

const keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

const mouse = { x: 0, y: 0, clicked: false };
canvas.addEventListener("mousemove", e => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});
canvas.addEventListener("mousedown", () => mouse.clicked = true);
canvas.addEventListener("mouseup", () => mouse.clicked = false);

// --- Jugador ---
const player = { x: 100, y: 100, size: 20, speed: 3, color: "cyan", bullets: [], reload:0, hp: 10, weapon:0 };

// --- Armas ---
const weapons = [
  {name:"Pistola", damage:1, rate:15, speed:7},
  {name:"Rifle", damage:2, rate:8, speed:10},
  {name:"Escopeta", damage:3, rate:30, speed:6}
];

// --- Enemigos ---
let enemies = [];
let round = 1;
function spawnEnemies(){
  enemies = [];
  for(let i=0;i<round+2;i++){
    enemies.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      size:20,
      speed:2,
      color:"red",
      bullets: [],
      reload:0,
      alive:true,
      hp: 3+round
    });
  }
}
spawnEnemies();

// --- Paredes y coberturas ---
const walls = [
  {x:0, y:0, w:canvas.width, h:20},
  {x:0, y:canvas.height-20, w:canvas.width, h:20},
  {x:0, y:0, w:20, h:canvas.height},
  {x:canvas.width-20, y:0, w:20, h:canvas.height},
  {x:200, y:150, w:400, h:20},
  {x:200, y:430, w:400, h:20},
  {x:200, y:150, w:20, h:300},
  {x:580, y:150, w:20, h:300},
  {x:650, y:100, w:20, h:200},
  {x:100, y:350, w:150, h:20},
  {x:400, y:500, w:300, h:20},
  {x:500, y:250, w:40, h:40, destructible:true, hp:3} // Cobertura interactiva
];

// --- Balas ---
function shootBullet(shooter, targetX, targetY){
  const dx = targetX - shooter.x;
  const dy = targetY - shooter.y;
  const dist = Math.hypot(dx,dy);
  shooter.bullets.push({
    x: shooter.x,
    y: shooter.y,
    vx: (dx/dist)*weapons[shooter.weapon].speed,
    vy: (dy/dist)*weapons[shooter.weapon].speed,
    size: 5,
    damage: weapons[shooter.weapon].damage
  });
  if(shooter===player) shotSound.play();
}

// --- Colisiones ---
function collideRectCircle(rect, circle){
  const closestX = Math.max(rect.x, Math.min(circle.x, rect.x+rect.w));
  const closestY = Math.max(rect.y, Math.min(circle.y, rect.y+rect.h));
  const dx = circle.x - closestX;
  const dy = circle.y - closestY;
  return (dx*dx + dy*dy) < (circle.size*circle.size);
}

function moveWithCollisions(entity, dx, dy){
  entity.x += dx;
  if(walls.some(wall => collideRectCircle(wall, entity))) entity.x -= dx;
  entity.y += dy;
  if(walls.some(wall => collideRectCircle(wall, entity))) entity.y -= dy;
}

// --- Game Loop ---
function update(){
  let dx=0, dy=0;
  if(keys["w"]) dy -= player.speed;
  if(keys["s"]) dy += player.speed;
  if(keys["a"]) dx -= player.speed;
  if(keys["d"]) dx += player.speed;
  moveWithCollisions(player, dx, dy);

  if(keys["1"]) player.weapon=0;
  if(keys["2"]) player.weapon=1;
  if(keys["3"]) player.weapon=2;

  if(mouse.clicked && player.reload <=0){
    shootBullet(player, mouse.x, mouse.y);
    player.reload = weapons[player.weapon].rate;
  }
  if(player.reload>0) player.reload--;

  enemies.forEach(enemy => {
    if(!enemy.alive) return;
    const dxE = player.x - enemy.x;
    const dyE = player.y - enemy.y;
    const dist = Math.hypot(dxE, dyE);
    const moveX = (dxE/dist)*enemy.speed;
    const moveY = (dyE/dist)*enemy.speed;
    moveWithCollisions(enemy, moveX, moveY);

    if(enemy.reload<=0 && dist<300){
      enemy.weapon = 0;
      shootBullet(enemy, player.x, player.y);
      enemy.reload = 60;
    }
    if(enemy.reload>0) enemy.reload--;
  });

  [player,...enemies].forEach(shooter=>{
    shooter.bullets.forEach((b,i)=>{
      b.x += b.vx;
      b.y += b.vy;

      // Colisiones con paredes
      for(let wall of walls){
        if(collideRectCircle(wall,b)){
          if(wall.destructible){
            wall.hp -= b.damage;
            if(wall.hp<=0) walls.splice(walls.indexOf(wall),1);
          }
          shooter.bullets.splice(i,1);
          break;
        }
      }

      // Colisiones con enemigos
      if(shooter===player){
        enemies.forEach(enemy => {
          if(enemy.alive && Math.hypot(enemy.x-b.x,enemy.y-b.y)<enemy.size){
            enemy.hp -= b.damage;
            shooter.bullets.splice(i,1);
            if(enemy.hp<=0){
              enemy.alive=false;
              deathSound.play();
            }
          }
        });
      } else {
        if(Math.hypot(player.x-b.x,player.y-b.y)<player.size){
          player.hp -= b.damage;
          shooter.bullets.splice(i,1);
          if(player.hp<=0){
            alert("Â¡Has muerto! Reiniciando ronda");
            player.hp=10;
            spawnEnemies();
          }
        }
      }
    });
  });

  if(enemies.every(e=>!e.alive)){
    round++;
    spawnEnemies();
  }

  draw();
  requestAnimationFrame(update);
}

// --- Dibujar ---
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Paredes
  walls.forEach(wall=>{
    ctx.fillStyle = wall.destructible ? "#aa6600" : "#555";
    ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
  });

  // Jugador
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size,0,Math.PI*2);
  ctx.fill();

  // Enemigos
  enemies.forEach(enemy => {
    if(!enemy.alive) return;
    ctx.fillStyle = enemy.color;
    ctx.beginPath();
    ctx.arc(enemy.x, enemy.y, enemy.size,0,Math.PI*2);
    ctx.fill();
  });

  // Balas
  [player,...enemies].forEach(shooter=>{
    shooter.bullets.forEach(b=>{
      ctx.fillStyle = "yellow";
      ctx.beginPath();
      ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
      ctx.fill();
    });
  });

  // HUD
  hud.innerHTML = `Vida: ${player.hp} | Arma: ${weapons[player.weapon].name} | Ronda: ${round}`;

  // Minimapa
  const mapW = 150, mapH = 150;
  ctx.fillStyle = "rgba(0,0,0,0.5)";
  ctx.fillRect(canvas.width-mapW-10, 10, mapW, mapH);
  // Jugador en minimapa
  ctx.fillStyle="cyan";
  ctx.fillRect(canvas.width-mapW-10 + player.x/canvas.width*mapW-2, 10+player.y/canvas.height*mapH-2,4,4);
  // Enemigos en minimapa
  enemies.forEach(e=>{
    if(!e.alive) return;
    ctx.fillStyle="red";
    ctx.fillRect(canvas.width-mapW-10 + e.x/canvas.width*mapW-2, 10+e.y/canvas.height*mapH-2,4,4);
  });
}

update();
</script>
</body>
</html>
