<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola Administrativa</title>
<style>
  body { font-family: Arial; background: #111; color: #fff; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #444; padding: 8px; text-align: left; }
  th { background: #222; }
</style>
</head>
<body>
<h1>Consola de Movimientos</h1>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Usuario</th>
      <th>Acción</th>
      <th>IP</th>
      <th>Fecha</th>
    </tr>
  </thead>
  <tbody id="logsBody">
    <tr><td colspan="5">Cargando...</td></tr>
  </tbody>
</table>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'
const supabase = createClient(supabaseUrl, supabaseKey)

// --- Función para registrar acciones ---
export async function registrarAccion(userId, accion, ip = 'desconocida') {
  const { data, error } = await supabase
    .from('logs')
    .insert([{ user_id: userId, action: accion, ip }])
  if (error) console.error('Error registrando acción:', error)
}

// --- Registro de usuario ---
export async function registrarUsuario(username, password) {
  // Crear usuario en la tabla usuarios
  const { data: newUser, error } = await supabase
    .from('usuarios')
    .insert([{ username, password }])
    .select()
    .single()

  if (error) {
    console.error('Error creando usuario:', error)
    return null
  }

  // Registrar acción
  await registrarAccion(newUser.id, 'registro')

  return newUser
}

// --- Login ---
export async function loginUsuario(username, password) {
  // Buscar usuario
  const { data: user, error } = await supabase
    .from('usuarios')
    .select('*')
    .eq('username', username)
    .single()

  if (error || !user) {
    console.error('Usuario no encontrado')
    return null
  }

  if (user.password !== password) {
    console.error('Contraseña incorrecta')
    return null
  }

  // Registrar login en logs
  await registrarAccion(user.id, 'login')

  return user
}

// --- Cambio de datos de usuario ---
export async function cambiarDato(userId, campo, valor) {
  const { data, error } = await supabase
    .from('usuarios')
    .update({ [campo]: valor })
    .eq('id', userId)

  if (error) {
    console.error('Error al actualizar dato:', error)
    return false
  }

  await registrarAccion(userId, `cambio de ${campo}`)
  return true
}

// --- Función para obtener logs (opcional, por consola) ---
export async function obtenerLogs(limit = 100) {
  const { data, error } = await supabase
    .from('logs')
    .select('id, action, ip, created_at, user:usuarios(username)')
    .order('created_at', { ascending: false })
    .limit(limit)

  if (error) {
    console.error('Error al cargar logs:', error)
    return []
  }
  return data
}
</script>
</body>
</html>
