<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background-color: #000;
    color: #0f0;
    font-family: "Courier New", monospace;
    padding: 20px;
    white-space: pre-wrap;
    overflow-y: auto;
  }
  h1 {
    color: #0f0;
    text-shadow: 0 0 10px #0f0;
  }
  .error {
    color: red;
    text-align: center;
    font-size: 24px;
    margin-top: 100px;
  }
  #debugUser {
    color: yellow;
    font-weight: bold;
    margin-bottom: 20px;
  }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="debugUser"></div>
<div id="output"></div>

<script>
// ===============================
// 🔧 CONFIGURACIÓN SUPABASE
// ===============================
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ===============================
// 🧠 DETECTAR USUARIO LOCAL
// ===============================
const debugUser = document.getElementById("debugUser");
const output = document.getElementById("output");
const currentUser = localStorage.getItem("currentUser");

debugUser.textContent = "Usuario actual guardado en localStorage: " + (currentUser || "NINGUNO");

// ===============================
// 🚫 SOLO PUEDE VER PEKETRULI
// ===============================
if (currentUser !== "Peketruli") {
  document.body.innerHTML = "<h1 class='error'>Casi pero no, vuelve cuando seas admin 😎</h1>";
} else {
  iniciarConsola();
}

// ===============================
// ⚙️ FUNCIÓN PRINCIPAL DE CONSOLA
// ===============================
async function iniciarConsola() {
  log("🟢 Bienvenido, Peketruli. Consola conectada a Supabase...\n");

  // Cargar historial
  const { data, error } = await supabase
    .from("actividad")
    .select("*")
    .order("fecha", { ascending: true });

  if (error) {
    log("❌ Error al cargar actividad: " + error.message);
  } else if (!data || data.length === 0) {
    log("Sin registros anteriores.\n───────────────\n");
  } else {
    data.forEach(row => {
      const hora = new Date(row.fecha).toLocaleTimeString();
      log(`[${hora}] ${row.usuario} ${row.accion}`);
    });
    log("───────────────\n");
  }

  // Escuchar nuevos registros en tiempo real
  supabase
    .channel("actividad_changes")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "actividad" }, payload => {
      const nuevo = payload.new;
      const hora = new Date(nuevo.fecha).toLocaleTimeString();
      log(`[${hora}] ${nuevo.usuario} ${nuevo.accion}`);
    })
    .subscribe();
}

// ===============================
// 📜 FUNCIONES GLOBALES
// ===============================
window.registrarActividad = async function(accion) {
  const usuario = localStorage.getItem("currentUser") || "Desconocido";

  const { error } = await supabase.from("actividad").insert([
    {
      usuario,
      accion,
      fecha: new Date().toISOString()
    }
  ]);

  if (error) {
    console.error("Error al registrar actividad:", error.message);
  }
};

function log(msg) {
  const time = new Date().toLocaleTimeString();
  output.innerHTML += `[${time}] ${msg}\n`;
  output.scrollTop = output.scrollHeight;
}
</script>
</body>
</html>
