<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Consola Administrativa</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #fff; padding: 20px; }
  h1 { text-align: center; color: #0f0; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #444; padding: 8px; text-align: left; }
  th { background: #222; color: #fff; }
  tr:nth-child(even) { background: #1a1a1a; }
  tr:hover { background: #333; }
  .error { color: red; font-weight: bold; }
  .empty { color: #888; }
</style>
</head>
<body>

<h1>Consola de Movimientos</h1>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Usuario</th>
      <th>Acción</th>
      <th>IP</th>
      <th>Fecha</th>
    </tr>
  </thead>
  <tbody id="logsBody">
    <tr><td colspan="5" class="empty">Cargando...</td></tr>
  </tbody>
</table>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- Conexión Supabase ---
const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI'
const supabase = createClient(supabaseUrl, supabaseKey)

// --- Función para cargar logs ---
async function cargarLogs(limit = 100) {
  const tbody = document.getElementById('logsBody')

  try {
    const { data: logs, error } = await supabase
      .from('logs')
      .select('id, action, ip, created_at, user:usuarios(username)')
      .order('created_at', { ascending: false })
      .limit(limit)

    if (error) {
      tbody.innerHTML = `<tr><td colspan="5" class="error">Error al cargar logs: ${error.message}</td></tr>`
      console.error(error)
      return
    }

    if (!logs || logs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="empty">No hay registros todavía</td></tr>`
      return
    }

    tbody.innerHTML = logs.map(log => `
      <tr>
        <td>${log.id}</td>
        <td>${log.user?.username || 'Desconocido'}</td>
        <td>${log.action}</td>
        <td>${log.ip}</td>
        <td>${new Date(log.created_at).toLocaleString()}</td>
      </tr>
    `).join('')

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="5" class="error">Error inesperado: ${err.message}</td></tr>`
    console.error(err)
  }
}

// --- Actualizar cada 10 segundos ---
cargarLogs()
setInterval(cargarLogs, 10000)

</script>

</body>
</html>
