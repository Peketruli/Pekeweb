<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Consola de Actividad</title>
<style>
  body { background:#000; color:#0f0; font-family:"Courier New",monospace; padding:20px; white-space:pre-wrap; overflow-y:auto; }
  h1 { color:#0f0; text-shadow:0 0 10px #0f0; }
  .error { color:red; text-align:center; font-size:24px; margin-top:100px; }
  #log { display:none; margin-top:20px; }
  #status { display:none; margin-bottom:10px; }
  #clearBtn { margin-top:10px; padding:6px 12px; background:#111; color:#0f0; border:1px solid #0f0; cursor:pointer; border-radius:6px; }
  #clearBtn:hover { background:#0f0; color:#000; }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="status"></div>
<button id="clearBtn">üßπ Limpiar todos los registros</button>
<pre id="log"></pre>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
  // consola.js ‚Äî Panel de administraci√≥n conectado a Supabase

const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ===============================
// üîπ FUNCIONES GENERALES
// ===============================

// Obtener usuario actual del localStorage
function getCurrentUser() {
  try {
    const data = localStorage.getItem("currentUser");
    return data ? JSON.parse(data) : null;
  } catch (err) {
    console.error("Error leyendo usuario:", err);
    return null;
  }
}

// Registrar actividad globalmente
async function registrarActividad(accion) {
  const user = getCurrentUser();
  const usuario = user?.username || "Desconocido";

  try {
    const { error } = await supabase.from("actividad").insert([
      {
        usuario,
        accion,
        fecha: new Date().toISOString(),
      },
    ]);
    if (error) console.error("‚ùå Error al registrar:", error.message);
    else console.log("‚úÖ Actividad registrada:", usuario, accion);
  } catch (err) {
    console.error("‚ö†Ô∏è Error general al registrar actividad:", err);
  }
}

// ===============================
// üîπ MOSTRAR REGISTROS DE SUPABASE
// ===============================

async function mostrarRegistros() {
  const tabla = document.getElementById("tabla-actividad");
  if (!tabla) return;

  tabla.innerHTML = `
    <tr>
      <th>Usuario</th>
      <th>Acci√≥n</th>
      <th>Fecha</th>
    </tr>
  `;

  try {
    const { data, error } = await supabase
      .from("actividad")
      .select("*")
      .order("fecha", { ascending: false });

    if (error) throw error;

    data.forEach((registro) => {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${registro.usuario}</td>
        <td>${registro.accion}</td>
        <td>${new Date(registro.fecha).toLocaleString()}</td>
      `;
      tabla.appendChild(fila);
    });
  } catch (err) {
    console.error("Error cargando registros:", err.message);
  }
}

// ===============================
// üîπ LIMPIAR REGISTROS
// ===============================

async function limpiarRegistros() {
  if (!confirm("¬øSeguro que quieres eliminar todos los registros?")) return;

  try {
    const { error } = await supabase.from("actividad").delete().neq("id", 0);
    if (error) throw error;

    alert("‚úÖ Todos los registros fueron eliminados correctamente.");
    await registrarActividad("ha eliminado todos los registros");
    mostrarRegistros();
  } catch (err) {
    alert("‚ùå Error al eliminar los registros: " + err.message);
  }
}

// ===============================
// üîπ VERIFICAR USUARIO Y ACCESO
// ===============================

function verificarAcceso() {
  const user = getCurrentUser();
  const contenido = document.getElementById("contenido");
  const accesoDenegado = document.getElementById("acceso-denegado");

  if (user && user.username === "Peketruli") {
    // Acceso permitido
    contenido.style.display = "block";
    accesoDenegado.style.display = "none";
    registrarActividad("ha accedido a la consola de administraci√≥n");
    mostrarRegistros();
  } else {
    // Bloqueado
    contenido.style.display = "none";
    accesoDenegado.style.display = "block";
  }
}

// ===============================
// üîπ EJECUCI√ìN AUTOM√ÅTICA
// ===============================

document.addEventListener("DOMContentLoaded", () => {
  verificarAcceso();

  const limpiarBtn = document.getElementById("btn-limpiar");
  if (limpiarBtn) limpiarBtn.addEventListener("click", limpiarRegistros);
});

</script>

</body>
</html>
