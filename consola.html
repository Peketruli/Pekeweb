<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Consola de Actividad (Admin)</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { background:#000; color:#0f0; font-family: "Courier New", monospace; padding:20px; white-space:pre-wrap; }
  h1 { color:#0f0; text-shadow:0 0 10px #0f0; }
  .error { color:#ff5c5c; font-size:20px; text-align:center; margin-top:80px; }
  #output { max-height:70vh; overflow:auto; margin-top:12px; border-top:1px solid #0f0; padding-top:8px; }
  .small { color: #bbb; font-size: 12px; margin-top:6px; }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="info" class="small">Comprobando sesi√≥n...</div>
<div id="output"></div>

<script>
// -------------------------------
// CONFIG (REEMPLAZA ESTO)
// -------------------------------
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";           // tu URL Supabase
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
const adminNames = ["Peketruli"];                                        // <-- Opcional, nombre en metadata si usas eso

// -------------------------------
// Inicializar Supabase
// -------------------------------
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// elementos
const info = document.getElementById("info");
const output = document.getElementById("output");

// -------------------------------
// Funci√≥n para comprobar si el user es admin
// -------------------------------
async function esAdmin() {
  // obtiene el usuario desde la sesi√≥n real de Supabase
  const { data: userData, error: userErr } = await supabase.auth.getUser();

  if (userErr) {
    console.error("Error al obtener usuario:", userErr);
    return { ok: false, reason: "error" };
  }

  const user = userData?.user;
  if (!user) return { ok: false, reason: "no_session" };

  // extrae campos √∫tiles
  const email = user.email || "";
  // metadata puede variar seg√∫n c√≥mo guardes el nombre: prueba varios campos comunes
  const meta = user.user_metadata || {};
  const metadataName = meta.name || meta.preferred_name || meta.username || meta.full_name || "";

  // comprobaciones:
  const emailMatch = adminEmails.some(a => a.toLowerCase() === email.toLowerCase());
  const nameMatch = adminNames.some(a => a.toLowerCase() === (metadataName || "").toLowerCase());
  const displayNameMatch = adminNames.some(a => a.toLowerCase() === (user.user_metadata?.displayName || "").toLowerCase());

  // devolver info para logs
  return {
    ok: emailMatch || nameMatch || displayNameMatch,
    user,
    email,
    metadataName,
    matches: { emailMatch, nameMatch, displayNameMatch }
  };
}

// -------------------------------
// Iniciar (comprobaci√≥n + UI)
// -------------------------------
(async function init() {
  info.innerText = "Comprobando sesi√≥n en Supabase...";
  const check = await esAdmin();

  if (!check.ok) {
    // mostrar mensaje de acceso denegado con motivo razonable
    if (check.reason === "no_session") {
      document.body.innerHTML = `
        <h1 class="error">Acceso denegado</h1>
        <p style="color:#ffb86b; text-align:center;">No hay sesi√≥n activa. Inicia sesi√≥n con tu cuenta (Supabase Auth) para acceder.</p>
        <p style="text-align:center; margin-top:12px;"><a href="/login.html" style="color:#0f0">Ir a login</a></p>
      `;
    } else {
      document.body.innerHTML = "<h1 class='error'>Casi pero no, vuelve cuando seas admin üòé</h1>";
    }
    return;
  }

  // si es admin, iniciamos la consola
  info.innerText = `Conectado como: ${check.email || check.metadataName} ‚Äî iniciando consola...`;
  iniciarConsola();
})();

// -------------------------------
// FUNCIONES DE CONSOLA
// -------------------------------
async function iniciarConsola() {
  log("üü¢ Bienvenido, Peketruli. Consola conectada a Supabase...\n");

  // cargar historial (los √∫ltimos 200 registros por ejemplo)
  const { data, error } = await supabase
    .from("actividad")
    .select("*")
    .order("fecha", { ascending: true })
    .limit(200);

  if (error) {
    log("‚ùå Error al cargar actividad: " + error.message);
  } else if (!data || data.length === 0) {
    log("Sin registros anteriores.\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
  } else {
    data.forEach(row => {
      const hora = new Date(row.fecha).toLocaleString();
      log(`[${hora}] ${row.usuario} ${row.accion}`);
    });
    log("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
  }

  // suscripci√≥n en tiempo real a nuevos INSERTs en tabla actividad
  supabase
    .channel("actividad_changes")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "actividad" }, payload => {
      const nuevo = payload.new;
      const hora = new Date(nuevo.fecha).toLocaleString();
      log(`[${hora}] ${nuevo.usuario} ${nuevo.accion}`);
    })
    .subscribe()
    .then(() => log("Suscripci√≥n a actividad en tiempo real activada."))
    .catch(e => log("No se pudo suscribir en tiempo real: " + (e?.message || e)));
}

// registrarActividad: usa la sesi√≥n real para extraer quien manda la acci√≥n
window.registrarActividad = async function(accion) {
  // intenta obtener usuario desde sesi√≥n
  const { data: userData } = await supabase.auth.getUser();
  const user = userData?.user;
  const usuario = user?.email || user?.user_metadata?.name || localStorage.getItem("currentUser") || "Desconocido";

  const { error } = await supabase.from("actividad").insert([{
    usuario,
    accion,
    fecha: new Date().toISOString()
  }]);

  if (error) {
    console.error("Error al registrar actividad:", error.message);
  }
};

// log visual en pantalla
function log(msg) {
  output.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  output.scrollTop = output.scrollHeight;
}
</script>
</body>
</html>
