<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background:#000;
    color:#0f0;
    font-family:"Courier New",monospace;
    padding:20px;
    white-space:pre-wrap;
    overflow-y:auto;
  }
  h1 { color:#0f0; text-shadow:0 0 10px #0f0; }
  .error {
    color:red;
    text-align:center;
    font-size:24px;
    margin-top:100px;
  }
  button {
    background:#0f0;
    color:#000;
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    margin-bottom:10px;
  }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="status"></div>
<button id="clearBtn" style="display:none;">üßπ Limpiar registros</button>
<pre id="log"></pre>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const clearBtn = document.getElementById("clearBtn");

let rawUser = localStorage.getItem("currentUser");
let currentUser = null;

try {
  currentUser = JSON.parse(rawUser);
} catch {
  currentUser = rawUser;
}

// --- FUNCIONES ---
function isAdmin(user){
  if(!user) return false;
  if(typeof user === "string") return user === "Peketruli";
  if(typeof user === "object") return user.username === "Peketruli";
  return false;
}

async function cargarRegistros(){
  logEl.textContent = "üì° Cargando actividad desde Supabase...\n";
  const { data, error } = await supabase
    .from("actividad")
    .select("*")
    .order("fecha", { ascending: true });

  if(error){
    logEl.textContent += `‚ùå Error al cargar registros: ${error.message}\n`;
    return;
  }

  if(!data || data.length === 0){
    logEl.textContent += "Sin registros.\n";
  } else {
    data.forEach(r => {
      const hora = new Date(r.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${r.usuario} ${r.accion}\n`;
    });
  }

  logEl.scrollTop = logEl.scrollHeight;
}

async function initConsole(){
  if(!isAdmin(currentUser)){
    document.body.innerHTML = "<h1 class='error'>üö´ Acceso denegado. Solo Peketruli puede ver la consola.</h1>";
    return;
  }

  statusEl.textContent = `üü¢ Bienvenido Peketruli ‚Äî acceso concedido`;
  clearBtn.style.display = "inline-block";

  await cargarRegistros();

  // üîÅ Suscripci√≥n en tiempo real
  supabase
    .channel("actividad_changes")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "actividad" }, payload => {
      const n = payload.new;
      const hora = new Date(n.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${n.usuario} ${n.accion}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    })
    .subscribe();
}

// üßπ Bot√≥n para limpiar registros
clearBtn.addEventListener("click", async ()=>{
  if(!confirm("¬øSeguro que deseas eliminar todos los registros?")) return;
  const { error } = await supabase.from("actividad").delete().neq("id", 0);
  if(error){
    alert("‚ùå Error al limpiar registros: " + error.message);
  } else {
    logEl.textContent = "üßπ Registros eliminados correctamente.\n";
  }
});

initConsole();
</script>
</body>
</html>
