<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { background:#000; color:#0f0; font-family:"Courier New",monospace; padding:20px; white-space:pre-wrap; overflow-y:auto; }
  h1 { color:#0f0; text-shadow:0 0 10px #0f0; }
  .error { color:red; text-align:center; font-size:24px; margin-top:100px; }
  #log { display:none; margin-top:20px; }
  #status { display:none; margin-bottom:10px; }
  #clearBtn { margin-top:10px; padding:6px 12px; background:#111; color:#0f0; border:1px solid #0f0; cursor:pointer; border-radius:6px; }
  #clearBtn:hover { background:#0f0; color:#000; }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="status"></div>
<button id="clearBtn">üßπ Limpiar todos los registros</button>
<pre id="log"></pre>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");
const clearBtn = document.getElementById("clearBtn");

// Leer usuario del localStorage
let rawUser = localStorage.getItem("currentUser");
let currentUser = null;
try { currentUser = JSON.parse(rawUser); } catch { currentUser = rawUser; }

// Comprobar si es admin
function isAdmin(user){
  if(!user) return false;
  if(typeof user === "string") return user === "Peketruli";
  if(typeof user === "object") return user.username === "Peketruli";
  return false;
}

// -------------------- ELIMINAR TODOS LOS REGISTROS --------------------
async function clearAllActivity() {
  try {
    const { error } = await supabase.from("actividad").delete().neq("id",0);
    if(error) {
      console.error("Error eliminando actividad:", error);
      alert("‚ùå Error al limpiar registros: "+error.message);
    } else {
      logEl.textContent = "üßπ Todos los registros eliminados.\n";
      console.log("‚úÖ Todos los registros eliminados");
    }
  } catch(e) { console.error("Exception eliminando actividad:", e); }
}

// -------------------- LOG DIRECTO A SUPABASE --------------------
async function logActividad(accion, detalle="") {
  if(!currentUser) return;
  try {
    const { error } = await supabase.from("actividad").insert([{
      user_id: currentUser.id || null,
      usuario: currentUser.username || currentUser || "Desconocido",
      accion: accion,
      detalle: detalle,
      fecha: new Date().toISOString()
    }]);
    if(error) console.error("Error registrando actividad:", error);
  } catch(e){ console.error("Exception logActividad:", e); }
}

// -------------------- INICIALIZACI√ìN DE LA CONSOLA --------------------
async function initConsole() {
  if(!isAdmin(currentUser)){
    document.body.innerHTML = "<h1 class='error'>Casi pero no, vuelve cuando seas admin üòé</h1>";
    return;
  }

  // Mostrar consola
  statusEl.style.display = "block";
  logEl.style.display = "block";

  statusEl.textContent = `üü¢ Bienvenido Peketruli ‚Äî acceso concedido`;
  logEl.textContent = "Cargando actividad...\n";

  // Limpiar los registros al cargar
  await clearAllActivity();

  // Historial (ya vac√≠o, pero por si hay nuevas inserciones)
  const { data, error } = await supabase.from("actividad").select("*").order("fecha",{ascending:true});
  if(error){ logEl.textContent += "‚ùå Error: "+error.message; return; }
  if(!data || data.length === 0){ logEl.textContent += "Sin registros anteriores.\n"; }

  // Tiempo real
  supabase.channel("actividad_changes")
    .on("postgres_changes", {event:"INSERT", schema:"public", table:"actividad"}, payload=>{
      const n = payload.new;
      const hora = new Date(n.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${n.usuario} ${n.accion}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    })
    .subscribe();
}

// -------------------- BOT√ìN LIMPIAR --------------------
clearBtn.addEventListener("click", async () => {
  if(confirm("‚ö†Ô∏è ¬øEst√°s seguro de eliminar todos los registros? Esta acci√≥n no se puede deshacer.")) {
    await clearAllActivity();
  }
});

initConsole();
</script>
</body>
</html>
