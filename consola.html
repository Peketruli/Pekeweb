<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background-color: #000;
    color: #0f0;
    font-family: "Courier New", monospace;
    padding: 20px;
    white-space: pre-wrap;
    overflow-y: scroll;
  }
  h1 {
    color: #0f0;
    text-shadow: 0 0 10px #0f0;
  }
  .error {
    color: red;
    text-align: center;
    font-size: 24px;
    margin-top: 100px;
  }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<div id="debugUser" style="color: yellow; font-weight: bold; margin-bottom: 20px;"></div>
<div id="output"></div>

<script>
// ===============================
// 🔧 CONFIGURACIÓN SUPABASE
// ===============================
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "TU_SUPABASE_PUBLIC_KEY"; // reemplaza con tu clave
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ===============================
// 🟡 CHEQUEO VISUAL DEL USUARIO
// ===============================
const debugUserDiv = document.getElementById("debugUser");
const currentUser = localStorage.getItem("currentUser");
debugUserDiv.innerText = "Usuario actual guardado en localStorage: " + (currentUser || "NINGUNO");

// ===============================
// 🚫 ACCESO RESTRINGIDO
// ===============================
if (currentUser !== "Peketruli") {
  document.body.innerHTML = "<h1 class='error'>Casi pero no, vuelve cuando seas admin 😎</h1>";
} else {
  iniciarConsola();
}

// ===============================
// 📡 INICIO DE CONSOLA
// ===============================
async function iniciarConsola() {
  log("🟢 Bienvenido, Peketruli. Consola conectada a Supabase...\n");

  // 1️⃣ Cargar historial
  const { data, error } = await supabase
    .from("actividad")
    .select("*")
    .order("fecha", { ascending: true });

  if (error) {
    log("❌ Error al cargar actividad: " + error.message);
  } else if (!data || data.length === 0) {
    log("Sin registros anteriores.\n───────────────\n");
  } else {
    data.forEach(row => {
      const hora = new Date(row.fecha).toLocaleTimeString();
      log(`[${hora}] ${row.usuario} ${row.accion}`);
    });
    log("───────────────\n");
  }

  // 2️⃣ Escuchar nuevos eventos en tiempo real
  supabase
    .channel("actividad_changes")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "actividad" }, payload => {
      const nuevo = payload.new;
      const hora = new Date(nuevo.fecha).toLocaleTimeString();
      log(`[${hora}] ${nuevo.usuario} ${nuevo.accion}`);
    })
    .subscribe();
}

// ===============================
// 🧠 FUNCIONES GLOBALES
// ===============================
window.registrarActividad = async function(accion) {
  const usuario = localStorage.getItem("currentUser") || "Desconocido";

  const { error } = await supabase.from("actividad").insert([
    {
      usuario,
      accion,
      fecha: new Date().toISOString()
    }
  ]);

  if (error) {
    console.error("Error al registrar actividad:", error.message);
  }
};

// ===============================
// 💬 LOG VISUAL
// ===============================
function log(msg) {
  const time = new Date().toLocaleTimeString();
  const output = document.getElementById("output");
  output.innerHTML += `[${time}] ${msg}\n`;
  output.scrollTop = output.scrollHeight;
}
</script>
</body>
</html>
