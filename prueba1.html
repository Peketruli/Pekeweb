<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampire Survival - Mini</title>
<style>
    body { margin: 0; overflow: hidden; background: #111; color: #fff; font-family: Arial, sans-serif; }
    canvas { display: block; background: #222; margin: 0 auto; }
    #ui { position: absolute; top: 10px; left: 10px; }
    #weaponSelect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 20px; border-radius: 10px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>
<div id="ui">
    Vida: <span id="life">100</span> | Nivel: <span id="level">1</span> | XP: <span id="xp">0</span>
</div>

<div id="weaponSelect">
    <h2>Elige tu arma</h2>
    <button onclick="startGame('sword')">Espada</button>
    <button onclick="startGame('magic')">Bola de Fuego</button>
    <button onclick="startGame('crossbow')">Ballesta</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 600;

let gameRunning = false;
let player, enemies = [], bullets = [];
let keys = {};
let weaponChoice = '';
let level = 1, xp = 0;

document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function startGame(weapon) {
    weaponChoice = weapon;
    document.getElementById('weaponSelect').style.display = 'none';
    gameRunning = true;
    player = { x: canvas.width/2, y: canvas.height/2, speed: 3, life: 100, weapon: weaponChoice };
    enemies = [];
    bullets = [];
    level = 1;
    xp = 0;
    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function spawnEnemies() {
    for (let i = 0; i < level + 2; i++) {
        enemies.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 20,
            speed: 1 + Math.random(),
            life: 10 + level * 2
        });
    }
}

function updatePlayer() {
    if (keys['w'] || keys['arrowup']) player.y -= player.speed;
    if (keys['s'] || keys['arrowdown']) player.y += player.speed;
    if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
    if (keys['d'] || keys['arrowright']) player.x += player.speed;

    // Mantener dentro del canvas
    player.x = Math.max(0, Math.min(canvas.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height, player.y));
}

function shoot() {
    // Disparo automático según arma
    if (player.weapon === 'sword') {
        // Ataque melee: crea un corto rango alrededor del jugador
        bullets.push({ x: player.x, y: player.y, vx: 0, vy: 0, type: 'melee', life: 10 });
    } else {
        // Ataque a distancia
        enemies.forEach(e => {
            const angle = Math.atan2(e.y - player.y, e.x - player.x);
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle) * 5, vy: Math.sin(angle) * 5, type: 'ranged' });
        });
    }
}

function updateBullets() {
    bullets.forEach((b, i) => {
        b.x += b.vx;
        b.y += b.vy;

        enemies.forEach((e, j) => {
            const dx = e.x - b.x;
            const dy = e.y - b.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if ((b.type === 'melee' && dist < 30) || (b.type === 'ranged' && dist < 10)) {
                e.life -= 5;
                if (e.life <= 0) {
                    enemies.splice(j, 1);
                    xp += 5;
                    document.getElementById('xp').innerText = xp;
                    if (xp >= level * 20) {
                        level++;
                        xp = 0;
                        document.getElementById('level').innerText = level;
                        spawnEnemies();
                    }
                }
            }
        });

        // eliminar bala si fuera del canvas
        if (b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) bullets.splice(i, 1);
    });
}

function updateEnemies() {
    enemies.forEach(e => {
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        e.x += dx/dist * e.speed;
        e.y += dy/dist * e.speed;

        if (dist < 20) {
            player.life -= 0.5;
            document.getElementById('life').innerText = Math.max(0, Math.floor(player.life));
        }
    });
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar jugador
    ctx.fillStyle = 'cyan';
    ctx.beginPath();
    ctx.arc(player.x, player.y, 15, 0, Math.PI*2);
    ctx.fill();

    // Dibujar enemigos
    enemies.forEach(e => {
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.size, 0, Math.PI*2);
        ctx.fill();
    });

    // Dibujar balas
    bullets.forEach(b => {
        ctx.fillStyle = b.type === 'melee' ? 'yellow' : 'orange';
        ctx.beginPath();
        ctx.arc(b.x, b.y, 5, 0, Math.PI*2);
        ctx.fill();
    });
}

function gameLoop() {
    if (!gameRunning) return;
    updatePlayer();
    shoot();
    updateBullets();
    updateEnemies();
    draw();

    if (player.life <= 0) {
        alert('Has muerto. Recarga la página para volver a jugar.');
        gameRunning = false;
        return;
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
