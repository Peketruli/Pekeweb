<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vampire Survival Optimizado</title>
<style>
body { margin:0; overflow:hidden; background:#111; color:white; font-family: Arial, sans-serif;}
canvas { display:block; background:#111; }
#mainMenu, #levelMenu {
    position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
    background:#222; padding:20px; border-radius:10px; display:flex; flex-direction:column; gap:10px;
}
button { padding:10px; border:none; border-radius:5px; cursor:pointer; background:#555; color:white; font-size:16px; }
button:hover { background:#777; }
#hud { position:absolute; top:10px; left:10px; }
#hud div { margin-bottom:5px; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="mainMenu">
    <h2>Selecciona tu arma inicial</h2>
    <button onclick="selectWeapon('pistol')">Pistola</button>
    <button onclick="selectWeapon('whip')">Látigo</button>
</div>

<div id="levelMenu" style="display:none;">
    <h2>¡Subiste de nivel! Escoge un bono:</h2>
    <div id="levelOptions"></div>
</div>

<div id="hud">
    <div>Vida: <span id="hpText"></span></div>
    <div>XP: <span id="xpText"></span></div>
    <div>Nivel: <span id="levelText"></span></div>
    <div>Armas: <span id="weaponsText"></span></div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

const mainMenu = document.getElementById('mainMenu');
const levelMenu = document.getElementById('levelMenu');
const levelOptions = document.getElementById('levelOptions');

const hud = {
    hpText: document.getElementById('hpText'),
    xpText: document.getElementById('xpText'),
    levelText: document.getElementById('levelText'),
    weaponsText: document.getElementById('weaponsText')
};

const player = {
    x: canvas.width/2, y: canvas.height/2, speed: 3, size:20,
    hp: 10, maxHp:10, xp:0, level:1
};

let weaponsState = {
    pistol: {unlocked:true, level:1, damage:1},
    whip: {unlocked:false, level:0, damage:2},
    sword: {unlocked:false, level:0, damage:3},
    staff: {unlocked:false, level:0, damage:2},
    potion: {unlocked:false, level:0, damage:1},
    solar: {unlocked:false, level:0, damage:2}
};

let currentWeapon = null;
let enemies = [];
let bullets = [];
let orbs = [];
let pendingSlashes = [];

let lastSpawnTime = 0;
let spawnInterval = 2500;
let lastFrame = performance.now();

function selectWeapon(name) {
    currentWeapon = name;
    weaponsState[name].unlocked = true;
    mainMenu.style.display = 'none';
    spawnInitialEnemies();
    requestAnimationFrame(gameLoop);
}

function spawnInitialEnemies() {
    for(let i=0;i<3;i++) spawnEnemy();
}

function spawnEnemy() {
    if(enemies.length>=15) return; // limitar enemigos
    enemies.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        size:20,
        hp:3 + Math.floor(Math.random()*3),
        speed:1+Math.random(),
        type:'normal'
    });
}

function spawnOrb(x,y){
    orbs.push({x,y,size:5,xp:1});
}

function updatePlayer(dt){
    if(keys['w']) player.y -= player.speed*(dt/16);
    if(keys['s']) player.y += player.speed*(dt/16);
    if(keys['a']) player.x -= player.speed*(dt/16);
    if(keys['d']) player.x += player.speed*(dt/16);
}

function updateEnemies(dt){
    enemies.forEach(e=>{
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist>1){
            e.x += (dx/dist)*e.speed*(dt/16);
            e.y += (dy/dist)*e.speed*(dt/16);
        }
        // daño al jugador
        if(dist<player.size+e.size){
            player.hp -= 0.05*dt/16;
        }
    });
    enemies = enemies.filter(e=>e.hp>0);
}

function updateBullets(dt){
    bullets.forEach(b=>{
        b.x += b.vx*(dt/16);
        b.y += b.vy*(dt/16);
        // colisiones con enemigos
        enemies.forEach(e=>{
            const dx = b.x - e.x;
            const dy = b.y - e.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < e.size){
                e.hp -= b.damage;
                b.hit = true;
            }
        });
    });
    bullets = bullets.filter(b=>!b.hit && b.x>0 && b.x<canvas.width && b.y>0 && b.y<canvas.height);
}

function updateOrbs(){
    orbs.forEach((o,i)=>{
        const dx = player.x - o.x;
        const dy = player.y - o.y;
        if(Math.sqrt(dx*dx+dy*dy)<player.size){
            player.xp += o.xp;
            orbs.splice(i,1);
            checkLevelUp();
        }
    });
}

function checkLevelUp(){
    const xpToNext = player.level*5;
    if(player.xp >= xpToNext){
        player.xp -= xpToNext;
        player.level++;
        openLevelMenu();
    }
}

function openLevelMenu(){
    levelMenu.style.display='flex';
    levelOptions.innerHTML='';
    const options = [
        {text:'+MaxHP', action:()=>{player.maxHp++; player.hp++;}},
        {text:'+Speed', action:()=>{player.speed +=0.5;}},
        {text:'+Weapon Level', action:()=>{weaponsState[currentWeapon].level++;}}
    ];
    options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.textContent = opt.text;
        btn.onclick = ()=>{opt.action(); levelMenu.style.display='none';};
        levelOptions.appendChild(btn);
    });
}

function fireWeapon(){
    if(currentWeapon==='pistol'){
        // dispara hacia enemigo más cercano
        if(enemies.length===0) return;
        let target = enemies.reduce((a,b)=>{
            const da = Math.hypot(a.x-player.x,a.y-player.y);
            const db = Math.hypot(b.x-player.x,b.y-player.y);
            return da<db?a:b;
        });
        const dx = target.x - player.x;
        const dy = target.y - player.y;
        const dist = Math.sqrt(dx*dx+dy*dy);
        bullets.push({x:player.x,y:player.y,vx:dx/dist*5,vy:dy/dist*5,damage:weaponsState.pistol.level});
    }
}

function updateHUD(){
    hud.hpText.textContent = `${Math.round(player.hp)}/${player.maxHp}`;
    hud.xpText.textContent = player.xp;
    hud.levelText.textContent = player.level;
    hud.weaponsText.textContent = Object.keys(weaponsState).filter(w=>weaponsState[w].unlocked).join(', ');
}

function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // player
    ctx.fillStyle='cyan';
    ctx.beginPath();
    ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
    ctx.fill();
    // enemies
    ctx.fillStyle='red';
    enemies.forEach(e=>{
        ctx.beginPath();
        ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
        ctx.fill();
    });
    // bullets
    ctx.fillStyle='yellow';
    bullets.forEach(b=>{
        ctx.beginPath();
        ctx.arc(b.x,b.y,5,0,Math.PI*2);
        ctx.fill();
    });
    // orbs
    ctx.fillStyle='green';
    orbs.forEach(o=>{
        ctx.beginPath();
        ctx.arc(o.x,o.y,o.size,0,Math.PI*2);
        ctx.fill();
    });
}

function gameLoop(now){
    const dt = now - lastFrame;
    lastFrame = now;
    updatePlayer(dt);
    updateEnemies(dt);
    updateBullets(dt);
    updateOrbs();
    fireWeapon();
    updateHUD();
    render();
    if(player.hp<=0) return alert('Has muerto!');
    if(now - lastSpawnTime > spawnInterval){spawnEnemy(); lastSpawnTime = now;}
    requestAnimationFrame(gameLoop);
}

</script>
</body>
</html>
