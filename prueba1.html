<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampire Survival Arcade</title>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; background:#111; color:white; overflow:hidden; }
  canvas { display:block; background:#111; }

  #hud {
      position:absolute; top:10px; left:10px;
      width:300px; font-size:16px;
      z-index:10;
  }
  .barContainer {
      background:#333; border:2px solid white; margin:5px 0; height:20px; width:100%;
      position:relative;
  }
  .barFill {
      background:lime; height:100%; width:100%;
      transition: width 0.2s;
  }
  #xpFill { background:gold; }
  #levelText, #scoreText { margin:5px 0; font-weight:bold; }

  #levelMenu {
      display:none;
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%, -50%);
      background:#222;
      padding:20px;
      border:2px solid white;
      text-align:center;
      z-index:100;
  }
  #levelMenu button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="hud">
  <div id="scoreText">Puntuación: 0</div>
  <div id="levelText">Nivel: 1</div>
  <div class="barContainer">
      <div id="hpFill" class="barFill"></div>
      <span style="position:absolute; width:100%; text-align:center; color:white; font-size:14px;" id="hpText">100/100</span>
  </div>
  <div class="barContainer">
      <div id="xpFill" class="barFill"></div>
      <span style="position:absolute; width:100%; text-align:center; color:white; font-size:14px;" id="xpText">0/15</span>
  </div>
</div>

<div id="levelMenu">
    <h2>¡Subiste de nivel!</h2>
    <div id="abilityButtons"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// -------------------- VARIABLES --------------------
let score = 0;
let playerXP = 0;
let playerLevel = 1;
let xpToNextLevel = 15;
let gamePaused = false;

// Player
const player = {
    x: canvas.width/2, y: canvas.height/2,
    size:30, speed:5, color:'cyan',
    bulletSpeed:10, shootInterval:2500, doubleShot:false, multiShot:false,
    melee:false, meleeInterval:2500, hp:100, maxHp:100, meleeDamage:10
};

// Input
const keys = {};
document.addEventListener('keydown', e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e=>keys[e.key.toLowerCase()]=false);

// Entities
const bullets=[], vampires=[], xpParticles=[], meleeAttacks=[];

// -------------------- ENEMIGOS --------------------
const vampireTypes=[
    {name:'Rojo', size:30, speed:2, hp:1},       // más fácil al principio
    {name:'Rápido', size:20, speed:3, hp:1},
    {name:'Resistente', size:35, speed:1.5, hp:5}
];

let spawnRate = 3000;
let spawnTimer = setInterval(spawnVampire, spawnRate);

function spawnVampire(){
    if(gamePaused) return;
    const type=vampireTypes[Math.floor(Math.random()*vampireTypes.length)];
    const edge=Math.floor(Math.random()*4);
    let x,y;
    if(edge===0){ x=0; y=Math.random()*canvas.height; }
    else if(edge===1){ x=canvas.width; y=Math.random()*canvas.height; }
    else if(edge===2){ x=Math.random()*canvas.width; y=0; }
    else{ x=Math.random()*canvas.width; y=canvas.height; }
    vampires.push({x,y,type: type.name, size:type.size, speed:type.speed, hp:type.hp});
}

// Incremento de dificultad progresivo
setInterval(()=>{
    if(spawnRate>800){
        spawnRate -= 200;
        clearInterval(spawnTimer);
        spawnTimer = setInterval(spawnVampire, spawnRate);
    }
}, 20000);

// -------------------- HABILIDADES / MEJORAS --------------------
const abilities=[
    {name:"Doble bala", apply:()=>player.doubleShot=true},
    {name:"Multidisparo", apply:()=>player.multiShot=true},
    {name:"Disparo rápido", apply:()=>{player.shootInterval=Math.max(500,player.shootInterval-500); resetShootTimer();}},
    {name:"Más velocidad", apply:()=>player.speed+=1},
    {name:"Más vida", apply:()=>{player.maxHp+=20; player.hp+=20; updateHUD();}},
    {name:"Espada", apply:()=>player.melee=true},
    {name:"Mejora espada", apply:()=>player.meleeDamage+=5},
    {name:"Más XP", apply:()=>playerXP+=3}
];

// -------------------- DISPARO AUTOMÁTICO --------------------
function shootAtClosestVampire(){
    if(gamePaused || vampires.length===0) return;
    let closest=vampires[0], minDist=Math.hypot(player.x-closest.x, player.y-closest.y);
    for(let i=1;i<vampires.length;i++){
        const dist=Math.hypot(player.x-vampires[i].x, player.y-vampires[i].y);
        if(dist<minDist){ minDist=dist; closest=vampires[i]; }
    }
    const angle=Math.atan2(closest.y-player.y, closest.x-player.x);
    bullets.push({x:player.x, y:player.y, dx:Math.cos(angle)*player.bulletSpeed, dy:Math.sin(angle)*player.bulletSpeed, size:5});
    if(player.doubleShot){
        setTimeout(()=>{ bullets.push({x:player.x, y:player.y, dx:Math.cos(angle)*player.bulletSpeed, dy:Math.sin(angle)*player.bulletSpeed, size:5}); }, 200);
    }
    if(player.multiShot){
        const spread=0.3;
        bullets.push({x:player.x, y:player.y, dx:Math.cos(angle+spread)*player.bulletSpeed, dy:Math.sin(angle+spread)*player.bulletSpeed, size:5});
        bullets.push({x:player.x, y:player.y, dx:Math.cos(angle-spread)*player.bulletSpeed, dy:Math.sin(angle-spread)*player.bulletSpeed, size:5});
    }
}
let shootTimer=setInterval(shootAtClosestVampire, player.shootInterval);
function resetShootTimer(){ clearInterval(shootTimer); shootTimer=setInterval(shootAtClosestVampire, player.shootInterval); }

// -------------------- ATAQUE MELEE --------------------
function startMelee(){
    if(player.melee && !gamePaused){
        meleeAttacks.push({x:player.x, y:player.y, size:50, damage:player.meleeDamage, lifetime:5});
    }
}
setInterval(startMelee, player.meleeInterval);

// -------------------- MENU DE NIVELES --------------------
function showLevelMenu(){
    gamePaused = true;
    const menu=document.getElementById('levelMenu');
    const buttonsDiv=document.getElementById('abilityButtons');
    buttonsDiv.innerHTML='';
    const options=[];
    while(options.length<3){
        const ability=abilities[Math.floor(Math.random()*abilities.length)];
        if(!options.includes(ability) && !(ability.name==="Espada" && player.melee)) options.push(ability);
    }
    options.forEach(a=>{
        const btn=document.createElement('button');
        btn.textContent=a.name;
        btn.onclick=()=>{
            a.apply();
            menu.style.display='none';
            gamePaused = false;
            updateHUD();
        };
        buttonsDiv.appendChild(btn);
    });
    menu.style.display='block';
}

// -------------------- HUD --------------------
function updateHUD(){
    document.getElementById('scoreText').textContent="Puntuación: "+score;
    document.getElementById('levelText').textContent="Nivel: "+playerLevel;
    const hpPercent = Math.max(0,player.hp/player.maxHp*100);
    document.getElementById('hpFill').style.width = hpPercent+"%";
    document.getElementById('hpText').textContent=player.hp+"/"+player.maxHp;
    const xpPercent = Math.min(100,playerXP/xpToNextLevel*100);
    document.getElementById('xpFill').style.width = xpPercent+"%";
    document.getElementById('xpText').textContent=playerXP+"/"+xpToNextLevel;
}

// -------------------- UPDATE --------------------
function update(){
    if(gamePaused) return;

    // Movimiento
    if(keys['w']) player.y-=player.speed;
    if(keys['s']) player.y+=player.speed;
    if(keys['a']) player.x-=player.speed;
    if(keys['d']) player.x+=player.speed;
    player.x=Math.max(player.size/2, Math.min(canvas.width-player.size/2, player.x));
    player.y=Math.max(player.size/2, Math.min(canvas.height-player.size/2, player.y));

    // Balas
    bullets.forEach((b,i)=>{ b.x+=b.dx; b.y+=b.dy; if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1); });

    // Melee
    meleeAttacks.forEach((m,i)=>{ m.lifetime--; if(m.lifetime<=0) meleeAttacks.splice(i,1); });

    // Enemigos
    vampires.forEach((v,vi)=>{
        const angle=Math.atan2(player.y-v.y, player.x-v.x);
        v.x+=Math.cos(angle)*v.speed;
        v.y+=Math.sin(angle)*v.speed;

        // Colisión con balas
        bullets.forEach((b,bi)=>{
            const dist=Math.hypot(b.x-v.x, b.y-v.y);
            if(dist<v.size/2+b.size/2){
                v.hp-=1;
                bullets.splice(bi,1);
                if(v.hp<=0){
                    const xpAmount=Math.floor(Math.random()*5)+1;
                    xpParticles.push({x:v.x, y:v.y, size:10, color:'lime', xp:xpAmount});
                    vampires.splice(vi,1);
                    score+=1;
                    updateHUD();
                }
            }
        });

        // Colisión con melee
        meleeAttacks.forEach(m=>{
            const dist=Math.hypot(m.x-v.x, m.y-v.y);
            if(dist<m.size/2+v.size/2){
                v.hp-=m.damage;
                if(v.hp<=0){
                    const xpAmount=Math.floor(Math.random()*5)+1;
                    xpParticles.push({x:v.x, y:v.y, size:10, color:'lime', xp:xpAmount});
                    vampires.splice(vi,1);
                    score+=1;
                    updateHUD();
                }
            }
        });

        // Colisión con player
        const distPlayer=Math.hypot(player.x-v.x, player.y-v.y);
        if(distPlayer<v.size/2+player.size/2){
            player.hp -= 20; 
            if(player.hp<=0){
                alert('¡Has sido atrapado! Puntuación final: '+score+', Nivel: '+playerLevel);
                window.location.reload();
            }
            updateHUD();
        }
    });

    // XP
    xpParticles.forEach((p,i)=>{
        const distPlayer=Math.hypot(player.x-p.x, player.y-p.y);
        if(distPlayer<player.size/2+p.size/2){
            playerXP+=p.xp;
            xpParticles.splice(i,1);
            if(playerXP>=xpToNextLevel){
                playerLevel+=1;
                playerXP=playerXP-xpToNextLevel;
                xpToNextLevel=Math.floor(xpToNextLevel*1.5);
                showLevelMenu();
            }
            updateHUD();
        }
    });
}

// -------------------- DRAW --------------------
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Player
    ctx.fillStyle=player.color;
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size/2,0,Math.PI*2);
    ctx.fill();

    // Balas
    bullets.forEach(b=>{ ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(b.x,b.y,b.size,0,Math.PI*2); ctx.fill(); });

    // Melee
    meleeAttacks.forEach(m=>{ ctx.fillStyle='orange'; ctx.beginPath(); ctx.arc(m.x,m.y,m.size/2,0,Math.PI*2); ctx.fill(); });

    // Vampires
    vampires.forEach(v=>{ ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(v.x,v.y,v.size/2,0,Math.PI*2); ctx.fill(); });

    // XP
    xpParticles.forEach(p=>{ ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size/2,0,Math.PI*2); ctx.fill(); });
}

// -------------------- LOOP --------------------
function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
updateHUD();
</script>

</body>
</html>
