<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampire Survival - Avanzado</title>
<style>
body { margin:0; overflow:hidden; background:#111; font-family:Arial,sans-serif; }
canvas { display:block; margin:0 auto; background:#222; }
#ui {
    position:absolute; top:10px; left:10px; color:#fff;
}
#lifeBar {
    width:200px; height:20px; background:#555; border-radius:5px; overflow:hidden;
}
#lifeFill {
    width:100%; height:100%; background:limegreen;
}
#weaponSelect {
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#333; padding:20px; border-radius:10px; text-align:center;
}
button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>

<div id="ui">
    Vida:
    <div id="lifeBar"><div id="lifeFill"></div></div>
    | Nivel: <span id="level">1</span> | XP: <span id="xp">0</span>
</div>

<div id="weaponSelect">
    <h2>Elige tu arma</h2>
    <button onclick="startGame('sword')">Espada</button>
    <button onclick="startGame('fireball')">Bola de Fuego</button>
    <button onclick="startGame('crossbow')">Ballesta</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800;
canvas.height = 600;

let gameRunning = false;
let player, enemies = [], bullets = [], powerups = [];
let keys = {};
let weaponChoice = '';
let level = 1, xp = 0;
let spawnTimer = 0;
let bossActive = false;

document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function startGame(weapon) {
    weaponChoice = weapon;
    document.getElementById('weaponSelect').style.display = 'none';
    gameRunning = true;
    player = { x: canvas.width/2, y: canvas.height/2, speed: 3, life: 100, weapon: weaponChoice, damage:5 };
    enemies = [];
    bullets = [];
    powerups = [];
    level = 1; xp = 0; bossActive = false;
    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function spawnEnemies() {
    let count = level + 2;
    enemies = [];
    for (let i = 0; i < count; i++) {
        enemies.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 20,
            speed: 1 + Math.random(),
            life: 10 + level * 3,
            maxLife: 10 + level * 3,
            boss: false
        });
    }
}

function spawnBoss() {
    bossActive = true;
    enemies.push({
        x: canvas.width/2,
        y: 50,
        size: 50,
        speed: 1,
        life: 200 + level*20,
        maxLife: 200 + level*20,
        boss:true
    });
}

function spawnPowerup() {
    powerups.push({
        x: Math.random()*canvas.width,
        y: Math.random()*canvas.height,
        type: ['life','speed','damage'][Math.floor(Math.random()*3)]
    });
}

function updatePlayer() {
    if (keys['w'] || keys['arrowup']) player.y -= player.speed;
    if (keys['s'] || keys['arrowdown']) player.y += player.speed;
    if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
    if (keys['d'] || keys['arrowright']) player.x += player.speed;

    player.x = Math.max(0, Math.min(canvas.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height, player.y));
}

function shoot() {
    spawnTimer++;
    if (spawnTimer % 15 !== 0) return; // velocidad de disparo

    enemies.forEach(e => {
        const dx = e.x - player.x;
        const dy = e.y - player.y;
        const angle = Math.atan2(dy, dx);

        if (player.weapon === 'sword') {
            bullets.push({ x: player.x, y: player.y, vx:0, vy:0, type:'melee', life:10, damage:player.damage });
        } else if (player.weapon === 'fireball') {
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*5, vy: Math.sin(angle)*5, type:'ranged', damage:player.damage });
        } else if (player.weapon === 'crossbow') {
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*8, vy: Math.sin(angle)*8, type:'ranged', damage:player.damage });
        }
    });
}

function updateBullets() {
    bullets.forEach((b,i)=>{
        b.x += b.vx;
        b.y += b.vy;

        enemies.forEach((e,j)=>{
            const dx = e.x - b.x;
            const dy = e.y - b.y;
            const dist = Math.sqrt(dx*dx+dy*dy);
            if ((b.type==='melee' && dist<30) || (b.type==='ranged' && dist<10)) {
                e.life -= b.damage;
                if (e.life <= 0) {
                    enemies.splice(j,1);
                    xp += e.boss?50:5;
                    document.getElementById('xp').innerText = xp;
                    if (!bossActive && xp >= level*20) {
                        level++;
                        xp=0;
                        document.getElementById('level').innerText = level;
                        if(level % 5 === 0) spawnBoss(); else spawnEnemies();
                    }
                }
            }
        });

        if (b.x<0 || b.x>canvas.width || b.y<0 || b.y>canvas.height) bullets.splice(i,1);
    });
}

function updateEnemies() {
    enemies.forEach(e=>{
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        e.x += dx/dist * e.speed;
        e.y += dy/dist * e.speed;

        if (dist<20) {
            player.life -= e.boss?1:0.5;
            document.getElementById('lifeFill').style.width = Math.max(0, player.life) + '%';
        }
    });
}

function updatePowerups() {
    powerups.forEach((p,i)=>{
        const dx = player.x - p.x;
        const dy = player.y - p.y;
        const dist = Math.sqrt(dx*dx+dy*dy);
        if(dist<20){
            if(p.type==='life') player.life=Math.min(100,player.life+20);
            if(p.type==='speed') player.speed+=1;
            if(p.type==='damage') player.damage+=2;
            powerups.splice(i,1);
        }
    });
    if(Math.random()<0.005) spawnPowerup();
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Fondo
    ctx.fillStyle = '#222';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#444';
    for (let i=0;i<canvas.width;i+=100){
        ctx.beginPath();
        ctx.moveTo(i,0);
        ctx.lineTo(i,canvas.height);
        ctx.stroke();
    }
    for (let i=0;i<canvas.height;i+=100){
        ctx.beginPath();
        ctx.moveTo(0,i);
        ctx.lineTo(canvas.width,i);
        ctx.stroke();
    }

    // Jugador
    ctx.fillStyle='cyan';
    ctx.beginPath();
    ctx.arc(player.x,player.y,15,0,Math.PI*2);
    ctx.fill();

    // Enemigos
    enemies.forEach(e=>{
        ctx.fillStyle=e.boss?'purple':'red';
        ctx.beginPath();
        ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
        ctx.fill();

        ctx.fillStyle='lime';
        ctx.fillRect(e.x - e.size, e.y - e.size - 8, e.size*2*(e.life/e.maxLife), 5);
        ctx.strokeStyle='#000';
        ctx.strokeRect(e.x - e.size, e.y - e.size - 8, e.size*2,5);
    });

    // Balas
    bullets.forEach(b=>{
        ctx.fillStyle = b.type==='melee'?'yellow':'orange';
        ctx.beginPath();
        ctx.arc(b.x,b.y,5,0,Math.PI*2);
        ctx.fill();
    });

    // Powerups
    powerups.forEach(p=>{
        if(p.type==='life') ctx.fillStyle='pink';
        if(p.type==='speed') ctx.fillStyle='blue';
        if(p.type==='damage') ctx.fillStyle='gold';
        ctx.beginPath();
        ctx.arc(p.x,p.y,10,0,Math.PI*2);
        ctx.fill();
    });
}

function gameLoop() {
    if (!gameRunning) return;
    updatePlayer();
    shoot();
    updateBullets();
    updateEnemies();
    updatePowerups();
    draw();

    if (player.life<=0){
        alert('Has muerto. Recarga la pÃ¡gina para volver a jugar.');
        gameRunning=false;
        return;
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
