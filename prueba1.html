<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vampire Survival - XP Balls</title>
<style>
body { margin:0; overflow:hidden; background:#111; font-family:Arial,sans-serif; }
#ui {
    position:absolute; top:10px; left:10px; color:#fff;
}
#lifeBar {
    width:200px; height:20px; background:#555; border-radius:5px; overflow:hidden;
}
#lifeFill {
    width:100%; height:100%; background:limegreen;
}
#weaponSelect {
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#333; padding:20px; border-radius:10px; text-align:center;
}
button { margin:5px; padding:10px 20px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>

<div id="ui">
    Vida:
    <div id="lifeBar"><div id="lifeFill"></div></div>
    | Nivel: <span id="level">1</span> | XP: <span id="xp">0</span>
</div>

<div id="weaponSelect">
    <h2>Elige tu arma</h2>
    <button onclick="startGame('sword')">Espada</button>
    <button onclick="startGame('fireball')">Bola de Fuego</button>
    <button onclick="startGame('crossbow')">Ballesta</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

let gameRunning = false;
let player, enemies = [], bullets = [], powerups = [], xpBalls = [];
let keys = {};
let weaponChoice = '';
let level = 1, xp = 0;
let spawnTimer = 0;

document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

function startGame(weapon) {
    weaponChoice = weapon;
    document.getElementById('weaponSelect').style.display = 'none';
    gameRunning = true;
    player = { x: canvas.width/2, y: canvas.height/2, speed: 3, life: 100, weapon: weaponChoice, damage:2 };
    enemies = [];
    bullets = [];
    powerups = [];
    xpBalls = [];
    level = 1; xp = 0;
    spawnEnemies();
    requestAnimationFrame(gameLoop);
}

function spawnEnemies() {
    let count = level + 2;
    enemies = [];
    for (let i = 0; i < count; i++) {
        enemies.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 20,
            speed: 1 + Math.random(),
            life: 10 + level * 3,
            maxLife: 10 + level * 3
        });
    }
}

function spawnXPBall(x,y) {
    xpBalls.push({
        x: x,
        y: y,
        vx: (Math.random()-0.5)*2,
        vy: (Math.random()-0.5)*2,
        value: 5
    });
}

function updatePlayer() {
    if (keys['w'] || keys['arrowup']) player.y -= player.speed;
    if (keys['s'] || keys['arrowdown']) player.y += player.speed;
    if (keys['a'] || keys['arrowleft']) player.x -= player.speed;
    if (keys['d'] || keys['arrowright']) player.x += player.speed;

    player.x = Math.max(0, Math.min(canvas.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height, player.y));
}

function shoot() {
    spawnTimer++;
    if (spawnTimer % 15 !== 0) return;

    enemies.forEach(e => {
        const dx = e.x - player.x;
        const dy = e.y - player.y;
        const angle = Math.atan2(dy, dx);

        if (player.weapon === 'sword') {
            bullets.push({ x: player.x, y: player.y, vx:0, vy:0, type:'melee', damage:player.damage });
        } else if (player.weapon === 'fireball') {
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*3, vy: Math.sin(angle)*3, type:'ranged', damage:player.damage });
        } else if (player.weapon === 'crossbow') {
            bullets.push({ x: player.x, y: player.y, vx: Math.cos(angle)*4, vy: Math.sin(angle)*4, type:'ranged', damage:player.damage });
        }
    });
}

function updateBullets() {
    bullets.forEach((b,i)=>{
        b.x += b.vx;
        b.y += b.vy;

        enemies.forEach((e,j)=>{
            const dx = e.x - b.x;
            const dy = e.y - b.y;
            const dist = Math.sqrt(dx*dx+dy*dy);
            if ((b.type==='melee' && dist<30) || (b.type==='ranged' && dist<10)) {
                e.life -= b.damage;
                if (e.life <= 0) {
                    spawnXPBall(e.x, e.y);
                    enemies.splice(j,1);
                }
            }
        });

        if (b.x<0 || b.x>canvas.width || b.y<0 || b.y>canvas.height) bullets.splice(i,1);
    });
}

function updateEnemies() {
    enemies.forEach(e=>{
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        e.x += dx/dist * e.speed;
        e.y += dy/dist * e.speed;

        if (dist<20) {
            player.life -= 0.5;
            document.getElementById('lifeFill').style.width = Math.max(0, player.life) + '%';
        }
    });
}

function updateXPBalls() {
    xpBalls.forEach((xpB,i)=>{
        xpB.x += xpB.vx;
        xpB.y += xpB.vy;

        const dx = player.x - xpB.x;
        const dy = player.y - xpB.y;
        const dist = Math.sqrt(dx*dx+dy*dy);

        if(dist<20){
            xp += xpB.value;
            document.getElementById('xp').innerText = xp;
            xpBalls.splice(i,1);

            if(xp >= level*20){
                level++;
                xp = 0;
                document.getElementById('level').innerText = level;
                spawnEnemies();
            }
        }

        if (xpB.x<0 || xpB.x>canvas.width || xpB.y<0 || xpB.y>canvas.height) xpBalls.splice(i,1);
    });
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Fondo
    ctx.fillStyle = '#111';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Jugador
    ctx.fillStyle='cyan';
    ctx.beginPath();
    ctx.arc(player.x,player.y,15,0,Math.PI*2);
    ctx.fill();

    // Enemigos
    enemies.forEach(e=>{
        ctx.fillStyle='red';
        ctx.beginPath();
        ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
        ctx.fill();

        ctx.fillStyle='lime';
        ctx.fillRect(e.x - e.size, e.y - e.size - 8, e.size*2*(e.life/e.maxLife), 5);
        ctx.strokeStyle='#000';
        ctx.strokeRect(e.x - e.size, e.y - e.size - 8, e.size*2,5);
    });

    // Balas
    bullets.forEach(b=>{
        ctx.fillStyle = b.type==='melee'?'yellow':'orange';
        ctx.beginPath();
        ctx.arc(b.x,b.y,5,0,Math.PI*2);
        ctx.fill();
    });

    // XP Balls
    xpBalls.forEach(xpB=>{
        ctx.fillStyle='gold';
        ctx.beginPath();
        ctx.arc(xpB.x,xpB.y,8,0,Math.PI*2);
        ctx.fill();
    });
}

function gameLoop() {
    if (!gameRunning) return;
    updatePlayer();
    shoot();
    updateBullets();
    updateEnemies();
    updateXPBalls();
    draw();

    if (player.life<=0){
        alert('Has muerto. Recarga la pÃ¡gina para volver a jugar.');
        gameRunning=false;
        return;
    }

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
