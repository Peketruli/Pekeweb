<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vampire Survival — Imán + Boss rebalanceado</title>
<style>
  :root{--hud-bg:rgba(0,0,0,0.55);--accent:#f1c40f;--muted:#999}
  html,body{height:100%;margin:0;background:#080808;color:#eee;font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
  canvas{display:block;background:linear-gradient(#111,#040404);width:100vw;height:100vh}
  /* TOP HUD (center) */
  #topHUD{position:fixed;top:10px;left:50%;transform:translateX(-50%);width:760px;max-width:85vw;z-index:30}
  .row{display:flex;gap:10px;align-items:center}
  .box{background:var(--hud-bg);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
  #bars{flex:1}
  .bar{height:18px;background:#222;border-radius:8px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.05)}
  .fill{height:100%;transition:width .18s linear}
  .hpFill{background:linear-gradient(90deg,#2ecc71,#27ae60)}
  .xpFill{background:linear-gradient(90deg,#f39c12,#e67e22)}
  /* Left HUD (weapons column) */
  #leftHUD{position:fixed;left:10px;top:50%;transform:translateY(-50%);z-index:35;display:flex;flex-direction:column;gap:8px}
  .weaponSlot{width:160px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);font-size:13px;display:flex;align-items:center;gap:8px}
  .weaponIcon{width:36px;height:36px;border-radius:6px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
  .weaponInfo{flex:1}
  .weaponName{font-size:13px}
  .weaponLvl{font-size:12px;color:var(--muted)}
  /* Timer top-right */
  #timer{position:fixed;top:12px;right:12px;background:var(--hud-bg);padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);z-index:40;font-size:14px}
  /* Level menu & death panel */
  #levelMenu,#deathPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#111;padding:18px;border:2px solid #fff;border-radius:10px;z-index:50;display:none;min-width:320px}
  #levelMenu h2,#deathPanel h2{margin:0 0 8px}
  #levelMenu .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  button.choice{padding:10px;border-radius:8px;border:none;background:#222;color:#fff;cursor:pointer}
  button.choice:hover{background:#333}
  #deathPanel button{margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:#c0392b;color:white;cursor:pointer}
  /* chest popup */
  #chestPopup{position:fixed;left:50%;top:20%;transform:translateX(-50%);z-index:60;background:linear-gradient(90deg,#222,#111);padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);display:none}
  /* debug */
  #debug{position:fixed;right:10px;bottom:10px;color:#999;font-size:12px;z-index:40}
  @keyframes chestGlow {0%{box-shadow:0 0 0 rgba(255,215,0,0)}50%{box-shadow:0 0 20px rgba(255,215,0,0.7)}100%{box-shadow:0 0 0 rgba(255,215,0,0)}}
  .chestAnim{animation: chestGlow 1s ease-in-out;}
  #mainMenu, #charSelect, #infoPanel {
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  background:#111; padding:20px; border:2px solid #fff; border-radius:10px;
  z-index:60; min-width:280px; text-align:center;
}
#mainMenu h2, #charSelect h2, #infoPanel h2 { margin-bottom:15px; }
#mainMenu .menuButtons { display:flex; flex-direction:column; gap:10px; }
#mainMenu button, #charSelect button, #infoPanel button {
  padding:10px 14px; border:none; border-radius:8px; background:#222; color:#fff; cursor:pointer;
}
#mainMenu button:hover, #charSelect button:hover, #infoPanel button:hover { background:#333; }
</style>
</head>
<body>

<canvas id="c"></canvas>

<!-- Left HUD: weapon column -->
<div id="leftHUD" aria-hidden="true"></div>

<!-- Top HUD center -->
<div id="topHUD">
  <div class="row">
    <div class="box" style="min-width:220px">
      <div style="font-size:14px"><strong id="scoreText">Puntos: 0</strong></div>
      <div style="font-size:13px">Nivel <span id="levelText">1</span></div>
    </div>
    <div id="bars" class="box" style="display:flex;flex-direction:column;gap:6px">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:80px">Vida</div>
        <div class="bar" style="flex:1"><div id="hpFill" class="fill hpFill" style="width:100%"></div></div>
        <div style="width:70px;text-align:right" id="hpText">100/100</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:80px">XP</div>
        <div class="bar" style="flex:1"><div id="xpFill" class="fill xpFill" style="width:0%"></div></div>
        <div style="width:70px;text-align:right" id="xpText">0/15</div>
      </div>
    </div>
    <div id="inv" class="box" style="display:none"></div>
  </div>
</div>

<!-- Timer -->
<div id="timer">00:00</div>

<!-- Level up menu -->
<div id="levelMenu">
  <h2>¡Subiste de nivel!</h2>
  <div style="font-size:13px;color:#ccc">Elige una opción (sube arma/habilidad si ya la tienes)</div>
  <div class="choices" id="levelChoices"></div>
</div>

<!-- Death panel -->
<div id="deathPanel">
  <h2>Has muerto</h2>
  <div id="deathScore"></div>
  <button id="btnRestart">Reiniciar</button>
</div>
  
<!-- Main Menu -->
<div id="mainMenu">
  <h2>Vampire Survival</h2>
  <div class="menuButtons">
    <button id="btnPlay">Jugar</button>
    <button id="btnInfo">Información</button>
    <button id="btnQuit">Volver</button>
  </div>
</div>

<!-- Character Selection Menu -->
<div id="charSelect" style="display:none">
  <h2>Selecciona tu personaje</h2>
  <div class="choices" id="charChoices"></div>
  <button id="btnCharBack">Volver</button>
</div>

<!-- Info Panel -->
<div id="infoPanel" style="display:none">
  <h2>Información de armas</h2>
  <div id="infoContent" style="font-size:13px; max-height:300px; overflow-y:auto"></div>
  <button id="btnInfoBack">Volver</button>
</div>

<!-- Chest popup -->
<div id="chestPopup"></div>

<div id="debug"></div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
addEventListener('resize', resize);
resize();

/* ---------- Estado global ---------- */
let time = 0;
let score = 0;
let xp = 0;
let level = 1;
let xpToNext = 15;
let gamePaused = false;
let dead = false;

/* ---------- Player ---------- */
const player = {
  x: canvas.width/2,
  y: canvas.height/2,
  size: 18,
  speed: 2.2,
  hp: 100,
  maxHp: 100
};

/* ---------- Input ---------- */
const keys = {};
addEventListener('keydown', e=> keys[e.key.toLowerCase()] = true);
addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);

/* ---------- Entities ---------- */
let bullets = [];
let enemies = [];
let meleeAttacks = [];
let orbs = [];
let chests = [];
let boss = null;
let lastSpawnTime = performance.now();
let lastBossSpawn = performance.now();

/* ---------- Weapons Library (Actualizada) ---------- */
const weaponsLib = {};

/* LÁTIGO */
weaponsLib.whip = {
  id:'whip', name:'Látigo',
  maxLevel:10,
  statsForLevel(level){
    const damage = 4 + level*1;
    const cooldown = Math.max(220, 500 - level*30);
    return { damage, cooldown };
  },
  attack(state){
    if(!state.level || dead) return;
    const now = performance.now();
    if(now - (state.lastUse||0) < weaponsLib.whip.statsForLevel(state.level).cooldown) return;
    state.lastUse = now;
    // golpea horizontal
    const s = weaponsLib.whip.statsForLevel(state.level);
    enemies.forEach(e => {
      if(Math.abs(e.y - player.y) < 14) e.hp -= s.damage;
    });
    if(boss && Math.abs(boss.y - player.y) < 14) boss.hp -= s.damage;
  }
};

/* CUCHILLO */
weaponsLib.knife = {
  id:'knife', name:'Cuchillo',
  maxLevel:10,
  statsForLevel(level){
    return { bullets: 1 + Math.floor(level/2), damage: 2 + level };
  },
  shoot(state){
    if(!state.level || dead) return;
    const now = performance.now();
    if(now - (state.lastShot||0) < 250) return;
    state.lastShot = now;
    const s = weaponsLib.knife.statsForLevel(state.level);
    for(let i=0;i<s.bullets;i++){
      bullets.push({ x:player.x, y:player.y, dx:Math.cos(0)*5, dy:Math.sin(0)*5, damage:s.damage, size:3, life:1500, friendly:true });
    }
  }
};

/* HACHA */
weaponsLib.axe = {
  id:'axe', name:'Hacha',
  maxLevel:10,
  statsForLevel(level){
    return { damage: 6+level*2, arc: Math.PI/3 + level*0.05 };
  },
  attack(state){
    if(!state.level || dead) return;
    const s = weaponsLib.axe.statsForLevel(state.level);
    meleeAttacks.push({ x:player.x, y:player.y, arc:s.arc, range:35, damage:s.damage, angle:0, life:120 });
  }
};

/* CRUZ */
weaponsLib.cross = {
  id:'cross', name:'Cruz',
  maxLevel:10,
  statsForLevel(level){ return { damage: 8+level*2, chanceCrit:0.05+level*0.02 }; },
  attack(state){
    if(!state.level || dead) return;
    const s = weaponsLib.cross.statsForLevel(state.level);
    bullets.push({ x:player.x, y:player.y, dx:0, dy:-4, damage:s.damage, critChance:s.chanceCrit, size:4, life:2500, friendly:true });
  }
};

/* AGUA BENDITA */
weaponsLib.holyWater = {
  id:'holyWater', name:'Agua Bendita',
  maxLevel:10,
  statsForLevel(level){ return { damage: 4+level, radius:12+level*2, duration:1800+level*100 }; },
  throw(state){
    if(!state.level || dead) return;
    bullets.push({ x:player.x, y:player.y, dx:0, dy:0, radius:weaponsLib.holyWater.statsForLevel(state.level).radius, damage:weaponsLib.holyWater.statsForLevel(state.level).damage, life:weaponsLib.holyWater.statsForLevel(state.level).duration, friendly:true });
  }
};

/* BIBLIA */
weaponsLib.bible = {
  id:'bible', name:'Biblia del Rey',
  maxLevel:10,
  statsForLevel(level){ return { orbCount:1+Math.floor(level/2), radius:55+level*6, damage:1+level*0.5, duration:4000+level*300, cooldown:8000-level*250, speed:0.005+level*0.0004 }; },
  activate(state){
    const s = weaponsLib.bible.statsForLevel(state.level);
    state.active = true;
    state.spawnTime = performance.now();
    state.orbs = [];
    for(let i=0;i<s.orbCount;i++){
      state.orbs.push({ angle:(i/s.orbCount)*Math.PI*2 });
    }
  },
  update(state, dt){
    if(!state.level) return;
    const now = performance.now();
    const s = weaponsLib.bible.statsForLevel(state.level);
    if(!state.active && (!state.lastUse || now - state.lastUse > s.cooldown)){
      state.lastUse = now;
      this.activate(state);
    }
    if(state.active){
      const elapsed = now - state.spawnTime;
      ctx.save();
      ctx.fillStyle="rgba(255,255,100,0.85)";
      ctx.shadowColor="rgba(255,255,150,0.9)";
      ctx.shadowBlur=10;
      state.orbs.forEach(orb=>{
        orb.angle += s.speed*dt;
        const x=player.x+Math.cos(orb.angle)*s.radius;
        const y=player.y+Math.sin(orb.angle)*s.radius;
        ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fill();
        enemies.forEach(e=>{ if(Math.hypot(x-e.x,y-e.y)<e.size+10) e.hp -= s.damage*(dt/16); });
        if(boss && Math.hypot(x-boss.x,y-boss.y)<boss.size+10) boss.hp -= s.damage*(dt/16);
      });
      ctx.restore();
      if(elapsed>s.duration){ state.active=false; state.orbs=[]; }
    }
  }
};

/* VARA MAGICA */
weaponsLib.magicWand = {
  id:'magicWand', name:'Vara Mágica',
  maxLevel:10,
  statsForLevel(level){ return { damage:3+level, speed:4+level*0.2, interval:Math.max(150,500-level*20) }; },
  shoot(state){
    if(!state.level || dead) return;
    const now = performance.now();
    const s = weaponsLib.magicWand.statsForLevel(state.level);
    if(now - (state.lastShot||0) < s.interval) return;
    state.lastShot = now;
    if(!enemies.length) return;
    const pool = boss ? enemies.concat([boss]) : enemies;
    let target = pool[0]; for(const e of pool) if(dist(e,player)<dist(target,player)) target=e;
    const ang = Math.atan2(target.y-player.y, target.x-player.x);
    bullets.push({ x:player.x, y:player.y, dx:Math.cos(ang)*s.speed, dy:Math.sin(ang)*s.speed, damage:s.damage, size:3, life:3000, friendly:true });
  }
};

/* FIRE WAND */
weaponsLib.fireWand = {
  id:'fireWand', name:'Pájaro de Fuego',
  maxLevel:10,
  statsForLevel(level){ return { damage:4+level, speed:3.5+level*0.2, interval:1500 }; },
  shoot(state){
    if(!state.level || dead) return;
    const now = performance.now();
    if(now - (state.lastShot||0) < weaponsLib.fireWand.statsForLevel(state.level).interval) return;
    state.lastShot = now;
    bullets.push({ x:player.x, y:player.y, dx:Math.random()*6-3, dy:-4, damage:weaponsLib.fireWand.statsForLevel(state.level).damage, size:4, life:2000, friendly:true });
  }
};

/* RAYO */
weaponsLib.lightning = {
  id:'lightning', name:'Rayo',
  maxLevel:10,
  statsForLevel(level){ return { damage:5+level, duration:400+level*20, cooldown:3000-level*150 }; },
  activate(state){
    const s=weaponsLib.lightning.statsForLevel(state.level);
    state.active=true; state.spawnTime=performance.now();
  },
  update(state,dt){
    if(!state.level) return;
    const s = weaponsLib.lightning.statsForLevel(state.level);
    const now = performance.now();
    if(!state.active && (!state.lastUse || now - state.lastUse > s.cooldown)){ state.lastUse=now; this.activate(state); }
    if(state.active){
      enemies.forEach(e=>{ if(Math.abs(e.x-player.x)<20) e.hp -= s.damage*(dt/16); });
      if(boss && Math.abs(boss.x-player.x)<20) boss.hp -= s.damage*(dt/16);
      if(now - state.spawnTime > s.duration) state.active=false;
    }
  }
};

/* ---------- Weapons State ---------- */
const weaponsState = {
  whip:{ level:1 },
  knife:{ level:1 },
  axe:{ level:0 },
  cross:{ level:0 },
  holyWater:{ level:0 },
  bible:{ level:0 },
  magicWand:{ level:0 },
  fireWand:{ level:0 },
  lightning:{ level:0 }
};

/* ---------- Game Loop ---------- */
function update(dt){
  if(gamePaused || dead) return;
  
  // movimiento player
  if(keys['w']) player.y -= player.speed;
  if(keys['s']) player.y += player.speed;
  if(keys['a']) player.x -= player.speed;
  if(keys['d']) player.x += player.speed;

  // actualizar armas
  Object.keys(weaponsState).forEach(k=>{
    const w = weaponsLib[k]; const s = weaponsState[k];
    if(w.update) w.update(s, dt);
    if(keys[' ']){ if(w.shoot) w.shoot(s); if(w.attack) w.attack(s); if(w.throw) w.throw(s); }
  });

  // actualizar bullets
  bullets.forEach(b=>{
    b.x+=b.dx; b.y+=b.dy; b.life-=dt;
  });
  bullets = bullets.filter(b=>b.life>0);

  // actualizar enemigos
  enemies.forEach(e=>{
    const dx=player.x-e.x, dy=player.y-e.y;
    const distSq=dx*dx+dy*dy;
    if(distSq<=(player.size+e.size)*(player.size+e.size)) player.hp-=0.2*dt;
    e.x+=dx*0.01*dt; e.y+=dy*0.01*dt;
  });
  enemies = enemies.filter(e=>e.hp>0);

  time+=dt;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // player
  ctx.fillStyle="white"; ctx.beginPath();
  ctx.arc(player.x,player.y,player.size,0,Math.PI*2); ctx.fill();
  // bullets
  bullets.forEach(b=>{ ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(b.x,b.y,b.size,0,Math.PI*2); ctx.fill(); });
  // enemies
  enemies.forEach(e=>{ ctx.fillStyle="green"; ctx.beginPath(); ctx.arc(e.x,e.y,e.size,0,Math.PI*2); ctx.fill(); });
}

let lastTime = performance.now();
function loop(now){
  const dt = now - lastTime; lastTime=now;
  update(dt); draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------- Helper ---------- */
function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }
</script>
</body>
</html>
