<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vampire Survival - Mejorado</title>
<style>
  html,body{height:100%;margin:0;background:#0a0a0a;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  canvas{display:block;background:radial-gradient(circle at center,#1f1f1f 0%, #000 100%);}
  #hud{position:fixed;left:12px;top:12px;z-index:20}
  #hud div{margin:4px 0;font-size:15px;background:rgba(0,0,0,0.35);padding:6px 10px;border-radius:6px}
  #healthBar{width:220px;height:18px;background:#222;border-radius:6px;overflow:hidden}
  #healthFill{height:100%;width:100%;background:limegreen;transition:width .15s linear,background .2s}
  #upgradeOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:30}
  #upgradeBox{background:#111;border:2px solid #fff;padding:18px;border-radius:10px;width:340px;text-align:center}
  #upgradeBox h2{margin:0 0 10px}
  #upgradeBox button{display:block;width:80%;margin:8px auto;padding:10px;border-radius:8px;border:1px solid #fff;background:#222;color:#fff;cursor:pointer}
  #menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:40}
  #menuBox{background:#0f0f0f;padding:24px;border-radius:12px;border:2px solid #fff;text-align:center}
  #menuBox button{margin:8px;padding:10px 18px;border-radius:8px;border:none;background:#2b2b2b;color:#fff;cursor:pointer}
</style>
</head>
<body>
  <div id="menu">
    <div id="menuBox">
      <h1>游빁 Vampire Survival</h1>
      <div style="margin:10px 0">Personaje: Disparo (autom치tico)</div>
      <button id="btnPlay">Jugar</button>
      <button id="btnDict">Diccionario</button>
      <button id="btnBack">Volver a Golf</button>
    </div>
  </div>

  <canvas id="c"></canvas>

  <div id="hud">
    <div id="healthBar"><div id="healthFill"></div></div>
    <div id="xpText">XP: 0 / 15</div>
    <div id="lvlText">Nivel: 1</div>
    <div id="scoreText">Puntos: 0</div>
  </div>

  <div id="upgradeOverlay">
    <div id="upgradeBox">
      <h2>춰Subiste de nivel!</h2>
      <div id="upgradeChoices"></div>
    </div>
  </div>

<script>
/* ==========================
   Juego: Vampire Survival
   ========================== */

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener('resize', resize);
resize();

/* HUD elems */
const healthFill = document.getElementById('healthFill');
const xpText = document.getElementById('xpText');
const lvlText = document.getElementById('lvlText');
const scoreText = document.getElementById('scoreText');
const upgradeOverlay = document.getElementById('upgradeOverlay');
const upgradeChoices = document.getElementById('upgradeChoices');
const menu = document.getElementById('menu');
const btnPlay = document.getElementById('btnPlay');
const btnDict = document.getElementById('btnDict');
const btnBack = document.getElementById('btnBack');

btnPlay.onclick = ()=>{ menu.style.display='none'; startGame(); };
btnDict.onclick = ()=> alert('Diccionario: armas, enemigos y habilidades pr칩ximamente.');
btnBack.onclick = ()=> location.href = 'golf.html';

/* Juego - estado */
let keys = {};
addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

let player = {
  x: canvas.width/2, y: canvas.height/2,
  size: 20,
  speed: 3,
  hp: 5, maxHp:5,
  damage: 1,
  shootInterval: 2500,
  lastShot: 0
};

let bullets = [];
let enemies = [];
let orbs = [];
let score = 0;
let xp = 0;
let level = 1;
let xpToNext = 15;
let gamePaused = false;

/* Upgrades (niveles) */
let upgrades = {
  'Bala doble': 0,         // a침ade proyectiles extra (cada nivel +1 proyectil)
  'Multidisparo': 0,      // a침ade niveles de multishot (cada nivel => +2 proyectiles en abanico)
  'Disparo r치pido': 0,     // reduce shootInterval
  'M치s velocidad': 0,      // aumenta speed
  'M치s vida': 0,           // aumenta maxHp
  'Espadazo': 0,           // desbloquea melee (nivel 0 = no)
  'Espada fuerte': 0,      // aumenta da침o melee
  'Espada amplia': 0,      // aumenta rango melee
  'Regeneraci칩n': 0        // activa regeneraci칩n y mejora con niveles
};

/* Dificultad */
let spawnInterval = 2500;
let spawnTimer = null;
let difficultyTimer = 0;
let difficultyInterval = 45000; // cada tantos ms sube dificultad
let enemyBaseSpeed = 1.0;
let enemyHpBoost = 0;

/* Config inicial: enemigos d칠biles al inicio (1 hp) */
function spawnEnemy(){
  if(gamePaused) return;
  const edge = Math.floor(Math.random()*4);
  let x = (edge===0) ? 0 : (edge===1 ? canvas.width : Math.random()*canvas.width);
  let y = (edge===2) ? 0 : (edge===3 ? canvas.height : Math.random()*canvas.height);
  // Tipo simple por ahora: hp inicial 1 (f치cil)
  const r = Math.random();
  if(r < 0.7){
    enemies.push({ x, y, size: 16, speed: enemyBaseSpeed + Math.random()*0.4, hp: 1 + enemyHpBoost, xpDrop: 1 + Math.floor(Math.random()*3), color:'#c0392b' });
  } else if (r < 0.92){
    enemies.push({ x, y, size: 18, speed: enemyBaseSpeed + 0.8 + Math.random()*0.6, hp: 1 + enemyHpBoost, xpDrop: 2, color:'#e67e22' });
  } else {
    enemies.push({ x, y, size: 26, speed: Math.max(0.6, enemyBaseSpeed - 0.3), hp: 3 + enemyHpBoost, xpDrop: 3 + Math.floor(Math.random()*4), color:'#8e44ad' });
  }
}

/* Helper distancia */
function dist(a,b){
  const dx = a.x - b.x, dy = a.y - b.y; return Math.hypot(dx,dy);
}

/* Disparo: ahora combina base + Bala doble + Multidisparo
   L칩gica:
   - baseShotCount = 1
   - doubleExtra = upgrades['Bala doble'] (cada nivel suma 1 proyectil)
   - multiLevel = upgrades['Multidisparo'] (cada nivel produce +2 proyectiles en abanico)
   - totalShots = base + doubleExtra + (multiLevel>0 ? multiLevel*2 : 0)
   - Dispersi칩n: center angle towards target, spread depends on totalShots
*/
function shootAtNearest(){
  if(gamePaused || enemies.length===0) return;
  const now = performance.now();
  if(now - player.lastShot < player.shootInterval) return;
  player.lastShot = now;

  // elegir objetivo m치s cercano
  let target = enemies[0];
  for(let e of enemies) if(dist(e, player) < dist(target, player)) target = e;
  const centerAng = Math.atan2(target.y - player.y, target.x - player.x);

  const base = 1;
  const doubleExtra = upgrades['Bala doble'] || 0;
  const multiLevel = upgrades['Multidisparo'] || 0;
  const multiExtra = multiLevel * 2; // cada nivel a침ade 2 proyectiles (uno por lado)
  const total = base + doubleExtra + multiExtra;

  // spread angle (radians)
  const spread = Math.min(Math.PI/3, 0.28 + 0.05 * total); // controlado
  const step = (total>1) ? spread / (total - 1) : 0;
  const start = centerAng - spread/2;

  for(let i=0;i<total;i++){
    const ang = start + step * i;
    bullets.push({
      x: player.x,
      y: player.y,
      dx: Math.cos(ang) * (4 + (upgrades['Multidisparo']*0.6)),
      dy: Math.sin(ang) * (4 + (upgrades['Multidisparo']*0.6)),
      size: 5,
      damage: player.damage
    });
  }
}

/* Melee autom치tico (si desbloqueado): golpea en rango cada X ms.
   Mejora por niveles:
   - Espadazo lvl 1 desbloquea; m치s niveles reducir치n cooldown.
   - Espada fuerte aumenta da침o melee.
   - Espada amplia aumenta rango.
*/
let melee = { last:0, baseInterval:2500, baseRange:40, baseDamage:2 };
function tryMelee(){
  if(upgrades['Espadazo'] === 0) return;
  const now = performance.now();
  const lvl = upgrades['Espadazo'];
  const interval = Math.max(600, melee.baseInterval - (lvl-1)*300); // reduce con niveles
  if(now - melee.last < interval) return;
  melee.last = now;

  // calcular rango y da침o seg칰n mejoras
  const range = melee.baseRange + (upgrades['Espada amplia'] || 0) * 12;
  const dmg = melee.baseDamage + (upgrades['Espada fuerte'] || 0) * 1;

  // dibujito breve
  ctx.save();
  ctx.strokeStyle = 'rgba(255,230,140,0.6)';
  ctx.beginPath();
  ctx.arc(player.x, player.y, range, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();

  // aplicar da침o
  for(let i = enemies.length-1; i>=0; i--){
    const e = enemies[i];
    if(dist(e, player) <= range + e.size){
      e.hp -= dmg;
      if(e.hp <= 0){
        spawnOrb(e);
        enemies.splice(i,1);
        score++;
      }
    }
  }
}

/* Orbs / XP fijo */
function spawnOrb(e){
  orbs.push({ x: e.x, y: e.y, size:10, value: e.xpDrop });
}

/* Update de balas */
function updateBullets(){
  for(let i = bullets.length-1; i>=0; i--){
    const b = bullets[i];
    b.x += b.dx; b.y += b.dy;
    // out of screen
    if(b.x< -20 || b.x>canvas.width+20 || b.y<-20 || b.y>canvas.height+20){ bullets.splice(i,1); continue; }
    // hit enemy
    for(let j = enemies.length-1; j>=0; j--){
      const e = enemies[j];
      if(dist(b,e) < e.size + 6){
        e.hp -= b.damage;
        bullets.splice(i,1);
        if(e.hp <= 0){
          spawnOrb(e);
          enemies.splice(j,1);
          score++;
        }
        break;
      }
    }
  }
}

/* Update enemies */
function updateEnemies(dt){
  for(let i = enemies.length-1; i>=0; i--){
    const e = enemies[i];
    const ang = Math.atan2(player.y - e.y, player.x - e.x);
    e.x += Math.cos(ang) * e.speed * (1 + (difficultyTimer/600000)); // leve scaling
    e.y += Math.sin(ang) * e.speed * (1 + (difficultyTimer/600000));
    // collision with player
    if(dist(e, player) < e.size + player.size){
      // da침o al tocar
      player.hp -= 0.2;
      // enemigo muere al tocar para evitar stacking
      spawnOrb(e);
      enemies.splice(i,1);
      if(player.hp <= 0){ alert('Has muerto\nPuntuaci칩n: '+score); location.reload(); }
    }
  }
}

/* Update orbs (recoger) */
function updateOrbs(){
  for(let i = orbs.length-1; i>=0; i--){
    const o = orbs[i];
    if(dist(o, player) < player.size + 12){
      xp += o.value;
      orbs.splice(i,1);
      if(xp >= xpToNext) levelUp();
    }
  }
}

/* Level up */
function levelUp(){
  level++;
  xp -= xpToNext;
  xpToNext = Math.floor(xpToNext * 1.25);
  gamePaused = true;
  showUpgradeUI();
}

/* Mostrar men칰 de upgrades - 3 opciones aleatorias.
   Si skill ya tiene nivel, mostrar치 "Nombre (Lv N)" y al elegir har치 LEVEL UP.
*/
const allUpgrades = [
  { id:'Bala doble', label:'Bala doble' },
  { id:'Multidisparo', label:'Multidisparo' },
  { id:'Disparo r치pido', label:'Disparo r치pido' },
  { id:'M치s velocidad', label:'M치s velocidad' },
  { id:'M치s vida', label:'M치s vida' },
  { id:'Espadazo', label:'Espadazo' },
  { id:'Espada fuerte', label:'Espada fuerte' },
  { id:'Espada amplia', label:'Espada amplia' },
  { id:'Regeneraci칩n', label:'Regeneraci칩n' }
];

function showUpgradeUI(){
  upgradeChoices.innerHTML = '';
  upgradeOverlay.style.display = 'flex';
  const opts = [];
  while(opts.length < 3){
    const pick = allUpgrades[Math.floor(Math.random()*allUpgrades.length)];
    // allow duplicates in picks? ensure unique in this choice set
    if(!opts.find(o=>o.id===pick.id)) opts.push(pick);
  }
  opts.forEach(opt=>{
    const btn = document.createElement('button');
    const levelNow = upgrades[opt.id] || 0;
    btn.textContent = `${opt.label}${levelNow>0 ? ' (Lv '+levelNow+')' : ''}`;
    btn.onclick = ()=>{
      // aplicar upgrade: incrementar contador y aplicar efecto
      upgrades[opt.id] = (upgrades[opt.id]||0) + 1;
      applyUpgradeEffect(opt.id);
      upgradeOverlay.style.display = 'none';
      gamePaused = false;
    };
    upgradeChoices.appendChild(btn);
  });
}

/* Aplicar efectos seg칰n id (acumulativos) */
function applyUpgradeEffect(id){
  const lv = upgrades[id];
  switch(id){
    case 'Bala doble':
      // cada nivel incrementa player.damage? No, mejor: a침ade proyectiles extra (handled in shoot)
      // no extra code needed here besides feedback
      break;
    case 'Multidisparo':
      // effect handled in shootAtNearest: number of extra shots increases
      break;
    case 'Disparo r치pido':
      // reduce interval progressively
      player.shootInterval = Math.max(300, player.shootInterval - 300);
      break;
    case 'M치s velocidad':
      player.speed += 0.4;
      break;
    case 'M치s vida':
      player.maxHp += 1;
      player.hp = player.maxHp;
      break;
    case 'Espadazo':
      // unlock - melee handled in tryMelee
      break;
    case 'Espada fuerte':
      // increases melee damage indirectly via upgrades value
      break;
    case 'Espada amplia':
      // increases melee range indirectly via upgrades value
      break;
    case 'Regeneraci칩n':
      // regen unlocked (handled in update)
      break;
  }
}

/* Dificultad incremental (m치s lenta que antes) */
function increaseDifficulty(){
  // spawnInterval reduce slowly but not below min
  spawnInterval = Math.max(1100, spawnInterval - 80);
  // reset timer
  clearInterval(spawnTimer);
  spawnTimer = setInterval(spawnEnemy, spawnInterval);
  enemyBaseSpeed += 0.08;
  enemyHpBoost += 0.2;
}

/* HUD draw */
function drawHUD(){
  const pct = Math.max(0, Math.min(1, player.hp / player.maxHp));
  healthFill.style.width = (pct*100) + '%';
  healthFill.style.background = pct < 0.3 ? '#e74c3c' : pct < 0.6 ? '#f1c40f' : '#2ecc71';
  xpText.textContent = `XP: ${Math.floor(xp)} / ${xpToNext}`;
  lvlText.textContent = `Nivel: ${level}`;
  scoreText.textContent = `Puntos: ${score}`;
}

/* Main loop */
let lastTime = performance.now();
function loop(now){
  const dt = now - lastTime;
  lastTime = now;
  if(!gamePaused){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // player movement
    if(keys['w']) player.y -= player.speed;
    if(keys['s']) player.y += player.speed;
    if(keys['a']) player.x -= player.speed;
    if(keys['d']) player.x += player.speed;
    player.x = Math.max(0, Math.min(canvas.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height, player.y));

    // auto shoot (based on shootInterval, with triple compatibility)
    shootAtNearest();

    // melee automatic (if unlocked)
    tryMelee();

    // update bullets
    updateBullets();

    // update enemies
    updateEnemies(dt);

    // update orbs
    updateOrbs();

    // draw player
    ctx.fillStyle = '#16a085';
    ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI*2); ctx.fill();

    // draw bullets
    for(let b of bullets){
      ctx.fillStyle = '#f9e79f';
      ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); ctx.fill();
    }

    // draw enemies
    for(let e of enemies){
      ctx.fillStyle = e.color;
      ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
      // hp text
      ctx.fillStyle = '#fff';
      ctx.font = '12px Arial';
      ctx.fillText('HP:'+Math.max(0,Math.round(e.hp)), e.x - e.size, e.y - e.size - 6);
    }

    // draw orbs
    for(let o of orbs){
      ctx.fillStyle = 'lime';
      ctx.beginPath(); ctx.arc(o.x, o.y, 6, 0, Math.PI*2); ctx.fill();
    }

    // regeneration
    if(upgrades['Regeneraci칩n'] && player.hp < player.maxHp){
      // regen rate scales with level
      const regenAmount = 0.03 * upgrades['Regeneraci칩n']; // por frame acumulable
      player.hp = Math.min(player.maxHp, player.hp + regenAmount * (dt/16));
    }

    // difficulty timer increment
    difficultyTimer += dt;
    if(difficultyTimer > difficultyInterval){
      difficultyTimer = 0;
      increaseDifficulty();
    }
  }

  drawHUD();
  requestAnimationFrame(loop);
}

/* Start the game */
function startGame(){
  // reset basic timers
  lastTime = performance.now();
  // initial easy state: enemies 1hp already set in spawnEnemy
  spawnInterval = 2500;
  clearInterval(spawnTimer);
  spawnTimer = setInterval(spawnEnemy, spawnInterval);
  // start loop
  requestAnimationFrame(loop);
}

/* Show upgrade overlay helper */
const upgradeOverlayElem = document.getElementById('upgradeOverlay');

/* init key listening already set above */

/* Prevent sword being useless: if already have Espadazo, choosing it increases level (handled) */

/* small helpers: spawn first enemies lightly */
for(let i=0;i<2;i++) spawnEnemy();

</script>
</body>
</html>
