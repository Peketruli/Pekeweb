<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vampire Survival — Imán + Boss rebalanceado</title>
<style>
  :root{--hud-bg:rgba(0,0,0,0.55);--accent:#f1c40f;--muted:#999}
  html,body{height:100%;margin:0;background:#080808;color:#eee;font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
  canvas{display:block;background:linear-gradient(#111,#040404);width:100vw;height:100vh}
  /* TOP HUD (center) */
  #topHUD{position:fixed;top:10px;left:50%;transform:translateX(-50%);width:760px;max-width:85vw;z-index:30}
  .row{display:flex;gap:10px;align-items:center}
  .box{background:var(--hud-bg);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
  #bars{flex:1}
  .bar{height:18px;background:#222;border-radius:8px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.05)}
  .fill{height:100%;transition:width .18s linear}
  .hpFill{background:linear-gradient(90deg,#2ecc71,#27ae60)}
  .xpFill{background:linear-gradient(90deg,#f39c12,#e67e22)}
  /* Left HUD (weapons column) */
  #leftHUD{position:fixed;left:10px;top:50%;transform:translateY(-50%);z-index:35;display:flex;flex-direction:column;gap:8px}
  .weaponSlot{width:160px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);font-size:13px;display:flex;align-items:center;gap:8px}
  .weaponIcon{width:36px;height:36px;border-radius:6px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
  .weaponInfo{flex:1}
  .weaponName{font-size:13px}
  .weaponLvl{font-size:12px;color:var(--muted)}
  /* Timer top-right */
  #timer{position:fixed;top:12px;right:12px;background:var(--hud-bg);padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);z-index:40;font-size:14px}
  /* Level menu & death panel */
  #levelMenu,#deathPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#111;padding:18px;border:2px solid #fff;border-radius:10px;z-index:50;display:none;min-width:320px}
  #levelMenu h2,#deathPanel h2{margin:0 0 8px}
  #levelMenu .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  button.choice{padding:10px;border-radius:8px;border:none;background:#222;color:#fff;cursor:pointer}
  button.choice:hover{background:#333}
  #deathPanel button{margin-top:10px;padding:8px 12px;border-radius:8px;border:none;background:#c0392b;color:white;cursor:pointer}
  /* chest popup */
  #chestPopup{position:fixed;left:50%;top:20%;transform:translateX(-50%);z-index:60;background:linear-gradient(90deg,#222,#111);padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);display:none}
  /* debug */
  #debug{position:fixed;right:10px;bottom:10px;color:#999;font-size:12px;z-index:40}
  @keyframes chestGlow {0%{box-shadow:0 0 0 rgba(255,215,0,0)}50%{box-shadow:0 0 20px rgba(255,215,0,0.7)}100%{box-shadow:0 0 0 rgba(255,215,0,0)}}
  .chestAnim{animation: chestGlow 1s ease-in-out;}
  #mainMenu, #charSelect, #infoPanel {
  position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
  background:#111; padding:20px; border:2px solid #fff; border-radius:10px;
  z-index:60; min-width:280px; text-align:center;
}
#mainMenu h2, #charSelect h2, #infoPanel h2 { margin-bottom:15px; }
#mainMenu .menuButtons { display:flex; flex-direction:column; gap:10px; }
#mainMenu button, #charSelect button, #infoPanel button {
  padding:10px 14px; border:none; border-radius:8px; background:#222; color:#fff; cursor:pointer;
}
#mainMenu button:hover, #charSelect button:hover, #infoPanel button:hover { background:#333; }
</style>
</head>
<body>

<canvas id="c"></canvas>

<!-- Left HUD: weapon column -->
<div id="leftHUD" aria-hidden="true"></div>

<!-- Top HUD center -->
<div id="topHUD">
  <div class="row">
    <div class="box" style="min-width:220px">
      <div style="font-size:14px"><strong id="scoreText">Puntos: 0</strong></div>
      <div style="font-size:13px">Nivel <span id="levelText">1</span></div>
    </div>
    <div id="bars" class="box" style="display:flex;flex-direction:column;gap:6px">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:80px">Vida</div>
        <div class="bar" style="flex:1"><div id="hpFill" class="fill hpFill" style="width:100%"></div></div>
        <div style="width:70px;text-align:right" id="hpText">100/100</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:80px">XP</div>
        <div class="bar" style="flex:1"><div id="xpFill" class="fill xpFill" style="width:0%"></div></div>
        <div style="width:70px;text-align:right" id="xpText">0/15</div>
      </div>
    </div>
    <div id="inv" class="box" style="display:none"></div>
  </div>
</div>

<!-- Timer -->
<div id="timer">00:00</div>

<!-- Level up menu -->
<div id="levelMenu">
  <h2>¡Subiste de nivel!</h2>
  <div style="font-size:13px;color:#ccc">Elige una opción (sube arma/habilidad si ya la tienes)</div>
  <div class="choices" id="levelChoices"></div>
</div>

<!-- Death panel -->
<div id="deathPanel">
  <h2>Has muerto</h2>
  <div id="deathScore"></div>
  <button id="btnRestart">Reiniciar</button>
</div>
  
<!-- Main Menu -->
<div id="mainMenu">
  <h2>Vampire Survival</h2>
  <div class="menuButtons">
    <button id="btnPlay">Jugar</button>
    <button id="btnInfo">Información</button>
    <button id="btnQuit">Volver</button>
  </div>
</div>

<!-- Character Selection Menu -->
<div id="charSelect" style="display:none">
  <h2>Selecciona tu personaje</h2>
  <div class="choices" id="charChoices"></div>
  <button id="btnCharBack">Volver</button>
</div>

<!-- Info Panel -->
<div id="infoPanel" style="display:none">
  <h2>Información de armas</h2>
  <div id="infoContent" style="font-size:13px; max-height:300px; overflow-y:auto"></div>
  <button id="btnInfoBack">Volver</button>
</div>

<!-- Chest popup -->
<div id="chestPopup"></div>

<div id="debug"></div>

<script>
/* ---------- Canvas ---------- */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
addEventListener('resize', resize);
resize();

/* ---------- Estado global ---------- */
let gameState = "menu"; // "menu", "playing", "gameOver"
let time = 0;
let score = 0;
let xp = 0;
let level = 1;
let xpToNext = 15;
let dead = false;
let gamePaused = false;

/* ---------- Player ---------- */
const player = {
  x: canvas.width/2,
  y: canvas.height/2,
  size: 15,
  speed: 200,
  hp: 100,
  maxHp: 100
};

/* ---------- Armas ---------- */
const weaponsState = {
  pistol: {level:1, cooldown:0.5, lastUse:0, active:true},
  solar: {level:0, cooldown:2, lastUse:0, active:false, orbs:[], areas:[]},
  bible: {level:0, cooldown:1.5, lastUse:0, active:false}
};

let bullets = [];
let enemies = [];
let boss = null;

/* ---------- Controles ---------- */
let keys = {};
let mouse = {x:0, y:0};
addEventListener('keydown', e=>keys[e.key]=true);
addEventListener('keyup', e=>keys[e.key]=false);
canvas.addEventListener('mousemove', e=>{
  mouse.x = e.clientX;
  mouse.y = e.clientY;
});

/* ---------- Funciones ---------- */
function startGame(){
  gameState = "playing";
  dead = false;
  score = 0;
  time = 0;
  player.x = canvas.width/2;
  player.y = canvas.height/2;
  player.hp = player.maxHp;

  bullets = [];
  enemies = [];
  boss = null;

  Object.keys(weaponsState).forEach(k=>{
    weaponsState[k].lastUse = 0;
    weaponsState[k].active = (k==="pistol");
    if(weaponsState[k].orbs) weaponsState[k].orbs = [];
    if(weaponsState[k].areas) weaponsState[k].areas = [];
  });

  for(let i=0;i<3;i++) spawnEnemy();
}

function spawnEnemy(){
  const e = {
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    size: 20,
    hp: 10 + level*2,
    speed: 50 + level*5
  };
  enemies.push(e);
}

function shootWeapon(weapon){
  const now = performance.now()/1000;
  if(now - weapon.lastUse < weapon.cooldown) return;
  weapon.lastUse = now;

  if(weapon === weaponsState.pistol){
    bullets.push({x:player.x, y:player.y, dx:(mouse.x-player.x)/50, dy:(mouse.y-player.y)/50, size:5});
  } else if(weapon === weaponsState.bible){
    // Dispara hacia el enemigo más cercano
    if(enemies.length===0) return;
    let nearest = enemies[0];
    let dist = Math.hypot(nearest.x-player.x, nearest.y-player.y);
    for(let e of enemies){
      const d = Math.hypot(e.x-player.x, e.y-player.y);
      if(d<dist){ dist=d; nearest=e; }
    }
    const dx = (nearest.x-player.x)/50;
    const dy = (nearest.y-player.y)/50;
    bullets.push({x:player.x, y:player.y, dx, dy, size:8});
  }
  // Solar y otras armas se pueden agregar aquí
}

function update(dt){
  if(gamePaused || dead || gameState!=="playing") return;

  // Mover player
  if(keys['w']||keys['ArrowUp']) player.y -= player.speed*dt;
  if(keys['s']||keys['ArrowDown']) player.y += player.speed*dt;
  if(keys['a']||keys['ArrowLeft']) player.x -= player.speed*dt;
  if(keys['d']||keys['ArrowRight']) player.x += player.speed*dt;

  // Mantener dentro del canvas
  player.x = Math.max(player.size, Math.min(canvas.width-player.size, player.x));
  player.y = Math.max(player.size, Math.min(canvas.height-player.size, player.y));

  // Disparos automáticos para armas activas
  Object.values(weaponsState).forEach(w=>{
    if(w.active) shootWeapon(w);
  });

  // Actualizar bullets
  bullets.forEach((b,i)=>{
    b.x += b.dx*dt*100;
    b.y += b.dy*dt*100;
    // colisión con enemigos
    enemies.forEach((e,j)=>{
      if(Math.hypot(e.x-b.x,e.y-b.y)<e.size+b.size){
        e.hp -= 10;
        bullets.splice(i,1);
        if(e.hp<=0) enemies.splice(j,1);
      }
    });
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1);
  });

  // Mover enemigos hacia player
  enemies.forEach(e=>{
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const dist = Math.hypot(dx,dy);
    e.x += (dx/dist)*e.speed*dt;
    e.y += (dy/dist)*e.speed*dt;

    // Colisión con player
    if(dist < e.size + player.size){
      player.hp -= 20*dt;
      if(player.hp <=0){
        dead = true;
        gameState = "gameOver";
      }
    }
  });

  time += dt;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameState==="menu"){
    ctx.fillStyle="white";
    ctx.font="48px Arial";
    ctx.fillText("Vampire Survival", canvas.width/2-200, canvas.height/2-50);
    ctx.font="32px Arial";
    ctx.fillText("Pulsa Jugar", canvas.width/2-80, canvas.height/2+20);
    return;
  }

  if(gameState==="gameOver"){
    ctx.fillStyle="red";
    ctx.font="48px Arial";
    ctx.fillText("Has Muerto", canvas.width/2-150, canvas.height/2);
    ctx.font="24px Arial";
    ctx.fillText("Pulsa Jugar para reiniciar", canvas.width/2-130, canvas.height/2+50);
    return;
  }

  // Dibujar player
  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
  ctx.fill();

  // Dibujar bullets
  bullets.forEach(b=>{
    ctx.fillStyle="red";
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
    ctx.fill();
  });

  // Dibujar enemigos
  enemies.forEach(e=>{
    ctx.fillStyle="green";
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
    ctx.fill();
  });

  // HUD
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.fillText("HP: "+Math.round(player.hp), 20, 30);
  ctx.fillText("Score: "+score, 20, 60);
}

/* ---------- Loop ---------- */
let last = performance.now();
function loop(){
  const now = performance.now();
  const dt = (now - last)/1000;
  last = now;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
loop();

/* ---------- Botón de juego ---------- */
const startButton = document.createElement('button');
startButton.id = "startButton";
startButton.textContent = "Jugar";
startButton.style.position = "absolute";
startButton.style.left = "50%";
startButton.style.top = "60%";
startButton.style.transform = "translate(-50%,-50%)";
startButton.style.padding = "10px 20px";
startButton.style.fontSize = "24px";
document.body.appendChild(startButton);

startButton.addEventListener('click', ()=>{
  startGame();
});
</script>
</body>
</html>
