<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RebeldÃ­a IN.AR â€” Navidad (Noche nevada)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Mountains+of+Christmas&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<style>
:root{
Â  --text: #f9f9ff;
Â  --accent-red: #ff3b3b;
Â  --accent-green: #1fc94c;
}

*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow-x:hidden;font-family:"Inter",Arial,sans-serif;color:var(--text);}
body{
Â  position:relative;
Â  padding:50px 20px 140px;
Â  background:linear-gradient(180deg,#0b1c33 0%,#123a58 50%,#05131d 100%);
Â  background-attachment:fixed;
}

/* ---------- NIEVE ---------- */
@keyframes snow {
Â  0% {transform: translateY(0);}
Â  100% {transform: translateY(100vh);}
}
.snowflake {
Â  position: fixed;
Â  top: -10px;
Â  color: white;
Â  font-size: 1em;
Â  animation: snow linear infinite;
Â  z-index: 2;
Â  opacity: 0.8;
}
@keyframes twinkle {
Â  0%,100%{opacity:0.8;}
Â  50%{opacity:0.2;}
}

/* ---------- LUCES ---------- */
.lights {
Â  position: fixed;
Â  top: 0;
Â  left: 0;
Â  width: 100%;
Â  height: 60px;
Â  display: flex;
Â  justify-content: space-around;
Â  z-index: 3;
Â  pointer-events: none;
}
.light {
Â  width: 14px;
Â  height: 22px;
Â  border-radius: 50%;
Â  background: var(--accent-red);
Â  box-shadow: 0 0 16px var(--accent-red);
Â  animation: twinkle 2s infinite;
}
.light:nth-child(odd){background:var(--accent-green);box-shadow:0 0 16px var(--accent-green);animation-delay:1s;}

/* ---------- MONTAÃ‘A DE NIEVE ---------- */
.scene-bg{
Â  position:fixed;bottom:0;left:0;width:100%;height:50%;z-index:1;pointer-events:none;
}
.scene-bg svg{width:100%;height:100%;display:block;}

/* ---------- BOTONES ---------- */
.btn{
Â  font-weight:600;
Â  padding:12px 22px;
Â  border-radius:12px;
Â  border:none;
Â  cursor:pointer;
Â  transition:all .25s ease;
Â  box-shadow:0 6px 18px rgba(0,0,0,0.45);
Â  display:inline-flex;
Â  align-items:center;
Â  gap:10px;
Â  color:white;
Â  background:linear-gradient(180deg,#e63946,#d62828);
Â  z-index:5;
}
.btn[disabled]{opacity:0.6;cursor:default;}
.btn:hover{
Â  transform:scale(1.1) translateY(-3px);
Â  box-shadow:0 0 50px 18px rgba(255,80,80,0.8),0 18px 60px rgba(0,0,0,0.7);
}

/* ---------- NAV INFERIOR ---------- */
.nav-container{
Â  position:fixed;bottom:20px;left:0;width:100%;
Â  background-color:rgba(0,0,0,0.7);
Â  padding:15px 0;
Â  display:flex;justify-content:space-around;
Â  z-index:6;
}
.nav-button{
Â  padding:10px 16px;margin:0 6px;border-radius:10px;border:none;
Â  background:linear-gradient(180deg,#e63946,#d62828);
Â  color:white;font-weight:600;cursor:pointer;
Â  transition:all .25s ease;
Â  box-shadow:0 4px 18px rgba(0,0,0,0.45);
}
.nav-button:hover{
Â  transform:translateY(-6px) scale(1.08);
Â  box-shadow:0 0 48px 16px rgba(255,80,80,0.9),0 20px 60px rgba(0,0,0,0.7);
}

/* ---------- CONTENIDO ---------- */
.container{text-align:center;max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:26px;align-items:center;position:relative;z-index:5;}
.card{
Â  width:100%;
Â  background:rgba(255,255,255,0.05);
Â  border-radius:14px;
Â  padding:18px;
Â  box-shadow:0 6px 30px rgba(0,0,0,0.6);
Â  backdrop-filter:blur(6px);
Â  border:1px solid rgba(255,255,255,0.05);
Â  color:#f1f1f1;
}
.header h1{
Â  text-align:center;
Â  font-family:"Mountains of Christmas",cursive;
Â  font-size:48px;
Â  color:var(--accent-red);
Â  text-shadow:0 4px 26px rgba(0,0,0,0.6),0 0 18px rgba(255,255,255,0.4);
}
.lead{font-size:16px;line-height:1.5;color:#eae8e8;}

/* ESTILOS PARA EL TEMPORIZADOR */
#countdownDisplay {
Â  font-size: 2.2em;
Â  font-weight: 700;
Â  color: var(--accent-green);
Â  text-shadow: 0 0 10px rgba(31, 201, 76, 0.8);
Â  margin: 10px 0;
}
#specialMessage {
Â  font-size: 1.1em;
Â  font-style: italic;
Â  margin-top: 5px;
Â  color: #ffffff;
}
.timer-input-group {
Â  display: flex;
Â  gap: 10px;
Â  margin-top: 10px;
Â  justify-content: center;
Â  align-items: center;
}
.timer-input-group input, .timer-input-group button {
Â  padding: 8px;
Â  border-radius: 6px;
}
/* FIN ESTILOS TEMPORIZADOR */

/* ---------- PERFIL ---------- */
.auth-container,.user-info{position:fixed;top:16px;right:16px;display:flex;align-items:center;gap:10px;z-index:10;}
.auth-button{padding:10px 18px;font-size:1em;color:white;background-color:#333;border:none;cursor:pointer;border-radius:6px;transition:all .2s;}
.auth-button:hover{transform:scale(1.08);box-shadow:0 0 30px rgba(255,255,255,0.4);}
.user-info{display:none;cursor:pointer;}
#userLogo{width:40px;height:40px;border-radius:50%;}
#userName{font-weight:600;font-size:1em;color:white;}

/* ---------- DROPDOWN ---------- */
.dropdown-menu{display:none;position:absolute;top:56px;right:0;background-color:#000;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.4);width:160px;text-align:left;z-index:10;}
.dropdown-menu td{padding:10px;cursor:pointer;color:white;}
.dropdown-menu td:hover{background-color:#333;}

/* ---------- PANEL ADMIN ---------- */
#adminPanel{display:none;text-align:left;}
#adminPanel table{width:100%;border-collapse:collapse;margin-top:8px;color:white;}
#adminPanel th,#adminPanel td{border:1px solid rgba(255,255,255,0.2);padding:6px 10px;font-size:14px;}
#adminPanel th{background:rgba(255,255,255,0.08);}

/* ---------- RESPONSIVE ---------- */
@media(max-width:720px){
Â  .header h1{font-size:36px;}
Â  .nav-button{font-size:14px;padding:8px 12px;}
}
</style>
</head>
<body>

<div class="lights">
Â  <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
Â  <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
</div>

<script>
for(let i=0;i<40;i++){
Â  const snow=document.createElement("div");
Â  snow.className="snowflake";
Â  snow.textContent="â„ï¸";
Â  snow.style.left=Math.random()*100+"%";
Â  snow.style.fontSize=(Math.random()*10+10)+"px";
Â  snow.style.animationDuration=(Math.random()*6+6)+"s";
Â  snow.style.animationDelay=(Math.random()*6)+"s";
Â  document.body.appendChild(snow);
}
</script>

<div class="scene-bg">
Â  <svg viewBox="0 0 1440 400" preserveAspectRatio="none">
Â  Â  <polygon points="0,400 0,260 200,300 400,220 600,280 800,240 1000,290 1200,260 1440,300 1440,400" fill="#fff"/>
Â  </svg>
</div>

<div class="container">
Â  <div class="header card">
Â  Â  <h1>ğŸ„ RebeldÃ­a IN.AR ğŸ</h1>
Â  Â  <p class="lead" style="margin-top:6px;">Un lugar para el alumnado â€” Â¡ahora con espÃ­ritu de Navidad! ğŸ…âœ¨</p>
Â  Â  
Â  Â  Â  Â  <div id="timerMessageContainer" style="margin-top: 15px;">
Â  Â  Â  <div id="countdownDisplay">Cargando temporizador...</div>
Â  Â  Â  <p id="specialMessage" class="lead"></p>
Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div id="peketruliTimerControl" style="display:none; margin-top: 15px;">
Â  Â  Â  Â  <h3 style="color:var(--accent-red); margin-bottom: 10px;">ğŸ› ï¸ Control del Temporizador (Peketruli)</h3>
Â  Â  Â  Â  <label for="countdownInput" style="display:block; margin-bottom: 5px;">Fecha/Hora Final (YYYY-MM-DD HH:MM):</label>
Â  Â  Â  Â  <input type="text" id="countdownInput" placeholder="Ej: 2025-12-25 00:00" style="width: 100%; max-width: 300px; padding: 8px; border-radius: 6px; margin-bottom: 10px; color: #333;">
Â  Â  Â  Â  
Â  Â  Â  Â  <label for="messageInput" style="display:block; margin-bottom: 5px;">Mensaje:</label>
Â  Â  Â  Â  <input type="text" id="messageInput" placeholder="Ej: Â¡Lanzamiento en! ğŸ‰" style="width: 100%; max-width: 300px; padding: 8px; border-radius: 6px; margin-bottom: 10px; color: #333;">
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="timer-input-group">
Â  Â  Â  Â  Â  <button class="btn" id="setCountdownBtn" style="padding: 8px 15px; font-size: 0.9em; transform: none; box-shadow: none;">Establecer</button>
Â  Â  Â  Â  Â  <button class="btn" id="clearCountdownBtn" style="background: linear-gradient(180deg, #555, #333); padding: 8px 15px; font-size: 0.9em; transform: none; box-shadow: none;">Borrar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  Â  </div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green);margin-bottom:8px;">Bienvenidos</h2>
Â  Â  <p class="lead">AquÃ­ podÃ©is escribir, organizar grupos, votar y divertiros. Este espacio es para la comunidad del instituto.</p>
Â  Â  <div class="actions" style="margin-top:12px;">
Â  Â  Â  <button class="btn" onclick="location.href='c.html'">ğŸ° Casino</button>
Â  Â  Â  <button class="btn" onclick="location.href='golf.html'">ğŸ® Zona Arcade</button>
Â  Â  Â  <button class="btn" onclick="location.href='po.html'">ğŸ“œ PolÃ­tica</button>
Â  Â  Â  <button class="btn" onclick="location.href='periodico.html'">ğŸ“° Noticias</button>
Â  Â  Â  <button class="btn" onclick="location.href='posts.html'">ğŸ“ Posts de la Pekeweb</button>
Â  Â  Â  <button class="auth-button" onclick="location.href='admin.html'">Admin</button>
Â  Â  </div>
Â  </div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green)">Enviar PeticiÃ³n</h2>
Â  Â  <textarea id="peticionInput" placeholder="Escribe tu peticiÃ³n aquÃ­..." rows="3" style="width:100%;border-radius:6px;padding:8px;margin-bottom:8px;"></textarea>
Â  Â  <button class="btn" id="enviarPeticionBtn">Enviar PeticiÃ³n ğŸ</button>
Â  Â  </div>

Â  <div class="card">
Â  Â  <h2 style="color:var(--accent-green)">Enviar Reporte</h2>
Â  Â  <select id="tipoReporte" style="width:100%;padding:8px;border-radius:6px;margin-bottom:8px;">
Â  Â  Â  <option value="inapropiado">Contenido inapropiado</option>
Â  Â  Â  <option value="error">Error / fallo</option>
Â  Â  Â  <option value="otro">Otro</option>
Â  Â  </select>
Â  Â  <textarea id="reporteInput" placeholder="Describe el reporte..." rows="3" style="width:100%;border-radius:6px;padding:8px;margin-bottom:8px;"></textarea>
Â  Â  <button class="btn" id="enviarReporteBtn">Enviar Reporte ğŸ…</button>
Â  </div>

Â  <div class="card" id="adminPanel">
Â  Â  <h2 style="color:var(--accent-red)">Panel Admin</h2>
Â  Â  <h3>Peticiones</h3>
Â  Â  <table id="peticionesTable"><thead><tr><th>ID</th><th>Usuario</th><th>Contenido</th><th>Fecha</th></tr></thead><tbody></tbody></table>
Â  Â  <h3 style="margin-top:12px;">Reportes</h3>
Â  Â  <table id="reportesTable"><thead><tr><th>ID</th><th>Usuario</th><th>Tipo</th><th>DescripciÃ³n</th><th>Fecha</th></tr></thead><tbody></tbody></table>
Â  </div>
</div>

<div class="auth-container" id="authContainer">
Â  <button class="auth-button" onclick="location.href='l.html'">Iniciar sesiÃ³n / Registrarse</button>
</div>

<div class="user-info" id="userInfo" title="Abrir menÃº de usuario">
Â  <img id="userLogo" src="logoDefault.png" alt="Logo usuario">
Â  <div style="text-align:left">
Â  Â  <div id="userName" style="font-weight:600">Usuario</div>
Â  Â  <div style="font-size:12px;color:#cfcacd">Ver perfil</div>
Â  Â  </div>
</div>

<div class="dropdown-menu" id="dropdownMenu">
Â  <table><tr><td onclick="logout()">ğŸšª Cerrar sesiÃ³n</td></tr></table>
</div>

<div class="nav-container">
Â  <button class="nav-button" onclick="location.href='b.html'">Blog</button>
Â  <button class="nav-button" onclick="location.href='ch.html'">Chat</button>
Â  <button class="nav-button" onclick="location.href='https://sites.google.com/arrigorriagabhi.net/ikasle'">Juegos</button>
Â  <button class="nav-button" onclick="location.href='e.html'">Encuesta</button>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// VARIABLES GLOBALES PARA EL TEMPORIZADOR
let countdownInterval;
let countdownEndDate = null;
let countdownMessage = "";

// ----------------------------------------------------
// FUNCIONES PARA TEMPORIZADOR Y MENSAJE PÃšBLICO (SUPABASE)
// ----------------------------------------------------

/**
 * Formatea milisegundos a DÃ­as, Horas, Minutos, Segundos.
 */
function formatTime(ms) {
Â  if (ms < 0) return "Â¡Tiempo terminado! ğŸ¥³";
Â  const seconds = Math.floor(ms / 1000);
Â  const days = Math.floor(seconds / (3600 * 24));
Â  const hours = Math.floor((seconds % (3600 * 24)) / 3600);
Â  const minutes = Math.floor((seconds % 3600) / 60);
Â  const remainingSeconds = seconds % 60;
Â  
Â  return `${days}d ${hours}h ${minutes}m ${remainingSeconds}s`;
}

/**
 * Actualiza el temporizador en la pantalla de todos los usuarios.
 */
function updateCountdown() {
Â  const display = document.getElementById("countdownDisplay");
Â  const msgEl = document.getElementById("specialMessage");

Â  msgEl.textContent = countdownMessage;

Â  if (!countdownEndDate) {
Â  Â  display.textContent = "Temporizador inactivo.";
Â  Â  return;
Â  }

Â  const endDate = new Date(countdownEndDate).getTime();
Â  const now = new Date().getTime();
Â  const distance = endDate - now;

Â  if (distance < 0) {
Â  Â  display.textContent = "Â¡Tiempo terminado! ğŸ¥³";
Â  Â  clearInterval(countdownInterval);
Â  Â  return;
Â  }

Â  display.textContent = formatTime(distance);
}

/**
 * Carga la configuraciÃ³n del temporizador desde Supabase.
 */
async function loadCountdownConfig() {
Â  try {
Â  Â  const { data, error } = await supabase
Â  Â  Â  .from("timer_config")
Â  Â  Â  .select("end_date, special_message")
Â  Â  Â  .eq("id", 1) // Siempre cargamos el Ãºnico registro (id=1)
Â  Â  Â  .single();

Â  Â  if (error || !data) {
Â  Â  Â  console.error("Error cargando configuraciÃ³n del temporizador:", error);
Â  Â  Â  return;
Â  Â  }

Â  Â  countdownEndDate = data.end_date;
Â  Â  countdownMessage = data.special_message || "";

Â  Â  // Cargar valores en los inputs de Peketruli (si estÃ¡ presente)
Â  Â  if (document.getElementById("peketruliTimerControl").style.display === "block") {
Â  Â  Â  document.getElementById("messageInput").value = countdownMessage;
Â  Â  Â  if (countdownEndDate) {
Â  Â  Â  Â  // Convierte la fecha ISO de Supabase a un formato mÃ¡s amigable para el input
Â  Â  Â  Â  const date = new Date(countdownEndDate);
Â  Â  Â  Â  const year = date.getFullYear();
Â  Â  Â  Â  const month = String(date.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  const day = String(date.getDate()).padStart(2, '0');
Â  Â  Â  Â  const hours = String(date.getHours()).padStart(2, '0');
Â  Â  Â  Â  const minutes = String(date.getMinutes()).padStart(2, '0');
Â  Â  Â  Â  document.getElementById("countdownInput").value = `${year}-${month}-${day} ${hours}:${minutes}`;
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById("countdownInput").value = "";
Â  Â  Â  }
Â  Â  }

Â  Â  // Reiniciar/iniciar el temporizador
Â  Â  clearInterval(countdownInterval);
Â  Â  countdownInterval = setInterval(updateCountdown, 1000);
Â  Â  updateCountdown(); // ActualizaciÃ³n inmediata
Â  } catch (e) {
Â  Â  console.error("ExcepciÃ³n al cargar configuraciÃ³n del temporizador:", e);
Â  }
}

/**
 * Guarda la nueva configuraciÃ³n del temporizador en Supabase (Solo Peketruli).
 */
async function saveCountdownConfig(endDate, message) {
Â  const setBtn = document.getElementById("setCountdownBtn");
Â  const clearBtn = document.getElementById("clearCountdownBtn");

Â  if (setBtn) setBtn.disabled = true;
Â  if (clearBtn) clearBtn.disabled = true;

Â  const updateData = {
Â  Â  end_date: endDate, // Puede ser NULL para "Borrar"
Â  Â  special_message: message || '',
Â  };

Â  try {
Â  Â  const { error } = await supabase
Â  Â  Â  .from("timer_config")
Â  Â  Â  .update(updateData)
Â  Â  Â  .eq("id", 1); // Actualiza el Ãºnico registro

Â  Â  if (error) {
Â  Â  Â  console.error("Error al guardar configuraciÃ³n:", error);
Â  Â  Â  alert("âŒ Error al guardar configuraciÃ³n: " + error.message);
Â  Â  } else {
Â  Â  Â  alert(endDate ? "âœ… Â¡Temporizador establecido!" : "ğŸ—‘ï¸ Temporizador borrado.");
Â  Â  Â  await loadCountdownConfig(); // Recarga para todos
Â  Â  }
Â  } catch (e) {
Â  Â  console.error("ExcepciÃ³n al guardar configuraciÃ³n:", e);
Â  Â  alert("Error interno al guardar la configuraciÃ³n.");
Â  } finally {
Â  Â  if (setBtn) setBtn.disabled = false;
Â  Â  if (clearBtn) clearBtn.disabled = false;
Â  }
}

// ----------------------------------------------------
// MANEJO DE EVENTOS DEL TEMPORIZADOR (Solo Peketruli)
// ----------------------------------------------------

async function handleSetCountdown() {
Â  const inputDateStr = document.getElementById("countdownInput").value.trim();
Â  const inputMessage = document.getElementById("messageInput").value.trim();
Â  
Â  if (!inputDateStr) return alert("Debes introducir una fecha y hora (YYYY-MM-DD HH:MM).");

Â  // Intentar parsear la fecha para validarla
Â  const date = new Date(inputDateStr);
Â  if (isNaN(date)) return alert("Formato de fecha/hora incorrecto. Usa YYYY-MM-DD HH:MM.");

Â  // Guardar en Supabase (la fecha debe ser ISO string)
Â  await saveCountdownConfig(date.toISOString(), inputMessage);
}

async function handleClearCountdown() {
Â  // Usar NULL para la fecha y string vacÃ­o para el mensaje
Â  await saveCountdownConfig(null, "Temporizador inactivo. ğŸ’¤");
}


// ----------------------------------------------------
// LÃ“GICA DE INICIO GENERAL
// ----------------------------------------------------

document.addEventListener("DOMContentLoaded", async () => {
Â  const authContainer = document.getElementById("authContainer");
Â  const userInfo = document.getElementById("userInfo");
Â  const dropdownMenu = document.getElementById("dropdownMenu");
Â  const adminPanel = document.getElementById("adminPanel");
Â  const peketruliControl = document.getElementById("peketruliTimerControl");

Â  
Â  // Asignar eventos de control del temporizador (solo para Peketruli)
Â  document.getElementById("setCountdownBtn")?.addEventListener("click", handleSetCountdown);
Â  document.getElementById("clearCountdownBtn")?.addEventListener("click", handleClearCountdown);
Â  

Â  let sendingPetition = false;
Â  let sendingReport = false;

Â  // Carga y pinta peticiones/reportes en el panel admin
Â  async function loadAdminData() {
Â  Â  // ... (Tu cÃ³digo loadAdminData se mantiene igual)
Â  Â  if (!adminPanel) return;
Â  Â  const tbodyP = document.querySelector("#peticionesTable tbody");
Â  Â  const tbodyR = document.querySelector("#reportesTable tbody");
Â  Â  tbodyP && (tbodyP.innerHTML = "");
Â  Â  tbodyR && (tbodyR.innerHTML = "");

Â  Â  try {
Â  Â  Â  const { data: peticiones, error: errP } = await supabase
Â  Â  Â  Â  .from("peticiones")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .order("id", { ascending: false });

Â  Â  Â  if (errP) {
Â  Â  Â  Â  console.error("Error cargando peticiones:", errP);
Â  Â  Â  Â  tbodyP.innerHTML = `<tr><td colspan="4" style="color:red;">Error cargando peticiones</td></tr>`;
Â  Â  Â  } else if (!peticiones || peticiones.length === 0) {
Â  Â  Â  Â  tbodyP.innerHTML = `<tr><td colspan="4">No hay peticiones</td></tr>`;
Â  Â  Â  } else {
Â  Â  Â  Â  peticiones.forEach(p => {
Â  Â  Â  Â  Â  const fecha = p.created_at ? new Date(p.created_at).toLocaleString() : "Sin fecha";
Â  Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  Â  tr.innerHTML = `<td>${p.id}</td><td>${escapeHtml(p.usuario)}</td><td>${escapeHtml(p.contenido)}</td><td>${fecha}</td>`;
Â  Â  Â  Â  Â  tbodyP.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error("ExcepciÃ³n al cargar peticiones:", e);
Â  Â  Â  if (tbodyP) tbodyP.innerHTML = `<tr><td colspan="4" style="color:red;">Error interno</td></tr>`;
Â  Â  }

Â  Â  try {
Â  Â  Â  const { data: reportes, error: errR } = await supabase
Â  Â  Â  Â  .from("reportes")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .order("id", { ascending: false });

Â  Â  Â  if (errR) {
Â  Â  Â  Â  console.error("Error cargando reportes:", errR);
Â  Â  Â  Â  tbodyR.innerHTML = `<tr><td colspan="5" style="color:red;">Error cargando reportes</td></tr>`;
Â  Â  Â  } else if (!reportes || reportes.length === 0) {
Â  Â  Â  Â  tbodyR.innerHTML = `<tr><td colspan="5">No hay reportes</td></tr>`;
Â  Â  Â  } else {
Â  Â  Â  Â  reportes.forEach(r => {
Â  Â  Â  Â  Â  const fecha = r.created_at ? new Date(r.created_at).toLocaleString() : "Sin fecha";
Â  Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  Â  tr.innerHTML = `<td>${r.id}</td><td>${escapeHtml(r.usuario)}</td><td>${escapeHtml(r.tipo)}</td><td>${escapeHtml(r.descripcion)}</td><td>${fecha}</td>`;
Â  Â  Â  Â  Â  tbodyR.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.error("ExcepciÃ³n al cargar reportes:", e);
Â  Â  Â  if (tbodyR) tbodyR.innerHTML = `<tr><td colspan="5" style="color:red;">Error interno</td></tr>`;
Â  Â  }
Â  }

Â  // Carga info de usuario, determina permisos y carga datos
Â  async function loadUserInfo() {
Â  Â  let user = null;
Â  Â  try {
Â  Â  Â  const { data: { session } = {} } = await supabase.auth.getSession();
Â  Â  Â  if (session?.user) {
Â  Â  Â  Â  user = {
Â  Â  Â  Â  Â  username: session.user.user_metadata?.username || session.user.email,
Â  Â  Â  Â  Â  email: session.user.email,
Â  Â  Â  Â  Â  logo: session.user.user_metadata?.logo || "logoDefault.png"
Â  Â  Â  Â  };
Â  Â  Â  Â  localStorage.setItem("currentUser", JSON.stringify(user));
Â  Â  Â  } else {
Â  Â  Â  Â  try { user = JSON.parse(localStorage.getItem("currentUser") || "null"); } catch {}
Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  console.warn("No se pudo obtener session de supabase:", e);
Â  Â  Â  try { user = JSON.parse(localStorage.getItem("currentUser") || "null"); } catch {}
Â  Â  }

Â  Â  if (user) {
Â  Â  Â  if (userInfo) userInfo.style.display = "flex";
Â  Â  Â  if (authContainer) authContainer.style.display = "none";
Â  Â  Â  const nameEl = document.getElementById("userName");
Â  Â  Â  const logoEl = document.getElementById("userLogo");
Â  Â  Â  if (nameEl) nameEl.textContent = user.username;
Â  Â  Â  if (logoEl) logoEl.src = user.logo || "logoDefault.png";

Â  Â  Â  if (user.username === "Peketruli") {
Â  Â  Â  Â  if (adminPanel) {
Â  Â  Â  Â  Â  adminPanel.style.display = "block";
Â  Â  Â  Â  Â  await loadAdminData();
Â  Â  Â  Â  }
Â  Â  Â  Â  // Mostrar control del temporizador solo para Peketruli
Â  Â  Â  Â  if (peketruliControl) peketruliControl.style.display = "block";
Â  Â  Â  } else {
Â  Â  Â  Â  if (adminPanel) adminPanel.style.display = "none";
Â  Â  Â  Â  if (peketruliControl) peketruliControl.style.display = "none";
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  if (userInfo) userInfo.style.display = "none";
Â  Â  Â  if (authContainer) authContainer.style.display = "flex";
Â  Â  Â  if (adminPanel) adminPanel.style.display = "none";
Â  Â  Â  if (peketruliControl) peketruliControl.style.display = "none";
Â  Â  }
Â  }

Â  await loadUserInfo();
Â  await loadCountdownConfig(); // Â¡Cargar el temporizador pÃºblico!

Â  // Dropdown menÃº usuario
Â  if (userInfo && dropdownMenu) {
Â  Â  userInfo.addEventListener("click", (e) => {
Â  Â  Â  e.stopPropagation();
Â  Â  Â  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
Â  Â  });

Â  Â  document.addEventListener("click", (e) => {
Â  Â  Â  if (!userInfo.contains(e.target) && !dropdownMenu.contains(e.target)) {
Â  Â  Â  Â  dropdownMenu.style.display = "none";
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Logout
Â  window.logout = async function() {
Â  Â  try { await supabase.auth.signOut(); } catch (e) { console.warn("signOut error", e); }
Â  Â  localStorage.removeItem("currentUser");
Â  Â  window.location.href = "l.html";
Â  };

Â  // Enviar peticiÃ³n
Â  const petBtn = document.getElementById("enviarPeticionBtn");
Â  if (petBtn) {
Â  Â  petBtn.addEventListener("click", async function () {
Â  Â  Â  if (sendingPetition) return;
Â  Â  Â  const contenido = (document.getElementById("peticionInput")?.value || "").trim();
Â  Â  Â  if (!contenido) return alert("Escribe algo antes de enviar.");

Â  Â  Â  sendingPetition = true;
Â  Â  Â  petBtn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const user = JSON.parse(localStorage.getItem("currentUser") || "null") || { username: "AnÃ³nimo" };
Â  Â  Â  Â  const created_at = new Date().toISOString();

Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  .from("peticiones")
Â  Â  Â  Â  Â  .insert([{ usuario: user.username, contenido, created_at }]);

Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  console.error("Error insert peticion:", error);
Â  Â  Â  Â  Â  alert("Error al enviar: " + (error.message || JSON.stringify(error)));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const input = document.getElementById("peticionInput");
Â  Â  Â  Â  Â  if (input) input.value = "";
Â  Â  Â  Â  Â  alert("âœ… Â¡PeticiÃ³n enviada!");
Â  Â  Â  Â  Â  await loadAdminData();
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("ExcepciÃ³n al enviar peticion:", e);
Â  Â  Â  Â  alert("Error al enviar la peticiÃ³n.");
Â  Â  Â  } finally {
Â  Â  Â  Â  sendingPetition = false;
Â  Â  Â  Â  petBtn.disabled = false;
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Enviar reporte
Â  const repBtn = document.getElementById("enviarReporteBtn");
Â  if (repBtn) {
Â  Â  repBtn.addEventListener("click", async function () {
Â  Â  Â  if (sendingReport) return;
Â  Â  Â  const descripcion = (document.getElementById("reporteInput")?.value || "").trim();
Â  Â  Â  if (!descripcion) return alert("Describe el reporte antes de enviar.");

Â  Â  Â  sendingReport = true;
Â  Â  Â  repBtn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const tipo = document.getElementById("tipoReporte")?.value || "otro";
Â  Â  Â  Â  const user = JSON.parse(localStorage.getItem("currentUser") || "null") || { username: "AnÃ³nimo" };
Â  Â  Â  Â  const created_at = new Date().toISOString();

Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  .from("reportes")
Â  Â  Â  Â  Â  .insert([{ usuario: user.username, tipo, descripcion, created_at }]);

Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  console.error("Error insert reporte:", error);
Â  Â  Â  Â  Â  alert("Error al enviar: " + (error.message || JSON.stringify(error)));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const input = document.getElementById("reporteInput");
Â  Â  Â  Â  Â  if (input) input.value = "";
Â  Â  Â  Â  Â  alert("âœ… Â¡Reporte enviado!");
Â  Â  Â  Â  Â  await loadAdminData();
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("ExcepciÃ³n al enviar reporte:", e);
Â  Â  Â  Â  alert("Error al enviar el reporte.");
Â  Â  Â  } finally {
Â  Â  Â  Â  sendingReport = false;
Â  Â  Â  Â  repBtn.disabled = false;
Â  Â  Â  }
Â  Â  });
Â  }

Â  // Utilidad: escape simple para mostrar texto de usuarios en tablas
Â  function escapeHtml(text) {
Â  Â  if (text === null || text === undefined) return "";
Â  Â  return String(text)
Â  Â  Â  .replaceAll("&", "&amp;")
Â  Â  Â  .replaceAll("<", "&lt;")
Â  Â  Â  .replaceAll(">", "&gt;")
Â  Â  Â  .replaceAll('"', "&quot;")
Â  Â  Â  .replaceAll("'", "&#039;");
Â  }
});
</script>
</body>
</html>
