<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas en Vivo - Navidad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root{
  --text-color: #222;
  --accent-red: #c62828;
  --accent-green: #2e7d32;
  --accent-gold: #d4af37;
}

/* üéÑ Fondo navide√±o pintado */
body {
  font-family: 'Segoe UI', sans-serif;
  color: var(--text-color);
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(to bottom, #ffffff 0%, #f2f7ff 40%, #d2ecff 100%);
  background-attachment: fixed;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

/* ‚ùÑÔ∏è Copos suaves pintados */
body::before, body::after {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  background-image: radial-gradient(white 1px, transparent 1px);
  background-size: 40px 40px;
  opacity: 0.3;
  animation: snowFall 40s linear infinite;
}
body::after {
  background-size: 25px 25px;
  opacity: 0.4;
  animation-duration: 60s;
}
@keyframes snowFall {
  0% { transform: translateY(0); }
  100% { transform: translateY(100%); }
}

/* üïØÔ∏è Marco central */
.container {
  position: relative;
  z-index: 5;
  background: rgba(255,255,255,0.9);
  border: 3px solid var(--accent-red);
  border-radius: 20px;
  box-shadow: 0 0 30px rgba(0,0,0,0.1);
  padding: 40px 30px;
  width: 90%;
  max-width: 500px;
  text-align: center;
}

/* üéÅ T√≠tulo */
h1, h2 {
  color: var(--accent-green);
  text-shadow: 0 1px 0 #fff;
}

/* üéÖ Inputs y botones */
input, .poll-option, .back-button, .submit-button, .add-option-button, .delete-button {
  display: block;
  width: 80%;
  padding: 12px;
  margin: 10px auto;
  font-size: 16px;
  border-radius: 10px;
  border: 2px solid var(--accent-green);
  background: #fff;
  color: var(--accent-green);
  transition: all 0.3s ease;
}
input:focus, .poll-option:hover, .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover {
  background: var(--accent-green);
  color: #fff;
  transform: scale(1.05);
}

/* Bot√≥n volver */
#backButton, .back-button {
  position: fixed;
  top: 20px;
  left: 20px;
  background: var(--accent-red);
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: bold;
  z-index: 9999;
  transition: all 0.2s ease;
}
#backButton:hover, .back-button:hover {
  transform: scale(1.1);
  box-shadow: 0 0 10px var(--accent-gold);
}
</style>
</head>
<body>

<div class="container">
  <h1>üéÑ Encuestas en Vivo üéÑ</h1>

  <!-- Crear encuesta -->
  <div id="createPoll" style="display:none;">
    <h2>Crear una nueva encuesta</h2>
    <input type="text" id="newQuestion" placeholder="Escribe la pregunta"><br>
    <div id="optionsContainer">
      <input type="text" class="option-input" placeholder="Opci√≥n 1"><br>
      <input type="text" class="option-input" placeholder="Opci√≥n 2"><br>
    </div>
    <button class="add-option-button" onclick="addOption()">A√±adir Opci√≥n</button><br>
    <label>Duraci√≥n:</label><br>
    <input type="number" id="hours" placeholder="Horas" min="0" value="0"> h
    <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" value="0"> m<br><br>
    <button class="submit-button" onclick="createPoll()">Crear Encuesta</button>
  </div>

  <!-- Encuesta activa -->
  <div id="pollContainer" style="display:none;">
    <h2 id="question">Pregunta en vivo</h2>
    <div id="pollOptions"></div>
    <p id="timer">Tiempo restante: --</p>
    <p id="results" style="display:none;"></p>
    <button class="delete-button" id="deleteButton" style="display:none;" onclick="deletePoll()">Eliminar Encuesta</button>
  </div>
</div>

<button class="back-button" onclick="goToMainPage()">Volver a la P√°gina Principal</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentPoll = null;
let pollInterval = null;
let pollEnded = false;

const user = JSON.parse(localStorage.getItem("currentUser"));

document.addEventListener("DOMContentLoaded", async () => {
  if(user && ["Peketruli","SabinoArana","Jesus de Nazaret","General Suker","(JUSTICIA POR PEKEPO11AENORME)_69"].includes(user.username)){
    document.getElementById("createPoll").style.display = "block";
    document.getElementById("deleteButton").style.display = "block";
  }
  await loadActivePoll();
});

function addOption(){
  const container=document.getElementById("optionsContainer");
  const count=container.getElementsByClassName("option-input").length+1;
  const input=document.createElement("input");
  input.type="text";
  input.className="option-input";
  input.placeholder=`Opci√≥n ${count}`;
  container.appendChild(input);
  container.appendChild(document.createElement("br"));
}

async function createPoll(){
  const question=document.getElementById("newQuestion").value;
  const options=Array.from(document.getElementsByClassName("option-input")).map(i=>i.value).filter(o=>o);
  const h=parseInt(document.getElementById("hours").value)||0;
  const m=parseInt(document.getElementById("minutes").value)||0;
  const duration=(h*3600)+(m*60);
  if(!question||options.length<2||duration<=0){alert("Completa todos los campos.");return;}
  localStorage.removeItem("votedPollId");
  const { data, error }=await db.from("polls").insert([{question,options:options.map(o=>({text:o})),votes:new Array(options.length).fill(0),duration,creator:user.username,start_time:new Date()}]).select().single();
  if(error){alert("Error: "+error.message);return;}
  alert("‚úÖ Encuesta creada!");
  loadPoll(data.id);
}

async function vote(i){
  if(!currentPoll||pollEnded)return;
  if(localStorage.getItem("votedPollId")===currentPoll.id){alert("Ya votaste.");return;}
  localStorage.setItem("votedPollId",currentPoll.id);
  currentPoll.votes[i]++;
  const { error }=await db.from("polls").update({votes:currentPoll.votes}).eq("id",currentPoll.id);
  if(error)alert("Error al votar: "+error.message);
  renderPollOptions();
  showResults();
}

async function loadActivePoll(){
  const { data }=await db.from("polls").select("*").order("created_at",{ascending:false}).limit(1);
  if(data&&data.length>0)loadPoll(data[0].id);
}

async function loadPoll(id){
  const { data }=await db.from("polls").select("*").eq("id",id).single();
  currentPoll=data;
  document.getElementById("question").textContent=data.question;
  renderPollOptions();
  document.getElementById("pollContainer").style.display="block";
  if(pollInterval)clearInterval(pollInterval);
  pollEnded=false;
  startTimer(new Date(data.start_time).getTime(),data.duration);
}

function renderPollOptions(){
  const cont=document.getElementById("pollOptions");
  cont.innerHTML="";
  const max=Math.max(...currentPoll.votes);
  const win=currentPoll.votes.indexOf(max);
  currentPoll.options.forEach((opt,i)=>{
    const btn=document.createElement("button");
    btn.className="poll-option";
    const v=currentPoll.votes[i]||0;
    btn.textContent=`${opt.text} (${v} votos)`;
    if(pollEnded&&i===win){btn.style.backgroundColor="gold";btn.style.color="#222";}
    btn.disabled=pollEnded;
    btn.onclick=()=>vote(i);
    cont.appendChild(btn);
  });
}

function startTimer(start,dur){
  let left=dur-Math.floor((Date.now()-start)/1000);
  const t=document.getElementById("timer");
  pollInterval=setInterval(()=>{
    left--;
    t.textContent=`Tiempo restante: ${left}s`;
    if(left<=0){clearInterval(pollInterval);pollEnded=true;showResults();renderPollOptions();}
  },1000);
}

function showResults(){
  const el=document.getElementById("results");
  const c=currentPoll.votes;
  const total=c.reduce((a,b)=>a+b,0);
  el.innerHTML=total===0?"No hubo votos.":"Resultados:<br>";
  c.forEach((v,i)=>{el.innerHTML+=`${currentPoll.options[i].text}: ${v} votos<br>`;});
  el.style.display="block";
}

function goToMainPage(){window.location.href='h.html';}
</script>
</body>
</html>
