<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encuestas en Vivo - Navidad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root {
  --text-color: #fffdf9;
  --accent-red: #ff4040;
  --accent-green: #2ecc71;
  --accent-gold: #ffd700;
}

/* ğŸ… Fondo navideÃ±o */
body {
  font-family: "Poppins", sans-serif;
  color: var(--text-color);
  text-align: center;
  margin: 0;
  padding: 50px 20px;
  min-height: 100vh;
  background: linear-gradient(180deg, #6bc5ff 0%, #b2e8ff 40%, #ffffff 100%);
  overflow-x: hidden;
}

/* â„ï¸ Nieve animada */
@keyframes snow {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(100vh); opacity: 0; }
}
.snowflake {
  position: fixed;
  top: -10px;
  color: white;
  font-size: 1em;
  user-select: none;
  pointer-events: none;
  animation: snow linear infinite;
  z-index: 999;
}

/* ğŸ„ Ãrboles y suelo nevado */
.scene-bg {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 35vh;
  background: url('https://i.imgur.com/bpHKQkS.png') repeat-x bottom;
  background-size: cover;
  z-index: 1;
}

/* ğŸ… Santa volador */
#santa {
  position: fixed;
  top: 100px;
  left: -200px;
  width: 180px;
  height: auto;
  z-index: 3;
  animation: flySanta 30s linear infinite;
}
@keyframes flySanta {
  0% { left: -200px; transform: scaleX(1); }
  49% { left: calc(100% + 200px); transform: scaleX(1); }
  50% { left: calc(100% + 200px); transform: scaleX(-1); }
  100% { left: -200px; transform: scaleX(-1); }
}

/* ğŸ’¡ Luces navideÃ±as */
.lights {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: repeating-linear-gradient(
    to right,
    red 0 20px,
    gold 20px 40px,
    green 40px 60px
  );
  filter: blur(2px) brightness(1.5);
  animation: twinkle 2s infinite alternate;
  z-index: 2;
}
@keyframes twinkle {
  0%, 100% { opacity: 0.9; }
  50% { opacity: 0.5; }
}

/* ğŸ§Š Contenedores */
.poll-container, .create-poll {
  position: relative;
  z-index: 10;
  max-width: 550px;
  margin: 30px auto;
  padding: 25px;
  border-radius: 15px;
  background: rgba(255, 255, 255, 0.85);
  border: 3px solid var(--accent-red);
  box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
  color: #333;
}

/* ğŸ Titulares */
h1 {
  color: var(--accent-red);
  text-shadow: 2px 2px 6px rgba(0,0,0,0.3);
  font-size: 2.5em;
}
h2 {
  color: var(--accent-green);
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
}

/* ğŸ€ Inputs y botones */
input, .poll-option, .back-button, .submit-button, .add-option-button, .delete-button {
  display: block;
  width: 80%;
  padding: 15px;
  margin: 10px auto;
  font-size: 18px;
  cursor: pointer;
  border-radius: 10px;
  border: 2px solid var(--accent-red);
  background: #fff;
  color: var(--accent-red);
  font-weight: bold;
  transition: all 0.3s ease;
}
input:focus, .poll-option:hover, .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover {
  background: var(--accent-green);
  color: white;
  transform: scale(1.05);
}

/* ğŸ”” BotÃ³n volver */
.back-button {
  background: var(--accent-red);
  color: white;
  border: none;
  width: auto;
  padding: 12px 25px;
  position: fixed;
  top: 20px;
  left: 20px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 9999;
  box-shadow: 0 0 10px rgba(255,0,0,0.5);
}

/* ğŸ§ Resultados */
#results {
  color: var(--accent-gold);
  font-weight: bold;
}

/* ğŸ•¯ï¸ PequeÃ±as luces flotantes */
@keyframes sparkle {
  0%,100% { opacity: 0.3; transform: translateY(0) scale(1); }
  50% { opacity: 1; transform: translateY(-8px) scale(1.2); }
}
.sparkle {
  position: fixed;
  width: 8px;
  height: 8px;
  background: gold;
  border-radius: 50%;
  animation: sparkle 2s ease-in-out infinite;
  z-index: 4;
}
</style>
</head>
<body>

<!-- ğŸ… Santa volando -->
<img id="santa" src="https://i.imgur.com/t4wF1xL.gif" alt="Santa">

<!-- ğŸ’¡ Luces -->
<div class="lights"></div>

<!-- ğŸ„ Fondo -->
<div class="scene-bg"></div>

<!-- â„ï¸ Copos de nieve generados por JS -->
<div id="snowContainer"></div>

<h1>ğŸ… Encuestas NavideÃ±as ğŸ„</h1>

<!-- Crear encuesta -->
<div id="createPoll" class="create-poll" style="display: none;">
  <h2>Crear una nueva encuesta</h2>
  <input type="text" id="newQuestion" placeholder="Escribe la pregunta">
  <div id="optionsContainer">
    <input type="text" class="option-input" placeholder="OpciÃ³n 1">
    <input type="text" class="option-input" placeholder="OpciÃ³n 2">
  </div>
  <button class="add-option-button" onclick="addOption()">AÃ±adir OpciÃ³n</button>
  <label>DuraciÃ³n:</label><br>
  <input type="number" id="hours" placeholder="Horas" min="0" value="0"> h
  <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" value="1"> m<br><br>
  <button class="submit-button" onclick="createPoll()">Crear Encuesta ğŸ</button>
</div>

<!-- Encuesta activa -->
<div class="poll-container" id="pollContainer" style="display: none;">
  <h2 id="question">Pregunta en vivo</h2>
  <div id="pollOptions"></div>
  <p id="timer">Tiempo restante: --</p>
  <p id="results" style="display: none;"></p>
  <button class="delete-button" id="deleteButton" style="display: none;" onclick="deletePoll()">Eliminar Encuesta</button>
</div>

<button class="back-button" onclick="goToMainPage()">Volver ğŸ„</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentPoll = null;
let pollInterval = null;
let pollEnded = false;

const user = JSON.parse(localStorage.getItem("currentUser"));
let votedPollId = localStorage.getItem("votedPollId");

/* Registrar actividad */
async function registrarActividad(usuario, accion, detalle = "") {
  try {
    const { error } = await db.from("actividad").insert([{ usuario, accion, detalle }]);
    if (error) console.error("Error registrando actividad:", error.message);
  } catch (err) {
    console.error("Error inesperado al registrar actividad:", err);
  }
}

/* InicializaciÃ³n */
document.addEventListener("DOMContentLoaded", async () => {
  generarNieve();
  generarBrillos();

  if (user && (user.username === "Peketruli" || user.username === "SabinoArana" || user.username === "Jesus de Nazaret" || user.username === "General Suker" || user.username === "(JUSTICIA POR PEKEPO11AENORME)_69")) {
    document.getElementById("createPoll").style.display = "block";
    document.getElementById("deleteButton").style.display = "block";
  }
  await loadActivePoll();
  if (user && currentPoll) {
    await registrarActividad(user.username, `visualizÃ³ la encuesta`, currentPoll.question);
  }
});

/* AÃ±adir opciÃ³n */
function addOption() {
  const optionsContainer = document.getElementById("optionsContainer");
  const input = document.createElement("input");
  input.type = "text";
  input.className = "option-input";
  input.placeholder = `OpciÃ³n ${optionsContainer.querySelectorAll('.option-input').length + 1}`;
  optionsContainer.appendChild(input);
}

/* Crear encuesta */
async function createPoll() {
  const question = document.getElementById("newQuestion").value;
  const options = Array.from(document.getElementsByClassName("option-input")).map(i => i.value).filter(Boolean);
  const hours = parseInt(document.getElementById("hours").value) || 0;
  const minutes = parseInt(document.getElementById("minutes").value) || 0;
  const duration = (hours * 3600) + (minutes * 60);
  if (!question || options.length < 2 || duration <= 0) { alert("Completa todos los campos."); return; }

  const { data, error } = await db.from("polls").insert([{ 
    question, 
    options: options.map(o => ({ text: o })), 
    votes: new Array(options.length).fill(0), 
    duration, 
    creator: user.username, 
    start_time: new Date() 
  }]).select().single();

  if (error) { alert("Error al crear: " + error.message); return; }

  await registrarActividad(user.username, `creÃ³ una encuesta navideÃ±a`, question);
  alert("ğŸ… Encuesta creada con Ã©xito!");
  loadPoll(data.id);
}

/* Votar */
async function vote(optionIndex) {
  if (!currentPoll) return;
  if (pollEnded) { alert("La encuesta ha terminado."); return; }
  if (localStorage.getItem("votedPollId") === currentPoll.id) { alert("Ya votaste."); return; }

  localStorage.setItem("votedPollId", currentPoll.id);
  currentPoll.votes[optionIndex]++;

  await db.from("polls").update({ votes: currentPoll.votes }).eq("id", currentPoll.id);
  const opcion = currentPoll.options[optionIndex].text;
  await registrarActividad(user.username, `votÃ³ en una encuesta`, opcion);
  renderPollOptions();
  showResults();
}

/* Cargar encuesta */
async function loadActivePoll() {
  const { data: polls } = await db.from("polls").select("*").order("created_at", { ascending: false }).limit(1);
  if (polls && polls.length > 0) loadPoll(polls[0].id);
}
async function loadPoll(id) {
  const { data: poll } = await db.from("polls").select("*").eq("id", id).single();
  currentPoll = poll;
  document.getElementById("question").textContent = poll.question;
  renderPollOptions();
  document.getElementById("pollContainer").style.display = "block";
  pollEnded = false;
  startTimer(new Date(poll.start_time).getTime(), poll.duration);
}

/* Render opciones */
function renderPollOptions() {
  const container = document.getElementById("pollOptions");
  container.innerHTML = "";
  currentPoll.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.className = "poll-option";
    btn.textContent = `${opt.text} (${currentPoll.votes[i] || 0} votos)`;
    btn.disabled = pollEnded;
    btn.onclick = () => vote(i);
    container.appendChild(btn);
  });
}

/* Timer */
function startTimer(startTime, duration) {
  let timeLeft = duration - Math.floor((Date.now() - startTime) / 1000);
  const timer = document.getElementById("timer");
  pollInterval = setInterval(() => {
    timeLeft--;
    timer.textContent = `Tiempo restante: ${timeLeft}s`;
    if (timeLeft <= 0) {
      clearInterval(pollInterval);
      pollEnded = true;
      showResults();
      renderPollOptions();
    }
  }, 1000);
}

/* Resultados */
function showResults() {
  const r = document.getElementById("results");
  const total = currentPoll.votes.reduce((a, b) => a + b, 0);
  r.innerHTML = total === 0 ? "No hubo votos ğŸ…" : "ğŸ„ Resultados:<br>";
  currentPoll.votes.forEach((c, i) => {
    r.innerHTML += `${currentPoll.options[i].text}: ${c} votos<br>`;
  });
  r.style.display = "block";
}

/* Eliminar encuesta */
async function deletePoll() {
  if (!currentPoll) return;
  if (!confirm("Â¿Eliminar esta encuesta?")) return;
  await db.from("polls").delete().eq("id", currentPoll.id);
  alert("ğŸ Encuesta eliminada");
  location.reload();
}

/* Volver */
function goToMainPage() { window.location.href = 'h.html'; }

/* ğŸŒ¨ï¸ Generar nieve */
function generarNieve() {
  const snowContainer = document.getElementById("snowContainer");
  for (let i = 0; i < 60; i++) {
    const snow = document.createElement("div");
    snow.classList.add("snowflake");
    snow.textContent = "â„";
    snow.style.left = Math.random() * 100 + "%";
    snow.style.animationDuration = (5 + Math.random() * 10) + "s";
    snow.style.fontSize = (10 + Math.random() * 20) + "px";
    snowContainer.appendChild(snow);
  }
}

/* âœ¨ Brillos flotantes */
function generarBrillos() {
  for (let i = 0; i < 20; i++) {
    const b = document.createElement("div");
    b.className = "sparkle";
    b.style.left = Math.random() * 100 + "%";
    b.style.top = Math.random() * 100 + "%";
    b.style.animationDuration = (1 + Math.random() * 2) + "s";
    document.body.appendChild(b);
  }
}
</script>
</body>
</html>
