<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Encuestas en Vivo ‚Äî Navidad Premium</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  :root{
    --bg-sky-1: #7fb8e6;
    --bg-sky-2: #eaf6ff;
    --accent-red: #c0392b;
    --accent-green: #27ae60;
    --accent-gold: #d4af37;
    --card-bg: rgba(255,255,255,0.95);
    --muted: #444;
    --glass: rgba(255,255,255,0.06);
  }

  /* Reset / layout */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg, var(--bg-sky-1) 0%, var(--bg-sky-2) 50%, #ffffff 100%);
    color: #111;
    overflow-x: hidden;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ---------- Container / header ---------- */
  .page {
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:28px 20px 80px;
    position:relative;
  }

  h1{
    margin:10px 0 18px;
    font-size:32px;
    color:var(--accent-green);
    text-shadow:0 2px 8px rgba(0,0,0,0.08);
    letter-spacing:0.4px;
  }

  /* ---------- Parallax layers (SVG trees/mountains) ---------- */
  .parallax {
    position:fixed;
    left:0;right:0;
    bottom:0;
    height:48vh;
    pointer-events:none;
    z-index:0;
    overflow:hidden;
  }
  .parallax .layer{ position:absolute; left:0; right:0; bottom:0; width:100%; }
  .layer.bg { transform:translateZ(0) scale(1); opacity:1; z-index:0; }
  .layer.mid { transform:translateZ(0); z-index:1; opacity:0.95; }
  .layer.front { transform:translateZ(0); z-index:2; opacity:1; }

  /* ---------- Canvas nieve (top) ---------- */
  #snowCanvas{
    position:fixed;
    inset:0;
    z-index:5;
    pointer-events:none;
  }

  /* ---------- Lights (string) ---------- */
  .lights {
    position:fixed;
    top:8px;
    left:0;
    right:0;
    height:56px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    pointer-events:none;
    z-index:6;
  }
  .light-bulb {
    width:14px;height:22px;border-radius:50%;
    box-shadow:0 0 12px rgba(255,255,255,0.12);
    filter:drop-shadow(0 4px 14px rgba(0,0,0,0.2));
    animation:bulbTwinkle 1.6s ease-in-out infinite;
  }
  .light-bulb:nth-child(odd){ animation-duration:1.2s; }
  .light-bulb.red{ background:var(--accent-red); box-shadow:0 0 18px rgba(192,57,43,0.45); }
  .light-bulb.green{ background:var(--accent-green); box-shadow:0 0 18px rgba(39,174,96,0.45); }
  .light-bulb.gold{ background:var(--accent-gold); box-shadow:0 0 18px rgba(212,175,55,0.45); }

  @keyframes bulbTwinkle {
    0%{ transform:scale(.95); opacity:.7 }
    50%{ transform:scale(1.15); opacity:1 }
    100%{ transform:scale(.95); opacity:.8 }
  }

  /* ---------- Card UI ---------- */
  .panel {
    position:relative;
    z-index:10;
    max-width:720px;
    width:100%;
    background:var(--card-bg);
    border-radius:14px;
    box-shadow:0 8px 40px rgba(0,0,0,0.12);
    padding:22px;
    margin-top:28px;
    border:1px solid rgba(0,0,0,0.06);
  }

  .muted{ color:var(--muted); font-size:0.95rem; }

  .row { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; }

  /* inputs / buttons */
  input[type="text"], input[type="number"], textarea {
    width: 100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #ddd;
    background: #fff;
    resize:vertical;
    font-size:1rem;
  }

  button {
    background: linear-gradient(180deg,var(--accent-red), #8f2a2a);
    color:#fff;
    border: none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 8px 18px rgba(0,0,0,0.12);
  }
  button.secondary {
    background: linear-gradient(180deg, var(--accent-green), #1f8b4f);
  }
  button.ghost {
    background:transparent;
    color:var(--muted);
    border:1px dashed #ccc;
  }

  .small { padding:8px 10px; border-radius:8px; font-size:0.95rem; }

  /* poll option button */
  .poll-option {
    display:block;
    width:100%;
    text-align:left;
    padding:12px 14px;
    margin:8px 0;
    border-radius:10px;
    background:linear-gradient(180deg,#fff,#f7f7f7);
    border:1px solid #e6e6e6;
    cursor:pointer;
    transition: all .12s ease;
    font-weight:600;
  }
  .poll-option:hover { transform:translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  .poll-option:disabled { opacity:0.7; cursor:default; transform:none; box-shadow:none; }

  /* timer / results */
  #timer { margin-top:12px; font-weight:600; color:var(--muted); }
  #results { margin-top:12px; color:var(--accent-gold); font-weight:700; }

  /* Floating music controller */
  .music-control {
    position:fixed;
    bottom:20px;
    right:20px;
    z-index:12;
    background: rgba(255,255,255,0.92);
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
    padding:8px 12px;
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid rgba(0,0,0,0.06);
  }
  .music-control button { background:transparent; color:#111; padding:6px; border-radius:8px; box-shadow:none; border:1px solid rgba(0,0,0,0.06); }
  .music-control .label { font-weight:600; color:#111; }

  /* back button */
  .back { position:fixed; top:18px; left:18px; z-index:12; background:rgba(255,255,255,0.95); padding:8px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; }

  /* responsive */
  @media (max-width:720px){
    .panel { padding:16px; margin-top:18px; border-radius:12px; }
    h1 { font-size:22px; }
  }

</style>
</head>
<body>
  <div class="parallax" aria-hidden="true">
    <!-- Back mountains (far) ‚Äî SVG stylized -->
    <div class="layer bg" style="transform:translateY(6%);">
      <svg viewBox="0 0 1440 320" preserveAspectRatio="none" style="width:100%;height:48vh;display:block;">
        <defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#e3f5ff"/><stop offset="1" stop-color="#b8e6ff"/></linearGradient></defs>
        <path d="M0,200 C140,140 280,160 420,200 C560,240 700,200 840,220 C980,240 1120,200 1280,210 C1360,215 1440,190 1440,190 L1440,320 L0,320 Z" fill="url(#g1)"></path>
      </svg>
    </div>

    <!-- mid trees -->
    <div class="layer mid" style="transform:translateY(2%);">
      <svg viewBox="0 0 1440 220" preserveAspectRatio="none" style="width:100%;height:36vh;display:block;">
        <g fill="#0b3b20">
          <!-- repeated tree shapes -->
          <polygon points="40,220 80,140 120,220" />
          <polygon points="160,220 200,120 240,220" />
          <polygon points="320,220 360,110 400,220" />
          <polygon points="560,220 600,110 640,220" />
          <polygon points="800,220 840,130 880,220" />
          <polygon points="1040,220 1080,120 1120,220" />
          <polygon points="1280,220 1320,140 1360,220" />
        </g>
      </svg>
    </div>

    <!-- front snow/trees -->
    <div class="layer front" style="transform:translateY(0%);">
      <svg viewBox="0 0 1440 160" preserveAspectRatio="none" style="width:100%;height:24vh;display:block;">
        <rect x="0" y="60" width="1440" height="100" fill="#ffffff"/>
        <g fill="#0b2f17">
          <polygon points="60,160 100,100 140,160" />
          <polygon points="240,160 280,90 320,160" />
          <polygon points="420,160 460,95 500,160" />
          <polygon points="720,160 760,85 800,160" />
          <polygon points="1020,160 1060,95 1100,160" />
        </g>
      </svg>
    </div>
  </div>

  <!-- canvas for snow -->
  <canvas id="snowCanvas"></canvas>

  <!-- festive lights -->
  <div class="lights" aria-hidden="true">
    <div class="light-bulb red"></div>
    <div class="light-bulb gold"></div>
    <div class="light-bulb green"></div>
    <div class="light-bulb red"></div>
    <div class="light-bulb gold"></div>
    <div class="light-bulb green"></div>
  </div>

  <!-- back button -->
  <button class="back" onclick="goToMainPage()">‚Üê Volver</button>

  <main class="page" id="page">
    <h1>Encuestas en Vivo ‚Äî Navidad</h1>

    <!-- Create poll (admins) -->
    <section id="createPoll" class="panel" style="display:none;">
      <h2 style="margin:0 0 12px;color:var(--accent-red)">Crear nueva encuesta</h2>

      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <input id="newQuestion" type="text" placeholder="Pregunta..." style="flex:1 1 100%;">
      </div>

      <div id="optionsContainer" style="margin-top:12px;">
        <input class="option-input" type="text" placeholder="Opci√≥n 1">
        <input class="option-input" type="text" placeholder="Opci√≥n 2" style="margin-top:8px">
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;align-items:center;">
          <label class="muted" style="margin-right:6px">Duraci√≥n</label>
          <input id="hours" type="number" min="0" value="0" style="width:80px">
          <span class="muted">h</span>
          <input id="minutes" type="number" min="0" max="59" value="1" style="width:80px">
          <span class="muted">m</span>
        </div>
        <button class="small" onclick="addOption()">‚ûï A√±adir opci√≥n</button>
        <button class="small" onclick="createPoll()">üéÅ Crear encuesta</button>
      </div>
    </section>

    <!-- Active poll -->
    <section id="pollPanel" class="panel" style="display:none; margin-top:18px;">
      <h2 id="question" style="margin:0 0 8px;color:var(--accent-green)"></h2>
      <div id="pollOptions" style="margin-top:8px"></div>
      <div id="timer" class="muted">Tiempo restante: --</div>
      <div id="results" style="display:none;"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
        <button id="deleteButton" class="ghost" style="display:none" onclick="deletePoll()">Eliminar encuesta</button>
      </div>
    </section>

  </main>

  <!-- music control -->
  <div class="music-control" aria-hidden="false">
    <div class="label">M√∫sica</div>
    <button id="musicToggle" title="Pausar / Reproducir">‚è∏Ô∏è</button>
  </div>

<script>
/* ------------------------ Supabase (igual que antes) ------------------------ */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------------ Estado ------------------------ */
let currentPoll = null;
let pollInterval = null;
let pollEnded = false;

const user = JSON.parse(localStorage.getItem("currentUser") || "null");

/* ------------------------ Actividades ------------------------ */
async function registrarActividad(usuario, accion, detalle = "") {
  try {
    const { error } = await db.from("actividad").insert([{ usuario, accion, detalle }]);
    if (error) console.error("Error registrando actividad:", error.message);
  } catch (err) {
    console.error("Error inesperado al registrar actividad:", err);
  }
}

/* ------------------------ DOMContentLoaded inicial ------------------------ */
document.addEventListener("DOMContentLoaded", async () => {
  // mostrar panel de creaci√≥n para admins listados (mismos nombres que tu lista original)
  const admins = ["Peketruli","SabinoArana","Jesus de Nazaret","General Suker","(JUSTICIA POR PEKEPO11AENORME)_69"];
  if (user && admins.includes(user.username)) {
    document.getElementById("createPoll").style.display = "block";
    document.getElementById("deleteButton").style.display = "inline-block";
  }

  // cargar encuesta activa
  await loadActivePoll();
  if (user && currentPoll) await registrarActividad(user.username, "visualiz√≥ la encuesta", currentPoll.question);

  // iniciar nieve animada canvas
  startSnow();

  // reproducir m√∫sica autom√°ticamente (si el navegador lo permite)
  try { await bgMusic.play().catch(()=>{}); } catch(e){ /* autoplay blocked */ }

});

/* ------------------------ Crear encuesta ------------------------ */
function addOption(){
  const container = document.getElementById("optionsContainer");
  const input = document.createElement("input");
  input.type = "text";
  input.className = "option-input";
  input.placeholder = `Opci√≥n ${container.querySelectorAll('.option-input').length + 1}`;
  input.style.marginTop = "8px";
  container.appendChild(input);
}

async function createPoll(){
  if(!user){ alert("Debes iniciar sesi√≥n para crear encuestas."); return; }
  const question = document.getElementById("newQuestion").value.trim();
  const options = Array.from(document.querySelectorAll(".option-input")).map(i=>i.value.trim()).filter(Boolean);
  const hours = parseInt(document.getElementById("hours").value) || 0;
  const minutes = parseInt(document.getElementById("minutes").value) || 0;
  const duration = (hours*3600) + (minutes*60);
  if(!question || options.length < 2 || duration <= 0){ alert("Completa pregunta, al menos 2 opciones y duraci√≥n>0."); return; }

  const payload = {
    question,
    options: options.map(o=>({ text: o })),
    votes: new Array(options.length).fill(0),
    duration,
    creator: user.username,
    start_time: new Date()
  };

  const { data, error } = await db.from("polls").insert([payload]).select().single();
  if(error){ alert("Error al crear encuesta: "+error.message); return; }

  await registrarActividad(user.username, "cre√≥ una encuesta", question);
  alert("‚úÖ Encuesta creada");
  loadPoll(data.id);
}

/* ------------------------ Votar ------------------------ */
async function vote(optionIndex){
  if(!currentPoll) return;
  if(pollEnded){ alert("La encuesta ha terminado."); return; }
  if(localStorage.getItem("votedPollId") === String(currentPoll.id)){ alert("Ya has votado en esta encuesta."); return; }

  localStorage.setItem("votedPollId", String(currentPoll.id));
  currentPoll.votes[optionIndex] = (currentPoll.votes[optionIndex]||0) + 1;

  const { error } = await db.from("polls").update({ votes: currentPoll.votes }).eq("id", currentPoll.id);
  if(error){ alert("Error registrando voto: "+error.message); return; }

  // sound + activity
  bell.currentTime = 0; bell.play().catch(()=>{});
  if(user) await registrarActividad(user.username, "vot√≥ en encuesta", `${currentPoll.options[optionIndex]?.text || optionIndex}`);

  renderPollOptions();
  showResults();
}

/* ------------------------ Cargar encuesta activa ------------------------ */
async function loadActivePoll(){
  try{
    const { data: polls } = await db.from("polls").select("*").order("created_at",{ascending:false}).limit(1);
    if(polls && polls.length>0) loadPoll(polls[0].id);
  }catch(e){ console.error("loadActivePoll", e); }
}

async function loadPoll(id){
  try{
    const { data: poll } = await db.from("polls").select("*").eq("id", id).single();
    if(!poll) return;
    // validar votes length
    if(!Array.isArray(poll.votes) || poll.votes.length !== poll.options.length){
      poll.votes = new Array(poll.options.length).fill(0);
      await db.from("polls").update({ votes: poll.votes }).eq("id", poll.id);
    }
    currentPoll = poll;
    document.getElementById("question").textContent = poll.question;
    renderPollOptions();
    document.getElementById("pollPanel").style.display = "block";
    pollEnded = false;
    if(pollInterval) clearInterval(pollInterval);
    startTimer(new Date(poll.start_time).getTime(), poll.duration);
  }catch(e){ console.error("loadPoll", e); }
}

/* ------------------------ Render opciones ------------------------ */
function renderPollOptions(){
  const container = document.getElementById("pollOptions");
  container.innerHTML = "";
  if(!currentPoll) return;

  // determine winner for highlighting when ended
  const maxVotes = currentPoll.votes?.length ? Math.max(...currentPoll.votes) : 0;
  const winnerIndex = currentPoll.votes?.length ? currentPoll.votes.indexOf(maxVotes) : -1;

  currentPoll.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.className = "poll-option";
    const votes = currentPoll.votes[i] || 0;
    btn.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><span>${escapeHtml(opt.text)}</span><strong style="color:${votes? (i===winnerIndex && pollEnded ? 'var(--accent-green)' : '#222') : '#777'}">${votes}</strong></div>`;
    btn.disabled = pollEnded;
    btn.onclick = ()=> vote(i);
    if(pollEnded && i===winnerIndex){
      btn.style.border = `2px solid var(--accent-green)`;
      btn.style.boxShadow = `0 8px 24px rgba(39,174,96,0.12)`;
    }
    container.appendChild(btn);
  });
}

/* ------------------------ Timer + results ------------------------ */
function startTimer(startTime, duration){
  let timeLeft = duration - Math.floor((Date.now() - startTime)/1000);
  const timerEl = document.getElementById("timer");
  if(pollInterval) clearInterval(pollInterval);
  timerEl.textContent = `Tiempo restante: ${timeLeft}s`;
  pollInterval = setInterval(()=>{
    timeLeft--;
    if(timeLeft < 0) timeLeft = 0;
    timerEl.textContent = `Tiempo restante: ${timeLeft}s`;
    if(timeLeft <= 0){
      clearInterval(pollInterval);
      pollEnded = true;
      renderPollOptions();
      showResults();
    }
  },1000);
}

function showResults(){
  const el = document.getElementById("results");
  if(!currentPoll) return;
  const counts = currentPoll.votes || [];
  const total = counts.reduce((a,b)=>a+b,0);
  if(total === 0){ el.innerHTML = "No hubo votos üéÑ"; }
  else{
    el.innerHTML = `<div style="margin-bottom:6px;font-weight:700;color:var(--accent-gold)">Resultados</div>`;
    counts.forEach((c,i)=>{
      el.innerHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-top:1px solid rgba(0,0,0,0.04)"><span>${escapeHtml(currentPoll.options[i].text)}</span><strong>${c} votos</strong></div>`;
    });
  }
  el.style.display = "block";
}

/* ------------------------ Delete ------------------------ */
async function deletePoll(){
  if(!currentPoll) return;
  if(!confirm("¬øEliminar esta encuesta?")) return;
  await db.from("polls").delete().eq("id", currentPoll.id);
  if(user) await registrarActividad(user.username, "elimin√≥ la encuesta", currentPoll.question);
  alert("Encuesta eliminada");
  location.reload();
}

/* ------------------------ Utilidades ------------------------ */
function escapeHtml(str){
  if(!str) return "";
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function goToMainPage(){ window.location.href = 'h.html'; }

/* ------------------------ Audio (music + bell) ------------------------ */
/* Bell sound when voting */
const bell = new Audio("https://cdn.pixabay.com/download/audio/2022/02/23/audio_3b8f4e21c4.mp3?filename=christmas-bells-117356.mp3");
bell.preload = "auto";

/* Background music (instrumental). Volume gentle. Source: royalty-free sample. */
const bgMusic = new Audio("https://cdn.pixabay.com/download/audio/2023/11/30/audio_dbb0c5d9f1.mp3?filename=jingle-bells-instrumental-149344.mp3");
bgMusic.loop = true;
bgMusic.volume = 0.35;
bgMusic.preload = "auto";

/* Music toggle button */
document.getElementById("musicToggle").addEventListener("click", async function(){
  if(bgMusic.paused){
    await bgMusic.play().catch(()=>{});
    this.textContent = "‚è∏Ô∏è";
  } else {
    bgMusic.pause();
    this.textContent = "‚ñ∂Ô∏è";
  }
});

/* Attempt autoplay on load (may be blocked by browser) */
window.addEventListener("load", async ()=>{
  try{ await bgMusic.play().catch(()=>{}); document.getElementById("musicToggle").textContent="‚è∏Ô∏è"; }catch(e){ document.getElementById("musicToggle").textContent="‚ñ∂Ô∏è"; }
});

/* ------------------------ Canvas snow (realistic, performant) ------------------------ */
const canvas = document.getElementById("snowCanvas");
const ctx = canvas.getContext("2d");
let W = innerWidth, H = innerHeight;
canvas.width = W; canvas.height = H;

window.addEventListener("resize", ()=>{ W = innerWidth; H = innerHeight; canvas.width = W; canvas.height = H; });

class Snowflake {
  constructor(){
    this.reset();
  }
  reset(){
    this.x = Math.random()*W;
    this.y = Math.random()*-H;
    this.vy = 0.6 + Math.random()*1.2;
    this.vx = Math.random()*0.8 - 0.4;
    this.r = 1 + Math.random()*3.5;
    this.o = 0.6 + Math.random()*0.4;
    this.t = Math.random()*Math.PI*2;
    this.spin = (Math.random()-0.5)*0.02;
  }
  update(){
    this.x += this.vx + Math.sin(this.t)*0.2;
    this.y += this.vy;
    this.t += this.spin;
    if(this.y - this.r > H) this.reset();
  }
  draw(ctx){
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${this.o})`;
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fill();
  }
}

const NUM = Math.min(220, Math.floor((innerWidth*innerHeight)/4500)); // adaptive density
const flakes = Array.from({length:NUM}, ()=> new Snowflake());

function snowLoop(){
  ctx.clearRect(0,0,W,H);
  // subtle gradient overlay to blend with sky
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, 'rgba(255,255,255,0.02)');
  g.addColorStop(1, 'rgba(255,255,255,0.08)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  for(const f of flakes){ f.update(); f.draw(ctx); }
  requestAnimationFrame(snowLoop);
}
function startSnow(){ requestAnimationFrame(snowLoop); }

/* Small floating sparkles for depth */
(function createSparkles(){
  for(let i=0;i<18;i++){
    const s = document.createElement('div');
    s.style.position='fixed';
    s.style.width='6px'; s.style.height='6px';
    s.style.borderRadius='50%';
    s.style.background = 'rgba(212,175,55,0.95)';
    s.style.left = (8 + Math.random()*84)+'%';
    s.style.top = (12 + Math.random()*60)+'%';
    s.style.zIndex = 4;
    s.style.pointerEvents = 'none';
    s.style.opacity = (0.3 + Math.random()*0.7)+'';
    s.style.transform = 'translateY(0)';
    s.style.transition = `${1+Math.random()*2}s ease-in-out`;
    document.body.appendChild(s);
    (function anim(el){
      setInterval(()=>{ el.style.transform = `translateY(${(Math.random()*12-6)}px) scale(${0.9+Math.random()*0.3})`; el.style.opacity = (0.3+Math.random()*0.7); }, 1200 + Math.random()*1600);
    })(s);
  }
})();

</script>
</body>
</html>
