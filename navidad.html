<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Blog - Rebeld√≠a IN.AR</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
/* üéÑ DECORACI√ìN NAVIDE√ëA COMPLETA üéÑ */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at 50% 0%, rgba(255, 0, 0, 0.2), transparent 70%),
              radial-gradient(circle at 0% 100%, rgba(0, 255, 0, 0.15), transparent 70%);
  z-index: -2;
  pointer-events: none;
}

/* ‚ùÑÔ∏è Copos de nieve */
.snowflake {
  position: fixed;
  top: -10px;
  color: white;
  font-size: 1.2em;
  user-select: none;
  z-index: 9999;
  animation: fall linear infinite;
}
@keyframes fall {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0.8; }
}

/* üéÅ Luces navide√±as */
.christmas-lights {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 40px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
  background: transparent;
  pointer-events: none;
}
.bulb {
  width: 16px;
  height: 24px;
  border-radius: 50%;
  box-shadow: 0 0 8px currentColor;
  animation: blink 1.2s infinite alternate;
}
@keyframes blink {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.1); }
}
.bulb:nth-child(1){color:red;}
.bulb:nth-child(2){color:gold;}
.bulb:nth-child(3){color:lime;}
.bulb:nth-child(4){color:deepskyblue;}
.bulb:nth-child(5){color:magenta;}
.bulb:nth-child(6){color:orange;}
.bulb:nth-child(7){color:cyan;}
.bulb:nth-child(8){color:greenyellow;}

/* üéÖ Santa flotando */
#santa {
  position: fixed;
  bottom: 120px;
  left: -200px;
  width: 180px;
  height: auto;
  z-index: 50;
  animation: santaFly 18s linear infinite;
}
@keyframes santaFly {
  0% { transform: translateX(-200px) scale(1); opacity: 0; }
  10% { opacity: 1; }
  50% { transform: translateX(100vw) scale(1); opacity: 1; }
  90% { opacity: 0.8; }
  100% { transform: translateX(120vw) scale(1); opacity: 0; }
}

/* üîî Efecto de parpadeo en botones */
button, .like-button {
  position: relative;
  z-index: 1;
}
button::after, .like-button::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: radial-gradient(circle, rgba(255,255,255,0.2), transparent 70%);
  animation: twinkle 2s infinite alternate;
  pointer-events: none;
}
@keyframes twinkle {
  from { opacity: 0.2; }
  to { opacity: 0.7; }
}
</style>
</head>
<body>
<button class="home-btn" onclick="window.location.href='h.html'">Volver a la P√°gina Principal</button>

<div class="auth-container" id="authContainer">
  <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesi√≥n o registrarse</button>
</div>
<div class="user-info" id="userInfo">
  <h3 id="userName"></h3>
  <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
</div>
<div class="dropdown-menu" id="dropdownMenu">
  <table><tr><td onclick="logout()">Cerrar sesi√≥n</td></tr></table>
</div>

<div class="blog-container">
  <h1>Blog</h1>
  <button class="btn" onclick="showNewBlogForm()">Publicar nuevo blog</button>

  <div id="newBlogForm" class="new-blog hidden">
    <h2>Nuevo Blog</h2>
    <input type="text" id="newTitle" placeholder="T√≠tulo">
    <textarea id="newContent" rows="5" placeholder="Escribe tu blog aqu√≠..."></textarea>
    <input type="file" id="newMedia" accept="image/*,video/*,image/gif">
    <button class="btn" onclick="publishBlog()">Publicar</button>
    <button class="btn" onclick="hideNewBlogForm()">Cancelar</button>
  </div>

  <div id="blogsList"></div>

  <div id="blogDetails" class="blog-details hidden">
    <h2 id="blogTitleDetail"></h2>
    <div id="blogMediaDetail"></div>
    <p id="blogContentDetail"></p>
    <h3>Comentarios</h3>
    <div id="commentsList"></div>
    <div id="newCommentForm">
      <textarea id="newCommentText" rows="3" placeholder="Escribe tu comentario..."></textarea>
      <button class="btn" onclick="publishComment()">Publicar comentario</button>
    </div>
    <button class="btn" onclick="closeBlog()">Volver</button>
  </div>
</div>
  <!-- üéÑ DECORACI√ìN NAVIDE√ëA -->
<div class="christmas-lights">
  <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
  <div class="bulb"></div><div class="bulb"></div><div class="bulb"></div>
  <div class="bulb"></div><div class="bulb"></div>
</div>

<img id="santa" src="https://i.imgur.com/8V7j0Va.png" alt="Santa Claus volando">
<script>
  /* ‚ùÑÔ∏è Generador de copos de nieve */
function createSnowflake() {
  const snowflake = document.createElement("div");
  snowflake.classList.add("snowflake");
  snowflake.textContent = "‚ùÑ";
  snowflake.style.left = Math.random() * 100 + "vw";
  snowflake.style.animationDuration = (3 + Math.random() * 5) + "s";
  snowflake.style.fontSize = (0.8 + Math.random() * 1.2) + "em";
  document.body.appendChild(snowflake);
  setTimeout(() => snowflake.remove(), 8000);
}
setInterval(createSnowflake, 200);

/* üîî Sonido navide√±o en "like" (puedes quitarlo si quieres) */
const bell = new Audio("https://cdn.pixabay.com/download/audio/2022/02/23/audio_3b8f4e21c4.mp3?filename=christmas-bells-117356.mp3");
document.addEventListener("click", e => {
  if (e.target && e.target.classList.contains("like-button")) {
    bell.currentTime = 0;
    bell.play();
  }
});
// -------------------- Supabase --------------------
const { createClient } = supabase;
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

// -------------------- Usuario --------------------
function getCurrentUser() { return JSON.parse(localStorage.getItem("currentUser")) || null; }
function isUserLoggedIn() { return !!getCurrentUser(); }

function loadUserInfo() {
  const user = getCurrentUser();
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");
  if(user) {
    userInfo.style.display = "flex";
    authContainer.style.display = "none";
    document.getElementById("userName").textContent = user.username || "Usuario";
    document.getElementById("userLogo").src = user.logo || "logoDefault.png";
    registrarActividad("ha iniciado sesi√≥n");
  } else {
    userInfo.style.display = "none";
    authContainer.style.display = "flex";
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  loadUserInfo();
  loadBlogs();
});

// Logout
function logout() {
  registrarActividad("ha cerrado sesi√≥n");
  localStorage.removeItem("currentUser");
  window.location.href="login.html";
}

const userInfoDiv = document.getElementById("userInfo");
const dropdownMenu = document.getElementById("dropdownMenu");
userInfoDiv.addEventListener("click", ()=>{ 
  dropdownMenu.style.display = dropdownMenu.style.display==="block"?"none":"block"; 
});
document.addEventListener("click",(e)=>{
  if(!userInfoDiv.contains(e.target)&&!dropdownMenu.contains(e.target)) dropdownMenu.style.display="none"; 
});

// -------------------- Registrar actividad --------------------
async function registrarActividad(accion) {
  const user = getCurrentUser();
  const usuario = user?.username || "Desconocido";

  try {
    await db.from("actividad").insert([{
      usuario,
      accion,
      fecha: new Date().toISOString()
    }]);
  } catch(err) {
    console.error("Error registrando actividad:", err.message);
  }
}

// -------------------- Blogs --------------------
function showNewBlogForm(){ 
  if(!isUserLoggedIn()){ alert("Debes iniciar sesi√≥n para publicar un blog"); return; } 
  document.getElementById("newBlogForm").classList.remove("hidden"); 
}
function hideNewBlogForm(){ document.getElementById("newBlogForm").classList.add("hidden"); }

async function loadBlogs(){
  const blogsList=document.getElementById("blogsList");
  blogsList.innerHTML="Cargando blogs...";
  const { data, error } = await db.from("blog").select("*").order("created_at",{ascending:false});
  if(error){ console.error(error); blogsList.innerHTML=`<p>Error al cargar blogs: ${error.message}</p>`; return; }
  if(!data || data.length===0){ blogsList.innerHTML="<p>No hay blogs publicados.</p>"; return; }
  blogsList.innerHTML="";
  const user=getCurrentUser();
  data.forEach(blog=>{
    const div=document.createElement("div");
    div.className="blog-post";
    div.innerHTML=`
      <h3>${blog.title}</h3>
      <p style="font-size:0.9em;color:gray;">Autor: ${blog.author||"An√≥nimo"}</p>
      ${blog.media_url?`<img src="${blog.media_url}" class="blog-media">`:''}
      <p>‚ù§Ô∏è <span id="likeCount-${blog.id}">${blog.likes||0}</span>
      <button class="like-btn" id="likeBtn-${blog.id}">‚ù§Ô∏è</button></p>
    `;
    div.addEventListener("click",(e)=>{ if(!e.target.classList.contains("like-btn")) openBlog(blog); });
    const likeBtn = div.querySelector(`#likeBtn-${blog.id}`);
    likeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); toggleLike(blog.id); });
    if(user && localStorage.getItem(`like_${blog.id}_${user.id}`)) likeBtn.classList.add("liked");
    blogsList.appendChild(div);
  });
}

// -------------------- Likes --------------------
async function toggleLike(blogId){
  const user=getCurrentUser(); if(!user){ alert("Inicia sesi√≥n para dar like"); return; }
  const likeKey=`like_${blogId}_${user.id}`;
  const likeEl=document.getElementById(`likeCount-${blogId}`);
  const btn=document.getElementById(`likeBtn-${blogId}`);
  const alreadyLiked=localStorage.getItem(likeKey);
  const currentLikes=parseInt(likeEl.textContent)||0;
  const newLikes=alreadyLiked?currentLikes-1:currentLikes+1;
  likeEl.textContent=newLikes;
  btn.classList.toggle("liked");
  if(alreadyLiked) localStorage.removeItem(likeKey); else localStorage.setItem(likeKey,"true");
  await db.from("blog").update({likes:newLikes}).eq("id",blogId);

  const blogTitle = (await db.from("blog").select("title").eq("id",blogId).single()).data?.title || "Desconocido";
  registrarActividad(`${alreadyLiked ? "ha quitado like" : "ha dado like"} al blog "${blogTitle}"`);
}

// -------------------- Publicar blog --------------------
async function publishBlog(){
  const user=getCurrentUser(); if(!user){ alert("Debes iniciar sesi√≥n"); return; }
  const title=document.getElementById("newTitle").value.trim();
  const content=document.getElementById("newContent").value.trim();
  const mediaInput=document.getElementById("newMedia");
  let mediaUrl="";
  if(!title||!content){ alert("Completa todos los campos"); return; }
  if(mediaInput.files.length>0){
    const file=mediaInput.files[0];
    const fileName=`${user.id}_${Date.now()}_${file.name}`;
    const { error: uploadError } = await db.storage.from("blog-media").upload(fileName, file, { upsert:true });
    if(uploadError){ console.error(uploadError); alert("Error al subir archivo"); return; }
    const { data: publicData } = db.storage.from("blog-media").getPublicUrl(fileName);
    mediaUrl=publicData.publicUrl;
  }
  const { error } = await db.from("blog").insert([{ title, content, author:user.username, media_url:mediaUrl, likes:0, comments:[] }]);
  if(error){ console.error(error); alert("Error al publicar"); return; }

  registrarActividad(`ha publicado un blog: "${title}"`);

  hideNewBlogForm();
  document.getElementById("newTitle").value="";
  document.getElementById("newContent").value="";
  document.getElementById("newMedia").value="";
  loadBlogs();
}

// -------------------- Abrir blog --------------------
function openBlog(blog){
  document.getElementById("blogTitleDetail").textContent=blog.title;
  document.getElementById("blogContentDetail").textContent=blog.content;
  const mediaDiv=document.getElementById("blogMediaDetail"); mediaDiv.innerHTML="";
  if(blog.media_url){
    if(blog.media_url.endsWith(".mp4")) mediaDiv.innerHTML=`<video src="${blog.media_url}" controls class="blog-media"></video>`;
    else mediaDiv.innerHTML=`<img src="${blog.media_url}" class="blog-media">`;
  }
  const commentsList=document.getElementById("commentsList"); commentsList.innerHTML="";
  if(blog.comments && blog.comments.length>0){
    blog.comments.forEach(c=>{ commentsList.innerHTML+=`<div><strong>${c.author}</strong>: ${c.comment}</div>`; });
  } else commentsList.innerHTML="<p>No hay comentarios todav√≠a.</p>";
  document.getElementById("blogsList").classList.add("hidden");
  document.getElementById("blogDetails").classList.remove("hidden");
  window.currentBlogId=blog.id;
}

// -------------------- Comentar --------------------
async function publishComment(){
  const user=getCurrentUser(); if(!user){ alert("Debes iniciar sesi√≥n"); return; }
  const commentText=document.getElementById("newCommentText").value.trim(); if(!commentText){ alert("Escribe un comentario"); return; }
  const { data: blogData, error } = await db.from("blog").select("*").eq("id",window.currentBlogId).single();
  if(error){ console.error(error); alert("Error al obtener comentarios"); return; }
  const newComments = blogData.comments || [];
  newComments.push({ author:user.username, comment:commentText });
  const { error: updateError } = await db.from("blog").update({comments:newComments}).eq("id",window.currentBlogId);
  if(updateError){ console.error(updateError); alert("Error al publicar comentario"); return; }

  registrarActividad(`ha comentado en el blog "${blogData.title}"`);

  document.getElementById("newCommentText").value="";
  openBlog({...blogData, comments:newComments});
}

// -------------------- Cerrar blog --------------------
function closeBlog(){
  document.getElementById("blogDetails").classList.add("hidden");
  document.getElementById("blogsList").classList.remove("hidden");
}
</script>
</body>
</html>
