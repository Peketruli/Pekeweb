<!DOCTYPE html>
<html lang="es">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1" />  
<title>Casino - Recompensas</title>  
<script src="https://unpkg.com/@supabase/supabase-js"></script>  
<style>
:root{
  --bg-deep: #07020a;
  --bg-mid: #17061b;
  --accent-orange: #ff7a1a;
  --accent-deep: #d94f00;
  --muted: #cfc6c2;
  --glass: rgba(255,255,255,0.04);
  --glass-strong: rgba(0,0,0,0.5);
  --led-on: #ff9b3b;
  --led-off: rgba(255,155,59,0.08);
  --card-radius: 14px;
  --ui-z: 999;
}

/* Reset ligero */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-mid) 65%, #030006 100%);
  color: var(--muted);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
  position:relative;
  padding:40px;
}

/* ---------- ESCENA DE FONDO (solo CSS, no imágenes obligatorias) ---------- */
.scene {
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}

/* luna */
.scene .moon{
  position:absolute;
  top:48px;
  right:96px;
  width:160px;
  height:160px;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fffde7 0%, #fff2b8 20%, #f1d78f 40%, rgba(240,200,140,0.15) 60%, transparent 70%);
  box-shadow:0 0 80px 24px rgba(255,220,140,0.06), 0 8px 30px rgba(0,0,0,0.6) inset;
  transform:translateZ(0);
  filter:drop-shadow(0 12px 40px rgba(0,0,0,0.6));
  opacity:0.95;
}

/* montes al fondo */
.scene .hills{
  position:absolute;
  left:-10%;
  bottom:-6%;
  width:120%;
  height:260px;
  z-index:0;
  background: linear-gradient(180deg,#040009, #12001a 60%, #0b0410 100%);
  clip-path: polygon(0 100%,10% 65%,18% 78%,30% 60%,42% 80%,55% 55%,68% 73%,82% 58%,92% 76%,100% 45%,100% 100%);
  opacity:0.95;
  transform:translateZ(0);
}

/* niebla sutil en varias capas */
.scene .fog{ position:absolute; left:-15%; width:130%; height:30vh; bottom:6%; z-index:1; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)); filter:blur(22px); opacity:0.35; animation: fogMove 30s linear infinite; }
.scene .fog.layer2{ bottom:0; opacity:0.22; filter:blur(36px); animation-duration:42s; }
@keyframes fogMove { 0%{transform:translateX(0)} 50%{transform:translateX(-8%)} 100%{transform:translateX(0)} }

/* murciélagos con imágenes locales si las añades (fallback a pseudo-shape) */
.scene .bat{
  position:absolute;
  width:110px;height:auto;
  z-index:2;
  opacity:0.95;
  filter:drop-shadow(0 8px 18px rgba(0,0,0,0.6));
  pointer-events:none;
}
.scene .bat.b1{ top:12%; left:-18%; animation:batFlyA 12s linear infinite; transform-origin:center; }
.scene .bat.b2{ top:30%; left:-30%; animation:batFlyB 16s linear infinite; transform-origin:center; }
.scene .bat.b3{ top:44%; left:-10%; animation:batFlyC 10s linear infinite; transform-origin:center; }
@keyframes batFlyA {0%{transform:translateX(0) translateY(0) rotate(0)}25%{transform:translateX(240px) translateY(-12px) rotate(-6deg)}50%{transform:translateX(500px) translateY(8px) rotate(10deg)}75%{transform:translateX(780px) translateY(-6px) rotate(-4deg)}100%{transform:translateX(1100px) translateY(0) rotate(0);opacity:0}}
@keyframes batFlyB {0%{transform:translateX(0) translateY(0) rotate(0)}20%{transform:translateX(160px) translateY(6px) rotate(6deg)}45%{transform:translateX(420px) translateY(-20px) rotate(-12deg)}70%{transform:translateX(760px) translateY(10px) rotate(8deg)}100%{transform:translateX(1100px) translateY(0) rotate(0);opacity:0}}
@keyframes batFlyC {0%{transform:translateX(0) translateY(0) rotate(0)}30%{transform:translateX(280px) translateY(-24px) rotate(-14deg)}60%{transform:translateX(560px) translateY(16px) rotate(12deg)}100%{transform:translateX(1100px) translateY(0) rotate(0);opacity:0}}

/* ---------- LUZ LED EN EL BORDE (animada, sutil) ---------- */
.led-frame {
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:5;
}
.led-frame::before,
.led-frame::after{
  content:"";
  position: absolute;
  inset: 8px;
  border-radius: 16px;
  padding: 6px;
  background: linear-gradient(90deg, rgba(255,155,59,0.06), rgba(0,0,0,0)) ;
  box-shadow: 0 0 40px rgba(255,155,59,0.04) inset;
  -webkit-mask: linear-gradient(#000 0 0);
}
.led-dots {
  position:absolute; inset:6px; border-radius:14px; pointer-events:none;
  background-image: radial-gradient(var(--led-on) 8%, var(--led-off) 9%);
  background-size:20px 20px;
  opacity:0.9;
  mix-blend-mode: screen;
  filter: blur(1px);
  animation: ledPulse 3.6s linear infinite;
}
@keyframes ledPulse{
  0%{opacity:0.55; transform:translateY(0)}
  50%{opacity:1; transform:translateY(-1px)}
  100%{opacity:0.55; transform:translateY(0)}
}

/* ---------- UI (delante de todo) ---------- */
.ui {
  position:relative;
  z-index: 10; /* siempre arriba del fondo */
  max-width:1100px;
  margin: 0 auto;
  display:flex;
  gap:20px;
  align-items:flex-start;
  justify-content:center;
  padding-top:16px;
}

/* Contenedor central tipo tarjeta (casino) */
.casino-card{
  flex: 1 1 780px;
  max-width:980px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.28));
  border-radius: var(--card-radius);
  padding: 26px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.6), 0 6px 18px rgba(0,0,0,0.5) inset;
  border: 1px solid rgba(255,255,255,0.03);
  text-align:center;
  backdrop-filter: blur(6px) saturate(120%);
}

/* Cabecera */
.casino-card h1{
  font-family: "Creepster", cursive;
  color: var(--accent-orange);
  font-size: 36px;
  margin-bottom:6px;
  text-shadow: 0 8px 36px rgba(255,120,40,0.08), 0 0 18px rgba(255,120,40,0.06);
}
.casino-card p.lead{
  color: #e6dbd0;
  margin-bottom:18px;
  font-size:15px;
}

/* Top5 lateral (centrado en diseños pequeños aparece debajo) */
.sidebar {
  width: 300px;
  max-width: 320px;
  display:flex;
  flex-direction:column;
  gap:18px;
  align-items:center;
}
.top5-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.5));
  border-radius:12px;
  padding:14px;
  width:100%;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,120,30,0.08);
  text-align:left;
}
.top5-card h2{
  font-family: "Creepster", cursive;
  color: var(--accent-orange);
  margin-bottom:10px;
  text-align:center;
}

/* Lista top items */
.top5-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
.top5-item{
  display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,120,30,0.03));
  border:1px solid rgba(255,255,255,0.03);
}
.top5-item img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,120,30,0.08)}

/* Botones principales: modernos y very «guapos» */
.btn-row{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;margin:20px 0 10px}
.btn-ghost{
  background:transparent;
  border:2px solid rgba(255,255,255,0.06);
  color:var(--muted);
  padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;transition:all .22s ease;
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
}
.btn-primary{
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-deep));
  color: #fff;
  padding:14px 22px;
  border-radius:12px;
  font-weight:800;
  border:none;
  cursor:pointer;
  transform:translateZ(0);
  box-shadow: 0 8px 36px rgba(217,79,0,0.18), 0 2px 8px rgba(0,0,0,0.6) inset;
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
.btn-primary:hover{
  transform: translateY(-5px) scale(1.03);
  box-shadow: 0 18px 56px rgba(217,79,0,0.28);
  filter:brightness(1.05);
}
.btn-ghost:hover{
  transform:translateY(-4px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.45);
}

/* indicador de Pekepuntos y acciones menores */
.puntos {
  margin-top:10px;
  font-weight:700;
  color:#ffd9b8;
  display:inline-flex;
  gap:10px;
  align-items:center;
}

/* tabla lista de recompensas / top */
.table-wrap{margin-top:10px;overflow:hidden;border-radius:10px}
.site-table{width:100%;border-collapse:collapse;background:transparent;color:var(--muted)}
.site-table th,.site-table td{padding:12px 10px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}

/* modal / floating form (centrado) */
.modal {
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1200;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.6));
  padding:18px;border-radius:12px;min-width:300px;max-width:90%;
  box-shadow:0 20px 80px rgba(0,0,0,0.7);
  display:none;
}

/* small responsive tweaks */
@media (max-width:1000px){
  .ui{flex-direction:column;gap:18px;padding-bottom:60px}
  .sidebar{order:2;width:100%;max-width:720px}
  .casino-card{order:1;width:100%;max-width:980px}
  .scene .moon{right:24px; top:40px; width:120px;height:120px}
}
@media (max-width:560px){
  body{padding:18px}
  .btn-row{gap:10px}
  .btn-primary{padding:12px 16px}
  .top5-card{padding:12px}
}

/* utility */
.hidden{display:none}
.center{text-align:center}
.kicker{color:#ffb78a;font-weight:700;font-size:0.95rem}
</style>
</head>  

<body> 
  <div class="led-border"></div>
<button class="auth-button" onclick="window.location.href='h.html'">Volver a la Página Principal</button>  
<h1>🎰 Casino - Recompensas</h1>  

<div class="auth-container" id="authContainer">  
  <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesión / Registrarse</button>  
</div>  

<div class="user-info" id="userInfo">  
  <span id="userName">Usuario</span>  
  <img id="userLogo" src="logoDefault.png" alt="logo"/>  
</div>  

<div class="dropdown-menu" id="dropdownMenu">  
  <div onclick="logout()">🚪 Cerrar sesión</div>  
</div>  

<div id="pekepuntos" style="margin-top:20px; font-size:1.2rem;">Pekepuntos: 0</div>  

<div class="section" id="top5Section">  
  <h2>🏆 Top 5 Jugadores</h2>  
  <ul id="top5List" class="top5-list"></ul>  
</div>  

<div class="section" id="gamesSection">  
  <h2>🎮 Juegos Disponibles</h2>  
  <button class="game-button" onclick="window.location.href='bl.html'">Blackjack</button>  
  <button class="game-button" onclick="window.location.href='r.html'">Ruleta</button>  
  <button class="game-button" onclick="window.location.href='p.html'">Poker</button>  
</div>  

<div class="section" id="rewardsSection">  
  <h2>🎁 Recompensas (Personalizaciones)</h2>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardBgBtn">Recompensa 1: Cambiar Fondo</button>  
    <input type="color" id="backgroundPicker" style="display:none; margin-left:8px;" />  
  </div>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardNameBtn">Recompensa 2: Cambiar Color del Nombre</button>  
    <input type="color" id="nameColorPicker" style="display:none; margin-left:8px;" />  
  </div>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="reward3Btn">Recompensa 3: Cambiar color de tablas</button>  
    <input type="color" id="tableColorPicker" style="display:none;" onchange="setTableColor(this.value)">  
  </div>    
  <div id="exclusiveTop5" style="display:none; margin-top:10px;">🎖 Estás en Top 5 → tu foto aparece en la lista.</div>  
  <div id="exclusiveTop3" style="display:none; margin-top:6px;">🥉 Top 3 → nombre en <span style="color:#b87333">cobre</span>.</div>  
  <div id="exclusiveTop2" style="display:none; margin-top:6px;">🥈 Top 2 → nombre en <span style="color:silver">plata</span>.</div>  
  <div id="exclusiveTop1" style="display:none; margin-top:6px;">👑 Top 1 → nombre en <span style="color:gold">oro</span>.</div>  
</div>  

<script>  
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";  
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";  
const { createClient } = window.supabase;  
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);  

let currentUser = null;  

document.addEventListener("DOMContentLoaded", async () => {  
  document.getElementById("reward3Btn").addEventListener("click", () => toggleShow("tableColorPicker"));  
  document.getElementById("rewardBgBtn").addEventListener("click", () => toggleShow("backgroundPicker"));  
  document.getElementById("rewardNameBtn").addEventListener("click", () => toggleShow("nameColorPicker"));  

  document.getElementById("backgroundPicker").addEventListener("input", (e) => setBackgroundColor(e.target.value));  
  document.getElementById("nameColorPicker").addEventListener("input", (e) => setNameColor(e.target.value));  
  document.getElementById("tableColorPicker").addEventListener("input", (e) => setTableColor(e.target.value));  

  document.getElementById("userInfo").addEventListener("click", toggleDropdown);  
  document.addEventListener("click", (e) => {  
    const ui = document.getElementById("userInfo"), dd = document.getElementById("dropdownMenu");  
    if (!ui.contains(e.target) && !dd.contains(e.target)) dd.style.display = "none";  
  });  

  await initUser();  
  await loadTop5();  
});  

async function initUser() {
  try {
    // 1️⃣ Intentar cargar desde localStorage
    const saved = localStorage.getItem("currentUser");
    if (saved) {
      currentUser = JSON.parse(saved);
      renderUserUI();
      return;
    }

    // 2️⃣ Obtener usuario de Supabase Auth
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      console.log("No hay usuario logueado");
      document.getElementById("authContainer").style.display = "flex"; // Aseguramos que se vea el botón
      document.getElementById("userInfo").style.display = "none";
      return;
    }

    // 3️⃣ Buscar el usuario en la tabla "usuarios"
    const { data, error } = await supabase
      .from("usuarios")
      .select("*")
      .eq("auth_id", user.id)
      .maybeSingle();

    if (error) {
      console.error("Error cargando usuario de la DB:", error);
      return;
    }

    if (!data) {
      console.log("Usuario no encontrado en la tabla usuarios");
      return;
    }

    currentUser = data;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));

    // 4️⃣ Actualizar UI
    renderUserUI();

  } catch (err) {
    console.error("initUser exception:", err);
  }
}

function renderUserUI() {
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");

  if (currentUser) {
    authContainer.style.display = "none";
    userInfo.style.display = "flex";

    document.getElementById("userName").textContent = currentUser.username || "Usuario";
    document.getElementById("userLogo").src = currentUser.logo || "logoDefault.png";
    const puntos = Number(currentUser.pekepuntos || 0);
    document.getElementById("pekepuntos").textContent = `Pekepuntos: ${puntos.toLocaleString()}`;

    if (currentUser.fondo_color) document.body.style.backgroundColor = currentUser.fondo_color;
    if (currentUser.nombre_color) document.getElementById("userName").style.color = currentUser.nombre_color;
    if (currentUser.tabla_color) {
      applyTableColor(currentUser.tabla_color);
      document.getElementById("tableColorPicker").value = currentUser.tabla_color;
    }
  } else {
    authContainer.style.display = "flex";
    userInfo.style.display = "none";
    document.getElementById("pekepuntos").textContent = "Pekepuntos: 0";
  }
}

async function loadTop5(){
  const top5List = document.getElementById("top5List");
  top5List.innerHTML = '<li style="color:#aaa;">Cargando top 5...</li>';

  try {
    const { data, error } = await supabase
      .from("usuarios")
      .select("id, username, pekepuntos, logo, nombre_color")
      .order("pekepuntos", { ascending: false })
      .limit(5);

    if (error) {
      top5List.innerHTML = `<li style="color:red;">❌ Error al cargar el Top 5:<br>${error.message}</li>`;
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      top5List.innerHTML = '<li style="color:#ccc;">(No hay jugadores aún en la base de datos)</li>';
      return;
    }

    const fixedData = data.map(u => ({
      ...u,
      pekepuntos: u.pekepuntos !== null && u.pekepuntos !== undefined ? parseInt(u.pekepuntos) : 0
    }));

    top5List.innerHTML = "";
    fixedData.forEach((u, idx) => {
      const li = document.createElement("li");
      li.className = "top5-item";
      const nameColor = (idx === 0) ? "gold" : (idx === 1) ? "silver" : (idx === 2) ? "#b87333" : u.nombre_color || "#fff";
      const imgHtml = u.logo ? `<img src="${u.logo}" alt="logo">` : `<div style="width:36px;height:36px;border-radius:50%;background:#666;"></div>`;
      li.innerHTML = `
        ${imgHtml}
        <div style="flex:1;text-align:left;">
          <strong style="color:${nameColor}">${idx+1}. ${u.username || 'Jugador'}</strong>
          <div style="font-size:0.9rem;color:#ddd;">${u.pekepuntos.toLocaleString()} Pekepuntos</div>
        </div>
      `;
      top5List.appendChild(li);
    });

  } catch(e){  
    console.error("loadTop5 exception:", e);  
    top5List.innerHTML = '<li style="color:red;">Error cargando Top 5 (revisa consola)</li>';  
  }  
}  

function toggleDropdown(){ 
  const dd=document.getElementById("dropdownMenu"); 
  dd.style.display = dd.style.display==="block"?"none":"block"; 
}  

function toggleShow(id){ 
  const el=document.getElementById(id); 
  el.style.display = el.style.display==="block"?"none":"block"; 
}  

function applyTableColor(color){ 
  document.querySelectorAll('.section').forEach(sec=>sec.style.backgroundColor=color); 
  document.querySelectorAll('table').forEach(tbl=>tbl.style.backgroundColor=color); 
}  

async function setBackgroundColor(color){ 
  document.body.style.backgroundColor=color; 
  if(currentUser){ 
    await supabase.from("usuarios").update({fondo_color:color}).eq("id",currentUser.id); 
    currentUser.fondo_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  

async function setNameColor(color){ 
  document.getElementById("userName").style.color=color; 
  if(currentUser){ 
    await supabase.from("usuarios").update({nombre_color:color}).eq("id",currentUser.id); 
    currentUser.nombre_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  

async function setTableColor(color){ 
  applyTableColor(color); 
  if(currentUser){ 
    await supabase.from("usuarios").update({tabla_color:color}).eq("id",currentUser.id); 
    currentUser.tabla_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  
</script> 
</body>  
</html>
