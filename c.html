<!DOCTYPE html>
<html lang="es">  
<head>  
<meta charset="utf-8" />  
<meta name="viewport" content="width=device-width, initial-scale=1" />  
<title>Casino - Recompensas</title>  
<script src="https://unpkg.com/@supabase/supabase-js"></script>  
<style>
/* Fuente terror√≠fica */
@import url('https://fonts.googleapis.com/css2?family=Creepster&display=swap');

/* Fondo general */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom, #0a0018 0%, #1a002a 100%);
  color: #fff;
  overflow-x: hidden;
  position: relative;
  min-height: 100vh;
}

/* ==== Luces LED Halloween alrededor del borde ==== */
.led-border {
  position: fixed;
  inset: 0;
  pointer-events: none;
  border: 5px solid transparent;
  box-shadow:
    0 0 15px 5px #ff6600,
    0 0 30px 10px #ff3300,
    inset 0 0 15px 5px #ff6600,
    inset 0 0 30px 10px #ff3300;
  animation: ledGlow 3s infinite alternate;
  border-radius: 10px;
  z-index: 10000;
}

@keyframes ledGlow {
  0% {
    box-shadow:
      0 0 15px 5px #ff6600,
      0 0 30px 10px #ff3300,
      inset 0 0 15px 5px #ff6600,
      inset 0 0 30px 10px #ff3300;
  }
  50% {
    box-shadow:
      0 0 25px 10px #ff9900,
      0 0 40px 15px #ff6600,
      inset 0 0 25px 10px #ff9900,
      inset 0 0 40px 15px #ff6600;
  }
  100% {
    box-shadow:
      0 0 20px 5px #ff3300,
      0 0 35px 10px #cc2200,
      inset 0 0 20px 5px #ff3300,
      inset 0 0 35px 10px #cc2200;
  }
}

/* ==== Usuario arriba a la derecha ==== */
#userDisplay {
  position: fixed;
  top: 15px;
  right: 20px;
  font-family: 'Creepster', cursive;
  font-size: 1.6em;
  color: #ffcc66;
  text-shadow: 0 0 10px #ff6600;
  z-index: 10001;
}

/* Escena de fondo */
.scene-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: 1;
}

/* Luna */
.moon {
  position: absolute;
  top: 60px;
  right: 120px;
  width: 140px;
  height: 140px;
  background: radial-gradient(circle at 30% 30%, #fff9e6, #f2e2b6, #c2b280);
  border-radius: 50%;
  box-shadow: 0 0 40px 10px #fff3b0;
  z-index: 2;
}

/* Monta√±as y cementerio al fondo */
.mountains {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 200%;
  height: 300px;
  background: linear-gradient(to top, #0a0018, #120024);
  clip-path: polygon(0 100%, 15% 60%, 30% 80%, 45% 55%, 60% 75%, 75% 50%, 100% 100%);
  animation: moveMountains 30s linear infinite alternate;
  z-index: 2;
}

@keyframes moveMountains {
  from { transform: translateX(0); }
  to { transform: translateX(-50px); }
}

/* Cementerio */
.cemetery {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 200px;
  background: repeating-linear-gradient(
    0deg,
    #0a0018 0%,
    #110022 40%,
    #220044 100%
  );
  z-index: 3;
}

.cemetery::before {
  content: '‚ö∞Ô∏è ‚ö∞Ô∏è ‚ö∞Ô∏è ‚ö∞Ô∏è ‚ö∞Ô∏è';
  position: absolute;
  bottom: 40px;
  left: 10%;
  font-size: 2em;
  opacity: 0.2;
}

/* Niebla animada */
.fog-layer {
  position: absolute;
  bottom: 0;
  width: 200%;
  height: 200px;
  background: rgba(255, 255, 255, 0.1);
  filter: blur(40px);
  animation: fogMove 40s linear infinite;
  z-index: 4;
}

@keyframes fogMove {
  from { transform: translateX(0); }
  to { transform: translateX(-50%); }
}

/* Murci√©lagos */
.bat {
  position: absolute;
  width: 40px;
  height: 20px;
  background: none;
  animation: batFly 12s linear infinite;
  z-index: 5;
}

.bat::before, .bat::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 10px;
  background: #000;
  border-radius: 50%;
  top: 5px;
}

.bat::before { left: 0; transform: rotate(-20deg); }
.bat::after { right: 0; transform: rotate(20deg); }

@keyframes batFly {
  0% { transform: translateX(-10%) translateY(0); }
  50% { transform: translateX(50vw) translateY(-60px); }
  100% { transform: translateX(110%) translateY(0); }
}

/* Contenedor principal centrado */
.blog-container {
  position: relative;
  z-index: 1000;
  width: 90%;
  max-width: 800px;
  margin: auto;
  background: rgba(0, 0, 0, 0.65);
  border: 2px solid #ff6600;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 0 25px #ff6600;
  backdrop-filter: blur(6px);
  top: 50%;
  transform: translateY(-50%);
}

/* T√≠tulos */
h1, h2, h3 {
  text-align: center;
  font-family: 'Creepster', cursive;
  color: #ff9900;
  text-shadow: 0 0 10px #ff6600;
}

/* Botones generales */
button {
  background: linear-gradient(135deg, #ff6600, #cc3300);
  color: #fff;
  border: 2px solid #ffcc00;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.25s ease;
  box-shadow: 0 0 10px #ff6600;
}

button:hover {
  box-shadow: 0 0 25px #ffa500;
  transform: scale(1.1);
}

/* --- Bot√≥n de volver - Especial Halloween üéÉ --- */
#backButton {
  position: fixed;
  top: 20px;
  left: 20px;
  background: linear-gradient(135deg, #ff6600, #cc3300);
  color: #fff8e1;
  border: 2px solid #ffcc00;
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: bold;
  font-family: 'Creepster', cursive;
  text-shadow: 0 0 8px #6a0dad;
  z-index: 9999;
  box-shadow: 0 0 15px #ff6600, 0 0 25px #ff3300 inset;
  transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease;
  animation: halloween-glow 2s infinite alternate;
}

@keyframes halloween-glow {
  from {
    box-shadow: 0 0 10px #ff6600, 0 0 20px #ff3300 inset;
    filter: brightness(1);
  }
  to {
    box-shadow: 0 0 25px #ff9900, 0 0 35px #ff6600 inset;
    filter: brightness(1.2);
  }
}

#backButton:hover {
  transform: scale(1.12);
  box-shadow: 0 0 30px #ffa500, 0 0 50px #ff3300 inset;
  filter: brightness(1.4);
}

/* Enlaces dentro del blog */
a {
  color: #ffcc66;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}
</style>
</head>  

<body>  
<button class="auth-button" onclick="window.location.href='h.html'">Volver a la P√°gina Principal</button>  
<h1>üé∞ Casino - Recompensas</h1>  

<div class="auth-container" id="authContainer">  
  <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesi√≥n / Registrarse</button>  
</div>  

<div class="user-info" id="userInfo">  
  <span id="userName">Usuario</span>  
  <img id="userLogo" src="logoDefault.png" alt="logo"/>  
</div>  

<div class="dropdown-menu" id="dropdownMenu">  
  <div onclick="logout()">üö™ Cerrar sesi√≥n</div>  
</div>  

<div id="pekepuntos" style="margin-top:20px; font-size:1.2rem;">Pekepuntos: 0</div>  

<div class="section" id="top5Section">  
  <h2>üèÜ Top 5 Jugadores</h2>  
  <ul id="top5List" class="top5-list"></ul>  
</div>  

<div class="section" id="gamesSection">  
  <h2>üéÆ Juegos Disponibles</h2>  
  <button class="game-button" onclick="window.location.href='bl.html'">Blackjack</button>  
  <button class="game-button" onclick="window.location.href='r.html'">Ruleta</button>  
  <button class="game-button" onclick="window.location.href='p.html'">Poker</button>  
</div>  

<div class="section" id="rewardsSection">  
  <h2>üéÅ Recompensas (Personalizaciones)</h2>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardBgBtn">Recompensa 1: Cambiar Fondo</button>  
    <input type="color" id="backgroundPicker" style="display:none; margin-left:8px;" />  
  </div>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="rewardNameBtn">Recompensa 2: Cambiar Color del Nombre</button>  
    <input type="color" id="nameColorPicker" style="display:none; margin-left:8px;" />  
  </div>    
  <div style="margin-bottom:12px;">  
    <button class="reward-button" id="reward3Btn">Recompensa 3: Cambiar color de tablas</button>  
    <input type="color" id="tableColorPicker" style="display:none;" onchange="setTableColor(this.value)">  
  </div>    
  <div id="exclusiveTop5" style="display:none; margin-top:10px;">üéñ Est√°s en Top 5 ‚Üí tu foto aparece en la lista.</div>  
  <div id="exclusiveTop3" style="display:none; margin-top:6px;">ü•â Top 3 ‚Üí nombre en <span style="color:#b87333">cobre</span>.</div>  
  <div id="exclusiveTop2" style="display:none; margin-top:6px;">ü•à Top 2 ‚Üí nombre en <span style="color:silver">plata</span>.</div>  
  <div id="exclusiveTop1" style="display:none; margin-top:6px;">üëë Top 1 ‚Üí nombre en <span style="color:gold">oro</span>.</div>  
</div>  

<script>  
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";  
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";  
const { createClient } = window.supabase;  
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);  

let currentUser = null;  

document.addEventListener("DOMContentLoaded", async () => {  
  document.getElementById("reward3Btn").addEventListener("click", () => toggleShow("tableColorPicker"));  
  document.getElementById("rewardBgBtn").addEventListener("click", () => toggleShow("backgroundPicker"));  
  document.getElementById("rewardNameBtn").addEventListener("click", () => toggleShow("nameColorPicker"));  

  document.getElementById("backgroundPicker").addEventListener("input", (e) => setBackgroundColor(e.target.value));  
  document.getElementById("nameColorPicker").addEventListener("input", (e) => setNameColor(e.target.value));  
  document.getElementById("tableColorPicker").addEventListener("input", (e) => setTableColor(e.target.value));  

  document.getElementById("userInfo").addEventListener("click", toggleDropdown);  
  document.addEventListener("click", (e) => {  
    const ui = document.getElementById("userInfo"), dd = document.getElementById("dropdownMenu");  
    if (!ui.contains(e.target) && !dd.contains(e.target)) dd.style.display = "none";  
  });  

  await initUser();  
  await loadTop5();  
});  

async function initUser() {
  try {
    // 1Ô∏è‚É£ Intentar cargar desde localStorage
    const saved = localStorage.getItem("currentUser");
    if (saved) {
      currentUser = JSON.parse(saved);
      renderUserUI();
      return;
    }

    // 2Ô∏è‚É£ Obtener usuario de Supabase Auth
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      console.log("No hay usuario logueado");
      document.getElementById("authContainer").style.display = "flex"; // Aseguramos que se vea el bot√≥n
      document.getElementById("userInfo").style.display = "none";
      return;
    }

    // 3Ô∏è‚É£ Buscar el usuario en la tabla "usuarios"
    const { data, error } = await supabase
      .from("usuarios")
      .select("*")
      .eq("auth_id", user.id)
      .maybeSingle();

    if (error) {
      console.error("Error cargando usuario de la DB:", error);
      return;
    }

    if (!data) {
      console.log("Usuario no encontrado en la tabla usuarios");
      return;
    }

    currentUser = data;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));

    // 4Ô∏è‚É£ Actualizar UI
    renderUserUI();

  } catch (err) {
    console.error("initUser exception:", err);
  }
}

function renderUserUI() {
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");

  if (currentUser) {
    authContainer.style.display = "none";
    userInfo.style.display = "flex";

    document.getElementById("userName").textContent = currentUser.username || "Usuario";
    document.getElementById("userLogo").src = currentUser.logo || "logoDefault.png";
    const puntos = Number(currentUser.pekepuntos || 0);
    document.getElementById("pekepuntos").textContent = `Pekepuntos: ${puntos.toLocaleString()}`;

    if (currentUser.fondo_color) document.body.style.backgroundColor = currentUser.fondo_color;
    if (currentUser.nombre_color) document.getElementById("userName").style.color = currentUser.nombre_color;
    if (currentUser.tabla_color) {
      applyTableColor(currentUser.tabla_color);
      document.getElementById("tableColorPicker").value = currentUser.tabla_color;
    }
  } else {
    authContainer.style.display = "flex";
    userInfo.style.display = "none";
    document.getElementById("pekepuntos").textContent = "Pekepuntos: 0";
  }
}

async function loadTop5(){
  const top5List = document.getElementById("top5List");
  top5List.innerHTML = '<li style="color:#aaa;">Cargando top 5...</li>';

  try {
    const { data, error } = await supabase
      .from("usuarios")
      .select("id, username, pekepuntos, logo, nombre_color")
      .order("pekepuntos", { ascending: false })
      .limit(5);

    if (error) {
      top5List.innerHTML = `<li style="color:red;">‚ùå Error al cargar el Top 5:<br>${error.message}</li>`;
      console.error(error);
      return;
    }

    if (!data || data.length === 0) {
      top5List.innerHTML = '<li style="color:#ccc;">(No hay jugadores a√∫n en la base de datos)</li>';
      return;
    }

    const fixedData = data.map(u => ({
      ...u,
      pekepuntos: u.pekepuntos !== null && u.pekepuntos !== undefined ? parseInt(u.pekepuntos) : 0
    }));

    top5List.innerHTML = "";
    fixedData.forEach((u, idx) => {
      const li = document.createElement("li");
      li.className = "top5-item";
      const nameColor = (idx === 0) ? "gold" : (idx === 1) ? "silver" : (idx === 2) ? "#b87333" : u.nombre_color || "#fff";
      const imgHtml = u.logo ? `<img src="${u.logo}" alt="logo">` : `<div style="width:36px;height:36px;border-radius:50%;background:#666;"></div>`;
      li.innerHTML = `
        ${imgHtml}
        <div style="flex:1;text-align:left;">
          <strong style="color:${nameColor}">${idx+1}. ${u.username || 'Jugador'}</strong>
          <div style="font-size:0.9rem;color:#ddd;">${u.pekepuntos.toLocaleString()} Pekepuntos</div>
        </div>
      `;
      top5List.appendChild(li);
    });

  } catch(e){  
    console.error("loadTop5 exception:", e);  
    top5List.innerHTML = '<li style="color:red;">Error cargando Top 5 (revisa consola)</li>';  
  }  
}  

function toggleDropdown(){ 
  const dd=document.getElementById("dropdownMenu"); 
  dd.style.display = dd.style.display==="block"?"none":"block"; 
}  

function toggleShow(id){ 
  const el=document.getElementById(id); 
  el.style.display = el.style.display==="block"?"none":"block"; 
}  

function applyTableColor(color){ 
  document.querySelectorAll('.section').forEach(sec=>sec.style.backgroundColor=color); 
  document.querySelectorAll('table').forEach(tbl=>tbl.style.backgroundColor=color); 
}  

async function setBackgroundColor(color){ 
  document.body.style.backgroundColor=color; 
  if(currentUser){ 
    await supabase.from("usuarios").update({fondo_color:color}).eq("id",currentUser.id); 
    currentUser.fondo_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  

async function setNameColor(color){ 
  document.getElementById("userName").style.color=color; 
  if(currentUser){ 
    await supabase.from("usuarios").update({nombre_color:color}).eq("id",currentUser.id); 
    currentUser.nombre_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  

async function setTableColor(color){ 
  applyTableColor(color); 
  if(currentUser){ 
    await supabase.from("usuarios").update({tabla_color:color}).eq("id",currentUser.id); 
    currentUser.tabla_color=color; 
    localStorage.setItem("currentUser",JSON.stringify(currentUser)); 
  } 
}  
</script> 
</body>  
</html>
