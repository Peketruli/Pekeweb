<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geiketa</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
:root {
  --neon-red: #ff3b3b;
  --neon-green: #39ff14;
  --neon-yellow: #fffb00;
  --neon-purple: #b517ff;
}

body {
  background: radial-gradient(circle at 20% 20%, #1a001a, #000000 90%);
  color: white;
  font-family: 'Poppins', Arial, sans-serif;
  text-align: center;
  padding: 20px;
}

button.auth-button {
  background: linear-gradient(90deg, var(--neon-purple), var(--neon-yellow));
  border-radius: 12px;
  color: white;
  padding: 10px 18px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  margin-bottom: 20px;
  text-shadow: 0 0 6px #000;
  box-shadow: 0 0 15px var(--neon-purple);
  transition: transform 0.2s, box-shadow 0.3s;
}
button.auth-button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px var(--neon-yellow);
}

h1 {
  font-size: 2.4em;
  color: var(--neon-yellow);
  text-shadow: 0 0 12px var(--neon-yellow), 0 0 25px var(--neon-purple);
  margin-bottom: 20px;
}

#pekePuntos {
  font-size: 2em;
  margin-bottom: 20px;
  text-shadow: 0 0 6px var(--neon-green);
}

/* Botones de apuesta */
button, .bet-btn, .option-btn {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: transform 0.2s, box-shadow 0.3s;
}

.bet-btn {
  min-width: 40px;
  margin: 2px;
  box-shadow: 0 0 8px #000;
}
.option-btn {
  min-width: 60px;
  margin: 2px;
  background-color: #222;
  box-shadow: 0 0 8px #000;
}

.bet-btn.selected, .option-btn.selected {
  border: 2px solid var(--neon-yellow);
  box-shadow: 0 0 12px var(--neon-yellow);
}

#spin-button, #confirm-bet-button {
  margin-top: 15px;
  background: linear-gradient(90deg, var(--neon-green), var(--neon-purple));
  color: black;
  box-shadow: 0 0 15px var(--neon-green);
}

canvas {
  background: radial-gradient(circle at center, #0c0c0c, #000000 90%);
  border-radius: 50%;
  margin-top: 20px;
  box-shadow: 0 0 20px var(--neon-purple);
}

#result {
  font-size: 1.5em;
  margin-top: 15px;
  color: var(--neon-yellow);
  text-shadow: 0 0 8px var(--neon-yellow), 0 0 12px var(--neon-purple);
}

button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px var(--neon-yellow);
}

#bet-buttons, #bet-options {
  margin-top: 15px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}

</style>
</head>
<body>
<button class="auth-button" onclick="window.location.href='c.html'">Volver</button>
<h1> Ruleta Casino </h1>
<div id="pekePuntos">Pekepuntos: 0</div>

<div id="bet-buttons"></div>
<div id="bet-options"></div>

<label for="bet-amount">Cantidad a apostar: </label>
<input type="number" id="bet-amount" min="1" placeholder="Puntos a apostar">
<button id="confirm-bet-button">Confirmar Apuesta</button>

<canvas id="roulette" width="400" height="400"></canvas>
<div id="result"></div>
<button id="spin-button" disabled>Girar Ruleta</button>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentBet = 0;
let selectedNumbers = new Set();
let selectedColor = null;
let selectedParity = null;

const numbers = Array.from({ length: 37 }, (_, i) => i);
const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
function getColor(num){ return num===0?'green':redNumbers.includes(num)?'red':'black'; }

const canvas = document.getElementById("roulette");
const ctx = canvas.getContext("2d");
const radius = canvas.width/2;
let currentAngle = 0, spinning = false, finalNumber = null;

/* Ь Registrar actividad en Supabase */
async function registrarActividad(usuario, accion) {
  try {
    await supabase.from("actividad").insert([{ usuario, accion }]);
  } catch (err) {
    console.error("Error registrando actividad:", err);
  }
}

/*  Dibujar la ruleta */
function drawRoulette() {
  const step = 2 * Math.PI / numbers.length;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(radius, radius);
  ctx.rotate(currentAngle);

  numbers.forEach((num, i) => {
    const start = i * step, end = start + step;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, radius, start, end);
    ctx.fillStyle = getColor(num);
    ctx.fill();
    ctx.strokeStyle = "white";
    ctx.stroke();

    ctx.save();
    ctx.rotate(start + step / 2);
    ctx.fillStyle = "white";
    ctx.textAlign = "right";
    ctx.font = "14px Arial";
    ctx.fillText(num, num < 10 ? radius - 15 : radius - 20, 5);
    ctx.restore();
  });

  ctx.restore();

  // marcador
  ctx.beginPath();
  ctx.moveTo(radius - 10, 0);
  ctx.lineTo(radius + 10, 0);
  ctx.lineWidth = 4;
  ctx.strokeStyle = "yellow";
  ctx.stroke();
}

/*  Girar la ruleta */
function spinRoulette() {
  if (spinning) return;

  if (!navigator.onLine) {
    alert("No tienes conexi贸n a Internet. No puedes girar la ruleta.");
    return;
  }

  if (currentBet <= 0) {
    alert("Debes confirmar la apuesta");
    return;
  }

  registrarActividad(currentUser.username, `gir贸 la ruleta apostando ${currentBet} pekepuntos`);

  spinning = true;
  let velocity = Math.random() * 0.15 + 0.18;
  let deceleration = 0.0025 + Math.random() * 0.003;

  function animate() {
    if (velocity <= 0) {
      spinning = false;
      const step = 2 * Math.PI / numbers.length;
      let idx = Math.floor(((2 * Math.PI - (currentAngle % (2 * Math.PI))) / step)) % numbers.length;
      finalNumber = numbers[idx];
      const color = getColor(finalNumber);
      const parity = finalNumber === 0 ? null : (finalNumber % 2 === 0 ? "even" : "odd");

      document.getElementById("result").textContent = `N煤mero: ${finalNumber} (${color})`;
      calculateWinnings(finalNumber, color, parity);
      return;
    }

    currentAngle += velocity;
    velocity -= deceleration;
    drawRoulette();
    requestAnimationFrame(animate);
  }

  animate();
}

/*  Cargar Pekepuntos + verificar baneo */
async function loadPekePuntos() {
  try {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) {
      alert("Debes iniciar sesi贸n.");
      window.location.href = "login.html";
      return;
    }

    const { data, error } = await supabase
      .from("usuarios")
      .select("pekepuntos, banned")
      .eq("id", currentUser.id)
      .single();

    if (error) throw error;

    if (data.banned === true) {
      alert("Has sido baneado y no puedes jugar a la ruleta.");
      document.getElementById("confirm-bet-button").disabled = true;
      document.getElementById("spin-button").disabled = true;
      registrarActividad(currentUser.username, "intent贸 jugar estando baneado");
      return;
    }

    currentUser.pekepuntos = data.pekepuntos;
    document.getElementById("pekePuntos").textContent = `Pekepuntos: ${data.pekepuntos}`;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
    registrarActividad(currentUser.username, "esta en la rule");
  } catch (err) {
    console.error("Error al cargar Pekepuntos:", err);
    alert("No se han podido cargar los Pekepuntos.");
  }
}

/*  Confirmar apuesta */
document.getElementById("confirm-bet-button").addEventListener("click", () => {
  if (!navigator.onLine) {
    alert("No tienes conexi贸n a Internet.");
    return;
  }

  const amount = parseInt(document.getElementById("bet-amount").value);
  if (isNaN(amount) || amount <= 0 || amount > currentUser.pekepuntos) {
    alert("Cantidad inv谩lida");
    return;
  }

  if (selectedNumbers.size === 0 && !selectedColor && !selectedParity) {
    alert("Debes seleccionar al menos un n煤mero, color o paridad");
    return;
  }

  currentBet = amount;
  currentUser.pekepuntos -= currentBet;
  document.getElementById("pekePuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos}`;

  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  supabase.from("usuarios").update({ pekepuntos: currentUser.pekepuntos }).eq("id", currentUser.id);

  registrarActividad(currentUser.username, `confirm贸 una apuesta de ${currentBet} pekepuntos`);
  document.getElementById("spin-button").disabled = false;
});

/*  Actualizar puntos */
async function updatePoints(wonAmount) {
  if (wonAmount > 0) {
    currentUser.pekepuntos += wonAmount;
    registrarActividad(currentUser.username, `gan贸 ${wonAmount} pekepuntos en la ruleta`);
  } else {
    registrarActividad(currentUser.username, `perdi贸 la apuesta de ${currentBet} pekepuntos`);
  }

  document.getElementById("pekePuntos").textContent = `Pekepuntos: ${currentUser.pekepuntos}`;
  await supabase.from("usuarios").update({ pekepuntos: currentUser.pekepuntos }).eq("id", currentUser.id);
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  resetSelections();
}

/*  Calcular ganancias */
function calculateWinnings(number, color, parity) {
  let won = 0;
  const activeBets = selectedNumbers.size + (selectedColor ? 1 : 0) + (selectedParity ? 1 : 0);
  if (activeBets === 0) return;

  const betPerOption = currentBet / activeBets;
  if (selectedNumbers.has(number)) won += betPerOption * 20;
  if (selectedColor && color === selectedColor) won += betPerOption * 2;
  if (selectedParity && ((parity === "even" && selectedParity === "even") || (parity === "odd" && selectedParity === "odd")))
    won += betPerOption * 2;

  alert(won > 0 ? `隆Ganaste ${Math.floor(won)} PekePuntos!` : "Perdiste la apuesta");
  updatePoints(Math.floor(won));
}

/*  Crear botones */
function createBetButtons() {
  const container = document.getElementById("bet-buttons");
  numbers.forEach(num => {
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.className = "bet-btn";
    btn.style.backgroundColor = getColor(num);
    btn.style.color = num === 0 ? "black" : "white";
    btn.onclick = () => {
      if (selectedNumbers.has(num)) { selectedNumbers.delete(num); btn.style.border = ""; }
      else { selectedNumbers.add(num); btn.style.border = "2px solid yellow"; }
    };
    container.appendChild(btn);
  });

  const optionsContainer = document.getElementById("bet-options");
  ["red", "black"].forEach(c => {
    const btn = document.createElement("button");
    btn.textContent = c;
    btn.className = "option-btn";
    btn.style.backgroundColor = c;
    btn.style.color = "white";
    btn.onclick = () => { selectedColor = selectedColor === c ? null : c; btn.style.border = selectedColor === c ? "2px solid yellow" : ""; };
    optionsContainer.appendChild(btn);
  });

  ["even", "odd"].forEach(p => {
    const btn = document.createElement("button");
    btn.textContent = p === "even" ? "Par" : "Impar";
    btn.className = "option-btn";
    btn.style.backgroundColor = "#444";
    btn.style.color = "white";
    btn.onclick = () => { selectedParity = selectedParity === p ? null : p; btn.style.border = selectedParity === p ? "2px solid yellow" : ""; };
    optionsContainer.appendChild(btn);
  });
}

/*  Resetear */
function resetSelections() {
  selectedNumbers.clear(); 
  selectedColor = null; 
  selectedParity = null; 
  currentBet = 0;
  document.getElementById("spin-button").disabled = true;
  document.getElementById("bet-amount").value = "";
  document.querySelectorAll(".bet-btn, .option-btn").forEach(b => b.style.border = "");
}

/*  Iniciar */
drawRoulette();
loadPekePuntos();
createBetButtons();
document.getElementById("spin-button").addEventListener("click", spinRoulette);
</script>
</body>
</html>
