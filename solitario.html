<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solitario (Klondike)</title>
<style>
    :root{
        --bg:#0b3d0b;
        --panel:#062906;
        --slot: rgba(255,255,255,0.08);
        --slot-border: rgba(255,255,255,0.12);
    }
    *{box-sizing:border-box;user-select:none}
    body{
        margin:0;
        font-family:Arial, Helvetica, sans-serif;
        background:var(--bg);
        color:#fff;
        height:100vh;
        overflow:hidden;
    }

    #top-bar{
        height:56px;
        background:var(--panel);
        border-bottom:2px solid #134013;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        padding:0 16px;
    }
    #top-bar h2{margin:0;font-size:18px}
    #top-bar .left, #top-bar .right{display:flex;gap:8px;align-items:center}

    button{
        background:#333;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;
    }
    button:hover{background:#4a4a4a}

    #game{
        padding:14px;
        height:calc(100vh - 56px);
        display:flex;
        flex-direction:column;
        gap:12px;
    }

    #top-area{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        width:100%;
    }
    #left-top{
        display:flex;
        gap:12px;
        align-items:center;
    }
    .slot{
        width:92px;
        height:132px;
        background:var(--slot);
        border:2px dashed var(--slot-border);
        border-radius:10px;
        position:relative;
        display:flex;
        align-items:center;
        justify-content:center;
        overflow:visible;
    }

    .card{
        width:92px;
        height:132px;
        border-radius:8px;
        position:absolute;
        left:0;
        top:0;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
        font-size:20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.6);
        cursor:pointer;
        background:white;
        color:black;
        transition: transform 0.05s linear;
    }
    .card.red{ color: #b91c1c; }
    .card.back{
        background: linear-gradient(180deg,#b91c1c,#8a1010);
        color:transparent;
        border:2px solid rgba(0,0,0,0.3);
    }

    #tableau{
        display:flex;
        gap:12px;
        align-items:flex-start;
        justify-content:center;
        height:100%;
        width:100%;
        padding:8px;
    }
    .column{
        width:92px;
        min-height:150px;
        background:var(--slot);
        border-radius:10px;
        position:relative;
        padding:6px 0;
        border:1px solid transparent;
    }

    .dragging{
        opacity:0.8;
        z-index:9999;
        transform:scale(1.05);
    }

    @media (max-width:900px){
        .slot, .card{ width:70px; height:100px; font-size:16px; }
        .column{ width:70px }
    }
</style>
</head>
<body>
    <div id="top-bar">
        <div class="left">
            <button onclick="window.location.href='menu.html'">‚Üê Volver</button>
            <h2>Solitario</h2>
        </div>
        <div class="right">
            <button onclick="iniciarJuego()">Reiniciar</button>
            <button onclick="autoMoverTodo()">Auto-mover</button>
        </div>
    </div>

    <div id="game">
        <div id="top-area">
            <div id="left-top">
                <div id="deck" class="slot" title="Mazo (haz clic)"> </div>
                <div id="waste" class="slot" title="Descarte"> </div>
            </div>

            <div id="foundations" style="display:flex;gap:12px">
                <div id="f0" class="slot" data-foundation="0" title="Fundaci√≥n ‚ô†"></div>
                <div id="f1" class="slot" data-foundation="1" title="Fundaci√≥n ‚ô•"></div>
                <div id="f2" class="slot" data-foundation="2" title="Fundaci√≥n ‚ô¶"></div>
                <div id="f3" class="slot" data-foundation="3" title="Fundaci√≥n ‚ô£"></div>
            </div>
        </div>

        <div id="tableau"></div>
    </div>

<script>
const palos = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
let mazo = [], descarte = [], tableau = [[],[],[],[],[],[],[]], fundaciones = [[],[],[],[]];

function crearMazo(){
    mazo = [];
    for (const palo of palos){
        for (let v=1; v<=13; v++){
            mazo.push({ valor: v, palo, color: (palo==='‚ô•' || palo==='‚ô¶') ? 'red':'black', visible:false });
        }
    }
}

function barajar(){
    for (let i=mazo.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [mazo[i],mazo[j]] = [mazo[j],mazo[i]];
    }
}

function repartirCartas(){
    tableau = [[],[],[],[],[],[],[]];
    for (let c=0;c<7;c++){
        for (let r=0;r<=c;r++){
            const carta = mazo.pop();
            carta.visible = (r===c);
            tableau[c].push(carta);
        }
    }
}

function puedeMoverAFoundation(carta, fundacion){
    if (!carta) return false;
    if (fundacion.length===0) return carta.valor===1;
    const top = fundacion[fundacion.length-1];
    return carta.palo===top.palo && carta.valor === top.valor+1;
}

function puedeColocarEnTabla(carta, columna){
    if (!carta) return false;
    if (columna.length===0) return carta.valor===13;
    const top = columna[columna.length-1];
    return top.visible && carta.color !== top.color && carta.valor === top.valor - 1;
}

function robarCarta(){
    if (mazo.length === 0){
        mazo = descarte.reverse().map(c => ({...c, visible:false}));
        descarte = [];
    } else {
        const carta = mazo.pop();
        carta.visible = true;
        descarte.push(carta);
    }
    render();
}

function moverDescarte(){
    if (descarte.length===0) return;
    const carta = descarte[descarte.length-1];
    for (let f=0; f<4; f++){
        if (puedeMoverAFoundation(carta, fundaciones[f])){
            fundaciones[f].push(descarte.pop());
            render(); return;
        }
    }
    for (let t=0;t<7;t++){
        if (puedeColocarEnTabla(carta, tableau[t])){
            tableau[t].push(descarte.pop());
            render(); return;
        }
    }
}

function clickColumna(i){
    const col = tableau[i];
    if (col.length===0) return;
    const ultima = col[col.length-1];
    if (!ultima.visible){ ultima.visible = true; render(); return; }
    for (let f=0; f<4; f++){
        if (puedeMoverAFoundation(ultima, fundaciones[f])){
            fundaciones[f].push(col.pop());
            render();
            return;
        }
    }
}

function dobleClickCarta(orig){
    if (orig.type === 'waste'){ moverDescarte(); return; }
    else if (orig.type === 'col'){
        const col = tableau[orig.colIndex];
        const carta = col[orig.cardIndex];
        if (!carta || !carta.visible) return;
        for (let f=0; f<4; f++){
            if (puedeMoverAFoundation(carta, fundaciones[f])){
                fundaciones[f].push(col.pop());
                render();
                return;
            }
        }
    }
}

function crearCartaDiv(carta){
    const div = document.createElement('div');
    div.className = 'card ' + (carta.visible ? (carta.color==='red' ? 'red' : '') : 'back');
    if (carta.visible){
        const txt = carta.valor===1? 'A' : carta.valor===11? 'J' : carta.valor===12? 'Q' : carta.valor===13? 'K' : carta.valor;
        div.textContent = txt + carta.palo;
    }
    return div;
}

function render(){
    const deckDiv = document.getElementById('deck');
    deckDiv.innerHTML = '';
    if (mazo.length>0){
        const back = document.createElement('div');
        back.className = 'card back';
        deckDiv.appendChild(back);
    }
    deckDiv.onclick = robarCarta;

    const wasteDiv = document.getElementById('waste');
    wasteDiv.innerHTML = '';
    if (descarte.length>0){
        const top = descarte[descarte.length-1];
        const div = crearCartaDiv(top);
        div.onclick = moverDescarte;
        div.ondblclick = ()=>dobleClickCarta({type:'waste'});
        wasteDiv.appendChild(div);
    }

    for (let f=0; f<4; f++){
        const fDiv = document.getElementById('f'+f);
        fDiv.innerHTML = '';
        if (fundaciones[f].length>0){
            const top = fundaciones[f][fundaciones[f].length-1];
            const d = crearCartaDiv(top);
            fDiv.appendChild(d);
        }
    }

    const tabla = document.getElementById('tableau');
    tabla.innerHTML = '';
    for (let i=0;i<7;i++){
        const colDiv = document.createElement('div');
        colDiv.className = 'column';
        colDiv.dataset.colIndex = i;
        colDiv.onclick = (e)=>{if(e.target===colDiv)clickColumna(i);};
        let offset=6;
        for (let j=0;j<tableau[i].length;j++){
            const carta = tableau[i][j];
            const cd = crearCartaDiv(carta);
            cd.style.top = offset + 'px';
            cd.dataset.colIndex=i;
            cd.dataset.cardIndex=j;
            if (carta.visible){
                cd.draggable=true;
                cd.addEventListener('dragstart',(e)=>dragStart(e,i,j));
                cd.addEventListener('dragend',(e)=>dragEnd(e));
                cd.ondblclick=()=>dobleClickCarta({type:'col',colIndex:i,cardIndex:j});
            }
            colDiv.appendChild(cd);
            offset+=28;
        }
        tabla.appendChild(colDiv);
    }

    verificarMovimientosPosibles();

    if (fundaciones.every(f => f.length===13)){
        setTimeout(()=>alert("üéâ ¬°Ganaste el Solitario!"),200);
    }
}

/* Drag real */
let dragged=null;
function dragStart(e,colIndex,cardIndex){
    const carta = tableau[colIndex][cardIndex];
    if (!carta.visible) return e.preventDefault();
    dragged={colIndex,cardIndex};
    e.target.classList.add('dragging');
}
function dragEnd(e){
    e.target.classList.remove('dragging');
    dragged=null;
}
document.addEventListener('dragover',e=>e.preventDefault());
document.addEventListener('drop',e=>{
    e.preventDefault();
    if(!dragged) return;
    const dropElem=document.elementFromPoint(e.clientX,e.clientY);
    let target=null;
    let el=dropElem;
    while(el&&el!==document.body){
        if(el.classList&&el.classList.contains('column')){
            target={type:'col',index:parseInt(el.dataset.colIndex)};
            break;
        }
        if(el.id&&el.id.startsWith('f')){
            target={type:'foundation',index:parseInt(el.id.substring(1))};
            break;
        }
        el=el.parentElement;
    }
    if(target){
        const moving=tableau[dragged.colIndex].slice(dragged.cardIndex);
        const first=moving[0];
        let moved=false;
        if(target.type==='col'){
            if(puedeColocarEnTabla(first,tableau[target.index])){
                tableau[target.index]=tableau[target.index].concat(moving);
                tableau[dragged.colIndex].splice(dragged.cardIndex);
                moved=true;
            }
        }else if(target.type==='foundation' && moving.length===1){
            if(puedeMoverAFoundation(first,fundaciones[target.index])){
                fundaciones[target.index].push(tableau[dragged.colIndex].pop());
                moved=true;
            }
        }
        if(moved && tableau[dragged.colIndex].length>0){
            tableau[dragged.colIndex][tableau[dragged.colIndex].length-1].visible=true;
        }
    }
    render();
});

/* Detectar si hay movimientos posibles */
function verificarMovimientosPosibles(){
    // comprobar descarte
    if (descarte.length>0){
        const c = descarte[descarte.length-1];
        for(let f=0;f<4;f++) if(puedeMoverAFoundation(c,fundaciones[f])) return;
        for(let t=0;t<7;t++) if(puedeColocarEnTabla(c,tableau[t])) return;
    }
    // comprobar columnas
    for(let i=0;i<7;i++){
        const col=tableau[i];
        if(col.length===0) continue;
        const top=col[col.length-1];
        if(top.visible){
            for(let f=0;f<4;f++) if(puedeMoverAFoundation(top,fundaciones[f])) return;
            for(let j=0;j<7;j++){
                if(i!==j && puedeColocarEnTabla(top,tableau[j])) return;
            }
        }
    }
    // Si llega aqu√≠, no hay movimientos
    setTimeout(()=>alert("‚ùå No hay movimientos posibles. Fin de partida."),200);
}

/* Auto mover */
function autoMoverTodo(){
    let movedSomething=true;
    while(movedSomething){
        movedSomething=false;
        if(descarte.length>0){
            const c=descarte[descarte.length-1];
            for(let f=0;f<4;f++){
                if(puedeMoverAFoundation(c,fundaciones[f])){
                    fundaciones[f].push(descarte.pop());
                    movedSomething=true;break;
                }
            }
        }
        for(let i=0;i<7;i++){
            if(tableau[i].length===0)continue;
            const top=tableau[i][tableau[i].length-1];
            if(!top.visible)continue;
            for(let f=0;f<4;f++){
                if(puedeMoverAFoundation(top,fundaciones[f])){
                    fundaciones[f].push(tableau[i].pop());
                    if(tableau[i].length>0)tableau[i][tableau[i].length-1].visible=true;
                    movedSomething=true;break;
                }
            }
        }
    }
    render();
}

function iniciarJuego(){
    crearMazo();barajar();descarte=[];fundaciones=[[],[],[],[]];repartirCartas();render();
}
window.onload=iniciarJuego;
document.addEventListener('selectstart',e=>e.preventDefault());
</script>
</body>
</html>
