<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat ‚Äî WhatsApp style</title>
<style>
  :root{--green:#128c7e;--accent:#25d366;--sidebar:#075e54;--bg:#ece5dd;}
  body{margin:0;font-family:Inter,Arial,sans-serif;height:100vh;display:flex;background:var(--bg);color:#111}
  /* SIDEBAR */
  #sidebar{width:320px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
  #profile{display:flex;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,0.06)}
  #profile .avatar{width:48px;height:48px;border-radius:50%;background:#0b845f;margin-right:12px;display:flex;align-items:center;justify-content:center;font-weight:700}
  #profile .who{font-size:14px}
  #sidebar-controls{display:flex;gap:8px;padding:12px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-green{background:var(--accent);color:#fff}
  .btn-light{background:#34b7f1;color:#fff}
  #search-contacts{margin:0 12px 8px;padding:8px;border-radius:8px;border:none}
  #lists{flex:1;overflow:auto;padding:8px}
  .section-title{color:rgba(255,255,255,0.8);font-size:13px;margin:8px 4px}
  .chat-item, .contact-item{background:transparent;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .chat-item:hover, .contact-item:hover{background:rgba(255,255,255,0.04)}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.7)}
  /* MAIN */
  #main{flex:1;display:flex;flex-direction:column;background:var(--bg)}
  #header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--green);color:#fff}
  #messages{flex:1;overflow:auto;padding:18px}
  .message{max-width:66%;margin:8px 0;padding:10px 14px;border-radius:18px;word-break:break-word;display:inline-block;clear:both}
  .my-message{background:#dcf8c6;float:right}
  .other-message{background:#fff;float:left}
  #composer{display:flex;padding:12px;background:#f0f0f0;gap:8px}
  #message-input{flex:1;padding:12px;border-radius:999px;border:1px solid #ccc;outline:none}
  #send{padding:10px 14px;border-radius:999px;border:none;background:var(--green);color:#fff;cursor:pointer}
  /* MODALS */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)}
  .card{background:#fff;border-radius:10px;padding:16px;width:360px;max-width:94%}
  .card h3{margin-top:0}
  .modal .list{max-height:260px;overflow:auto}
  /* members modal */
  #members-list div{padding:8px;border-bottom:1px solid #eee}
  /* small responsive */
  @media (max-width:900px){#sidebar{width:260px}}
  @media (max-width:700px){#sidebar{display:none}}
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div id="profile">
      <div class="avatar" id="profile-avatar">P</div>
      <div class="who">
        <div id="profile-name">T√∫</div>
        <div class="small-muted" id="profile-id"></div>
      </div>
    </div>

    <div id="sidebar-controls">
      <button id="btn-add-contact" class="btn btn-light">Agregar contacto</button>
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search-contacts" placeholder="Buscar contactos..." />

    <div id="lists">
      <div class="section-title">CHATS</div>
      <div id="chats-list"></div>

      <div class="section-title" style="margin-top:12px">CONTACTOS</div>
      <div id="contacts-list"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="main">
    <div id="header">
      <div id="chat-title">Selecciona un chat</div>
      <div>
        <button id="btn-members" class="btn btn-light">Miembros</button>
      </div>
    </div>

    <div id="messages"></div>

    <form id="composer" onsubmit="return false;">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <button id="send" class="btn">Enviar</button>
    </form>
  </main>

  <!-- MODALS -->
  <div id="modal-create-group" class="modal">
    <div class="card">
      <h3>Crear grupo</h3>
      <input id="group-name" placeholder="Nombre del grupo" />
      <div style="margin-top:8px" class="small-muted">Selecciona miembros:</div>
      <div class="list" id="group-members-list"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="confirm-create-group" class="btn btn-green">Crear</button>
        <button id="cancel-create-group" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-members" class="modal">
    <div class="card">
      <h3>Miembros</h3>
      <div id="members-list"></div>
      <div style="margin-top:10px;text-align:right"><button id="close-members" class="btn">Cerrar</button></div>
    </div>
  </div>

 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// -----------------------------------------------------
// 1Ô∏è‚É£ CONFIG SUPABASE
// -----------------------------------------------------
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ‚úîÔ∏è Lo ponemos en number porque Supabase devuelve n√∫meros
const currentUserId = Number(localStorage.getItem("currentUser"));

let currentChatId = null;
let messageChannel = null;

// DOM
const recentList   = document.getElementById("chats-list");
const allUsersList = document.getElementById("contacts-list");
const chatBox      = document.getElementById("messages");
const messageInput = document.getElementById("message-input");


// -----------------------------------------------------
// 2Ô∏è‚É£ CARGAR USUARIOS
// -----------------------------------------------------
async function loadUsers() {
  const { data: users, error } = await supabase
    .from("usuarios")
    .select("id, username");

  if (error) {
    alert("Error cargando usuarios");
    return;
  }

  // Filtrar: todos excepto yo
  const filteredUsers = users.filter(u => u.id !== currentUserId);

  // Cargar √∫ltimas conversaciones
  const { data: recentMessages } = await supabase
    .from("new_messages")
    .select("chat_id, created_at")
    .order("created_at", { ascending: false });

  const recentChats = [];
  if (recentMessages) {
    for (const msg of recentMessages) {
      if (!recentChats.includes(msg.chat_id)) recentChats.push(msg.chat_id);
    }
  }

  // üí¨ CHATS RECIENTES
  recentList.innerHTML = "";
  for (const chatId of recentChats) {

    const { data: members } = await supabase
      .from("new_chat_members")
      .select("user_id")
      .eq("chat_id", chatId);

    if (!members) continue;

    const other = members.find(m => m.user_id !== currentUserId);
    if (!other) continue;

    const profile = filteredUsers.find(u => u.id === other.user_id);
    if (!profile) continue;

    const li = document.createElement("li");
    li.textContent = profile.username;
    li.onclick = () => openChat(chatId, profile);
    recentList.appendChild(li);
  }

  // üìí LISTA DE USUARIOS
  allUsersList.innerHTML = "";
  filteredUsers.forEach(user => {
    const li = document.createElement("li");
    li.textContent = user.username;
    li.onclick = () => openOrCreatePrivateChat(user.id, user.username);
    allUsersList.appendChild(li);
  });
}



// -----------------------------------------------------
// 3Ô∏è‚É£ CREAR O ABRIR CHAT PRIVADO
// -----------------------------------------------------
async function openOrCreatePrivateChat(otherUserId, username) {

  const { data: chats } = await supabase
    .from("new_chats")
    .select("id")
    .eq("type", "private");

  if (chats) {
    for (const chat of chats) {

      const { data: members } = await supabase
        .from("new_chat_members")
        .select("user_id")
        .eq("chat_id", chat.id);

      const hasMe = members.some(m => m.user_id === currentUserId);
      const hasOther = members.some(m => m.user_id === otherUserId);

      if (hasMe && hasOther) {
        return openChat(chat.id, { username });
      }
    }
  }

  // Crear chat nuevo
  const { data: newChat } = await supabase
    .from("new_chats")
    .insert({ type: "private" })
    .select()
    .single();

  await supabase.from("new_chat_members").insert([
    { chat_id: newChat.id, user_id: currentUserId },
    { chat_id: newChat.id, user_id: otherUserId }
  ]);

  openChat(newChat.id, { username });
}



// -----------------------------------------------------
// 4Ô∏è‚É£ ABRIR CHAT
// -----------------------------------------------------
async function openChat(chatId, user) {
  currentChatId = chatId;

  chatBox.innerHTML = `<h3>Chat con ${user.username}</h3>`;

  await loadMessages(chatId);
  subscribeToChat(chatId);

  messageInput.onkeydown = e => {
    if (e.key === "Enter") sendMessage(chatId);
  };
}



// -----------------------------------------------------
// 5Ô∏è‚É£ SUSCRIPCI√ìN REALTIME
// -----------------------------------------------------
function subscribeToChat(chatId) {
  if (messageChannel) supabase.removeChannel(messageChannel);

  messageChannel = supabase
    .channel(`chat_${chatId}`)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "new_messages",
        filter: `chat_id=eq.${chatId}`
      },
      payload => {
        const msg = payload.new;

        const div = document.createElement("div");
        div.className =
          "message " +
          (msg.sender_id === currentUserId ? "my-message" : "other-message");

        div.textContent = msg.content;
        chatBox.appendChild(div);

        chatBox.scrollTop = chatBox.scrollHeight;
      }
    )
    .subscribe();
}



// -----------------------------------------------------
// 6Ô∏è‚É£ ENVIAR MENSAJE
// -----------------------------------------------------
async function sendMessage(chatId) {
  const content = messageInput.value.trim();
  if (!content) return;

  await supabase.from("new_messages").insert({
    chat_id: chatId,
    sender_id: currentUserId,
    content
  });

  messageInput.value = "";
}



// -----------------------------------------------------
// 7Ô∏è‚É£ CARGAR MENSAJES
// -----------------------------------------------------
async function loadMessages(chatId) {
  const { data: messages } = await supabase
    .from("new_messages")
    .select("*")
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  messages.forEach(msg => {
    const div = document.createElement("div");
    div.className =
      "message " +
      (msg.sender_id === currentUserId ? "my-message" : "other-message");

    div.textContent = msg.content;
    chatBox.appendChild(div);
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}



// -----------------------------------------------------
// 8Ô∏è‚É£ INICIO
// -----------------------------------------------------
loadUsers();
</script>
</body>
</html>
