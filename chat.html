<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat — WhatsApp style (Clean)</title>

<style>
  :root{--bg:#ece5dd;--sidebar:#075e54;--accent:#25d366;--green:#128c7e;--card:#fff;--muted:#7a7a7a}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{background:var(--bg);display:flex;align-items:stretch;color:#111}

  .app{display:flex;height:100vh;width:100%;max-width:1200px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,.12);border-radius:8px;overflow:hidden;background:#fff}
  .sidebar{width:340px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
  .main{flex:1;display:flex;flex-direction:column;background:var(--bg)}

  .profile{display:flex;align-items:center;padding:18px;border-bottom:1px solid rgba(255,255,255,0.06)}
  .avatar{width:48px;height:48px;border-radius:50%;background:#0b845f;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:12px}
  .who .name{font-weight:700}
  .who .id{font-size:12px;color:rgba(255,255,255,0.8);word-break:break-all}

  .sidebar-controls{display:flex;gap:8px;padding:12px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-light{background:#34b7f1;color:#fff}
  .btn-green{background:var(--accent);color:#fff}
  .search{margin:8px 12px;padding:8px;border-radius:8px;border:none;width:calc(100% - 24px)}

  .lists{flex:1;overflow:auto;padding:8px}
  .section-title{color:rgba(255,255,255,0.85);font-size:12px;margin:6px 6px}
  ul{list-style:none;padding:0;margin:0}
  .contact-item,.chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;color:#fff;margin:4px 6px}
  .contact-item:hover,.chat-item:hover{background:rgba(255,255,255,0.04)}
  .meta{display:flex;flex-direction:column}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.7)}

  .header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--green);color:#fff}
  .title{font-weight:700}
  .typing{font-size:12px;color:rgba(255,255,255,0.85)}

  .messages{flex:1;overflow:auto;padding:18px;background:var(--bg)}
  .msg-row{display:flex;margin:8px 0;align-items:flex-end}
  .msg{max-width:68%;padding:10px 14px;border-radius:14px;word-break:break-word;line-height:1.3}
  .mine{margin-left:auto;background:#dcf8c6}
  .other{margin-right:auto;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,0.04)}
  .sender-name{font-size:12px;font-weight:700;margin-bottom:6px;color:#222}
  .msg-time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}

  .composer{display:flex;gap:8px;padding:12px;background:#f0f0f0;align-items:center}
  .composer input{flex:1;padding:12px;border-radius:999px;border:1px solid #ccc;outline:none}
  .composer button{padding:10px 14px;border-radius:999px;border:none;background:var(--green);color:#fff;cursor:pointer}

  @media(max-width:900px){.sidebar{width:260px}}
  @media(max-width:700px){.app{flex-direction:column;height:100%}.sidebar{width:100%;height:260px}.main{height:calc(100% - 260px)}}
</style>
</head>
<body>

<div class="app" id="app">
  <aside class="sidebar">
    <div class="profile">
      <div class="avatar" id="profile-avatar">?</div>
      <div class="who">
        <div class="name" id="profile-name">Cargando...</div>
        <div class="id small-muted" id="profile-id"></div>
      </div>
    </div>

    <div class="sidebar-controls">
      
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search" class="search" placeholder="Buscar contactos..." />

    <div class="lists">
      <div class="section-title">CHATS</div>
      <ul id="chats-list"></ul>

      <div class="section-title" style="margin-top:14px">CONTACTOS</div>
      <ul id="contacts-list"></ul>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="title" id="chat-title">Selecciona un chat</div>
        <div class="typing" id="typing"></div>
      </div>
      <div></div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off" />
      <button id="send">Enviar</button>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM
const profileNameEl = document.getElementById('profile-name');
const profileIdEl = document.getElementById('profile-id');
const profileAvatarEl = document.getElementById('profile-avatar');
const contactsListEl = document.getElementById('contacts-list');
const chatsListEl = document.getElementById('chats-list');
const messagesEl = document.getElementById('messages');
const chatTitleEl = document.getElementById('chat-title');
const typingEl = document.getElementById('typing');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send');
const searchInput = document.getElementById('search');

// State
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
const usersMap = {};
let currentChatId = null;
let realtimeChannel = null;

// Ensure local user exists and upsert to DB
async function ensureLocalUser(){
  if (currentUser && currentUser.id && currentUser.username) return;
  const id = crypto.randomUUID();
  const username = 'Usuario-' + Math.floor(Math.random()*9000 + 1000);
  currentUser = { id, username };
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  try{
    await supabase.from('usuarios').upsert([{ id: currentUser.id, username: currentUser.username }], { onConflict: 'id' });
  }catch(e){console.warn('upsert user failed', e)}
}

function el(tag, props = {}, ...children){ const d = document.createElement(tag); for(const k in props) d[k] = props[k]; for(const c of children) if(typeof c==='string') d.appendChild(document.createTextNode(c)); else d.appendChild(c); return d; }
function timeShort(dateStr){ const d = dateStr ? new Date(dateStr) : new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

// Load users and render contacts + recent chats
async function loadUsers(){
  const { data: users, error } = await supabase.from('usuarios').select('id, username');
  if(error){ console.error('loadUsers', error); contactsListEl.innerHTML = '<li class="small-muted">Error cargando contactos</li>'; return; }
  users.forEach(u => usersMap[u.id] = u.username);
  renderContacts(users);
  await loadRecentChats();
}

function renderContacts(users){
  contactsListEl.innerHTML = '';
  const others = users.filter(u => u.id !== currentUser.id);
  if(others.length===0){ contactsListEl.innerHTML = '<li class="small-muted">No hay otros usuarios</li>'; return; }
  others.forEach(u => {
    const li = el('li', { className: 'contact-item' }, el('div', { className: 'meta' }, el('div', {}, u.username), el('div', { className: 'small-muted' }, u.id)) );
    li.onclick = () => openOrCreatePrivateChat(u.id, u.username);
    contactsListEl.appendChild(li);
  });
}

async function loadRecentChats(){
  const { data: recentMessages } = await supabase.from('new_messages').select('chat_id, created_at').order('created_at', { ascending: false });
  const unique = [];
  if(recentMessages){ for(const m of recentMessages) if(!unique.includes(m.chat_id)) unique.push(m.chat_id); }
  chatsListEl.innerHTML = '';
  for(const chatId of unique){
    const { data: members } = await supabase.from('new_chat_members').select('user_id').eq('chat_id', chatId);
    if(!members) continue;
    const other = members.find(x => x.user_id !== currentUser.id);
    if(!other) continue;
    const username = usersMap[other.user_id] || other.user_id;
    const li = el('li', { className: 'chat-item' }, el('div', { className: 'meta' }, el('div', {}, username), el('div', { className: 'small-muted' }, chatId)) );
    li.onclick = () => openChat(chatId, { id: other.user_id, username });
    chatsListEl.appendChild(li);
  }
  if(unique.length===0) chatsListEl.innerHTML = '<li class="small-muted">Aún no hay chats</li>';
}

async function openOrCreatePrivateChat(otherId, otherUsername){
  const { data: chats } = await supabase.from('new_chats').select('id').eq('type','private');
  if(chats){
    for(const c of chats){
      const { data: members } = await supabase.from('new_chat_members').select('user_id').eq('chat_id', c.id);
      if(!members) continue;
      const hasMe = members.some(m => m.user_id === currentUser.id);
      const hasOther = members.some(m => m.user_id === otherId);
      if(hasMe && hasOther) return openChat(c.id, { id: otherId, username: otherUsername });
    }
  }
  const { data: newChat, error } = await supabase.from('new_chats').insert({ type: 'private' }).select().single();
  if(error){ alert('Error creando chat: '+ error.message); return; }
  await supabase.from('new_chat_members').insert([ { chat_id: newChat.id, user_id: currentUser.id }, { chat_id: newChat.id, user_id: otherId } ]);
  openChat(newChat.id, { id: otherId, username: otherUsername });
}

async function openChat(chatId, otherUser){
  currentChatId = chatId;
  chatTitleEl.textContent = otherUser.username;
  messagesEl.innerHTML = '<div class="small-muted">Cargando mensajes...</div>';
  await loadMessages(chatId);
  subscribeToChat(chatId);
}

async function loadMessages(chatId){
  const { data: msgs, error } = await supabase.from('new_messages').select('*').eq('chat_id', chatId).order('created_at', { ascending: true });
  if(error){ console.error('loadMessages', error); messagesEl.innerHTML = '<div class="small-muted">No se pudieron cargar mensajes</div>'; return; }
  messagesEl.innerHTML = '';
  msgs.forEach(m => renderMessage(m));
}

function renderMessage(msg){
  const isMine = msg.sender_id === currentUser.id;
  const row = el('div', { className: 'msg-row' });
  const box = el('div', { className: 'msg ' + (isMine ? 'mine' : 'other') });
  if(!isMine){ const name = usersMap[msg.sender_id] || msg.sender_id; box.appendChild(el('div', { className: 'sender-name' }, name)); }
  box.appendChild(el('div', {}, msg.content));
  box.appendChild(el('div', { className: 'msg-time' }, timeShort(msg.created_at)));
  row.appendChild(box);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function subscribeToChat(chatId){
  if(realtimeChannel) supabase.removeChannel(realtimeChannel);
  realtimeChannel = supabase.channel(`chat_${chatId}`).on('postgres_changes',{ event:'INSERT', schema:'public', table:'new_messages', filter:`chat_id=eq.${chatId}` }, payload => renderMessage(payload.new)).subscribe();
}

async function sendMessage(){
  const content = messageInput.value.trim();
  if(!content || !currentChatId) return;
  const { error } = await supabase.from('new_messages').insert({ chat_id: currentChatId, sender_id: currentUser.id, content });
  if(error){ alert('Error enviando mensaje: '+error.message); return; }
  messageInput.value = '';
}

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });
searchInput.addEventListener('input',(e)=>{ const q=e.target.value.toLowerCase(); const lis=contactsListEl.querySelectorAll('li'); lis.forEach(li=>{ const txt=li.textContent.toLowerCase(); li.style.display = txt.includes(q) ? '' : 'none'; }); });

(async function init(){
  await ensureLocalUser();
  profileNameEl.textContent = currentUser.username;
  profileIdEl.textContent = currentUser.id;
  profileAvatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
  await loadUsers();
})();

function timeShort(dateStr){ const d = dateStr ? new Date(dateStr) : new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

</script>
</body>
</html>
