<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat — WhatsApp style</title>
<style>
:root {
  --green:#128c7e;
  --accent:#25d366;
  --sidebar:#075e54;
  --bg:#ece5dd;
}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  height:100vh;
  display:flex;
  background:var(--bg);
  color:#111
}
/* SIDEBAR */
#sidebar{
  width:320px;
  background:var(--sidebar);
  color:#fff;
  display:flex;
  flex-direction:column;
}
#profile{
  display:flex;
  align-items:center;
  padding:16px;
  border-bottom:1px solid rgba(255,255,255,0.06)
}
#profile .avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:#0b845f;
  margin-right:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700
}
#profile .who{font-size:14px}
#lists{
  flex:1;
  overflow:auto;
  padding:8px
}
.section-title{
  color:rgba(255,255,255,0.8);
  font-size:13px;
  margin:8px 4px
}
li{
  list-style:none;
  padding:10px;
  border-radius:8px;
  cursor:pointer;
}
li:hover{
  background:rgba(255,255,255,0.1)
}
/* MAIN */
#main{
  flex:1;
  display:flex;
  flex-direction:column;
  background:var(--bg)
}
#header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:var(--green);
  color:#fff
}
#messages{
  flex:1;
  overflow:auto;
  padding:12px
}
.message{
  max-width:66%;
  margin:8px 0;
  padding:10px 14px;
  border-radius:18px;
  word-break:break-word;
  display:inline-block;
  clear:both
}
.my-message{background:#dcf8c6;float:right}
.other-message{background:#fff;float:left}
#composer{
  display:flex;
  padding:12px;
  background:#f0f0f0;
  gap:8px
}
#message-input{
  flex:1;
  padding:12px;
  border-radius:999px;
  border:1px solid #ccc;
  outline:none
}
#send{
  padding:10px 14px;
  border-radius:999px;
  border:none;
  background:var(--green);
  color:#fff;
  cursor:pointer
}
#typing-indicator{
  font-size:12px;
  color:gray;
  margin-left:12px;
}
</style>
</head>
<body>

<aside id="sidebar">
  <div id="profile">
    <div class="avatar" id="profile-avatar">P</div>
    <div class="who">
      <div id="profile-name">Tú</div>
      <div class="small-muted" id="profile-id"></div>
    </div>
  </div>

  <div id="lists">
    <div class="section-title">CHATS</div>
    <ul id="chats-list"></ul>

    <div class="section-title">CONTACTOS</div>
    <ul id="contacts-list"></ul>
  </div>
</aside>

<main id="main">
  <div id="header">
    <div id="chat-title">Selecciona un chat</div>
    <div id="typing-indicator"></div>
  </div>

  <div id="messages"></div>

  <form id="composer" onsubmit="return false;">
    <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
    <button id="send" class="btn">Enviar</button>
  </form>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* --------------------------------------------------
  CONFIG SUPABASE
-------------------------------------------------- */
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let currentUserId = Number(localStorage.getItem("currentUser"));
if (!currentUserId) {
  currentUserId = Math.floor(Math.random() * 1000000);
  localStorage.setItem("currentUser", currentUserId);
}

let currentChatId = null;
let messageChannel = null;
let typingTimeout = null;

// DOM
const recentList   = document.getElementById("chats-list");
const allUsersList = document.getElementById("contacts-list");
const chatBox      = document.getElementById("messages");
const messageInput = document.getElementById("message-input");
const chatTitle    = document.getElementById("chat-title");
const typingIndicator = document.getElementById("typing-indicator");

/* --------------------------------------------------
  FUNCIONES AUXILIARES
-------------------------------------------------- */
function appendMessage(msg){
  const div = document.createElement("div");
  const isMine = msg.sender_id === currentUserId;
  div.className = "message " + (isMine ? "my-message" : "other-message");

  if(!isMine){
    const nameDiv = document.createElement("div");
    nameDiv.style.fontSize = "12px";
    nameDiv.style.fontWeight = "600";
    nameDiv.style.marginBottom = "4px";
    nameDiv.textContent = usersMap[msg.sender_id] || "Desconocido";
    div.appendChild(nameDiv);
  }

  const textDiv = document.createElement("div");
  textDiv.textContent = msg.content;
  div.appendChild(textDiv);

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}


/* --------------------------------------------------
  CARGAR USUARIOS Y CHATS
-------------------------------------------------- */
async function loadUsers(){
  const { data: users } = await supabase.from("usuarios").select("id,username");

  const filtered = users.filter(u => u.id !== currentUserId);

  // contactos
  allUsersList.innerHTML="";
  filtered.forEach(u=>{
    const li = document.createElement("li");
    li.textContent = u.username;
    li.onclick = ()=>openOrCreatePrivateChat(u.id,u.username);
    allUsersList.appendChild(li);
  });

  // chats recientes
  const { data: recentMsgs } = await supabase.from("new_messages").select("chat_id,created_at").order("created_at",{ascending:false});
  const recentChats = [...new Set(recentMsgs.map(m=>m.chat_id))];

  recentList.innerHTML="";
  for(const chatId of recentChats){
    const { data: members } = await supabase.from("new_chat_members").select("user_id").eq("chat_id",chatId);
    const other = members.find(m=>m.user_id!==currentUserId);
    if(!other) continue;
    const user = filtered.find(f=>f.id===other.user_id);
    if(!user) continue;
    const li = document.createElement("li");
    li.textContent = user.username;
    li.onclick = ()=>openChat(chatId,user);
    recentList.appendChild(li);
  }
}

/* --------------------------------------------------
  ABRIR CHAT PRIVADO
-------------------------------------------------- */
async function openOrCreatePrivateChat(otherId,username){
  const { data: chats } = await supabase.from("new_chats").select("id").eq("type","private");

  if(chats){
    for(const c of chats){
      const { data: members } = await supabase.from("new_chat_members").select("user_id").eq("chat_id",c.id);
      if(members.some(m=>m.user_id===currentUserId) && members.some(m=>m.user_id===otherId)){
        return openChat(c.id,{username});
      }
    }
  }

  const { data: newChat } = await supabase.from("new_chats").insert({type:"private"}).select().single();
  await supabase.from("new_chat_members").insert([
    {chat_id:newChat.id,user_id:currentUserId},
    {chat_id:newChat.id,user_id:otherId}
  ]);
  openChat(newChat.id,{username});
}

/* --------------------------------------------------
  ABRIR CHAT
-------------------------------------------------- */
async function openChat(chatId,user){
  currentChatId = chatId;
  chatBox.innerHTML="";
  chatTitle.textContent = user.username;
  typingIndicator.textContent="";
  await loadMessages(chatId);
  subscribeToChat(chatId);
}

/* --------------------------------------------------
  SUSCRIPCIÓN REALTIME
-------------------------------------------------- */
function subscribeToChat(chatId){
  if(messageChannel) supabase.removeChannel(messageChannel);

  messageChannel = supabase.channel(`chat_${chatId}`)
    .on("postgres_changes",{
      event:"INSERT",
      schema:"public",
      table:"new_messages",
      filter:`chat_id=eq.${chatId}`
    }, payload=>{
      appendMessage(payload.new);
    })
    .subscribe();
}

/* --------------------------------------------------
  CARGAR MENSAJES
-------------------------------------------------- */
// Cargar mensajes históricos
async function loadMessages(chatId){
  const { data: messages } = await supabase
    .from("new_messages")
    .select("*")
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  chatBox.innerHTML = "";
  messages.forEach(msg => appendMessage(msg));
}

// Suscribirse a realtime
function subscribeToChat(chatId){
  if(messageChannel) supabase.removeChannel(messageChannel);

  messageChannel = supabase
    .channel(`chat_${chatId}`)
    .on(
      "postgres_changes",
      {
        event: "INSERT",
        schema: "public",
        table: "new_messages",
        filter: `chat_id=eq.${chatId}`
      },
      payload => appendMessage(payload.new)
    )
    .subscribe();
}


/* --------------------------------------------------
  ENVIAR MENSAJE
-------------------------------------------------- */
async function sendMessage(){
  const content = messageInput.value.trim();
  if(!content || !currentChatId) return;

  await supabase.from("new_messages").insert({
    chat_id: currentChatId,
    sender_id: currentUserId,
    content
  });

  messageInput.value="";
}

/* --------------------------------------------------
  EVENTOS
-------------------------------------------------- */
messageInput.addEventListener("keypress",e=>{
  if(e.key==="Enter"){ sendMessage(); }
});

/* --------------------------------------------------
  INICIAR TODO
-------------------------------------------------- */
loadUsers();
</script>
</body>
</html>
