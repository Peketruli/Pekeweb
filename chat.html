<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zona de Chat</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    background: #1e1e1e;
    color: #fff;
  }

  /* Sidebar de chats */
  #chat-list {
    width: 250px;
    background: #2c2c2c;
    overflow-y: auto;
    padding: 10px;
  }

  #chat-list h2 {
    text-align: center;
    margin: 10px 0;
  }

  .chat-item {
    padding: 8px;
    margin-bottom: 5px;
    cursor: pointer;
    border-radius: 5px;
    background: #3a3a3a;
  }

  .chat-item:hover {
    background: #505050;
  }

  /* Chat principal */
  #chat-window {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
    border: 1px solid #444;
    border-radius: 5px;
    margin-bottom: 10px;
    background: #252525;
  }

  .message {
    margin-bottom: 8px;
    padding: 5px 10px;
    border-radius: 8px;
    max-width: 70%;
    word-wrap: break-word;
  }

  .my-message {
    background: #0b93f6;
    margin-left: auto;
  }

  .other-message {
    background: #3a3a3a;
    margin-right: auto;
  }

  /* Input para escribir */
  #message-form {
    display: flex;
  }

  #message-input {
    flex: 1;
    padding: 8px;
    border-radius: 5px 0 0 5px;
    border: none;
    outline: none;
  }

  #send-btn {
    padding: 8px 15px;
    border: none;
    background: #0b93f6;
    color: #fff;
    cursor: pointer;
    border-radius: 0 5px 5px 0;
  }

  #send-btn:hover {
    background: #0873c8;
  }

  /* Modal para crear grupo */
  #group-modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
  }

  #group-modal-content {
    background: #2c2c2c;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
  }

  #group-modal-content input,
  #group-modal-content select {
    width: 100%;
    padding: 5px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    outline: none;
  }

  #group-modal-content button {
    padding: 8px;
    width: 100%;
    border: none;
    border-radius: 5px;
    background: #0b93f6;
    color: #fff;
    cursor: pointer;
  }

  #group-modal-content button:hover {
    background: #0873c8;
  }

</style>
</head>
<body>

  <!-- Sidebar de chats -->
  <div id="chat-list">
    <h2>Chats</h2>
    <div id="chats-container"></div>
    <button id="create-group-btn">Crear Grupo</button>
  </div>

  <!-- Chat principal -->
  <div id="chat-window">
    <div id="messages"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="Escribe un mensaje..." autocomplete="off">
      <button type="submit" id="send-btn">Enviar</button>
    </form>
  </div>

  <!-- Modal para crear grupo -->
  <div id="group-modal">
    <div id="group-modal-content">
      <h3>Crear Grupo</h3>
      <input type="text" id="group-name" placeholder="Nombre del grupo">
      <select id="group-members" multiple size="5">
        <!-- Lista de usuarios -->
      </select>
      <button id="create-group-confirm">Crear Grupo</button>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ------------------------------
  // 1️⃣ Configuración Supabase
  // ------------------------------
  const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ------------------------------
  // 2️⃣ Usuario actual desde localStorage
  // ------------------------------
  const currentUserId = localStorage.getItem('userId');
  const currentUsername = localStorage.getItem('username');

  // ------------------------------
  // 3️⃣ Variables globales
  // ------------------------------
  let currentChatId = null;
  const chatsContainer = document.getElementById('chats-container');
  const messagesEl = document.getElementById('messages');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');

  const groupModal = document.getElementById('group-modal');
  const createGroupBtn = document.getElementById('create-group-btn');
  const createGroupConfirm = document.getElementById('create-group-confirm');
  const groupNameInput = document.getElementById('group-name');
  const groupMembersSelect = document.getElementById('group-members');

  // ------------------------------
  // 4️⃣ Función: Mostrar mensaje en UI
  // ------------------------------
  function addMessageToUI(message) {
    const isMe = message.sender_id === currentUserId;
    const msgEl = document.createElement('div');
    msgEl.classList.add('message');
    msgEl.classList.add(isMe ? 'my-message' : 'other-message');
    msgEl.innerHTML = `<strong>${message.sender_name || 'Anon'}:</strong> ${message.content}`;
    messagesEl.appendChild(msgEl);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ------------------------------
  // 5️⃣ Función: Cargar mensajes de un chat
  // ------------------------------
  async function loadMessages(chatId) {
    messagesEl.innerHTML = '';
    const { data: messages, error } = await supabase
      .from('messages')
      .select('*')
      .eq('chat_id', chatId)
      .order('created_at', { ascending: true });

    if (error) console.error(error);
    messages.forEach(addMessageToUI);

    // Realtime listener
    supabase.removeAllChannelSubscriptions(); // limpiar listeners anteriores
    supabase.channel('chat-' + chatId)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, payload => {
        addMessageToUI(payload.new);
      })
      .subscribe();
  }

  // ------------------------------
  // 6️⃣ Función: Cargar lista de chats
  // ------------------------------
  async function loadChats() {
    chatsContainer.innerHTML = '';
    const { data: chats, error } = await supabase
      .from('chat_members')
      .select('chat_id, chats(type,name)')
      .eq('user_id', currentUserId);

    if (error) console.error(error);

    chats.forEach(item => {
      const chatEl = document.createElement('div');
      chatEl.classList.add('chat-item');
      const chatName = item.chats.type === 'private' ? 'Chat privado' : item.chats.name;
      chatEl.textContent = chatName;
      chatEl.onclick = () => {
        currentChatId = item.chat_id;
        loadMessages(currentChatId);
      };
      chatsContainer.appendChild(chatEl);
    });
  }

  // ------------------------------
  // 7️⃣ Enviar mensaje
  // ------------------------------
  messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text || !currentChatId) return;

    const { error } = await supabase.from('messages').insert([{
      chat_id: currentChatId,
      sender_id: currentUserId,
      sender_name: currentUsername,
      content: text
    }]);
    if (error) console.error(error);
    messageInput.value = '';
  });

  // ------------------------------
  // 8️⃣ Crear chat privado
  // ------------------------------
  async function createPrivateChat(otherUserId) {
    // Crear chat
    const { data: chat } = await supabase.from('chats').insert({ type: 'private' }).select().single();
    // Añadir miembros
    await supabase.from('chat_members').insert([
      { chat_id: chat.id, user_id: currentUserId },
      { chat_id: chat.id, user_id: otherUserId }
    ]);
    loadChats();
    return chat.id;
  }

  // ------------------------------
  // 9️⃣ Crear grupo
  // ------------------------------
  createGroupBtn.addEventListener('click', () => {
    groupModal.style.display = 'flex';
    loadUsersIntoSelect();
  });

  createGroupConfirm.addEventListener('click', async () => {
    const groupName = groupNameInput.value.trim();
    const selectedOptions = Array.from(groupMembersSelect.selectedOptions).map(opt => opt.value);
    if (!groupName || selectedOptions.length === 0) return;

    const { data: chat } = await supabase.from('chats').insert({
      type: 'group',
      name: groupName,
      owner: currentUserId
    }).select().single();

    const members = selectedOptions.map(uid => ({ chat_id: chat.id, user_id: uid }));
    members.push({ chat_id: chat.id, user_id: currentUserId }); // agregar creador
    await supabase.from('chat_members').insert(members);

    groupModal.style.display = 'none';
    groupNameInput.value = '';
    loadChats();
  });

  // Cerrar modal si clic fuera del contenido
  groupModal.addEventListener('click', (e) => {
    if (e.target === groupModal) groupModal.style.display = 'none';
  });

  // ------------------------------
  // 10️⃣ Cargar usuarios en select (simulado)
  // ------------------------------
  async function loadUsersIntoSelect() {
    groupMembersSelect.innerHTML = '';
    // Aquí deberías traer tus usuarios desde Supabase o tu propia lista
    const users = [
      { id: 'user1', name: 'Alice' },
      { id: 'user2', name: 'Bob' },
      { id: 'user3', name: 'Charlie' }
    ];

    users.forEach(u => {
      if (u.id !== currentUserId) {
        const option = document.createElement('option');
        option.value = u.id;
        option.textContent = u.name;
        groupMembersSelect.appendChild(option);
      }
    });
  }

  // ------------------------------
  // 11️⃣ Inicialización
  // ------------------------------
  loadChats();
</script>
</body>
</html>
