<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat â€” WhatsApp style</title>
<style>
  :root{--green:#128c7e;--accent:#25d366;--sidebar:#075e54;--bg:#ece5dd;}
  body{margin:0;font-family:Inter,Arial,sans-serif;height:100vh;display:flex;background:var(--bg);color:#111}
  /* SIDEBAR */
  #sidebar{width:320px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
  #profile{display:flex;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,0.06)}
  #profile .avatar{width:48px;height:48px;border-radius:50%;background:#0b845f;margin-right:12px;display:flex;align-items:center;justify-content:center;font-weight:700}
  #profile .who{font-size:14px}
  #sidebar-controls{display:flex;gap:8px;padding:12px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-green{background:var(--accent);color:#fff}
  .btn-light{background:#34b7f1;color:#fff}
  #search-contacts{margin:0 12px 8px;padding:8px;border-radius:8px;border:none}
  #lists{flex:1;overflow:auto;padding:8px}
  .section-title{color:rgba(255,255,255,0.8);font-size:13px;margin:8px 4px}
  .chat-item, .contact-item{background:transparent;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .chat-item:hover, .contact-item:hover{background:rgba(255,255,255,0.04)}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.7)}
  /* MAIN */
  #main{flex:1;display:flex;flex-direction:column;background:var(--bg)}
  #header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--green);color:#fff}
  #messages{flex:1;overflow:auto;padding:18px}
  .message{max-width:66%;margin:8px 0;padding:10px 14px;border-radius:18px;word-break:break-word;display:inline-block;clear:both}
  .my-message{background:#dcf8c6;float:right}
  .other-message{background:#fff;float:left}
  #composer{display:flex;padding:12px;background:#f0f0f0;gap:8px}
  #message-input{flex:1;padding:12px;border-radius:999px;border:1px solid #ccc;outline:none}
  #send{padding:10px 14px;border-radius:999px;border:none;background:var(--green);color:#fff;cursor:pointer}
  /* MODALS */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)}
  .card{background:#fff;border-radius:10px;padding:16px;width:360px;max-width:94%}
  .card h3{margin-top:0}
  .modal .list{max-height:260px;overflow:auto}
  /* members modal */
  #members-list div{padding:8px;border-bottom:1px solid #eee}
  /* small responsive */
  @media (max-width:900px){#sidebar{width:260px}}
  @media (max-width:700px){#sidebar{display:none}}
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div id="profile">
      <div class="avatar" id="profile-avatar">P</div>
      <div class="who">
        <div id="profile-name">TÃº</div>
        <div class="small-muted" id="profile-id"></div>
      </div>
    </div>

    <div id="sidebar-controls">
      <button id="btn-add-contact" class="btn btn-light">Agregar contacto</button>
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search-contacts" placeholder="Buscar contactos..." />

    <div id="lists">
      <div class="section-title">CHATS</div>
      <div id="chats-list"></div>

      <div class="section-title" style="margin-top:12px">CONTACTOS</div>
      <div id="contacts-list"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="main">
    <div id="header">
      <div id="chat-title">Selecciona un chat</div>
      <div>
        <button id="btn-members" class="btn btn-light">Miembros</button>
      </div>
    </div>

    <div id="messages"></div>

    <form id="composer" onsubmit="return false;">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <button id="send" class="btn">Enviar</button>
    </form>
  </main>

  <!-- MODALS -->
  <div id="modal-create-group" class="modal">
    <div class="card">
      <h3>Crear grupo</h3>
      <input id="group-name" placeholder="Nombre del grupo" />
      <div style="margin-top:8px" class="small-muted">Selecciona miembros:</div>
      <div class="list" id="group-members-list"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="confirm-create-group" class="btn btn-green">Crear</button>
        <button id="cancel-create-group" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-members" class="modal">
    <div class="card">
      <h3>Miembros</h3>
      <div id="members-list"></div>
      <div style="margin-top:10px;text-align:right"><button id="close-members" class="btn">Cerrar</button></div>
    </div>
  </div>

 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// =====================================
// 1ï¸âƒ£ LOGIN AUTOMÃTICO POR DISPOSITIVO
// =====================================
let currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser) {
  currentUser = {
    id: crypto.randomUUID(),
    name: "Usuario-" + Math.floor(Math.random() * 9999)
  };
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}
console.log("SesiÃ³n iniciada como:", currentUser);

// =====================================
// 2ï¸âƒ£ CONFIG SUPABASE
// =====================================
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "TU_SUPABASE_KEY_AQUI"; // Reemplaza con tu clave real
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// =====================================
// 3ï¸âƒ£ CONEXIÃ“N WEBSOCKET
// =====================================
const socket = new WebSocket("ws://localhost:8080");

socket.onopen = () => {
  console.log("ðŸŸ¢ Conectado al servidor");

  // Mandamos login al servidor
  socket.send(JSON.stringify({
    type: "login",
    userId: currentUser.id,
    name: currentUser.name
  }));
};

socket.onclose = () => console.log("ðŸ”´ Desconectado del servidor");
socket.onerror = err => console.error("âš  Error WS:", err);

// =====================================
// 4ï¸âƒ£ CARGAR USUARIOS DESDE SUPABASE
// =====================================
async function loadUsers() {
  const { data: users, error } = await supabase
    .from("usuarios")
    .select("id, username");

  if (error) {
    alert("Error cargando usuarios desde Supabase");
    return;
  }

  const filteredUsers = users.filter(u => u.id !== currentUser.id);

  renderUserList(filteredUsers);
}

// =====================================
// 5ï¸âƒ£ LISTA DE USUARIOS
// =====================================
let selectedUser = null;
function renderUserList(users) {
  const container = document.getElementById("userList");
  container.innerHTML = "";

  users.forEach(user => {
    const btn = document.createElement("button");
    btn.className = "contact";
    btn.textContent = user.username;

    btn.onclick = () => {
      selectedUser = user;
      document.getElementById("chatTitle").textContent = "Chat con " + user.username;
      document.getElementById("messages").innerHTML = "";
    };

    container.appendChild(btn);
  });
}

// =====================================
// 6ï¸âƒ£ RECIBIR MENSAJES WS (SOLO PARA MÃ)
// =====================================
socket.onmessage = (event) => {
  const msg = JSON.parse(event.data);

  if (msg.type === "user_list") {
    renderUserList(msg.users);
    return;
  }

  if (msg.type === "private_message") {
    if (msg.to === currentUser.id) {
      addMessageToChat(msg.from, msg.text, false);
    }
  }
};

// =====================================
// 7ï¸âƒ£ ENVIAR MENSAJE PRIVADO
// =====================================
function sendMessage() {
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if (!text || !selectedUser) return;

  // Guardar en Supabase
  supabase.from("new_messages").insert({
    chat_id: crypto.randomUUID(), // o tu lÃ³gica de chat existente
    sender_id: currentUser.id,
    receiver_id: selectedUser.id,
    content: text
  });

  // Enviar al servidor WS
  socket.send(JSON.stringify({
    type: "private_message",
    from: currentUser.id,
    to: selectedUser.id,
    text
  }));

  // Mostrar en mi chat
  addMessageToChat(currentUser.id, text, true);
  input.value = "";
}

// =====================================
// 8ï¸âƒ£ MOSTRAR MENSAJES EN PANTALLA
// =====================================
function addMessageToChat(from, text, isMine) {
  const box = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = isMine ? "msg mine" : "msg other";
  div.textContent = text;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// =====================================
// 9ï¸âƒ£ EVENTOS BOTÃ“N ENVIAR
// =====================================
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("msgInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

// =====================================
//  ðŸ”Ÿ INICIAR
// =====================================
loadUsers();
</script>
</body>
</html>
