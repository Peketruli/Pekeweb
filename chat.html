<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PekeChat — v1</title>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #111;
      color: #fff;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* PANEL DE CONTACTOS */
    #usersPanel {
      width: 30%;
      background: #181818;
      border-right: 1px solid #333;
      overflow-y: auto;
    }

    .user {
      padding: 15px;
      cursor: pointer;
      border-bottom: 1px solid #222;
    }
    .user:hover {
      background: #242424;
    }

    /* PANEL DEL CHAT */
    #chatPanel {
      width: 70%;
      display: flex;
      flex-direction: column;
      background: #121212;
    }

    #chatHeader {
      padding: 15px;
      background: #1e1e1e;
      border-bottom: 1px solid #333;
      font-weight: bold;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .msg {
      max-width: 70%;
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      line-height: 1.4;
    }

    .mine {
      background: #005cff;
      margin-left: auto;
    }

    .other {
      background: #333;
      margin-right: auto;
    }

    /* ENVIAR MENSAJE */
    #inputBar {
      display: flex;
      padding: 10px;
      border-top: 1px solid #333;
      background: #1e1e1e;
    }

    #msgInput {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      outline: none;
    }

    #sendBtn {
      margin-left: 10px;
      padding: 10px 15px;
      background: #005cff;
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
    }

  </style>
</head>
<body>

  <!-- PANEL USUARIOS -->
  <div id="usersPanel">
    <h3 style="padding:15px;margin:0;border-bottom:1px solid #333;">Usuarios</h3>
    <div id="usersList"></div>
  </div>

  <!-- PANEL CHAT -->
  <div id="chatPanel">
    <div id="chatHeader">Selecciona un usuario</div>
    <div id="messages"></div>

    <div id="inputBar">
      <input id="msgInput" placeholder="Escribe un mensaje..." />
      <button id="sendBtn">Enviar</button>
    </div>
  </div>
<script>
  // ---------------------------------------------------------------
// 1. CONFIGURACIÓN SUPABASE
// ---------------------------------------------------------------
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ---------------------------------------------------------------
// 2. SESSION
// ---------------------------------------------------------------
let currentUserId = localStorage.getItem("currentUser");
let currentUsername = localStorage.getItem("currentUsername");

if (!currentUserId) {
  alert("❌ No hay usuario logueado.");
}

// ---------------------------------------------------------------
// ELEMENTOS DEL DOM
// ---------------------------------------------------------------
const contactsList = document.getElementById("contacts-list");
const chatTitle = document.getElementById("chat-title");
const messagesBox = document.getElementById("messages");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const myNameTag = document.getElementById("my-name");

// Mostrar nombre del usuario logueado
if (myNameTag) {
  myNameTag.textContent = currentUsername || "Usuario";
}

let currentChatId = null;
let realtimeChannel = null;

// ---------------------------------------------------------------
// 3. CARGAR CONTACTOS
// ---------------------------------------------------------------
async function loadContacts() {
  const { data: users, error } = await supabase
    .from("usuarios")
    .select("id, username");

  if (error) {
    alert("Error cargando usuarios");
    return;
  }

  const filtered = users.filter(u => u.id !== currentUserId);

  contactsList.innerHTML = "";
  filtered.forEach(user => {
    const li = document.createElement("li");
    li.textContent = user.username;
    li.onclick = () => openOrCreateChat(user.id, user.username);
    contactsList.appendChild(li);
  });
}

// ---------------------------------------------------------------
// 4. CREAR O ABRIR CHAT PRIVADO
// ---------------------------------------------------------------
async function openOrCreateChat(otherUserId, otherUsername) {
  chatTitle.textContent = otherUsername;

  // Buscar si ya existe un chat privado entre ambos
  const { data: chats } = await supabase
    .from("chats")
    .select("id, type")
    .eq("type", "private");

  if (chats) {
    for (const chat of chats) {
      const { data: members } = await supabase
        .from("chat_members")
        .select("user_id")
        .eq("chat_id", chat.id);

      if (!members) continue;

      const hasMe = members.some(m => m.user_id === currentUserId);
      const hasOther = members.some(m => m.user_id === otherUserId);

      if (hasMe && hasOther) {
        return openChat(chat.id);
      }
    }
  }

  // No existe → crearlo
  const { data: newChat } = await supabase
    .from("chats")
    .insert({ type: "private" })
    .select()
    .single();

  await supabase.from("chat_members").insert([
    { chat_id: newChat.id, user_id: currentUserId },
    { chat_id: newChat.id, user_id: otherUserId }
  ]);

  openChat(newChat.id);
}

// ---------------------------------------------------------------
// 5. ABRIR UN CHAT
// ---------------------------------------------------------------
async function openChat(chatId) {
  currentChatId = chatId;

  messagesBox.innerHTML = "";
  await loadMessages(chatId);
  subscribeToChat(chatId);
}

// ---------------------------------------------------------------
// 6. CARGAR MENSAJES DE UN CHAT
// ---------------------------------------------------------------
async function loadMessages(chatId) {
  const { data: msgs } = await supabase
    .from("messages")
    .select("*")
    .eq("chat_id", chatId)
    .order("created_at", { ascending: true });

  messagesBox.innerHTML = "";
  msgs.forEach(renderMessage);
}

// ---------------------------------------------------------------
// 7. MOSTRAR MENSAJE EN PANTALLA
// ---------------------------------------------------------------
function renderMessage(msg) {
  const div = document.createElement("div");
  div.classList.add("message");

  if (msg.sender_id === currentUserId) {
    div.classList.add("my-message");  
    div.textContent = `${currentUsername}: ${msg.content}`;
  } else {
    div.classList.add("other-message");
    div.textContent = `${msg.sender_name}: ${msg.content}`;
  }

  messagesBox.appendChild(div);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ---------------------------------------------------------------
// 8. REALTIME
// ---------------------------------------------------------------
function subscribeToChat(chatId) {
  if (realtimeChannel) {
    supabase.removeChannel(realtimeChannel);
  }

  realtimeChannel = supabase
    .channel(`chat_${chatId}`)
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages", filter: `chat_id=eq.${chatId}` },
      payload => renderMessage(payload.new)
    )
    .subscribe();
}

// ---------------------------------------------------------------
// 9. ENVIAR MENSAJE
// ---------------------------------------------------------------
async function sendMessage() {
  const content = messageInput.value.trim();
  if (!content || !currentChatId) return;

  await supabase.from("messages").insert({
    chat_id: currentChatId,
    sender_id: currentUserId,
    sender_name: currentUsername,
    content
  });

  messageInput.value = "";
}

sendBtn.onclick = sendMessage;
messageInput.onkeydown = e => {
  if (e.key === "Enter") sendMessage();
};

// ---------------------------------------------------------------
// 10. INICIAR
// ---------------------------------------------------------------
loadContacts();

</script>
</body>
</html>
