<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat â€” WhatsApp style (Clean)</title>

<style>
  :root{--bg:#ece5dd;--sidebar:#075e54;--accent:#25d366;--green:#128c7e;--card:#fff;--muted:#7a7a7a}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{background:var(--bg);display:flex;align-items:stretch;color:#111}

  .app{display:flex;height:100vh;width:100%;max-width:1200px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,.12);border-radius:8px;overflow:hidden;background:#fff}
  .sidebar{width:340px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
  .main{flex:1;display:flex;flex-direction:column;background:var(--bg)}

  .profile{display:flex;align-items:center;padding:18px;border-bottom:1px solid rgba(255,255,255,0.06)}
  .avatar{width:48px;height:48px;border-radius:50%;background:#0b845f;display:flex;align-items:center;justify-content:center;font-weight:700;margin-right:12px}
  .who .name{font-weight:700}
  .who .id{font-size:12px;color:rgba(255,255,255,0.8);word-break:break-all}

  .sidebar-controls{display:flex;gap:8px;padding:12px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-light{background:#34b7f1;color:#fff}
  .btn-green{background:var(--accent);color:#fff}
  .search{margin:8px 12px;padding:8px;border-radius:8px;border:none;width:calc(100% - 24px)}

  .lists{flex:1;overflow:auto;padding:8px}
  .section-title{color:rgba(255,255,255,0.85);font-size:12px;margin:6px 6px}
  ul{list-style:none;padding:0;margin:0}
  .contact-item,.chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;cursor:pointer;color:#fff;margin:4px 6px}
  .contact-item:hover,.chat-item:hover{background:rgba(255,255,255,0.04)}
  .meta{display:flex;flex-direction:column}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.7)}

  .header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--green);color:#fff}
  .title{font-weight:700}
  .typing{font-size:12px;color:rgba(255,255,255,0.85)}

  .messages{flex:1;overflow:auto;padding:18px;background:var(--bg)}
  .msg-row{display:flex;margin:8px 0;align-items:flex-end}
  .msg{max-width:68%;padding:10px 14px;border-radius:14px;word-break:break-word;line-height:1.3}
  .mine{margin-left:auto;background:#dcf8c6}
  .other{margin-right:auto;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,0.04)}
  .sender-name{font-size:12px;font-weight:700;margin-bottom:6px;color:#222}
  .msg-time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}

  .composer{display:flex;gap:8px;padding:12px;background:#f0f0f0;align-items:center}
  .composer input{flex:1;padding:12px;border-radius:999px;border:1px solid #ccc;outline:none}
  .composer button{padding:10px 14px;border-radius:999px;border:none;background:var(--green);color:#fff;cursor:pointer}

  @media(max-width:900px){.sidebar{width:260px}}
  @media(max-width:700px){.app{flex-direction:column;height:100%}.sidebar{width:100%;height:260px}.main{height:calc(100% - 260px)}}
</style>
</head>
<body>

<div class="app" id="app">
  <aside class="sidebar">
    <div class="profile">
      <div class="avatar" id="profile-avatar">?</div>
      <div class="who">
        <div class="name" id="profile-name">Cargando...</div>
        <div class="id small-muted" id="profile-id"></div>
      </div>
    </div>

    <div class="sidebar-controls">
      
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search" class="search" placeholder="Buscar contactos..." />

    <div class="lists">
      <div class="section-title">CHATS</div>
      <ul id="chats-list"></ul>

      <div class="section-title" style="margin-top:14px">CONTACTOS</div>
      <ul id="contacts-list"></ul>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="title" id="chat-title">Selecciona un chat</div>
        <div class="typing" id="typing"></div>
      </div>
      <div></div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off" />
      <button id="send">Enviar</button>
    </div>
  </main>

  <!-- MODAL CREAR GRUPO -->
  <div id="groupModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50;">
    <div style="background:#fff;width:360px;padding:20px;border-radius:12px;color:#111;max-height:80%;overflow:auto;">
      <h3 style="margin-top:0;margin-bottom:10px;">Crear grupo</h3>

      <label>Nombre del grupo</label>
      <input id="group-name" placeholder="Mi grupo" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin:6px 0 14px 0;" />

      <h4 style="margin:6px 0 6px 0;">Selecciona usuarios</h4>
      <div id="group-users" style="border:1px solid #ccc;border-radius:8px;padding:10px;max-height:200px;overflow:auto;"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:18px;">
        <button id="group-cancel" style="padding:8px 12px;border:none;border-radius:8px;background:#ccc;cursor:pointer;">Cancelar</button>
        <button id="group-create" style="padding:8px 12px;border:none;border-radius:8px;background:#25d366;color:#fff;cursor:pointer;">Crear</button>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM
const profileNameEl = document.getElementById('profile-name');
const profileIdEl = document.getElementById('profile-id');
const profileAvatarEl = document.getElementById('profile-avatar');
const contactsListEl = document.getElementById('contacts-list');
const chatsListEl = document.getElementById('chats-list');
const messagesEl = document.getElementById('messages');
const chatTitleEl = document.getElementById('chat-title');
const typingEl = document.getElementById('typing');
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send');
const searchInput = document.getElementById('search');

// State
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
const usersMap = {};
let currentChatId = null;
let realtimeChannel = null;

// Ensure local user exists and upsert to DB
async function ensureLocalUser(){
  if (currentUser && currentUser.id && currentUser.username) return;
  const id = crypto.randomUUID();
  const username = 'Usuario-' + Math.floor(Math.random()*9000 + 1000);
  currentUser = { id, username };
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  try{
    await supabase.from('usuarios').upsert([{ id: currentUser.id, username: currentUser.username }], { onConflict: 'id' });
  }catch(e){console.warn('upsert user failed', e)}
}

function el(tag, props = {}, ...children){ const d = document.createElement(tag); for(const k in props) d[k] = props[k]; for(const c of children) if(typeof c==='string') d.appendChild(document.createTextNode(c)); else d.appendChild(c); return d; }
function timeShort(dateStr){ const d = dateStr ? new Date(dateStr) : new Date(); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

// ======= GROUP MODAL LOGIC =======
const groupModal = document.getElementById('groupModal');
const groupUsersContainer = document.getElementById('group-users');
const groupNameInput = document.getElementById('group-name');
const groupCancelBtn = document.getElementById('group-cancel');
const groupCreateBtn = document.getElementById('group-create');
const btnCreateGroup = document.getElementById('btn-create-group');

// Open modal and populate users
btnCreateGroup.addEventListener('click', async () => {
  // ensure usersMap loaded
  if(Object.keys(usersMap).length <= 1){
    await loadUsers();
  }

  groupUsersContainer.innerHTML = '';

  // Add checkbox for each user except current
  for(const [id, username] of Object.entries(usersMap)){
    if(id === currentUser.id) continue;
    const idSafe = id.replace(/[^a-zA-Z0-9_-]/g, '_');
    const row = el('div', {},
      el('label', {},
        el('input', { type: 'checkbox', id: 'g_user_' + idSafe, value: id }),
        ' ', username
      )
    );
    groupUsersContainer.appendChild(row);
  }

  groupNameInput.value = '';
  groupModal.style.display = 'flex';
});

groupCancelBtn.addEventListener('click', () => {
  groupModal.style.display = 'none';
});

// Create group
groupCreateBtn.addEventListener('click', async () => {
  const name = groupNameInput.value.trim();
  if(!name){ alert('Pon un nombre para el grupo'); return; }

  // collect selected user ids
  const selected = Array.from(groupUsersContainer.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  if(selected.length === 0){ if(!confirm('Crear grupo sin miembros adicionales?')) return; }

  // include current user as member
  const members = Array.from(new Set([ currentUser.id, ...selected ]));

  // create group chat
  const { data: newChat, error: chatErr } = await supabase.from('new_chats').insert({ type: 'group', name }).select().single();
  if(chatErr){ alert('Error creando grupo: ' + chatErr.message); return; }

  // insert members
  const rows = members.map(uid => ({ chat_id: newChat.id, user_id: uid }));
  const { error: membersErr } = await supabase.from('new_chat_members').insert(rows);
  if(membersErr){ alert('Error agregando miembros: ' + membersErr.message); return; }

  // close modal, refresh chats and open
  groupModal.style.display = 'none';
  await loadRecentChats();
  openChat(newChat.id, { id: null, username: name });
});

</script>
</body>
</html>
