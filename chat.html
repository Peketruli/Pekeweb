<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PekeChat — WhatsApp style</title>
<style>
  :root {
    --green: #128c7e;
    --accent: #25d366;
    --sidebar: #075e54;
    --bg: #ece5dd;
  }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    background: var(--bg);
  }

  /* Sidebar */
  #sidebar {
    width: 320px;
    background: var(--sidebar);
    color: white;
    display: flex;
    flex-direction: column;
  }
  #profile {
    display: flex;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  #profile .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #0b845f;
    margin-right: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }
  #sidebar-controls {
    display: flex;
    gap: 8px;
    padding: 12px;
  }
  .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
  .btn-green { background: var(--accent); color: #fff; }
  .btn-light { background: #34b7f1; color: #fff; }
  #search-contacts { margin: 0 12px 8px; padding: 8px; border-radius: 8px; border: none; }
  #lists { flex: 1; overflow: auto; padding: 8px; }
  .section-title { color: rgba(255,255,255,0.8); font-size: 13px; margin: 8px 4px; }
  li { list-style: none; padding: 8px; cursor: pointer; border-radius: 8px; }
  li:hover { background: rgba(255,255,255,0.1); }

  /* Main */
  #main { flex: 1; display: flex; flex-direction: column; }
  #header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--green); color: #fff; }
  #messages { flex: 1; overflow-y: auto; padding: 18px; background: var(--bg); }
  .message {
    max-width: 70%;
    margin: 8px 0;
    padding: 10px 14px;
    border-radius: 18px;
    word-break: break-word;
    display: inline-block;
    clear: both;
  }
  .my-message { background: #dcf8c6; float: right; }
  .other-message { background: #fff; float: left; }

  #composer { display: flex; padding: 12px; background: #f0f0f0; gap: 8px; }
  #message-input { flex: 1; padding: 12px; border-radius: 999px; border: 1px solid #ccc; outline: none; }
  #send { padding: 10px 14px; border-radius: 999px; border: none; background: var(--green); color: #fff; cursor: pointer; }
</style>
</head>
<body>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="profile">
      <div class="avatar" id="profile-avatar">P</div>
      <div>
        <div id="profile-name">Tú</div>
        <div class="small-muted" id="profile-id"></div>
      </div>
    </div>

    <div id="sidebar-controls">
      <button id="btn-add-contact" class="btn btn-light">Agregar contacto</button>
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search-contacts" placeholder="Buscar contactos..." />

    <div id="lists">
      <div class="section-title">CHATS</div>
      <ul id="chats-list"></ul>
      <div class="section-title" style="margin-top:12px;">CONTACTOS</div>
      <ul id="contacts-list"></ul>
    </div>
  </aside>

  <!-- Main Chat -->
  <main id="main">
    <div id="header">
      <div id="chat-title">Selecciona un chat</div>
    </div>
    <div id="messages"></div>
    <form id="composer" onsubmit="return false;">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <button id="send" class="btn">Enviar</button>
    </form>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------------------------------------------
    // 1️⃣ CONFIG SUPABASE
    // ---------------------------------------------
    const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; // Cambia esto
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Usuario actual
    let currentUserId = localStorage.getItem("currentUser");
    if (!currentUserId) {
      currentUserId = crypto.randomUUID();
      localStorage.setItem("currentUser", currentUserId);
    }

    const chatsList = document.getElementById("chats-list");
    const contactsList = document.getElementById("contacts-list");
    const messagesBox = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    let currentChatId = null;
    let messageChannel = null;
    let usersMap = {};

    // ---------------------------------------------
    // 2️⃣ CARGAR USUARIOS
    // ---------------------------------------------
    async function loadUsers() {
      const { data: users } = await supabase.from("usuarios").select("id, username");
      usersMap = {};
      users.forEach(u => usersMap[u.id] = u.username);

      // Lista contactos
      contactsList.innerHTML = "";
      users.filter(u => u.id !== currentUserId).forEach(user => {
        const li = document.createElement("li");
        li.textContent = user.username;
        li.onclick = () => openOrCreatePrivateChat(user.id, user.username);
        contactsList.appendChild(li);
      });
    }

    // ---------------------------------------------
    // 3️⃣ ABRIR O CREAR CHAT PRIVADO
    // ---------------------------------------------
    async function openOrCreatePrivateChat(otherUserId, username) {
      // Buscar chat privado existente
      const { data: chats } = await supabase.from("new_chats").select("id").eq("type","private");
      for (const chat of chats) {
        const { data: members } = await supabase.from("new_chat_members").select("user_id").eq("chat_id", chat.id);
        const hasMe = members.some(m => m.user_id === currentUserId);
        const hasOther = members.some(m => m.user_id === otherUserId);
        if (hasMe && hasOther) return openChat(chat.id, {username});
      }

      // Crear chat nuevo
      const { data: newChat } = await supabase.from("new_chats").insert({ type: "private" }).select().single();
      await supabase.from("new_chat_members").insert([{ chat_id: newChat.id, user_id: currentUserId }, { chat_id: newChat.id, user_id: otherUserId }]);
      openChat(newChat.id, { username });
    }

    // ---------------------------------------------
    // 4️⃣ ABRIR CHAT
    // ---------------------------------------------
    async function openChat(chatId, user) {
      currentChatId = chatId;
      document.getElementById("chat-title").textContent = "Chat con " + user.username;
      messagesBox.innerHTML = "";
      await loadMessages(chatId);
      subscribeToChat(chatId);
    }

    // ---------------------------------------------
    // 5️⃣ SUSCRIPCIÓN REALTIME
    // ---------------------------------------------
    function subscribeToChat(chatId) {
      if (messageChannel) supabase.removeChannel(messageChannel);
      messageChannel = supabase.channel(`chat_${chatId}`)
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "new_messages", filter:`chat_id=eq.${chatId}`}, payload=>{
          const msg = payload.new;
          appendMessage(msg.sender_id, msg.content);
        })
        .subscribe();
    }

    function appendMessage(senderId, content) {
      const div = document.createElement("div");
      div.className = "message " + (senderId === currentUserId ? "my-message" : "other-message");
      if(senderId !== currentUserId) div.textContent = usersMap[senderId]+": "+content;
      else div.textContent = content;
      messagesBox.appendChild(div);
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // ---------------------------------------------
    // 6️⃣ CARGAR MENSAJES HISTÓRICOS
    // ---------------------------------------------
    async function loadMessages(chatId) {
      const { data: msgs } = await supabase.from("new_messages").select("*").eq("chat_id", chatId).order("created_at", {ascending:true});
      msgs.forEach(m=>appendMessage(m.sender_id, m.content));
    }

    // ---------------------------------------------
    // 7️⃣ ENVIAR MENSAJE
    // ---------------------------------------------
    document.getElementById("send").onclick = async () => {
      const content = messageInput.value.trim();
      if(!content || !currentChatId) return;
      await supabase.from("new_messages").insert({ chat_id: currentChatId, sender_id: currentUserId, content });
      messageInput.value = "";
    };

    messageInput.addEventListener("keypress", e => { if(e.key==="Enter") document.getElementById("send").click(); });

    // ---------------------------------------------
    // 8️⃣ INICIAR
    // ---------------------------------------------
    loadUsers();
  </script>
</body>
</html>
