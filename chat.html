<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PekeChat — WhatsApp style</title>
<style>
  :root{--green:#128c7e;--accent:#25d366;--sidebar:#075e54;--bg:#ece5dd;}
  body{margin:0;font-family:Inter,Arial,sans-serif;height:100vh;display:flex;background:var(--bg);color:#111}
  /* SIDEBAR */
  #sidebar{width:320px;background:var(--sidebar);color:#fff;display:flex;flex-direction:column}
  #profile{display:flex;align-items:center;padding:16px;border-bottom:1px solid rgba(255,255,255,0.06)}
  #profile .avatar{width:48px;height:48px;border-radius:50%;background:#0b845f;margin-right:12px;display:flex;align-items:center;justify-content:center;font-weight:700}
  #profile .who{font-size:14px}
  #sidebar-controls{display:flex;gap:8px;padding:12px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-green{background:var(--accent);color:#fff}
  .btn-light{background:#34b7f1;color:#fff}
  #search-contacts{margin:0 12px 8px;padding:8px;border-radius:8px;border:none}
  #lists{flex:1;overflow:auto;padding:8px}
  .section-title{color:rgba(255,255,255,0.8);font-size:13px;margin:8px 4px}
  .chat-item, .contact-item{background:transparent;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .chat-item:hover, .contact-item:hover{background:rgba(255,255,255,0.04)}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.7)}
  /* MAIN */
  #main{flex:1;display:flex;flex-direction:column;background:var(--bg)}
  #header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--green);color:#fff}
  #messages{flex:1;overflow:auto;padding:18px}
  .message{max-width:66%;margin:8px 0;padding:10px 14px;border-radius:18px;word-break:break-word;display:inline-block;clear:both}
  .my-message{background:#dcf8c6;float:right}
  .other-message{background:#fff;float:left}
  #composer{display:flex;padding:12px;background:#f0f0f0;gap:8px}
  #message-input{flex:1;padding:12px;border-radius:999px;border:1px solid #ccc;outline:none}
  #send{padding:10px 14px;border-radius:999px;border:none;background:var(--green);color:#fff;cursor:pointer}
  /* MODALS */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55)}
  .card{background:#fff;border-radius:10px;padding:16px;width:360px;max-width:94%}
  .card h3{margin-top:0}
  .modal .list{max-height:260px;overflow:auto}
  /* members modal */
  #members-list div{padding:8px;border-bottom:1px solid #eee}
  /* small responsive */
  @media (max-width:900px){#sidebar{width:260px}}
  @media (max-width:700px){#sidebar{display:none}}
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div id="profile">
      <div class="avatar" id="profile-avatar">P</div>
      <div class="who">
        <div id="profile-name">Tú</div>
        <div class="small-muted" id="profile-id"></div>
      </div>
    </div>

    <div id="sidebar-controls">
      <button id="btn-add-contact" class="btn btn-light">Agregar contacto</button>
      <button id="btn-create-group" class="btn btn-green">Crear grupo</button>
    </div>

    <input id="search-contacts" placeholder="Buscar contactos..." />

    <div id="lists">
      <div class="section-title">CHATS</div>
      <div id="chats-list"></div>

      <div class="section-title" style="margin-top:12px">CONTACTOS</div>
      <div id="contacts-list"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="main">
    <div id="header">
      <div id="chat-title">Selecciona un chat</div>
      <div>
        <button id="btn-members" class="btn btn-light">Miembros</button>
      </div>
    </div>

    <div id="messages"></div>

    <form id="composer" onsubmit="return false;">
      <input id="message-input" placeholder="Escribe un mensaje..." autocomplete="off"/>
      <button id="send" class="btn">Enviar</button>
    </form>
  </main>

  <!-- MODALS -->
  <div id="modal-create-group" class="modal">
    <div class="card">
      <h3>Crear grupo</h3>
      <input id="group-name" placeholder="Nombre del grupo" />
      <div style="margin-top:8px" class="small-muted">Selecciona miembros:</div>
      <div class="list" id="group-members-list"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="confirm-create-group" class="btn btn-green">Crear</button>
        <button id="cancel-create-group" class="btn">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modal-members" class="modal">
    <div class="card">
      <h3>Miembros</h3>
      <div id="members-list"></div>
      <div style="margin-top:10px;text-align:right"><button id="close-members" class="btn">Cerrar</button></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------------------------
  CONFIG - PON TUS CREDENCIALES
---------------------------- */
const SUPABASE_URL = 'TU_SUPABASE_URL';
const SUPABASE_KEY = 'TU_SUPABASE_ANON_KEY';

/* intenta inicializar supabase; si falla el script seguirá en modo local */
let supabase = null;
try { supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){ console.warn('Supabase init error', e); supabase = null; }

/* ---------------------------
  HELPERS: local fallback + small utils
---------------------------- */
const L = { chats:'pc_chats', members:'pc_chat_members', messages:'pc_messages', users:'pc_users' };

function uid(){ return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,6); }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ return JSON.parse(localStorage.getItem(k) || 'null') } catch(e){ return null } }
function escapeHtml(t){ return String(t||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------------------------
  STATE
---------------------------- */
let currentUserId = localStorage.getItem('userId');
let currentUsername = localStorage.getItem('username');
if(!currentUserId || !currentUsername){
  currentUserId = 'me-' + Math.random().toString(36).slice(2,8);
  currentUsername = 'Tú';
  localStorage.setItem('userId', currentUserId);
  localStorage.setItem('username', currentUsername);
}

document.getElementById('profile-name').textContent = currentUsername;
document.getElementById('profile-id').textContent = currentUserId;
document.getElementById('profile-avatar').textContent = (currentUsername[0]||'P').toUpperCase();

let appUsers = [];      // contactos visibles (from supabase usuarios or fallback)
let localChats = load(L.chats) || [];        // [{id,type,name,owner,created_at}]
let localChatMembers = load(L.members) || []; // [{chat_id,user_id,role}]
let localMessages = load(L.messages) || [];   // [{id,chat_id,sender_id,sender_name,content,created_at}]
let localAppUsers = load(L.users) || [];      // [{id,name}]

let currentChatId = null;

/* ---------------------------
  UI refs
---------------------------- */
const chatsListEl = document.getElementById('chats-list');
const contactsListEl = document.getElementById('contacts-list');
const messagesEl = document.getElementById('messages');
const chatTitleEl = document.getElementById('chat-title');
const inputEl = document.getElementById('message-input');
const sendBtn = document.getElementById('send');

const btnAddContact = document.getElementById('btn-add-contact');
const btnCreateGroup = document.getElementById('btn-create-group');
const btnMembers = document.getElementById('btn-members');

const modalCreateGroup = document.getElementById('modal-create-group');
const groupNameInput = document.getElementById('group-name');
const groupMembersList = document.getElementById('group-members-list');
const confirmCreateGroup = document.getElementById('confirm-create-group');
const cancelCreateGroup = document.getElementById('cancel-create-group');

const modalMembers = document.getElementById('modal-members');
const membersListEl = document.getElementById('members-list');
const closeMembersBtn = document.getElementById('close-members');

const searchContacts = document.getElementById('search-contacts');

/* ---------------------------
  Load users (from 'usuarios' table) OR fallback
---------------------------- */
async function loadAppUsers(){
  appUsers = [];
  // try supabase
  if(supabase){
    try{
      // asumimos tabla 'usuarios' y columnas id, username, avatar_url(optional)
      const { data, error } = await supabase.from('usuarios').select('id, username, avatar_url');
      if(!error && data && data.length){
        appUsers = data.map(u => ({ id: String(u.id), name: u.username, avatar: u.avatar_url || null }));
      } else {
        console.info('Tabla usuarios vacía o inaccesible, usando fallback.');
      }
    } catch(e){ console.warn('Error leyendo usuarios table:', e); }
  }
  // merge with localAppUsers
  (localAppUsers || []).forEach(u => { if(!appUsers.some(x => x.id===u.id)) appUsers.push(u); });
  if(appUsers.length===0){
    appUsers = [ {id:'user1',name:'Alice'}, {id:'user2',name:'Bob'}, {id:'user3',name:'Charlie'} ];
  }
  if(!appUsers.some(u=>u.id===currentUserId)) appUsers.push({id:currentUserId,name:currentUsername});
}

/* ---------------------------
  Render lists
---------------------------- */
function renderChats(){
  chatsListEl.innerHTML = '';
  // combine supabase chat_members + localChatMembers
  (async ()=>{
    let items = [];
    if(supabase){
      try{
        const { data, error } = await supabase.from('chat_members').select('chat_id, chats(type,name)').eq('user_id', currentUserId);
        if(!error && data) items = data;
      } catch(e){ console.warn('err load supabase chat_members',e); }
    }
    // add local member chats
    const localItems = localChatMembers.filter(cm=>cm.user_id===currentUserId).map(cm=>{
      const chat = localChats.find(c=>c.id===cm.chat_id);
      if(!chat) return null;
      return { chat_id: chat.id, chats: { type: chat.type, name: chat.name } };
    }).filter(Boolean);
    localItems.forEach(li => { if(!items.some(i=>i.chat_id===li.chat_id)) items.push(li); });

    if(items.length===0){
      const empty = document.createElement('div'); empty.className='small-muted'; empty.style.padding='12px'; empty.textContent='Sin chats aún';
      chatsListEl.appendChild(empty); return;
    }
    items.forEach(it=>{
      const el = document.createElement('div'); el.className='chat-item';
      el.textContent = it.chats && it.chats.type==='private' ? 'Chat privado' : (it.chats && it.chats.name ? it.chats.name : 'Chat');
      el.onclick = ()=>{ currentChatId = it.chat_id; openChat(it.chat_id); }
      chatsListEl.appendChild(el);
    });
  })();
}

function renderContacts(filter=''){
  contactsListEl.innerHTML = '';
  const q = filter.trim().toLowerCase();
  appUsers.filter(u=>u.id!==currentUserId && (!q || u.name.toLowerCase().includes(q) || u.id.toLowerCase().includes(q)))
    .forEach(u=>{
      const el = document.createElement('div'); el.className='contact-item';
      el.innerHTML = `<div><strong style="color:#fff">${escapeHtml(u.name)}</strong><div class="small-muted">${escapeHtml(u.id)}</div></div>
                      <div style="display:flex;gap:6px">
                        <button class="btn" style="background:#fff;color:#000">Chat</button>
                      </div>`;
      el.querySelector('button').onclick = (ev)=>{
        ev.stopPropagation();
        ensurePrivateChat(u.id, u.name);
      };
      contactsListEl.appendChild(el);
    });
}

/* ---------------------------
  OPEN CHAT (load messages & title)
---------------------------- */
async function openChat(chatId){
  messagesEl.innerHTML = '';
  chatTitleEl.textContent = 'Cargando...';

  // get name (if supabase available)
  let name = null;
  if(supabase){
    try{
      const { data } = await supabase.from('chats').select('name').eq('id', chatId).single();
      if(data) name = data.name;
    }catch(e){}
  }
  // fallback local
  if(!name){
    const c = localChats.find(x=>x.id===chatId); name = c ? c.name : chatId;
  }
  chatTitleEl.textContent = name;

  // try supabase messages
  if(supabase){
    try{
      const { data, error } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at', {ascending:true});
      if(!error && data){
        data.forEach(m=> addMessageRow(m));
      }
      // subscribe realtime
      try{ supabase.removeAllChannelSubscriptions(); } catch(e){}
      supabase.channel('chat-'+chatId)
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`chat_id=eq.${chatId}`},
            payload => addMessageRow(payload.new)
        ).subscribe();
      return;
    } catch(e){ console.warn('error reading supabase messages',e); }
  }

  // fallback local messages
  localMessages.filter(m=>m.chat_id===chatId).sort((a,b)=>new Date(a.created_at)-new Date(b.created_at)).forEach(addMessageRow);
}

/* helper to render a message */
function addMessageRow(m){
  const div = document.createElement('div'); div.className = 'message ' + (m.sender_id===currentUserId? 'my-message':'other-message');
  div.innerHTML = `<strong>${escapeHtml(m.sender_name||m.sender_id)}:</strong> ${escapeHtml(m.content)}`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* ---------------------------
  SEND MESSAGE
---------------------------- */
async function sendMessage(){
  const txt = inputEl.value.trim();
  if(!txt) return;
  if(!currentChatId) return alert('Selecciona un chat');

  const row = {
    id: uid(),
    chat_id: currentChatId,
    sender_id: currentUserId,
    sender_name: currentUsername,
    content: txt,
    created_at: new Date().toISOString()
  };

  // intentar supabase
  if(supabase){
    try{
      const { error } = await supabase.from('messages').insert([{
        chat_id: currentChatId,
        sender_id: currentUserId,
        sender_name: currentUsername,
        content: txt
      }]);
      if(error) throw error;
      inputEl.value = ''; return;
    }catch(e){
      console.warn('Enviar a supabase falló, guardando local', e);
      alert('No se pudo enviar a Supabase; mensaje guardado localmente.');
    }
  }

  // fallback local
  localMessages.push(row); save(L.messages, localMessages);
  addMessageRow(row);
  inputEl.value = '';
}

/* ---------------------------
  ENSURE PRIVATE CHAT (create if not exists)
---------------------------- */
async function ensurePrivateChat(otherId, otherName){
  // 1) buscar en supabase chat con 2 miembros? Simplicidad: creamos siempre nuevo chat privado
  // si quieres deduplicar, habría que buscar chats donde ambos sean miembros - lo puedo añadir si quieres
  const name = 'Chat privado';
  if(supabase){
    try{
      const { data: chatData, error: chatError } = await supabase.from('chats').insert({ type:'private', name }).select('id');
      if(chatError) throw chatError;
      const chatId = chatData[0].id;
      const members = [{chat_id:chatId,user_id:currentUserId},{chat_id:chatId,user_id:otherId}];
      const { error: membersError } = await supabase.from('chat_members').insert(members);
      if(membersError) throw membersError;
      // open
      currentChatId = chatId; await openChat(chatId);
      await renderAll();
      return;
    }catch(e){ console.warn('Crear private chat supabase falló, creando local', e); alert('No se pudo crear en Supabase; creado local.'); }
  }
  // local fallback
  const chatId = uid();
  localChats.push({id:chatId,type:'private',name,owner:currentUserId,created_at:new Date().toISOString()});
  localChatMembers.push({chat_id:chatId,user_id:currentUserId,role:'owner'});
  localChatMembers.push({chat_id:chatId,user_id:otherId,role:'member'});
  save(L.chats, localChats); save(L.members, localChatMembers);
  currentChatId = chatId; openChat(chatId); renderAll();
}

/* ---------------------------
  CREATE GROUP modal flow
---------------------------- */
btnCreateGroup.onclick = async ()=>{
  await loadAppUsers(); populateGroupMembers(); modalCreateGroup.style.display='flex';
};
cancelCreateGroup.onclick = ()=>{ modalCreateGroup.style.display='none'; groupNameInput.value=''; }

function populateGroupMembers(){
  groupMembersList.innerHTML = '';
  appUsers.filter(u=>u.id!==currentUserId).forEach(u=>{
    const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid #eee';
    row.innerHTML = `<label style="display:flex;justify-content:space-between;align-items:center">
      <span><strong>${escapeHtml(u.name)}</strong> <div class="small-muted" style="font-size:12px">${escapeHtml(u.id)}</div></span>
      <input type="checkbox" value="${escapeHtml(u.id)}"/>
    </label>`;
    groupMembersList.appendChild(row);
  });
}

confirmCreateGroup.onclick = async ()=>{
  const name = groupNameInput.value.trim();
  if(!name) return alert('Pon nombre al grupo');
  const selected = Array.from(groupMembersList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  if(selected.length===0) return alert('Selecciona al menos un miembro');

  // try supabase
  if(supabase){
    try{
      const { data: chatData, error: chatError } = await supabase.from('chats').insert({type:'group',name,owner:currentUserId}).select('id');
      if(chatError) throw chatError;
      const chatId = chatData[0].id;
      const membersRows = selected.map(uid=>({chat_id:chatId,user_id:uid}));
      membersRows.push({chat_id:chatId,user_id:currentUserId});
      const { error: membersError } = await supabase.from('chat_members').insert(membersRows);
      if(membersError) throw membersError;
      modalCreateGroup.style.display='none';
      groupNameInput.value=''; renderAll(); currentChatId = chatId; openChat(chatId); return;
    }catch(e){ console.warn('Crear grupo supabase falló', e); alert('No se pudo crear en Supabase; creado local.'); }
  }

  // local fallback
  const chatId = uid();
  localChats.push({id:chatId,type:'group',name,owner:currentUserId,created_at:new Date().toISOString()});
  const membersRows = selected.map(uid=>({chat_id:chatId,user_id:uid}));
  membersRows.push({chat_id:chatId,user_id:currentUserId});
  localChatMembers.push(...membersRows); save(L.chats, localChats); save(L.members, localChatMembers);
  modalCreateGroup.style.display='none'; groupNameInput.value=''; renderAll(); currentChatId = chatId; openChat(chatId);
};

/* ---------------------------
  ADD CONTACT flow
---------------------------- */
btnAddContact.onclick = async ()=>{
  let id = prompt('ID del contacto (ej: user5)');
  if(!id) return;
  id = id.trim();
  let name = prompt('Nombre del contacto');
  if(!name) return;
  name = name.trim();

  // check duplicates in appUsers and localAppUsers
  if((appUsers||[]).some(u=>u.id===id) || (localAppUsers||[]).some(u=>u.id===id)){
    return alert('Ese contacto ya existe localmente.');
  }

  // try supabase upsert into 'usuarios'
  if(supabase){
    try{
      const { error } = await supabase.from('usuarios').upsert({ id, username: name });
      if(error) throw error;
      // reload users
      await loadAppUsers();
      alert('Contacto guardado en Supabase');
      return renderContacts(searchContacts.value||'');
    }catch(e){ console.warn('Upsert supabase falló:', e); }
  }

  // fallback local
  localAppUsers.push({id,name}); save(L.users, localAppUsers);
  await loadAppUsers(); renderContacts(searchContacts.value||'');
  alert('Contacto guardado localmente');
};

/* ---------------------------
  VIEW MEMBERS
---------------------------- */
btnMembers.onclick = async ()=>{
  if(!currentChatId) return alert('Selecciona un chat');
  membersListEl.innerHTML = '';
  // try supabase first
  if(supabase){
    try{
      const { data, error } = await supabase.from('chat_members').select('user_id').eq('chat_id', currentChatId);
      if(!error && data && data.length){
        for(const m of data){
          const u = (appUsers||[]).find(x=>x.id===m.user_id) || (localAppUsers||[]).find(x=>x.id===m.user_id);
          const text = u ? `${u.name} (${m.user_id})` : m.user_id;
          const d = document.createElement('div'); d.textContent = text; membersListEl.appendChild(d);
        }
        modalMembers.style.display='flex'; return;
      }
    }catch(e){ console.warn('read members supabase failed', e); }
  }
  // fallback local
  const members = localChatMembers.filter(m=>m.chat_id===currentChatId);
  if(members.length===0) membersListEl.textContent='Sin miembros (local)';
  else members.forEach(m=>{
    const u = (appUsers||[]).find(x=>x.id===m.user_id) || (localAppUsers||[]).find(x=>x.id===m.user_id);
    const text = u ? `${u.name} (${m.user_id})` : m.user_id;
    const d = document.createElement('div'); d.textContent = text; membersListEl.appendChild(d);
  });
  modalMembers.style.display='flex';
};
closeMembersBtn.onclick = ()=> modalMembers.style.display='none';

/* ---------------------------
  SEARCH contacts
---------------------------- */
searchContacts.addEventListener('input', e=> renderContacts(e.target.value));

/* ---------------------------
  Render everything
---------------------------- */
async function renderAll(){
  await loadAppUsers();
  renderContacts(searchContacts.value||'');
  renderChats();
}

/* ---------------------------
  Init
---------------------------- */
(async function init(){
  await renderAll();
})();

/* ---------------------------
  UI events
---------------------------- */
sendBtn.onclick = sendMessage;
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

/* ---------------------------
  Small note for the user
---------------------------- */
console.log('PekeChat loaded. user:', currentUserId, currentUsername);
</script>
</body>
</html>
