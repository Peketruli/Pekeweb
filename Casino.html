<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎰 Casino 🎰</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body { background-color: #2c2c2c; color: white; font-family: Arial, sans-serif; text-align: center; padding: 50px; }
.auth-container, .user-info { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; }
.auth-button { padding: 10px 20px; font-size: 1em; color: white; background-color: #333; border: none; cursor: pointer; border-radius: 5px; }
.user-info { display: none; cursor: pointer; }
#userLogo { width: 40px; height: 40px; border-radius: 50%; }
#userName { font-weight: bold; }
.dropdown-menu { display: none; position: absolute; top: 60px; right: 20px; background-color: black; color: black; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 150px; text-align: left; }
.dropdown-menu td { padding: 10px; cursor: pointer; }
.dropdown-menu td:hover { background-color: #ddd; color:black; }
.section { margin-top: 40px; padding: 20px; background-color: #3a3a3a; border-radius: 10px; }
.section h2 { margin-bottom: 20px; color: #ffcc00; }
.top5-list, .games-list, .rewards-list { list-style: none; padding: 0; }
.top5-list li, .games-list li, .rewards-list li { padding: 10px; margin: 5px 0; background-color: #4a4a4a; border-radius: 5px; display: flex; align-items: center; gap:8px; }
.game-button, .reward-button { padding: 10px 20px; margin: 5px; background-color: #ff4081; color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
.game-button:hover, .reward-button:hover { transform: scale(1.1); }
</style>
</head>
<body>

<button class="home-btn" onclick="window.location.href='Hub.html'">Volver a la Página Principal</button>

<h1>🎰 Casino 🎰</h1>

<div class="auth-container" id="authContainer">
    <button class="auth-button" onclick="window.location.href='login.html'">Iniciar sesión o registrarse</button>
</div>

<div class="user-info" id="userInfo">
    <h3 id="userName"></h3>
    <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
</div>

<div class="dropdown-menu" id="dropdownMenu">
    <table>
        <tr><td onclick="logout()">🚪 Cerrar sesión</td></tr>
    </table>
</div>

<div id="Pekepuntos">Pekepuntos: 0</div>

<!-- Top 5 usuarios -->
<div class="section" id="top5Section">
    <h2>🏆 Top 5 Jugadores</h2>
    <ul class="top5-list" id="top5List"></ul>
</div>

<!-- Juegos -->
<div class="section" id="gamesSection">
    <h2>🎮 Juegos Disponibles</h2>
    <button class="game-button" onclick="window.location.href='blackjack.html'">Blackjack</button>
    <button class="game-button" onclick="window.location.href='ruleta.html'">Ruleta</button>
    <button class="game-button" onclick="window.location.href='poker.html'">Poker</button>
</div>

<!-- Recompensas -->
<div class="section" id="rewardsSection">
    <h2>🎁 Recompensas</h2>
    <button class="reward-button" id="reward1Btn">Recompensa 1: Cambiar Fondo</button>
    <input type="color" id="backgroundPicker" style="display:none;" onchange="setBackgroundColor(this.value)">
    
    <button class="reward-button" id="reward2Btn">Recompensa 2: Cambiar Color de Nombre</button>
    <input type="color" id="nameColorPicker" style="display:none;" onchange="setNameColor(this.value)">
    
    <button class="reward-button" id="reward3Btn">Recompensa 3: Último blog color especial</button>
    <input type="color" id="blogColorPicker" style="display:none;" onchange="setBlogColor(this.value)">

    <!-- Recompensas Top -->
    <div id="exclusiveTop5" style="display:none;">🎖 Foto de perfil en Top 5</div>
    <div id="exclusiveTop3" style="display:none;">🥉 Nombre color cobre</div>
    <div id="exclusiveTop2" style="display:none;">🥈 Nombre color plata</div>
    <div id="exclusiveTop1" style="display:none;">👑 Nombre color oro</div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

document.addEventListener("DOMContentLoaded", async () => {
    // Cargar usuario desde localStorage
    currentUser = JSON.parse(localStorage.getItem("currentUser"));

    loadUserInfo();
    await loadTop5();

    const userInfo = document.getElementById("userInfo");
    const dropdownMenu = document.getElementById("dropdownMenu");
    userInfo.addEventListener("click", () => {
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", e => {
        if(!userInfo.contains(e.target) && !dropdownMenu.contains(e.target)) dropdownMenu.style.display = "none";
    });

    document.getElementById("reward1Btn").addEventListener("click",()=>{document.getElementById("backgroundPicker").style.display="block"});
    document.getElementById("reward2Btn").addEventListener("click",()=>{document.getElementById("nameColorPicker").style.display="block"});
    document.getElementById("reward3Btn").addEventListener("click",()=>{document.getElementById("blogColorPicker").style.display="block"});
});

function logout() {
    supabase.auth.signOut();
    localStorage.removeItem("currentUser");
    window.location.href="login.html";
}

async function loadUserInfo() {
    const authContainer = document.getElementById("authContainer");
    const userInfo = document.getElementById("userInfo");

    if(currentUser){
        userInfo.style.display="flex";
        authContainer.style.display="none";
        document.getElementById("userName").textContent = currentUser.username;
        document.getElementById("userLogo").src = currentUser.logo || "logoDefault.png";

        // cargar puntos desde Supabase
        const {data,error} = await supabase.from("usuarios")
            .select("pekepuntos,fondo_color,nombre_color")
            .eq("id",currentUser.id)
            .single();

        if(error){ console.error(error); return; }

        document.getElementById("pekepuntos").textContent = `Pekepuntos: ${data.pekepuntos || 0}`;

        // aplicar estilos guardados
        if(data.fondo_color) document.body.style.backgroundColor = data.fondo_color;
        if(data.nombre_color) document.getElementById("userName").style.color = data.nombre_color;
    } else {
        userInfo.style.display="none";
        authContainer.style.display="flex";
    }
}

// Funciones recompensas
async function setBackgroundColor(color){
    document.body.style.backgroundColor = color;
    await supabase.from("usuarios").update({fondo_color:color}).eq("id",currentUser.id);
}
async function setNameColor(color){
    document.getElementById("userName").style.color = color;
    await supabase.from("usuarios").update({nombre_color:color}).eq("id",currentUser.id);
}
async function setBlogColor(color){
    await supabase.from("usuarios").update({blog_color:color}).eq("id",currentUser.id);
    alert("✅ El próximo blog aparecerá en tu color especial.");
}

// Top 5
async function loadTop5(){
    const {data,error} = await supabase.from("usuarios").select("id,username,pekepuntos,logo,nombre_color").order("pekepuntos",{ascending:false}).limit(5);
    if(error){console.error(error); return;}

    const top5List=document.getElementById("top5List");
    top5List.innerHTML="";

    data.forEach((user,index)=>{
        let color = user.nombre_color || "white";
        if(index===0) color="gold";
        else if(index===1) color="silver";
        else if(index===2) color="#b87333"; // cobre
        let imgHtml = user.logo?`<img src="${user.logo}" style="width:30px;height:30px;border-radius:50%;">`:"";
        top5List.innerHTML += `<li>${imgHtml}<span style="color:${color};">${index+1}. ${user.username}</span> - ${user.pekepuntos} Pekepuntos</li>`;
    });

    // Mostrar recompensas exclusivas
    if(currentUser){
        const pos = data.findIndex(u=>u.id===currentUser.id);
        if(pos!==-1){
            if(pos<=4) document.getElementById("exclusiveTop5").style.display="block";
            if(pos===2) document.getElementById("exclusiveTop3").style.display="block";
            if(pos===1) document.getElementById("exclusiveTop2").style.display="block";
            if(pos===0) document.getElementById("exclusiveTop1").style.display="block";
        }
    }
}
</script>
</body>
</html>
