<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pekepuntos - Recompensas</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background:#111;
      color:#eee;
      padding:20px;
    }
    h1,h2 { margin-top:20px; }
    ul { list-style:none; padding:0; }
    li { margin:5px 0; }
    .reward-button {
      background:#333;
      color:#eee;
      border:none;
      padding:8px 12px;
      margin:6px 0;
      border-radius:8px;
      cursor:pointer;
    }
    .reward-button:hover { background:#555; }
    #top5List li {
      display:flex;
      align-items:center;
      gap:8px;
      padding:5px;
      border-bottom:1px solid #333;
    }
  </style>
</head>
<body>
  <h1>Pekepuntos</h1>
  <p>Usuario: <span id="userName">Desconocido</span></p>
  <p>Pekepuntos: <span id="userPoints">0</span></p>

  <!-- Recompensas -->
  <div class="section" id="rewardsSection">
    <h2>🎁 Recompensas</h2>
    
    <!-- Recompensa 1: cambiar fondo -->
    <div>
      <button class="reward-button" onclick="unlockBackground()">Recompensa 1: Cambiar Fondo</button>
      <input type="color" id="backgroundPicker" style="display:none;" onchange="setBackgroundColor(this.value)">
    </div>
    
    <!-- Recompensa 2: cambiar color de nombre -->
    <div>
      <button class="reward-button" onclick="unlockNameColor()">Recompensa 2: Cambiar Color del Nombre</button>
      <input type="color" id="nameColorPicker" style="display:none;" onchange="setNameColor(this.value)">
    </div>

    <!-- Recompensa 3: último blog con color especial -->
    <div>
      <button class="reward-button" onclick="unlockBlogColor()">Recompensa 3: Cambiar Color del Último Blog</button>
      <input type="color" id="blogColorPicker" style="display:none;" onchange="setBlogColor(this.value)">
    </div>

    <!-- Exclusivas Top -->
    <div id="exclusiveTop5" style="display:none;">
      <p>🎖 Recompensa Exclusiva: Mostrar tu foto de perfil en el Top 5</p>
    </div>

    <div id="exclusiveTop3" style="display:none;">
      <p>🥉 Tu nombre será de <b style="color:#b87333;">cobre</b></p>
    </div>

    <div id="exclusiveTop2" style="display:none;">
      <p>🥈 Tu nombre será de <b style="color:silver;">plata</b></p>
    </div>

    <div id="exclusiveTop1" style="display:none;">
      <p>👑 Tu nombre será de <b style="color:gold;">oro</b></p>
    </div>
  </div>

  <!-- Top 5 -->
  <div class="section">
    <h2>🏆 Top 5 Usuarios</h2>
    <ul id="top5List"></ul>
  </div>

  <script>
    // Configura tu proyecto Supabase
    const supabaseUrl = "TU_SUPABASE_URL";
    const supabaseKey = "TU_SUPABASE_KEY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = { id: null, username:"", pekepuntos:0 };

    // 🔹 Simulación de usuario actual (reemplaza con login real)
    async function loadCurrentUser() {
      // ejemplo: cogemos el primer usuario
      const { data, error } = await supabase.from("usuarios").select("*").limit(1);
      if (error) { console.error(error); return; }
      if (data.length > 0) {
        currentUser = data[0];
        document.getElementById("userName").innerText = currentUser.username;
        document.getElementById("userPoints").innerText = currentUser.pekepuntos;

        // aplicar estilos guardados
        if (currentUser.fondo_color) document.body.style.backgroundColor = currentUser.fondo_color;
        if (currentUser.nombre_color) document.getElementById("userName").style.color = currentUser.nombre_color;
      }
    }

    // 🔹 Recompensas
    async function unlockBackground() {
      document.getElementById("backgroundPicker").style.display = "block";
    }
    async function setBackgroundColor(color) {
      document.body.style.backgroundColor = color;
      await supabase.from("usuarios").update({ fondo_color: color }).eq("id", currentUser.id);
    }

    async function unlockNameColor() {
      document.getElementById("nameColorPicker").style.display = "block";
    }
    async function setNameColor(color) {
      document.getElementById("userName").style.color = color;
      await supabase.from("usuarios").update({ nombre_color: color }).eq("id", currentUser.id);
    }

    async function unlockBlogColor() {
      document.getElementById("blogColorPicker").style.display = "block";
    }
    async function setBlogColor(color) {
      await supabase.from("usuarios").update({ blog_color: color }).eq("id", currentUser.id);
      alert("✅ El próximo blog que publiques saldrá en tu color especial.");
    }

    // 🔹 Top 5
    async function loadTop5() {
      const { data, error } = await supabase
        .from('usuarios')
        .select('id, username, pekepuntos, logo, nombre_color')
        .order('pekepuntos', { ascending: false })
        .limit(5);

      if (error) { console.error(error); return; }

      const top5List = document.getElementById('top5List');
      top5List.innerHTML = "";

      data.forEach((user, index) => {
        const li = document.createElement('li');

        // Colores automáticos para top 1-3
        let color = user.nombre_color || "white";
        if (index === 0) color = "gold";
        else if (index === 1) color = "silver";
        else if (index === 2) color = "#b87333"; // cobre

        // Foto de perfil si tiene logo
        let imgHtml = "";
        if (user.logo) imgHtml = `<img src="${user.logo}" style="width:30px;height:30px;border-radius:50%;">`;

        li.innerHTML = `${imgHtml}<span style="color:${color};">${index+1}. ${user.username}</span> - ${user.pekepuntos} Pekepuntos`;
        top5List.appendChild(li);
      });

      // Mostrar recompensas especiales según tu posición
      if (currentUser) {
        const pos = data.findIndex(u => u.id === currentUser.id);
        if (pos !== -1) {
          if (pos <= 4) document.getElementById("exclusiveTop5").style.display = "block";
          if (pos === 2) document.getElementById("exclusiveTop3").style.display = "block";
          if (pos === 1) document.getElementById("exclusiveTop2").style.display = "block";
          if (pos === 0) document.getElementById("exclusiveTop1").style.display = "block";
        }
      }
    }

    // 🔹 Inicializar
    loadCurrentUser().then(loadTop5);
  </script>
</body>
</html>
