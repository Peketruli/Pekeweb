<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monopoly ‚Äî OnePlayer / Multiplayer (Supabase)</title>
<style>
  :root{
    --bg:#cfe7ef;
    --panel:#fff;
    --leftWidth:240px;
    --hand-gap:10px;
  }
  html,body{height:100%; margin:0; padding:0; background:var(--bg); font-family:Arial,Helvetica,sans-serif; color:#111}
  /* layout */
  #wrap{padding:18px; box-sizing:border-box; min-height:100vh;}
  #menuOverlay{
    position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.45));
    z-index:9999;
  }
  #menuBox{width:820px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.35)}
  #menuBox h1{margin:0 0 10px; font-size:20px;}
  .menuRow{display:flex; gap:12px; align-items:center; justify-content:space-between}
  .modeBtn{flex:1;padding:12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
  .oneBtn{background:#2ecc71;color:#fff}
  .multiBtn{background:#6c5ce7;color:#fff}
  .smallTxt{font-size:13px;color:#555;margin-top:8px}
  /* game layout */
  #page {
    display:grid;
    grid-template-columns: var(--leftWidth) 700px 360px;
    gap:18px;
    justify-content:center;
    align-items:start;
    min-height:calc(100vh - 36px);
    box-sizing:border-box;
  }
  /* left */
  #leftCol { display:flex; flex-direction:column; gap:var(--hand-gap); align-items:stretch; }
  .handPanel { background:#0b6b3a; color:#fff; padding:8px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); min-height:180px; }
  .handPanel.ai { background:#23394d; color:#f7eab6; }
  .handTitle { font-weight:700; font-size:14px; margin-bottom:6px; display:flex;justify-content:space-between; align-items:center;}
  .handGrid { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; }
  .handCard { width:100px; background:#fff; color:#111; border-radius:6px; padding:6px; box-shadow:0 6px 14px rgba(0,0,0,0.12); cursor:pointer; font-size:12px; position:relative; }
  .handCard .stripe { height:10px; border-radius:4px; margin-bottom:6px; }
  .handEmpty { opacity:0.7; font-size:13px; }
  /* center */
  #centerCol { display:flex; justify-content:center; align-items:flex-start; }
  canvas { background:#fafafa; border:4px solid #333; box-shadow:0 8px 30px rgba(0,0,0,0.12); }
  /* right */
  #hud { width:360px; background:var(--panel); padding:14px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.08); max-height:82vh; overflow:auto; }
  h2{margin:6px 0 10px;font-size:18px;text-align:center;}
  .btn{display:block; width:100%; padding:10px; margin:8px 0; border-radius:6px; border:none; font-weight:600; cursor:pointer;}
  #rollBtn{background:#2b8aef;color:#fff;}
  #payJailBtn{background:#e67e22;color:#fff; display:none;}
  #useCardBtn{background:#27ae60;color:#fff; display:none;}
  .info{background:#f3f6f8;padding:8px;border-radius:6px;margin-top:8px; font-size:14px; color:#111;}
  .small{font-size:13px;color:#444;margin-top:6px;}
  .playersList{margin-top:8px;}
  .playerRow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee;color:#111;}
  .center{display:flex;gap:8px;align-items:center;justify-content:center;}
  /* modals and multiplayer panel */
  #multiPanel{display:none;padding:12px;background:#fff;border-radius:8px;margin-bottom:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .inline{display:inline-block}
  #roomCode{width:180px;padding:8px;border-radius:6px;border:1px solid #ddd}
  #statusLine{font-size:13px;color:#333;margin-top:8px}
  /* prop modal */
  #propModal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9999}
  #propBox{width:420px;background:#fff;padding:16px;border-radius:10px;color:#111;box-shadow:0 12px 40px rgba(0,0,0,0.35)}
  #propBox h3{margin:0 0 8px}
  .line{margin:6px 0}
  #propBox .btn{width:auto;margin-left:6px;padding:8px 10px;border-radius:6px}
  /* card modal */
  #cardModal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9998}
  #cardBox{width:380px;background:#fff;padding:16px;border-radius:10px;color:#111}
  #closeCardBtn{padding:8px 12px;border-radius:6px;border:none;background:#2b8aef;color:#fff;cursor:pointer}
  .floatingCard { position:fixed; width:160px; height:100px; background:#fff; border-radius:8px; box-shadow:0 12px 30px rgba(0,0,0,0.25); display:flex;align-items:center;justify-content:center;font-weight:700; z-index:99997; pointer-events:none; }
  @media(max-width:1200px){
    #page { grid-template-columns: 200px 700px 320px; }
    :root{--leftWidth:200px;}
  }
</style>
<!-- supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>
<div id="wrap">
  <!-- MENU -->
  <div id="menuOverlay">
    <div id="menuBox">
      <h1>Monopoly ‚Äî Elige modo</h1>
      <div class="menuRow">
        <button id="onePlayerBtn" class="modeBtn oneBtn">One Player ‚Äî Jugar contra la IA</button>
        <button id="multiBtn" class="modeBtn multiBtn">Multiplayer ‚Äî Jugar online (Supabase)</button>
      </div>
      <div class="smallTxt">Al elegir Multiplayer se mostrar√° un panel para crear o unirse a una sala. Cambia las credenciales Supabase en el archivo HTML.</div>
    </div>
  </div>

  <!-- GAME AREA -->
  <div id="page" style="display:none;">
    <!-- LEFT -->
    <div id="leftCol">
      <div id="playerHandPanel" class="handPanel">
        <div class="handTitle"><span>Tu mano</span><span id="playerMoney" style="font-weight:600">$1500</span></div>
        <div id="playerHand" class="handGrid"><div class="handEmpty">Sin propiedades</div></div>
      </div>

      <div id="aiHandPanel" class="handPanel ai">
        <div class="handTitle"><span>Mano Oponente</span><span id="aiMoney" style="font-weight:600">$1500</span></div>
        <div id="aiHand" class="handGrid"><div class="handEmpty">Sin propiedades</div></div>
      </div>
    </div>

    <!-- CENTER -->
    <div id="centerCol">
      <canvas id="gameCanvas" width="700" height="700"></canvas>
    </div>

    <!-- RIGHT -->
    <div id="hud">
      <h2>Monopoly ‚Äî Turno: <span id="turnName">Jugador</span></h2>

      <!-- multiplayer panel (visible only en multiplayer) -->
      <div id="multiPanel">
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="createRoomBtn" class="btn" style="background:#2ecc71;color:#fff;width:auto">Crear sala</button>
          <input id="roomCode" placeholder="C√≥digo sala (ej. ABC123)" />
          <button id="joinRoomBtn" class="btn" style="background:#6c5ce7;color:#fff;width:auto">Unirse</button>
        </div>
        <div id="statusLine">Modo local (no conectado).</div>
      </div>

      <div class="playersList" id="playersList"></div>

      <div class="center">
        <button id="rollBtn" class="btn">üé≤ Tirar dados</button>
      </div>

      <div class="center small">
        <button id="payJailBtn" class="btn" style="width:auto;padding:8px 10px;">üíµ Pagar $50 y salir</button>
        <button id="useCardBtn" class="btn" style="width:auto;padding:8px 10px;">üÉè Usar "Salir de la c√°rcel"</button>
      </div>

      <div class="info" id="infoBox">Bienvenido ‚Äî pulsa "Tirar dados".</div>

      <div class="small" style="margin-top:10px;">
        <strong>Cartas en mesa:</strong>
        <div>Suerte: <span id="suerteCount"></span> ‚Äî Arca: <span id="arcaCount"></span></div>
      </div>

      <div style="margin-top:12px;">
        <div class="hudTitle">Acciones r√°pidas</div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button id="endTurnBtn" class="btn" style="background:#95a5a6;color:#fff;width:50%">Terminar</button>
          <button id="toggleIAPropBtn" class="btn" style="background:#6c5ce7;color:#fff;width:50%">Mostrar Oponente</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- modals -->
<div id="cardModal" role="dialog" aria-hidden="true">
  <div id="cardBox">
    <div id="cardText">Contenido de la carta</div>
    <div style="display:flex; justify-content:flex-end; margin-top:8px;">
      <button id="closeCardBtn">Cerrar</button>
    </div>
  </div>
</div>

<div id="propModal">
  <div id="propBox">
    <h3 id="pmName"></h3>
    <div id="pmColor" style="height:12px;width:100%;border-radius:4px;margin:6px 0"></div>
    <div class="line"><strong>Precio compra:</strong> $<span id="pmPrice"></span></div>
    <div class="line"><strong>Costo por casa:</strong> $<span id="pmHouseCost"></span></div>
    <div class="line"><strong>Costo hotel:</strong> $<span id="pmHotelCost"></span></div>
    <div class="line"><strong>Rentas:</strong></div>
    <div id="pmRents" class="line" style="margin-left:8px"></div>
    <div class="line"><strong>Mejoras actuales:</strong> <span id="pmImprovements"></span></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px">
      <button id="buyHouseBtn" class="btn" style="width:auto;background:#2ecc71;color:#fff;padding:8px 10px">Comprar casa</button>
      <button id="buyHotelBtn" class="btn" style="width:auto;background:#e67e22;color:#fff;padding:8px 10px;margin-left:6px">Comprar hotel</button>
      <button id="closePropBtn" class="btn" style="width:auto;background:#95a5a6;color:#fff;padding:8px 10px;margin-left:6px">Cerrar</button>
    </div>
    <div id="propMsg" style="margin-top:8px;color:#b33;"></div>
  </div>
</div>

<script>
/* ------------------ CONFIG: pon aqu√≠ tus claves ------------------ */
const SUPABASE_URL = "https://TU_PROYECTO.supabase.co"; // reemplaza
const SUPABASE_KEY = "PUBLIC_ANON_KEY"; // reemplaza
/* ----------------------------------------------------------------- */

/* ------------------ Inicializa Supabase (si se usa) ----------------- */
let supabase = null;
try {
  if (typeof supabase === 'undefined' || !supabase) {
    // crea cliente si la librer√≠a est√° cargada y las claves est√°n puestas
    if (window.supabase && SUPABASE_URL && SUPABASE_KEY && SUPABASE_URL !== "https://TU_PROYECTO.supabase.co") {
      supabase = supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      // dejar supabase = null si no configurado
      supabase = null;
      console.warn("Supabase no inicializado (coloca SUPABASE_URL y SUPABASE_KEY si quieres multiplayer).");
    }
  }
} catch (e) {
  console.warn("Error inicializando Supabase:", e);
  supabase = null;
}

/* ------------------ UI: Overlay de inicio (One Player / Multiplayer) ------------------ */
(function createStartOverlay(){
  const overlay = document.createElement('div');
  overlay.id = 'startOverlay';
  overlay.style.position = 'fixed';
  overlay.style.left = 0;
  overlay.style.top = 0;
  overlay.style.right = 0;
  overlay.style.bottom = 0;
  overlay.style.background = 'rgba(0,0,0,0.6)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = 999999;
  overlay.innerHTML = `
    <div style="width:420px;background:#fff;padding:20px;border-radius:10px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
      <h2 style="margin:6px 0 12px;">Monopoly ‚Äî Elige modo</h2>
      <p style="margin-bottom:14px;">Juega solo contra la IA o crea/√∫nete a una sala para jugar online.</p>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="onePlayerBtn" style="padding:10px 16px;border-radius:8px;background:#2b8aef;border:none;color:#fff;font-weight:700;cursor:pointer;">One Player</button>
        <button id="multiplayerBtn" style="padding:10px 16px;border-radius:8px;background:#6c5ce7;border:none;color:#fff;font-weight:700;cursor:pointer;">Multiplayer</button>
      </div>
      <div id="mpArea" style="margin-top:12px;display:none;text-align:left;">
        <div style="margin-top:8px;">
          <input id="roomInput" placeholder="Nombre sala (ej: sala123)" style="width:65%;padding:8px;border-radius:6px;border:1px solid #ddd" />
          <button id="createRoomBtn" style="padding:8px;border-radius:6px;margin-left:6px;background:#27ae60;color:#fff;border:none;cursor:pointer;">Crear</button>
        </div>
        <div style="margin-top:8px;">
          <button id="joinRoomBtn" style="padding:8px;border-radius:6px;background:#e67e22;color:#fff;border:none;cursor:pointer;">Unirse</button>
        </div>
        <p id="mpMsg" style="margin-top:8px;color:#b33"></p>
      </div>
      <p style="font-size:12px;margin-top:12px;color:#666">Si usas multiplayer, recuerda configurar SUPABASE_URL y SUPABASE_KEY.</p>
    </div>
  `;
  document.body.appendChild(overlay);

  const oneBtn = document.getElementById('onePlayerBtn');
  const multiBtn = document.getElementById('multiplayerBtn');
  const mpArea = document.getElementById('mpArea');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomInput = document.getElementById('roomInput');
  const mpMsg = document.getElementById('mpMsg');

  oneBtn.addEventListener('click', ()=> {
    overlay.remove();
    startOnePlayer();
  });

  multiBtn.addEventListener('click', ()=>{
    if(!supabase){
      mpMsg.textContent = "Supabase no est√° configurado. Revisa las claves en el script.";
      mpArea.style.display = 'block';
      return;
    }
    mpArea.style.display = (mpArea.style.display === 'block') ? 'none' : 'block';
  });

  createRoomBtn.addEventListener('click', async ()=>{
    const name = roomInput.value.trim();
    if(!name){ mpMsg.textContent = "Escribe un nombre de sala."; return; }
    mpMsg.textContent = "Creando sala...";
    try {
      const r = await createRoom(name);
      if(r.ok){
        mpMsg.style.color = "#0a0";
        mpMsg.textContent = `Sala "${name}" creada. Esperando jugadores...`;
        // unimos (host)
        joinRoom(name);
        overlay.remove();
      } else {
        mpMsg.style.color = "#b33";
        mpMsg.textContent = `Error creando sala: ${r.err}`;
      }
    } catch(e){
      mpMsg.style.color = "#b33"; mpMsg.textContent = "Error crear sala: " + e.message;
    }
  });

  joinRoomBtn.addEventListener('click', async ()=>{
    const name = roomInput.value.trim();
    if(!name){ mpMsg.textContent = "Escribe un nombre de sala."; return; }
    mpMsg.textContent = "Uni√©ndote...";
    try {
      const ok = await joinRoom(name);
      if(ok){
        overlay.remove();
      } else {
        mpMsg.style.color = "#b33";
        mpMsg.textContent = "No se pudo unir (sala inexistente o error).";
      }
    } catch(e){
      mpMsg.style.color = "#b33"; mpMsg.textContent = "Error unir sala: " + e.message;
    }
  });
})();

/* ------------------ Juego: estado y referencias DOM ------------------ */
/* --- mantenemos la estructura que ya ten√≠as --- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const SIZE = 700;
const CORNER = 100;
const SIDE_COUNT_BETWEEN_CORNERS = 9;
const SIDE_CELL_SIZE = (SIZE - CORNER*2) / SIDE_COUNT_BETWEEN_CORNERS;

/* board (id√©ntico) */
const board = [ /* ... tu array de 40 casillas ... */ ];

/* --- Reconstruyo el board literal (copia exacta) --- */
/* Para evitar bloquear el mensaje por longitud: si ya tienes el array en tu HTML d√©jalo; 
   si no est√°, pega aqu√≠ el mismo array de tu HTML tal como estaba. */
/* ---------------- NOTE: reutiliza el array que ya ten√≠as en tu HTML ---------------- */

/// PARA EVITAR DUPLICIDAD: si el array ya existe en la p√°gina, no lo sobrescribimos
if(typeof window._monopoly_board === 'undefined'){
  window._monopoly_board = [
    {name:"Salida", type:"especial"},
    {name:"Ronda de Valencia", color:"#8B4513", price:60, type:"propiedad"},
    {name:"Comunidad", type:"arca"},
    {name:"Plaza Lavapi√©s", color:"#8B4513", price:60, type:"propiedad"},
    {name:"Impuesto", type:"impuesto"},
    {name:"Estaci√≥n Mediod√≠a", type:"estacion", price:200},
    {name:"Glorieta Cuatro Caminos", color:"#ADD8E6", price:100, type:"propiedad"},
    {name:"Suerte", type:"suerte"},
    {name:"Avenida Reina Victoria", color:"#ADD8E6", price:100, type:"propiedad"},
    {name:"Calle Bravo Murillo", color:"#ADD8E6", price:120, type:"propiedad"},
    {name:"C√°rcel", type:"especial"},
    {name:"Glorieta Bilbao", color:"#FFC0CB", price:140, type:"propiedad"},
    {name:"Compa√±√≠a electricidad", type:"compa√±ia", price:150},
    {name:"Calle Alberto Aguilera", color:"#FFC0CB", price:140, type:"propiedad"},
    {name:"Calle Fuencarral", color:"#FFC0CB", price:160, type:"propiedad"},
    {name:"Estaci√≥n Norte", type:"estacion", price:200},
    {name:"Avenida Felipe II", color:"#FFA500", price:180, type:"propiedad"},
    {name:"Comunidad", type:"arca"},
    {name:"Calle Serrano", color:"#FFA500", price:180, type:"propiedad"},
    {name:"Calle Vel√°zquez", color:"#FFA500", price:200, type:"propiedad"},
    {name:"Parking", type:"especial"},
    {name:"Avenida de Am√©rica", color:"#FF0000", price:220, type:"propiedad"},
    {name:"Suerte", type:"suerte"},
    {name:"Calle Mar√≠a de Molina", color:"#FF0000", price:220, type:"propiedad"},
    {name:"Calle Cea Berm√∫dez", color:"#FF0000", price:240, type:"propiedad"},
    {name:"Estaci√≥n Delicias", type:"estacion", price:200},
    {name:"Avenida de los Poblados", color:"#FFFF00", price:260, type:"propiedad"},
    {name:"Calle O'Donnell", color:"#FFFF00", price:260, type:"propiedad"},
    {name:"Compa√±√≠a de agua", type:"compa√±ia", price:150},
    {name:"Calle Goya", color:"#FFFF00", price:280, type:"propiedad"},
    {name:"Ve a la c√°rcel", type:"especial"},
    {name:"Calle Alcal√°", color:"#008000", price:300, type:"propiedad"},
    {name:"Calle Gran V√≠a", color:"#008000", price:300, type:"propiedad"},
    {name:"Comunidad", type:"arca"},
    {name:"Paseo de la Castellana", color:"#008000", price:320, type:"propiedad"},
    {name:"Estaci√≥n Sur", type:"estacion", price:200},
    {name:"Suerte", type:"suerte"},
    {name:"Paseo del Prado", color:"#0000FF", price:350, type:"propiedad"},
    {name:"Impuesto de lujo", type:"impuesto"},
    {name:"Calle Serrano Mayor", color:"#0000FF", price:400, type:"propiedad"}
  ];
}
const BOARD = window._monopoly_board;

/* inicializa propertyData como en tu c√≥digo original */
for(let c of BOARD){
  if(c.type === "propiedad" && c.price){
    const base = Math.max(1, Math.floor(c.price * 0.1));
    c.propertyData = {
      price: c.price,
      rent: [
        base,
        Math.floor(base * 3),
        Math.floor(base * 8),
        Math.floor(base * 18),
        Math.floor(base * 30),
        Math.floor(base * 50)
      ],
      houseCost: Math.max(10, Math.floor(c.price * 0.5)),
      hotelCost: Math.max(10, Math.floor(c.price * 0.5)),
      houses: 0,
      hotel: false
    };
  }
  if((c.type === "estacion" || c.type === "compa√±ia") && c.price){
    c.propertyData = { price: c.price, houses:0, hotel:false };
  }
}

/* players: por defecto 2 (Jugador vs IA). En multiplayer las entradas se sincronizan */
let players = [
  {id: 'p1', name:"Jugador", color:"#1f77b4", pos:0, money:1500, properties:[], inJail:false, jailTurns:0, hasGetOutCard:false},
  {id: 'p2', name:"IA", color:"#d62728", pos:0, money:1500, properties:[], inJail:false, jailTurns:0, hasGetOutCard:false}
];

let current = 0;
let animating = false;
let diceRolling = false;
let diceResult = [1,1];
let lastRollWasDouble = false;
let suerteDeck = [], arcaDeck = [];

/* UI refs (esperan que tu HTML tenga estos ids) */
const playerHandDiv = document.getElementById('playerHand');
const aiHandDiv = document.getElementById('aiHand');
const playerMoneyEl = document.getElementById('playerMoney');
const aiMoneyEl = document.getElementById('aiMoney');
const rollBtn = document.getElementById('rollBtn');
const payJailBtn = document.getElementById('payJailBtn');
const useCardBtn = document.getElementById('useCardBtn');
const infoBox = document.getElementById('infoBox');
const turnName = document.getElementById('turnName');
const playersListDiv = document.getElementById('playersList');
const suerteCount = document.getElementById('suerteCount');
const arcaCount = document.getElementById('arcaCount');
const cardModal = document.getElementById('cardModal');
const cardTextEl = document.getElementById('cardText');
const closeCardBtn = document.getElementById('closeCardBtn');

/* prop modal refs */
const propModal = document.getElementById('propModal');
const pmName = document.getElementById('pmName');
const pmColor = document.getElementById('pmColor');
const pmPrice = document.getElementById('pmPrice');
const pmHouseCost = document.getElementById('pmHouseCost');
const pmHotelCost = document.getElementById('pmHotelCost');
const pmRents = document.getElementById('pmRents');
const pmImprovements = document.getElementById('pmImprovements');
const buyHouseBtn = document.getElementById('buyHouseBtn');
const buyHotelBtn = document.getElementById('buyHotelBtn');
const closePropBtn = document.getElementById('closePropBtn');
const propMsg = document.getElementById('propMsg');

/* ------------------ Helpers y l√≥gica de UI de mano / tarjetas ------------------ */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
function showMsg(t){ infoBox.textContent = t; }

/* Decks (id√©nticos a tus funciones) */
function createDecks(){
  suerteDeck = [
    {text:"Avanza a Salida. Cobra $200.", action:(p)=>{ p.pos=0; p.money+=200; showMsg(`${p.name} avanza a Salida y cobra $200`); }},
    {text:"Ve a la C√°rcel (no cobras por pasar).", action:(p)=>{ p.pos=10; p.inJail=true; p.jailTurns=0; showMsg(`${p.name} va a la c√°rcel`); }},
    {text:"Cobras $150.", action:(p)=>{ p.money+=150; showMsg(`${p.name} cobra $150`); updateHUD(); }},
    {text:"Paga $50.", action:(p)=>{ p.money-=50; showMsg(`${p.name} paga $50`); updateHUD(); }},
    {text:"Toma tarjeta 'Salir de la c√°rcel'.", action:(p)=>{ p.hasGetOutCard=true; addCardToPlayerHand(p, {name:"Salir de la c√°rcel", type:"card", desc:"Usa para salir de la c√°rcel"}); showMsg(`${p.name} obtiene 'Salir de la c√°rcel'`); }},
    {text:"Avanza a Paseo del Prado.", action:(p)=>{ p.pos=38; showMsg(`${p.name} avanza a Paseo del Prado`); }},
    {text:"Avanza a la pr√≥xima estaci√≥n. Paga si no es tuya.", action:(p)=>{ advanceToNextStation(p); }}
  ];
  arcaDeck = [
    {text:"Cobras $100.", action:(p)=>{ p.money+=100; showMsg(`${p.name} cobra $100`); updateHUD(); }},
    {text:"Paga $50.", action:(p)=>{ p.money-=50; showMsg(`${p.name} paga $50`); updateHUD(); }},
    {text:"Toma tarjeta 'Salir de la c√°rcel'.", action:(p)=>{ p.hasGetOutCard=true; addCardToPlayerHand(p, {name:"Salir de la c√°rcel", type:"card", desc:"Usa para salir de la c√°rcel"}); showMsg(`${p.name} obtiene 'Salir de la c√°rcel'`); }},
    {text:"Recibe $40 de otros (simplificado).", action:(p)=>{ p.money+=40; showMsg(`${p.name} recibe $40 (simplificado)`); updateHUD(); }},
    {text:"Avanza a Salida. Cobra $200.", action:(p)=>{ p.pos=0; p.money+=200; showMsg(`${p.name} avanza a Salida y cobra $200`); updateHUD(); }}
  ];
  shuffle(suerteDeck);
  shuffle(arcaDeck);
}

/* geometry y drawBoard (id√©nticos a tu c√≥digo original) */
/* --- (mant√©n tus funciones getCellRect, wrapText, drawBoard, drawDicePreview...) --- */

/* para no repetir mucho texto en la respuesta, asumo que las funciones gr√°ficas que ya tienes
   (getCellRect, wrapText, drawBoard, drawPips, drawDicePreview) se mantienen igual en tu HTML.
   Si necesitas que te vuelva a pegar esas funciones exactamente, d√≠melo y te las pego. */

/* ------------------ HAND UI & ANIMACIONES (id√©ntico + mejora modal) ------------------ */
/* createHandCardDOM y funciones de animaci√≥n: mantenlas (ya las tienes) */
function createHandCardDOM(item){
  const el = document.createElement('div');
  el.className = 'handCard';
  const stripe = document.createElement('div');
  stripe.className = 'stripe';
  stripe.style.background = item.color || '#ddd';
  el.appendChild(stripe);
  const name = document.createElement('div'); name.textContent = item.name; name.style.fontWeight='700'; name.style.marginBottom='6px';
  el.appendChild(name);
  if(item.propertyData){
    const price = document.createElement('div'); price.textContent = `$${item.propertyData.price}`; price.style.fontSize='12px'; price.style.color='#444';
    el.appendChild(price);
    const imp = document.createElement('div'); imp.style.fontSize='12px'; imp.style.marginTop='6px';
    imp.textContent = `Casas: ${item.propertyData.houses || 0} ${item.propertyData.hotel ? 'Hotel' : ''}`;
    el.appendChild(imp);
  } else if(item.type === 'card'){
    const desc = document.createElement('div'); desc.textContent = item.desc || ''; desc.style.fontSize='12px'; desc.style.color='#555';
    el.appendChild(desc);
  } else {
    const price = document.createElement('div'); price.textContent = item.price?`$${item.price}`:""; price.style.fontSize='12px'; price.style.color='#444';
    el.appendChild(price);
  }
  return el;
}

function addCardToPlayerHandDOM(playerIndex, item){
  const container = (playerIndex === 0) ? playerHandDiv : aiHandDiv;
  const empty = container.querySelector('.handEmpty');
  if(empty) empty.remove();
  const cardDOM = createHandCardDOM(item);
  cardDOM.addEventListener('click', ()=>{
    openPropertyModal(players[playerIndex], item, 'view');
  });
  container.appendChild(cardDOM);
}
function addCardToPlayerHand(playerObj, item){
  playerObj.properties.push(item);
  const pIndex = players.indexOf(playerObj);
  addCardToPlayerHandDOM(pIndex, item);
  updateHUD();
}

/* ------------------ PROPERTY MODAL: ahora soporta modo 'view' y 'buy' ------------------ */
let modalOpenFor = null;
function openPropertyModal(playerObj, p, mode='view'){
  modalOpenFor = p;
  pmName.textContent = p.name;
  pmColor.style.background = p.color || '#ddd';
  pmPrice.textContent = p.propertyData ? p.propertyData.price : (p.price || "-");
  pmHouseCost.textContent = p.propertyData ? p.propertyData.houseCost : "-";
  pmHotelCost.textContent = p.propertyData ? p.propertyData.hotelCost : "-";
  if(p.propertyData){
    pmRents.innerHTML = `
      Base: $${p.propertyData.rent[0]}<br>
      1 Casa: $${p.propertyData.rent[1]}<br>
      2 Casas: $${p.propertyData.rent[2]}<br>
      3 Casas: $${p.propertyData.rent[3]}<br>
      4 Casas: $${p.propertyData.rent[4]}<br>
      Hotel: $${p.propertyData.rent[5]}
    `;
    pmImprovements.textContent = `${p.propertyData.houses || 0} casas ${p.propertyData.hotel ? "y hotel" : ""}`;
  } else {
    pmRents.innerHTML = `<i>No aplicable</i>`;
    pmImprovements.textContent = "-";
  }
  propMsg.textContent = "";

  // Ajuste de botones seg√∫n modo:
  if(mode === 'buy'){
    // mostrar bot√≥n COMPRAR
    buyHouseBtn.style.display = "none";
    buyHotelBtn.style.display = "none";
    // reutilizamos buyHouseBtn como 'Comprar' en este modo temporalmente
    buyHouseBtn.textContent = "Comprar propiedad";
    buyHouseBtn.style.display = "inline-block";
    buyHouseBtn.disabled = false;
    // desactivar buyHotelBtn
    buyHotelBtn.style.display = "none";

    // remap evento comprar en este contexto
    buyHouseBtn.onclick = ()=>{
      const pl = playerObj;
      const prop = p;
      if(pl.money >= prop.price){
        pl.money -= prop.price;
        prop.owner = pl.name;
        // a√±ade la carta de la propiedad a la mano del comprador
        addCardToPlayerHand(pl, prop);
        propMsg.textContent = `${pl.name} compr√≥ ${prop.name} por $${prop.price}.`;
        updateHUD(); drawBoard();
        // restaurar texto del bot√≥n
        buyHouseBtn.textContent = "Comprar casa";
        buyHouseBtn.onclick = buyHouseHandler;
        propModal.style.display = "none";
        modalOpenFor = null;
      } else {
        propMsg.textContent = "No tienes dinero suficiente.";
      }
    };
  } else {
    // modo view: mostrar botones de gesti√≥n solo si el jugador es propietario
    const currentPlayerObj = players[current];
    const ownerName = p.owner || null;
    if(ownerName === currentPlayerObj.name && p.propertyData){
      buyHouseBtn.style.display = "inline-block";
      buyHotelBtn.style.display = "inline-block";
      buyHouseBtn.disabled = false;
      buyHotelBtn.disabled = false;
    } else {
      buyHouseBtn.style.display = "none";
      buyHotelBtn.style.display = "none";
    }
    // restauramos texto y handlers por defecto
    buyHouseBtn.textContent = "Comprar casa";
    buyHouseBtn.onclick = buyHouseHandler;
    buyHotelBtn.onclick = buyHotelHandler;
  }

  propModal.style.display = "flex";
}

function buyHouseHandler(){
  const p = modalOpenFor;
  const pl = players[current];
  if(!p || !p.propertyData){ propMsg.textContent = "No es propiedad construible."; return; }
  if(p.owner !== pl.name){ propMsg.textContent = "No eres el propietario."; return; }
  if(p.propertyData.hotel){ propMsg.textContent = "Ya tienes hotel."; return; }
  if(p.propertyData.houses >= 4){ propMsg.textContent = "4 casas alcanzadas; compra hotel."; return; }
  const cost = p.propertyData.houseCost;
  if(pl.money < cost){ propMsg.textContent = "No tienes dinero suficiente."; return; }
  pl.money -= cost; p.propertyData.houses++;
  propMsg.textContent = `Comprada 1 casa por $${cost}.`;
  updateHUD(); drawBoard();
  openPropertyModal(pl,p,'view');
}

function buyHotelHandler(){
  const p = modalOpenFor;
  const pl = players[current];
  if(!p || !p.propertyData){ propMsg.textContent = "No es propiedad construible."; return; }
  if(p.owner !== pl.name){ propMsg.textContent = "No eres el propietario."; return; }
  if(p.propertyData.hotel){ propMsg.textContent = "Ya tienes hotel."; return; }
  if(p.propertyData.houses < 4){ propMsg.textContent = "Necesitas 4 casas antes de comprar hotel."; return; }
  const cost = p.propertyData.hotelCost;
  if(pl.money < cost){ propMsg.textContent = "No tienes dinero suficiente."; return; }
  pl.money -= cost; p.propertyData.houses = 0; p.propertyData.hotel = true;
  propMsg.textContent = `Comprado hotel por $${cost}.`;
  updateHUD(); drawBoard();
  openPropertyModal(pl,p,'view');
}

closePropBtn.addEventListener('click', ()=>{ propModal.style.display = "none"; modalOpenFor = null; });

/* ------------------ Movimiento, dados, landing (mejorado para mostrar carta al caer) ------------------ */
function randDice(){ return Math.floor(Math.random()*6)+1; }

/* Reusa tu rollDiceAnimated/drawDicePreview/drawPips tal cual; por brevedad no los repito. */

/* animateMove y handleLanding: al caer en propiedad mostramos modal en 'buy' si est√° libre y jugador es humano */
function animateMove(player, steps){
  if(animating) return;
  animating = true;
  let s = 0;
  function step(){
    if(s < steps){
      player.pos++;
      if(player.pos >= 40){ player.pos -= 40; player.money += 200; showMsg(`${player.name} pasa por Salida +$200`); }
      s++;
      // si est√°s en modo multiplayer, la posici√≥n deber√≠a sincronizarse con la sala (m√°s abajo se explica)
      drawBoard(); updateHUD();
      setTimeout(step, 180);
    } else {
      animating = false;
      handleLandingWithDoubles(player);
    }
  }
  step();
}

function handleLandingWithDoubles(pl){
  const cell = BOARD[pl.pos];

  // si es propiedad / estacion / compa√±ia
  if(cell.type === "propiedad" || cell.type === "estacion" || cell.type === "compa√±ia"){
    if(!cell.owner){
      if(pl.name === "Jugador" || (isMultiplayerLocalPlayer(pl) && !isMultiplayerRoomHost())){
        // si es el jugador local: mostramos la modal de compra (modo 'buy')
        openPropertyModal(pl, cell, 'buy');
      } else if(pl.name === "IA" || (isMultiplayerLocalPlayer(pl) && isMultiplayerRoomHost()===false)){
        // IA o jugador remoto autom√°tico: l√≥gica de compra simple
        if(pl.money > (cell.price || 0) + 200){
          pl.money -= cell.price;
          cell.owner = pl.name;
          addCardToPlayerHand(pl, cell);
          showMsg(`${pl.name} compra ${cell.name}`);
        } else {
          showMsg(`${pl.name} no compra ${cell.name}`);
        }
        drawBoard(); updateHUD();
        setTimeout(()=> nextTurn(), 800);
      } else {
        // fallback: preguntar (en navegador esto ser√≠a el humano)
        const ok = confirm(`¬øComprar ${cell.name} por $${cell.price}?`);
        if(ok){
          if(pl.money >= cell.price){
            pl.money -= cell.price;
            cell.owner = pl.name;
            addCardToPlayerHand(pl, cell);
            showMsg(`${pl.name} compra ${cell.name}`);
            updateHUD();
            drawBoard();
          } else {
            showMsg("No tienes dinero suficiente.");
          }
        } else showMsg(`${pl.name} no compra ${cell.name}`);
        setTimeout(()=> nextTurn(), 800);
      }
      return;
    } else if(cell.owner !== pl.name){
      const owner = players.find(p => p.name === cell.owner);
      let rent = 0;
      if(cell.propertyData){
        if(cell.propertyData.hotel) rent = cell.propertyData.rent[5];
        else rent = cell.propertyData.rent[cell.propertyData.houses || 0];
      } else {
        rent = Math.floor(cell.price/2);
      }
      pl.money -= rent; owner.money += rent;
      showMsg(`${pl.name} paga $${rent} a ${owner.name}`);
      drawBoard(); updateHUD();
      setTimeout(()=> nextTurn(), 800);
      return;
    } else {
      showMsg(`${pl.name} cae en su propia propiedad`);
      drawBoard(); updateHUD();
      setTimeout(()=> nextTurn(), 800);
      return;
    }
  }

  // resto tipo impuesto, suerte, etc (id√©ntico)
  if(cell.type === "impuesto"){
    pl.money -= 100;
    showMsg(`${pl.name} paga impuesto $100`);
    drawBoard(); updateHUD();
    setTimeout(()=> nextTurn(), 800);
    return;
  }

  if(cell.type === "suerte" || cell.type === "arca"){
    animateTakeCard(cell.type, pl);
    return;
  }

  if(cell.name === "Ve a la c√°rcel"){
    pl.pos = 10; pl.inJail = true; pl.jailTurns = 0;
    showMsg(`${pl.name} va directo a la c√°rcel`);
    drawBoard(); updateHUD();
    setTimeout(()=> nextTurn(), 800);
    return;
  }

  if(cell.name === "C√°rcel"){
    showMsg(`${pl.name} est√° en la casilla de C√°rcel`);
    setTimeout(()=> nextTurn(), 800);
    return;
  }

  showMsg(`${pl.name} cae en ${cell.name}`);
  setTimeout(()=> nextTurn(), 800);
}

/* ------------------ Resto de l√≥gica (jail, AI, dados) ------------------ */
/* Reutiliza tu c√≥digo existente para rollForJail, aiTakeTurn, rollDiceAnimated, revealCard, etc. */
/* ... (c√≥rtalos aqu√≠ y reusa tus funciones del HTML original, que ya estaban probadas) ... */

/* ------------------ HUD y render de manos ------------------ */
function updateHUD(){
  turnName.textContent = players[current].name;
  playersListDiv.innerHTML = "";
  players.forEach(p=>{
    const row = document.createElement('div'); row.className = "playerRow";
    const left = document.createElement('div'); left.innerHTML = `<strong style="color:${p.color}">${p.name}</strong><br><span class="small">Pos: ${p.pos}</span>`;
    const right = document.createElement('div'); right.innerHTML = `<div>$${p.money}</div><div class="small">${p.properties.length} cartas</div>`;
    row.appendChild(left); row.appendChild(right);
    playersListDiv.appendChild(row);
  });
  suerteCount.textContent = suerteDeck.length;
  arcaCount.textContent = arcaDeck.length;
  playerMoneyEl.textContent = `$${players[0].money}`;
  aiMoneyEl.textContent = `$${players[1].money}`;
  const pl = players[current];
  if(pl.inJail){
    payJailBtn.style.display = "inline-block";
    useCardBtn.style.display = pl.hasGetOutCard ? "inline-block" : "none";
  } else {
    payJailBtn.style.display = "none";
    useCardBtn.style.display = "none";
  }
  // render manos
  playerHandDiv.innerHTML = ''; aiHandDiv.innerHTML = '';
  if(players[0].properties.length === 0) playerHandDiv.innerHTML = '<div class="handEmpty">Sin propiedades</div>';
  if(players[1].properties.length === 0) aiHandDiv.innerHTML = '<div class="handEmpty">Sin propiedades</div>';
  for(let it of players[0].properties) addCardToPlayerHandDOM(0, it);
  for(let it of players[1].properties) addCardToPlayerHandDOM(1, it);
}

/* ------------------ MULTIPLAYER: funciones b√°sicas con Supabase ------------------ */
async function createRoom(roomName){
  if(!supabase) return { ok:false, err:"Supabase no configurado" };
  try {
    // tabla 'rooms' con columnas: id (text), state jsonb, created_at timestamp
    const initialState = {
      board: BOARD,
      players,
      current,
      turnTimestamp: Date.now(),
      chat: []
    };
    const { data, error } = await supabase.from('rooms').insert([{ id: roomName, state: initialState }]).select().single();
    if(error) return { ok:false, err:error.message };
    subscribeToRoom(roomName);
    return { ok:true, data };
  } catch(e){
    return { ok:false, err:e.message };
  }
}

async function joinRoom(roomName){
  if(!supabase) {
    alert("Supabase no configurado.");
    return false;
  }
  try {
    const { data, error } = await supabase.from('rooms').select().eq('id', roomName).single();
    if(error || !data) {
      console.warn("No existe sala", error);
      return false;
    }
    // sync local state with room
    const st = data.state || {};
    if(st.players) players = st.players;
    if(typeof st.current !== 'undefined') current = st.current;
    subscribeToRoom(roomName);
    showMsg(`Conectado a sala: ${roomName}`);
    updateHUD(); drawBoard();
    return true;
  } catch(e){
    console.warn("Error joinRoom:", e);
    return false;
  }
}

let roomSubscription = null;
let currentRoomId = null;
function subscribeToRoom(roomName){
  if(!supabase) return;
  currentRoomId = roomName;
  if(roomSubscription){
    try { roomSubscription.unsubscribe(); } catch(e) {}
    roomSubscription = null;
  }

  // suscripci√≥n en tiempo real: escucha cambios en la fila con id = roomName
  roomSubscription = supabase
    .channel(`public:rooms:id=eq.${roomName}`)
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomName}` }, (payload) => {
      if(payload && payload.new && payload.new.state){
        const st = payload.new.state;
        // aplicar estado recibido a cliente
        if(st.players) players = st.players;
        if(typeof st.current !== 'undefined') current = st.current;
        showMsg(`Sincronizado sala ${roomName}`);
        updateHUD(); drawBoard();
      }
    })
    .subscribe((status)=>{
      if(status === 'SUBSCRIBED') {
        console.log("Suscrito a sala", roomName);
      }
    });
}

/* Guarda el estado de la sala en Supabase */
async function saveRoomState(){
  if(!supabase || !currentRoomId) return;
  const payload = {
    state: {
      board: BOARD,
      players,
      current,
      turnTimestamp: Date.now()
    }
  };
  const { error } = await supabase.from('rooms').update(payload).eq('id', currentRoomId);
  if(error) console.warn("Error guardando estado sala:", error);
}

/* Utilidades multiplayer r√°pidas */
function isMultiplayerLocalPlayer(pl){
  // aqu√≠ simple: si el nombre coincide con 'Jugador' lo consideramos local
  // en una integraci√≥n real mapear√≠as users -> player ids
  return pl.name === "Jugador";
}
function isMultiplayerRoomHost(){
  // simplificado: el que crea la sala ser√≠a host; en este ejemplo asumimos p1 es host
  return true;
}

/* ------------------ START/ONE-PLAYER helper ------------------ */
function startOnePlayer(){
  // deja players como Jugador vs IA
  players = [
    {id:'p1', name:"Jugador", color:"#1f77b4", pos:0, money:1500, properties:[], inJail:false, jailTurns:0, hasGetOutCard:false},
    {id:'p2', name:"IA", color:"#d62728", pos:0, money:1500, properties:[], inJail:false, jailTurns:0, hasGetOutCard:false}
  ];
  current = 0;
  createDecks();
  drawBoard(); updateHUD();
  showMsg("Modo One Player listo. Pulsa 'Tirar dados'.");
}

/* ------------------ Inicializaci√≥n final ------------------ */
createDecks();
drawBoard();
updateHUD();
showMsg("Juego listo. Pulsa 'Tirar dados'.");

/* keep board refreshing (mant√©n tu setInterval original si lo ten√≠as) */
setInterval(()=>{ if(!diceRolling) drawBoard(); }, 700);

/* ------------------ Nota final ------------------ */
/*
- Este script provee la estructura completa y los puntos de integraci√≥n con Supabase.
- Algunas funciones gr√°ficas (drawBoard, drawPips, rollDiceAnimated, revealCard, etc.)
  deben copiarse exactamente de tu script original si ya estaban implementadas.
- Para multiplayer real deber√≠as crear en Supabase una tabla 'rooms' con:
    id text PRIMARY KEY,
    state jsonb,
    created_at timestamp default now()
  y dar permisos R/W al anon public (o usar RLS seg√∫n necesites).
- Cuando quieras, te pego las funciones faltantes (drawBoard exacto, drawPips, rollDiceAnimated)
  si quieres el archivo listo para pegar completo sin tener que insertar nada m√°s.
*/
</script>
</body>
</html>
