<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peri√≥dico</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body {
  background: #1a001a;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
}
.section {
  background: rgba(30,0,30,0.85);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}
input, textarea {
  width: 80%;
  margin: 5px 0;
  padding: 8px;
  border-radius: 6px;
  border: none;
}
button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #b517ff;
  color: #fff;
  margin: 5px;
}
</style>
</head>
<body>

<h1>üì∞ Peri√≥dico</h1>

<!-- Lista de noticias -->
<div id="noticiasList" class="section">Cargando noticias...</div>

<!-- Ajustes de Peketruli -->
<div id="ajustesDiv" class="section" style="display:none;">
  <h3>‚öôÔ∏è Ajustes del Peri√≥dico</h3>
  <p>Otorga o quita permisos de publicaci√≥n:</p>
  <div id="usuariosList">Cargando usuarios...</div>
</div>

<!-- Crear noticia para usuarios con permisos -->
<div id="crearNoticiaDiv" class="section" style="display:none;">
  <h3>üñä Crear noticia</h3>
  <input type="text" id="tituloNoticia" placeholder="T√≠tulo"><br>
  <textarea id="contenidoNoticia" rows="4" placeholder="Contenido"></textarea><br>
  <input type="file" id="imagenNoticia"><br>
  <button onclick="crearNoticia()">Publicar noticia</button>
</div>

<script>
const SUPABASE_URL = "TU_SUPABASE_URL";
const SUPABASE_KEY = "TU_SUPABASE_KEY";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;

async function initUser() {
  const saved = localStorage.getItem("currentUser");
  if (saved) currentUser = JSON.parse(saved);

  // Solo Peketruli ve ajustes
  if (currentUser?.username === "Peketruli") {
    document.getElementById("ajustesDiv").style.display = "block";
    cargarUsuarios();
  }

  // Usuarios con permisos pueden crear noticias
  if (currentUser?.puede_publicar) {
    document.getElementById("crearNoticiaDiv").style.display = "block";
  }

  cargarNoticias();
}

// -------------------- Noticias --------------------
async function cargarNoticias() {
  const { data, error } = await supabase
    .from("noticias")
    .select("id, titulo, contenido, imagen_url, fecha_creacion, usuarios(username)")
    .eq("publicada", true)
    .order("fecha_creacion", { ascending: false });

  if (error) return document.getElementById("noticiasList").innerText = "Error cargando noticias.";

  if (!data || data.length === 0) {
    document.getElementById("noticiasList").innerText = "No hay noticias todav√≠a.";
    return;
  }

  document.getElementById("noticiasList").innerHTML = data.map(n => `
    <div style="margin-bottom:12px; padding:10px; border:1px solid #ff6f00; border-radius:8px;">
      <strong>${n.titulo}</strong> <br>
      <small>${new Date(n.fecha_creacion).toLocaleString()}</small><br>
      <div>${n.contenido}</div>
      ${n.imagen_url ? `<img src="${n.imagen_url}" style="max-width:200px; margin-top:8px; border-radius:6px;">` : ""}
      <br><em>Autor: ${n.usuarios?.username || 'Desconocido'}</em>
    </div>
  `).join("");
}

// -------------------- Ajustes de Peketruli --------------------
async function cargarUsuarios() {
  const { data, error } = await supabase
    .from("usuarios")
    .select("id, username, puede_publicar")
    .neq("username", "Peketruli");

  if (error) return document.getElementById("usuariosList").innerText = "Error cargando usuarios.";

  document.getElementById("usuariosList").innerHTML = data.map(u => `
    <div style="margin-bottom:6px;">
      ${u.username} 
      <button onclick="togglePermiso('${u.id}', ${u.puede_publicar})">
        ${u.puede_publicar ? "Quitar permiso" : "Dar permiso"}
      </button>
    </div>
  `).join("");
}

async function togglePermiso(userId, actual) {
  const { error } = await supabase.from("usuarios").update({ puede_publicar: !actual }).eq("id", userId);
  if (error) return alert("Error actualizando permiso.");
  cargarUsuarios();
}

// -------------------- Crear noticia --------------------
async function crearNoticia() {
  const titulo = document.getElementById("tituloNoticia").value.trim();
  const contenido = document.getElementById("contenidoNoticia").value.trim();
  const archivo = document.getElementById("imagenNoticia").files[0];

  if (!titulo || !contenido) return alert("Completa t√≠tulo y contenido.");

  let imagen_url = null;
  if (archivo) {
    const { data, error } = await supabase.storage.from("periodico").upload(`noticias/${archivo.name}`, archivo, { upsert: true });
    if (error) return alert("Error subiendo imagen.");
    imagen_url = supabase.storage.from("periodico").getPublicUrl(`noticias/${archivo.name}`).publicUrl;
  }

  const { error } = await supabase.from("noticias").insert([{
    titulo,
    contenido,
    imagen_url,
    autor_id: currentUser.id
  }]);
  if (error) return alert("Error publicando noticia.");

  alert("‚úÖ Noticia publicada.");
  document.getElementById("tituloNoticia").value = "";
  document.getElementById("contenidoNoticia").value = "";
  document.getElementById("imagenNoticia").value = "";
  cargarNoticias();
}

document.addEventListener("DOMContentLoaded", initUser);
</script>
</body>
</html>
