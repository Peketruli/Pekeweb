<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rebeld√≠a IN.AR ‚Äî Noticias</title>

<!-- Fuentes -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Creepster&display=swap" rel="stylesheet">

<!-- Dependencias -->
<script src="https://unpkg.com/@supabase/supabase-js"></script>

<style>
:root{
  --text: #f5f3f4;
  --accent-orange: #ff8a33;
  --accent-purple: #6b2a7a;
}

/* Reset base */
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%; font-family:"Inter", Arial, sans-serif; color:var(--text);}
body { background: linear-gradient(180deg,#1b0b2b 0%,#3a103a 50%,#0b0b0b 100%); padding:50px 20px 140px; }

/* Contenedores y cards */
.container {text-align: center; max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:26px; align-items:center;}
.card { background: rgba(255,255,255,0.02); border-radius:14px; padding:18px; box-shadow: 0 6px 30px rgba(0,0,0,0.6); backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,0.03); color: #eae8e8; text-align: center; width:100%; max-width:800px; }
.lead { font-size:16px; line-height:1.5; color:#eae8e8; }

/* Botones */
.btn { font-weight:600; padding:12px 22px; border-radius:12px; border:none; cursor:pointer; color:white; background:linear-gradient(180deg,#f39c12,#f57c00); margin:4px; transition:all .25s ease; }
.btn:hover { transform: scale(1.1) translateY(-3px); box-shadow:0 0 50px 18px rgba(255,160,70,0.9),0 18px 60px rgba(0,0,0,0.7); }

/* Publicar noticia */
#publicarContainer { display:none; background:#222; padding:10px; border-radius:8px; margin-bottom:20px; }
#editor { background:#333; padding:10px; border-radius:8px; min-height:150px; border:1px solid #555; text-align:left; overflow:auto; }
#editorToolbar button { margin:2px; padding:4px 8px; border-radius:4px; border:none; cursor:pointer; }
#noticiasList { list-style:none; padding:0; margin-top:10px; }
.noticia-item { background:#222; padding:10px; border-radius:8px; margin-bottom:10px; text-align:left; }
.noticia-item img { max-width:100%; margin-top:6px; display:block; }

.auth-container, .user-info { position:fixed; top:16px; right:16px; display:flex; align-items:center; gap:10px; z-index:10; }
.auth-button { padding:10px 18px; font-size:1em; color:white; background-color:#333; border:none; cursor:pointer; border-radius:6px; text-decoration:none; }
.user-info { display:none; cursor:pointer; }
#userLogo { width:40px; height:40px; border-radius:50%; }
#userName { font-weight:600; font-size:1em; color:white; }

.dropdown-menu { display:none; position:absolute; top:56px; right:0; background-color:#000; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.4); width:160px; text-align:left; z-index:10; }
.dropdown-menu td { padding:10px; cursor:pointer; color:white; }
.dropdown-menu td:hover { background-color: #333; }
</style>
</head>
<body>

<div class="container">

  <div class="header card" role="banner">
    <h1 style="font-family:'Creepster',cursive; color:var(--accent-orange); font-size:48px;">Rebeld√≠a IN.AR</h1>
    <p class="lead">Un lugar para el alumnado ‚Äî ahora con noticias y editor estilo documento üì∞</p>
  </div>

  <!-- BOT√ìN AJUSTES (solo admin) -->
  <div id="ajustesContainer" style="display:none; margin-bottom:12px;">
    <button class="btn" onclick="mostrarAjustes()">‚öôÔ∏è Ajustes de Publicaci√≥n</button>
  </div>

  <!-- DIV AJUSTES -->
  <div id="ajustesDiv" style="display:none; background:#222; padding:10px; border-radius:8px; margin-bottom:20px;">
    <h3>Gestionar permisos de publicaci√≥n</h3>
    <ul id="listaUsuariosPermisos"></ul>
  </div>

  <!-- PUBLICAR NOTICIA -->
  <div id="publicarContainer">
    <h3>üì¢ Crear Noticia</h3>
    <input type="text" id="noticiaTitulo" placeholder="T√≠tulo de la noticia" style="width:100%; margin-bottom:8px; padding:6px; border-radius:6px; border:1px solid #555; background:#333; color:#fff;">
    <div id="editorToolbar" style="margin-bottom:8px;">
      <button data-cmd="bold">B</button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertOrderedList">1.</button>
      <button data-cmd="insertUnorderedList">‚Ä¢</button>
      <button data-cmd="createLink">üîó</button>
      <button data-cmd="insertImage">üñºÔ∏è</button>
      <button data-cmd="formatBlock" onclick="document.execCommand('formatBlock', false, 'h3')">H3</button>
    </div>
    <div id="editor" contenteditable="true">‚úèÔ∏è Escribe tu noticia aqu√≠...</div>
    <button class="btn" style="margin-top:8px;" onclick="publicarNoticia()">Publicar Noticia</button>
  </div>

  <!-- LISTA DE NOTICIAS -->
  <h2 style="color:var(--accent-orange)">Noticias Recientes</h2>
  <ul id="noticiasList"></ul>

</div>

<!-- AUTH -->
<div class="auth-container" id="authContainer">
  <button class="auth-button" onclick="window.location.href='l.html'">Iniciar sesi√≥n / Registrarse</button>
</div>

<div class="user-info" id="userInfo">
  <img id="userLogo" src="logoDefault.png" alt="Logo del usuario">
  <div style="text-align:left">
    <div id="userName">Usuario</div>
    <div style="font-size:12px;color:#cfcacd">Ver perfil</div>
  </div>
</div>

<div class="dropdown-menu" id="dropdownMenu">
  <table>
    <tr><td onclick="logout()">üö™ Cerrar sesi√≥n</td></tr>
  </table>
</div>

<script>
// ==================== SUPABASE ====================
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let permisosPublicar = [];

document.addEventListener("DOMContentLoaded", async () => {
    await initUser();
    await loadPermisos();
    renderUserUI();
    await loadNoticias();
    initEditorTools();
    setupUserUI();
});

// ==================== USUARIO ====================
async function initUser() {
    const saved = localStorage.getItem("currentUser");
    if (saved) { currentUser = JSON.parse(saved); return; }

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data, error } = await supabase
        .from("usuarios")
        .select("*")
        .eq("auth_id", user.id)
        .maybeSingle();
    if (error || !data) return;

    currentUser = data;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

function renderUserUI() {
    const ajustesBtnContainer = document.getElementById("ajustesContainer");
    const publicarDiv = document.getElementById("publicarContainer");
    if (!currentUser) return;
    ajustesBtnContainer.style.display = currentUser.username === "Peketruli" ? "block" : "none";
    publicarDiv.style.display = (permisosPublicar.includes(currentUser.id) || currentUser.username === "Peketruli") ? "block" : "none";
}

// ==================== PERMISOS ====================
async function loadPermisos() {
    const { data, error } = await supabase.from("usuarios").select("id, username, puede_publicar");
    if (error) return console.error(error);
    permisosPublicar = data.filter(u => u.puede_publicar).map(u => u.id);
    renderUserUI();
}

async function togglePermiso(usuarioId) {
    const usuario = permisosPublicar.includes(usuarioId);
    const { error } = await supabase
        .from("usuarios")
        .update({ puede_publicar: !usuario })
        .eq("id", usuarioId);
    if (error) return alert("Error actualizando permiso: " + error.message);
    await loadPermisos();
    mostrarAjustes();
}

// ==================== AJUSTES ====================
async function mostrarAjustes() {
    const ajustesDiv = document.getElementById("ajustesDiv");
    ajustesDiv.style.display = ajustesDiv.style.display === "block" ? "none" : "block";
    if (ajustesDiv.style.display === "block") {
        const { data, error } = await supabase.from("usuarios").select("id, username, puede_publicar");
        if (error) return console.error(error);
        const lista = document.getElementById("listaUsuariosPermisos");
        lista.innerHTML = "";
        data.forEach(u => {
            const esPeketruli = u.username === "Peketruli";
            const li = document.createElement("li");
            li.innerHTML = `${u.username} ${!esPeketruli ? `<button onclick="togglePermiso('${u.id}')">${u.puede_publicar ? "Quitar permiso" : "Dar permiso"}</button>` : "(admin)"}`;
            lista.appendChild(li);
        });
    }
}

// ==================== NOTICIAS ====================
async function loadNoticias() {
    const noticiasList = document.getElementById("noticiasList");
    noticiasList.innerHTML = "<li>Cargando noticias...</li>";
    const { data, error } = await supabase
        .from("noticias")
        .select("id, titulo, contenido, fecha_creacion, autor_id(username)")
        .eq("publicada", true)
        .order("fecha_creacion", { ascending: false });
    if (error) return console.error(error);
    noticiasList.innerHTML = "";
    if (!data || data.length === 0) { noticiasList.innerHTML = "<li>No hay noticias a√∫n.</li>"; return; }
    data.forEach(n => {
        const li = document.createElement("li");
        li.className = "noticia-item";
        li.innerHTML = `<h3>${n.titulo}</h3><div>${n.contenido}</div><small>Por: ${n.autor_id?.username || "Desconocido"} | ${new Date(n.fecha_creacion).toLocaleString()}</small>`;
        noticiasList.appendChild(li);
    });
}

// ==================== EDITOR ====================
function initEditorTools() {
    const editor = document.getElementById("editor");
    const toolbar = document.getElementById("editorToolbar");
    toolbar.querySelectorAll("button[data-cmd]").forEach(btn => {
        btn.addEventListener("click", () => {
            const cmd = btn.dataset.cmd;
            if (cmd === "createLink") {
                const url = prompt("Introduce la URL del enlace:");
                if (url) document.execCommand(cmd, false, url);
            } else if (cmd === "insertImage") {
                const url = prompt("Introduce la URL de la imagen:");
                if (url) document.execCommand(cmd, false, url);
            } else {
                document.execCommand(cmd, false, null);
            }
            editor.focus();
        });
    });
}

// ==================== PUBLICAR ====================
async function publicarNoticia() {
    const titulo = document.getElementById("noticiaTitulo").value.trim();
    const contenido = document.getElementById("editor").innerHTML.trim();
    if (!titulo || !contenido) return alert("Debes completar el t√≠tulo y la noticia.");
    const { error } = await supabase.from("noticias").insert({ titulo, contenido, autor_id: currentUser.id, publicada:true });
    if (error) return alert("Error publicando noticia: " + error.message);
    document.getElementById("noticiaTitulo").value = "";
    document.getElementById("editor").innerHTML = "";
    loadNoticias();
    alert("üì∞ Noticia publicada con √©xito");
}

// ==================== LOGOUT ====================
function setupUserUI() {
    const userInfo = document.getElementById("userInfo");
    const authContainer = document.getElementById("authContainer");
    const dropdownMenu = document.getElementById("dropdownMenu");

    if (currentUser) {
        userInfo.style.display = "flex";
        authContainer.style.display = "none";
        document.getElementById("userName").textContent = currentUser.username;
        document.getElementById("userLogo").src = currentUser.logo || "logoDefault.png";
    }

    userInfo.addEventListener("click", () => {
        const isOpen = dropdownMenu.style.display === "block";
        dropdownMenu.style.display = isOpen ? "none" : "block";
    });

    document.addEventListener("click", (e) => {
        if (!userInfo.contains(e.target) && !dropdownMenu.contains(e.target)) {
            dropdownMenu.style.display = "none";
        }
    });
}

function logout() {
    localStorage.removeItem("currentUser");
    window.location.href = "l.html";
}
</script>

</body>
</html>
