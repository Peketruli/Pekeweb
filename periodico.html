<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PeriÃ³dico</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body {
  background: #1a001a;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
}
.section {
  background: rgba(30,0,30,0.85);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}
input, textarea {
  width: 80%;
  margin: 5px 0;
  padding: 8px;
  border-radius: 6px;
  border: none;
}
button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #b517ff;
  color: #fff;
}
</style>
</head>
<body>
<h1>ðŸ“° PeriÃ³dico</h1>

<div id="noticiasList" class="section">Cargando noticias...</div>

<div id="nuevaNoticiaDiv" class="section" style="display:none;">
  <h3>ðŸ–Š Crear noticia</h3>
  <input type="text" id="tituloNoticia" placeholder="TÃ­tulo"><br>
  <textarea id="contenidoNoticia" rows="4" placeholder="Contenido"></textarea><br>
  <button onclick="crearNoticia()">Publicar noticia</button>
</div>

<script>
const SUPABASE_URL = "TU_SUPABASE_URL";
const SUPABASE_KEY = "TU_SUPABASE_KEY";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;

async function initUser() {
  const saved = localStorage.getItem("currentUser");
  if (saved) currentUser = JSON.parse(saved);
  if (currentUser?.puede_publicar) {
    document.getElementById("nuevaNoticiaDiv").style.display = "block";
  }
  cargarNoticias();
}

async function cargarNoticias() {
  const { data, error } = await supabase
    .from("noticias")
    .select("id, titulo, contenido, fecha_creacion, usuarios(username)")
    .eq("publicada", true)
    .order("fecha_creacion", { ascending: false });

  if (error) return document.getElementById("noticiasList").innerText = "Error cargando noticias.";

  if (!data || data.length === 0) {
    document.getElementById("noticiasList").innerText = "No hay noticias todavÃ­a.";
    return;
  }

  document.getElementById("noticiasList").innerHTML = data.map(n => `
    <div style="margin-bottom:12px; padding:10px; border:1px solid #ff6f00; border-radius:8px;">
      <strong>${n.titulo}</strong> <br>
      <small>${new Date(n.fecha_creacion).toLocaleString()}</small><br>
      <div>${n.contenido}</div>
      <em>Autor: ${n.usuarios?.username || 'Desconocido'}</em>
    </div>
  `).join("");
}

async function crearNoticia() {
  const titulo = document.getElementById("tituloNoticia").value.trim();
  const contenido = document.getElementById("contenidoNoticia").value.trim();
  if (!titulo || !contenido) return alert("Completa tÃ­tulo y contenido.");

  const { error } = await supabase.from("noticias").insert([{
    titulo,
    contenido,
    autor_id: currentUser.id
  }]);
  if (error) return alert("Error publicando noticia.");

  alert("âœ… Noticia publicada.");
  document.getElementById("tituloNoticia").value = "";
  document.getElementById("contenidoNoticia").value = "";
  cargarNoticias();
}

document.addEventListener("DOMContentLoaded", initUser);
</script>
</body>
</html>
