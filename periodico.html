<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Periódico</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
h1 { color: #ff6f00; }
button { padding: 8px 12px; margin: 4px; border-radius: 6px; border: none; cursor: pointer; }
#ajustesContainer { display: none; margin-bottom: 12px; }
#ajustesDiv { display: none; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
#publicarContainer { display: none; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
input, textarea { width: 100%; margin-bottom: 8px; padding: 6px; border-radius: 6px; border: 1px solid #555; background: #333; color: #fff; }
.noticia-item { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
.noticia-item img { max-width: 200px; display: block; margin-top: 6px; }
</style>
</head>
<body>

<h1>📰 Periódico</h1>

<!-- BOTÓN DE AJUSTES PARA PEKETRULI -->
<div id="ajustesContainer">
  <button onclick="mostrarAjustes()">⚙️ Ajustes de Publicación</button>
</div>

<!-- DIV AJUSTES -->
<div id="ajustesDiv">
  <h3>Gestionar permisos de publicación</h3>
  <ul id="listaUsuariosPermisos"></ul>
</div>

<!-- FORMULARIO PARA PUBLICAR -->
<div id="publicarContainer">
  <h3>Publicar Noticia</h3>
  <input type="text" id="noticiaTitulo" placeholder="Título de la noticia">
  <textarea id="noticiaContenido" rows="4" placeholder="Contenido de la noticia"></textarea>
  <input type="text" id="noticiaImagen" placeholder="URL de imagen (opcional)">
  <button onclick="publicarNoticia()">📢 Publicar</button>
</div>

<!-- LISTA DE NOTICIAS -->
<h2>Noticias Recientes</h2>
<ul id="noticiasList"></ul>

<script>
// ==================== JS SUPABASE ====================
// ==================== JS SUPABASE ====================
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let permisosPublicar = [];

// ------------------ INIT ------------------
document.addEventListener("DOMContentLoaded", async () => {
    await initUser();
    await loadPermisos();
    renderUserUI();
    await loadNoticias();
});

// ------------------ INIT USER ------------------
async function initUser() {
    try {
        // ======= MODO PRUEBA =======
        // Esto asegura que Peketruli siempre aparezca para pruebas
        currentUser = {
            id: "88dfe118-dba2-4a86-85b7-6cba6b069ba1", // Reemplaza por tu UUID real de Peketruli
            username: "Peketruli"
        };
        renderUserUI();
        return;
        // ============================

        /*
        const saved = localStorage.getItem("currentUser");
        if (saved) {
            currentUser = JSON.parse(saved);
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
            .from("usuarios")
            .select("*")
            .eq("auth_id", user.id)
            .maybeSingle();

        if (error || !data) return console.error(error || "Usuario no encontrado");
        currentUser = data;
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        */
    } catch (err) {
        console.error(err);
    }
}

// ------------------ RENDER UI ------------------
function renderUserUI() {
    const ajustesBtnContainer = document.getElementById("ajustesContainer");
    const publicarDiv = document.getElementById("publicarContainer");

    if (!currentUser) return;

    // Botón ajustes solo para Peketruli
    ajustesBtnContainer.style.display = currentUser.username === "Peketruli" ? "block" : "none";

    // Formulario publicar solo si tiene permiso o es Peketruli
    publicarDiv.style.display = (permisosPublicar.includes(currentUser.id) || currentUser.username === "Peketruli") ? "block" : "none";
}

// ------------------ PERMISOS ------------------
async function loadPermisos() {
    try {
        const { data, error } = await supabase
            .from("usuarios")
            .select("id, username, puede_publicar");

        if (error) return console.error(error);

        permisosPublicar = data.filter(u => u.puede_publicar).map(u => u.id);
        renderUserUI();
    } catch (err) {
        console.error(err);
    }
}

async function togglePermiso(usuarioId) {
    try {
        const tienePermiso = permisosPublicar.includes(usuarioId);
        const { error } = await supabase
            .from("usuarios")
            .update({ puede_publicar: !tienePermiso })
            .eq("id", usuarioId);

        if (error) return alert("Error actualizando permiso: " + error.message);

        await loadPermisos();
        mostrarAjustes(); // recarga lista
    } catch (err) {
        console.error(err);
    }
}

// ------------------ AJUSTES ------------------
async function mostrarAjustes() {
    const ajustesDiv = document.getElementById("ajustesDiv");
    ajustesDiv.style.display = ajustesDiv.style.display === "block" ? "none" : "block";

    if (ajustesDiv.style.display === "block") {
        try {
            const { data, error } = await supabase.from("usuarios").select("id, username, puede_publicar");
            if (error) return console.error(error);

            const lista = document.getElementById("listaUsuariosPermisos");
            lista.innerHTML = "";

            data.forEach(u => {
                const esPeketruli = u.username === "Peketruli";
                const li = document.createElement("li");
                li.innerHTML = `
                    ${u.username} 
                    ${!esPeketruli ? `<button onclick="togglePermiso('${u.id}')">
                        ${u.puede_publicar ? "Quitar permiso" : "Dar permiso"}
                    </button>` : "(admin)"}
                `;
                lista.appendChild(li);
            });
        } catch (err) {
            console.error(err);
        }
    }
}

// ------------------ NOTICIAS ------------------
async function loadNoticias() {
    const noticiasList = document.getElementById("noticiasList");
    noticiasList.innerHTML = "<li>Cargando noticias...</li>";

    try {
        const { data, error } = await supabase
            .from("noticias")
            .select("id, titulo, contenido, imagen_url, fecha_creacion, autor_id(username)")
            .eq("publicada", true)
            .order("fecha_creacion", { ascending: false });

        if (error) return console.error(error);

        if (!data || data.length === 0) {
            noticiasList.innerHTML = "<li>No hay noticias aún.</li>";
            return;
        }

        noticiasList.innerHTML = "";
        data.forEach(n => {
            const li = document.createElement("li");
            li.className = "noticia-item";
            li.innerHTML = `
                <h3>${n.titulo}</h3>
                <p>${n.contenido}</p>
                ${n.imagen_url ? `<img src="${n.imagen_url}" alt="Imagen noticia">` : ""}
                <small>Por: ${n.autor_id?.username || "Desconocido"} | ${new Date(n.fecha_creacion).toLocaleString()}</small>
            `;
            noticiasList.appendChild(li);
        });
    } catch (err) {
        console.error(err);
        noticiasList.innerHTML = "<li>Error cargando noticias.</li>";
    }
}

// ------------------ PUBLICAR ------------------
async function publicarNoticia() {
    const titulo = document.getElementById("noticiaTitulo").value.trim();
    const contenido = document.getElementById("noticiaContenido").value.trim();
    const imagen = document.getElementById("noticiaImagen").value.trim();

    if (!titulo || !contenido) return alert("Debes completar título y contenido.");

    try {
        const { error } = await supabase.from("noticias").insert({
            titulo,
            contenido,
            imagen_url: imagen || null,
            autor_id: currentUser.id,
            publicada: true
        });

        if (error) return alert("Error publicando noticia: " + error.message);

        document.getElementById("noticiaTitulo").value = "";
        document.getElementById("noticiaContenido").value = "";
        document.getElementById("noticiaImagen").value = "";

        loadNoticias();
    } catch (err) {
        console.error(err);
    }
}
</script>
</body>
</html>
