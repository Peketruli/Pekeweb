<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peri√≥dico</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #111; color: #fff; }
h1 { color: #ff6f00; }
button { padding: 8px 12px; margin: 4px; border-radius: 6px; border: none; cursor: pointer; }
#ajustesContainer { display: none; margin-bottom: 12px; }
#ajustesDiv { display: none; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
#publicarContainer { display: none; background: #222; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
input, textarea { width: 100%; margin-bottom: 8px; padding: 6px; border-radius: 6px; border: 1px solid #555; background: #333; color: #fff; }
.noticia-item { background: #222; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
.noticia-item img { max-width: 200px; display: block; margin-top: 6px; }
</style>
</head>
<body>

<h1>üì∞ Peri√≥dico</h1>

<!-- BOT√ìN DE AJUSTES PARA PEKETRULI -->
<div id="ajustesContainer">
  <button onclick="mostrarAjustes()">‚öôÔ∏è Ajustes de Publicaci√≥n</button>
</div>

<!-- DIV AJUSTES -->
<div id="ajustesDiv">
  <h3>Gestionar permisos de publicaci√≥n</h3>
  <ul id="listaUsuariosPermisos"></ul>
</div>

<!-- FORMULARIO PARA PUBLICAR -->
<div id="publicarContainer">
  <h3>Publicar Noticia</h3>
  <input type="text" id="noticiaTitulo" placeholder="T√≠tulo de la noticia">
  <textarea id="noticiaContenido" rows="4" placeholder="Contenido de la noticia"></textarea>
  <input type="text" id="noticiaImagen" placeholder="URL de imagen (opcional)">
  <button onclick="publicarNoticia()">üì¢ Publicar</button>
</div>

<!-- LISTA DE NOTICIAS -->
<h2>Noticias Recientes</h2>
<ul id="noticiasList"></ul>

<script>
/* ===== Supabase (usa tu URL y KEY originales) ===== */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

document.addEventListener("DOMContentLoaded", async () => {
  const authContainer = document.getElementById("authContainer");
  const userInfo = document.getElementById("userInfo");
  const dropdownMenu = document.getElementById("dropdownMenu");
  const golfButton = document.getElementById("golfButton");
  const ajustesButton = document.getElementById("ajustesButton");
  const noticiasContainer = document.getElementById("noticiasContainer");
  const publicarNoticiaBtn = document.getElementById("publicarNoticiaBtn");

  // ===== Cargar informaci√≥n de usuario =====
  async function loadUserInfo() {
    let user = null;

    // 1Ô∏è‚É£ Intentar obtener desde Supabase
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      user = {
        username: session.user.user_metadata?.username || session.user.email,
        email: session.user.email,
        logo: session.user.user_metadata?.logo || "logoDefault.png"
      };
      localStorage.setItem("currentUser", JSON.stringify(user));
    }

    // 2Ô∏è‚É£ Si no hay sesi√≥n, cargar del localStorage
    if (!user) {
      const stored = JSON.parse(localStorage.getItem("currentUser"));
      if (stored) user = stored;
    }

    // ===== Actualizar UI =====
    if (user) {
      userInfo.style.display = "flex";
      authContainer.style.display = "none";
      document.getElementById("userName").textContent = user.username;
      document.getElementById("userLogo").src = user.logo || "logoDefault.png";

      // Solo Peketruli puede ver los botones especiales
      if (user.username === "Peketruli") {
        if (golfButton) golfButton.style.display = "inline-flex";
        if (ajustesButton) ajustesButton.style.display = "inline-flex";
        if (publicarNoticiaBtn) publicarNoticiaBtn.style.display = "inline-flex";
      } else {
        if (golfButton) golfButton.style.display = "none";
        if (ajustesButton) ajustesButton.style.display = "none";
        if (publicarNoticiaBtn) publicarNoticiaBtn.style.display = "none";
      }

      // Cargar las noticias
      await cargarNoticias();

    } else {
      userInfo.style.display = "none";
      authContainer.style.display = "flex";
    }
  }

  await loadUserInfo();

  // ===== Logout =====
  window.logout = async function() {
    await supabase.auth.signOut();
    localStorage.removeItem("currentUser");
    window.location.href = "l.html";
  };

  // ===== Noticias =====
  async function cargarNoticias() {
    const { data, error } = await supabase.from("noticias").select("*").order("id", { ascending: false });
    if (error) {
      console.warn("Error cargando noticias:", error);
      noticiasContainer.innerHTML = "<p>Error al cargar las noticias.</p>";
      return;
    }

    noticiasContainer.innerHTML = "";
    data.forEach(noticia => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3 style="color:orange;">${noticia.titulo}</h3>
        <p>${noticia.contenido}</p>
        <p style="font-size:12px;color:gray;">Por ${noticia.autor}</p>
      `;
      noticiasContainer.appendChild(div);
    });
  }

  // ===== Publicar nueva noticia =====
  if (publicarNoticiaBtn) {
    publicarNoticiaBtn.addEventListener("click", async () => {
      const titulo = prompt("T√≠tulo de la noticia:");
      const contenido = prompt("Contenido de la noticia:");
      if (!titulo || !contenido) return alert("Faltan datos");

      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      const autor = currentUser?.username || "An√≥nimo";

      const { error } = await supabase.from("noticias").insert([{ titulo, contenido, autor }]);
      if (error) {
        alert("Error al publicar: " + error.message);
      } else {
        alert("‚úÖ Noticia publicada correctamente.");
        await cargarNoticias();
      }
    });
  }
});
</script>
</body>
</html>
