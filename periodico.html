<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Periódico</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body {
  background: #1a001a;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
}
.section {
  background: rgba(30,0,30,0.85);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}
input, textarea {
  width: 80%;
  margin: 5px 0;
  padding: 8px;
  border-radius: 6px;
  border: none;
}
button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #b517ff;
  color: #fff;
  margin: 5px;
}
</style>
</head>
<body>

<h1>📰 Periódico</h1>

<!-- Lista de noticias -->
<div id="noticiasList" class="section">Cargando noticias...</div>

<!-- Ajustes de Peketruli -->
<div id="ajustesDiv" class="section" style="display:none;">
  <h3>⚙️ Ajustes del Periódico</h3>
  <p>Otorga o quita permisos de publicación:</p>
  <div id="usuariosList">Cargando usuarios...</div>
</div>

<!-- Crear noticia para usuarios con permisos -->
<div id="crearNoticiaDiv" class="section" style="display:none;">
  <h3>🖊 Crear noticia</h3>
  <input type="text" id="tituloNoticia" placeholder="Título"><br>
  <textarea id="contenidoNoticia" rows="4" placeholder="Contenido"></textarea><br>
  <input type="file" id="imagenNoticia"><br>
  <button onclick="crearNoticia()">Publicar noticia</button>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let permisosPublicar = []; // IDs de usuarios que pueden publicar

document.addEventListener("DOMContentLoaded", async () => {
    await initUser();
    await loadPermisos();
    await loadNoticias();
});

// ---------------------- INIT USUARIO ----------------------
async function initUser() {
    try {
        const saved = localStorage.getItem("currentUser");
        if (saved) {
            currentUser = JSON.parse(saved);
            renderUserUI();
            return;
        }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
            .from("usuarios")
            .select("*")
            .eq("auth_id", user.id)
            .maybeSingle();

        if (error || !data) return console.error(error || "Usuario no encontrado");

        currentUser = data;
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        renderUserUI();

    } catch (err) {
        console.error("initUser exception:", err);
    }
}

function renderUserUI() {
    const ajustesBtnContainer = document.getElementById("ajustesContainer");
    if (!ajustesBtnContainer) return;

    if (currentUser?.username === "Peketruli") {
        ajustesBtnContainer.style.display = "block"; // Mostrar botón de ajustes
    } else {
        ajustesBtnContainer.style.display = "none";
    }

    // Si tiene permiso de publicar
    if (permisosPublicar.includes(currentUser?.id)) {
        document.getElementById("publicarContainer").style.display = "block";
    } else {
        document.getElementById("publicarContainer").style.display = "none";
    }
}

// ---------------------- PERMISOS ----------------------
async function loadPermisos() {
    // Traemos todos los usuarios que tienen permiso de publicar
    const { data, error } = await supabase
        .from("usuarios")
        .select("id, username, puede_publicar")
        .eq("puede_publicar", true);

    if (error) return console.error("Error cargando permisos:", error);

    permisosPublicar = data.map(u => u.id);
    renderUserUI();
}

async function togglePermiso(usuarioId) {
    const nuevoValor = !permisosPublicar.includes(usuarioId);
    const { error } = await supabase
        .from("usuarios")
        .update({ puede_publicar: nuevoValor })
        .eq("id", usuarioId);

    if (error) return alert("Error actualizando permiso: " + error.message);

    await loadPermisos();
    loadNoticias();
}

// ---------------------- CARGAR NOTICIAS ----------------------
async function loadNoticias() {
    const noticiasList = document.getElementById("noticiasList");
    if (!noticiasList) return;

    noticiasList.innerHTML = "<li>Cargando noticias...</li>";

    try {
        const { data, error } = await supabase
            .from("noticias")
            .select(`
                id,
                titulo,
                contenido,
                imagen_url,
                fecha_creacion,
                autor:autor_id(username)
            `)
            .eq("publicada", true)
            .order("fecha_creacion", { ascending: false });

        if (error) return console.error("Error cargando noticias:", error);

        if (!data || data.length === 0) {
            noticiasList.innerHTML = "<li>No hay noticias aún.</li>";
            return;
        }

        noticiasList.innerHTML = "";
        data.forEach(n => {
            const li = document.createElement("li");
            li.className = "noticia-item";
            li.innerHTML = `
                <h3>${n.titulo}</h3>
                <p>${n.contenido}</p>
                ${n.imagen_url ? `<img src="${n.imagen_url}" alt="Imagen noticia" style="max-width:200px;">` : ""}
                <small>Por: ${n.autor?.username || "Desconocido"} | ${new Date(n.fecha_creacion).toLocaleString()}</small>
            `;
            noticiasList.appendChild(li);
        });
    } catch (err) {
        console.error("loadNoticias exception:", err);
        noticiasList.innerHTML = "<li>Error cargando noticias.</li>";
    }
}

// ---------------------- PUBLICAR NOTICIAS ----------------------
async function publicarNoticia() {
    const titulo = document.getElementById("noticiaTitulo").value.trim();
    const contenido = document.getElementById("noticiaContenido").value.trim();
    const imagen = document.getElementById("noticiaImagen").value.trim();

    if (!titulo || !contenido) return alert("Debes completar título y contenido.");

    const { error } = await supabase.from("noticias").insert({
        titulo,
        contenido,
        imagen_url: imagen || null,
        autor_id: currentUser.id,
        publicada: true
    });

    if (error) return alert("Error publicando noticia: " + error.message);

    document.getElementById("noticiaTitulo").value = "";
    document.getElementById("noticiaContenido").value = "";
    document.getElementById("noticiaImagen").value = "";

    loadNoticias();
}

// ---------------------- AJUSTES DE PERMISOS ----------------------
async function mostrarAjustes() {
    const ajustesDiv = document.getElementById("ajustesDiv");
    ajustesDiv.style.display = ajustesDiv.style.display === "block" ? "none" : "block";

    // Cargar todos los usuarios para editar permisos
    const { data, error } = await supabase.from("usuarios").select("id, username, puede_publicar");
    if (error) return console.error("Error cargando usuarios:", error);

    const lista = document.getElementById("listaUsuariosPermisos");
    lista.innerHTML = "";

    data.forEach(u => {
        const li = document.createElement("li");
        li.innerHTML = `
            ${u.username} 
            <button onclick="togglePermiso('${u.id}')">
                ${u.puede_publicar ? "Quitar permiso" : "Dar permiso"}
            </button>
        `;
        lista.appendChild(li);
    });
}
</script>

</body>
</html>
