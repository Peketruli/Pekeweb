<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas Web - Salas Online</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#4CAF50; color:#fff; text-align:center; padding:20px; }
  h1 { margin-bottom: 10px; }
  .mano { margin: 20px 0; }
  .carta { display:inline-block; width:60px; height:90px; line-height:90px; border:2px solid #fff; border-radius:10px; margin:5px; background:#fff; color:#000; font-weight:bold; font-size:20px; }
  button { padding:10px 20px; font-size:16px; cursor:pointer; border-radius:5px; border:none; background:#388E3C; color:#fff; margin:5px; }
  button:hover { background:#2E7D32; }
  input { padding:8px; border:none; border-radius:5px; margin:5px; font-size:16px; }
  #salaCodigo { font-size:18px; color:#ffeb3b; }
</style>
</head>
<body>
<h1>Juego de Cartas Web</h1>

<div id="inicio">
  <button id="crearBtn">Crear nueva sala</button>
  <h3>Salas disponibles</h3>
  <div id="salas">Cargando salas...</div>
</div>

<div id="juego" style="display:none;">
  <h3>Sala: <span id="salaCodigo"></span></h3>
  <div id="estadoJuego"></div>
  <div class="mano" id="manoJugador"></div>
</div>

<script>
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let usuarioActual = null;
let salaActual = '';

// --- Detectar sesión ---
async function detectarSesion() {
  // Primero mirar si hay un nombre guardado localmente
  let storedUser = localStorage.getItem('username') || localStorage.getItem('user') || null;

  if (storedUser) {
    usuarioActual = storedUser;
    console.log("Sesión detectada desde localStorage:", usuarioActual);
    return true;
  }

  // Si no hay en localStorage, intentar con Supabase Auth
  const { data, error } = await supabase.auth.getSession();
  if (data?.session) {
    usuarioActual = data.session.user.email || data.session.user.id;
    console.log("Sesión detectada desde Supabase:", usuarioActual);
    return true;
  }

  // Si no hay sesión
  alert("No tienes la sesión iniciada. Inicia sesión primero.");
  window.location.href = "/login.html";
  return false;
}

// --- Crear nueva sala ---
async function crearSala() {
  if (!usuarioActual) {
    alert('No se detectó sesión. Inicia sesión primero.');
    return;
  }

  const codigo = 'sala_' + Math.floor(Math.random() * 10000);
  const { error } = await supabase.from('rooms').insert([{ name: codigo }]);
  if (error) {
    alert('Error al crear sala: ' + error.message);
    return;
  }

  alert('Sala creada con éxito: ' + codigo);
  listarSalas();
}

// --- Listar salas ---
async function listarSalas() {
  const div = document.getElementById('salas');
  div.innerHTML = 'Cargando salas...';
  const { data, error } = await supabase.from('rooms').select('*');
  if (error) {
    div.innerHTML = 'Error al cargar salas.';
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    div.innerHTML = 'No hay salas disponibles.';
    return;
  }

  div.innerHTML = '';
  data.forEach(sala => {
    const btn = document.createElement('button');
    btn.textContent = `Unirse a ${sala.name}`;
    btn.onclick = () => unirseASala(sala.name);
    div.appendChild(btn);
  });
}

// --- Unirse a una sala ---
async function unirseASala(nombreSala) {
  if (!usuarioActual) return alert('No se detectó sesión.');

  salaActual = nombreSala;
  document.getElementById('inicio').style.display = 'none';
  document.getElementById('juego').style.display = 'block';
  document.getElementById('salaCodigo').textContent = nombreSala;

  let baraja = crearBaraja();
  barajar(baraja);
  let mano = baraja.splice(0, 5);

  const { error } = await supabase.from('card_game').insert([
    { player: usuarioActual, room: nombreSala, hand: mano, points: 0 }
  ]);
  if (error) {
    alert('Error al unirse: ' + error.message);
    return;
  }

  mostrarMano(mano);
  actualizarEstado();
}

// --- Crear baraja ---
function crearBaraja() {
  const palos = ['♠','♥','♦','♣'];
  const valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let baraja = [];
  for (let palo of palos) for (let valor of valores) baraja.push(valor + palo);
  return baraja;
}

// --- Barajar ---
function barajar(baraja) {
  for (let i = baraja.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [baraja[i], baraja[j]] = [baraja[j], baraja[i]];
  }
  return baraja;
}

// --- Mostrar mano ---
function mostrarMano(mano) {
  const div = document.getElementById('manoJugador');
  div.innerHTML = '';
  mano.forEach(carta => {
    const cartaDiv = document.createElement('div');
    cartaDiv.className = 'carta';
    cartaDiv.textContent = carta;
    div.appendChild(cartaDiv);
  });
}

// --- Actualizar estado ---
async function actualizarEstado() {
  if (!salaActual) return;
  const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
  const estado = document.getElementById('estadoJuego');
  estado.innerHTML = '<h3>Jugadores en la sala</h3>';
  if (jugadores) {
    jugadores.forEach(j => {
      estado.innerHTML += `<p>${j.player} - Puntos: ${j.points}</p>`;
    });
  }
}

// --- Eventos ---
document.getElementById('crearBtn').addEventListener('click', crearSala);

// --- Inicialización ---
(async () => {
  const sesionOK = await detectarSesion();
  if (sesionOK) listarSalas();
  setInterval(listarSalas, 4000);
})();
</script>
</body>
</html>
