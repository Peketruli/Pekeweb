<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas Online</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#1f2937,#4b5563); color:#fff; margin:0; padding:0; }
header { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:#111827; box-shadow:0 2px 6px rgba(0,0,0,0.5);}
#userInfo { display:flex; align-items:center; gap:10px;}
#userLogo { width:40px; height:40px; border-radius:50%; border:2px solid #fff;}
main { padding:20px; text-align:center;}
button { padding:10px 20px; margin:5px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;}
button.primary { background:#3b82f6; color:white;}
button.primary:hover { background:#2563eb;}
button.danger { background:#ef4444; color:white;}
button.danger:hover { background:#b91c1c;}
button.sala-btn { background:#10b981; color:white;}
button.sala-btn:hover { background:#059669;}
#salas { margin-top:15px;}
#juego { display:none; margin-top:20px;}
.mano { margin-top:15px;}
.carta { display:inline-block; width:60px; height:90px; line-height:90px; border:2px solid #fff; border-radius:10px; margin:5px; background:#fff; color:#000; font-weight:bold; font-size:20px; cursor:pointer;}
.carta:hover { background:#f3f4f6; color:#000;}
#apuestas, #fichas { margin-top:15px;}
.ficha { display:inline-block; width:50px; height:50px; border-radius:50%; margin:5px; line-height:50px; font-weight:bold; cursor:pointer; border:2px solid #fff; }
</style>
</head>
<body>
<header>
<h2>ðŸŽ´ Juego de Cartas</h2>
<div id="userInfo">
<img id="userLogo" src="logoDefault.png" alt="Logo">
<span id="userName"></span>
<button id="logoutBtn" class="danger">Cerrar sesiÃ³n</button>
</div>
</header>
<main>
<div id="zonaInicial">
<button id="crearBtn" class="primary">Crear nueva sala</button>
<h3>Salas disponibles</h3>
<div id="salas">Cargando salas...</div>
</div>

<div id="juego">
<h3>Sala: <span id="salaCodigo"></span></h3>

<!-- SISTEMA DE FICHAS -->
<div id="fichas">
  <h4>ðŸŽ° Banco de fichas</h4>
  <p>Pekepuntos disponibles: <span id="pekepuntosUsuario">0</span></p>
  <input type="number" id="depositoCantidad" placeholder="Pekepuntos a depositar" min="1">
  <button id="depositarBtn" class="primary">Depositar</button>
  <div id="fichasJugador"></div>
  <button id="cobrarBtn" class="sala-btn">ðŸ’° Entregar fichas al banco</button>
</div>

<div id="estadoJuego"></div>
<div id="apuestas">
<h4>Apuestas</h4>
<input type="number" id="montoApuesta" placeholder="Cantidad a apostar" min="1">
<button id="apostarBtn" class="primary">Apostar</button>
</div>
<div class="mano" id="manoJugador"></div>
<button id="salirSalaBtn" class="danger">Salir de la sala</button>
</div>
</main>

<script>
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // tu clave
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let usuarioActual = null;
let salaActual = '';
let manoJugador = [];
let intervaloActualizacion = null;
let montoActual = 0;
let fichas = { 1:0, 5:0, 25:0, 100:0 };

// Cargar usuario
async function cargarUsuario() {
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) {
    alert('No tienes sesiÃ³n iniciada');
    window.location.href = 'login.html';
    return;
  }
  usuarioActual = user.username;
  document.getElementById('userName').textContent = usuarioActual;
  document.getElementById('userLogo').src = user.logo || 'logoDefault.png';

  const { data } = await supabase.from('usuarios').select('pekepuntos').eq('username', usuarioActual).single();
  document.getElementById('pekepuntosUsuario').textContent = data.pekepuntos;
}

// Mostrar fichas
function mostrarFichas() {
  const div = document.getElementById('fichasJugador');
  div.innerHTML = '';
  const colores = {1:'#fff',5:'#ef4444',25:'#3b82f6',100:'#10b981'};
  for (const [valor, cantidad] of Object.entries(fichas)) {
    if (cantidad>0) {
      const chip = document.createElement('div');
      chip.className = 'ficha';
      chip.style.background = colores[valor];
      chip.style.color = (valor==1)?'#000':'#fff';
      chip.textContent = `${valor}x${cantidad}`;
      div.appendChild(chip);
    }
  }
}

// Depositar pekepuntos y recibir fichas
document.getElementById('depositarBtn').onclick = async () => {
  const cantidad = parseInt(document.getElementById('depositoCantidad').value);
  if (!cantidad || cantidad <= 0) return alert('Cantidad invÃ¡lida');
  
  const { data: user } = await supabase.from('usuarios').select('pekepuntos').eq('username', usuarioActual).single();
  if (user.pekepuntos < cantidad) return alert('No tienes suficientes Pekepuntos');

  // Restar pekepuntos
  await supabase.from('usuarios').update({ pekepuntos: user.pekepuntos - cantidad }).eq('username', usuarioActual);

  // Repartir fichas (de mayor a menor)
  let restante = cantidad;
  [100,25,5,1].forEach(v=>{
    const num = Math.floor(restante/v);
    fichas[v] += num;
    restante -= num*v;
  });
  
  alert('Has cambiado tus Pekepuntos por fichas');
  mostrarFichas();
  cargarUsuario();
};

// Entregar fichas al banco
document.getElementById('cobrarBtn').onclick = async () => {
  let total = 0;
  for (const [valor,cantidad] of Object.entries(fichas)) {
    total += valor * cantidad;
    fichas[valor]=0;
  }

  if (total === 0) return alert('No tienes fichas para entregar');

  const { data: user } = await supabase.from('usuarios').select('pekepuntos').eq('username', usuarioActual).single();
  await supabase.from('usuarios').update({ pekepuntos: user.pekepuntos + total }).eq('username', usuarioActual);

  alert(`Has entregado tus fichas y recibido ${total} Pekepuntos`);
  mostrarFichas();
  cargarUsuario();
};

// Logout
document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('currentUser');
    window.location.href = 'login.html';
};

// Listar salas
async function listarSalas() {
    const div = document.getElementById('salas');
    div.innerHTML = 'Cargando salas...';
    const { data, error } = await supabase.from('rooms').select('*');
    if (error) { div.innerHTML = 'Error al cargar salas'; console.error(error); return; }
    div.innerHTML = '';
    if (!data || data.length === 0) div.innerHTML = 'No hay salas disponibles';
    data.forEach(sala => {
        const btn = document.createElement('button');
        btn.textContent = `Unirse a ${sala.name}`;
        btn.className = 'sala-btn';
        btn.onclick = () => unirseASala(sala.name);
        div.appendChild(btn);
    });
}

// Crear sala
document.getElementById('crearBtn').onclick = async () => {
    if (!usuarioActual) return alert('No se detectÃ³ sesiÃ³n');
    const codigo = 'sala_' + Math.floor(Math.random()*10000);

    await supabase.from('rooms').insert([{ name: codigo }]);
    listarSalas();
    alert('Sala creada: ' + codigo);
};

// Crear baraja
function crearBaraja() {
    const palos = ['â™ ','â™¥','â™¦','â™£'];
    const valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const baraja = [];
    for (let palo of palos) for (let val of valores) baraja.push(val+palo);
    return baraja;
}
function barajar(baraja) { for(let i=baraja.length-1;i>0;i--){ let j=Math.floor(Math.random()*(i+1)); [baraja[i],baraja[j]]=[baraja[j],baraja[i]]; } }
function mostrarMano(mano){ 
    const div=document.getElementById('manoJugador'); 
    div.innerHTML=''; 
    mano.forEach(c=>{
        const d=document.createElement('div'); 
        d.className='carta'; 
        d.textContent=c; 
        d.onclick = () => jugarCarta(c); 
        div.appendChild(d);
    }); 
}

// Apostar
document.getElementById('apostarBtn').onclick = async () => {
    const monto = parseInt(document.getElementById('montoApuesta').value);
    if (!monto || monto <= 0) return alert('Cantidad invÃ¡lida');
    montoActual = monto;
    await supabase.from('card_game').update({ bet: monto }).eq('player', usuarioActual).eq('room', salaActual);
    alert('Apuesta realizada: '+monto);
    actualizarEstado();
};

// Unirse a sala
async function unirseASala(nombreSala) {
    if (!usuarioActual) return alert('No se detectÃ³ sesiÃ³n');
    salaActual = nombreSala;

    // Revisar cantidad de jugadores
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
    if (jugadores.length >= 4) return alert('Sala llena, mÃ¡ximo 4 jugadores');

    document.getElementById('zonaInicial').style.display = 'none';
    document.getElementById('juego').style.display = 'block';
    document.getElementById('salaCodigo').textContent = salaActual;

    const baraja = crearBaraja();
    barajar(baraja);
    manoJugador = baraja.splice(0,5);
    mostrarMano(manoJugador);

    const { data: existe } = await supabase.from('card_game')
        .select('*')
        .eq('player', usuarioActual)
        .eq('room', salaActual)
        .single();

    if (!existe) {
        await supabase.from('card_game').insert([{ player: usuarioActual, room: salaActual, hand: manoJugador, played:null, bet:null }]);
    }

    actualizarEstado();
    if (intervaloActualizacion) clearInterval(intervaloActualizacion);
    intervaloActualizacion = setInterval(actualizarEstado, 2000);
}

// Salir de sala
document.getElementById('salirSalaBtn').onclick = async () => {
    if (!salaActual) return;
    await supabase.from('card_game').delete().eq('player', usuarioActual).eq('room', salaActual);
    salaActual = '';
    document.getElementById('juego').style.display = 'none';
    document.getElementById('zonaInicial').style.display = 'block';
    if (intervaloActualizacion) clearInterval(intervaloActualizacion);
    listarSalas();
};

// Jugar carta
async function jugarCarta(carta) {
    if (!salaActual) return;
    // Verificar que todos apostaron
    const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
    if (jugadores.some(j=>!j.bet)) return alert('Todos deben apostar antes de jugar');

    await supabase.from('card_game').update({ played: carta }).eq('player', usuarioActual).eq('room', salaActual);
    manoJugador = manoJugador.filter(c => c !== carta);
    mostrarMano(manoJugador);

    const { data: actualJugadores } = await supabase.from('card_game').select('player, played').eq('room', salaActual);
    if (actualJugadores.every(j=>j.played)) determinarGanador(actualJugadores);
}

// Determinar ganador
async function determinarGanador(jugadores) {
    const valorCarta = { 'A':14,'K':13,'Q':12,'J':11,'10':10,'9':9,'8':8,'7':7,'6':6,'5':5,'4':4,'3':3,'2':2 };
    let max = -1;
    let ganador = '';
    jugadores.forEach(j => {
        const val = j.played.slice(0,j.played.length-1);
        const puntos = valorCarta[val];
        if (puntos > max) { max=puntos; ganador=j.player; }
    });

    const { data:user } = await supabase.from('usuarios').select('pekepuntos').eq('username', ganador).single();
    await supabase.from('usuarios').update({ pekepuntos: user.pekepuntos+10 }).eq('username', ganador);

    await supabase.from('card_game').update({ played:null, bet:null }).eq('room', salaActual);
    alert(`Ganador de la ronda: ${ganador} +10 pekepuntos!`);
    actualizarEstado();
}

// Actualizar sala
async function actualizarEstado() {
    if (!salaActual) return;
    try {
        const { data: jugadores } = await supabase.from('card_game').select('*').eq('room', salaActual);
        const div = document.getElementById('estadoJuego');
        div.innerHTML = '<h4>Jugadores en la sala</h4>';
        if (!jugadores || jugadores.length===0){ div.innerHTML+='<p>(ninguno aÃºn)</p>'; return; }
        const nombres = jugadores.map(j=>j.player);
        const { data: usuarios } = await supabase.from('usuarios').select('username,pekepuntos').in('username', nombres);

        jugadores.forEach(j=>{
            const user = usuarios.find(u=>u.username===j.player);
            const estado = j.bet ? (j.played?'Jugando':'ApostÃ³'):'Esperando apuesta';
            div.innerHTML+=`<p>${j.player} - Pekepuntos: ${user ? user.pekepuntos:0} - ${estado}</p>`;
        });

    } catch(err){ console.error(err); }
}

// InicializaciÃ³n
window.onload = () => { cargarUsuario(); listarSalas(); };
</script>
</body>
</html>
