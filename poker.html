<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salas Online - Pekep贸ker</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#2E7D32; color:#fff; text-align:center; padding:20px; }
  h1 { margin-bottom: 10px; }
  .sala { background:#388E3C; padding:10px; margin:10px auto; border-radius:10px; width:200px; cursor:pointer; transition:.3s; }
  .sala:hover { background:#43A047; }
  button { padding:10px 20px; font-size:16px; cursor:pointer; border-radius:5px; border:none; background:#66BB6A; color:#fff; margin:5px; }
  button:hover { background:#81C784; }
  #estadoJuego p { margin:4px; }
</style>
</head>
<body>
<h1>Salas Online</h1>

<div id="inicio">
  <button onclick="crearSala()">Crear nueva sala</button>
  <h3>Salas disponibles:</h3>
  <div id="listaSalas">Cargando salas...</div>
</div>

<div id="juego" style="display:none;">
  <h2>Sala: <span id="salaCodigo"></span></h2>
  <div id="estadoJuego"></div>
  <button onclick="salirSala()">Salir de la sala</button>
</div>

<script>
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let username = localStorage.getItem("username"); // Detecta sesi贸n guardada
let salaActual = null;

if (!username) {
  alert("No se ha detectado una sesi贸n activa. Inicia sesi贸n primero.");
  window.location.href = "/login.html"; // cambia a tu login real
}

// Crear sala
async function crearSala() {
  const codigo = 'Sala-' + Math.floor(Math.random() * 10000);
  const { error } = await supabase.from('rooms').insert([{ name: codigo }]);
  if (error) return alert('Error al crear sala: ' + error.message);
  unirseSala(codigo);
}

// Mostrar salas disponibles
async function cargarSalas() {
  const { data, error } = await supabase.from('rooms').select('*');
  const lista = document.getElementById('listaSalas');
  if (error) return lista.textContent = 'Error al cargar salas.';

  if (!data || data.length === 0) {
    lista.textContent = 'No hay salas disponibles.';
    return;
  }

  lista.innerHTML = '';
  data.forEach(sala => {
    const div = document.createElement('div');
    div.className = 'sala';
    div.textContent = sala.name;
    div.onclick = () => unirseSala(sala.name);
    lista.appendChild(div);
  });
}

// Unirse a una sala
async function unirseSala(nombreSala) {
  salaActual = nombreSala;
  document.getElementById('inicio').style.display = 'none';
  document.getElementById('juego').style.display = 'block';
  document.getElementById('salaCodigo').textContent = nombreSala;

  const { error } = await supabase.from('card_game').insert([{ player: username, room: nombreSala, points: 0 }]);
  if (error) console.error(error);

  actualizarJugadores();
}

// Mostrar jugadores en la sala
async function actualizarJugadores() {
  if (!salaActual) return;
  const { data } = await supabase.from('card_game').select('*').eq('room', salaActual);
  const div = document.getElementById('estadoJuego');
  div.innerHTML = '<h3>Jugadores en la sala:</h3>';
  data?.forEach(j => div.innerHTML += `<p>${j.player} (${j.points} pts)</p>`);
}

setInterval(() => {
  if (salaActual) actualizarJugadores();
  else cargarSalas();
}, 3000);

// Salir de la sala
async function salirSala() {
  if (!salaActual) return;
  await supabase.from('card_game').delete().eq('player', username).eq('room', salaActual);
  salaActual = null;
  document.getElementById('inicio').style.display = 'block';
  document.getElementById('juego').style.display = 'none';
  cargarSalas();
}

cargarSalas();
</script>
</body>
</html>
