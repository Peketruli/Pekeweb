<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juego de Cartas Web - Salas Online</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background:#4CAF50;
    color:#fff;
    text-align:center;
    padding:20px;
  }
  h1 { margin-bottom: 10px; }
  .mano { margin: 20px 0; }
  .carta {
    display:inline-block;
    width:60px;
    height:90px;
    line-height:90px;
    border:2px solid #fff;
    border-radius:10px;
    margin:5px;
    background:#fff;
    color:#000;
    font-weight:bold;
    font-size:20px;
  }
  button {
    padding:10px 20px;
    font-size:16px;
    cursor:pointer;
    border-radius:5px;
    border:none;
    background:#388E3C;
    color:#fff;
    margin:5px;
  }
  button:hover { background:#2E7D32; }
  input {
    padding:8px;
    border:none;
    border-radius:5px;
    margin:5px;
    font-size:16px;
  }
  #listaSalas {
    background:#2E7D32;
    border-radius:10px;
    padding:15px;
    margin-top:20px;
  }
  .sala-item {
    background:#66BB6A;
    padding:8px;
    border-radius:8px;
    margin:5px;
    cursor:pointer;
  }
  .sala-item:hover { background:#81C784; }
</style>
</head>
<body>
<h1>Juego de Cartas Web</h1>

<div id="inicio">
  <input type="text" id="playerName" placeholder="Tu nombre">
  <input type="text" id="roomName" placeholder="Nombre de la sala">
  <button id="btnCrear">Crear Sala</button>
  <button id="btnUnirse">Unirse</button>

  <div id="listaSalas">
    <h3>Salas disponibles</h3>
    <div id="salasActivas">Cargando salas...</div>
  </div>
</div>

<div id="juego" style="display:none;">
  <h3>Sala: <span id="salaCodigo"></span></h3>
  <div id="estadoJuego"></div>
  <div class="mano" id="manoJugador"></div>
</div>

<script>
const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';

// ✅ CORRECTO: crear cliente con "const client = ..."
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const palos = ['♠','♥','♦','♣'];
const valores = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
let salaActual = '';

function crearBaraja() {
  let baraja = [];
  for (let palo of palos) {
    for (let valor of valores) {
      baraja.push(valor + palo);
    }
  }
  return baraja;
}

function barajar(baraja) {
  for (let i = baraja.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [baraja[i], baraja[j]] = [baraja[j], baraja[i]];
  }
  return baraja;
}

async function crearSala() {
  const nombreSala = document.getElementById('roomName').value.trim();
  if (!nombreSala) return alert('Ingresa un nombre para la sala');

  const { data: existe } = await client.from('rooms').select('name').eq('name', nombreSala).maybeSingle();
  if (existe) return alert('Esa sala ya existe');

  const { error } = await client.from('rooms').insert([{ name: nombreSala }]);
  if (error) return alert('Error al crear sala: ' + error.message);

  alert('Sala creada con éxito: ' + nombreSala);
  cargarSalas();
}

async function unirse(roomName = null) {
  const player = document.getElementById('playerName').value.trim();
  const room = roomName || document.getElementById('roomName').value.trim();
  if (!player || !room) return alert('Ingresa tu nombre y el nombre de la sala');

  salaActual = room;
  document.getElementById('inicio').style.display = 'none';
  document.getElementById('juego').style.display = 'block';
  document.getElementById('salaCodigo').textContent = room;

  let baraja = crearBaraja();
  barajar(baraja);
  let mano = baraja.splice(0, 5);

  const { error } = await client.from('card_game').insert([{ player, room, hand: mano, points: 0 }]);
  if (error) return alert('Error al unirse: ' + error.message);

  mostrarMano(mano);
  actualizarEstado();
}

function mostrarMano(mano) {
  const div = document.getElementById('manoJugador');
  div.innerHTML = '';
  mano.forEach(carta => {
    const cartaDiv = document.createElement('div');
    cartaDiv.className = 'carta';
    cartaDiv.textContent = carta;
    div.appendChild(cartaDiv);
  });
}

async function actualizarEstado() {
  if (!salaActual) return;
  let { data: jugadores } = await client.from('card_game').select('*').eq('room', salaActual);
  const estado = document.getElementById('estadoJuego');
  estado.innerHTML = '<h3>Jugadores en la sala</h3>';
  if (!jugadores || jugadores.length === 0) {
    estado.innerHTML += '<p>No hay jugadores aún.</p>';
    return;
  }
  jugadores.forEach(j => {
    estado.innerHTML += `<p>${j.player} - Puntos: ${j.points}</p>`;
  });
}

async function cargarSalas() {
  const { data: salas, error } = await client.from('rooms').select('*');
  const div = document.getElementById('salasActivas');
  div.innerHTML = '';
  if (error) return (div.textContent = 'Error al cargar salas');
  if (!salas || salas.length === 0) return (div.textContent = 'No hay salas activas');

  salas.forEach(sala => {
    const item = document.createElement('div');
    item.className = 'sala-item';
    item.textContent = sala.name;
    item.onclick = () => {
      document.getElementById('roomName').value = sala.name;
      unirse(sala.name);
    };
    div.appendChild(item);
  });
}

setInterval(actualizarEstado, 5000);
setInterval(cargarSalas, 4000);
window.onload = cargarSalas;

// ✅ Ahora los botones sí funcionan
document.getElementById('btnCrear').addEventListener('click', crearSala);
document.getElementById('btnUnirse').addEventListener('click', () => unirse());
</script>
</body>
</html>
