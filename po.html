<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pol√≠tica - Partidos</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #2c1a00, #1a0000);
  color: #fff;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 800px;
  margin: 40px auto;
  padding: 25px;
  background: rgba(40, 0, 0, 0.9);
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
}

h1, h2 {
  text-align: center;
  color: #ff8c00;
  text-shadow: 2px 2px 6px #330000;
}

label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
  color: #ffa500;
}

input[type="text"], 
textarea, 
input[type="file"], 
input[type="color"] {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border-radius: 5px;
  border: 1px solid #aa5500;
  box-sizing: border-box;
  background: #2b1000;
  color: #fff;
}

button {
  margin-top: 20px;
  padding: 10px 20px;
  background: #ff8c00;
  color: #1a0000;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 0 10px #ff8c00;
}

button:hover {
  background: #ffa500;
  box-shadow: 0 0 20px #ff8c00;
}

#backBtn {
  background: #555;
  color: #fff;
  box-shadow: 0 0 8px #000;
}
#backBtn:hover {
  background: #333;
}

#partiesList {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
}

.party-card {
  border: 1px solid #aa5500;
  border-radius: 10px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(30,0,0,0.8);
  box-shadow: 0 0 15px rgba(255, 140, 0, 0.3);
  transition: transform 0.2s;
}
.party-card:hover {
  transform: scale(1.03);
  box-shadow: 0 0 25px rgba(255, 140, 0, 0.6);
}

.party-card img {
  max-width: 80px;
  max-height: 80px;
  margin-bottom: 10px;
  border-radius: 50%;
  border: 2px solid #ff8c00;
}

.party-card h3 {
  margin: 5px 0;
  text-align: center;
  color: #ffb84d;
}

.party-card p {
  text-align: center;
  color: #ffd699;
}

#partyView {
  display: none;
  padding: 20px;
  max-width: 800px;
  margin: 40px auto;
  background: rgba(40, 0, 0, 0.9);
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
}

#partyMembers, #partyChat {
  list-style: none;
  padding: 0;
}

#partyChat {
  margin-top: 15px;
  border-top: 1px solid #aa5500;
  padding: 10px;
  max-height: 200px;
  overflow-y: auto;
  background: rgba(30,0,0,0.7);
  border-radius: 8px;
}

#chatInput {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  box-sizing: border-box;
  border-radius: 5px;
  border: 1px solid #aa5500;
  background: #2b1000;
  color: #fff;
}

#leaveBtn {
  background: #ff5555;
  box-shadow: 0 0 10px #ff5555;
}
#leaveBtn:hover {
  background: #cc4444;
  box-shadow: 0 0 20px #ff5555;
}

#hubBtn {
  background: #555;
  box-shadow: 0 0 8px #000;
}
#hubBtn:hover {
  background: #333;
  box-shadow: 0 0 12px #000;
}

#editPartyBtn {
  background: #ffaa00;
  box-shadow: 0 0 10px #ffaa00;
}
#editPartyBtn:hover {
  background: #cc8800;
  box-shadow: 0 0 20px #ffaa00;
}
</style>
</head>
<body>

<div id="mainContainer" class="container">
  <h1>Crear Partido Pol√≠tico</h1>
  <div id="error-box" style="color:red; font-weight:bold; margin:10px 0;"></div>
  <form id="partyForm">
    <label>Nombre del Partido</label>
    <input type="text" id="partyName" required>

    <label>Descripci√≥n</label>
    <textarea id="partyDescription" rows="3" required></textarea>

    <label>Logo</label>
    <input type="file" id="partyLogo" accept="image/*">

    <label>Color del Partido</label>
    <input type="color" id="partyColor" value="#0077ff">

    <label>Programa / Manifesto (un punto por l√≠nea)</label>
    <textarea id="partyManifesto" rows="4"></textarea>

    <label>Candidatos</label>
    <div class="candidate-inputs" id="candidateInputs">
      <input type="text" placeholder="Nombre candidato" class="candidateName">
    </div>
    <button type="button" id="addCandidate">+ A√±adir otro candidato</button>

    <button type="submit">Crear Partido</button>
  </form>

  <button id="backBtn" onclick="window.location.href='h.html'">‚¨Ö Volver al Hub</button>
  <p id="status"></p>

  <h2>üìå Partidos Creados</h2>
  <div id="partiesList"></div>
</div>

<!-- Vista del partido -->
<div id="partyView">
  <button id="leaveBtn">Salir del Partido</button>
  <button id="hubBtn">‚¨Ö Volver al Hub</button>
  <img id="partyLogoView" style="max-width:120px; display:block; margin:0 auto 10px;">
  <h2 id="partyNameView"></h2>
  <p id="partyDescriptionView"></p>
  
  <!-- Bot√≥n y formulario de edici√≥n -->
  <button id="editPartyBtn" style="display:none;">‚úèÔ∏è Editar Partido</button>
  <div id="editPartyForm" style="display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
    <label>Nombre del Partido</label>
    <input type="text" id="editPartyName">
    <label>Descripci√≥n</label>
    <textarea id="editPartyDescription" rows="3"></textarea>
    <label>Color del Partido</label>
    <input type="color" id="editPartyColor" value="#0077ff">
    <label>Manifesto</label>
    <textarea id="editPartyManifesto" rows="4"></textarea>
    <label>Nuevo Logo (opcional)</label>
    <input type="file" id="editPartyLogo" accept="image/*">
    <button id="saveEditBtn">üíæ Guardar Cambios</button>
    <button id="cancelEditBtn" type="button">Cancelar</button>
  </div>

  <div id="partyManifestoView"><h3>Manifesto / Programa</h3><ul></ul></div>
  <h3>Miembros</h3>
  <ul id="partyMembers"></ul>
  <h3>Chat del Partido</h3>
  <div id="partyChat"></div>
  <input type="text" id="chatInput" placeholder="Escribe un mensaje y presiona Enter">
</div>

<script type="module">
const errorBox = document.getElementById("error-box");

function showError(msg){
  errorBox.innerHTML = msg;
}

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const partyForm = document.getElementById('partyForm');
const candidateInputs = document.getElementById('candidateInputs');
const addCandidateBtn = document.getElementById('addCandidate');
const statusText = document.getElementById('status');
const partiesList = document.getElementById('partiesList');

const mainContainer = document.getElementById('mainContainer');
const partyView = document.getElementById('partyView');
const partyNameView = document.getElementById('partyNameView');
const partyDescriptionView = document.getElementById('partyDescriptionView');
const manifestoList = document.querySelector("#partyManifestoView ul");
const partyMembersList = document.getElementById('partyMembers');
const chatInput = document.getElementById('chatInput');
const leaveBtn = document.getElementById('leaveBtn');
const hubBtn = document.getElementById('hubBtn');
const partyLogoView = document.getElementById('partyLogoView');
const editBtn = document.getElementById("editPartyBtn");
const editForm = document.getElementById("editPartyForm");
const saveEditBtn = document.getElementById("saveEditBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");

let chatInterval;

// ====================
// A√±adir candidato din√°micamente
// ====================
addCandidateBtn.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Nombre candidato';
  input.className = 'candidateName';
  candidateInputs.appendChild(input);
});

// ====================
// AUX
// ====================
function slugify(text){ 
  return text.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+|-+$/g,''); 
}

async function cryptoRandomUUID(){ 
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Math.random().toString(36).slice(2,10)); 
}

// ====================
// Cargar partidos
// ====================
async function loadParties(){
  partiesList.innerHTML = "Cargando partidos...";

  try {
    const { data, error } = await supabase
      .from("parties")
      .select("id, name, description, manifesto, logo_path, color");

    if(error) throw error;

    if(!data || data.length === 0){
      partiesList.innerHTML = "<p>No hay partidos creados a√∫n.</p>";
      return;
    }

    partiesList.innerHTML = "";

    data.forEach(party => {
      const div = document.createElement("div");
      div.className = "party-card";
      div.style.backgroundColor = party.color || "#fafafa";

      // Logo seguro
      let logoHtml = "";
      if(party.logo_path){
        try {
          const { data: urlData } = supabase.storage.from("logos").getPublicUrl(party.logo_path);
          const publicUrl = urlData?.publicUrl;
          if(publicUrl) logoHtml = `<img src="${publicUrl}" alt="Logo">`;
        } catch(e){
          console.warn("Error cargando logo:", e);
        }
      }

      // Manifesto seguro
      let manifestoHtml = "";
      let manifestoArray = [];
      if(party.manifesto){
        manifestoArray = Array.isArray(party.manifesto) ? party.manifesto : Object.values(party.manifesto);
        if(manifestoArray.length > 0){
          manifestoHtml = `<ul>${manifestoArray.map(line => `<li>${line}</li>`).join('')}</ul>`;
        }
      }

      div.innerHTML = `
        ${logoHtml}
        <h3>${party.name || "Sin nombre"}</h3>
        <p>${party.description || "Sin descripci√≥n"}</p>
        ${manifestoHtml}
        <button onclick="joinParty('${party.id}')">Unirse</button>
      `;

      partiesList.appendChild(div);
    });

  } catch(err){
    partiesList.innerHTML = "‚ùå Error cargando partidos";
    console.error("Error en loadParties:", err);
    showError("‚ùå " + (err.message || JSON.stringify(err)));
  }
}

// ====================
// Crear partido
// ====================
partyForm.addEventListener('submit', async e => {
  e.preventDefault();
  statusText.textContent = 'Creando partido...';
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  const name = document.getElementById('partyName').value;
  const description = document.getElementById('partyDescription').value;
  const manifestoArray = document.getElementById('partyManifesto').value.split('\n').filter(l => l.trim() !== '');
  const logoFile = document.getElementById('partyLogo').files[0];
  const color = document.getElementById('partyColor').value;
  const slug = `${slugify(name)}-${Math.random().toString(36).slice(2,6)}`;
  let logo_path = null;

  if(logoFile){
    const fileExt = logoFile.name.split('.').pop();
    const fileName = await cryptoRandomUUID() + '.' + fileExt;
    logo_path = `parties/logos/${fileName}`;
    const { error: uploadError } = await supabase.storage.from('logos').upload(logo_path, logoFile);
    if(uploadError){ alert("Error subiendo logo: "+uploadError.message); return; }
  }

  try{
    const { data: party, error: partyError } = await supabase.from('parties')
      .insert([{ name, slug, description, manifesto: manifestoArray, logo_path, color, creator_id: user.id }])
      .select().single();
    if(partyError) throw partyError;

    const candidates = Array.from(document.querySelectorAll('.candidateName'))
      .map(c => c.value.trim()).filter(c => c !== '');
    if(candidates.length){
      await supabase.from('party_candidates')
        .insert(candidates.map((c,i)=>({ party_id: party.id, name:c, order_index:i })));
    }

    await supabase.from('party_members')
      .insert([{ party_id: party.id, usuarios_id: user.id, role:'creator' }]);

    alert("Partido creado exitosamente");
    statusText.textContent = '¬°Partido creado!';
    partyForm.reset();
    candidateInputs.innerHTML = '<input type="text" placeholder="Nombre candidato" class="candidateName">';
    loadParties();
  }catch(err){ console.error(err); alert("Error creando partido: "+err.message);}
});

// ====================
// Unirse a partido
// ====================
window.joinParty = async function(partyId){
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("Debes iniciar sesi√≥n"); return; }

  const { data: existing } = await supabase.from("party_members")
    .select("party_id")
    .eq("usuarios_id", user.id)
    .eq("party_id", partyId);

  if(existing && existing.length > 0){
    alert("Ya est√°s en este partido");
    showParty(partyId);
    return;
  }

  const { error } = await supabase.from("party_members")
    .insert([{ party_id: partyId, usuarios_id: user.id, role:"member" }]);
  if(error){ alert("No se pudo unir: "+error.message); return; }

  localStorage.setItem("currentPartyId", partyId);
  showParty(partyId);
}

// ====================
// Mostrar partido
// ====================
async function showParty(partyId){
  mainContainer.style.display = "none";
  partyView.style.display = "block";

  const user = JSON.parse(localStorage.getItem("currentUser"));

  const { data: party, error: partyError } = await supabase
    .from("parties")
    .select("id,name,description,logo_path,manifesto,creator_id,color")
    .eq("id", partyId)
    .single();

  if(partyError || !party){
    showError("‚ùå " + (partyError?.message || partyError));
    alert("No se pudo cargar el partido.");
    return;
  }

  partyView.style.backgroundColor = party.color || "#fff";
  partyNameView.textContent = party.name;
  partyDescriptionView.textContent = party.description;
  manifestoList.innerHTML = party.manifesto?.map(line => `<li>${line}</li>`).join("") || "<li>No hay manifesto</li>";

  if(party.logo_path){
    const { data: { publicUrl } } = supabase.storage.from("logos").getPublicUrl(party.logo_path);
    if(publicUrl){
      partyLogoView.src = publicUrl;
      partyLogoView.style.display = "block";
    } else {
      partyLogoView.style.display = "none";
    }
  } else {
    partyLogoView.style.display = "none";
  }

  editBtn.style.display = (user && user.id === party.creator_id) ? "inline-block" : "none";

  // Miembros
  const { data: members, error: membersError } = await supabase
    .from("party_members")
    .select("usuarios_id, usuarios:usuarios_id ( username )")
    .eq("party_id", partyId);

  if(membersError){
    showError("‚ùå " + (membersError.message || membersError));
    partyMembersList.innerHTML = `<li>Error cargando miembros: ${membersError.message}</li>`;
  } else {
    partyMembersList.innerHTML = members.length > 0
      ? members.map(m => `<li>${m.usuarios?.username || "Anon"}</li>`).join("")
      : "<li>No hay miembros</li>";
  }

  startChatPolling(partyId);

  localStorage.setItem("currentPartyId", partyId);

  // Edici√≥n
  editBtn.onclick = () => {
    document.getElementById("editPartyName").value = party.name;
    document.getElementById("editPartyDescription").value = party.description;
    document.getElementById("editPartyManifesto").value = party.manifesto?.join("\n") || "";
    document.getElementById("editPartyColor").value = party.color || "#0077ff";
    editForm.style.display = "block";
  };
  cancelEditBtn.onclick = () => { editForm.style.display = "none"; };

  saveEditBtn.onclick = async () => {
    const newName = document.getElementById("editPartyName").value;
    const newDesc = document.getElementById("editPartyDescription").value;
    const newManifesto = document.getElementById("editPartyManifesto").value.split("\n").filter(l => l.trim() !== "");
    const newLogoFile = document.getElementById("editPartyLogo").files[0];
    const newColor = document.getElementById("editPartyColor").value;

    let newLogoPath = null;
    if(newLogoFile){
      const fileExt = newLogoFile.name.split('.').pop();
      const fileName = await cryptoRandomUUID() + '.' + fileExt;
      newLogoPath = `parties/logos/${fileName}`;
      const { error: uploadError } = await supabase.storage.from('logos').upload(newLogoPath, newLogoFile, { upsert: true });
      if(uploadError){ alert("‚ùå Error subiendo nuevo logo: " + uploadError.message); return; }
    }

    const updateData = { name: newName, description: newDesc, manifesto: newManifesto, color: newColor };
    if(newLogoPath) updateData.logo_path = newLogoPath;

    const { error: updateError } = await supabase.from("parties").update(updateData).eq("id", partyId);
    if(updateError){ alert("‚ùå Error actualizando partido: " + updateError.message); return; }

    alert("‚úÖ Partido actualizado con √©xito");
    editForm.style.display = "none";
    showParty(partyId);
    loadParties();
  };
}

// ====================
// Chat
// ====================
async function loadMessages(partyId){
  const { data, error } = await supabase
    .from("party_messages")
    .select("id, message, created_at, usuarios:usuarios_id ( username )")
    .eq("party_id", partyId)
    .order("created_at", { ascending:true });

  if(error){
    showError("‚ùå " + (error.message || error));
    return;
  }

  document.getElementById("partyChat").innerHTML = data?.map(m =>
    `<p><b>${m.usuarios?.username || 'Anon'}:</b> ${m.message}</p>`).join("") || "";

  const chatDiv = document.getElementById("partyChat");
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function startChatPolling(partyId){
  clearInterval(chatInterval);
  loadMessages(partyId);
  chatInterval = setInterval(()=>loadMessages(partyId), 3000);
}

chatInput.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter" && chatInput.value.trim() !== ""){
    e.preventDefault();
    const user = JSON.parse(localStorage.getItem("currentUser"));
    const partyId = localStorage.getItem("currentPartyId");
    if(!user || !partyId) return;

    const message = chatInput.value.trim();
    chatInput.value = "";

    const { error } = await supabase.from("party_messages")
      .insert([{ party_id: partyId, usuarios_id: user.id, message }]);

    if(error){ showError("‚ùå " + (error.message || error)); return; }

    loadMessages(partyId);
  }
});

// ====================
// Salir del partido
// ====================
leaveBtn.addEventListener("click", async ()=>{
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const partyId = localStorage.getItem("currentPartyId");
  if(!user || !partyId) return;

  const { error } = await supabase.from("party_members")
    .delete()
    .eq("party_id", partyId)
    .eq("usuarios_id", user.id);

  if(error){ alert("No se pudo salir del partido"); return; }

  localStorage.removeItem("currentPartyId");
  clearInterval(chatInterval);
  partyView.style.display = "none";
  mainContainer.style.display = "block";
  loadParties();
});

// ====================
// Volver al Hub
// ====================
hubBtn.addEventListener("click", ()=>{
  localStorage.removeItem("currentPartyId");
  clearInterval(chatInterval);
  window.location.href = "h.html";
});

// ====================
// Detectar si ya est√° en un partido
// ====================
window.addEventListener("DOMContentLoaded", async ()=>{
  await loadParties();
  const user = JSON.parse(localStorage.getItem("currentUser"));
  const savedPartyId = localStorage.getItem("currentPartyId");

  if(savedPartyId){
    showParty(savedPartyId);
  } else if(user){
    const { data: membership } = await supabase.from("party_members")
      .select("party_id").eq("usuarios_id", user.id);
    if(membership && membership.length > 0){
      localStorage.setItem("currentPartyId", membership[0].party_id);
      showParty(membership[0].party_id);
    }
  }
});
</script>
</body>
</html>
