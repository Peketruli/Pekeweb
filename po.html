<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PekeOS - Pol√≠tica Abierta</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- ESTILOS (Id√©nticos, solo a√±ad√≠ estilo para la pantalla de error) --- */
        :root {
            --bg-color: #121212;
            --window-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --accent: #00bcd4;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        /* Ventana OS */
        .os-window {
            width: 900px; height: 650px;
            background-color: var(--window-bg);
            border: 1px solid #333; border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            display: flex; flex-direction: column; position: relative;
        }

        .title-bar {
            background: #252526; padding: 10px 15px; display: flex;
            justify-content: space-between; align-items: center; user-select: none;
        }
        .window-controls span { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-left: 6px; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }

        .main-content { padding: 20px; flex: 1; overflow-y: auto; position: relative; }

        /* Panel Usuario */
        .user-panel {
            background: linear-gradient(90deg, #2a2a2a, #222);
            padding: 15px; border-radius: 8px; display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 20px;
            border-left: 4px solid var(--accent);
        }
        .cpu-badge { background: #000; padding: 5px 10px; border-radius: 4px; color: var(--accent); font-weight: bold; font-family: monospace;}

        /* Grid Din√°mico */
        .parties-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;
        }

        /* Tarjeta de Partido */
        .party-card {
            background: #2d2d2d; padding: 15px; border-radius: 8px;
            border-top: 4px solid #555; display: flex; flex-direction: column;
            transition: transform 0.2s; position: relative;
        }
        .party-card:hover { transform: translateY(-3px); background: #333; }
        
        .party-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .party-icon { font-size: 1.8rem; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 50%; }
        .party-name { font-weight: bold; font-size: 1.1rem; }
        .party-desc { font-size: 0.85rem; color: #aaa; flex-grow: 1; margin-bottom: 10px; line-height: 1.4; }
        
        .vote-bar-bg { width: 100%; height: 6px; background: #111; border-radius: 3px; overflow: hidden; margin-bottom: 10px; }
        .vote-bar-fill { height: 100%; transition: width 0.5s ease; }
        
        .btn-vote {
            width: 100%; padding: 8px; border: none; border-radius: 4px;
            background: #3a3a3a; color: white; cursor: pointer; transition: 0.2s;
        }
        .btn-vote:hover { background: #555; }
        .btn-vote:active { transform: scale(0.95); }

        /* Bot√≥n Flotante (Crear) */
        .fab {
            position: absolute; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--accent); color: #000; font-size: 30px; border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* Modal */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-window {
            width: 400px; background: #252526; padding: 25px; border-radius: 10px;
            border: 1px solid #444; box-shadow: 0 10px 30px #000;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }
        .form-input { 
            width: 100%; padding: 8px; background: #111; border: 1px solid #444; 
            color: white; border-radius: 4px; box-sizing: border-box;
        }
        .color-picker { height: 40px; padding: 2px; }
        .btn-submit {
            width: 100%; background: var(--accent); color: black; font-weight: bold;
            padding: 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;
        }
        
        /* Pantalla de error de sesi√≥n */
        #error-screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; color: #ff5f56;
        }

    </style>
</head>
<body>

    <div class="os-window">
        <div class="title-bar">
            <span>üèõÔ∏è PEKE_DEMOCRACY.APP</span>
            <div class="window-controls">
                <span class="green"></span><span class="yellow"></span><span class="red"></span>
            </div>
        </div>

        <div class="main-content" id="app-content">
            <div class="user-panel">
                <div>
                    <strong>Ciudadano:</strong> <span id="username">Cargando...</span>
                    <div style="font-size: 0.8rem; color: #888;">ID Sesi√≥n: <span id="sessionId">...</span></div>
                </div>
                <div class="cpu-badge">‚ö° <span id="cpuDisplay">0</span> CPU</div>
            </div>

            <div id="partiesContainer" class="parties-grid">
                <div style="color: #666;">Conectando con el servidor...</div>
            </div>

            <button class="fab" onclick="openModal()" title="Fundar nuevo partido">+</button>
        </div>

        <div id="error-screen">
            <h1 style="font-size: 3rem; margin: 0;">üîí</h1>
            <h2>ACCESO DENEGADO</h2>
            <p>No se detect√≥ una sesi√≥n activa en PekeOS.</p>
        </div>

        <div class="modal-overlay" id="createModal">
            <div class="modal-window">
                <h3 style="margin-top: 0;">üìú Fundar Nuevo Partido</h3>
                <p style="font-size: 0.8rem; color: #ff5f56; margin-bottom: 15px;">Coste de registro: 50 CPU</p>
                
                <div class="form-group">
                    <label>Nombre del Partido</label>
                    <input type="text" id="newPartyName" class="form-input" placeholder="Ej: Partido Gamer" maxlength="20">
                </div>
                <div class="form-group">
                    <label>Propuesta Principal (Corta)</label>
                    <input type="text" id="newPartyDesc" class="form-input" placeholder="Ej: Poner m√∫sica en el recreo" maxlength="60">
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Icono (Emoji)</label>
                        <input type="text" id="newPartyIcon" class="form-input" value="üí°" style="text-align: center;">
                    </div>
                    <div style="flex: 1;">
                        <label>Color</label>
                        <input type="color" id="newPartyColor" class="form-input color-picker" value="#00bcd4">
                    </div>
                </div>
                <button class="btn-submit" onclick="createParty()">Pagar 50 CPU y Crear</button>
                <button style="background: none; border: none; color: #888; width: 100%; margin-top: 10px; cursor: pointer;" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN SUPABASE ---
        // (Usando tus claves proporcionadas)
        const SUPABASE_URL = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. CONFIGURACI√ìN DE USUARIO (IMPORTANTE) ---
        // Cambia 'pekeos_user' si en tu sistema usas otro nombre (ej: 'session', 'alumno_data')
        const NOMBRE_CLAVE_STORAGE = 'pekeos_user'; 
        
        const VOTE_COST = 5;
        const CREATE_COST = 50;

        let localState = null;

        // --- 3. INICIALIZACI√ìN Y VALIDACI√ìN ---
        function initSystem() {
            // Intentamos recuperar la sesi√≥n del LocalStorage
            const rawData = localStorage.getItem(NOMBRE_CLAVE_STORAGE);

            if (!rawData) {
                // Si NO existe el usuario, bloqueamos la app
                document.getElementById('app-content').style.display = 'none';
                document.getElementById('error-screen').style.display = 'flex';
                console.error("No se encontr√≥ usuario en localStorage con la clave: " + NOMBRE_CLAVE_STORAGE);
                return;
            }

            // Si existe, lo cargamos
            localState = JSON.parse(rawData);

            // Verificaci√≥n extra: Asegurarse de que tiene CPU, si no, ponerle 0 o 100
            if (typeof localState.cpu === 'undefined') localState.cpu = 100;

            // Actualizar interfaz con datos reales
            document.getElementById('username').innerText = localState.username || "Usuario Desconocido";
            document.getElementById('sessionId').innerText = localState.id || "N/A"; // Si tienes ID
            updateCpuDisplay();
            
            // Iniciar l√≥gica de Supabase
            fetchParties();
            setupRealtime();
        }

        // --- 4. FUNCIONES L√ìGICAS ---

        function updateCpuDisplay() {
            const cpuDisplay = document.getElementById('cpuDisplay');
            cpuDisplay.innerText = localState.cpu;
            
            // ¬°IMPORTANTE! Guardamos el cambio en localStorage para que el resto del OS lo sepa
            localStorage.setItem(NOMBRE_CLAVE_STORAGE, JSON.stringify(localState));
        }

        // CARGAR PARTIDOS
        async function fetchParties() {
            const { data, error } = await supabase
                .from('partidos')
                .select('*')
                .order('votos', { ascending: false });

            if (error) console.error('Error cargando:', error);
            else renderParties(data);
        }

        // RENDERIZAR
        function renderParties(parties) {
            const container = document.getElementById('partiesContainer');
            container.innerHTML = '';
            
            if(parties.length === 0) {
                container.innerHTML = '<div style="grid-column: span 3; text-align: center; color: #555;">No hay partidos. ¬°S√© el primero en crear uno!</div>';
                return;
            }

            parties.forEach(party => {
                let pct = (party.votos / 50) * 100;
                if(pct > 100) pct = 100;

                const html = `
                    <div class="party-card" style="border-top-color: ${party.color}">
                        <div class="party-header">
                            <div class="party-icon">${party.icono}</div>
                            <div>
                                <div class="party-name">${party.nombre}</div>
                            </div>
                        </div>
                        <div class="party-desc">${party.descripcion}</div>
                        
                        <div style="font-size: 0.8rem; margin-bottom: 5px; display: flex; justify-content: space-between;">
                            <span>Progreso</span>
                            <strong>${party.votos} votos</strong>
                        </div>
                        <div class="vote-bar-bg">
                            <div class="vote-bar-fill" style="width: ${pct}%; background: ${party.color}"></div>
                        </div>

                        <button class="btn-vote" onclick="votar('${party.id}')">
                            Votar (-${VOTE_COST} CPU)
                        </button>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // VOTAR
        async function votar(id) {
            if (localState.cpu < VOTE_COST) {
                alert("¬°No tienes suficiente CPU! Participa en clase.");
                return;
            }

            // Restar CPU localmente y guardar
            localState.cpu -= VOTE_COST;
            updateCpuDisplay();

            const { error } = await supabase.rpc('votar_partido', { partido_id: id });
            if (error) {
                alert("Error al votar: " + error.message);
                // Si falla, devolvemos la CPU
                localState.cpu += VOTE_COST;
                updateCpuDisplay();
            }
        }

        // CREAR PARTIDO
        async function createParty() {
            const name = document.getElementById('newPartyName').value;
            const desc = document.getElementById('newPartyDesc').value;
            const icon = document.getElementById('newPartyIcon').value;
            const color = document.getElementById('newPartyColor').value;

            if (!name || !desc) return alert("Rellena todos los campos");

            if (localState.cpu < CREATE_COST) {
                return alert(`Necesitas ${CREATE_COST} CPU para fundar un partido.`);
            }

            localState.cpu -= CREATE_COST;
            updateCpuDisplay();

            const { error } = await supabase
                .from('partidos')
                .insert([{ nombre: name, descripcion: desc, icono: icon, color: color }]);

            if (error) {
                alert("Error creando partido: " + error.message);
                localState.cpu += CREATE_COST;
                updateCpuDisplay();
            } else {
                closeModal();
                document.getElementById('newPartyName').value = '';
                document.getElementById('newPartyDesc').value = '';
            }
        }

        // REALTIME
        function setupRealtime() {
            supabase
                .channel('tabla-partidos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'partidos' }, payload => {
                    fetchParties();
                })
                .subscribe();
        }

        // UI Helpers
        const modal = document.getElementById('createModal');
        function openModal() { modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; }

        // --- ARRANCAR SISTEMA ---
        initSystem();

    </script>
</body>
</html>
