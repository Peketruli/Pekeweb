<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Encuestas en Vivo</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body {
      background: linear-gradient(45deg, #FF5733, #FF8D1A, #FFC300, #FF5733);
      background-size: 400% 400%;
      animation: gradientBG 10s ease infinite;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
      margin-bottom: 100px;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .poll-container, .create-poll {
      max-width: 500px;
      margin: auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      background: rgba(0,0,0,0.3);
    }
    .poll-option {
      display: block;
      width: 80%;
      padding: 15px;
      margin: 10px auto;
      font-size: 20px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background: #007BFF;
      color: white;
    }
    .poll-option:hover { background-color: #0056b3; }
    .back-button, .submit-button, .add-option-button, .delete-button {
      display: block;
      margin: 20px auto;
      padding: 15px;
      font-size: 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h1>Encuestas en Vivo</h1>

  <!-- Crear encuesta (solo Peketruli) -->
  <div id="createPoll" class="create-poll" style="display: none;">
    <h2>Crear una nueva encuesta</h2>
    <input type="text" id="newQuestion" placeholder="Escribe la pregunta"><br><br>
    <div id="optionsContainer">
      <input type="text" class="option-input" placeholder="Opción 1"><br><br>
      <input type="text" class="option-input" placeholder="Opción 2"><br><br>
    </div>
    <button class="add-option-button" onclick="addOption()">Añadir Opción</button><br><br>
    <label>Duración:</label><br>
    <input type="number" id="hours" placeholder="Horas" min="0" value="0"> h
    <input type="number" id="minutes" placeholder="Minutos" min="0" max="59" value="0"> m<br><br>
    <button class="submit-button" onclick="createPoll()">Crear Encuesta</button>
  </div>

  <!-- Encuesta activa -->
  <div class="poll-container" id="pollContainer" style="display: none;">
    <h2 id="question">Pregunta en vivo</h2>
    <div id="pollOptions"></div>
    <p id="timer">Tiempo restante: --</p>
    <p id="results" style="display: none;"></p>
    <button class="delete-button" id="deleteButton" style="display: none;" onclick="deletePoll()">Eliminar Encuesta</button>
  </div>

  <button class="back-button" onclick="goToMainPage()">Volver a Página Principal</button>

  <script>
    /* --- Conexión Supabase --- */
    const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentPoll = null;
    let pollInterval = null;
    const user = JSON.parse(localStorage.getItem("currentUser"));

    document.addEventListener("DOMContentLoaded", async () => {
      if (user.username === "Peketruli") {
        document.getElementById("createPoll").style.display = "block";
        document.getElementById("deleteButton").style.display = "block";
      }
      await loadActivePoll();
    });

    /* --- Añadir opción --- */
    function addOption() {
      const optionsContainer = document.getElementById("optionsContainer");
      const optionCount = optionsContainer.getElementsByClassName("option-input").length + 1;
      const input = document.createElement("input");
      input.type = "text";
      input.className = "option-input";
      input.placeholder = `Opción ${optionCount}`;
      optionsContainer.appendChild(input);
      optionsContainer.appendChild(document.createElement("br"));
    }

    /* --- Crear encuesta --- */
    async function createPoll() {
      const question = document.getElementById("newQuestion").value;
      const options = Array.from(document.getElementsByClassName("option-input"))
        .map(input => ({ text: input.value, votes: 0 }))
        .filter(opt => opt.text);
      const duration = parseInt(document.getElementById("duration").value);

      if (!question || options.length < 2 || isNaN(duration)) {
        alert("Completa todos los campos (pregunta, al menos 2 opciones y duración).");
        return;
      }

      const { data, error } = await db.from("polls").insert([
        { question, options, duration, creator: user.username }
      ]).select().single();

      if (error) { alert("Error al crear: " + error.message); return; }

      alert("Encuesta creada!");
      loadPoll(data.id);
    }

    /* --- Votar --- */
    async function vote(optionIndex) {
  if (!currentPoll) return;

  const { error } = await db.from("poll_votes").insert([{
    poll_id: currentPoll.id,
    user_email: user.username,  // 👈 CAMBIO CLAVE
    option_index: optionIndex
  }]);

  if (error) {
    if (error.message.includes("duplicate key")) {
      alert("Ya has votado en esta encuesta.");
    } else {
      alert("Error: " + error.message);
    }
    return;
  }

  alert("Voto registrado!");
  loadPoll(currentPoll.id);
}

    /* --- Cargar encuesta --- */
    async function loadPoll(pollId) {
      const { data: poll, error } = await db.from("polls").select("*").eq("id", pollId).single();
      if (error) { console.error(error); return; }
      currentPoll = poll;

      document.getElementById("question").textContent = poll.question;
      const pollOptions = document.getElementById("pollOptions");
      pollOptions.innerHTML = "";

      // Contar votos
      const { data: votes } = await db.from("poll_votes").select("*").eq("poll_id", poll.id);
      const counts = new Array(poll.options.length).fill(0);
      votes.forEach(v => counts[v.option_index]++);

      poll.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "poll-option";
        btn.textContent = `${opt.text} (${counts[i]} votos)`;
        btn.onclick = () => vote(i);
        pollOptions.appendChild(btn);
      });

      document.getElementById("pollContainer").style.display = "block";

      // Temporizador
      if (pollInterval) clearInterval(pollInterval);
      startTimer(new Date(poll.start_time).getTime(), poll.duration);
    }

    /* --- Cargar última encuesta activa --- */
    async function loadActivePoll() {
      const { data: polls } = await db.from("polls").select("*").order("created_at", { ascending: false }).limit(1);
      if (polls && polls.length > 0) {
        loadPoll(polls[0].id);
      }
    }

    /* --- Temporizador --- */
    function startTimer(startTime, duration) {
      let timeLeft = duration - Math.floor((Date.now() - startTime) / 1000);
      const timerElement = document.getElementById("timer");

      pollInterval = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `Tiempo restante: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(pollInterval);
          showResults();
        }
      }, 1000);
    }

    /* --- Mostrar resultados --- */
    async function showResults() {
      const resultsElement = document.getElementById("results");
      const { data: votes } = await db.from("poll_votes").select("*").eq("poll_id", currentPoll.id);
      const counts = new Array(currentPoll.options.length).fill(0);
      votes.forEach(v => counts[v.option_index]++);

      const total = counts.reduce((a,b) => a+b, 0);
      resultsElement.innerHTML = total === 0 ? "No hubo votos." : "Resultados:<br>";
      counts.forEach((c, i) => {
        resultsElement.innerHTML += `${currentPoll.options[i].text}: ${c} votos<br>`;
      });
      resultsElement.style.display = "block";
    }

    /* --- Eliminar encuesta --- */
    async function deletePoll() {
      if (!currentPoll) return;
      if (!confirm("¿Eliminar esta encuesta?")) return;
      await db.from("polls").delete().eq("id", currentPoll.id);
      await db.from("poll_votes").delete().eq("poll_id", currentPoll.id);
      alert("Encuesta eliminada");
      location.reload();
    }

    /* --- Volver atrás --- */
    function goToMainPage() {
      window.location.href = 'Hub.html';
    }
  </script>
</body>
</html>
