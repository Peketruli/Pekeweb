<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Panel de Administraci√≥n - Chat Privado Integrado</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
h1,h2 { margin-top:20px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th,td { padding:8px; border:1px solid #333; text-align:left; }
button { padding:6px 10px; margin:2px; border-radius:6px; cursor:pointer; }
.danger { background:#c82333; color:white; border:none; }
.ok { background:#28a745; color:white; border:none; }
.small { padding:4px 6px; font-size:13px; }
#controls { margin-bottom:10px; display:flex; gap:8px; align-items:center; }
input[type="number"], input[type="text"]{ width:120px; padding:6px; }
#messages {
  border:1px solid #333;
  height:250px;
  overflow-y:auto;
  padding:10px;
  background:#1a1a1a;
  color:#fff;
  border-radius:8px;
}
#messageInput {
  flex:1;
  padding:6px;
  border-radius:6px;
  border:1px solid #444;
  background:#222;
  color:#eee;
}
</style>
</head>
<body>
<button class="home-btn" onclick="window.location.href='h.html'">üè† Volver a la P√°gina Principal</button>
<h1>Zona de administraci√≥n</h1>
<div id="status">Comprobando usuario...</div>

<div id="adminArea" style="display:none;">

  <!-- CHAT PRIVADO -->
  <h2>üí¨ Chat Privado de Administradores</h2>
  <div id="adminChat" style="display:none; margin-bottom:30px;">
    <div id="messages"></div>
    <div style="display:flex; gap:5px; margin-top:10px;">
      <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

  <!-- USUARIOS -->
  <h2>Gesti√≥n de Usuarios</h2>
  <div id="controls">
    <button id="refreshBtn">üîÑ Actualizar lista</button>
    <input id="searchInput" placeholder="Buscar por nombre" />
    <button id="searchBtn">üîé</button>
  </div>
  <table id="usersTable">
    <thead>
      <tr><th>Id</th><th>Usuario</th><th>Pekepuntos</th><th>Banned</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- BLOGS -->
  <h2>Gesti√≥n de Blogs</h2>
  <table id="blogsTable">
    <thead><tr><th>Id</th><th>T√≠tulo</th><th>Autor</th><th>Acciones</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- CHATS -->
  <h2>Gesti√≥n de Chats</h2>
  <table id="chatsTable">
    <thead><tr><th>Id</th><th>Usuario</th><th>Mensaje</th><th>Acciones</th></tr></thead>
    <tbody></tbody>
  </table>

</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// ================== CONFIGURACI√ìN ==================
const allowedAdmins = ["Peketruli", "SabinoArana"];

// ================== INICIO ==================
async function init(){
  const status = document.getElementById('status');
  status.textContent = "Verificando usuario...";

  try {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
  } catch {
    status.textContent = "Error al leer usuario del localStorage.";
    return;
  }

  if(!currentUser){
    status.textContent = "No hay sesi√≥n activa.";
    return;
  }

  if(!allowedAdmins.includes(currentUser.username)){
    status.textContent = `Acceso denegado. Usuario "${currentUser.username}" no autorizado.`;
    return;
  }

  // Usuario verificado
  status.textContent = `‚úÖ Bienvenido, ${currentUser.username}`;
  document.getElementById('adminArea').style.display = 'block';
  document.getElementById('adminChat').style.display = 'block';

  // Inicializar todo
  await loadMessages();
  subscribeMessages();
  document.getElementById('sendBtn').addEventListener('click', sendMessage);

  await loadUsers();
  await loadBlogs();
  await loadChats();
}

// ================== CHAT PRIVADO ==================
async function loadMessages(){
  const { data, error } = await supabase
    .from("mensajes")
    .select("*")
    .order("created_at", { ascending: true });

  const messagesDiv = document.getElementById("messages");
  if(error){
    messagesDiv.innerHTML = `<p style="color:red;">Error cargando mensajes: ${error.message}</p>`;
    return;
  }
  messagesDiv.innerHTML = data.map(m => `<b>${m.username}</b>: ${m.text}`).join("<br>");
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text) return;
  await supabase.from("mensajes").insert([{ username: currentUser.username, text }]);
  input.value = "";
}

function subscribeMessages(){
  supabase
    .channel('realtime:mensajes')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'mensajes' }, payload=>{
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML += `<br><b>${payload.new.username}</b>: ${payload.new.text}`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    })
    .subscribe();
}

// ================== ADMIN TOOLS ==================
async function loadUsers(filter=""){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = 'Cargando...';
  const { data, error } = await supabase.from('usuarios').select('id,username,pekepuntos,banned').limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="5">Error: ${error.message}</td></tr>`; return; }
  let result = data || [];
  if(filter){ result = result.filter(u => (u.username||'').toLowerCase().includes(filter.toLowerCase())); }
  renderUsers(result);
}

function renderUsers(users){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  if(!users.length){ tbody.innerHTML = '<tr><td colspan="5">No hay usuarios</td></tr>'; return; }
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.pekepuntos ?? 0}</td>
      <td>${u.banned ? 'S√≠' : 'No'}</td>
      <td><button class="small danger">Borrar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadBlogs(){
  const tbody = document.querySelector('#blogsTable tbody');
  const { data, error } = await supabase.from('blog').select('id,title,author').limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`; return; }
  tbody.innerHTML = data.map(b => `<tr><td>${b.id}</td><td>${b.title}</td><td>${b.author}</td><td><button class='small danger'>Borrar</button></td></tr>`).join('');
}

async function loadChats(){
  const tbody = document.querySelector('#chatsTable tbody');
  const { data, error } = await supabase.from('chats').select('id,nombre,creador').limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`; return; }
  tbody.innerHTML = data.map(c => `<tr><td>${c.id}</td><td>${c.nombre}</td><td>${c.creador}</td><td><button class='small danger'>Borrar</button></td></tr>`).join('');
}

// ================== EVENTOS ==================
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('searchInput').value || '';
  loadUsers(q);
});
document.getElementById('refreshBtn').addEventListener('click', ()=> loadUsers());

init();
</script>
</body>
</html>
