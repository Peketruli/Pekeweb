<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Admin - Usuarios</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th,td { padding:8px; border:1px solid #333; text-align:left; }
  button { padding:6px 10px; margin:2px; border-radius:6px; cursor:pointer; }
  .danger { background:#c82333; color:white; border:none; }
  .ban { background:#555; color:white; border:none; }
  .ok { background:#28a745; color:white; border:none; }
  .small { padding:4px 6px; font-size:13px; }
  #controls { margin-bottom:10px; display:flex; gap:8px; align-items:center; }
  input[type="number"]{ width:120px; padding:6px; }
</style>
</head>
<body>
  <h1>Zona de administraciÃ³n</h1>
  <div id="status">Comprobando usuario...</div>

  <div id="adminArea" style="display:none;">
    <div id="controls">
      <button id="refreshBtn">ðŸ”„ Actualizar lista</button>
      <input id="searchInput" placeholder="Buscar por nombre" />
      <button id="searchBtn">ðŸ”Ž</button>
    </div>

    <table id="usersTable">
      <thead>
        <tr>
          <th>Id</th>
          <th>Usuario</th>
          <th>Email</th>
          <th>Pekepuntos</th>
          <th>Banned</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// Comprobar admin
function isAdmin(user){
  // Control simple: username == Peketruli. En producciÃ³n usa auth.uid + tabla admins.
  return user && user.username === "Peketruli";
}

async function init(){
  currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if(!currentUser){
    document.getElementById('status').textContent = "No estÃ¡s logueado. Inicia sesiÃ³n.";
    return;
  }
  if(!isAdmin(currentUser)){
    document.getElementById('status').textContent = "Acceso denegado. No eres administrador.";
    return;
  }
  document.getElementById('status').textContent = `Hola ${currentUser.username} â€” administrador.`;
  document.getElementById('adminArea').style.display = 'block';
  await loadUsers();
}

// Cargar lista de usuarios
async function loadUsers(filter=""){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = 'Cargando...';

  let query = supabase.from('usuarios').select('id,username,pekepuntos,banned').order('created_at', { ascending: true });
  // BÃºsqueda simple si filter provisto
  if(filter){
    // por seguridad la bÃºsqueda se hace en cliente tras traer resultados limitados
    const { data, error } = await query.limit(500);
    if(error){ tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`; return; }
    const filtered = data.filter(u => (u.username||'').toLowerCase().includes(filter.toLowerCase()) || (u.email||'').toLowerCase().includes(filter.toLowerCase()));
    renderUsers(filtered);
    return;
  }

  const { data, error } = await query.limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`; return; }
  renderUsers(data || []);
}

function renderUsers(users){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  if(!users.length){ 
    tbody.innerHTML = '<tr><td colspan="6">No hay usuarios</td></tr>'; 
    return; 
  }

  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-size:12px">${u.id}</td>
      <td>${escapeHtml(u.username||'')}</td>
      <td>${u.pekepuntos ?? 0}</td>
      <td>${u.banned ? 'SÃ­' : 'No'}</td>
      <td>
        <button class="small addBtn">+Puntos</button>
        <button class="small removeBtn">-Puntos</button>
        <button class="small banBtn">${u.banned ? 'Desbanear' : 'Banear'}</button>
        <button class="small danger deleteBtn">Borrar</button>
      </td>
    `;
    tbody.appendChild(tr);

    // Event listeners
    tr.querySelector('.addBtn').addEventListener('click', ()=>promptAdd(u.id));
    tr.querySelector('.removeBtn').addEventListener('click', ()=>promptRemove(u.id));
    tr.querySelector('.banBtn').addEventListener('click', ()=>toggleBan(u.id, u.banned));
    tr.querySelector('.deleteBtn').addEventListener('click', ()=>deleteUser(u.id, u.username||''));
  });
}

// util escape
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// AÃ±adir puntos (prompt)
async function promptAdd(userId){
  const raw = prompt("Â¿CuÃ¡ntos Pekepuntos aÃ±adir? (positivo)");
  const val = parseInt(raw);
  if(isNaN(val) || val<=0) return alert("Cantidad invÃ¡lida");
  await changePoints(userId, val);
  await loadUsers();
}
async function promptRemove(userId){
  const raw = prompt("Â¿CuÃ¡ntos Pekepuntos quitar? (positivo)");
  const val = parseInt(raw);
  if(isNaN(val) || val<=0) return alert("Cantidad invÃ¡lida");
  await changePoints(userId, -val);
  await loadUsers();
}

// Cambiar puntos
async function changePoints(userId, delta){
  // Mejor estrategia: obtener los puntos actuales desde DB y hacer update con suma
  const { data, error } = await supabase.from('usuarios').select('pekepuntos').eq('id', userId).single();
  if(error) return alert('Error leyendo usuario: '+error.message);
  const current = BigInt(data.pekepuntos || 0);
  const newVal = current + BigInt(delta);
  // evita negativos
  const finalVal = newVal < 0n ? 0n : newVal;
  const { error:err2 } = await supabase.from('usuarios').update({ pekepuntos: finalVal.toString() }).eq('id', userId);
  if(err2) return alert('Error actualizando: '+err2.message);
  alert('Pekepuntos actualizados');
}

// Ban / unban
async function toggleBan(userId, currentlyBanned){
  const confirmMsg = currentlyBanned ? "Â¿Desbanear a este usuario?" : "Â¿Banear a este usuario?";
  if(!confirm(confirmMsg)) return;
  const { error } = await supabase.from('usuarios').update({ banned: !currentlyBanned }).eq('id', userId);
  if(error) return alert('Error: '+error.message);
  alert(currentlyBanned ? 'Usuario desbaneado' : 'Usuario baneado');
  await loadUsers();
}

// Borrar usuario
async function deleteUser(userId, username){
  if(!confirm(`Borrar al usuario ${username} (id: ${userId})? Esta acciÃ³n es irreversible.`)) return;
  const { error } = await supabase.from('usuarios').delete().eq('id', userId);
  if(error) return alert('Error borrando: '+error.message);
  alert('Usuario borrado');
  await loadUsers();
}

// Busqueda
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('searchInput').value || '';
  loadUsers(q);
});
document.getElementById('refreshBtn').addEventListener('click', ()=> loadUsers());

// Inicializar
init();
</script>
</body>
</html>
