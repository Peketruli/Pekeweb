<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Admin - Panel</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
  h1,h2 { margin-top:20px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th,td { padding:8px; border:1px solid #333; text-align:left; }
  button { padding:6px 10px; margin:2px; border-radius:6px; cursor:pointer; }
  .danger { background:#c82333; color:white; border:none; }
  .ban { background:#555; color:white; border:none; }
  .ok { background:#28a745; color:white; border:none; }
  .small { padding:4px 6px; font-size:13px; }
  #controls { margin-bottom:10px; display:flex; gap:8px; align-items:center; }
  input[type="number"]{ width:120px; padding:6px; }
</style>
</head>
<body>
  <button class="home-btn" onclick="window.location.href='Hub.html'"> Volver a la PÃ¡gina Principal</button>
  <h1>Zona de administraciÃ³n</h1>
  <div id="status">Comprobando usuario...</div>

  <div id="adminArea" style="display:none;">
    <!-- Usuarios -->
    <h2>GestiÃ³n de Usuarios</h2>
    <div id="controls">
      <button id="refreshBtn">ðŸ”„ Actualizar lista</button>
      <input id="searchInput" placeholder="Buscar por nombre" />
      <button id="searchBtn">ðŸ”Ž</button>
    </div>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Id</th>
          <th>Usuario</th>
          <th>Pekepuntos</th>
          <th>Banned</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Blogs -->
    <h2>GestiÃ³n de Blogs</h2>
    <table id="blogsTable">
      <thead>
        <tr>
          <th>Id</th>
          <th>TÃ­tulo</th>
          <th>Autor</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Chats -->
    <h2>GestiÃ³n de Chats</h2>
    <table id="chatsTable">
      <thead>
        <tr>
          <th>Id</th>
          <th>Usuario</th>
          <th>Mensaje</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// Comprobar admin
function isAdmin(user){
  return user && user.username === "Peketruli", "SabinoArana";
}

async function init(){
  currentUser = JSON.parse(localStorage.getItem("currentUser"));
  if(!currentUser){
    document.getElementById('status').textContent = "No estÃ¡s logueado. Inicia sesiÃ³n.";
    return;
  }
  if(!isAdmin(currentUser)){
    document.getElementById('status').textContent = "Acceso denegado. No eres administrador.";
    return;
  }
  document.getElementById('status').textContent = `Hola ${currentUser.username} â€” administrador.`;
  document.getElementById('adminArea').style.display = 'block';

  await loadUsers();
  await loadBlogs();
  await loadChats();
}

/* ------------------ USUARIOS ------------------ */
async function loadUsers(filter=""){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = 'Cargando...';

  let query = supabase.from('usuarios').select('id,username,pekepuntos,banned').order('created_at', { ascending: true });
  const { data, error } = await query.limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`; return; }

  let result = data || [];
  if(filter){
    result = result.filter(u => (u.username||'').toLowerCase().includes(filter.toLowerCase()));
  }
  renderUsers(result);
}

function renderUsers(users){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  if(!users.length){ 
    tbody.innerHTML = '<tr><td colspan="6">No hay usuarios</td></tr>'; 
    return; 
  }

  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-size:12px">${u.id}</td>
      <td>${escapeHtml(u.username||'')}</td>
      <td>${u.pekepuntos ?? 0}</td>
      <td>${u.banned ? 'SÃ­' : 'No'}</td>
      <td>
        <button class="small addBtn">+Puntos</button>
        <button class="small removeBtn">-Puntos</button>
        <button class="small banBtn">${u.banned ? 'Desbanear' : 'Banear'}</button>
        <button class="small danger deleteBtn">Borrar</button>
      </td>
    `;
    tbody.appendChild(tr);

    tr.querySelector('.addBtn').addEventListener('click', ()=>promptAdd(u.id));
    tr.querySelector('.removeBtn').addEventListener('click', ()=>promptRemove(u.id));
    tr.querySelector('.banBtn').addEventListener('click', ()=>toggleBan(u.id, u.banned));
    tr.querySelector('.deleteBtn').addEventListener('click', ()=>deleteUser(u.id, u.username||''));
  });
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function promptAdd(userId){
  const raw = prompt("Â¿CuÃ¡ntos Pekepuntos aÃ±adir? (positivo)");
  const val = parseInt(raw);
  if(isNaN(val) || val<=0) return alert("Cantidad invÃ¡lida");
  await changePoints(userId, val);
  await loadUsers();
}
async function promptRemove(userId){
  const raw = prompt("Â¿CuÃ¡ntos Pekepuntos quitar? (positivo)");
  const val = parseInt(raw);
  if(isNaN(val) || val<=0) return alert("Cantidad invÃ¡lida");
  await changePoints(userId, -val);
  await loadUsers();
}
async function changePoints(userId, delta){
  const { data, error } = await supabase.from('usuarios').select('pekepuntos').eq('id', userId).single();
  if(error) return alert('Error leyendo usuario: '+error.message);
  const current = BigInt(data.pekepuntos || 0);
  const newVal = current + BigInt(delta);
  const finalVal = newVal < 0n ? 0n : newVal;
  const { error:err2 } = await supabase.from('usuarios').update({ pekepuntos: finalVal.toString() }).eq('id', userId);
  if(err2) return alert('Error actualizando: '+err2.message);
  alert('Pekepuntos actualizados');
}
async function toggleBan(userId, currentlyBanned){
  const confirmMsg = currentlyBanned ? "Â¿Desbanear a este usuario?" : "Â¿Banear a este usuario?";
  if(!confirm(confirmMsg)) return;
  const { error } = await supabase.from('usuarios').update({ banned: !currentlyBanned }).eq('id', userId);
  if(error) return alert('Error: '+error.message);
  alert(currentlyBanned ? 'Usuario desbaneado' : 'Usuario baneado');
  await loadUsers();
}
async function deleteUser(userId, username){
  if(!confirm(`Borrar al usuario ${username} (id: ${userId})? Esta acciÃ³n es irreversible.`)) return;
  const { error } = await supabase.from('usuarios').delete().eq('id', userId);
  if(error) return alert('Error borrando: '+error.message);
  alert('Usuario borrado');
  await loadUsers();
}

/* ------------------ BLOGS ------------------ */
async function loadBlogs(){
  const tbody = document.querySelector('#blogsTable tbody');
  tbody.innerHTML = 'Cargando...';
  const { data, error } = await supabase.from('blog').select('id,title,author').limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`; return; }

  tbody.innerHTML = '';
  (data||[]).forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${escapeHtml(b.title||'')}</td>
      <td>${escapeHtml(b.author||'')}</td>
      <td><button class="small danger deleteBlogBtn">Borrar</button></td>
    `;
    tbody.appendChild(tr);
    tr.querySelector('.deleteBlogBtn').addEventListener('click', ()=>deleteBlog(b.id, b.title));
  });
}
async function deleteBlog(id, titulo){
  if(!confirm(`Â¿Borrar el blog "${titulo}" (id: ${id})?`)) return;
  const { error } = await supabase.from('blog').delete().eq('id', id);
  if(error) return alert('Error borrando blog: '+error.message);
  alert('Blog borrado');
  await loadBlogs();
}

/* ------------------ CHATS ------------------ */
async function loadChats(){
  const tbody = document.querySelector('#chatsTable tbody');
  tbody.innerHTML = 'Cargando...';
  const { data, error } = await supabase.from('chats').select('id,nombre,creador').limit(500);
  if(error){ tbody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`; return; }

  tbody.innerHTML = '';
  (data||[]).forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${escapeHtml(c.nombre||'')}</td>
      <td>${escapeHtml(c.creador||'')}</td>
      <td><button class="small danger deleteChatBtn">Borrar</button></td>
    `;
    tbody.appendChild(tr);
    tr.querySelector('.deleteChatBtn').addEventListener('click', ()=>deleteChat(c.id, c.creador));
  });
}
async function deleteChat(id, msg){
  if(!confirm(`Â¿Borrar el mensaje "${msg}" (id: ${id})?`)) return;
  const { error } = await supabase.from('chats').delete().eq('id', id);
  if(error) return alert('Error borrando chat: '+error.message);
  alert('Mensaje borrado');
  await loadChats();
}

/* ------------------ EVENTOS ------------------ */
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('searchInput').value || '';
  loadUsers(q);
});
document.getElementById('refreshBtn').addEventListener('click', ()=> loadUsers());

// Inicializar
init();
</script>
</body>
</html>
