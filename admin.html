<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#0f0; padding:20px; }
  h1 { margin-bottom:10px; }
  .error { color:red; text-align:center; font-size:24px; margin-top:50px; }
  pre { background:#000; color:#0f0; padding:10px; white-space:pre-wrap; max-height:70vh; overflow-y:auto; }
</style>
</head>
<body>
<h1>Consola de Actividad</h1>
<div id="status">Comprobando usuario...</div>
<pre id="log"></pre>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");

// Leer usuario del localStorage (como en tu panel admin)
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

// Función de check admin (igual que tu panel)
function isAdmin(user) {
  return user && user.username === "Peketruli";
}

// Inicializar consola
async function initConsole() {
  if (!currentUser) {
    statusEl.innerHTML = "<span class='error'>No has iniciado sesión.</span>";
    return;
  }
  if (!isAdmin(currentUser)) {
    statusEl.innerHTML = "<span class='error'>Casi pero no, vuelve cuando seas admin 😎</span>";
    return;
  }

  statusEl.textContent = `🟢 Bienvenido ${currentUser.username} — acceso concedido`;
  logEl.textContent = "Cargando actividad...\n";

  // Cargar historial de actividad
  const { data, error } = await supabase.from("actividad").select("*").order("fecha",{ascending:true});
  if (error) {
    logEl.textContent += `❌ Error al cargar actividad: ${error.message}\n`;
  } else if (!data || data.length === 0) {
    logEl.textContent += "Sin registros anteriores.\n";
  } else {
    data.forEach(row => {
      const hora = new Date(row.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${row.usuario} ${row.accion}\n`;
    });
  }

  // Suscribirse a cambios en tiempo real
  supabase.channel("actividad_changes")
    .on("postgres_changes", { event:"INSERT", schema:"public", table:"actividad"}, payload => {
      const n = payload.new;
      const hora = new Date(n.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${n.usuario} ${n.accion}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    })
    .subscribe();
}

// Ejecutar
initConsole();
</script>
</body>
</html>
