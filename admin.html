<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Consola de Actividad</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background-color: #000;
    color: #0f0;
    font-family: "Courier New", monospace;
    padding: 20px;
    white-space: pre-wrap;
    overflow-y: auto;
  }
  h1 {
    color: #0f0;
    text-shadow: 0 0 10px #0f0;
  }
  .error {
    color: red;
    text-align: center;
    font-size: 24px;
    margin-top: 100px;
  }
</style>
</head>
<body>
  <h1>Consola de Actividad</h1>
  <div id="status"></div>
  <pre id="log"></pre>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const statusEl = document.getElementById("status");
const logEl = document.getElementById("log");

// Leer usuario del localStorage
let currentUser = null;
try {
  currentUser = JSON.parse(localStorage.getItem("currentUser"));
} catch (e) {
  currentUser = null;
}

// Verificar si es admin
function isAdmin(user) {
  return user && (user.username === "Peketruli" || user.username === "SabinoArana");
}

// Iniciar consola
async function initConsole() {
  if (!currentUser) {
    statusEl.innerHTML = "<span class='error'>No has iniciado sesi√≥n.</span>";
    return;
  }

  if (!isAdmin(currentUser)) {
    statusEl.innerHTML = "<span class='error'>Acceso denegado. No eres administrador.</span>";
    return;
  }

  statusEl.textContent = `üü¢ Bienvenido ${currentUser.username} ‚Äî acceso concedido`;
  logEl.textContent = "Cargando actividad...\n";

  const { data, error } = await supabase
    .from("actividad")
    .select("*")
    .order("fecha", { ascending: true });

  if (error) {
    logEl.textContent += "\n‚ùå Error al cargar actividad: " + error.message;
    return;
  }

  if (!data || data.length === 0) {
    logEl.textContent += "\nSin registros anteriores.\n";
  } else {
    data.forEach(row => {
      const hora = new Date(row.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${row.usuario} ${row.accion}\n`;
    });
  }

  // Escuchar nuevas actividades en tiempo real
  supabase
    .channel("actividad_changes")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "actividad" }, payload => {
      const nuevo = payload.new;
      const hora = new Date(nuevo.fecha).toLocaleTimeString();
      logEl.textContent += `[${hora}] ${nuevo.usuario} ${nuevo.accion}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    })
    .subscribe();
}

initConsole();
</script>
</body>
</html>
