<script>
// -------------------- Supabase --------------------
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// -------------------- Elementos --------------------
const statusText = document.getElementById("status");
const loadingText = document.getElementById("loadingText");
const teasersContainer = document.getElementById("teasersContainer");
const uploadZone = document.getElementById("uploadZone");
const debug = document.getElementById("debug");

// -------------------- Funciones --------------------
function showMessage(msg, color="#ff8a33") {
  statusText.textContent = msg;
  statusText.style.color = color;
}

function logDebug(msg) {
  debug.textContent += msg + "\n";
}

// Simular sesión de usuario
function getCurrentUser() {
  const raw = localStorage.getItem("currentUser");
  if(!raw) return null;
  try { return JSON.parse(raw); } catch { return { username: raw }; }
}

function checkUser() {
  const user = getCurrentUser();
  logDebug("Usuario detectado: " + JSON.stringify(user));
  if(user && user.username && user.username.toLowerCase() === "peketruli") {
    uploadZone.style.display = "block";
    showMessage("✅ Estás en modo Peketruli (puedes subir teasers)", "#7fff7f");
  } else {
    uploadZone.style.display = "none";
    showMessage("👤 Modo visitante (solo puedes ver los teasers)", "#ff6a6a");
  }
}

async function loadTeasers() {
  teasersContainer.innerHTML = "";
  loadingText.textContent = "Cargando teasers...";
  try {
    const { data, error } = await supabase.storage.from("teasers").list("public");
    if(error) throw error;
    if(!data || data.length===0){ loadingText.textContent="No hay teasers publicados"; return; }
    loadingText.textContent="";
    for(const file of data){
      const { data: publicData, error: urlError } = supabase.storage.from("teasers").getPublicUrl(`public/${file.name}`);
      if(urlError) throw urlError;
      const img = document.createElement("img");
      img.src = publicData.publicUrl;
      img.className = "teaser";
      teasersContainer.appendChild(img);
    }
    logDebug("Teasers cargados: " + data.length);
  } catch(err) {
    loadingText.textContent = "❌ Error cargando teasers: " + (err.message||err);
    logDebug("Error cargar teasers: " + (err.message||err));
  }
}

async function uploadTeaser() {
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  if(!file){ showMessage("❌ Selecciona un archivo primero","#ff6a6a"); return; }
  const user = getCurrentUser();
  if(!user || user.username.toLowerCase() !== "peketruli"){ showMessage("❌ Solo Peketruli puede subir teasers","#ff6a6a"); return; }

  const fileName = `${Date.now()}-${file.name}`;
  showMessage("⏳ Subiendo teaser...", "#fffa7f");
  try {
    const { error } = await supabase.storage.from("teasers").upload(`public/${fileName}`, file, { upsert:true });
    if(error) throw error;
    showMessage("✅ Teaser subido correctamente!","#7fff7f");
    fileInput.value="";
    loadTeasers();
  } catch(err) {
    showMessage("❌ Error subiendo teaser: "+(err.message||err),"#ff6a6a");
    logDebug("Error subir teaser: "+(err.message||err));
  }
}

// -------------------- Inicialización --------------------
document.addEventListener("DOMContentLoaded", () => {
  checkUser();
  loadTeasers();
  window.uploadTeaser = uploadTeaser;
});
</script>
</body>
</html>
