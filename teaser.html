<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zona de Teasers</title>
<style>
  body { background:#111; color:#eee; font-family:Arial; text-align:center; padding:20px; }
  h1 { color:#00ffb3; }
  #uploadSection { margin:20px auto; padding:20px; background:#222; border-radius:10px; width:fit-content; display:none; }
  input[type=file] { margin:10px 0; }
  button { background:#00ffb3; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; }
  button:hover { background:#00cc8a; }
  img.teaser { width:300px; border-radius:10px; margin:10px; box-shadow:0 0 10px #00ffb3; }
</style>
</head>
<body>

<h1>🎬 Teasers Públicos</h1>

<div id="status">Verificando usuario...</div>

<div id="uploadSection">
  <h3>Subir nuevo teaser</h3>
  <input type="file" id="fileInput" accept="image/*"><br>
  <button id="uploadBtn">📤 Subir teaser</button>
</div>

<div id="teasersContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>
<script>
(async () => {
  // ✅ Inicializar Supabase
  const supabaseUrl = 'https://jdvwlfogkzrzovepzjqa.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI';
  const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

  const statusDiv = document.getElementById('status');
  const uploadSection = document.getElementById('uploadSection');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const teasersContainer = document.getElementById('teasersContainer');

  // ✅ Comprobar usuario
  const currentUserRaw = localStorage.getItem('currentUser');
  let currentUser = null;
  try { currentUser = JSON.parse(currentUserRaw); } catch {}

  if (currentUser && currentUser.username === "Peketruli") {
    statusDiv.textContent = "👑 Bienvenido, Peketruli. Puedes publicar teasers.";
    uploadSection.style.display = "block";
  } else {
    statusDiv.textContent = "👤 Modo visitante (solo puedes ver los teasers)";
  }

  // ✅ Evento del botón
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) {
      alert("Selecciona una imagen primero");
      return;
    }

    try {
      const filePath = `public/${Date.now()}_${file.name}`;
      const { error } = await supabase.storage
        .from('teasers')
        .upload(filePath, file, { upsert: true });

      if (error) throw error;

      alert("✅ Teaser subido correctamente");
      fileInput.value = "";
      loadTeasers();
    } catch (err) {
      alert("❌ Error al subir: " + err.message);
    }
  });

  // ✅ Cargar y mostrar teasers
  async function loadTeasers() {
    const { data, error } = await supabase.storage.from('teasers').list('public');
    if (error) return console.error(error);

    teasersContainer.innerHTML = '';
    data.reverse().forEach(file => {
      const url = supabase.storage.from('teasers').getPublicUrl(`public/${file.name}`).data.publicUrl;
      const img = document.createElement('img');
      img.src = url;
      img.className = 'teaser';
      teasersContainer.appendChild(img);
    });
  }

  loadTeasers();
})();
</script>

</body>
</html>
