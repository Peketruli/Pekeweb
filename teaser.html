<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teasers Oficiales</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
body {
  background: #0b0b0b;
  color: #f5f3f4;
  font-family: "Segoe UI", Arial, sans-serif;
  text-align: center;
  padding: 20px;
}
h1 { color: #ff8a33; }
#status { margin: 15px 0; font-weight: bold; }
#debug { font-size: 0.85em; color: #888; margin-top: 10px; text-align: left; max-width: 600px; margin: 10px auto; white-space: pre-wrap; }
#teasersContainer { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
.teaser { width: 300px; border-radius: 10px; box-shadow: 0 0 15px rgba(255,138,51,0.4); transition: transform 0.2s ease; }
.teaser:hover { transform: scale(1.05); }
.upload-zone { margin: 25px auto; background: #1a1a1a; padding: 15px; border-radius: 10px; width: fit-content; display: none; }
input[type="file"], button { margin: 8px; padding: 8px 14px; border-radius: 8px; border: none; font-weight: bold; }
button { background: #ff8a33; color: white; cursor: pointer; }
.loading { color: #999; margin-top: 20px; }
</style>
</head>
<body>

<h1>🎬 Teasers Oficiales</h1>
<div id="status">Cargando página...</div>

<div class="upload-zone" id="uploadZone">
  <input type="file" id="fileInput">
  <button id="uploadBtn">Subir Teaser</button>
</div>

<div id="teasersContainer"></div>
<p class="loading" id="loadingText"></p>
<div id="debug"></div>

<script>
/* --------- Supabase --------- */
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* --------- Elementos --------- */
const statusText = document.getElementById("status");
const teasersContainer = document.getElementById("teasersContainer");
const loadingText = document.getElementById("loadingText");
const uploadZone = document.getElementById("uploadZone");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const debug = document.getElementById("debug");

/* --------- Funciones --------- */
function showMessage(msg, color="#ff8a33"){
  statusText.textContent = msg;
  statusText.style.color = color;
}

function logDebug(msg){
  debug.textContent += msg + "\n";
}

/* --------- Usuario --------- */
let currentUser = localStorage.getItem("currentUser") || "peketruli"; // Cambiar para probar visitantes
let isPeketruli = currentUser.toLowerCase() === "peketruli";

if(isPeketruli){
  uploadZone.style.display = "block";
  showMessage("✅ Estás en modo Peketruli (puedes subir teasers)", "#7fff7f");
} else {
  uploadZone.style.display = "none";
  showMessage("👤 Modo visitante (solo puedes ver los teasers)", "#ff6a6a");
}

/* --------- Cargar teasers --------- */
async function loadTeasers(){
  teasersContainer.innerHTML = "";
  loadingText.textContent = "Cargando teasers...";
  try{
    // Asegurarse de que la carpeta exista
    const { data, error } = await supabase.storage.from("teasers").list("public");
    if(error) throw error;
    if(!data || data.length===0){
      loadingText.textContent = "No hay teasers publicados";
      return;
    }
    loadingText.textContent = "";
    for(const file of data){
      const { data: publicData, error: urlError } = supabase.storage.from("teasers").getPublicUrl(`public/${file.name}`);
      if(urlError) throw urlError;
      const img = document.createElement("img");
      img.src = publicData.publicUrl;
      img.className = "teaser";
      teasersContainer.appendChild(img);
    }
    logDebug("Teasers cargados: "+data.length);
  } catch(err){
    loadingText.textContent = "❌ Error cargando teasers: "+(err.message||err);
    logDebug("Error cargar teasers: "+(err.message||err));
  }
}

/* --------- Subir teaser --------- */
async function uploadTeaser(){
  if(!isPeketruli){ showMessage("❌ Solo Peketruli puede subir teasers","#ff6a6a"); return; }
  const file = fileInput.files[0];
  if(!file){ showMessage("❌ Selecciona un archivo","#ff6a6a"); return; }
  const fileName = `${Date.now()}-${file.name}`;
  showMessage("⏳ Subiendo teaser...", "#fffa7f");
  try{
    const { error } = await supabase.storage.from("teasers").upload(`public/${fileName}`, file, { upsert:true });
    if(error) throw error;
    showMessage("✅ Teaser subido correctamente!", "#7fff7f");
    fileInput.value = "";
    loadTeasers();
  } catch(err){
    showMessage("❌ Error subiendo teaser: "+(err.message||err),"#ff6a6a");
    logDebug("Error subir teaser: "+(err.message||err));
  }
}

/* --------- Inicialización --------- */
document.addEventListener("DOMContentLoaded", ()=>{
  loadTeasers();
  uploadBtn.addEventListener("click", uploadTeaser);
});
</script>

</body>
</html>
