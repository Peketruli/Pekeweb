<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Casino - Blackjack</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
    body {
        background-color: #222; 
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    #pekePuntos {
        font-size: 20px;
        margin-bottom: 15px;
    }
    #bet-container {
        margin-bottom: 20px;
    }
    input[type="number"] {
        padding: 5px;
        width: 100px;
        border-radius: 5px;
        border: none;
    }
    button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        margin: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    #hit-button, #stand-button {
        background-color: #007BFF;
        color: white;
    }
    #hit-button:hover, #stand-button:hover {
        background-color: #0056b3;
    }
    #game-message {
        margin-top: 20px;
        font-size: 18px;
        min-height: 24px;
    }
    #player-hand, #dealer-hand {
        margin: 10px;
        font-size: 18px;
    }
</style>
</head>
<body>

<h1>ðŸŽ° Casino - Blackjack ðŸŽ°</h1>
<div id="pekePuntos">PekePuntos: <span id="points">0</span></div>

<div id="bet-container">
  <label for="bet-amount">Apuesta: </label>
  <input type="number" id="bet-amount" min="1" placeholder="Ingresa tus PekePuntos">
  <button id="place-bet-button">Apostar</button>
</div>

<div id="player-hand">Tus cartas: </div>
<div id="dealer-hand">Cartas del crupier: </div>

<button id="hit-button" disabled>Hit</button>
<button id="stand-button" disabled>Stand</button>

<div id="game-message"></div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let playerHand = [];
let dealerHand = [];
let hideDealer = true;
let currentBet = 0;

// Cargar PekePuntos del jugador
document.addEventListener("DOMContentLoaded", function() {
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if(user){
        document.getElementById("points").textContent = user.pekePuntos || 0;
    }
});

// FunciÃ³n para actualizar puntos
async function updatePoints(result){
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if(result === "win") user.pekePuntos += currentBet;
    else if(result === "lose") user.pekePuntos -= currentBet;

    document.getElementById("points").textContent = user.pekePuntos;

    await supabase.from("usuarios").update({pekePuntos: user.pekePuntos}).eq("username", user.username);

    localStorage.setItem("currentUser", JSON.stringify(user));
    currentBet = 0;
    document.getElementById("bet-amount").disabled = false;
    document.getElementById("place-bet-button").disabled = false;
    document.getElementById("bet-amount").value = '';
}

// Funciones de Blackjack
function createDeck(){
    const suits = ["â™¥","â™¦","â™£","â™ "];
    const values = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    let deck = [];
    for(let suit of suits){
        for(let val of values){
            deck.push({suit: suit, value: val});
        }
    }
    return deck.sort(()=> Math.random() - 0.5);
}

function cardValue(card){
    if(["J","Q","K"].includes(card.value)) return 10;
    if(card.value === "A") return 11;
    return parseInt(card.value);
}

function handValue(hand){
    let val = hand.reduce((acc, card) => acc + cardValue(card),0);
    let aces = hand.filter(c => c.value==="A").length;
    while(val>21 && aces>0){
        val -= 10;
        aces--;
    }
    return val;
}

function updateUI(){
    document.getElementById("player-hand").textContent = "Tus cartas: " + playerHand.map(c=>c.value+c.suit).join(" ");
    if(hideDealer){
        document.getElementById("dealer-hand").textContent = "Cartas del crupier: " + dealerHand[0].value + dealerHand[0].suit + " ??";
    } else {
        document.getElementById("dealer-hand").textContent = "Cartas del crupier: " + dealerHand.map(c=>c.value+c.suit).join(" ");
    }
}

function endGame(message){
    document.getElementById("game-message").textContent = message;
    document.getElementById("hit-button").disabled=true;
    document.getElementById("stand-button").disabled=true;
    hideDealer=false;
    updateUI();

    if(message.includes("Ganaste")) updatePoints("win");
    else if(message.includes("perdiste") || message.includes("Pierdes") || message.includes("Crupier gana")) updatePoints("lose");
}

let deck = [];
function startGame(){
    deck = createDeck();
    playerHand = [deck.pop(), deck.pop()];
    dealerHand = [deck.pop(), deck.pop()];
    hideDealer = true;
    updateUI();

    document.getElementById("hit-button").disabled=false;
    document.getElementById("stand-button").disabled=false;
    document.getElementById("game-message").textContent = "";
}

document.getElementById("hit-button").addEventListener("click", () => {
    playerHand.push(deck.pop());
    updateUI();
    if(handValue(playerHand)>21) endGame("Â¡Perdiste! Te pasaste.");
});

document.getElementById("stand-button").addEventListener("click", () => {
    hideDealer=false;
    updateUI();
    while(handValue(dealerHand)<17){
        dealerHand.push(deck.pop());
        updateUI();
    }
    const playerVal = handValue(playerHand);
    const dealerVal = handValue(dealerHand);

    if(dealerVal>21 || playerVal>dealerVal) endGame("Â¡Ganaste!");
    else if(playerVal<dealerVal) endGame("Crupier gana. Pierdes.");
    else endGame("Empate.");
});

// Colocar apuesta
document.getElementById("place-bet-button").addEventListener("click", () => {
    const betInput = document.getElementById("bet-amount");
    let bet = parseInt(betInput.value);
    const user = JSON.parse(localStorage.getItem("currentUser"));

    if(isNaN(bet) || bet <= 0){
        alert("Introduce una cantidad vÃ¡lida.");
        return;
    }
    if(bet > user.pekePuntos){
        alert("No tienes suficientes PekePuntos.");
        return;
    }

    currentBet = bet;
    document.getElementById("game-message").textContent = `Apuesta colocada: ${currentBet} PekePuntos`;
    betInput.disabled = true;
    document.getElementById("place-bet-button").disabled = true;

    startGame();
});
</script>
</body>
</html>
