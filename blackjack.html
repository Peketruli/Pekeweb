<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack - Casino</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
    body {
    background-color: #2c2c2c;
    color: white;
    font-family: 'Arial', sans-serif;
    text-align: center;
    padding: 30px;
}

#pekePuntos {
    font-size: 2em;
    margin-bottom: 20px;
}

#bet-container {
    margin-bottom: 20px;
}

input[type="number"] {
    padding: 5px;
    width: 120px;
    border-radius: 5px;
    border: none;
    font-size: 16px;
}

button {
    padding: 10px 20px;
    margin: 5px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

#hit-button { background-color: #28a745; color: white; }
#stand-button { background-color: #dc3545; color: white; }
#place-bet-button { background-color: #ffc107; color: black; }

#game-container {
    background-color: #0b3d0b; /* Mesa verde */
    border-radius: 15px;
    padding: 20px;
    margin: 0 auto;
    max-width: 600px;
}

#player-hand, #dealer-hand {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    min-height: 80px;
}

.card {
    width: 60px;
    height: 90px;
    border-radius: 10px;
    background-color: white;
    color: black;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 5px;
    font-weight: bold;
    font-size: 1.2em;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    position: relative;
}

.card.hidden {
    background-color: #444;
    color: #444;
}

#game-message {
    margin-top: 20px;
    font-size: 18px;
    min-height: 24px;
    color: #ffd700;
    font-weight: bold;
}

h1 {
    font-size: 2em;
    color: #ffd700;
    margin-bottom: 20px;
}
</style>
</head>
<body>

<h1>ðŸŽ° Blackjack ðŸŽ°</h1>
<div id="pekePuntos">PekePuntos: 0</div>

<div id="bet-container">
    <label for="bet-amount">Apuesta: </label>
    <input type="number" id="bet-amount" min="1" placeholder="Ingresa tus PekePuntos">
    <button id="place-bet-button">Apostar</button>
</div>

<div id="game-container">
    <div id="dealer-hand"></div>
    <div id="player-hand"></div>
</div>

<button id="hit-button" disabled>Hit</button>
<button id="stand-button" disabled>Stand</button>

<div id="game-message"></div>
<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let playerHand = [];
let dealerHand = [];
let hideDealer = true;
let currentBet = 0;
let currentUser = null;

// Cargar PekePuntos reales
async function loadPekePuntos() {
    currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if(!currentUser) {
        alert("Debes iniciar sesiÃ³n para jugar.");
        window.location.href = "login.html";
        return;
    }
    const { data, error } = await supabase.from("usuarios").select("pekepuntos").eq("id", currentUser.id).single();
    if(error) { console.error(error); return; }
    currentUser.pekepuntos = data.pekepuntos;
    document.getElementById("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

async function updatePoints(result) {
    if(result === "win") currentUser.pekepuntos += currentBet * 2;
    else if(result === "lose") currentUser.pekepuntos -= currentBet;

    document.getElementById("pekePuntos").textContent = `PekePuntos: ${currentUser.pekepuntos}`;

    // Guardar en Supabase y localStorage
    const { data, error } = await supabase
        .from("usuarios")
        .update({ pekepuntos: currentUser.pekepuntos })
        .eq("id", currentUser.id);

    if(error) {
        console.error("Error al actualizar Pekepuntos:", error);
        alert("No se pudieron guardar tus PekePuntos. Intenta de nuevo.");
    } else {
        // Actualizamos localStorage solo si se guardÃ³ correctamente
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
    }

    currentBet = 0;
    document.getElementById("bet-amount").disabled = false;
    document.getElementById("place-bet-button").disabled = false;
    document.getElementById("bet-amount").value = '';
}




// Blackjack
function createDeck(){
    const suits = ["â™¥","â™¦","â™£","â™ "];
    const values = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    let deck = [];
    for(let s of suits){ for(let v of values){ deck.push({suit:s,value:v}); } }
    return deck.sort(()=> Math.random()-0.5);
}
function cardValue(card){ if(["J","Q","K"].includes(card.value)) return 10; if(card.value==="A") return 11; return parseInt(card.value); }
function handValue(hand){ let val=hand.reduce((acc,c)=>acc+cardValue(c),0); let aces=hand.filter(c=>c.value==="A").length; while(val>21 && aces>0){ val-=10; aces--; } return val; }
function updateUI(){
    document.getElementById("player-hand").textContent = "Tus cartas: "+playerHand.map(c=>c.value+c.suit).join(" ");
    document.getElementById("dealer-hand").textContent = hideDealer ? "Cartas del crupier: " + dealerHand[0].value + dealerHand[0].suit + " ??" : "Cartas del crupier: "+dealerHand.map(c=>c.value+c.suit).join(" ");
}
function endGame(msg){
    hideDealer=false; updateUI();
    document.getElementById("game-message").textContent = msg;
    document.getElementById("hit-button").disabled=true;
    document.getElementById("stand-button").disabled=true;
    if(msg.includes("Ganaste")) updatePoints("win");
    else if(msg.includes("perdiste") || msg.includes("Pierdes") || msg.includes("Crupier gana")) updatePoints("lose");
}

let deck = [];
function startGame(){
    deck = createDeck();
    playerHand=[deck.pop(),deck.pop()];
    dealerHand=[deck.pop(),deck.pop()];
    hideDealer=true;
    updateUI();
    document.getElementById("hit-button").disabled=false;
    document.getElementById("stand-button").disabled=false;
    document.getElementById("game-message").textContent="";
}

// Eventos
document.getElementById("hit-button").addEventListener("click",()=>{
    playerHand.push(deck.pop()); updateUI();
    if(handValue(playerHand)>21) endGame("Â¡Perdiste! Te pasaste.");
});
document.getElementById("stand-button").addEventListener("click",()=>{
    hideDealer=false; updateUI();
    while(handValue(dealerHand)<17){ dealerHand.push(deck.pop()); updateUI(); }
    const pVal=handValue(playerHand), dVal=handValue(dealerHand);
    if(dVal>21 || pVal>dVal) endGame("Â¡Ganaste!");
    else if(pVal<dVal) endGame("Crupier gana. Pierdes.");
    else endGame("Empate.");
});
document.getElementById("place-bet-button").addEventListener("click",()=>{
    const bet=parseInt(document.getElementById("bet-amount").value);
    if(isNaN(bet) || bet<=0){ alert("Introduce una cantidad vÃ¡lida."); return; }
    if(bet>currentUser.pekepuntos){ alert("No tienes suficientes PekePuntos."); return; }
    currentBet=bet;
    document.getElementById("game-message").textContent=`Apuesta colocada: ${currentBet} PekePuntos`;
    document.getElementById("bet-amount").disabled=true;
    document.getElementById("place-bet-button").disabled=true;
    startGame();
});

// Inicializar
loadPekePuntos();

    function renderHand(containerId, hand, hideSecond=false) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    hand.forEach((card, index) => {
        const cardDiv = document.createElement('div');
        cardDiv.classList.add('card');
        if(hideSecond && index === 1) cardDiv.classList.add('hidden');
        cardDiv.textContent = cardDiv.classList.contains('hidden') ? '??' : card.value + card.suit;
        container.appendChild(cardDiv);
    });
}

function updateUI(){
    renderHand('player-hand', playerHand);
    renderHand('dealer-hand', dealerHand, hideDealer);
}
</script>
</body>
</html>
