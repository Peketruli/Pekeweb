<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Posts</title>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Inter", sans-serif;
  background: linear-gradient(180deg, #1b0b2b 0%, #3a103a 50%, #0b0b0b 100%);
  color: #eee;
  margin: 0;
  padding: 40px 20px 100px;
}
.container {
  max-width: 800px;
  margin: 0 auto;
}
h1 {
  text-align: center;
  color: #ff8a33;
  margin-bottom: 30px;
}
.btn {
  background: linear-gradient(180deg, #ff8a33, #f57c00);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.btn:hover { transform: scale(1.05); }
.card {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
#publicar {
  display: none;
  background: rgba(0,0,0,0.4);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 20px;
}
input, textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-bottom: 10px;
  background: rgba(255,255,255,0.1);
  color: #fff;
}
input::placeholder, textarea::placeholder { color: #aaa; }
#postsList {
  list-style: none;
  padding: 0;
}
.post {
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  margin-bottom: 8px;
}
.post h3 { color: #ff8a33; margin: 0 0 5px; }
.post small { color: #ccc; }
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ“š Posts</h1>

  <div id="estado">Cargando...</div>

  <div id="publicar">
    <h3>Crear nuevo post</h3>
    <input type="text" id="titulo" placeholder="TÃ­tulo del post" />
    <textarea id="contenido" placeholder="Contenido del post..." rows="5"></textarea>
    <button class="btn" onclick="publicarPost()">Publicar</button>
  </div>

  <ul id="postsList"></ul>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

document.addEventListener("DOMContentLoaded", async () => {
  await initUser();
  await cargarPosts();
});

async function initUser() {
  // Leer usuario desde localStorage
  const saved = localStorage.getItem("currentUser");
  if (saved) currentUser = JSON.parse(saved);

  const estado = document.getElementById("estado");
  const publicar = document.getElementById("publicar");

  if (currentUser && currentUser.username === "Peketruli") {
    estado.textContent = "SesiÃ³n iniciada como Peketruli âœ…";
    publicar.style.display = "block";
  } else {
    estado.textContent = "Modo lectura (solo Peketruli puede publicar)";
  }
}

async function cargarPosts() {
  const lista = document.getElementById("postsList");
  lista.innerHTML = "<li>Cargando posts...</li>";

  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .order("fecha_creacion", { ascending: false });

  if (error) {
    lista.innerHTML = `<li>Error cargando: ${error.message}</li>`;
    return;
  }

  lista.innerHTML = "";
  if (!data || data.length === 0) {
    lista.innerHTML = "<li>No hay posts todavÃ­a.</li>";
    return;
  }

  data.forEach(post => {
    const li = document.createElement("li");
    li.className = "post";
    const fecha = new Date(post.fecha_creacion || Date.now()).toLocaleString();
    li.innerHTML = `
      <h3>${post.titulo}</h3>
      <div>${post.contenido}</div>
      <small>${fecha}</small>
    `;
    lista.appendChild(li);
  });
}

async function publicarPost() {
  const titulo = document.getElementById("titulo").value.trim();
  const contenido = document.getElementById("contenido").value.trim();
  if (!titulo || !contenido) return alert("Debes escribir tÃ­tulo y contenido");

  const { error } = await supabase.from("posts").insert({
    titulo,
    contenido,
    fecha_creacion: new Date().toISOString(),
  });

  if (error) return alert("Error publicando: " + error.message);

  document.getElementById("titulo").value = "";
  document.getElementById("contenido").value = "";
  await cargarPosts();
  alert("âœ… Post publicado correctamente");
}
</script>
</body>
</html>
