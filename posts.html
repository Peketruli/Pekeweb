<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Devlog — Peketruli</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    background:#111;
    color:#eee;
    font-family:Arial, sans-serif;
    margin:0; padding:20px;
  }
  h1 {
    text-align:center;
    color:#0ff;
    margin-bottom:10px;
  }
  #topBar {
    text-align:center;
    margin-bottom:25px;
  }
  button.loginBtn {
    background:#0ff; color:#000; border:none;
    border-radius:8px; padding:8px 15px;
    cursor:pointer; font-weight:bold;
    margin-top:10px;
  }
  button.loginBtn:hover { background:#0cc; }
  .post {
    background:#222;
    padding:15px;
    margin:10px auto;
    border-radius:10px;
    max-width:650px;
  }
  .post h2 { margin:0 0 5px; color:#fff; }
  .date { color:#888; font-size:0.9em; }
  .content { margin-top:10px; line-height:1.5; }
  #adminPanel {
    display:none;
    background:#1b1b1b;
    padding:20px;
    border-radius:12px;
    max-width:650px;
    margin:0 auto 30px;
  }
  #adminPanel input, #adminPanel textarea, #adminPanel button {
    width:100%; margin:8px 0; padding:10px;
    border:none; border-radius:8px; font-size:1em;
  }
  #adminPanel input, #adminPanel textarea {
    background:#222; color:#eee;
  }
  #adminPanel button {
    background:#0ff; color:#000; cursor:pointer; font-weight:bold;
  }
  #adminPanel button:hover { background:#0cc; }
  #loginMsg {
    text-align:center; color:#aaa; font-size:0.95em;
    margin-bottom:10px;
    display:block;
  }
</style>
</head>
<body>

<h1>Devlog de Peketruli</h1>

<div id="topBar">
  <span id="loginMsg">Cargando estado...</span><br>
  <button id="loginButton" class="loginBtn">...</button>
</div>

<div id="adminPanel">
  <h2>Nuevo Post</h2>
  <input id="title" placeholder="Título del post" />
  <textarea id="content" rows="6" placeholder="Contenido del post (puede ser texto o HTML)"></textarea>
  <button id="publishBtn">Publicar</button>
</div>

<div id="posts"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const adminPanel = document.getElementById('adminPanel');
  const loginMsg = document.getElementById('loginMsg');
  const loginButton = document.getElementById('loginButton');
  const publishBtn = document.getElementById('publishBtn');

  // Actualiza la interfaz según el estado del login
  function actualizarEstadoLogin() {
    const user = localStorage.getItem('user');
    if (user === 'Peketruli') {
      adminPanel.style.display = 'block';
      loginMsg.textContent = "Estás conectado como Peketruli (modo edición activo)";
      loginButton.textContent = "Cerrar sesión";
    } else {
      adminPanel.style.display = 'none';
      loginMsg.textContent = "Modo lectura. Solo Peketruli puede publicar.";
      loginButton.textContent = "Iniciar sesión como Peketruli";
    }
  }

  // Manejar el botón de login/logout
  loginButton.addEventListener('click', () => {
    const user = localStorage.getItem('user');
    if (user === 'Peketruli') {
      localStorage.removeItem('user');
    } else {
      localStorage.setItem('user', 'Peketruli');
    }
    actualizarEstadoLogin();
  });

  // Cargar posts desde Supabase
  async function cargarPosts() {
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false });

    const contenedor = document.getElementById('posts');
    contenedor.innerHTML = '';

    if (error) {
      console.error('Error cargando posts:', error);
      contenedor.textContent = "Error cargando posts.";
      return;
    }

    if (!data.length) {
      contenedor.innerHTML = "<p style='text-align:center;color:#888;'>No hay posts todavía.</p>";
      return;
    }

    data.forEach(post => {
      const div = document.createElement('div');
      div.className = 'post';
      div.innerHTML = `
        <h2>${post.title}</h2>
        <div class="date">${new Date(post.created_at).toLocaleString()}</div>
        <div class="content">${post.content}</div>
      `;
      contenedor.appendChild(div);
    });
  }

  // Publicar nuevo post
  publishBtn.addEventListener('click', async () => {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    if (!title || !content) return alert('Completa todos los campos.');

    const { error } = await supabase.from('posts').insert([{ title, content }]);
    if (error) {
      console.error(error);
      alert('Error al publicar.');
    } else {
      alert('Post publicado correctamente.');
      document.getElementById('title').value = '';
      document.getElementById('content').value = '';
      cargarPosts();
    }
  });

  actualizarEstadoLogin();
  cargarPosts();
});
</script>

</body>
</html>
