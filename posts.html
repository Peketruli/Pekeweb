<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Posts de Peketruli</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#eee; margin:0; padding:0; }
  header { background:#222; padding:15px; text-align:center; font-size:1.5em; font-weight:bold; }
  #postForm { display:none; background:#111; padding:15px; border-bottom:2px solid #444; }
  #postForm input, #postForm textarea { width:100%; margin:5px 0; background:#222; border:1px solid #444; color:#eee; padding:10px; }
  #postForm button { background:#0ff; border:none; color:#000; padding:10px 15px; cursor:pointer; font-weight:bold; }
  #postForm button:hover { background:#0cc; }
  #postsContainer { display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:20px; padding:20px; }
  .post { background:#111; border:1px solid #333; border-radius:8px; overflow:hidden; }
  .post .content { padding:15px; }
  .gallery { display:flex; flex-wrap:wrap; gap:8px; padding:10px; justify-content:center; }
  .gallery img { width:45%; border-radius:6px; object-fit:cover; }
  #loginStatus { text-align:center; padding:10px; font-size:0.9em; background:#111; }
</style>
</head>
<body>

<header>üìù Posts de Peketruli</header>

<button onclick="window.location.href='h.html'">Volver a la P√°gina Principal</button>

<div id="loginStatus"></div>

<div id="postForm">
  <h3>Nuevo Post</h3>
  <input type="text" id="titulo" placeholder="T√≠tulo del post" />
  <textarea id="contenido" rows="4" placeholder="Contenido..."></textarea>
  <input type="file" id="imagenes" accept="image/*" multiple />
  <button id="publicarBtn">üìù Publicar</button>
</div>

<div id="postsContainer"></div>

<script type="module">
  const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const usuario = localStorage.getItem("usuario");
  const postForm = document.getElementById("postForm");
  const postsContainer = document.getElementById("postsContainer");
  const loginStatus = document.getElementById("loginStatus");

  // Mostrar formulario solo a Peketruli
  if (usuario === "Peketruli") {
    postForm.style.display = "block";
    loginStatus.textContent = "Modo edici√≥n activo: Peketruli ‚úÖ";
  } else {
    postForm.style.display = "none";
    loginStatus.textContent = "Solo lectura. (Solo Peketruli puede publicar)";
  }

  // --- Cargar posts ---
  async function cargarPosts() {
    const { data, error } = await supabase
      .from("posts")
      .select("*")
      .order("fecha_creacion", { ascending: false });

    if (error) {
      postsContainer.innerHTML = "<p>Error al cargar posts: " + error.message + "</p>";
      return;
    }

    postsContainer.innerHTML = "";
    for (const post of data) {
      const div = document.createElement("div");
      div.className = "post";

      // Mostrar im√°genes (compatibilidad con posts antiguos)
      let galeriaHTML = "";
      if (post.imagenes_urls && post.imagenes_urls.length > 0) {
        galeriaHTML = `
          <div class="gallery">
            ${post.imagenes_urls.map(url => `<img src="${url}" alt="imagen">`).join("")}
          </div>
        `;
      } else if (post.imagen_url) {
        galeriaHTML = `
          <div class="gallery">
            <img src="${post.imagen_url}" alt="imagen √∫nica">
          </div>
        `;
      }

      div.innerHTML = `
        <div class="content">
          <h3>${post.titulo}</h3>
          <p>${post.contenido}</p>
          <small>Publicado el ${new Date(post.fecha_creacion).toLocaleString()}</small>
        </div>
        ${galeriaHTML}
      `;
      postsContainer.appendChild(div);
    }
  }
  cargarPosts();

  // --- Publicar post ---
  document.getElementById("publicarBtn").onclick = async () => {
    const titulo = document.getElementById("titulo").value.trim();
    const contenido = document.getElementById("contenido").value.trim();
    const imagenes = document.getElementById("imagenes").files;

    if (!titulo || !contenido) {
      alert("Completa todos los campos.");
      return;
    }

    let imagenes_urls = [];

    // Subir todas las im√°genes
    for (let file of imagenes) {
      const nombreArchivo = `${Date.now()}_${file.name}`;
      const { error: imgError } = await supabase.storage
        .from("blog-media")
        .upload(nombreArchivo, file);

      if (imgError) {
        alert("‚ùå Error al subir imagen:\n" + imgError.message);
        return;
      }

      const { data: publicURL } = supabase.storage
        .from("blog-media")
        .getPublicUrl(nombreArchivo);

      imagenes_urls.push(publicURL.publicUrl);
    }

    const nuevoPost = {
      titulo,
      contenido,
      autor: "Peketruli"
    };

    // Si hay im√°genes, las a√±adimos
    if (imagenes_urls.length > 0) nuevoPost.imagenes_urls = imagenes_urls;

    const { error: postError } = await supabase
      .from("posts")
      .insert([nuevoPost]);

    if (postError) {
      alert("‚ùå Error al publicar:\n" + postError.message);
    } else {
      alert("‚úÖ Post publicado correctamente");
      location.reload();
    }
  };

  // ==================== L√ìGICA MU√ëECOS ESCONDIDOS A√ëADIDA ====================
let snowmen = JSON.parse(localStorage.getItem("snowmen")) || [];
let collectedIDs = JSON.parse(localStorage.getItem("collectedSnowmenIDs")) || [];
const firstCollectibleIndex = 13; // Primer coleccionable para mu√±ecos (ID 13)
const maxCollectibleIndex = 22; // √öltimo coleccionable para mu√±ecos (ID 22)


document.addEventListener("DOMContentLoaded", () => {
    // ... (El resto de loadUserInfo y loadBlogs ya est√°n arriba)
    setupSnowmanListeners(); 
});

function unlockCollectible(id){
¬† // Esta es una funci√≥n auxiliar que debe estar definida en evento.html para que funcione la l√≥gica de desbloqueo,
    // pero la definimos aqu√≠ para evitar errores y simular el guardado.
¬† // En el blog, solo recogemos y guardamos en localStorage. El desbloqueo visual se har√° en evento.html.
¬† ¬† let coleccion = JSON.parse(localStorage.getItem("coleccionables"));
¬† ¬† if(!coleccion) return false;

¬† ¬† if(coleccion[id-1] && !coleccion[id-1].unlocked){
¬† ¬† ¬† coleccion[id-1].unlocked=true;
¬† ¬† ¬† localStorage.setItem("coleccionables", JSON.stringify(coleccion));
¬† ¬† ¬† return true;
¬† ¬† }
¬† ¬† return false;
}

function setupSnowmanListeners() {
    document.querySelectorAll(".hidden-snowman").forEach(sm=>{
        const id = sm.dataset.id;
        
        // Posici√≥n aleatoria en la ventana
        const padding = 80; 
        // Usamos document.body.scrollHeight/scrollWidth para posicionar en todo el cuerpo, no solo la vista
        const maxX = window.innerWidth - padding;
        const maxY = document.body.scrollHeight - padding; 
        
        // Intentamos que se posicionen fuera de la zona central del blog-container para que sean "escondidos"
        const isLeft = Math.random() < 0.5;
        
        if (isLeft) {
             // Posicionar en el lado izquierdo (0 a 30% de la ventana)
            sm.style.left = (Math.random() * (window.innerWidth * 0.3 - padding) + padding) + "px";
        } else {
            // Posicionar en el lado derecho (70% al 100% de la ventana)
            sm.style.left = (window.innerWidth * 0.7 + Math.random() * (window.innerWidth * 0.3 - padding) + padding) + "px";
        }

        // Posici√≥n vertical aleatoria
        sm.style.top = (Math.random() * (maxY - 200) + 200) + "px"; // 200px para evitar el header

        // Ocultar si ya recogido
        if(collectedIDs.includes(id)) sm.style.display="none";

        sm.addEventListener("click", ()=>{
            if(collectedIDs.includes(id)) return;

            sm.classList.add("catched");
            setTimeout(()=> sm.style.display="none", 200);

            // Guardar en el array de mu√±ecos
            snowmen.push("Mu√±eco #" + (snowmen.length + 1));
            localStorage.setItem("snowmen", JSON.stringify(snowmen));

            // Guardar el ID recogido
            collectedIDs.push(id);
            localStorage.setItem("collectedSnowmenIDs", JSON.stringify(collectedIDs));

            const totalCollected = snowmen.length;
            
            let unlockedNow = false;
            let nextNeeded = 5 - (totalCollected % 5);

            // L√≥gica de desbloqueo (Solo se comprueba y se guarda el estado)
            if(totalCollected % 5 === 0){
                const collectibleToUnlock = firstCollectibleIndex + (totalCollected / 5) - 1;
                
                if(collectibleToUnlock <= maxCollectibleIndex) {
                    if(unlockCollectible(collectibleToUnlock)){
                        unlockedNow = true;
                        alert("‚ùÑÔ∏è ¬°Mu√±ecos recogidos! Un coleccionable se ha desbloqueado. Visita el Evento de Navidad para verlo.");
                    }
                } else {
                    alert("‚úÖ ¬°Mu√±eco recogido! Ya has desbloqueado todos los coleccionables disponibles.");
                }
            }
            
            if (!unlockedNow && totalCollected < maxCollectibleIndex * 5) {
                alert(`‚õÑ ¬°Mu√±eco de nieve recogido! Faltan ${nextNeeded} para el pr√≥ximo coleccionable.`);
            } else if (!unlockedNow) {
                 alert("‚õÑ ¬°Mu√±eco de nieve recogido! (Ya has desbloqueado todos los premios)");
            }
        });
    });
}
</script>
</body>
</html>
