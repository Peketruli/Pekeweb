<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Posts de Peketruli</title>

<script type="text/javascript">
    // Si esta p√°gina se abre fuera de PekeOS (ventana principal), redirige al escritorio
    if (window.self === window.top) {
        window.location.replace("PekeOS.html");
    }
</script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#eee; margin:0; padding:0; }
  header { background:#222; padding:15px; text-align:center; font-size:1.5em; font-weight:bold; }
  #postForm { display:none; background:#111; padding:15px; border-bottom:2px solid #444; }
  #postForm input, #postForm textarea { width:100%; margin:5px 0; background:#222; border:1px solid #444; color:#eee; padding:10px; }
  #postForm button { background:#0ff; border:none; color:#000; padding:10px 15px; cursor:pointer; font-weight:bold; }
  #postForm button:hover { background:#0cc; }
  #postsContainer { display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:20px; padding:20px; }
  .post { background:#111; border:1px solid #333; border-radius:8px; overflow:hidden; }
  .post .content { padding:15px; }
  .gallery { display:flex; flex-wrap:wrap; gap:8px; padding:10px; justify-content:center; }
  .gallery img { width:45%; border-radius:6px; object-fit:cover; }
  #loginStatus { text-align:center; padding:10px; font-size:0.9em; background:#111; }
  
  /* Bot√≥n volver estilizado */
  .back-btn {
      display: block;
      margin: 10px auto;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 5px;
  }
  .back-btn:hover { background: #444; }
</style>
</head>
<body>
  
<header>üìù Posts de Peketruli</header>


<div id="loginStatus"></div>

<div id="postForm">
  <h3>Nuevo Post</h3>
  <input type="text" id="titulo" placeholder="T√≠tulo del post" />
  <textarea id="contenido" rows="4" placeholder="Contenido..."></textarea>
  <input type="file" id="imagenes" accept="image/*" multiple />
  <button id="publicarBtn">üìù Publicar</button>
</div>

<div id="postsContainer"></div>

<script type="module">
  const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const usuario = localStorage.getItem("usuario");
  const postForm = document.getElementById("postForm");
  const postsContainer = document.getElementById("postsContainer");
  const loginStatus = document.getElementById("loginStatus");

  // Mostrar formulario solo a Peketruli
  if (usuario === "Peketruli") {
    postForm.style.display = "block";
    loginStatus.textContent = "Modo edici√≥n activo: Peketruli ‚úÖ";
  } else {
    postForm.style.display = "none";
    loginStatus.textContent = "Solo lectura. (Solo Peketruli puede publicar)";
  }

  // --- Cargar posts ---
  async function cargarPosts() {
    const { data, error } = await supabase
      .from("posts")
      .select("*")
      .order("fecha_creacion", { ascending: false });

    if (error) {
      postsContainer.innerHTML = "<p>Error al cargar posts: " + error.message + "</p>";
      return;
    }

    postsContainer.innerHTML = "";
    for (const post of data) {
      const div = document.createElement("div");
      div.className = "post";

      // Mostrar im√°genes (compatibilidad con posts antiguos)
      let galeriaHTML = "";
      if (post.imagenes_urls && post.imagenes_urls.length > 0) {
        galeriaHTML = `
          <div class="gallery">
            ${post.imagenes_urls.map(url => `<img src="${url}" alt="imagen">`).join("")}
          </div>
        `;
      } else if (post.imagen_url) {
        galeriaHTML = `
          <div class="gallery">
            <img src="${post.imagen_url}" alt="imagen √∫nica">
          </div>
        `;
      }

      div.innerHTML = `
        <div class="content">
          <h3>${post.titulo}</h3>
          <p>${post.contenido}</p>
          <small>Publicado el ${new Date(post.fecha_creacion).toLocaleString()}</small>
        </div>
        ${galeriaHTML}
      `;
      postsContainer.appendChild(div);
    }
  }
  cargarPosts();

  // --- Publicar post ---
  document.getElementById("publicarBtn").onclick = async () => {
    const titulo = document.getElementById("titulo").value.trim();
    const contenido = document.getElementById("contenido").value.trim();
    const imagenes = document.getElementById("imagenes").files;

    if (!titulo || !contenido) {
      alert("Completa todos los campos.");
      return;
    }

    let imagenes_urls = [];

    // Subir todas las im√°genes
    for (let file of imagenes) {
      const nombreArchivo = `${Date.now()}_${file.name}`;
      const { error: imgError } = await supabase.storage
        .from("blog-media")
        .upload(nombreArchivo, file);

      if (imgError) {
        alert("‚ùå Error al subir imagen:\n" + imgError.message);
        return;
      }

      const { data: publicURL } = supabase.storage
        .from("blog-media")
        .getPublicUrl(nombreArchivo);

      imagenes_urls.push(publicURL.publicUrl);
    }

    const nuevoPost = {
      titulo,
      contenido,
      autor: "Peketruli"
    };

    // Si hay im√°genes, las a√±adimos
    if (imagenes_urls.length > 0) nuevoPost.imagenes_urls = imagenes_urls;

    const { error: postError } = await supabase
      .from("posts")
      .insert([nuevoPost]);

    if (postError) {
      alert("‚ùå Error al publicar:\n" + postError.message);
    } else {
      alert("‚úÖ Post publicado correctamente");
      location.reload();
    }
  };

</script>
</body>
</html>
