<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Posts</title>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Inter", sans-serif;
  background: linear-gradient(180deg, #1b0b2b 0%, #3a103a 50%, #0b0b0b 100%);
  color: #eee;
  margin: 0;
  padding: 40px 20px 100px;
}
.container {
  max-width: 800px;
  margin: 0 auto;
}
h1 {
  text-align: center;
  color: #ff8a33;
  margin-bottom: 30px;
}
.btn {
  background: linear-gradient(180deg, #ff8a33, #f57c00);
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.btn:hover { transform: scale(1.05); }
.card {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
#publicar {
  display: none;
  background: rgba(0,0,0,0.4);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 20px;
}
input, textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-bottom: 10px;
  background: rgba(255,255,255,0.1);
  color: #fff;
}
input::placeholder, textarea::placeholder { color: #aaa; }
#postsList {
  list-style: none;
  padding: 0;
}
.post {
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  margin-bottom: 8px;
}
.post h3 { color: #ff8a33; margin: 0 0 5px; }
.post small { color: #ccc; }
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ“š Posts</h1>

  <div id="estado">Cargando...</div>

<div id="adminPanel">
  <h2>Nuevo Post</h2>
  <input id="title" placeholder="TÃ­tulo del post" />
  <textarea id="content" rows="6" placeholder="Contenido del post (puede ser texto o HTML)"></textarea>
  <input type="file" id="imageInput" accept="image/*" />
  <button onclick="publicar()">Publicar</button>
</div>

<div id="posts"></div>

<script>
const supabaseUrl = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const db = supabase.createClient(supabaseUrl, supabaseKey);

const user = localStorage.getItem('user');
const adminPanel = document.getElementById('adminPanel');
const loginMsg = document.getElementById('loginMsg');

if (user === 'Peketruli') {
  adminPanel.style.display = 'block';
  loginMsg.textContent = "EstÃ¡s conectado como Peketruli (modo ediciÃ³n activo)";
} else {
  adminPanel.style.display = 'none';
  loginMsg.textContent = "Solo lectura. Inicia sesiÃ³n como Peketruli para publicar.";
}

async function cargarPosts() {
  const { data, error } = await db
    .from('posts')
    .select('*')
    .order('fecha_creacion', { ascending: false });

  if (error) {
    console.error('Error cargando posts:', error);
    return;
  }

  const contenedor = document.getElementById('posts');
  contenedor.innerHTML = '';

  data.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <h2>${post.titulo}</h2>
      <div class="date">${new Date(post.fecha_creacion).toLocaleString()}</div>
      ${post.imagen_url ? `<img src="${post.imagen_url}" style="max-width:100%;border-radius:8px;margin-top:10px;">` : ''}
      <div class="content">${post.contenido}</div>
    `;
    contenedor.appendChild(div);
  });
}
cargarPosts();

async function publicar() {
  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value.trim();
  const imageInput = document.getElementById('imageInput');

  if (!title || !content) return alert('Completa todos los campos.');

  let imageUrl = null;

  // Si hay imagen, subirla primero
  if (imageInput.files.length > 0) {
    const file = imageInput.files[0];
    const fileName = `${Date.now()}_${file.name}`;
    const { data: imgData, error: uploadError } = await db.storage
      .from('imagenes_posts')
      .upload(fileName, file);

    if (uploadError) {
      console.error(uploadError);
      alert('Error subiendo la imagen.');
      return;
    }

    imageUrl = `${supabaseUrl}/storage/v1/object/public/imagenes_posts/${fileName}`;
  }

  // Insertar post
  const { error } = await db.from('posts').insert([
    { titulo: title, contenido: content, imagen_url: imageUrl }
  ]);

  if (error) {
    console.error(error);
    alert('Error al publicar.');
  } else {
    alert('Post publicado correctamente.');
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
    document.getElementById('imageInput').value = '';
    cargarPosts();
  }
}
</script>
</body>
</html>
