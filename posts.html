<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Posts de Peketruli</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #0b0b0b;
    color: #eee;
    margin: 0;
    padding: 0;
  }
  header {
    background: #222;
    padding: 15px;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
  }
  #postForm {
    display: none;
    background: #111;
    padding: 15px;
    border-bottom: 2px solid #444;
  }
  #postForm input, #postForm textarea {
    width: 100%;
    margin: 5px 0;
    background: #222;
    border: 1px solid #444;
    color: #eee;
    padding: 10px;
  }
  #postForm button {
    background: #444;
    border: none;
    color: white;
    padding: 10px 15px;
    cursor: pointer;
  }
  #postsContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
    padding: 20px;
  }
  .post {
    background: #111;
    border: 1px solid #333;
    border-radius: 8px;
    overflow: hidden;
  }
  .post img {
    width: 100%;
    height: auto;
    display: block;
  }
  .post .content {
    padding: 15px;
  }
  .likes-comments {
    padding: 10px 15px;
    border-top: 1px solid #333;
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
  }
  .likes-comments button {
    background: none;
    border: none;
    color: #aaa;
    cursor: pointer;
  }
  .likes-comments button:hover {
    color: #fff;
  }
  #loginStatus {
    text-align: center;
    padding: 10px;
    font-size: 0.9em;
    background: #111;
  }
  .comment-box {
    border-top: 1px solid #333;
    padding: 10px;
  }
  .comment {
    border-bottom: 1px solid #333;
    padding: 5px 0;
    font-size: 0.85em;
  }
</style>
</head>
<body>

<header>üìù Posts de Peketruli</header>

<div id="loginStatus">Cargando estado...</div>

<div id="postForm">
  <h3>Nuevo Post</h3>
  <input type="text" id="titulo" placeholder="T√≠tulo del post" />
  <textarea id="contenido" rows="4" placeholder="Contenido..."></textarea>
  <input type="file" id="imagen" accept="image/*" />
  <button id="publicarBtn">Publicar</button>
</div>

<div id="postsContainer"></div>

<script type="module">
  const SUPABASE_URL = "https://TU_URL.supabase.co";
  const SUPABASE_ANON_KEY = "TU_API_KEY";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let usuario = localStorage.getItem("usuario") || null;
  const loginStatus = document.getElementById("loginStatus");
  const postForm = document.getElementById("postForm");
  const postsContainer = document.getElementById("postsContainer");

  // üîπ Inicializaci√≥n
  async function init() {
    if (!usuario) {
      loginStatus.innerHTML = `<button id="loginBtn">Iniciar sesi√≥n como Peketruli</button>`;
      document.getElementById("loginBtn").onclick = () => {
        localStorage.setItem("usuario", "Peketruli");
        location.reload();
      };
      postForm.style.display = "none";
    } else {
      loginStatus.textContent = `Sesi√≥n iniciada como ${usuario} | `;
      const btn = document.createElement("button");
      btn.textContent = "Cerrar sesi√≥n";
      btn.onclick = () => {
        localStorage.removeItem("usuario");
        location.reload();
      };
      loginStatus.appendChild(btn);
      if (usuario === "Peketruli") postForm.style.display = "block";
    }
    await cargarPosts();
  }

  // üîπ Cargar posts
  async function cargarPosts() {
    const { data, error } = await supabase
      .from("posts")
      .select("*")
      .order("fecha_creacion", { ascending: false });

    if (error) {
      postsContainer.innerHTML = "<p>Error al cargar posts.</p>";
      return;
    }

    postsContainer.innerHTML = "";
    for (const post of data) {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        ${post.imagen_url ? `<img src="${post.imagen_url}" alt="imagen">` : ""}
        <div class="content">
          <h3>${post.titulo}</h3>
          <p>${post.contenido}</p>
          <small>Publicado el ${new Date(post.fecha_creacion).toLocaleString()}</small>
        </div>
        <div class="likes-comments" id="actions-${post.id}">
          <button onclick="likePost(${post.id})">‚ù§Ô∏è Like</button>
          <button onclick="toggleComentarios(${post.id})">üí¨ Comentarios</button>
        </div>
        <div class="comment-box" id="comentarios-${post.id}" style="display:none;"></div>
      `;
      postsContainer.appendChild(div);
    }
  }

  // üîπ Publicar post
  document.getElementById("publicarBtn").onclick = async () => {
    const titulo = document.getElementById("titulo").value.trim();
    const contenido = document.getElementById("contenido").value.trim();
    const imagenFile = document.getElementById("imagen").files[0];

    if (!titulo || !contenido) {
      alert("Completa todos los campos.");
      return;
    }

    let imagen_url = null;
    if (imagenFile) {
      const nombreArchivo = `${Date.now()}_${imagenFile.name}`;
      const { data: imgData, error: imgError } = await supabase.storage
        .from("blog-media")
        .upload(nombreArchivo, imagenFile);
      if (imgError) {
        alert("Error al subir la imagen.");
        return;
      }
      const { data: publicURL } = supabase.storage
        .from("blog-media")
        .getPublicUrl(nombreArchivo);
      imagen_url = publicURL.publicUrl;
    }

    const { error } = await supabase
      .from("posts")
      .insert([{ titulo, contenido, imagen_url, autor: "Peketruli" }]);

    if (error) alert("Error al publicar.");
    else {
      alert("Post publicado ‚úÖ");
      location.reload();
    }
  };

  // üîπ Likes
  window.likePost = async (id) => {
    if (!usuario) return alert("Inicia sesi√≥n para dar like.");
    await supabase.from("likes").insert([{ post_id: id, user_name: usuario }]).catch(() => {});
    alert("‚ù§Ô∏è Like registrado");
  };

  // üîπ Comentarios
  window.toggleComentarios = async (postId) => {
    const box = document.getElementById(`comentarios-${postId}`);
    if (box.style.display === "none") {
      box.style.display = "block";
      const { data } = await supabase
        .from("comentarios")
        .select("*")
        .eq("post_id", postId)
        .order("fecha", { ascending: true });
      box.innerHTML = data.map(c => `<div class="comment"><b>${c.user_name}:</b> ${c.comentario}</div>`).join("");
      if (usuario) {
        box.innerHTML += `
          <input type="text" id="nuevoComentario-${postId}" placeholder="Escribe un comentario...">
          <button onclick="enviarComentario(${postId})">Enviar</button>
        `;
      }
    } else box.style.display = "none";
  };

  window.enviarComentario = async (postId) => {
    const input = document.getElementById(`nuevoComentario-${postId}`);
    const texto = input.value.trim();
    if (!texto) return;
    await supabase.from("comentarios").insert([{ post_id: postId, user_name: usuario, comentario: texto }]);
    toggleComentarios(postId);
  };

  init();
</script>
</body>
</html>
