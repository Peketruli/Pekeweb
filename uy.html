<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Subir Im√°genes y Videos</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { color: white, font-family: Arial, sans-serif; background:black; padding:20px; }
    .preview { margin-top:20px; display:flex; flex-wrap:wrap; gap:15px; }
    .preview-item { max-width:300px; }
    img, video { max-width:100%; border-radius:8px; box-shadow:0 0 5px rgba(0,0,0,0.2); }
    input, button { margin-top:10px; padding:8px; }
  </style>
</head>
<body>
  <button class="home-btn" onclick="window.location.href='Hub.html'"> Volver a la P√°gina Principal</button>
  <h1>Zona +18: Subida de Contenido</h1>

  <!-- Subir archivos desde PC -->
  <h2>Subir desde tu ordenador</h2>
  <input type="file" id="fileInput" accept="image/*,video/*" multiple>

  <!-- Insertar por URL -->
  <h2>Insertar desde URL</h2>
  <input type="text" id="urlInput" placeholder="Pega aqu√≠ la URL de imagen o video">
  <button onclick="addFromUrl()">A√±adir</button>

  <!-- Previsualizaci√≥n -->
  <div class="preview" id="preview"></div>

  <script>
    // ‚ö° Configura tu Supabase
    const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI"; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const preview = document.getElementById("preview");

    // Subida desde el ordenador
    document.getElementById("fileInput").addEventListener("change", async (event) => {
      const files = event.target.files;
      for (let file of files) {
        const filePath = `${Date.now()}_${file.name}`;
        
        // üì§ Subir a Supabase Storage
        const { data, error } = await supabase.storage
          .from("zona18")
          .upload(filePath, file);

        if (error) {
          console.error("Error al subir archivo:", error.message);
          alert("Error al subir archivo: " + error.message);
        } else {
          // Obtener URL p√∫blica
          const { data: urlData } = supabase.storage.from("zona18").getPublicUrl(filePath);
          const fileUrl = urlData.publicUrl;

          // Guardar en base de datos
          const { error: insertError } = await supabase
            .from("contenidos")
            .insert([{ url: fileUrl, tipo: file.type.startsWith("video") ? "video" : "image" }]);

          if (insertError) console.error("Error al guardar en BD:", insertError.message);

          // Render en la p√°gina
          renderMedia(fileUrl, file.type);
        }
      }
    });

    // Subida desde URL externa
    async function addFromUrl() {
      const url = document.getElementById("urlInput").value.trim();
      if (!url) return alert("Introduce una URL v√°lida");

      let tipo = null;
      if (url.match(/\.(mp4|webm|ogg)$/i)) {
        tipo = "video";
      } else if (url.match(/\.(jpeg|jpg|png|gif|webp)$/i)) {
        tipo = "image";
      } else {
        return alert("Formato no soportado");
      }

      // Guardar en BD
      const { error } = await supabase.from("contenidos").insert([{ url, tipo }]);
      if (error) console.error("Error al guardar en BD:", error.message);

      renderMedia(url, tipo);
      document.getElementById("urlInput").value = "";
    }

    // Renderizar en pantalla
    function renderMedia(url, type) {
      const div = document.createElement("div");
      div.classList.add("preview-item");

      if (type.startsWith("video") || type === "video") {
        div.innerHTML = `<video src="${url}" controls></video>`;
      } else {
        div.innerHTML = `<img src="${url}" alt="imagen">`;
      }

      preview.appendChild(div);
    }

    // üì• Cargar contenidos guardados al entrar
    (async function loadContent() {
      const { data, error } = await supabase.from("contenidos").select("*").order("created_at", { ascending: false });
      if (!error && data) {
        data.forEach(item => renderMedia(item.url, item.tipo));
      }
    })();
  </script>
</body>
</html>
