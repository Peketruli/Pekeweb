<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zona +18 - Subir Imágenes y Vídeos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg:#000; --panel:#111; --accent:#ff3b3b; }
    body{font-family:Arial;margin:0;background:var(--bg);color:#fff;padding:20px}
    .wrap{max-width:1000px;margin:18px auto}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type=file]{background:var(--panel);color:#fff;border:1px solid #333;padding:8px;border-radius:6px}
    input[type=text]{background:#222;color:#fff;border:1px solid #333;padding:8px;border-radius:6px;width:420px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.neutral{background:#444}
    .preview{margin-top:20px;display:flex;flex-wrap:wrap;gap:15px}
    .preview-item{width:300px;background:#0b0b0b;padding:8px;border-radius:8px;border:1px solid #222;display:flex;flex-direction:column;gap:8px}
    .preview-item img,.preview-item video,.preview-item iframe{width:100%;border-radius:6px;display:block}
    .meta{font-size:13px;color:#ccc;display:flex;justify-content:space-between;align-items:center}
    .status{font-size:12px;color:#9aa}
    .note{color:#aaa;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Zona +18: Subida de Contenido</h1>

  <div class="controls">
    <label>
      <strong>Subir desde el ordenador:</strong><br>
      <input id="fileInput" type="file" accept="image/*,video/*" multiple>
    </label>

    <div>
      <strong>Insertar desde URL:</strong><br>
      <input id="urlInput" type="text" placeholder="Pega URL (mp4/jpg/png/gif) o YouTube/Vimeo">
      <button id="addUrlBtn">Añadir</button>
    </div>

    <button id="refreshBtn" class="neutral">Recargar guardados</button>
  </div>

  <div class="note">Asegúrate de que el bucket <code>zona18</code> existe. Si es privado, se usarán signed URLs.</div>
  <div id="preview" class="preview"></div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const BUCKET = "zona18";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const urlInput = document.getElementById('urlInput');
const addUrlBtn = document.getElementById('addUrlBtn');
const refreshBtn = document.getElementById('refreshBtn');

function isImageExt(url){ return /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(url); }
function isVideoExt(url){ return /\.(mp4|webm|ogg|mov|mkv)$/i.test(url); }
function isYouTube(url){ return /youtube\.com|youtu\.be/i.test(url); }
function isVimeo(url){ return /vimeo\.com/i.test(url); }

function youtubeEmbedUrl(url){
  try{
    if(/youtu\.be/i.test(url)){ const id=url.split('/').pop().split('?')[0]; return `https://www.youtube.com/embed/${id}`; }
    const u=new URL(url); const id=u.searchParams.get('v'); return id?`https://www.youtube.com/embed/${id}`:null;
  }catch(e){return null;}
}
function vimeoEmbedUrl(url){ try{ const m=url.match(/vimeo\.com\/(\d+)/); return m?`https://player.vimeo.com/video/${m[1]}`:null; }catch(e){return null;} }

function renderMediaBlock({url,tipo,status=''}){
  const div=document.createElement('div'); div.className='preview-item';
  const meta=document.createElement('div'); meta.className='meta';
  meta.innerHTML=`<span>${tipo==='image'?'Imagen':tipo==='video'?'Vídeo':tipo}</span><span class="status">${status}</span>`;
  if(tipo==='image'){ const img=document.createElement('img'); img.src=url; div.appendChild(img); }
  else if(tipo==='video'){ const video=document.createElement('video'); video.src=url; video.controls=true; video.preload='metadata'; div.appendChild(video); }
  else if(tipo==='youtube'||tipo==='vimeo'){ const iframe=document.createElement('iframe'); iframe.src=url; iframe.width='560'; iframe.height='315'; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true; div.appendChild(iframe); }
  else { const a=document.createElement('a'); a.href=url; a.textContent=url; a.target='_blank'; div.appendChild(a); }
  div.appendChild(meta); preview.prepend(div); return div;
}

// --- Subida de archivos ---
fileInput.addEventListener('change', async e=>{
  const files=Array.from(e.target.files||[]);
  if(!files.length) return;
  for(const file of files){
    const localUrl = URL.createObjectURL(file);
    const tipo = file.type.startsWith('video')?'video':'image';
    const block = renderMediaBlock({url:localUrl,tipo,status:'Subiendo...'});
    try{
      const ext = (file.name.split('.').pop()||'').split('?')[0];
      const path = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext|| (tipo==='image'?'jpg':'mp4')}`;
      const { error: uploadErr } = await sb.storage.from(BUCKET).upload(path,file,{cacheControl:'3600',upsert:false});
      if(uploadErr) throw uploadErr;

      const { data: signedData, error: signedErr } = await sb.storage.from(BUCKET).createSignedUrl(path,60*60*24);
      if(signedErr) throw signedErr;
      const fileUrl = signedData.signedUrl;

      const { error: insertErr } = await sb.from('contenidos').insert([{
        url: fileUrl,
        tipo,
        created_at: new Date().toISOString()
      }]);
      if(insertErr) throw insertErr;

      block.querySelector('.status').textContent='Subido';
      const media = block.querySelector(tipo==='image'?'img':'video'); if(media) media.src=fileUrl;
      URL.revokeObjectURL(localUrl);
    }catch(err){
      console.error('Error subiendo archivo:',err);
      block.querySelector('.status').textContent='Error';
      alert('Error al subir '+file.name+': '+(err.message||err));
    }
  }
  fileInput.value='';
});

// --- Añadir por URL ---
addUrlBtn.addEventListener('click', async ()=>{
  const raw = (urlInput.value||'').trim(); if(!raw) return alert('Introduce URL válida'); urlInput.value='';
  try{
    let tipo='unknown', urlFinal = raw;
    if(isYouTube(raw)){ tipo='youtube'; urlFinal=youtubeEmbedUrl(raw)||raw; }
    else if(isVimeo(raw)){ tipo='vimeo'; urlFinal=vimeoEmbedUrl(raw)||raw; }
    else if(isImageExt(raw)){ tipo='image'; }
    else if(isVideoExt(raw)){ tipo='video'; }

    renderMediaBlock({url:urlFinal,tipo,status:'Guardado (embed)'});

    await sb.from('contenidos').insert([{
      url: raw,
      tipo,
      created_at: new Date().toISOString()
    }]);
  }catch(e){ console.error(e); alert('Error guardando URL: '+(e.message||e)); }
});

// --- Cargar guardados ---
async function loadSaved(){
  preview.innerHTML='';
  try{
    const { data, error } = await sb.from('contenidos').select('*').order('created_at',{ascending:false}).limit(500);
    if(error) throw error;
    if(!data?.length) return;
    for(const item of data){
      let tipo = item.tipo || (isImageExt(item.url)?'image': isVideoExt(item.url)?'video': (isYouTube(item.url)?'youtube': isVimeo(item.url)?'vimeo':'unknown'));
      renderMediaBlock({url:item.url,tipo,status:'Guardado'});
    }
  }catch(err){ console.error(err); alert('Error cargando contenidos: '+(err.message||err)); }
}

refreshBtn.addEventListener('click',loadSaved);
loadSaved();
</script>
</body>
</html>
