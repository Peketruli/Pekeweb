<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zona +18 - Subir Imágenes y Vídeos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <style>
    :root { --bg:#000; --panel:#111; --accent:#ff3b3b; }
    body{font-family:Arial;margin:0;background:var(--bg);color:#fff;padding:20px}
    .wrap{max-width:1000px;margin:18px auto}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type=file]{background:var(--panel);color:#fff;border:1px solid #333;padding:8px;border-radius:6px}
    input[type=text]{background:#222;color:#fff;border:1px solid #333;padding:8px;border-radius:6px;width:420px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button.neutral{background:#444}
    .preview{margin-top:20px;display:flex;flex-wrap:wrap;gap:15px}
    .preview-item{width:300px;background:#0b0b0b;padding:8px;border-radius:8px;border:1px solid #222;display:flex;flex-direction:column;gap:8px}
    .preview-item img,.preview-item video,.preview-item iframe{width:100%;border-radius:6px;display:block}
    .meta{font-size:13px;color:#ccc;display:flex;justify-content:space-between;align-items:center}
    .status{font-size:12px;color:#9aa}
  </style>
</head>
<body>
   <button class="home-btn" onclick="window.location.href='Hub.html'"> Volver a la Página Principal</button>
<div class="wrap">
  <h1>Zona +18: Subida de Contenido</h1>

  <div class="controls">
    <label>
      <strong>Subir desde el ordenador:</strong><br>
      <input id="fileInput" type="file" accept="image/*,video/*" multiple>
    </label>

    <div>
      <strong>Insertar desde URL:</strong><br>
      <input id="urlInput" type="text" placeholder="Pega URL (mp4/jpg/png/gif) o YouTube/Vimeo">
      <button id="addUrlBtn">Añadir</button>
    </div>

    <button id="refreshBtn" class="neutral">Recargar guardados</button>
  </div>

  <div id="preview" class="preview"></div>
</div>

<script>
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
const BUCKET = "zona18";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const urlInput = document.getElementById('urlInput');
const addUrlBtn = document.getElementById('addUrlBtn');
const refreshBtn = document.getElementById('refreshBtn');

function isImageExt(url){ return /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(url); }
function isVideoExt(url){ return /\.(mp4|webm|ogg|mov|mkv)$/i.test(url); }
function isYouTube(url){ return /youtube\.com|youtu\.be/i.test(url); }
function isVimeo(url){ return /vimeo\.com/i.test(url); }

function youtubeEmbedUrl(url){
  try{
    if(/youtu\.be/i.test(url)){ const id=url.split('/').pop().split('?')[0]; return `https://www.youtube.com/embed/${id}`; }
    const u=new URL(url); const id=u.searchParams.get('v'); return id?`https://www.youtube.com/embed/${id}`:null;
  }catch(e){return null;}
}

function vimeoEmbedUrl(url){ 
  try{ const m=url.match(/vimeo\.com\/(\d+)/); return m?`https://player.vimeo.com/video/${m[1]}`:null; }catch(e){return null;} 
}

function renderMediaBlock({url,tipo,status=''}){
  const div=document.createElement('div'); div.className='preview-item';
  const meta=document.createElement('div'); meta.className='meta';
  meta.innerHTML=`<span>${tipo}</span><span class="status">${status}</span>`;
  if(tipo==='image'){ const img=document.createElement('img'); img.src=url; div.appendChild(img); }
  else if(tipo==='video'){ const video=document.createElement('video'); video.src=url; video.controls=true; div.appendChild(video); }
  else if(tipo==='youtube'||tipo==='vimeo'){ const iframe=document.createElement('iframe'); iframe.src=url; iframe.width='560'; iframe.height='315'; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true; div.appendChild(iframe); }
  else { const a=document.createElement('a'); a.href=url; a.textContent=url; a.target='_blank'; div.appendChild(a); }
  div.appendChild(meta); preview.prepend(div);
}

// --- Subida de archivos ---
fileInput.addEventListener('change', async e=>{
  const files=Array.from(e.target.files||[]);
  for(const file of files){
    const tipo = file.type.startsWith('video')?'video':'image';
    const block = renderMediaBlock({url:URL.createObjectURL(file),tipo,status:'Subiendo...'});
    try{
      const ext=(file.name.split('.').pop()||'jpg');
      const path=`${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      const { error: uploadErr } = await sb.storage.from(BUCKET).upload(path,file,{upsert:false});
      if(uploadErr) throw uploadErr;
      const { data: signedData, error: signedErr } = await sb.storage.from(BUCKET).createSignedUrl(path,60*60*24);
      if(signedErr) throw signedErr;
      const fileUrl = signedData.signedUrl;

      const { error: insertErr } = await sb.from('contenidos').insert([{ url:fileUrl,tipo,created_at:new Date().toISOString() }]);
      if(insertErr) throw insertErr;
      block.querySelector('.status').textContent='Subido';
    }catch(err){
      console.error(err);
      block.querySelector('.status').textContent='Error';
    }
  }
  fileInput.value='';
});

// --- Añadir por URL ---
addUrlBtn.addEventListener('click', async ()=>{
  const raw = urlInput.value.trim(); if(!raw) return;
  urlInput.value='';
  let tipo='unknown', urlFinal=raw;
  if(isYouTube(raw)){ tipo='youtube'; urlFinal=youtubeEmbedUrl(raw)||raw; }
  else if(isVimeo(raw)){ tipo='vimeo'; urlFinal=vimeoEmbedUrl(raw)||raw; }
  else if(isImageExt(raw)) tipo='image';
  else if(isVideoExt(raw)) tipo='video';

  renderMediaBlock({url:urlFinal,tipo,status:'Guardado'});
  await sb.from('contenidos').insert([{ url: raw, tipo, created_at:new Date().toISOString() }]);
});

// --- Cargar guardados ---
async function loadSaved(){
  preview.innerHTML='';
  try{
    const { data, error } = await sb.from('contenidos').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    data.forEach(item=>{
      let tipo=item.tipo;
      let urlRender=item.url;
      renderMediaBlock({url:urlRender,tipo,status:'Guardado'});
    });
  }catch(err){ console.error(err); }
}

refreshBtn.addEventListener('click',loadSaved);
loadSaved();
</script>
</body>
</html>
